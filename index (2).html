
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        
// ===== PAYPAL CONFIGURATION =====
const PAYPAL_HANDLER_URL = 'https://verificationpaypalpayment-998744778737.us-central1.run.app';
const REOPEN_ACCOUNT_COST = 6.50;
const REOPEN_DAYS = 30;

let paypalButtonRendered = false;
let sponsorPaypalRendered = false;
let currentChildData = null;

        

        let paypalSDKLoaded = false;

async function loadPayPalSDK() {
    if (paypalSDKLoaded) {
        return Promise.resolve();
    }
    
    try {
        // Get client ID from Firebase function
        const response = await fetch(`${PAYPAL_HANDLER_URL}?action=getClientId`);
        const data = await response.json();
        
        if (!data.success || !data.clientId) {
            throw new Error('Failed to get PayPal client ID');
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${data.clientId}&currency=USD&locale=en_US`;
            script.async = true;
            
            script.onload = () => {
                paypalSDKLoaded = true;
                console.log('âœ… PayPal SDK loaded');
                resolve();
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load PayPal SDK'));
            };
            
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading PayPal SDK:', error);
        throw error;
    }
}
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // âœ… NEW: Track declined challenges
let presenceInitialized = false; // âœ… NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// âœ… Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;


// ===== TOURNAMENT VARIABLES =====
let currentTournament = null;
let tournamentStage = 0;
let stage1Questions = [];
let stage1CurrentIndex = 0;
let stage1Score = 0;
let stage1Errors = 0;
let stage1Handicaps = 2;
let stage1TimeLeft = 600; // 10 minutes in seconds
let stage1Timer = null;



// ===== STAGE 2: AI AUDIO SPELLING =====
let stage2Words = [];
let stage2CurrentIndex = 0;
let stage2Score = 0;
let stage2Errors = 0;
let stage2TimeLeft = 900; // 15 minutes
let stage2Timer = null;
let stage2HandicapsRemaining = 1; // Base 1 + carried from Stage 1


   // ===== TOURNAMENT STAGE 3 FUNCTIONS =====
let stage3Words = [];
let stage3CurrentIndex = 0;
let stage3Score = 0;
let stage3Errors = 0;
let stage3TimeLeft = 900; // 15 minutes
let stage3Timer = null;
let stage3HandicapsRemaining = 0;
let stage3CurrentLetterOrder = [];
let stage3DraggedElement = null; 

 // ===== LIVE SPELL MASTER STAGES (4-7) =====
let liveStageParticipants = [];
let currentLiveStageIndex = 0;
let liveStageTimer = null;
let callerMode = false; // true if user is the caller
let liveStageWords = [];
let eliminatedPlayers = [];
let currentSpellerIndex = 0;
let finalRoundSpelling = null;

        
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // âœ… Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // âœ… ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // Ã¢Å“â€¦ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });
    
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        console.log('ğŸ‘¤ User signed in:', user.email);
        console.log('ğŸ–¼ï¸ Auth photoURL:', user.photoURL);
        
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        console.log('ğŸ“„ Firestore photoURL:', userData.photoURL);
        
        if (user.photoURL && !userData.photoURL) {
            console.log('ğŸ“„ Syncing photoURL to Firestore...');
            await userRef.update({
                photoURL: user.photoURL
            });
            console.log('âœ… PhotoURL synced!');
        }
        
        // âœ… INITIALIZE SPELLING STATS IF NOT EXISTS
        if (!userData.spellingStats) {
            console.log('ğŸ“„ Initializing spelling stats...');
            await userRef.update({
                spellingStats: {
                    totalChallenges: 0,
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    winStreak: 0,
                    bestStreak: 0
                }
            });
            console.log('âœ… Spelling stats initialized!');
        }
        
        // âœ… CHECK ADMIN STATUS HERE (CRITICAL - RIGHT AFTER USER DATA IS LOADED)
        await checkAdminStatus();
        
        // âœ… CHECK USER TYPE AND HANDLE ACCORDINGLY
        if (userData.userType === 'parent') {
            // Parent user - no profile completion needed
            if (!userData.profileComplete) {
                await userRef.update({ profileComplete: true });
            }
            updateUIForAuthenticatedUser(user);
            
            // Navigate to parent dashboard
            navigateTo('parent-dashboard');
            return;
        }
        
        // STUDENT/COACH HANDLING
        if (!userData.profileComplete) {
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // âœ… LOAD USER COINS (for students only)
        if (userData.userType === 'student') {
            await loadUserCoins(user.uid);
            await checkSubscriptionStatus();
        }
        
        await cleanupInvalidFavorites();
        
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // âœ… Initialize presence immediately on login (only for students/coaches)
        if (userData.userType !== 'parent') {
            await initializeOnlinePresence();
        }
        
        // Load appropriate dashboard
        if (userData.userType === 'student') {
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        }
   } else {
    currentUser = null;
    isAdmin = false;
    
    // âœ… Clean up tournament listeners
    if (tournamentListeners) {
        tournamentListeners.forEach(unsubscribe => unsubscribe());
        tournamentListeners = [];
    }
    
    updateUIForGuestUser();
    updateAdminUI();
}
});
    });
        
        
    
// ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // âœ… CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'parent-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // âœ… ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard' || section === 'parent-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // âœ… PREVENT PARENTS FROM ACCESSING STUDENT FEATURES
    if (currentUser && section !== 'parent-dashboard' && section !== 'home' && section !== 'about' && section !== 'coaches' && section !== 'students') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'parent') {
                alert('âš ï¸ Parents can only access:\nâ€¢ Parent Dashboard\nâ€¢ Home\nâ€¢ About\nâ€¢ Coaches\nâ€¢ Students\n\nPlease use the Parent Dashboard to manage your child\'s account.');
                navigateTo('parent-dashboard');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // âœ… Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // âœ… RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // âœ… Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // âœ… Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // âœ… Load student dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    // âœ… Load parent dashboard when navigating to it
    if (section === 'parent-dashboard' && currentUser) {
        await loadParentDashboard();
    }
    
    // âœ… LOAD ADMIN PANEL WHEN NAVIGATING TO IT
    if (section === 'admin' && currentUser) {
        console.log('ğŸ¯ Navigating to admin panel. isAdmin:', isAdmin);
        if (!isAdmin) {
            alert('âŒ Admin access required. Please sign in with an admin account.');
            navigateTo('home');
            return;
        }
        await loadAdminPanel();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }

    if (section === 'tournaments') {
    await loadTournamentList();
}
}
        
     


     // ===== TOURNAMENT STAGE 1 FUNCTIONS =====

async function startTournamentStage1(tournamentId) {
    try {
        console.log('ğŸ† Joining Tournament Stage 1:', tournamentId);
        
        const tournamentRef = db.collection('tournaments').doc(tournamentId);
        const tournamentDoc = await tournamentRef.get();
        
        if (!tournamentDoc.exists) {
            throw new Error('Tournament not found');
        }
        
        const tournamentData = tournamentDoc.data();
        selectedGameLevel = tournamentData.level || 'challenge';
        
        currentTournament = tournamentId;
        tournamentStage = 1;
        stage1CurrentIndex = 0;
        stage1Score = 0;
        stage1Errors = 0;
        stage1Handicaps = 2;
        stage1TimeLeft = 600;
        
        // âœ… Check if questions already exist (first player generates, others use same)
        const questionsSnapshot = await tournamentRef.collection('stage1Questions').get();
        
        if (questionsSnapshot.empty) {
            console.log('ğŸ“ Generating questions for all players...');
            
            // First player to join generates questions
            await generateStage1Questions();
            
            // Save questions to Firestore so all players use the same questions
            const batch = db.batch();
            stage1Questions.forEach((question, index) => {
                const questionRef = tournamentRef.collection('stage1Questions').doc(`q${index}`);
                batch.set(questionRef, question);
            });
            await batch.commit();
            
            console.log('âœ… Questions saved to Firestore');
        } else {
            console.log('ğŸ“¥ Loading existing questions...');
            
            // Load questions from Firestore
            stage1Questions = [];
            questionsSnapshot.forEach(doc => {
                stage1Questions.push(doc.data());
            });
            
            // Sort by document ID to maintain order
            stage1Questions.sort((a, b) => {
                const aNum = parseInt(a.word) || 0;
                const bNum = parseInt(b.word) || 0;
                return aNum - bNum;
            });
            
            console.log('âœ… Loaded', stage1Questions.length, 'questions');
        }
        
        // âœ… Create participant document for real-time tracking
        await tournamentRef.collection('participants').doc(currentUser.uid).set({
            userId: currentUser.uid,
            name: currentUser.displayName || currentUser.email,
            stage: 1,
            score: 0,
            errors: 0,
            handicaps: 2,
            currentQuestion: 0,
            status: 'active',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Hide lobby, show stage 1
        document.getElementById('tournament-lobby').style.display = 'none';
        document.getElementById('tournament-stage1').style.display = 'block';
        
        // âœ… Setup real-time leaderboard
        setupStage1Leaderboard(tournamentId);
        
        // Start timer
        startStage1Timer();
        
        // Load first question
        loadStage1Question();
        
    } catch (error) {
        console.error('Error starting Stage 1:', error);
        alert('Failed to start tournament: ' + error.message);
    }
}
async function generateStage1Questions() {
    try {
        console.log('ğŸ¯ Fetching words from database for level:', selectedGameLevel);
        
        // âœ… Fetch words from Firestore dictionary that match the tournament level
        const wordsSnapshot = await db.collection('dictionary')
            .where('level', '==', selectedGameLevel)
            .limit(100)
            .get();
        
        if (wordsSnapshot.empty) {
            // Try without level filter
            console.log('âš ï¸ No words found with level filter, fetching random words...');
            const randomWordsSnapshot = await db.collection('dictionary').limit(100).get();
            
            if (randomWordsSnapshot.empty) {
                throw new Error('No words found in database. Please add words first.');
            }
            
            const allWords = [];
            randomWordsSnapshot.forEach(doc => {
                allWords.push({ id: doc.id, ...doc.data() });
            });
            
            return await buildQuestionsFromWords(allWords.slice(0, 25));
        }
        
        const words = [];
        wordsSnapshot.forEach(doc => {
            words.push({ id: doc.id, ...doc.data() });
        });
        
        console.log(`âœ… Found ${words.length} words in database`);
        
        // Randomly select 25 words
        const shuffled = words.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, 25);
        
        return await buildQuestionsFromWords(selected);
        
    } catch (error) {
        console.error('Error fetching words from database:', error);
        throw new Error('Failed to load words from database: ' + error.message);
    }
}

async function buildQuestionsFromWords(words) {
    stage1Questions = [];
    
    for (const wordData of words) {
        const word = wordData.word || wordData.id;
        
        // Get synonyms and antonyms from meanings
        let synonyms = [];
        let antonyms = [];
        let definition = '';
        let example = '';
        
        if (wordData.meanings && wordData.meanings.length > 0) {
            wordData.meanings.forEach(meaning => {
                definition = definition || meaning.definition;
                example = example || meaning.example;
                
                if (meaning.synonyms && meaning.synonyms.length > 0) {
                    synonyms = synonyms.concat(meaning.synonyms);
                }
                if (meaning.antonyms && meaning.antonyms.length > 0) {
                    antonyms = antonyms.concat(meaning.antonyms);
                }
            });
        }
        
        // Decide question type
        const hasEnoughSynonyms = synonyms.length >= 1;
        const hasEnoughAntonyms = antonyms.length >= 1;
        
        let questionType;
        if (hasEnoughSynonyms && hasEnoughAntonyms) {
            questionType = Math.random() > 0.5 ? 'synonym' : 'antonym';
        } else if (hasEnoughSynonyms) {
            questionType = 'synonym';
        } else if (hasEnoughAntonyms) {
            questionType = 'antonym';
        } else {
            questionType = 'definition';
        }
        
        const availableWords = questionType === 'synonym' ? synonyms : antonyms;
        const correctAnswer = availableWords.length > 0 ? availableWords[0] : word;
        
        // Get wrong options from other words
        const wrongOptions = words
            .filter(w => (w.word || w.id) !== word && (w.word || w.id) !== correctAnswer)
            .map(w => w.word || w.id)
            .sort(() => 0.5 - Math.random())
            .slice(0, 3);
        
        // Build options
        const options = [correctAnswer, ...wrongOptions].sort(() => 0.5 - Math.random());
        const correctIndex = options.indexOf(correctAnswer);
        
        // Build sentence
        const sentence = example || 
            `Find the ${questionType} of "${word}"` + 
            (definition ? `: ${definition}` : '');
        
        stage1Questions.push({
            word: word,
            targetWord: word,
            type: questionType,
            sentence: sentence,
            options: options,
            correctAnswer: correctIndex
        });
    }
    
    console.log('âœ… Built', stage1Questions.length, 'questions from database');
    return stage1Questions;
}

function loadStage1Question() {
    if (stage1CurrentIndex >= stage1Questions.length) {
        completeStage1();
        return;
    }
    
    const question = stage1Questions[stage1CurrentIndex];
    const container = document.getElementById('stage1-question-container');
    
    document.getElementById('stage1-progress').textContent = 
        `Question ${stage1CurrentIndex + 1} of ${stage1Questions.length}`;
    
    container.innerHTML = `
        <div style="margin: 30px 0;">
            <p style="font-size: 1.3rem; margin-bottom: 20px; line-height: 1.6;">
                <strong>${question.sentence}</strong>
            </p>
            <p style="color: #666; margin-bottom: 10px;">
                Select the best ${question.type === 'synonym' ? 'SYNONYM' : 'ANTONYM'} for the word: 
                <strong style="color: #0d3b66;">${question.targetWord}</strong>
            </p>
        </div>
        
        <div class="quiz-options">
            ${question.options.map((option, index) => `
                <div class="quiz-option" onclick="checkStage1Answer(${index})">
                    ${option}
                </div>
            `).join('')}
        </div>
        
        <div id="stage1-feedback" style="margin-top: 20px;"></div>
    `;
}

async function checkStage1Answer(selectedIndex) {
    const question = stage1Questions[stage1CurrentIndex];
    const options = document.querySelectorAll('.quiz-option');
    const feedbackDiv = document.getElementById('stage1-feedback');
    
    // Disable all options
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        stage1Score++;
        options[selectedIndex].classList.add('correct');
        feedbackDiv.innerHTML = '<div class="feedback success">âœ… Correct!</div>';
        
        document.getElementById('stage1-score').textContent = stage1Score;
        
        // âœ… Update Firestore
        await db.collection('tournaments').doc(currentTournament)
            .collection('participants').doc(currentUser.uid).update({
                score: stage1Score,
                currentQuestion: stage1CurrentIndex + 1
            });
        
        setTimeout(() => {
            stage1CurrentIndex++;
            loadStage1Question();
        }, 1000);
        
    } else {
        stage1Errors++;
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
        
        document.getElementById('stage1-errors').textContent = stage1Errors;
        
        // âœ… Update Firestore
        await db.collection('tournaments').doc(currentTournament)
            .collection('participants').doc(currentUser.uid).update({
                errors: stage1Errors,
                handicaps: stage1Handicaps,
                currentQuestion: stage1CurrentIndex + 1
            });
        
        if (stage1Errors >= 2 && stage1Handicaps === 0) {
            // Eliminated
            await db.collection('tournaments').doc(currentTournament)
                .collection('participants').doc(currentUser.uid).update({
                    status: 'eliminated',
                    eliminatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            feedbackDiv.innerHTML = '<div class="feedback error">âŒ Eliminated! You made 2 errors with no handicaps.</div>';
            setTimeout(() => eliminateFromStage1(), 2000);
            
        } else if (stage1Errors >= 2 && stage1Handicaps > 0) {
            stage1Handicaps--;
            stage1Errors = 0;
            
            document.getElementById('stage1-handicaps').textContent = stage1Handicaps;
            document.getElementById('stage1-errors').textContent = stage1Errors;
            
            await db.collection('tournaments').doc(currentTournament)
                .collection('participants').doc(currentUser.uid).update({
                    errors: 0,
                    handicaps: stage1Handicaps
                });
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    âŒ Wrong! Correct: ${question.options[question.correctAnswer]}<br>
                    ğŸ›¡ï¸ Handicap used! Errors reset. Handicaps: ${stage1Handicaps}
                </div>
            `;
            
            setTimeout(() => {
                stage1CurrentIndex++;
                loadStage1Question();
            }, 2000);
        } else {
            feedbackDiv.innerHTML = `<div class="feedback error">âŒ Wrong! Correct: ${question.options[question.correctAnswer]}</div>`;
            setTimeout(() => {
                stage1CurrentIndex++;
                loadStage1Question();
            }, 2000);
        }
    }
}
function startStage1Timer() {
    if (stage1Timer) clearInterval(stage1Timer);
    
    stage1Timer = setInterval(() => {
        stage1TimeLeft--;
        
        const minutes = Math.floor(stage1TimeLeft / 60);
        const seconds = stage1TimeLeft % 60;
        document.getElementById('stage1-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is low
        if (stage1TimeLeft <= 60) {
            document.getElementById('stage1-timer').style.color = '#dc3545';
        }
        
        if (stage1TimeLeft <= 0) {
            clearInterval(stage1Timer);
            completeStage1();
        }
    }, 1000);
}


function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    if (stage2Timer) clearInterval(stage2Timer);
    if (stage3Timer) clearInterval(stage3Timer);
    
    // âœ… Clean up leaderboard listener
    if (stage1LeaderboardListener) {
        stage1LeaderboardListener();
        stage1LeaderboardListener = null;
    }
    
    // âœ… Remove leaderboard UI
    const leaderboard = document.getElementById('stage1-leaderboard');
    if (leaderboard) {
        leaderboard.remove();
    }
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    const stage2 = document.getElementById('tournament-stage2');
    if (stage2) stage2.style.display = 'none';
    
    const stage3 = document.getElementById('tournament-stage3');
    if (stage3) stage3.style.display = 'none';
    
    loadTournamentList();
}
        
async function completeStage1() {
    clearInterval(stage1Timer);
    
    // âœ… Mark as completed in Firestore
    await db.collection('tournaments').doc(currentTournament)
        .collection('participants').doc(currentUser.uid).update({
            status: 'completed',
            completedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    
    const container = document.getElementById('stage1-question-container');
    const percentage = Math.round((stage1Score / stage1Questions.length) * 100);
    
    // âœ… Get final rankings
    const participantsSnapshot = await db.collection('tournaments').doc(currentTournament)
        .collection('participants')
        .where('stage', '==', 1)
        .orderBy('score', 'desc')
        .get();
    
    const allPlayers = [];
    participantsSnapshot.forEach(doc => {
        allPlayers.push({ id: doc.id, ...doc.data() });
    });
    
    const myRank = allPlayers.findIndex(p => p.id === currentUser.uid) + 1;
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'ğŸ†' : percentage >= 60 ? 'â­' : 'ğŸ“š'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 1 Complete!</h2>
            
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 10px 0;">
                    ${stage1Score} / ${stage1Questions.length} Correct
                </div>
                <p style="font-size: 1.2rem; color: #666;">
                    Accuracy: ${percentage}%
                </p>
                <p style="font-size: 1.3rem; color: #667eea; font-weight: bold; margin: 10px 0;">
                    ğŸ… Your Rank: #${myRank} of ${allPlayers.length}
                </p>
                <p style="font-size: 1.1rem; color: #667eea;">
                    ğŸ›¡ï¸ Handicaps Remaining: ${stage1Handicaps}
                </p>
            </div>
            
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0; max-height: 300px; overflow-y: auto;">
                <h3 style="color: #0d3b66; margin-bottom: 15px;">ğŸ† Final Rankings</h3>
                ${allPlayers.slice(0, 10).map((player, index) => `
                    <div style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 5px; background: ${player.id === currentUser.uid ? '#e3f2fd' : 'white'}; border-radius: 5px;">
                        <span style="font-weight: ${index < 3 ? 'bold' : 'normal'};">
                            ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`} 
                            ${player.name || 'Player'}
                            ${player.id === currentUser.uid ? ' (You)' : ''}
                        </span>
                        <span style="font-weight: bold; color: #28a745;">
                            ${player.score} pts
                        </span>
                    </div>
                `).join('')}
            </div>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">âœ… Qualified for Stage 2!</h3>
                    <p style="color: #155724;">
                        You'll carry ${stage1Handicaps} handicap(s) into the next round.
                    </p>
                </div>
                <button class="practice-btn" onclick="proceedToStage2()" style="font-size: 1.2rem; padding: 15px 40px;">
                    â¡ï¸ Proceed to Stage 2
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">âŒ Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    ğŸ  Return to Lobby
                </button>
            `}
        </div>
    `;
}

        
let stage1LeaderboardListener = null;

function setupStage1Leaderboard(tournamentId) {
    const leaderboardContainer = document.createElement('div');
    leaderboardContainer.id = 'stage1-leaderboard';
    leaderboardContainer.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        max-width: 300px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 100;
    `;
    
    document.body.appendChild(leaderboardContainer);
    
    // âœ… Listen to all participants in real-time
    stage1LeaderboardListener = db.collection('tournaments').doc(tournamentId)
        .collection('participants')
        .where('stage', '==', 1)
        .onSnapshot(snapshot => {
            const players = [];
            snapshot.forEach(doc => {
                players.push({ id: doc.id, ...doc.data() });
            });
            
            // Sort by score (descending), then by current question (descending)
            players.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.currentQuestion - a.currentQuestion;
            });
            
            leaderboardContainer.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: #0d3b66; font-size: 1.1rem;">
                    ğŸ† Live Leaderboard (${players.length})
                </h3>
                ${players.map((player, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: ${player.id === currentUser.uid ? '#e3f2fd' : '#f9f9f9'}; border-radius: 8px; border-left: 4px solid ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#0d3b66'};">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #0d3b66; font-size: 0.9rem;">
                                ${index + 1}. ${player.name || 'Player'}
                                ${player.id === currentUser.uid ? ' (You)' : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">
                                Q${player.currentQuestion + 1}/25 â€¢ ${player.errors} errors
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">
                                ${player.score}
                            </div>
                            <div style="font-size: 0.75rem; color: #666;">
                                ${player.status === 'active' ? 'ğŸŸ¢' : 'ğŸ”´'}
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        });
}        

function eliminateFromStage1() {
    clearInterval(stage1Timer);
    
    const container = document.getElementById('stage1-question-container');
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 1</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You made 2 errors with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage1Score} / ${stage1CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                ğŸ  Return to Lobby
            </button>
        </div>
    `;
}

function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    // Reload tournament list
    loadTournamentList();
}

function proceedToStage2() {
    alert('Stage 2 will be implemented next! ğŸ‰');
    // This will be implemented in the next step
}

async function loadTournamentList() {
    const container = document.getElementById('tournament-list-container');
    container.innerHTML = '<div class="loading">Loading tournaments...</div>';
    
    try {
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('startDate', 'asc')
            .get();
        
        if (tournamentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ†</div>
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">No Active Tournaments</h3>
                    <p style="color: #666;">Check back later for upcoming spelling tournaments!</p>
                </div>
            `;
            return;
        }
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.status === 'upcoming' || data.status === 'active') {
                tournaments.push({ id: doc.id, ...data });
            }
        });
        
        if (tournaments.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ†</div>
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">No Active Tournaments</h3>
                    <p style="color: #666;">Check back later for upcoming spelling tournaments!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = tournaments.map(tournament => {
            const isFull = tournament.participants >= tournament.maxParticipants;
            const isRegistered = tournament.registeredUsers?.includes(currentUser?.uid);
            
            const levelEmoji = {
                'foundation': 'ğŸŒ±',
                'challenge': 'ğŸ¯',
                'advanced': 'ğŸš€',
                'championship': 'ğŸ†'
            };
            
            const statusColor = {
                'upcoming': '#ffc107',
                'active': '#28a745',
                'completed': '#6c757d',
                'cancelled': '#dc3545'
            };
            
            return `
                <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-left: 5px solid ${statusColor[tournament.status]};">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="color: #0d3b66; margin: 0 0 10px 0; font-size: 1.5rem;">${levelEmoji[tournament.level]} ${tournament.name}</h3>
                            <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">${tournament.description}</p>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">ğŸ“…</span>
                                    <span style="color: #666;">${new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">ğŸ•</span>
                                    <span style="color: #666;">${tournament.startTime}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">ğŸ‘¥</span>
                                    <span style="color: #666;">${tournament.participants} / ${tournament.maxParticipants} registered</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="background: ${statusColor[tournament.status]}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; margin-bottom: 15px;">
                                ${tournament.status === 'upcoming' ? 'ğŸ“… Upcoming' : tournament.status === 'active' ? 'â–¶ï¸ Live Now' : 'âœ… Completed'}
                            </div>
                            
                            ${currentUser ? (
                                isRegistered ? (
                                    tournament.status === 'active' && tournament.sessionActive ? `
                                        <button class="practice-btn" onclick="joinLiveTournament('${tournament.id}')" style="background: #28a745; animation: pulse 2s infinite;">
                                            âš¡ JOIN NOW - LIVE!
                                        </button>
                                    ` : `
                                        <button class="practice-btn" disabled style="background: #28a745; opacity: 0.7; cursor: not-allowed;">
                                            âœ… Registered
                                        </button>
                                    `
                                ) : isFull ? `
                                    <button class="practice-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                                        ğŸ”’ Full
                                    </button>
                                ` : tournament.status === 'upcoming' ? `
                                    <button class="practice-btn" onclick="registerForTournament('${tournament.id}')" style="font-size: 1.1rem; padding: 12px 30px;">
                                        ğŸ“ Register
                                    </button>
                                ` : `
                                    <button class="practice-btn" disabled style="opacity: 0.5;">
                                        Tournament Started
                                    </button>
                                `
                            ) : `
                                <button class="practice-btn" onclick="showAuthModal()" style="font-size: 1.1rem; padding: 12px 30px;">
                                    ğŸ” Sign In to Join
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // âœ… SET UP REAL-TIME LISTENERS FOR REGISTERED TOURNAMENTS
        if (currentUser) {
            setupTournamentListeners(tournaments);
        }
        
    } catch (error) {
        console.error('Error loading tournaments:', error);
        container.innerHTML = `
            <div class="feedback error">
                âŒ Failed to load tournaments: ${error.message}
            </div>
        `;
    }
}

async function registerForTournament(tournamentId) {
    if (!currentUser) {
        alert('Please sign in to register');
        showAuthModal();
        return;
    }
    
    try {
        const tournamentRef = db.collection('tournaments').doc(tournamentId);
        const tournamentDoc = await tournamentRef.get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Check if already registered
        if (tournament.registeredUsers?.includes(currentUser.uid)) {
            alert('You are already registered for this tournament');
            return;
        }
        
        // Check if full
        if (tournament.participants >= tournament.maxParticipants) {
            alert('This tournament is full');
            return;
        }
        
        // Register user
        await tournamentRef.update({
            participants: firebase.firestore.FieldValue.increment(1),
            registeredUsers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        
        alert('âœ… Successfully registered for the tournament!');
        
        // Reload list
        loadTournamentList();
        
    } catch (error) {
        console.error('Error registering for tournament:', error);
        alert('Failed to register: ' + error.message);
    }
}

  
async function proceedToStage2() {
    try {
        console.log('ğŸ¯ Starting Stage 2: AI Audio Spelling');
        
        tournamentStage = 2;
        stage2CurrentIndex = 0;
        stage2Score = 0;
        stage2Errors = 0;
        stage2TimeLeft = 900;
        stage2HandicapsRemaining = 1 + stage1Handicaps; // Add carried handicaps
        
        // Hide Stage 1
        document.getElementById('tournament-stage1').style.display = 'none';
        
        // Create Stage 2 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage2Container = document.getElementById('tournament-stage2');
        
        if (!stage2Container) {
            stage2Container = document.createElement('div');
            stage2Container.id = 'tournament-stage2';
            tournamentsSection.appendChild(stage2Container);
        }
        
        stage2Container.style.display = 'block';
        
        // Show loading
        stage2Container.innerHTML = '<div class="loading">ğŸ“š Loading Stage 2 words...</div>';
        
        // Generate words
        await generateStage2Words();
        
        // Build Stage 2 UI
        buildStage2UI();
        
        // Start timer
        startStage2Timer();
        
        // Load first word
        loadStage2Word();
        
    } catch (error) {
        console.error('Error starting Stage 2:', error);
        alert('Failed to start Stage 2: ' + error.message);
    }
}

async function generateStage2Words() {
    try {
        // Use words from current level
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select 25 random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        stage2Words = shuffled.slice(0, 25);
        
        console.log('âœ… Generated 25 words for Stage 2:', stage2Words);
        
    } catch (error) {
        console.error('Error generating Stage 2 words:', error);
        throw error;
    }
}

function buildStage2UI() {
    const container = document.getElementById('tournament-stage2');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: #0d3b66; margin: 0;">ğŸ¤ Stage 2: AI Audio Spelling</h2>
                <button class="practice-btn" onclick="exitTournament()" style="background: #dc3545; padding: 10px 20px;">
                    ğŸšª Exit
                </button>
            </div>
            
            <!-- Timer and Stats -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">â±ï¸ Time Remaining</div>
                    <div id="stage2-timer" style="font-size: 2rem; font-weight: bold; color: #0d3b66;">15:00</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">âœ… Correct</div>
                    <div id="stage2-score" style="font-size: 2rem; font-weight: bold; color: #28a745;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">âŒ Errors</div>
                    <div id="stage2-errors" style="font-size: 2rem; font-weight: bold; color: #dc3545;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ğŸ›¡ï¸ Handicaps</div>
                    <div id="stage2-handicaps" style="font-size: 2rem; font-weight: bold; color: #667eea;">${stage2HandicapsRemaining}</div>
                </div>
            </div>
            
            <!-- Progress -->
            <h3 id="stage2-progress">Word 1 of 25</h3>
            
            <!-- Audio Controls -->
            <div style="text-align: center; margin: 30px 0;">
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="practice-btn" onclick="speakStage2Word()" style="font-size: 1.1rem; padding: 15px 30px;">
                        ğŸ”Š Play Word
                    </button>
                    <button class="practice-btn" onclick="speakStage2Sentence()" style="font-size: 1.1rem; padding: 15px 30px; background: #17a2b8;">
                        ğŸ’¬ Use in Sentence
                    </button>
                </div>
                <p style="color: #666; font-style: italic; font-size: 0.9rem;">Listen and spell the word you hear</p>
            </div>
            
            <!-- Input Field -->
            <div class="form-group" style="margin: 30px 0;">
                <label style="font-size: 1.2rem;">Type what you hear:</label>
                <input type="text" id="stage2-input" 
                       placeholder="Use the keyboard below..." 
                       style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                       readonly>
            </div>
            
            <!-- Virtual Keyboard -->
            <div class="virtual-keyboard">
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('Q')">Q</button>
                    <button class="keyboard-key" onclick="typeStage2Key('W')">W</button>
                    <button class="keyboard-key" onclick="typeStage2Key('E')">E</button>
                    <button class="keyboard-key" onclick="typeStage2Key('R')">R</button>
                    <button class="keyboard-key" onclick="typeStage2Key('T')">T</button>
                    <button class="keyboard-key" onclick="typeStage2Key('Y')">Y</button>
                    <button class="keyboard-key" onclick="typeStage2Key('U')">U</button>
                    <button class="keyboard-key" onclick="typeStage2Key('I')">I</button>
                    <button class="keyboard-key" onclick="typeStage2Key('O')">O</button>
                    <button class="keyboard-key" onclick="typeStage2Key('P')">P</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('A')">A</button>
                    <button class="keyboard-key" onclick="typeStage2Key('S')">S</button>
                    <button class="keyboard-key" onclick="typeStage2Key('D')">D</button>
                    <button class="keyboard-key" onclick="typeStage2Key('F')">F</button>
                    <button class="keyboard-key" onclick="typeStage2Key('G')">G</button>
                    <button class="keyboard-key" onclick="typeStage2Key('H')">H</button>
                    <button class="keyboard-key" onclick="typeStage2Key('J')">J</button>
                    <button class="keyboard-key" onclick="typeStage2Key('K')">K</button>
                    <button class="keyboard-key" onclick="typeStage2Key('L')">L</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('Z')">Z</button>
                    <button class="keyboard-key" onclick="typeStage2Key('X')">X</button>
                    <button class="keyboard-key" onclick="typeStage2Key('C')">C</button>
                    <button class="keyboard-key" onclick="typeStage2Key('V')">V</button>
                    <button class="keyboard-key" onclick="typeStage2Key('B')">B</button>
                    <button class="keyboard-key" onclick="typeStage2Key('N')">N</button>
                    <button class="keyboard-key" onclick="typeStage2Key('M')">M</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key backspace" onclick="backspaceStage2Key()">âŒ« Delete</button>
                    <button class="keyboard-key space" onclick="typeStage2Key(' ')">Space</button>
                    <button class="keyboard-key enter" onclick="submitStage2Answer()">âœ“ Enter</button>
                </div>
            </div>
            
            <div id="stage2-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
}

function startStage2Timer() {
    if (stage2Timer) clearInterval(stage2Timer);
    
    stage2Timer = setInterval(() => {
        stage2TimeLeft--;
        
        const minutes = Math.floor(stage2TimeLeft / 60);
        const seconds = stage2TimeLeft % 60;
        document.getElementById('stage2-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (stage2TimeLeft <= 60) {
            document.getElementById('stage2-timer').style.color = '#dc3545';
        }
        
        if (stage2TimeLeft <= 0) {
            clearInterval(stage2Timer);
            completeStage2();
        }
    }, 1000);
}

function loadStage2Word() {
    if (stage2CurrentIndex >= stage2Words.length) {
        completeStage2();
        return;
    }
    
    document.getElementById('stage2-progress').textContent = 
        `Word ${stage2CurrentIndex + 1} of ${stage2Words.length}`;
    
    document.getElementById('stage2-input').value = '';
    document.getElementById('stage2-feedback').innerHTML = '';
    
    // Auto-play word
    setTimeout(() => speakStage2Word(), 500);
}

function speakStage2Word() {
    const word = stage2Words[stage2CurrentIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage2Sentence() {
    const word = stage2Words[stage2CurrentIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage2Word();
    }
}

function typeStage2Key(letter) {
    const input = document.getElementById('stage2-input');
    input.value += letter.toLowerCase();
}

function backspaceStage2Key() {
    const input = document.getElementById('stage2-input');
    input.value = input.value.slice(0, -1);
}

function submitStage2Answer() {
    const userAnswer = document.getElementById('stage2-input').value.trim().toLowerCase();
    const correctWord = stage2Words[stage2CurrentIndex].toLowerCase();
    const feedbackDiv = document.getElementById('stage2-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">âš ï¸ Please type a word</div>';
        return;
    }
    
    const isCorrect = userAnswer === correctWord;
    
    if (isCorrect) {
        stage2Score++;
        feedbackDiv.innerHTML = '<div class="feedback success">âœ… Correct!</div>';
        document.getElementById('stage2-score').textContent = stage2Score;
        
        setTimeout(() => {
            stage2CurrentIndex++;
            loadStage2Word();
        }, 1000);
        
    } else {
        stage2Errors++;
        document.getElementById('stage2-errors').textContent = stage2Errors;
        
        // Check elimination
        if (stage2Errors >= 1 && stage2HandicapsRemaining === 0) {
            feedbackDiv.innerHTML = `<div class="feedback error">âŒ Eliminated! Wrong spelling. Correct: ${correctWord}</div>`;
            setTimeout(() => eliminateFromStage2(), 2000);
        } else if (stage2Errors >= 1 && stage2HandicapsRemaining > 0) {
            // Use handicap
            stage2HandicapsRemaining--;
            stage2Errors = 0;
            document.getElementById('stage2-handicaps').textContent = stage2HandicapsRemaining;
            document.getElementById('stage2-errors').textContent = stage2Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    âŒ Wrong! Correct: ${correctWord}<br>
                    ğŸ›¡ï¸ Handicap used! Errors reset. Handicaps remaining: ${stage2HandicapsRemaining}
                </div>
            `;
            
            setTimeout(() => {
                stage2CurrentIndex++;
                loadStage2Word();
            }, 2000);
        }
    }
}

function completeStage2() {
    clearInterval(stage2Timer);
    
    const container = document.getElementById('tournament-stage2');
    const percentage = Math.round((stage2Score / stage2Words.length) * 100);
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'ğŸ†' : percentage >= 60 ? 'â­' : 'ğŸ“š'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 2 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage2Score} / ${stage2Words.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                ğŸ›¡ï¸ Handicaps Remaining: ${stage2HandicapsRemaining}
            </p>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">âœ… Qualified for Stage 3!</h3>
                    <p style="color: #155724;">
                        You'll carry ${stage2HandicapsRemaining} handicap(s) into Stage 3.
                    </p>
                </div>
                <button class="practice-btn" onclick="proceedToStage3()" style="font-size: 1.2rem; padding: 15px 40px;">
                    â¡ï¸ Proceed to Stage 3
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">âŒ Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance to Stage 3.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    ğŸ  Return to Lobby
                </button>
            `}
        </div>
    `;
}

function eliminateFromStage2() {
    clearInterval(stage2Timer);
    
    const container = document.getElementById('tournament-stage2');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 2</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                One error with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage2Score} / ${stage2CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                ğŸ  Return to Lobby
            </button>
        </div>
    `;
}


     

async function proceedToStage3() {
    try {
        console.log('ğŸ¯ Starting Stage 3: Spelling Challenge');
        
        tournamentStage = 3;
        stage3CurrentIndex = 0;
        stage3Score = 0;
        stage3Errors = 0;
        stage3TimeLeft = 900;
        stage3HandicapsRemaining = stage2HandicapsRemaining; // Carry from Stage 2
        
        // Hide Stage 2
        document.getElementById('tournament-stage2').style.display = 'none';
        
        // Create Stage 3 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage3Container = document.getElementById('tournament-stage3');
        
        if (!stage3Container) {
            stage3Container = document.createElement('div');
            stage3Container.id = 'tournament-stage3';
            tournamentsSection.appendChild(stage3Container);
        }
        
        stage3Container.style.display = 'block';
        stage3Container.innerHTML = '<div class="loading">ğŸ“š Loading Stage 3 words...</div>';
        
        // Generate words
        await generateStage3Words();
        
        // Build UI
        buildStage3UI();
        
        // Start timer
        startStage3Timer();
        
        // Load first word
        loadStage3Word();
        
    } catch (error) {
        console.error('Error starting Stage 3:', error);
        alert('Failed to start Stage 3: ' + error.message);
    }
}

async function generateStage3Words() {
    try {
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select 25 random words for unscrambling
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        stage3Words = shuffled.slice(0, 25);
        
        console.log('âœ… Generated 25 words for Stage 3:', stage3Words);
        
    } catch (error) {
        console.error('Error generating Stage 3 words:', error);
        throw error;
    }
}

function buildStage3UI() {
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: #0d3b66; margin: 0;">ğŸ”¤ Stage 3: Unscramble Challenge</h2>
                <button class="practice-btn" onclick="exitTournament()" style="background: #dc3545; padding: 10px 20px;">
                    ğŸšª Exit
                </button>
            </div>
            
            <!-- Timer and Stats -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">â±ï¸ Time Remaining</div>
                    <div id="stage3-timer" style="font-size: 2rem; font-weight: bold; color: #0d3b66;">15:00</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">âœ… Correct</div>
                    <div id="stage3-score" style="font-size: 2rem; font-weight: bold; color: #28a745;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">âŒ Errors</div>
                    <div id="stage3-errors" style="font-size: 2rem; font-weight: bold; color: #dc3545;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ğŸ›¡ï¸ Handicaps</div>
                    <div id="stage3-handicaps" style="font-size: 2rem; font-weight: bold; color: #667eea;">${stage3HandicapsRemaining}</div>
                </div>
            </div>
            
            <h3 id="stage3-progress">Word 1 of 25</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                
                <div id="stage3-letter-tiles" class="letter-tiles-container">
                    <!-- Letter tiles will be inserted here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="shuffleStage3Letters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                        ğŸ”€ Shuffle
                    </button>
                    
                    <button class="practice-btn" onclick="submitStage3Answer()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        âœ“ Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="stage3-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
}

function startStage3Timer() {
    if (stage3Timer) clearInterval(stage3Timer);
    
    stage3Timer = setInterval(() => {
        stage3TimeLeft--;
        
        const minutes = Math.floor(stage3TimeLeft / 60);
        const seconds = stage3TimeLeft % 60;
        document.getElementById('stage3-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (stage3TimeLeft <= 60) {
            document.getElementById('stage3-timer').style.color = '#dc3545';
        }
        
        if (stage3TimeLeft <= 0) {
            clearInterval(stage3Timer);
            completeStage3();
        }
    }, 1000);
}

function loadStage3Word() {
    if (stage3CurrentIndex >= stage3Words.length) {
        completeStage3();
        return;
    }
    
    const word = stage3Words[stage3CurrentIndex];
    
    document.getElementById('stage3-progress').textContent = 
        `Word ${stage3CurrentIndex + 1} of ${stage3Words.length}`;
    
    document.getElementById('stage3-feedback').innerHTML = '';
    
    // Scramble the letters
    shuffleStage3Letters();
}

function shuffleStage3Letters() {
    const word = stage3Words[stage3CurrentIndex];
    const letters = word.split('');
    let scrambled = [...letters];
    
    // Shuffle the array
    let attempts = 0;
    do {
        for (let i = scrambled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
        }
        attempts++;
    } while (scrambled.join('') === word && attempts < 10);
    
    stage3CurrentLetterOrder = scrambled;
    renderStage3LetterTiles();
}

function renderStage3LetterTiles() {
    const container = document.getElementById('stage3-letter-tiles');
    container.innerHTML = '';
    
    stage3CurrentLetterOrder.forEach((letter, index) => {
        const tile = document.createElement('div');
        tile.className = 'letter-tile';
        tile.textContent = letter.toUpperCase();
        tile.draggable = true;
        tile.dataset.index = index;
        
        // Drag events
        tile.addEventListener('dragstart', handleStage3DragStart);
        tile.addEventListener('dragend', handleStage3DragEnd);
        tile.addEventListener('dragover', handleStage3DragOver);
        tile.addEventListener('drop', handleStage3Drop);
        tile.addEventListener('dragenter', handleStage3DragEnter);
        tile.addEventListener('dragleave', handleStage3DragLeave);
        
        // Touch events for mobile
        tile.addEventListener('touchstart', handleStage3TouchStart, { passive: false });
        tile.addEventListener('touchmove', handleStage3TouchMove, { passive: false });
        tile.addEventListener('touchend', handleStage3TouchEnd);
        
        container.appendChild(tile);
    });
}

function handleStage3DragStart(e) {
    stage3DraggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleStage3DragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
}

function handleStage3DragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleStage3DragEnter(e) {
    if (this !== stage3DraggedElement) {
        this.classList.add('drag-over');
    }
}

function handleStage3DragLeave(e) {
    this.classList.remove('drag-over');
}

function handleStage3Drop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    this.classList.remove('drag-over');
    
    if (stage3DraggedElement !== this) {
        const draggedIndex = parseInt(stage3DraggedElement.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        
        [stage3CurrentLetterOrder[draggedIndex], stage3CurrentLetterOrder[targetIndex]] = 
        [stage3CurrentLetterOrder[targetIndex], stage3CurrentLetterOrder[draggedIndex]];
        
        renderStage3LetterTiles();
    }
    
    return false;
}

// Touch support for mobile
let stage3TouchTarget = null;
let stage3TouchClone = null;

function handleStage3TouchStart(e) {
    e.preventDefault();
    stage3TouchTarget = this;
    this.classList.add('dragging');
    
    stage3TouchClone = this.cloneNode(true);
    stage3TouchClone.style.position = 'fixed';
    stage3TouchClone.style.zIndex = '10000';
    stage3TouchClone.style.pointerEvents = 'none';
    stage3TouchClone.style.opacity = '0.8';
    document.body.appendChild(stage3TouchClone);
    
    updateStage3TouchClonePosition(e.touches[0]);
}

function handleStage3TouchMove(e) {
    e.preventDefault();
    if (!stage3TouchTarget) return;
    
    updateStage3TouchClonePosition(e.touches[0]);
    
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== stage3TouchTarget) {
        elementBelow.classList.add('drag-over');
    }
}

function handleStage3TouchEnd(e) {
    e.preventDefault();
    if (!stage3TouchTarget) return;
    
    stage3TouchTarget.classList.remove('dragging');
    
    if (stage3TouchClone) {
        stage3TouchClone.remove();
        stage3TouchClone = null;
    }
    
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== stage3TouchTarget) {
        const draggedIndex = parseInt(stage3TouchTarget.dataset.index);
        const targetIndex = parseInt(elementBelow.dataset.index);
        
        [stage3CurrentLetterOrder[draggedIndex], stage3CurrentLetterOrder[targetIndex]] = 
        [stage3CurrentLetterOrder[targetIndex], stage3CurrentLetterOrder[draggedIndex]];
        
        renderStage3LetterTiles();
    }
    
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    stage3TouchTarget = null;
}

function updateStage3TouchClonePosition(touch) {
    if (stage3TouchClone) {
        stage3TouchClone.style.left = (touch.clientX - 30) + 'px';
        stage3TouchClone.style.top = (touch.clientY - 30) + 'px';
    }
}

function submitStage3Answer() {
    const userWord = stage3CurrentLetterOrder.join('').toLowerCase();
    const correctWord = stage3Words[stage3CurrentIndex].toLowerCase();
    const feedbackDiv = document.getElementById('stage3-feedback');
    
    if (userWord === correctWord) {
        stage3Score++;
        feedbackDiv.innerHTML = '<div class="feedback success">âœ… Correct!</div>';
        document.getElementById('stage3-score').textContent = stage3Score;
        
        setTimeout(() => {
            stage3CurrentIndex++;
            loadStage3Word();
        }, 1000);
        
    } else {
        stage3Errors++;
        document.getElementById('stage3-errors').textContent = stage3Errors;
        
        // Check elimination
        if (stage3Errors >= 1 && stage3HandicapsRemaining === 0) {
            feedbackDiv.innerHTML = `<div class="feedback error">âŒ Eliminated! Wrong word. Correct: ${correctWord}</div>`;
            setTimeout(() => eliminateFromStage3(), 2000);
        } else if (stage3Errors >= 1 && stage3HandicapsRemaining > 0) {
            // Use handicap
            stage3HandicapsRemaining--;
            stage3Errors = 0;
            document.getElementById('stage3-handicaps').textContent = stage3HandicapsRemaining;
            document.getElementById('stage3-errors').textContent = stage3Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    âŒ Wrong! Correct: ${correctWord}<br>
                    ğŸ›¡ï¸ Handicap used! Errors reset. Handicaps remaining: ${stage3HandicapsRemaining}
                </div>
            `;
            
            setTimeout(() => {
                stage3CurrentIndex++;
                loadStage3Word();
            }, 2000);
        }
    }
}

function completeStage3() {
    clearInterval(stage3Timer);
    
    const container = document.getElementById('tournament-stage3');
    const percentage = Math.round((stage3Score / stage3Words.length) * 100);
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'ğŸ†' : percentage >= 60 ? 'â­' : 'ğŸ“š'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 3 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage3Score} / ${stage3Words.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                ğŸ›¡ï¸ Handicaps Remaining: ${stage3HandicapsRemaining}
            </p>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">âœ… Qualified for Stage 4!</h3>
                    <p style="color: #155724;">
                        Congratulations! You've reached the Live Spell Master rounds.<br>
                        <strong>Next:</strong> Top 10 compete with live human caller
                    </p>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin: 0 0 15px 0;">ğŸ­ Choose Your Role:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <button class="practice-btn" onclick="joinAsSpeller()" style="background: #667eea; font-size: 1rem; padding: 15px;">
                            ğŸ¯ Join as Speller
                        </button>
                        <button class="practice-btn" onclick="joinAsCaller()" style="background: #764ba2; font-size: 1rem; padding: 15px;">
                            ğŸ¤ Join as Caller
                        </button>
                    </div>
                    <p style="color: #856404; margin: 15px 0 0 0; font-size: 0.9rem;">
                        â„¹ï¸ <strong>Speller:</strong> Compete to spell words correctly<br>
                        â„¹ï¸ <strong>Caller:</strong> Read words aloud for spellers
                    </p>
                </div>
                
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d;">
                    ğŸ  Return to Lobby
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">âŒ Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance to the Live Rounds.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    ğŸ  Return to Lobby
                </button>
            `}
        </div>
    `;
}

function eliminateFromStage3() {
    clearInterval(stage3Timer);
    
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 3</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                One error with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage3Score} / ${stage3CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                ğŸ  Return to Lobby
            </button>
        </div>
    `;
}

// Update exitTournament to handle all stages
function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    if (stage2Timer) clearInterval(stage2Timer);
    if (stage3Timer) clearInterval(stage3Timer);
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    const stage2 = document.getElementById('tournament-stage2');
    if (stage2) stage2.style.display = 'none';
    
    const stage3 = document.getElementById('tournament-stage3');
    if (stage3) stage3.style.display = 'none';
    
    loadTournamentList();
} 


 async function joinAsSpeller() {
    callerMode = false;
    
    // Show waiting room
    const container = document.getElementById('tournament-stage3');
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin: 20px 0; animation: pulse 2s infinite;">â³</div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Waiting for Stage 4 to Begin...</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You've joined as a <strong style="color: #667eea;">SPELLER</strong>
            </p>
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 15px;">ğŸ“‹ Stage 4: Live Spell Master (Top 10)</h3>
                <p style="color: #666; line-height: 1.8;">
                    â€¢ Live human caller will read words<br>
                    â€¢ One mistake = eliminated (unless you have a Shield)<br>
                    â€¢ Top 10 spellers advance<br>
                    â€¢ 5-minute break after this round
                </p>
            </div>
            <div class="loading">Waiting for a caller to start the round...</div>
            
            <button class="practice-btn" onclick="exitTournament()" style="margin-top: 20px; background: #6c757d;">
                ğŸšª Leave Waiting Room
            </button>
        </div>
    `;
    
    // In a real implementation, this would connect to a live session
    // For demo purposes, we'll simulate
    setTimeout(() => {
        alert('â° In a live tournament, you would wait here for a caller to start Stage 4.\n\nFor demo purposes, the caller interface is available by choosing "Join as Caller".');
    }, 2000);
}

async function joinAsCaller() {
    callerMode = true;
    
    try {
        // Hide Stage 3
        document.getElementById('tournament-stage3').style.display = 'none';
        
        // Generate words for Stage 4
        await generateLiveStageWords(10); // 10 words for Stage 4
        
        // Show caller interface
        startStage4AsCaller();
        
    } catch (error) {
        console.error('Error starting as caller:', error);
        alert('Failed to start as caller: ' + error.message);
    }
}

  async function generateLiveStageWords(count) {
    try {
        if (!selectedGameLevel) {
            selectedGameLevel = 'championship'; // Use hardest level for finals
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        liveStageWords = shuffled.slice(0, count);
        
        console.log(`âœ… Generated ${count} words for live stage:`, liveStageWords);
        
    } catch (error) {
        console.error('Error generating live stage words:', error);
        throw error;
    }
}

 function startStage4AsCaller() {
    tournamentStage = 4;
    currentLiveStageIndex = 0;
    liveStageParticipants = ['Demo Player 1', 'Demo Player 2', 'Demo Player 3']; // Simulated players
    eliminatedPlayers = [];
    
    const tournamentsSection = document.querySelector('#tournaments-section .word-database');
    let stage4Container = document.getElementById('tournament-stage4');
    
    if (!stage4Container) {
        stage4Container = document.createElement('div');
        stage4Container.id = 'tournament-stage4';
        tournamentsSection.appendChild(stage4Container);
    }
    
    stage4Container.style.display = 'block';
    
    buildStage4CallerUI();
}

function buildStage4CallerUI() {
    const container = document.getElementById('tournament-stage4');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¤ Stage 4: Live Spell Master (Caller Mode)</h2>
                <p style="margin: 0; opacity: 0.9;">You are the human caller for this round</p>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">ğŸ‘¥ Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #d4edda; padding: 10px 20px; border-radius: 20px; color: #155724; font-weight: bold;">
                            âœ… ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">âŒ Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: white;">ğŸ“ Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="caller-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length ? `
                    <button class="practice-btn" onclick="speakCallerWord()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ğŸ”Š Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakCallerSentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        ğŸ’¬ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="caller-controls">
                ${currentLiveStageIndex < liveStageWords.length ? `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 15px 0;">ğŸ“‹ Caller Instructions:</h4>
                        <ol style="color: #856404; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Pronounce the word clearly</li>
                            <li>Use it in a sentence if requested</li>
                            <li>Mark each speller as correct or incorrect</li>
                            <li>One mistake eliminates a speller (unless they have a Shield)</li>
                        </ol>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markSpellerCorrect(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        âœ… Correct
                                    </button>
                                    <button class="practice-btn" onclick="markSpellerIncorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        âŒ Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextCallerWord()" style="font-size: 1.2rem; padding: 15px 40px; background: #667eea;">
                            â¡ï¸ Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ†</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 4 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} spellers advance to Stage 5
                        </p>
                        
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3 style="color: #155724; margin-bottom: 15px;">âœ… Qualified for Stage 5:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                ${liveStageParticipants.map(player => `
                                    <div style="background: white; padding: 15px 25px; border-radius: 10px; color: #155724; font-weight: bold; font-size: 1.1rem;">
                                        ğŸŒŸ ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage5()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            â¡ï¸ Proceed to Stage 5 (Top 5)
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            ğŸ  Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}   

    // ===== TOURNAMENT STAGE 5 FUNCTIONS (Top 10 â†’ Top 5) =====

async function proceedToStage5() {
    try {
        console.log('ğŸ¯ Starting Stage 5: Live Spell Master (Top 10 â†’ Top 5)');
        
        tournamentStage = 5;
        currentLiveStageIndex = 0;
        
        // Keep current participants from Stage 4
        if (liveStageParticipants.length > 10) {
            liveStageParticipants = liveStageParticipants.slice(0, 10);
        }
        
        eliminatedPlayers = [];
        
        // Generate words for Stage 5
        await generateLiveStageWords(15); // 15 words for Stage 5
        
        // Hide Stage 4
        const stage4 = document.getElementById('tournament-stage4');
        if (stage4) stage4.style.display = 'none';
        
        // Create Stage 5 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage5Container = document.getElementById('tournament-stage5');
        
        if (!stage5Container) {
            stage5Container = document.createElement('div');
            stage5Container.id = 'tournament-stage5';
            tournamentsSection.appendChild(stage5Container);
        }
        
        stage5Container.style.display = 'block';
        
        // Show caller interface for Stage 5
        buildStage5CallerUI();
        
    } catch (error) {
        console.error('Error starting Stage 5:', error);
        alert('Failed to start Stage 5: ' + error.message);
    }
}

function buildStage5CallerUI() {
    const container = document.getElementById('tournament-stage5');
    const targetCount = 5; // Advance top 5
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¤ Stage 5: Live Spell Master (Top 10 â†’ Top 5)</h2>
                <p style="margin: 0; opacity: 0.9;">Spell until ${targetCount} spellers remain</p>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666; font-weight: bold;">Active: ${liveStageParticipants.length}</span>
                    <span style="color: #667eea; font-weight: bold;">Target: ${targetCount}</span>
                    <span style="color: #dc3545; font-weight: bold;">Eliminated: ${eliminatedPlayers.length}</span>
                </div>
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${((liveStageParticipants.length / 10) * 100)}%; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">ğŸ‘¥ Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #d4edda; padding: 10px 20px; border-radius: 20px; color: #155724; font-weight: bold;">
                            âœ… ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">âŒ Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: white;">ğŸ“ Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="stage5-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length && liveStageParticipants.length > targetCount ? `
                    <button class="practice-btn" onclick="speakStage5Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ğŸ”Š Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage5Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        ğŸ’¬ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="stage5-caller-controls">
                ${liveStageParticipants.length > targetCount && currentLiveStageIndex < liveStageWords.length ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markStage5Correct(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        âœ… Correct
                                    </button>
                                    <button class="practice-btn" onclick="markStage5Incorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        âŒ Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextStage5Word()" style="font-size: 1.2rem; padding: 15px 40px; background: #667eea;">
                            â¡ï¸ Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ†</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 5 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} spellers advance to Stage 6
                        </p>
                        
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3 style="color: #155724; margin-bottom: 15px;">âœ… Qualified for Stage 6:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                ${liveStageParticipants.map(player => `
                                    <div style="background: white; padding: 15px 25px; border-radius: 10px; color: #155724; font-weight: bold; font-size: 1.1rem;">
                                        ğŸŒŸ ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage6()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            â¡ï¸ Proceed to Stage 6 (Top 5 â†’ Top 3)
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            ğŸ  Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function speakStage5Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage5Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage5Word();
    }
}

function markStage5Correct(playerIndex) {
    // Player stays in the game
    console.log(`âœ… ${liveStageParticipants[playerIndex]} spelled correctly`);
}

function markStage5Incorrect(playerIndex) {
    const player = liveStageParticipants[playerIndex];
    
    if (confirm(`âŒ Are you sure ${player} spelled incorrectly? This will eliminate them.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(playerIndex, 1);
        
        // Rebuild UI
        buildStage5CallerUI();
    }
}

function nextStage5Word() {
    currentLiveStageIndex++;
    
    if (liveStageParticipants.length <= 5) {
        // Reached target - complete stage
        buildStage5CallerUI();
    } else if (currentLiveStageIndex >= liveStageWords.length) {
        // Ran out of words but still too many players - generate more
        alert('âš ï¸ Need more words! Generating additional words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage5CallerUI();
        });
    } else {
        // Continue to next word
        buildStage5CallerUI();
    }
}

// ===== TOURNAMENT STAGE 6 FUNCTIONS (Top 5 â†’ Top 3) =====

async function proceedToStage6() {
    try {
        console.log('ğŸ¯ Starting Stage 6: Live Spell Master (Top 5 â†’ Top 3)');
        
        tournamentStage = 6;
        currentLiveStageIndex = 0;
        
        // Keep top 5 from Stage 5
        if (liveStageParticipants.length > 5) {
            liveStageParticipants = liveStageParticipants.slice(0, 5);
        }
        
        eliminatedPlayers = [];
        
        // Generate words for Stage 6
        await generateLiveStageWords(12); // 12 words for Stage 6
        
        // Hide Stage 5
        const stage5 = document.getElementById('tournament-stage5');
        if (stage5) stage5.style.display = 'none';
        
        // Create Stage 6 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage6Container = document.getElementById('tournament-stage6');
        
        if (!stage6Container) {
            stage6Container = document.createElement('div');
            stage6Container.id = 'tournament-stage6';
            tournamentsSection.appendChild(stage6Container);
        }
        
        stage6Container.style.display = 'block';
        
        // Show caller interface for Stage 6
        buildStage6CallerUI();
        
    } catch (error) {
        console.error('Error starting Stage 6:', error);
        alert('Failed to start Stage 6: ' + error.message);
    }
}

function buildStage6CallerUI() {
    const container = document.getElementById('tournament-stage6');
    const targetCount = 3; // Advance top 3
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: #0d3b66;">
                <h2 style="margin: 0 0 10px 0;">ğŸ¤ Stage 6: Live Spell Master (Top 5 â†’ Top 3)</h2>
                <p style="margin: 0; opacity: 0.9;">Spell until ${targetCount} finalists remain</p>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666; font-weight: bold;">Active: ${liveStageParticipants.length}</span>
                    <span style="color: #FFD700; font-weight: bold;">Target: ${targetCount}</span>
                    <span style="color: #dc3545; font-weight: bold;">Eliminated: ${eliminatedPlayers.length}</span>
                </div>
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #FFD700, #FFA500); height: 100%; width: ${((liveStageParticipants.length / 5) * 100)}%; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">ğŸ‘¥ Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #fff3cd; padding: 10px 20px; border-radius: 20px; color: #856404; font-weight: bold; border: 2px solid #FFD700;">
                            â­ ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">âŒ Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: #0d3b66; text-align: center;">
                <h3 style="margin: 0 0 15px 0;">ğŸ“ Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="stage6-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length && liveStageParticipants.length > targetCount ? `
                    <button class="practice-btn" onclick="speakStage6Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ğŸ”Š Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage6Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        ğŸ’¬ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="stage6-caller-controls">
                ${liveStageParticipants.length > targetCount && currentLiveStageIndex < liveStageWords.length ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #FFD700; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">â­ ${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markStage6Correct(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        âœ… Correct
                                    </button>
                                    <button class="practice-btn" onclick="markStage6Incorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        âŒ Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextStage6Word()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #0d3b66;">
                            â¡ï¸ Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ†</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 6 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} finalists advance to the <strong>FINAL SPELL-OFF</strong>
                        </p>
                        
                        <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 30px; border-radius: 15px; margin: 20px 0;">
                            <h3 style="margin-bottom: 15px; color: #0d3b66;">ğŸŒŸ FINALISTS:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                                ${liveStageParticipants.map((player, idx) => `
                                    <div style="background: white; padding: 20px 30px; border-radius: 15px; color: #0d3b66; font-weight: bold; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                                        ${idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰'} ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage7()" style="font-size: 1.3rem; padding: 20px 50px; margin: 10px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #0d3b66; font-weight: bold;">
                            ğŸ† START FINAL SPELL-OFF
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            ğŸ  Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function speakStage6Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage6Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage6Word();
    }
}

function markStage6Correct(playerIndex) {
    console.log(`âœ… ${liveStageParticipants[playerIndex]} spelled correctly`);
}

function markStage6Incorrect(playerIndex) {
    const player = liveStageParticipants[playerIndex];
    
    if (confirm(`âŒ Are you sure ${player} spelled incorrectly? This will eliminate them from the finals.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(playerIndex, 1);
        
        buildStage6CallerUI();
    }
}

function nextStage6Word() {
    currentLiveStageIndex++;
    
    if (liveStageParticipants.length <= 3) {
        buildStage6CallerUI();
    } else if (currentLiveStageIndex >= liveStageWords.length) {
        alert('âš ï¸ Need more words! Generating additional words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage6CallerUI();
        });
    } else {
        buildStage6CallerUI();
    }
}

// ===== TOURNAMENT STAGE 7 FUNCTIONS (Final Spell-Off: Top 3 â†’ Champion) =====

async function proceedToStage7() {
    try {
        console.log('ğŸ† Starting Stage 7: FINAL SPELL-OFF');
        
        tournamentStage = 7;
        currentLiveStageIndex = 0;
        currentSpellerIndex = 0;
        
        // Keep top 3 from Stage 6
        if (liveStageParticipants.length > 3) {
            liveStageParticipants = liveStageParticipants.slice(0, 3);
        }
        
        eliminatedPlayers = [];
        finalRoundSpelling = null;
        
        // Generate words for Final Round (championship level)
        selectedGameLevel = 'championship';
        await generateLiveStageWords(20); // 20 championship words
        
        // Hide Stage 6
        const stage6 = document.getElementById('tournament-stage6');
        if (stage6) stage6.style.display = 'none';
        
        // Create Stage 7 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage7Container = document.getElementById('tournament-stage7');
        
        if (!stage7Container) {
            stage7Container = document.createElement('div');
            stage7Container.id = 'tournament-stage7';
            tournamentsSection.appendChild(stage7Container);
        }
        
        stage7Container.style.display = 'block';
        
        // Show final spell-off interface
        buildStage7UI();
        
    } catch (error) {
        console.error('Error starting Stage 7:', error);
        alert('Failed to start Final Spell-Off: ' + error.message);
    }
}

// ===== COMPLETE STAGE 7 FUNCTIONS =====

function buildStage7UI() {
    const container = document.getElementById('tournament-stage7');
    
    // Check if we have a winner
    if (liveStageParticipants.length === 1) {
        showTournamentWinner();
        return;
    }
    
    const currentSpeller = liveStageParticipants[currentSpellerIndex];
    const currentWord = liveStageWords[currentLiveStageIndex];
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 20px; color: white; text-align: center;">
                <h1 style="margin: 0 0 10px 0; color: white; font-size: 2.5rem;">ğŸ† FINAL SPELL-OFF ğŸ†</h1>
                <p style="margin: 0; opacity: 0.9; font-size: 1.2rem;">Classic Turn-Based Spelling â€¢ One Wrong Disqualifies</p>
            </div>
            
            <!-- Remaining Finalists -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0; text-align: center;">ğŸŒŸ Remaining Finalists (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    ${liveStageParticipants.map((player, idx) => `
                        <div style="background: ${player === currentSpeller ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'white'}; padding: 20px 30px; border-radius: 15px; color: #0d3b66; font-weight: bold; font-size: 1.2rem; border: 3px solid ${player === currentSpeller ? '#FFD700' : '#e0e0e0'}; box-shadow: ${player === currentSpeller ? '0 5px 20px rgba(255,215,0,0.5)' : '0 2px 8px rgba(0,0,0,0.1)'}; transition: all 0.3s;">
                            ${player === currentSpeller ? 'â¤ ' : ''}${player}${player === currentSpeller ? ' â¬…ï¸' : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0; text-align: center;">âŒ Eliminated</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Turn -->
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: #0d3b66; text-align: center;">
                <h3 style="margin: 0 0 15px 0;">ğŸ¯ ${currentSpeller}'s Turn</h3>
                <div style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentWord.toUpperCase()}
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="speakStage7Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ğŸ”Š Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage7Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        ğŸ’¬ Use in Sentence
                    </button>
                </div>
            </div>
            
            <!-- Caller Controls -->
            <div style="text-align: center; margin: 30px 0;">
                <h4 style="color: #0d3b66; margin-bottom: 20px;">Did ${currentSpeller} spell "${currentWord}" correctly?</h4>
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button class="practice-btn" onclick="markStage7Correct()" style="background: #28a745; font-size: 1.2rem; padding: 15px 40px;">
                        âœ… CORRECT
                    </button>
                    <button class="practice-btn" onclick="markStage7Incorrect()" style="background: #dc3545; font-size: 1.2rem; padding: 15px 40px;">
                        âŒ WRONG
                    </button>
                </div>
            </div>
        </div>
    `;
}

function speakStage7Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage7Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage7Word();
    }
}

function markStage7Correct() {
    console.log(`âœ… ${liveStageParticipants[currentSpellerIndex]} spelled correctly`);
    
    // Move to next speller
    currentSpellerIndex++;
    if (currentSpellerIndex >= liveStageParticipants.length) {
        currentSpellerIndex = 0; // Loop back to first speller
        currentLiveStageIndex++; // New word for next round
    }
    
    // Check if we ran out of words
    if (currentLiveStageIndex >= liveStageWords.length) {
        alert('âš ï¸ Need more words! Generating additional championship words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage7UI();
        });
    } else {
        buildStage7UI();
    }
}

function markStage7Incorrect() {
    const player = liveStageParticipants[currentSpellerIndex];
    
    if (confirm(`âŒ Are you sure ${player} spelled incorrectly? This will eliminate them from the finals.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(currentSpellerIndex, 1);
        
        // Adjust current speller index
        if (currentSpellerIndex >= liveStageParticipants.length) {
            currentSpellerIndex = 0;
        }
        
        // Check if we have a winner
        if (liveStageParticipants.length === 1) {
            showTournamentWinner();
        } else {
            // Move to next word
            currentLiveStageIndex++;
            buildStage7UI();
        }
    }
}

function showTournamentWinner() {
    const container = document.getElementById('tournament-stage7');
    const winner = liveStageParticipants[0];
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 50px; background: linear-gradient(135deg, #FFD700, #FFA500);">
            <div style="font-size: 6rem; margin-bottom: 30px; animation: bounce 2s infinite;">ğŸ†</div>
            
            <h1 style="color: #0d3b66; font-size: 3rem; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                SPELLING CHAMPION
            </h1>
            
            <div style="background: white; padding: 40px; border-radius: 20px; margin: 30px 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="font-size: 2.5rem; font-weight: bold; color: #0d3b66; margin-bottom: 20px;">
                    ğŸŒŸ ${winner} ğŸŒŸ
                </div>
                <p style="font-size: 1.3rem; color: #666; margin: 15px 0;">
                    Conquered all 7 stages to become the ultimate spelling champion!
                </p>
            </div>
            
            <div style="background: rgba(255,255,255,0.9); padding: 30px; border-radius: 15px; margin: 30px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 20px;">ğŸ¯ Tournament Journey</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 1</div>
                        <div style="color: #666; font-size: 0.9rem;">Antonym/Synonym</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 2</div>
                        <div style="color: #666; font-size: 0.9rem;">AI Audio Spelling</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 3</div>
                        <div style="color: #666; font-size: 0.9rem;">Unscramble</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 4</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 10</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 5</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 5</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 6</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 3</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66;">Stage 7</div>
                        <div style="color: #0d3b66; font-size: 0.9rem; font-weight: bold;">ğŸ† CHAMPION</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 40px;">
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.3rem; padding: 20px 50px; background: white; color: #0d3b66; font-weight: bold;">
                    ğŸ  Return to Lobby
                </button>
            </div>
        </div>
    `;
    
    // Add bounce animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
    `;
    document.head.appendChild(style);
}




// ===== ADMIN CONFIGURATION =====
// ===== ADMIN CONFIGURATION =====
const ADMIN_EMAIL = 'carlanviroberts@gmail.com'; // âš ï¸ CHANGE THIS TO YOUR ADMIN EMAIL
let isAdmin = false;

// Check if current user is admin
async function checkAdminStatus() {
    if (!currentUser) {
        isAdmin = false;
        updateAdminUI();
        console.log('âŒ No current user - admin status: false');
        return false;
    }
    
    try {
        console.log('ğŸ” Checking admin status for:', currentUser.email);
        console.log('ğŸ” Admin email configured as:', ADMIN_EMAIL);
        
        // Check email directly first
        if (currentUser.email === ADMIN_EMAIL) {
            isAdmin = true;
            console.log('âœ… ADMIN DETECTED via email match!');
            updateAdminUI();
            return true;
        }
        
        // Also check Firestore user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            isAdmin = (userData?.email === ADMIN_EMAIL);
            console.log('ğŸ“„ Firestore check - Admin status:', isAdmin);
        } else {
            console.log('âš ï¸ User document not found in Firestore');
        }
        
        updateAdminUI();
        return isAdmin;
        
    } catch (error) {
        console.error('âŒ Error checking admin status:', error);
        isAdmin = false;
        updateAdminUI();
        return false;
    }
}

function updateAdminUI() {
    console.log('ğŸ”„ Updating admin UI. isAdmin:', isAdmin);
    
    // Show/hide admin link in sidebar
    const adminLink = document.getElementById('admin-nav-link');
    if (adminLink) {
        adminLink.style.display = isAdmin ? 'block' : 'none';
        console.log('âœ… Admin link display set to:', isAdmin ? 'block' : 'none');
    } else {
        console.log('âš ï¸ Admin link element not found in DOM');
    }
}
// ===== ADMIN TOURNAMENT MANAGEMENT =====

async function loadAdminPanel() {
    if (!isAdmin) {
        document.getElementById('admin-container').innerHTML = `
            <div class="feedback error" style="text-align: center; padding: 40px;">
                âŒ <strong>Access Denied</strong><br><br>
                Admin privileges required.<br>
                Current user: ${currentUser ? currentUser.email : 'Not signed in'}
            </div>
        `;
        return;
    }
    
    const container = document.getElementById('admin-container');
    container.innerHTML = '<div class="loading">Loading admin panel...</div>';
    
    try {
        // Load all tournaments
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('createdAt', 'desc')
            .get();
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            tournaments.push({ id: doc.id, ...doc.data() });
        });
        
        container.innerHTML = `
            <div class="admin-panel">
                <!-- Create Tournament Button -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="practice-btn" onclick="showCreateTournamentModal()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2);">
                        â• Create New Tournament
                    </button>
                </div>
                
                <!-- Tournaments List -->
                <h3 style="color: #0d3b66; margin-bottom: 20px;">ğŸ“‹ Manage Tournaments (${tournaments.length})</h3>
                
                ${tournaments.length === 0 ? `
                    <div class="loading">
                        No tournaments created yet. Click "Create New Tournament" to get started.
                    </div>
                ` : `
                    <div class="coaches-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ğŸ† Tournament</th>
                                    <th>ğŸ“… Date</th>
                                    <th>ğŸ‘¥ Participants</th>
                                    <th>âš™ï¸ Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tournaments.map(tournament => `
                                    <tr>
                                        <td>
                                            <div style="font-weight: bold; color: #0d3b66;">${tournament.name}</div>
                                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                                Level: ${tournament.level} â€¢ Status: ${tournament.status}
                                            </div>
                                        </td>
                                        <td>
                                            <div>${tournament.startDate ? new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not scheduled'}</div>
                                            <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                                ${tournament.startTime || 'Time TBD'}
                                            </div>
                                        </td>
                                        <td style="text-align: center;">
                                            <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #0d3b66;">
                                                ${tournament.participants || 0}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 5px; justify-content: center;">
                                                <button class="practice-btn" onclick="viewTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8;">
                                                    ğŸ‘ï¸ View
                                                </button>
                                                <button class="practice-btn" onclick="editTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                    âœï¸ Edit
                                                </button>
                                                <button class="practice-btn" onclick="deleteTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                                    ğŸ—‘ï¸ Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading admin panel:', error);
        container.innerHTML = `
            <div class="feedback error">
                âŒ Failed to load admin panel: ${error.message}
            </div>
        `;
    }
}

        
function showCreateTournamentModal() {
    const modal = document.createElement('div');
    modal.className = 'auth-modal';
    modal.id = 'createTournamentModal';
    modal.style.display = 'block';
    modal.classList.add('active');
    
    modal.innerHTML = `
        <div class="auth-content" style="max-width: 600px;">
            <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h2 style="color: white;">â• Create New Tournament</h2>
                <button class="modal-close" onclick="closeCreateTournamentModal()" style="color: white;">Ã—</button>
            </div>
            <div class="auth-body">
                <form id="create-tournament-form" onsubmit="handleCreateTournament(event)">
                    <div class="form-group">
                        <label>Tournament Name *</label>
                        <input type="text" id="tournament-name" required placeholder="e.g., Summer Spelling Championship 2025">
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;" placeholder="Describe the tournament..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty Level *</label>
                        <select id="tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="">Select level</option>
                            <option value="foundation">ğŸŒ± Foundation</option>
                            <option value="challenge">ğŸ¯ Challenge</option>
                            <option value="advanced">ğŸš€ Advanced</option>
                            <option value="championship">ğŸ† Championship</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="tournament-date" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="tournament-time" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Max Participants</label>
                        <input type="number" id="tournament-max-participants" min="10" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="upcoming">ğŸ“… Upcoming (Open for Registration)</option>
                            <option value="active">â–¶ï¸ Active (In Progress)</option>
                            <option value="completed">âœ… Completed</option>
                            <option value="cancelled">âŒ Cancelled</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        âœ… Create Tournament
                    </button>
                    
                    <div id="create-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                </form>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeCreateTournamentModal() {
    const modal = document.getElementById('createTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleCreateTournament(event) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    const name = document.getElementById('tournament-name').value.trim();
    const description = document.getElementById('tournament-description').value.trim();
    const level = document.getElementById('tournament-level').value;
    const date = document.getElementById('tournament-date').value;
    const time = document.getElementById('tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('tournament-max-participants').value);
    const status = document.getElementById('tournament-status').value;
    
    const errorDiv = document.getElementById('create-tournament-error');
    
    try {
        console.log('ğŸ“ Creating tournament:', name);
        
        // Create tournament in Firestore
        const tournamentRef = await db.collection('tournaments').add({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            participants: 0,
            registeredUsers: [],
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Tournament created:', tournamentRef.id);
        
        closeCreateTournamentModal();
        
        alert('âœ… Tournament created successfully!');
        
        // âœ… Reload admin panel
        await loadAdminPanel();
        
        // âœ… ALSO reload tournament list if we're on tournaments page
        const tournamentsSection = document.getElementById('tournaments-section');
        if (tournamentsSection && tournamentsSection.classList.contains('active')) {
            await loadTournamentList();
        }
        
    } catch (error) {
        console.error('âŒ Error creating tournament:', error);
        errorDiv.textContent = 'Failed to create tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function viewTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = { id: tournamentDoc.id, ...tournamentDoc.data() };
        
        // Create detailed view modal
        const modal = document.createElement('div');
        modal.className = 'auth-modal';
        modal.id = 'viewTournamentModal';
        modal.style.display = 'block';
        modal.classList.add('active');
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 700px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                    <h2 style="color: white;">ğŸ‘ï¸ ${tournament.name}</h2>
                    <button class="modal-close" onclick="closeViewTournamentModal()" style="color: white;">Ã—</button>
                </div>
                <div class="auth-body">
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #0d3b66; margin-bottom: 10px;">ğŸ“‹ Description</h4>
                        <p style="color: #666;">${tournament.description}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>ğŸ“Š Level:</strong> ${tournament.level}
                        </div>
                        <div>
                            <strong>ğŸ“… Date:</strong> ${tournament.startDate}
                        </div>
                        <div>
                            <strong>ğŸ• Time:</strong> ${tournament.startTime}
                        </div>
                        <div>
                            <strong>âš¡ Status:</strong> ${tournament.status}
                        </div>
                        <div>
                            <strong>ğŸ‘¥ Registered:</strong> ${tournament.participants} / ${tournament.maxParticipants}
                        </div>
                        <div>
                            <strong>ğŸ® Session:</strong> ${tournament.sessionActive ? 'LIVE âœ…' : 'Not Started'}
                        </div>
                    </div>
                    
                    ${tournament.registeredUsers && tournament.registeredUsers.length > 0 ? `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="color: #0d3b66; margin-bottom: 10px;">ğŸ‘¥ Registered Users (${tournament.registeredUsers.length})</h4>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${await getRegisteredUserNames(tournament.registeredUsers)}
                            </div>
                        </div>
                    ` : '<p style="color: #999;">No users registered yet</p>'}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        ${!tournament.sessionActive && tournament.status === 'active' && tournament.participants > 0 ? `
                            <button class="practice-btn" onclick="startTournamentSession('${tournamentId}')" style="flex: 1; background: #28a745; font-size: 1.1rem;">
                                ğŸš€ START TOURNAMENT
                            </button>
                        ` : tournament.sessionActive ? `
                            <button class="practice-btn" disabled style="flex: 1; background: #28a745; opacity: 0.7;">
                                âœ… Tournament Running
                            </button>
                        ` : ''}
                        
                        <button class="practice-btn" onclick="closeViewTournamentModal()" style="flex: 1; background: #6c757d;">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error viewing tournament:', error);
        alert('Failed to load tournament details');
    }
}

async function getRegisteredUserNames(userIds) {
    const names = [];
    for (const uid of userIds) {
        try {
            const userDoc = await db.collection('users').doc(uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                names.push(`<div style="padding: 5px; border-bottom: 1px solid #e0e0e0;">â€¢ ${userData.firstName} ${userData.lastName} (${userData.email})</div>`);
            }
        } catch (error) {
            console.error('Error fetching user:', error);
        }
    }
    return names.join('');
}

function closeViewTournamentModal() {
    const modal = document.getElementById('viewTournamentModal');
    if (modal) {
        modal.remove();
    }
}

// âœ… NEW: Start tournament session (Admin only)
async function startTournamentSession(tournamentId) {
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    if (!confirm('ğŸš€ Start this tournament now? All registered users will be notified.')) {
        return;
    }
    
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            sessionActive: true,
            sessionStartedAt: firebase.firestore.FieldValue.serverTimestamp(),
            sessionJoined: []
        });
        
        alert('âœ… Tournament started! Registered users will be notified.');
        
        closeViewTournamentModal();
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error starting tournament:', error);
        alert('Failed to start tournament: ' + error.message);
    }
}

async function editTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Pre-fill edit modal (similar to create modal)
        const modal = document.createElement('div');
        modal.className = 'auth-modal';
        modal.id = 'editTournamentModal';
        modal.style.display = 'block';
        modal.classList.add('active');
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 600px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #ffc107, #ff9800);">
                    <h2 style="color: #0d3b66;">âœï¸ Edit Tournament</h2>
                    <button class="modal-close" onclick="closeEditTournamentModal()" style="color: #0d3b66;">Ã—</button>
                </div>
                <div class="auth-body">
                    <form id="edit-tournament-form" onsubmit="handleEditTournament(event, '${tournamentId}')">
                        <div class="form-group">
                            <label>Tournament Name *</label>
                            <input type="text" id="edit-tournament-name" required value="${tournament.name}">
                        </div>
                        
                        <div class="form-group">
                            <label>Description *</label>
                            <textarea id="edit-tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;">${tournament.description}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Difficulty Level *</label>
                            <select id="edit-tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                                <option value="foundation" ${tournament.level === 'foundation' ? 'selected' : ''}>ğŸŒ± Foundation</option>
                                <option value="challenge" ${tournament.level === 'challenge' ? 'selected' : ''}>ğŸ¯ Challenge</option>
                                <option value="advanced" ${tournament.level === 'advanced' ? 'selected' : ''}>ğŸš€ Advanced</option>
                                <option value="championship" ${tournament.level === 'championship' ? 'selected' : ''}>ğŸ† Championship</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Start Date *</label>
                            <input type="date" id="edit-tournament-date" required value="${tournament.startDate}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Start Time *</label>
                            <input type="time" id="edit-tournament-time" required value="${tournament.startTime}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Max Participants</label>
                            <input type="number" id="edit-tournament-max-participants" min="10" max="100" value="${tournament.maxParticipants}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="edit-tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                                <option value="upcoming" ${tournament.status === 'upcoming' ? 'selected' : ''}>ğŸ“… Upcoming</option>
                                <option value="active" ${tournament.status === 'active' ? 'selected' : ''}>â–¶ï¸ Active</option>
                                <option value="completed" ${tournament.status === 'completed' ? 'selected' : ''}>âœ… Completed</option>
                                <option value="cancelled" ${tournament.status === 'cancelled' ? 'selected' : ''}>âŒ Cancelled</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #ffc107, #ff9800); color: #0d3b66;">
                            âœ… Save Changes
                        </button>
                        
                        <div id="edit-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error loading tournament for edit:', error);
        alert('Failed to load tournament: ' + error.message);
    }
}

function closeEditTournamentModal() {
    const modal = document.getElementById('editTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleEditTournament(event, tournamentId) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    const name = document.getElementById('edit-tournament-name').value.trim();
    const description = document.getElementById('edit-tournament-description').value.trim();
    const level = document.getElementById('edit-tournament-level').value;
    const date = document.getElementById('edit-tournament-date').value;
    const time = document.getElementById('edit-tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('edit-tournament-max-participants').value);
    const status = document.getElementById('edit-tournament-status').value;
    
    const errorDiv = document.getElementById('edit-tournament-error');
    
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Tournament updated:', tournamentId);
        
        closeEditTournamentModal();
        
        alert('âœ… Tournament updated successfully!');
        
        // Reload admin panel
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error updating tournament:', error);
        errorDiv.textContent = 'Failed to update tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function deleteTournament(tournamentId) {
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    if (confirm('ğŸ—‘ï¸ Are you sure you want to delete this tournament? This action cannot be undone.')) {
        try {
            await db.collection('tournaments').doc(tournamentId).delete();
            
            console.log('âœ… Tournament deleted:', tournamentId);
            
            alert('âœ… Tournament deleted successfully');
            
            // Reload admin panel
            loadAdminPanel();
            
        } catch (error) {
            console.error('Error deleting tournament:', error);
            alert('Failed to delete tournament: ' + error.message);
        }
    }
}        

// âœ… NEW: Setup real-time listeners for tournaments user is registered for
let tournamentListeners = [];

function setupTournamentListeners(tournaments) {
    // Clean up old listeners
    tournamentListeners.forEach(unsubscribe => unsubscribe());
    tournamentListeners = [];
    
    tournaments.forEach(tournament => {
        if (tournament.registeredUsers?.includes(currentUser.uid)) {
            console.log('ğŸ‘€ Watching tournament:', tournament.name);
            
            const unsubscribe = db.collection('tournaments').doc(tournament.id)
                .onSnapshot(doc => {
                    const data = doc.data();
                    
                    // Check if tournament just went live
                    if (data.status === 'active' && data.sessionActive && !data.sessionJoined?.includes(currentUser.uid)) {
                        showTournamentStartNotification(tournament.id, data);
                    }
                });
            
            tournamentListeners.push(unsubscribe);
        }
    });
}

// âœ… NEW: Show notification when tournament starts
function showTournamentStartNotification(tournamentId, tournamentData) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.5s ease-out;
    `;
    
    notification.innerHTML = `
        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ†</div>
        <h3 style="margin: 0 0 10px 0; color: white;">Tournament Starting!</h3>
        <p style="margin: 0 0 15px 0; opacity: 0.9;">${tournamentData.name} is now LIVE!</p>
        <button onclick="joinLiveTournament('${tournamentId}')" class="practice-btn" style="background: white; color: #28a745; width: 100%; font-weight: bold;">
            âš¡ JOIN NOW
        </button>
        <button onclick="this.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">Ã—</button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 30 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 30000);
}

// âœ… NEW: Join live tournament
async function joinLiveTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Check if user is registered
        if (!tournament.registeredUsers?.includes(currentUser.uid)) {
            alert('You must be registered to join this tournament');
            return;
        }
        
        // Mark user as joined
        await db.collection('tournaments').doc(tournamentId).update({
            sessionJoined: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        
        // Set current tournament
        currentTournament = tournamentId;
        selectedGameLevel = tournament.level;
        
        // Start Stage 1
        await startTournamentStage1(tournamentId);
        
    } catch (error) {
        console.error('Error joining tournament:', error);
        alert('Failed to join tournament: ' + error.message);
    }
}        
    </script>
</body>
</html>
