   <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        
// ===== PAYPAL CONFIGURATION =====
const PAYPAL_HANDLER_URL = 'https://verificationpaypalpayment-998744778737.us-central1.run.app';
const REOPEN_ACCOUNT_COST = 6.50;
const REOPEN_DAYS = 30;

let paypalButtonRendered = false;
let sponsorPaypalRendered = false;
let currentChildData = null;

        

        let paypalSDKLoaded = false;

async function loadPayPalSDK() {
    if (paypalSDKLoaded) {
        return Promise.resolve();
    }
    
    try {
        // Get client ID from Firebase function
        const response = await fetch(`${PAYPAL_HANDLER_URL}?action=getClientId`);
        const data = await response.json();
        
        if (!data.success || !data.clientId) {
            throw new Error('Failed to get PayPal client ID');
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${data.clientId}&currency=USD&locale=en_US`;
            script.async = true;
            
            script.onload = () => {
                paypalSDKLoaded = true;
                console.log('‚úÖ PayPal SDK loaded');
                resolve();
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load PayPal SDK'));
            };
            
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading PayPal SDK:', error);
        throw error;
    }
}
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // ‚úÖ NEW: Track declined challenges
let presenceInitialized = false; // ‚úÖ NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// ‚úÖ Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;


// ===== TOURNAMENT VARIABLES =====
let currentTournament = null;
let tournamentStage = 0;
let stage1Questions = [];
let stage1CurrentIndex = 0;
let stage1Score = 0;
let stage1Errors = 0;
let stage1Handicaps = 2;
let stage1TimeLeft = 600; // 10 minutes in seconds
let stage1Timer = null;

// ===== STAGE 2: AI AUDIO SPELLING =====
let stage2Words = [];
let stage2CurrentIndex = 0;
let stage2Score = 0;
let stage2Errors = 0;
let stage2TimeLeft = 900; // 15 minutes
let stage2Timer = null;
let stage2HandicapsRemaining = 1; // Base 1 + carried from Stage 1

// ===== TOURNAMENT STAGE 3 FUNCTIONS =====
let stage3Words = [];
let stage3CurrentIndex = 0;
let stage3Score = 0;
let stage3Errors = 0;
let stage3TimeLeft = 900; // 15 minutes
let stage3Timer = null;
let stage3HandicapsRemaining = 0;
let stage3CurrentLetterOrder = [];
let stage3DraggedElement = null;

// ===== LIVE STAGES 4-7 VARIABLES =====
let stage4RoomId = null;
let stage5RoomId = null;
let stage6RoomId = null;
let stage7RoomId = null;
let currentStageRoom = null;
let stageRoomListener = null;


// ===== LIVE ROOM VARIABLES =====
let localStream = null;
let liveRoomParticipants = new Map(); // userId -> {name, email, schoolId, stream, audioEnabled, videoEnabled}
let liveRoomListener = null;
let myAudioEnabled = true;
let myVideoEnabled = true;


// ===== AUTO-ELIMINATION VARIABLES =====
let stage3CompletionChecker = null;
const STAGE3_CUTOFF_TIME = 15 * 60 * 1000; // 15 minutes to complete Stage 3
const STAGE3_ELIMINATION_DELAY = 2 * 60 * 1000; // Wait 2 minutes after first completion before eliminating
let stage3FirstCompletionTime = null;


   // ===== CLASS SYSTEM VARIABLES =====
let myClass = null;
let classStudents = [];
let classAnnouncements = [];


// ===== LIVE SESSION VARIABLES =====
let liveSessionActive = false;
let liveSessionId = null;
let liveSessionListener = null;
let myPeerConnection = null;
let localAudioStream = null;
let peerConnections = new Map(); // userId -> RTCPeerConnection
let remoteStreams = new Map(); // userId -> MediaStream
let isMicMuted = false;
let sessionParticipants = new Map(); // userId -> {name, email, photoURL}
let isCoach = false; // Track if current user is coach
let coachMutedMe = false; // Track if coach has muted this student
let isCleaningUp = false; // Prevent duplicate operations during cleanup
let activeSpeakers = new Set(); // Track currently unmuted users
const MAX_ACTIVE_SPEAKERS = 5; // Maximum simultaneous speakers allowed
let connectionHealthChecks = new Map(); // userId -> intervalId for health monitoring

        
// ===== ICE CANDIDATE QUEUE =====
const pendingIceCandidates = new Map(); // userId -> [candidates]
        
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // ‚úÖ Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // ‚úÖ ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // √¢≈ì‚Ä¶ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });



 auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        console.log('üë§ User signed in:', user.email);
        console.log('üñºÔ∏è Auth photoURL:', user.photoURL);
        
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        console.log('üìÑ Firestore photoURL:', userData.photoURL);
        
        if (user.photoURL && !userData.photoURL) {
            console.log('üìù Syncing photoURL to Firestore...');
            await userRef.update({
                photoURL: user.photoURL
            });
            console.log('‚úÖ PhotoURL synced!');
        }
        
        // ‚úÖ INITIALIZE SPELLING STATS IF NOT EXISTS
        if (!userData.spellingStats) {
            console.log('üìù Initializing spelling stats...');
            await userRef.update({
                spellingStats: {
                    totalChallenges: 0,
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    winStreak: 0,
                    bestStreak: 0
                }
            });
            console.log('‚úÖ Spelling stats initialized!');
        }
        
        // ‚úÖ CHECK ADMIN STATUS HERE (CRITICAL - RIGHT AFTER USER DATA IS LOADED)
        await checkAdminStatus();
        
        // ‚úÖ CHECK AND REMOVE EXPIRED CLASS ENROLLMENTS
        await checkAndRemoveExpiredStudents();
        
        // ‚úÖ ADD MY CLASS BUTTON
        const myClassBtn = document.getElementById('myClassBtn');
        if (!myClassBtn) {
            const classBtn = document.createElement('button');
            classBtn.id = 'myClassBtn';
            classBtn.className = 'my-profile-btn';
            classBtn.style.cssText = 'display: none; margin-top: 10px;';
            classBtn.onclick = () => {
                navigateTo('class');
                loadMyClass();
            };
            
            const sidebarUserInfo = document.getElementById('sidebarUserInfo');
            sidebarUserInfo.appendChild(classBtn);
        }
        
        try {
            if (userData && (userData.userType === 'student' || userData.userType === 'coach')) {
                document.getElementById('myClassBtn').innerHTML = 'üìö MY CLASS';
                document.getElementById('myClassBtn').style.display = 'block';
            }
        } catch (error) {
            console.error('Error checking class status:', error);
        }
        
        // ‚úÖ CHECK USER TYPE AND HANDLE ACCORDINGLY
        if (userData.userType === 'parent') {
            if (!userData.profileComplete) {
                await userRef.update({ profileComplete: true });
            }
            updateUIForAuthenticatedUser(user);
            navigateTo('parent-dashboard');
            return;
        }
        
        // ‚úÖ ORGANIZATION HANDLING - SHOW ORG MODAL IF INCOMPLETE
        if (userData.userType === 'organization') {
            if (!userData.profileComplete) {
                showOrgProfileModal(user);
                return;
            }
            updateUIForAuthenticatedUser(user);
            navigateTo('parent-dashboard');
            return;
        }
        
        // STUDENT/COACH HANDLING
        if (!userData.profileComplete) {
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // ‚úÖ LOAD USER COINS (for students only)
        if (userData.userType === 'student') {
            await loadUserCoins(user.uid);
            await checkSubscriptionStatus();
        }
        
        await cleanupInvalidFavorites();
        
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // ‚úÖ Initialize presence immediately on login (only for students/coaches)
        if (userData.userType !== 'parent' && userData.userType !== 'organization') {
            await initializeOnlinePresence();
        }
        
        // Load appropriate dashboard
        if (userData.userType === 'student') {
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        }
    } else {
        currentUser = null;
        isAdmin = false;
        
        // ‚úÖ Clean up tournament listeners
        if (tournamentListeners) {
            tournamentListeners.forEach(unsubscribe => unsubscribe());
            tournamentListeners = [];
        }
        
        updateUIForGuestUser();
        updateAdminUI();
    }
});
 });       
        
    
// ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // ‚úÖ CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'parent-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // ‚úÖ ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard' || section === 'parent-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // ‚úÖ PREVENT PARENTS FROM ACCESSING STUDENT FEATURES
    if (currentUser && section !== 'parent-dashboard' && section !== 'home' && section !== 'about' && section !== 'coaches' && section !== 'students') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'parent') {
                alert('‚ö†Ô∏è Parents can only access:\n‚Ä¢ Parent Dashboard\n‚Ä¢ Home\n‚Ä¢ About\n‚Ä¢ Coaches\n‚Ä¢ Students\n\nPlease use the Parent Dashboard to manage your child\'s account.');
                navigateTo('parent-dashboard');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // ‚úÖ Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // ‚úÖ RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // ‚úÖ Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // ‚úÖ Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // ‚úÖ Load student dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    // ‚úÖ Load parent dashboard when navigating to it
    if (section === 'parent-dashboard' && currentUser) {
        await loadParentDashboard();
    }
    
    // ‚úÖ LOAD ADMIN PANEL WHEN NAVIGATING TO IT
    if (section === 'admin' && currentUser) {
        console.log('üéØ Navigating to admin panel. isAdmin:', isAdmin);
        if (!isAdmin) {
            alert('‚ùå Admin access required. Please sign in with an admin account.');
            navigateTo('home');
            return;
        }
        await loadAdminPanel();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }

    if (section === 'tournaments') {
    await loadTournamentList();
}
   // Load class section
    if (section === 'class' && currentUser) {
        await loadMyClass();
} 
}




// ===== BOOK COACH (STUDENT) =====
async function bookCoach(coachId, coachName) {
    if (!currentUser) {
        alert('Please sign in to book a coach');
        return;
    }
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (!userData.hasGuardian) {
            alert('‚ùå Coach booking unavailable.\n\nYou need a guardian (parent or organization) to book coaches.\n\nAsk your guardian to:\n1. Sign up on the platform\n2. Add you as their student\n3. Contact support to enable booking');
            return;
        }
        
        if (!userData.bookingEnabled) {
            alert('‚ùå Coach booking unavailable.\n\nYour guardian must contact support to enable booking permissions.\n\nSupport Email: support@wordbizacademy.com');
            return;
        }
        
        const bookingExpiry = userData.bookingExpiry?.toDate();
        const now = new Date();
        
        if (bookingExpiry && now > bookingExpiry) {
            alert('‚ùå Your booking permission has expired.\n\nYour guardian must contact support to renew booking access.\n\nSupport Email: support@wordbizacademy.com');
            return;
        }
        
        if (!confirm(`Book ${coachName} as your coach?\n\nThis will add you to their class.`)) {
            return;
        }
        
        const classQuery = await db.collection('classes').where('coachId', '==', coachId).limit(1).get();
        
        if (classQuery.empty) {
            alert('‚ùå Coach class not found. Please try again later.');
            return;
        }
        
        const classDoc = classQuery.docs[0];
        const classId = classDoc.id;
        
        if (userData.classId && userData.classId !== classId) {
            if (!confirm('You are already in another class. Switch to this coach?')) {
                return;
            }
            
            try {
                const oldClassDoc = await db.collection('classes').doc(userData.classId).get();
                if (oldClassDoc.exists) {
                    const oldCount = oldClassDoc.data().studentCount || 0;
                    await db.collection('classes').doc(userData.classId).update({
                        studentCount: Math.max(0, oldCount - 1)
                    });
                }
            } catch (error) {
                console.error('Error updating old class count:', error);
            }
        }
        
        // Calculate class expiry (30 days from now)
        const classExpiryDate = new Date();
        classExpiryDate.setDate(classExpiryDate.getDate() + 30);
        
        await db.collection('users').doc(currentUser.uid).update({
            classId: classId,
            coachId: coachId,
            classJoinedAt: firebase.firestore.FieldValue.serverTimestamp(),
            classExpiryDate: firebase.firestore.Timestamp.fromDate(classExpiryDate)
        });
        
        const currentCount = classDoc.data().studentCount || 0;
        await db.collection('classes').doc(classId).update({
            studentCount: currentCount + 1
        });
        
        alert(`‚úÖ Successfully booked ${coachName}!\n\nYou can now access your class from the "MY CLASS" button.\n\n‚è∞ Your enrollment expires in 30 days.`);
        closeCoachDetailModal();
        
        const myClassBtn = document.getElementById('myClassBtn');
        if (myClassBtn) {
            myClassBtn.style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error booking coach:', error);
        alert('Failed to book coach: ' + error.message);
    }
}
        

// ===== RECRUIT STUDENT (COACH) =====
async function recruitStudent(studentId, studentName) {
    if (!currentUser || !myClass) {
        alert('Please ensure you have a class set up first');
        return;
    }
    
    if (!confirm(`Recruit ${studentName} to your class?`)) {
        return;
    }
    
    try {
        // Check if student already has a coach
        const studentDoc = await db.collection('users').doc(studentId).get();
        const studentData = studentDoc.data();
        
        if (studentData.classId && studentData.classId !== myClass.id) {
            if (!confirm(`${studentName} is already in another class. Recruit anyway?`)) {
                return;
            }
            
            // Remove from old class count
            try {
                const oldClassDoc = await db.collection('classes').doc(studentData.classId).get();
                if (oldClassDoc.exists) {
                    const oldCount = oldClassDoc.data().studentCount || 0;
                    await db.collection('classes').doc(studentData.classId).update({
                        studentCount: Math.max(0, oldCount - 1)
                    });
                }
            } catch (error) {
                console.error('Error updating old class count:', error);
            }
        }
        
        // Calculate class expiry (30 days from now)
        const classExpiryDate = new Date();
        classExpiryDate.setDate(classExpiryDate.getDate() + 30);
        
        // Add student to coach's class
        await db.collection('users').doc(studentId).update({
            classId: myClass.id,
            coachId: currentUser.uid,
            classJoinedAt: firebase.firestore.FieldValue.serverTimestamp(),
            classExpiryDate: firebase.firestore.Timestamp.fromDate(classExpiryDate)
        });
        
        // Update class student count
        const currentCount = myClass.studentCount || 0;
        await db.collection('classes').doc(myClass.id).update({
            studentCount: currentCount + 1
        });
        
        // Update myClass object
        myClass.studentCount = currentCount + 1;
        
        alert(`‚úÖ Successfully recruited ${studentName} to your class!\n\n‚è∞ Their enrollment will expire in 30 days.`);
        closeStudentDetailModal();
        
        // Reload class students
        await loadClassStudents();
        updateCoachClassStats();
        
    } catch (error) {
        console.error('Error recruiting student:', error);
        alert('Failed to recruit student: ' + error.message);
    }
}
        

  // ===== ADMIN CONFIGURATION =====
const ADMIN_EMAIL = 'carlanviroberts@gmail.com'; // ‚ö†Ô∏è CHANGE THIS TO YOUR ADMIN EMAIL
let isAdmin = false;

// Check if current user is admin
async function checkAdminStatus() {
    if (!currentUser) {
        isAdmin = false;
        updateAdminUI();
        console.log('‚ùå No current user - admin status: false');
        return false;
    }
    
    try {
        console.log('üîç Checking admin status for:', currentUser.email);
        console.log('üîç Admin email configured as:', ADMIN_EMAIL);
        
        // Check email directly first
        if (currentUser.email === ADMIN_EMAIL) {
            isAdmin = true;
            console.log('‚úÖ ADMIN DETECTED via email match!');
            updateAdminUI();
            return true;
        }
        
        // Also check Firestore user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            isAdmin = (userData?.email === ADMIN_EMAIL);
            console.log('üìÑ Firestore check - Admin status:', isAdmin);
        } else {
            console.log('‚ö†Ô∏è User document not found in Firestore');
        }
        
        updateAdminUI();
        return isAdmin;
        
    } catch (error) {
        console.error('‚ùå Error checking admin status:', error);
        isAdmin = false;
        updateAdminUI();
        return false;
    }
}

function updateAdminUI() {
    console.log('üîÑ Updating admin UI. isAdmin:', isAdmin);
    
    // Show/hide admin link in sidebar
    const adminLink = document.getElementById('admin-nav-link');
    if (adminLink) {
        adminLink.style.display = isAdmin ? 'block' : 'none';
        console.log('‚úÖ Admin link display set to:', isAdmin ? 'block' : 'none');
    } else {
        console.log('‚ö†Ô∏è Admin link element not found in DOM');
    }
}


// ===== ADMIN BOOKING CONTROL FUNCTIONS =====
async function toggleStudentBooking(studentId, currentStatus) {
    if (!isAdmin) {
        alert('Admin access required');
        return;
    }
    
    const action = currentStatus ? 'disable' : 'enable';
    if (!confirm(`${action.charAt(0).toUpperCase() + action.slice(1)} coach booking for this student?`)) {
        return;
    }
    
    try {
        const updateData = { 
            bookingEnabled: !currentStatus 
        };
        
        if (!currentStatus) {
            // Enabling booking - set expiry to 30 days
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);
            updateData.bookingExpiry = firebase.firestore.Timestamp.fromDate(expiryDate);
        } else {
            // Disabling booking - remove expiry
            updateData.bookingExpiry = firebase.firestore.FieldValue.delete();
        }
        
        await db.collection('users').doc(studentId).update(updateData);
        
        alert(`‚úÖ Coach booking ${action}d successfully!${!currentStatus ? '\n\nBooking will expire in 30 days.' : ''}`);
        
        // Reload the students list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminStudentsList(listContainer);
        }
        
    } catch (error) {
        console.error('Error toggling booking:', error);
        alert('Failed to update booking status: ' + error.message);
    }
}

        
// ===== ADMIN PANEL WITH SECTIONS =====

let currentAdminSection = 'tournaments'; // Default section
let currentUserSubSection = 'students'; // Default user sub-section

async function loadAdminPanel() {
    if (!isAdmin) {
        document.getElementById('admin-container').innerHTML = `
            <div class="feedback error" style="text-align: center; padding: 40px;">
                ‚ùå <strong>Access Denied</strong><br><br>
                Admin privileges required.<br>
                Current user: ${currentUser ? currentUser.email : 'Not signed in'}
            </div>
        `;
        return;
    }
    
    const container = document.getElementById('admin-container');
    container.innerHTML = `
        <div class="admin-panel">
            <!-- Admin Navigation -->
            <div style="display: flex; gap: 15px; margin-bottom: 30px; justify-content: center;">
                <button class="practice-btn" id="admin-tournaments-btn" onclick="switchAdminSection('tournaments')" style="padding: 12px 30px; font-size: 1.1rem;">
                    üèÜ Tournaments
                </button>
                <button class="practice-btn" id="admin-users-btn" onclick="switchAdminSection('users')" style="padding: 12px 30px; font-size: 1.1rem;">
                    üë• Users
                </button>
            </div>
            
            <!-- Content Container -->
            <div id="admin-content-container">
                <div class="loading">Loading...</div>
            </div>
        </div>
    `;
    
    // Load default section
    switchAdminSection('tournaments');
}

async function switchAdminSection(section) {
    currentAdminSection = section;
    
    // Update button styles
    const tournamentsBtn = document.getElementById('admin-tournaments-btn');
    const usersBtn = document.getElementById('admin-users-btn');
    
    if (tournamentsBtn && usersBtn) {
        tournamentsBtn.style.background = section === 'tournaments' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
        usersBtn.style.background = section === 'users' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
    }
    
    const contentContainer = document.getElementById('admin-content-container');
    
    if (section === 'tournaments') {
        await loadAdminTournaments(contentContainer);
    } else if (section === 'users') {
        await loadAdminUsersSection(contentContainer);
    }
}

// ===== TOURNAMENTS SECTION =====

async function loadAdminTournaments(container) {
    container.innerHTML = '<div class="loading">Loading tournaments...</div>';
    
    try {
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('createdAt', 'desc')
            .get();
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            tournaments.push({ id: doc.id, ...doc.data() });
        });
        
        container.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <button class="practice-btn" onclick="showCreateTournamentModal()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2);">
                    ‚ûï Create New Tournament
                </button>
            </div>
            
            <h3 style="color: #0d3b66; margin-bottom: 20px;">üìã Manage Tournaments (${tournaments.length})</h3>
            
            ${tournaments.length === 0 ? `
                <div class="loading">
                    No tournaments created yet. Click "Create New Tournament" to get started.
                </div>
            ` : `
                <div class="coaches-table">
                    <table>
                        <thead>
                            <tr>
                                <th>üèÜ Tournament</th>
                                <th>üìÖ Date</th>
                                <th>üë• Participants</th>
                                <th>‚öôÔ∏è Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tournaments.map(tournament => `
                                <tr>
                                    <td>
                                        <div style="font-weight: bold; color: #0d3b66;">${tournament.name}</div>
                                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                            Level: ${tournament.level} ‚Ä¢ Status: ${tournament.status}
                                        </div>
                                    </td>
                                    <td>
                                        <div>${tournament.startDate ? new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not scheduled'}</div>
                                        <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                            ${tournament.startTime || 'Time TBD'}
                                        </div>
                                    </td>
                                    <td style="text-align: center;">
                                        <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #0d3b66;">
                                            ${tournament.participants || 0}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 5px; justify-content: center;">
                                            <button class="practice-btn" onclick="viewTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8;">
                                                üëÅÔ∏è View
                                            </button>
                                            <button class="practice-btn" onclick="editTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                ‚úèÔ∏è Edit
                                            </button>
                                            <button class="practice-btn" onclick="deleteTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                                üóëÔ∏è Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `}
        `;
        
    } catch (error) {
        console.error('Error loading tournaments:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load tournaments: ${error.message}
            </div>
        `;
    }
}



 async function switchUserSubSection(subSection) {
    currentUserSubSection = subSection;
    
    // Update button styles
    const studentsBtn = document.getElementById('admin-students-btn');
    const coachesBtn = document.getElementById('admin-coaches-btn');
    
    if (studentsBtn && coachesBtn) {
        studentsBtn.style.background = subSection === 'students' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
        coachesBtn.style.background = subSection === 'coaches' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
    }
    
    const listContainer = document.getElementById('admin-user-list-container');
    
    if (subSection === 'students') {
        await loadAdminStudentsList(listContainer);
    } else if (subSection === 'coaches') {
        await loadAdminCoachesList(listContainer);
    }
}

// ===== STUDENTS LIST =====

async function loadAdminStudentsList(container) {
    container.innerHTML = '<div class="loading">Loading students...</div>';
    try {
        const studentsSnapshot = await db.collection('users')
            .where('userType', '==', 'student')
            .orderBy('createdAt', 'desc')
            .get();
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            students.push({ id: doc.id, ...doc.data() });
        });
        
        if (students.length === 0) {
            container.innerHTML = '<div class="loading">No students found on the platform.</div>';
            return;
        }
        
        // Desktop view
        let desktopHTML = `
            <h3 style="color: #0d3b66; margin-bottom: 20px;">üéì All Students (${students.length})</h3>
            <div class="coaches-table" style="display: none;">
                <table id="students-desktop-table">
                    <thead>
                        <tr>
                            <th>üë§ Student</th>
                            <th>üìß Email</th>
                            <th>üë• Guardian</th>
                            <th>üéØ Booking</th>
                            <th>üìÖ Joined</th>
                            <th>üîí Status</th>
                            <th>‚öôÔ∏è Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // Mobile view
        let mobileHTML = '<div id="students-mobile-list" style="display: none;">';
        
        students.forEach(student => {
            const hasGuardian = student.hasGuardian || false;
            const bookingEnabled = student.bookingEnabled || false;
            const bookingExpiry = student.bookingExpiry?.toDate();
            const now = new Date();
            
            let bookingStatus = '‚ùå Disabled';
            let bookingColor = '#ff6b6b';
            
            if (bookingEnabled && bookingExpiry && now < bookingExpiry) {
                const daysLeft = Math.ceil((bookingExpiry - now) / (1000 * 60 * 60 * 24));
                bookingStatus = `‚úÖ ${daysLeft}d left`;
                bookingColor = '#51cf66';
            } else if (bookingEnabled && bookingExpiry && now >= bookingExpiry) {
                bookingStatus = '‚è∞ Expired';
                bookingColor = '#ffc107';
            }
            
            // Desktop row
            desktopHTML += `
                <tr onclick="viewStudentDetailsAdmin('${student.id}')" style="cursor: pointer;">
                    <td>
                        <div style="font-weight: bold; color: #0d3b66;">${student.name || student.firstName || 'N/A'} ${student.lastName || ''}</div>
                        <div style="font-size: 0.85rem; color: #666;">ID: ${student.id.substring(0, 8)}...</div>
                    </td>
                    <td>${student.email || 'No email'}</td>
                    <td style="text-align: center;">
                        ${hasGuardian ? 
                            '<span style="background: #51cf66; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">‚úÖ Yes</span>' : 
                            '<span style="background: #868e96; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">‚ùå No</span>'
                        }
                    </td>
                    <td style="text-align: center;" onclick="event.stopPropagation();">
                        <span style="background: ${bookingColor}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem; cursor: pointer;" 
                            onclick="toggleStudentBooking('${student.id}', ${bookingEnabled})">
                            ${bookingStatus}
                        </span>
                    </td>
                    <td>${student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                    <td style="text-align: center;">
                        ${student.subscriptionLocked ? 
                            '<span style="background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">üîí Locked</span>' : 
                            '<span style="background: #51cf66; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">‚úÖ Active</span>'
                        }
                    </td>
                    <td onclick="event.stopPropagation();">
                        <button class="practice-btn" onclick="viewStudentDetailsAdmin('${student.id}')" 
                            style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8; margin: 2px;">
                            üëÅÔ∏è View
                        </button>
                    </td>
                </tr>
            `;
            
            // Mobile card
            mobileHTML += `
                <div class="student-card-mobile" style="background: white; border-radius: 10px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: bold; color: #0d3b66; font-size: 1.1rem;">${student.name || student.firstName || 'N/A'} ${student.lastName || ''}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">${student.email || 'No email'}</div>
                        </div>
                        ${student.subscriptionLocked ? 
                            '<span style="background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">üîí Locked</span>' : 
                            '<span style="background: #51cf66; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem;">‚úÖ Active</span>'
                        }
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        <div>
                            <div style="font-size: 0.75rem; color: #666;">Guardian</div>
                            <div style="font-size: 0.9rem; font-weight: bold;">
                                ${hasGuardian ? '‚úÖ Yes' : '‚ùå No'}
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: #666;">Booking</div>
                            <div style="font-size: 0.9rem; font-weight: bold; color: ${bookingColor};">
                                ${bookingStatus}
                            </div>
                        </div>
                    </div>
                    
                    <button class="practice-btn" onclick="viewStudentDetailsAdmin('${student.id}')" 
                        style="width: 100%; padding: 12px; font-size: 0.95rem; background: #17a2b8;">
                        üëÅÔ∏è View Details
                    </button>
                </div>
            `;
        });
        
        desktopHTML += '</tbody></table></div>';
        mobileHTML += '</div>';
        
        container.innerHTML = desktopHTML + mobileHTML;
        
        // Show appropriate view based on screen size
        const updateView = () => {
            const desktopTable = document.getElementById('students-desktop-table');
            const mobileList = document.getElementById('students-mobile-list');
            
            if (desktopTable && mobileList) {
                if (window.innerWidth > 768) {
                    desktopTable.parentElement.style.display = 'block';
                    mobileList.style.display = 'none';
                } else {
                    desktopTable.parentElement.style.display = 'none';
                    mobileList.style.display = 'block';
                }
            }
        };
        
        updateView();
        window.addEventListener('resize', updateView);
        
    } catch (error) {
        console.error('Error loading students:', error);
        container.innerHTML = '<div class="feedback error">‚ùå Failed to load students: ' + error.message + '</div>';
    }
}

        
// ===== COACHES LIST =====

async function loadAdminCoachesList(container) {
    container.innerHTML = '<div class="loading">Loading coaches...</div>';
    
    try {
        const coachesSnapshot = await db.collection('users')
            .where('userType', '==', 'coach')
            .orderBy('createdAt', 'desc')
            .get();
        
        const coaches = [];
        coachesSnapshot.forEach(doc => {
            coaches.push({ id: doc.id, ...doc.data() });
        });
        
        if (coaches.length === 0) {
            container.innerHTML = `
                <div class="loading">
                    No coaches found on the platform.
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <h3 style="color: #0d3b66; margin-bottom: 20px;">üë®‚Äçüè´ All Coaches (${coaches.length})</h3>
            
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üë§ Coach</th>
                            <th>üìß Email</th>
                            <th>üë• Students</th>
                            <th>üìÖ Joined</th>
                            <th>üîí Status</th>
                            <th>‚öôÔ∏è Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => `
                            <tr onclick="viewCoachDetailsAdmin('${coach.id}')" style="cursor: pointer;">
                                <td>
                                    <div style="font-weight: bold; color: #0d3b66;">${coach.name || coach.firstName || 'N/A'} ${coach.lastName || ''}</div>
                                    <div style="font-size: 0.85rem; color: #666;">ID: ${coach.id.substring(0, 8)}...</div>
                                </td>
                                <td>${coach.email || 'No email'}</td>
                                <td style="text-align: center;">
                                    <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #0d3b66;">
                                        ${coach.studentCount || 0}
                                    </span>
                                </td>
                                <td>${coach.createdAt ? new Date(coach.createdAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                                <td style="text-align: center;">
                                    ${coach.subscriptionLocked ? 
                                        '<span style="background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">üîí Locked</span>' : 
                                        '<span style="background: #51cf66; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">‚úÖ Active</span>'
                                    }
                                </td>
                                <td onclick="event.stopPropagation();">
                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                        ${coach.subscriptionLocked ? 
                                            `<button class="practice-btn" onclick="unlockCoachAccount('${coach.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #51cf66;">
                                                üîì Unlock
                                            </button>` :
                                            `<button class="practice-btn" onclick="lockCoachAccount('${coach.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                üîí Lock
                                            </button>`
                                        }
                                        <button class="practice-btn" onclick="deleteCoachAccount('${coach.id}', '${(coach.name || coach.firstName || 'Coach') + ' ' + (coach.lastName || '')}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading coaches:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load coaches: ${error.message}
            </div>
        `;
    }
}
        
// ===== USERS SECTION =====

async function loadAdminUsersSection(container) {
    container.innerHTML = `
        <div>
            <!-- User Type Navigation -->
            <div style="display: flex; gap: 15px; margin-bottom: 30px; justify-content: center;">
                <button class="practice-btn" id="admin-students-btn" onclick="switchUserSubSection('students')" style="padding: 10px 25px;">
                    üéì Students
                </button>
                <button class="practice-btn" id="admin-coaches-btn" onclick="switchUserSubSection('coaches')" style="padding: 10px 25px;">
                    üë®‚Äçüè´ Coaches
                </button>
            </div>
            
            <!-- User List Container -->
            <div id="admin-user-list-container">
                <div class="loading">Loading users...</div>
            </div>
        </div>
    `;
    
    // Load default sub-section
    switchUserSubSection('students');
}

async function switchUserSubSection(subSection) {
    currentUserSubSection = subSection;
    
    // Update button styles
    const studentsBtn = document.getElementById('admin-students-btn');
    const coachesBtn = document.getElementById('admin-coaches-btn');
    
    if (studentsBtn && coachesBtn) {
        studentsBtn.style.background = subSection === 'students' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
        coachesBtn.style.background = subSection === 'coaches' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
    }
    
    const listContainer = document.getElementById('admin-user-list-container');
    
    if (subSection === 'students') {
        await loadAdminStudentsList(listContainer);
    } else if (subSection === 'coaches') {
        await loadAdminCoachesList(listContainer);
    }
}



// ===== STUDENT ADMIN ACTIONS =====

async function viewStudentDetailsAdmin(studentId) {
    try {
        const studentDoc = await db.collection('users').doc(studentId).get();
        
        if (!studentDoc.exists) {
            alert('‚ùå Student not found');
            return;
        }
        
        const student = studentDoc.data();
        
        // Get student's progress data
        const progressSnapshot = await db.collection('users').doc(studentId)
            .collection('progress')
            .orderBy('timestamp', 'desc')
            .limit(10)
            .get();
        
        const progressData = [];
        progressSnapshot.forEach(doc => {
            progressData.push(doc.data());
        });
        
        // Format subscription info
        const subscriptionExpiry = student.subscriptionExpiry?.toDate();
        const subscriptionType = student.subscriptionType || 'trial';
        const now = new Date();
        let subscriptionStatus = '';
        
        if (!subscriptionExpiry) {
            subscriptionStatus = 'üîí No Subscription';
        } else if (now > subscriptionExpiry) {
            subscriptionStatus = `üîí Expired on ${subscriptionExpiry.toLocaleDateString()}`;
        } else {
            const daysLeft = Math.ceil((subscriptionExpiry - now) / (1000 * 60 * 60 * 24));
            subscriptionStatus = `${subscriptionType === 'trial' ? 'üéÅ Trial' : '‚úÖ Active'} - Expires ${subscriptionExpiry.toLocaleDateString()} (${daysLeft} days left)`;
        }
        
        // Booking status
        const bookingEnabled = student.bookingEnabled || false;
        const bookingExpiry = student.bookingExpiry?.toDate();
        let bookingStatus = '‚ùå Disabled';
        
        if (bookingEnabled && bookingExpiry && now < bookingExpiry) {
            const daysLeft = Math.ceil((bookingExpiry - now) / (1000 * 60 * 60 * 24));
            bookingStatus = `‚úÖ Active (${daysLeft} days left)`;
        } else if (bookingEnabled && bookingExpiry && now >= bookingExpiry) {
            bookingStatus = '‚è∞ Expired';
        }
        
        const modal = document.createElement('div');
        modal.className = 'auth-modal active';
        modal.style.display = 'block';
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 700px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <h2 style="color: white;">üë§ Student Details</h2>
                    <button class="modal-close" onclick="this.closest('.auth-modal').remove()" style="color: white;">√ó</button>
                </div>
                <div class="auth-body">
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">üìã Basic Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <p><strong>Name:</strong> ${student.name || student.firstName || 'N/A'} ${student.lastName || ''}</p>
                            <p><strong>Email:</strong> ${student.email || 'N/A'}</p>
                            <p><strong>User ID:</strong> ${studentId}</p>
                            <p><strong>Student ID:</strong> ${student.studentId || `WB-2025-${studentId.slice(-4).toUpperCase()}`}</p>
                            <p><strong>Account Created:</strong> ${student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Account Status:</strong> ${student.subscriptionLocked ? 'üîí Locked' : '‚úÖ Active'}</p>
                            <p><strong>Subscription:</strong> ${subscriptionStatus}</p>
                            <p><strong>Coins:</strong> ü™ô ${student.coins || 0}</p>
                            <p><strong>Coach ID:</strong> ${student.coachId || 'No coach assigned'}</p>
                            <p><strong>Has Guardian:</strong> ${student.hasGuardian ? '‚úÖ Yes' : '‚ùå No'}</p>
                            <p><strong>Booking Status:</strong> ${bookingStatus}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">‚öôÔ∏è Admin Actions</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            ${student.subscriptionLocked ? 
                                `<button class="practice-btn" onclick="unlockStudentAccount('${studentId}'); this.closest('.auth-modal').remove();" style="background: #51cf66; width: 100%;">üîì Unlock Account</button>` :
                                `<button class="practice-btn" onclick="lockStudentAccount('${studentId}'); this.closest('.auth-modal').remove();" style="background: #ffc107; color: #0d3b66; width: 100%;">üîí Lock Account</button>`
                            }
                            
                            <button class="practice-btn" onclick="toggleStudentBooking('${studentId}', ${bookingEnabled}); this.closest('.auth-modal').remove();" 
                                style="background: ${bookingEnabled ? '#ff6b6b' : '#51cf66'}; width: 100%;">
                                ${bookingEnabled ? '‚ùå Disable Booking' : '‚úÖ Enable Booking'}
                            </button>
                            
                            <button class="practice-btn" onclick="deleteStudentAccount('${studentId}', '${(student.name || student.firstName || 'Student') + ' ' + (student.lastName || '')}'); this.closest('.auth-modal').remove();" 
                                style="background: #dc3545; width: 100%; grid-column: 1 / -1;">
                                üóëÔ∏è Delete Account
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">üìä Recent Activity</h3>
                        ${progressData.length === 0 ? 
                            '<p style="color: #666;">No practice sessions recorded yet.</p>' :
                            `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 200px; overflow-y: auto;">
                                ${progressData.map(session => `
                                    <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${session.difficulty || 'Unknown'}</strong> - 
                                        Score: ${session.score || 0}/${session.totalWords || 0} 
                                        (${session.accuracy || 0}%)
                                        <br>
                                        <small style="color: #666;">${session.timestamp ? new Date(session.timestamp.toDate()).toLocaleString() : 'N/A'}</small>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                    
                    <button class="auth-submit" onclick="this.closest('.auth-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error viewing student details:', error);
        alert('‚ùå Failed to load student details: ' + error.message);
    }
}

    
async function unlockStudentAccount(studentId) {
    if (!confirm('Are you sure you want to unlock this student account?\n\nThis will:\n‚úÖ Remove the subscription lock\n‚úÖ Hide the subscription modal\n‚úÖ Grant full access to all features')) {
        return;
    }
    
    try {
        // Set subscription expiry to 30 days from now
        const newExpiry = new Date();
        newExpiry.setDate(newExpiry.getDate() + 30);
        
        await db.collection('users').doc(studentId).update({
            subscriptionLocked: false,
            subscriptionExpiry: firebase.firestore.Timestamp.fromDate(newExpiry),
            unlockedByAdmin: true,
            unlockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Student account unlocked successfully!\n\n‚Ä¢ Subscription lock removed\n‚Ä¢ 30-day access granted\n‚Ä¢ Student can now access all features');
        
        // Reload the students list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminStudentsList(listContainer);
        }
        
    } catch (error) {
        console.error('Error unlocking student account:', error);
        alert('‚ùå Failed to unlock account: ' + error.message);
    }
}

async function lockStudentAccount(studentId) {
    if (!confirm('Are you sure you want to lock this student account?\n\nThis will:\nüîí Show subscription modal blocking all features\nüîí Set subscription as expired\nüîí Require payment to unlock\n\nThe student will NOT be able to access any features until unlocked.')) {
        return;
    }
    
    try {
        // Set subscription to expired (yesterday)
        const expiredDate = new Date();
        expiredDate.setDate(expiredDate.getDate() - 1);
        
        await db.collection('users').doc(studentId).update({
            subscriptionLocked: true,
            subscriptionExpiry: firebase.firestore.Timestamp.fromDate(expiredDate),
            lockedByAdmin: true,
            lockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Student account locked successfully!\n\n‚Ä¢ Subscription modal will appear on login\n‚Ä¢ All features blocked\n‚Ä¢ Student must pay or contact admin to unlock');
        
        // Reload the students list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminStudentsList(listContainer);
        }
        
    } catch (error) {
        console.error('Error locking student account:', error);
        alert('‚ùå Failed to lock account: ' + error.message);
    }
}

async function deleteStudentAccount(studentId, studentName) {
    const confirmDelete = confirm(`‚ö†Ô∏è WARNING: Are you sure you want to permanently delete the account for "${studentName}"?\n\nThis will:\n- Delete their user account\n- Delete all their progress data\n- Remove them from their coach's student list\n\nThis action CANNOT be undone!`);
    
    if (!confirmDelete) {
        return;
    }
    
    const doubleConfirm = confirm(`Final confirmation: This will permanently delete all data for "${studentName}". Continue?`);
    
    if (!doubleConfirm) {
        return;
    }
    
    try {
        // Delete user document
        await db.collection('users').doc(studentId).delete();
        
        alert('‚úÖ Student account deleted successfully!');
        
        // Reload the students list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminStudentsList(listContainer);
        }
        
    } catch (error) {
        console.error('Error deleting student account:', error);
        alert('‚ùå Failed to delete account: ' + error.message);
    }
}

// ===== COACH ADMIN ACTIONS =====

async function viewCoachDetailsAdmin(coachId) {
    try {
        const coachDoc = await db.collection('users').doc(coachId).get();
        
        if (!coachDoc.exists) {
            alert('‚ùå Coach not found');
            return;
        }
        
        const coach = coachDoc.data();
        
        // Get coach's students
        const studentsSnapshot = await db.collection('users')
            .where('coachId', '==', coachId)
            .get();
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            students.push({ id: doc.id, ...doc.data() });
        });
        
        const modal = document.createElement('div');
        modal.className = 'auth-modal active';
        modal.style.display = 'block';
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 700px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <h2 style="color: white;">üë®‚Äçüè´ Coach Details</h2>
                    <button class="modal-close" onclick="this.closest('.auth-modal').remove()" style="color: white;">√ó</button>
                </div>
                <div class="auth-body">
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">üìã Basic Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <p><strong>Name:</strong> ${coach.name || coach.firstName || 'N/A'} ${coach.lastName || ''}</p>
                            <p><strong>Email:</strong> ${coach.email || 'N/A'}</p>
                            <p><strong>User ID:</strong> ${coachId}</p>
                            <p><strong>Account Created:</strong> ${coach.createdAt ? new Date(coach.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Account Status:</strong> ${coach.subscriptionLocked ? 'üîí Locked' : '‚úÖ Active'}</p>
                            <p><strong>Total Students:</strong> ${students.length}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">üë• Students (${students.length})</h3>
                        ${students.length === 0 ? 
                            '<p style="color: #666;">No students assigned to this coach.</p>' :
                            `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 200px; overflow-y: auto;">
                                ${students.map(student => `
                                    <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${student.name || student.firstName || 'N/A'} ${student.lastName || ''}</strong>
                                        <br>
                                        <small style="color: #666;">${student.email || 'No email'}</small>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                    
                    <button class="auth-submit" onclick="this.closest('.auth-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error viewing coach details:', error);
        alert('‚ùå Failed to load coach details: ' + error.message);
    }
}

async function unlockCoachAccount(coachId) {
    if (!confirm('Are you sure you want to unlock this coach account?\n\nThis will grant full access to their dashboard.')) {
        return;
    }
    
    try {
        await db.collection('users').doc(coachId).update({
            subscriptionLocked: false,
            unlockedByAdmin: true,
            unlockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Coach account unlocked successfully!');
        
        // Reload the coaches list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminCoachesList(listContainer);
        }
        
    } catch (error) {
        console.error('Error unlocking coach account:', error);
        alert('‚ùå Failed to unlock account: ' + error.message);
    }
}

async function lockCoachAccount(coachId) {
    if (!confirm('Are you sure you want to lock this coach account?\n\nThey will not be able to access their dashboard until unlocked.')) {
        return;
    }
    
    try {
        await db.collection('users').doc(coachId).update({
            subscriptionLocked: true,
            lockedByAdmin: true,
            lockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Coach account locked successfully!');
        
        // Reload the coaches list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminCoachesList(listContainer);
        }
        
    } catch (error) {
        console.error('Error locking coach account:', error);
        alert('‚ùå Failed to lock account: ' + error.message);
    }
}

async function deleteCoachAccount(coachId, coachName) {
    const confirmDelete = confirm(`‚ö†Ô∏è WARNING: Are you sure you want to permanently delete the account for coach "${coachName}"?\n\nThis will:\n- Delete their coach account\n- Unassign all their students\n- Delete all their data\n\nThis action CANNOT be undone!`);
    
    if (!confirmDelete) {
        return;
    }

    const doubleConfirm = confirm(`Final confirmation: This will also unassign all students from this coach. Continue?`);

    if (!doubleConfirm) {
        return;
    }

    try {
        // First, unassign all students
        const studentsSnapshot = await db.collection('users')
            .where('coachId', '==', coachId)
            .get();
        
        const batch = db.batch();
        studentsSnapshot.forEach(doc => {
            batch.update(doc.ref, { coachId: null });
        });
        
        // Delete coach document
        batch.delete(db.collection('users').doc(coachId));
        
        await batch.commit();
        
        alert('‚úÖ Coach account deleted successfully and students unassigned!');
        
        // Reload the coaches list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminCoachesList(listContainer);
        }
        
    } catch (error) {
        console.error('Error deleting coach account:', error);
        alert('‚ùå Failed to delete account: ' + error.message);
    }
}

// ===== TOURNAMENT MODAL FUNCTIONS =====
function showCreateTournamentModal() {
    const modal = document.createElement('div');
    modal.className = 'auth-modal';
    modal.id = 'createTournamentModal';
    modal.style.display = 'block';
    modal.classList.add('active');
    modal.innerHTML = `
        <div class="auth-content" style="max-width: 600px;">
            <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h2 style="color: white;">‚ûï Create New Tournament</h2>
                <button class="modal-close" onclick="closeCreateTournamentModal()" style="color: white;">√ó</button>
            </div>
            <div class="auth-body">
                <form id="create-tournament-form" onsubmit="handleCreateTournament(event)">
                    <div class="form-group">
                        <label>Tournament Name *</label>
                        <input type="text" id="tournament-name" required placeholder="e.g., Summer Spelling Championship 2025">
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;" placeholder="Describe the tournament..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty Level *</label>
                        <select id="tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="">Select level</option>
                            <option value="foundation">üå± Foundation</option>
                            <option value="challenge">üéØ Challenge</option>
                            <option value="advanced">üöÄ Advanced</option>
                            <option value="championship">üèÜ Championship</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="tournament-date" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="tournament-time" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Max Participants</label>
                        <input type="number" id="tournament-max-participants" min="10" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="upcoming">üìÖ Upcoming (Open for Registration)</option>
                            <option value="active">‚ñ∂Ô∏è Active (In Progress)</option>
                            <option value="completed">‚úÖ Completed</option>
                            <option value="cancelled">‚ùå Cancelled</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        ‚úÖ Create Tournament
                    </button>
                    
                    <div id="create-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                </form>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

function closeCreateTournamentModal() {
    const modal = document.getElementById('createTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleCreateTournament(event) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('‚ùå Admin access required');
        return;
    }

    const name = document.getElementById('tournament-name').value.trim();
    const description = document.getElementById('tournament-description').value.trim();
    const level = document.getElementById('tournament-level').value;
    const date = document.getElementById('tournament-date').value;
    const time = document.getElementById('tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('tournament-max-participants').value);
    const status = document.getElementById('tournament-status').value;

    const errorDiv = document.getElementById('create-tournament-error');

    try {
        console.log('üìù Creating tournament:', name);
        
        // Create tournament in Firestore
        const tournamentRef = await db.collection('tournaments').add({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            participants: 0,
            registeredUsers: [],
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Tournament created:', tournamentRef.id);
        
        closeCreateTournamentModal();
        
        alert('‚úÖ Tournament created successfully!');
        
        // Reload admin panel tournaments section
        const contentContainer = document.getElementById('admin-content-container');
        if (contentContainer) {
            await loadAdminTournaments(contentContainer);
        }
        
        // Also reload tournament list if we're on tournaments page
        const tournamentsSection = document.getElementById('tournaments-section');
        if (tournamentsSection && tournamentsSection.classList.contains('active')) {
            await loadTournamentList();
        }
        
    } catch (error) {
        console.error('‚ùå Error creating tournament:', error);
        errorDiv.textContent = 'Failed to create tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}



   // ===== AUTHENTICATION FUNCTIONS =====
function showAuthModal() {
    document.getElementById('authModal').classList.add('active');
}

function closeAuthModal() {
    document.getElementById('authModal').classList.remove('active');
    document.getElementById('signin-error').style.display = 'none';
    
    // Hide all signup forms and show selection
    document.getElementById('signup-selection').style.display = 'none';
    document.getElementById('signup-student-form').style.display = 'none';
    document.getElementById('signup-coach-form').style.display = 'none';
    document.getElementById('signup-organization-form').style.display = 'none';
    
    // Clear all error messages
    document.querySelectorAll('.feedback.error').forEach(el => el.style.display = 'none');
}

function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => {
        f.classList.remove('active');
        f.style.display = 'none'; // Force hide all forms
    });
    
    if (tab === 'signin') {
        document.querySelector('.auth-tab:first-child').classList.add('active');
        document.getElementById('signin-form').classList.add('active');
        document.getElementById('signin-form').style.display = 'block';
        
        // Hide all signup forms
        document.getElementById('signup-selection').style.display = 'none';
        document.getElementById('signup-student-form').style.display = 'none';
        document.getElementById('signup-coach-form').style.display = 'none';
        document.getElementById('signup-organization-form').style.display = 'none';
    } else {
        document.querySelector('.auth-tab:last-child').classList.add('active');
        document.getElementById('signup-selection').classList.add('active');
        document.getElementById('signup-selection').style.display = 'block';
        
        // Hide signin form
        document.getElementById('signin-form').style.display = 'none';
    }
}

function showSignUpForm(userType) {
    // Hide selection screen
    document.getElementById('signup-selection').style.display = 'none';
    
    // Show appropriate form
    if (userType === 'student') {
        document.getElementById('signup-student-form').style.display = 'block';
    } else if (userType === 'parent') {
        document.getElementById('signup-parent-form').style.display = 'block';
    } else if (userType === 'coach') {
        document.getElementById('signup-coach-form').style.display = 'block';
    } else if (userType === 'organization') {
        document.getElementById('signup-organization-form').style.display = 'block';
    }
}

function backToUserTypeSelection() {
    // Hide all forms
    document.getElementById('signup-student-form').style.display = 'none';
    document.getElementById('signup-parent-form').style.display = 'none';
    document.getElementById('signup-coach-form').style.display = 'none';
    document.getElementById('signup-organization-form').style.display = 'none';
    
    // Show selection
    document.getElementById('signup-selection').style.display = 'block';
}
        
async function handleSignIn(event) {
    event.preventDefault();
    const email = document.getElementById('signin-email').value;
    const password = document.getElementById('signin-password').value;
    const errorDiv = document.getElementById('signin-error');

    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Check if user document exists in Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
            // User signed in but no profile exists - sign them out
            await auth.signOut();
            errorDiv.textContent = 'No account found with this email. Please sign up first.';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check if profile is complete
        const userData = userDoc.data();
        if (!userData.profileComplete) {
            // Show verification modal
            closeAuthModal();
            showVerificationModal(userData);
            return;
        }
        
        closeAuthModal();
        errorDiv.style.display = 'none';
    } catch (error) {
        if (error.code === 'auth/user-not-found') {
            errorDiv.textContent = 'No account found with this email. Please sign up first.';
        } else if (error.code === 'auth/wrong-password') {
            errorDiv.textContent = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
            errorDiv.textContent = 'Invalid email address.';
        } else {
            errorDiv.textContent = error.message;
        }
        errorDiv.style.display = 'block';
    }
}

async function handleSignUp(event, userType) {
    event.preventDefault();
    
    let name, email, password, errorDiv;
    let additionalData = { 
        userType: userType,
        profileComplete: false // Mark as incomplete
    };
    
    if (userType === 'student') {
        name = document.getElementById('signup-student-name').value;
        email = document.getElementById('signup-student-email').value;
        password = document.getElementById('signup-student-password').value;
        errorDiv = document.getElementById('signup-student-error');
        additionalData.age = document.getElementById('signup-student-age').value;
        additionalData.country = document.getElementById('signup-student-country').value;
        
        // For students, if they provided age and country, mark complete
        if (additionalData.age && additionalData.country) {
            additionalData.profileComplete = true;
        }
    } else if (userType === 'coach') {
        name = document.getElementById('signup-coach-name').value;
        email = document.getElementById('signup-coach-email').value;
        password = document.getElementById('signup-coach-password').value;
        errorDiv = document.getElementById('signup-coach-error');
        additionalData.organization = document.getElementById('signup-coach-organization').value;
        additionalData.profileComplete = true; // Coaches don't need extra verification
    } else if (userType === 'organization') {
        name = document.getElementById('signup-org-name').value;
        email = document.getElementById('signup-org-email').value;
        password = document.getElementById('signup-org-password').value;
        errorDiv = document.getElementById('signup-org-error');
        additionalData.phone = document.getElementById('signup-org-phone').value;
        additionalData.address = document.getElementById('signup-org-address').value;
        additionalData.profileComplete = true; // Organizations don't need extra verification
    }

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: name });
        
        // ‚úÖ GENERATE STUDENT ID FOR STUDENTS
        if (userType === 'student') {
            additionalData.studentId = generateStudentId(userCredential.user.uid);
            console.log('‚úÖ Generated Student ID:', additionalData.studentId);
        }
        
        await db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            ...additionalData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        closeAuthModal();
        errorDiv.style.display = 'none';
        
        // If profile not complete, show verification modal
        if (!additionalData.profileComplete) {
            showVerificationModal({ name, email, userType });
        } else {
            if (userType === 'student') {
                alert(`Welcome, ${name}! Your student account has been created successfully.\n\nYour Student ID: ${additionalData.studentId}\n\nPlease save this ID - your parent will need it to link their account.`);
            } else {
                alert(`Welcome, ${name}! Your ${userType} account has been created successfully.`);
            }
        }
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}
        
function signOut() {
    // Remove online presence before signing out
    removeOnlinePresence();
    
    // ‚úÖ CLEAR DECLINED CHALLENGES
    declinedChallengeIds.clear();
    shownPopupIds.clear();
    shownQuizPopupIds.clear();
    
    // Sign out from Firebase
    auth.signOut();
    
    // Navigate to home
    navigateTo('home');
}

async function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // Check if user document exists
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            // ‚úÖ NOW SAVING photoURL
            await userRef.set({
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL || null, // ‚úÖ ADD THIS
                userType: 'student',
                profileComplete: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            closeAuthModal();
            showVerificationModal({
                name: user.displayName,
                email: user.email,
                userType: 'student'
            });
        } else {
            // Existing user - check if profile is complete
            const userData = userDoc.data();
            if (!userData.profileComplete) {
                closeAuthModal();
                showVerificationModal(userData);
            } else {
                closeAuthModal();
            }
        }
    } catch (error) {
        console.error('Google sign-in error:', error);
        document.getElementById('signin-error').textContent = error.message;
        document.getElementById('signin-error').style.display = 'block';
    }
}
        
async function signUpWithGoogle(userType) {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        const userRef = db.collection('users').doc(user.uid);
        const userData = {
            email: user.email,
            photoURL: user.photoURL || null,
            userType: userType,
            profileComplete: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (userType !== 'organization') {
            userData.name = user.displayName;
        }
        if (userType === 'student') {
            userData.studentId = generateStudentId(user.uid);
            userData.hasGuardian = false;
            userData.bookingEnabled = false;
        }
        await userRef.set(userData);
        closeAuthModal();
        if (userType === 'organization') {
            showOrgProfileModal(user);
        } else {
            showVerificationModal({
                name: user.displayName,
                email: user.email,
                userType: userType
            });
        }
    } catch (error) {
        console.error('Google sign-up error:', error);
        const errorDiv = document.getElementById(`signup-${userType}-error`);
        if (errorDiv) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
        }
    }
}
        
        // ===== VERIFICATION MODAL FUNCTIONS =====
function showVerificationModal(userData) {
    const modal = document.getElementById('verificationModal');
    
    // Pre-fill any existing data
    if (userData.name) {
        document.getElementById('verify-name').value = userData.name;
    }
    if (userData.age) {
        document.getElementById('verify-age').value = userData.age;
    }
    if (userData.country) {
        document.getElementById('verify-country').value = userData.country;
    }
    
    modal.classList.add('active');
}

function closeVerificationModal() {
    document.getElementById('verificationModal').classList.remove('active');
}

async function handleVerification(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const name = document.getElementById('verify-name').value.trim();
    const age = document.getElementById('verify-age').value;
    const country = document.getElementById('verify-country').value;
    const errorDiv = document.getElementById('verify-error');
    
    if (!name || !age || !country) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (age < 5 || age > 100) {
        errorDiv.textContent = 'Please enter a valid age between 5 and 100.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            name: name,
            age: parseInt(age),
            country: country,
            profileComplete: true
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: name });
        
        errorDiv.style.display = 'none';
        closeVerificationModal();
        
        alert('‚úÖ Profile completed successfully! Welcome to WordBiz Coaching Academy!');
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
    } catch (error) {
        console.error('Error completing profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

        async function signOutAndSwitchAccount() {
    if (confirm('‚ö†Ô∏è Are you sure you want to sign out? You will need to sign in with a different account.')) {
        try {
            // Close verification modal
            closeVerificationModal();
            
            // Sign out the user
            await auth.signOut();
            
            // Reset UI to guest state
            currentUser = null;
            updateUIForGuestUser();
            
            // Navigate to home
            navigateTo('home');
            
            // Show auth modal for them to sign in/up with different account
            setTimeout(() => {
                showAuthModal();
            }, 500);
            
        } catch (error) {
            console.error('Error signing out:', error);
            alert('Failed to sign out: ' + error.message);
        }
    }
}

        // ===== ID VERIFICATION FUNCTIONS =====

function showVerificationModal(userData) {
    const modal = document.getElementById('verificationModal');
    const idSection = document.getElementById('coachIdVerification');
    const completeBtn = document.getElementById('completeProfileBtn');
    
    // Pre-fill any existing data
    if (userData.name) {
        document.getElementById('verify-name').value = userData.name;
    }
    if (userData.age) {
        document.getElementById('verify-age').value = userData.age;
    }
    if (userData.country) {
        document.getElementById('verify-country').value = userData.country;
    }
    
    // Check if this is a coach
    isCoachVerification = (userData.userType === 'coach');
    
    if (isCoachVerification) {
        idSection.classList.add('show');
        completeBtn.textContent = '‚è≥ Upload ID to Continue';
        completeBtn.disabled = true;
    } else {
        idSection.classList.remove('show');
        completeBtn.textContent = '‚úÖ Complete Profile';
        completeBtn.disabled = false;
    }
    
    // Reset ID verification state
    uploadedIDFile = null;
    uploadedIDBase64 = null;
    idVerificationPassed = false;
    document.getElementById('idPreviewContainer').classList.remove('show');
    document.getElementById('idVerificationStatus').classList.remove('show');
    
    modal.classList.add('active');
}

// Handle ID file upload
function handleIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    // Validate file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    uploadedIDFile = file;
    
    // Convert to base64 for preview and API
    const reader = new FileReader();
    reader.onload = function(e) {
        uploadedIDBase64 = e.target.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
        
        // Show preview for images only
        if (file.type.startsWith('image/')) {
            document.getElementById('idPreviewImage').src = e.target.result;
            document.getElementById('idPreviewContainer').classList.add('show');
        } else {
            document.getElementById('idPreviewContainer').classList.remove('show');
        }
        
        // Automatically start verification
        verifyIDWithAI();
    };
    reader.readAsDataURL(file);
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('idUploadArea');
    
    if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('drag-over');
            }, false);
        });
        
        uploadArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                document.getElementById('verify-id-file').files = files;
                handleIDUpload({ target: { files: files } });
            }
        }, false);
    }
});

function changeIDPhoto() {
    document.getElementById('verify-id-file').value = '';
    document.getElementById('idPreviewContainer').classList.remove('show');
    document.getElementById('idVerificationStatus').classList.remove('show');
    uploadedIDFile = null;
    uploadedIDBase64 = null;
    idVerificationPassed = false;
    document.getElementById('completeProfileBtn').disabled = true;
    document.getElementById('completeProfileBtn').textContent = '‚è≥ Upload ID to Continue';
}

// Verify ID using AI
async function verifyIDWithAI() {
    if (!uploadedIDBase64) {
        alert('Please upload an ID first');
        return;
    }
    
    const statusDiv = document.getElementById('idVerificationStatus');
    const completeBtn = document.getElementById('completeProfileBtn');
    const coachName = document.getElementById('verify-name').value.trim();
    const coachAge = document.getElementById('verify-age').value.trim(); // ‚úÖ GET AGE
    
    if (!coachName) {
        alert('Please enter your full name first');
        return;
    }
    
    if (!coachAge) {
        alert('Please enter your age first');
        return;
    }
    
    // Show verifying status
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.innerHTML = `
        <div class="verification-spinner"></div>
        <strong>Verifying your ID...</strong>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    completeBtn.disabled = true;
    completeBtn.textContent = '‚è≥ Verifying ID...';
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: uploadedIDBase64,
                    coachName: coachName,
                    userAge: coachAge, // ‚úÖ SEND AGE
                    userId: currentUser.uid
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        console.log('Verification result:', result);
        
        // ‚úÖ SIMPLIFIED: Check if verification passed
        if (result.verificationPassed) {
            // ‚úÖ SUCCESS - CLEAN MESSAGE
            idVerificationPassed = true;
            statusDiv.className = 'id-verification-status success show';
            statusDiv.innerHTML = `
                <strong>‚úÖ ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Status:</strong> Text is clear and consistent with a standard passport layout.
                </p>
                <p style="margin-top: 10px; font-size: 0.9rem; font-style: italic;">
                    üîí Your ID photo has not been stored. Only verification status is saved.
                </p>
            `;
            
            completeBtn.disabled = false;
            completeBtn.textContent = '‚úÖ COMPLETE PROFILE';
            
            // Store verification result in Firestore
            await db.collection('users').doc(currentUser.uid).update({
                idVerified: true,
                idVerificationDate: firebase.firestore.FieldValue.serverTimestamp(),
                idDocumentType: result.documentType,
                idVerificationConfidence: result.confidence,
                verifiedAge: result.age
            });
            
        } else {
            // ‚úÖ FAILURE - CLEAN MESSAGE
            idVerificationPassed = false;
            statusDiv.className = 'id-verification-status error show';
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${result.reason || 'Unable to verify your ID.'}</p>
                <p style="margin-top: 10px; font-size: 0.9rem;">
                    <strong>Tips for better verification:</strong><br>
                    ‚Ä¢ Ensure good lighting<br>
                    ‚Ä¢ Avoid glare or shadows<br>
                    ‚Ä¢ Make sure all text is readable<br>
                    ‚Ä¢ Use the original, unedited document<br>
                    ‚Ä¢ Ensure the name you typed matches the ID exactly
                </p>
            `;
            
            completeBtn.disabled = true;
            completeBtn.textContent = '‚ùå Upload Valid ID';
        }
        
    } catch (error) {
        console.error('ID Verification Error:', error);
        idVerificationPassed = false;
        statusDiv.className = 'id-verification-status error show';
        statusDiv.innerHTML = `
            <strong>‚ùå Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify your ID. This could be due to:<br>
                ‚Ä¢ Poor image quality<br>
                ‚Ä¢ Network connection issues<br>
                ‚Ä¢ Unsupported document format
            </p>
            <p style="margin-top: 10px;">
                Error details: ${error.message}
            </p>
            <p style="margin-top: 10px; font-weight: bold;">
                Please try uploading a clearer photo of your ID.
            </p>
        `;
        
        completeBtn.disabled = true;
        completeBtn.textContent = '‚ùå Upload Valid ID';
    }
}
        
// Update handleVerification function to include ID check
async function handleVerification(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const name = document.getElementById('verify-name').value.trim();
    const age = document.getElementById('verify-age').value;
    const country = document.getElementById('verify-country').value;
    const errorDiv = document.getElementById('verify-error');
    
    if (!name || !age || !country) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (age < 5 || age > 100) {
        errorDiv.textContent = 'Please enter a valid age between 5 and 100.';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Check if coach needs ID verification
    if (isCoachVerification && !idVerificationPassed) {
        errorDiv.textContent = 'Please upload and verify your government-issued ID to continue.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // ‚úÖ Update Firestore - PRESERVE photoURL
        const updateData = {
            name: name,
            age: parseInt(age),
            country: country,
            profileComplete: true
        };
        
        // Only add photoURL if it exists (don't overwrite with null)
        if (currentUser.photoURL) {
            updateData.photoURL = currentUser.photoURL;
        }
        
        await db.collection('users').doc(currentUser.uid).update(updateData);
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: name });
        
        errorDiv.style.display = 'none';
        closeVerificationModal();
        
        if (isCoachVerification) {
            alert('‚úÖ Profile and ID verification completed successfully! Welcome to WordBiz Coaching Academy!');
        } else {
            alert('‚úÖ Profile completed successfully! Welcome to WordBiz Coaching Academy!');
        }
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
    } catch (error) {
        console.error('Error completing profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}
        


// ===== PARENT ID UPLOAD FUNCTIONS =====
function handleParentIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    parentIDFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        parentIDBase64 = e.target.result.split(',')[1];
        
        if (file.type.startsWith('image/')) {
            document.getElementById('parent-id-preview-image').src = e.target.result;
            document.getElementById('parent-id-preview').style.display = 'block';
        }
        
        verifyParentID();
    };
    reader.readAsDataURL(file);
}

function changeParentID() {
    document.getElementById('parent-id-file').value = '';
    document.getElementById('parent-id-preview').style.display = 'none';
    document.getElementById('parent-id-status').style.display = 'none';
    parentIDFile = null;
    parentIDBase64 = null;
    parentIDVerified = false;
}

async function verifyParentID() {
    if (!parentIDBase64) {
        alert('Please upload parent ID first');
        return;
    }
    
    const statusDiv = document.getElementById('parent-id-status');
    const parentName = document.getElementById('signup-parent-name').value.trim();
    
    if (!parentName) {
        alert('Please enter parent name first');
        return;
    }
    
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#fff3cd';
    statusDiv.style.borderLeft = '4px solid #ffc107';
    statusDiv.style.padding = '15px';
    statusDiv.style.borderRadius = '8px';
    statusDiv.style.color = '#856404';
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="verification-spinner"></div>
            <strong>Verifying parent ID...</strong>
        </div>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: parentIDBase64,
                    coachName: parentName,
                    userId: 'temp-parent-' + Date.now()
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        if (result.isValid && result.isOver16 && !result.documentAppearsTampered) {
            parentIDVerified = true;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderLeft = '4px solid #28a745';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `
                <strong>‚úÖ Parent ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Document:</strong> ${result.documentType}<br>
                    <strong>Name:</strong> ${result.fullName}<br>
                    <strong>Age:</strong> ${result.age} years old
                </p>
            `;
        } else {
            parentIDVerified = false;
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderLeft = '4px solid #dc3545';
            statusDiv.style.color = '#721c24';
            
            let errorMessage = result.reason || 'Verification failed';
            
            if (!result.isValid) {
                errorMessage = '‚ùå Invalid or unrecognized document. Please upload a clear photo of your Driver\'s License, Passport, or National ID.';
            } else if (!result.isOver16) {
                errorMessage = '‚ùå Parent must be at least 16 years old.';
            } else if (result.documentAppearsTampered) {
                errorMessage = '‚ùå Document appears to be altered. Please upload an original, unedited ID.';
            }
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${errorMessage}</p>
            `;
        }
    } catch (error) {
        console.error('Parent ID Verification Error:', error);
        parentIDVerified = false;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.borderLeft = '4px solid #dc3545';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `
            <strong>‚ùå Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify ID. Please ensure:<br>
                ‚Ä¢ Good lighting<br>
                ‚Ä¢ All text is readable<br>
                ‚Ä¢ No glare or shadows
            </p>
        `;
    }
}

// ===== CHILD ID UPLOAD FUNCTIONS =====
function handleChildIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    childIDFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        childIDBase64 = e.target.result.split(',')[1];
        
        if (file.type.startsWith('image/')) {
            document.getElementById('child-id-preview-image').src = e.target.result;
            document.getElementById('child-id-preview').style.display = 'block';
        }
        
        verifyChildID();
    };
    reader.readAsDataURL(file);
}

function changeChildID() {
    document.getElementById('child-id-file').value = '';
    document.getElementById('child-id-preview').style.display = 'none';
    document.getElementById('child-id-status').style.display = 'none';
    childIDFile = null;
    childIDBase64 = null;
    childIDVerified = false;
}

async function verifyChildID() {
    if (!childIDBase64) {
        alert('Please upload child ID first');
        return;
    }
    
    const statusDiv = document.getElementById('child-id-status');
    const childName = document.getElementById('signup-child-name').value.trim();
    
    if (!childName) {
        alert('Please enter child name first');
        return;
    }
    
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#fff3cd';
    statusDiv.style.borderLeft = '4px solid #ffc107';
    statusDiv.style.padding = '15px';
    statusDiv.style.borderRadius = '8px';
    statusDiv.style.color = '#856404';
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="verification-spinner"></div>
            <strong>Verifying child ID...</strong>
        </div>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: childIDBase64,
                    coachName: childName,
                    userId: 'temp-child-' + Date.now()
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        // ‚úÖ ADD: Check if name matches
        const nameMatches = result.fullName && 
            (result.fullName.toLowerCase().includes(childName.toLowerCase().split(' ')[0]) ||
            childName.toLowerCase().includes(result.fullName.toLowerCase().split(' ')[0]));
        
        // For children, we accept any valid document with matching name
        if (result.isValid && !result.documentAppearsTampered && nameMatches) {
            childIDVerified = true;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderLeft = '4px solid #28a745';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `
                <strong>‚úÖ Child ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Document:</strong> ${result.documentType}<br>
                    <strong>Name on ID:</strong> ${result.fullName}<br>
                    <strong>Your Child's Name:</strong> ${childName}
                    ${result.age ? `<br><strong>Age:</strong> ${result.age} years old` : ''}
                </p>
            `;
        } else {
            childIDVerified = false;
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderLeft = '4px solid #dc3545';
            statusDiv.style.color = '#721c24';
            
            let errorMessage = result.reason || 'Verification failed';
            
            if (!result.isValid) {
                errorMessage = '‚ùå Invalid or unrecognized document. Please upload a clear photo of the child\'s Birth Certificate, Student ID, or Government ID.';
            } else if (result.documentAppearsTampered) {
                errorMessage = '‚ùå Document appears to be altered. Please upload an original, unedited ID.';
            } else if (!nameMatches) {
                errorMessage = `‚ùå Name mismatch! The name on the ID (${result.fullName}) does not match the child's name you entered (${childName}).`;
            }
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${errorMessage}</p>
                ${result.fullName ? `<p style="margin-top: 5px;"><strong>Detected Name:</strong> ${result.fullName}</p>` : ''}
            `;
        }
    } catch (error) {
        console.error('Child ID Verification Error:', error);
        childIDVerified = false;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.borderLeft = '4px solid #dc3545';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `
            <strong>‚ùå Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify ID. Please ensure:<br>
                ‚Ä¢ Good lighting<br>
                ‚Ä¢ All text is readable<br>
                ‚Ä¢ No glare or shadows<br>
                ‚Ä¢ Name matches exactly
            </p>
        `;
    }
}

// ===== PARENT SIGN UP HANDLER =====
async function handleParentSignUp(event) {
    event.preventDefault();
    
    const errorDiv = document.getElementById('signup-parent-error');
    
    // Check ID verifications
    if (!parentIDVerified) {
        errorDiv.textContent = '‚ùå Please upload and verify parent ID first';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!childIDVerified) {
        errorDiv.textContent = '‚ùå Please upload and verify child ID first';
        errorDiv.style.display = 'block';
        return;
    }
    
    const parentName = document.getElementById('signup-parent-name').value.trim();
    const email = document.getElementById('signup-parent-email').value.trim();
    const password = document.getElementById('signup-parent-password').value;
    const phone = document.getElementById('signup-parent-phone').value.trim();
    const country = document.getElementById('signup-parent-country').value;
    
    const childName = document.getElementById('signup-child-name').value.trim();
    const childAge = document.getElementById('signup-child-age').value;
    const childStudentId = document.getElementById('signup-child-student-id').value.trim();
    
    // Validate student ID format
    const studentIdPattern = /^WB-2025-[A-Z0-9]{4}$/;
    if (!studentIdPattern.test(childStudentId)) {
        errorDiv.textContent = '‚ùå Invalid student ID format. Must be WB-2025-XXXX';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Verify student ID exists in database
    try {
        const studentQuery = await db.collection('users')
            .where('studentId', '==', childStudentId)
            .where('userType', '==', 'student')
            .get();
        
        if (studentQuery.empty) {
            errorDiv.textContent = '‚ùå Student ID not found. Please verify the ID is correct.';
            errorDiv.style.display = 'block';
            return;
        }
        
        const studentDoc = studentQuery.docs[0];
        const studentData = studentDoc.data();
        
        // Check if student name matches
        if (studentData.name.toLowerCase() !== childName.toLowerCase()) {
            errorDiv.textContent = `‚ùå Student name does not match. Registered name: ${studentData.name}`;
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check if student already has a parent
        if (studentData.parentId) {
            errorDiv.textContent = '‚ùå This student already has a parent account linked.';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Disable submit button
        const submitBtn = document.getElementById('parent-signup-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Creating account...';
        
        // Create parent account
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: parentName });
        
        // Save parent data to Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
            name: parentName,
            email: email,
            phone: phone,
            country: country,
            userType: 'parent',
            parentIDVerified: true,
            childIDVerified: true,
            childStudentId: childStudentId,
            childName: childName,
            childAge: parseInt(childAge),
            linkedStudentId: studentDoc.id,
            profileComplete: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Link parent to student
        await db.collection('users').doc(studentDoc.id).update({
            parentId: userCredential.user.uid,
            parentName: parentName,
            parentEmail: email,
            parentLinkedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeAuthModal();
        errorDiv.style.display = 'none';
        
        alert(`‚úÖ Parent account created successfully!\n\nYou are now linked to student: ${childName}\nStudent ID: ${childStudentId}`);
        
        // Reset form
        document.getElementById('signup-parent-form').reset();
        parentIDFile = null;
        parentIDBase64 = null;
        childIDFile = null;
        childIDBase64 = null;
        parentIDVerified = false;
        childIDVerified = false;
        
    } catch (error) {
        console.error('Error creating parent account:', error);
        errorDiv.textContent = 'Failed to create account: ' + error.message;
        errorDiv.style.display = 'block';
        
        const submitBtn = document.getElementById('parent-signup-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ Create Parent Account';
    }
}        
    async function updateUIForAuthenticatedUser(user) {
    const displayName = user.displayName || user.email.split('@')[0];
    const photoURL = user.photoURL;
    
    // Update sidebar
    document.getElementById('sidebarUserName').textContent = displayName;
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    
    if (photoURL) {
        sidebarAvatar.style.backgroundImage = `url(${photoURL})`;
        sidebarAvatar.style.backgroundSize = 'cover';
        sidebarAvatar.style.backgroundPosition = 'center';
        sidebarAvatar.textContent = '';
    } else {
        sidebarAvatar.style.backgroundImage = 'none';
        sidebarAvatar.textContent = displayName.charAt(0).toUpperCase();
    }
    
    // Show MY PROFILE button based on user type
    const myProfileBtn = document.getElementById('myProfileBtn');
    
    try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userData = userDoc.data();
        
        if (userData && userData.userType === 'organization') {
            myProfileBtn.innerHTML = 'üë®‚Äçüè´ MY PROFILE';
            myProfileBtn.onclick = () => {
                navigateTo('parent-dashboard');
                loadParentDashboard();
            };
        } else if (userData && userData.userType === 'parent') {
            myProfileBtn.innerHTML = 'üë®‚Äçüë©‚Äçüëß PARENT DASHBOARD';
            myProfileBtn.onclick = () => {
                navigateTo('parent-dashboard');
                loadParentDashboard();
            };
        } else if (userData && userData.userType === 'coach') {
            myProfileBtn.innerHTML = 'üë®‚Äçüè´ MY PROFILE';
            myProfileBtn.onclick = () => {
                navigateTo('student-dashboard');
                loadUserDashboard();
            };
        } else {
            myProfileBtn.innerHTML = 'üë§ MY PROFILE';
            myProfileBtn.onclick = () => {
                navigateTo('student-dashboard');
                loadUserDashboard();
            };
        }
        
        myProfileBtn.style.display = 'block';
    } catch (error) {
        console.error('Error loading user type:', error);
        myProfileBtn.innerHTML = 'üë§ MY PROFILE';
        myProfileBtn.onclick = () => {
            navigateTo('student-dashboard');
            loadUserDashboard();
        };
        myProfileBtn.style.display = 'block';
    }
    
    document.getElementById('sidebar-signin').style.display = 'none';
    document.getElementById('sidebar-signout').style.display = 'block';
}
        
        
      function updateUIForGuestUser() {
    document.getElementById('sidebarUserName').textContent = 'Guest';
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    sidebarAvatar.style.backgroundImage = 'none';
    sidebarAvatar.textContent = '?';
    
    // Hide My Profile button
    document.getElementById('myProfileBtn').style.display = 'none';
    
    document.getElementById('sidebar-signin').style.display = 'block';
    document.getElementById('sidebar-signout').style.display = 'none';
    userFavorites = [];
    userIncorrect = [];
    userSpellingFavorites = [];
    userSpellingIncorrect = [];
    
    // ‚úÖ HIDE COINS
    userCoins = 0;
    hideCoinDisplay();
    
    document.getElementById('favorites-container').innerHTML = '<div class="loading">Please sign in to save favorites</div>';
    document.getElementById('incorrect-container').innerHTML = '<div class="loading">Please sign in to track incorrect answers</div>';
    document.getElementById('spelling-favorites-container').innerHTML = '<div class="loading">Please sign in to save spelling favorites</div>';
    document.getElementById('spelling-incorrect-container').innerHTML = '<div class="loading">Please sign in to track spelling mistakes</div>';
}


// ===== STUDENT ID GENERATION =====
function generateStudentId(userId) {
    return `WB-2025-${userId.slice(-4).toUpperCase()}`;
}  


 // ===== PARENT DASHBOARD FUNCTIONS =====
async function loadParentDashboard() {
    if (!currentUser) return;
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData.userType !== 'parent' && userData.userType !== 'organization') {
            alert('Access denied. Parent/Organization accounts only.');
            navigateTo('home');
            return;
        }
        
        const isOrganization = userData.userType === 'organization';
        const displayName = isOrganization ? (userData.organizationName || userData.name) : userData.name;
        
        // Update header with correct account type label
        document.getElementById('parent-dashboard-name').textContent = displayName || (isOrganization ? 'Organization' : 'Parent');
        document.getElementById('parent-dashboard-email').textContent = userData.email || '';
        
        // Fix avatar centering
        const parentAvatar = document.getElementById('parent-dashboard-avatar');
        if (currentUser.photoURL) {
            parentAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            parentAvatar.style.backgroundSize = 'cover';
            parentAvatar.style.backgroundPosition = 'center';
            parentAvatar.textContent = '';
        } else {
            parentAvatar.style.backgroundImage = 'none';
            parentAvatar.textContent = displayName ? displayName.charAt(0).toUpperCase() : (isOrganization ? 'O' : 'P');
        }
        
        // Update profile section
        if (isOrganization) {
            document.getElementById('parent-display-name').textContent = userData.organizationName || userData.name || 'Organization';
            document.getElementById('parent-edit-name').value = userData.organizationName || userData.name || '';
            document.getElementById('parent-display-phone').textContent = userData.phone || 'Not set';
            document.getElementById('parent-edit-phone').value = userData.phone || '';
            
            // Change "Country" label to "Address" for organizations
            const countryLabel = document.querySelector('.profile-field:has(#parent-display-country) .profile-label');
            if (countryLabel) {
                countryLabel.textContent = 'üè¢ Address';
            }
            
            document.getElementById('parent-display-country').textContent = userData.address || 'Not set';
            document.getElementById('parent-edit-country').value = userData.address || '';
            document.getElementById('parent-edit-country').placeholder = 'Organization address';
        } else {
            document.getElementById('parent-display-name').textContent = userData.name || 'Parent';
            document.getElementById('parent-edit-name').value = userData.name || '';
            document.getElementById('parent-display-phone').textContent = userData.phone || 'Not set';
            document.getElementById('parent-edit-phone').value = userData.phone || '';
            
            // Change label back to "Country" for parents
            const countryLabel = document.querySelector('.profile-field:has(#parent-display-country) .profile-label');
            if (countryLabel) {
                countryLabel.textContent = 'üåç Country';
            }
            
            document.getElementById('parent-display-country').textContent = userData.country || 'Not set';
            document.getElementById('parent-edit-country').value = userData.country || '';
            document.getElementById('parent-edit-country').placeholder = 'Your country';
        }
        
        // Fix email display
        document.getElementById('parent-display-email').textContent = userData.email || currentUser.email || 'Not set';
        
        // Update user type display
        const userTypeElement = document.getElementById('parent-display-usertype');
        if (userTypeElement) {
            if (isOrganization) {
                userTypeElement.textContent = 'üè¢ Organization Account';
            } else {
                userTypeElement.textContent = 'üë®‚Äçüë©‚Äçüëß Parent Account';
            }
        }
        
        // Show join date
        if (userData.createdAt) {
            const joinDate = userData.createdAt.toDate();
            document.getElementById('parent-display-joined').textContent = joinDate.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        } else {
            document.getElementById('parent-display-joined').textContent = 'Recently joined';
        }
        
        // HIDE child status container (old single child view)
        const childContainer = document.getElementById('child-status-container');
        if (childContainer) {
            childContainer.style.display = 'none';
        }
        
        // Hide transaction history section completely
        const transactionSection = document.querySelector('.dashboard-section:has(#transaction-history-container)');
        if (transactionSection) {
            transactionSection.style.display = 'none';
        }
        
        // Show guardian students section
        document.getElementById('guardian-students-section').style.display = 'block';
        document.getElementById('guardian-support-section').style.display = 'block';
        
        // Load all children accounts
        await loadGuardianStudents();
        
    } catch (error) {
        console.error('Error loading parent dashboard:', error);
        alert('Failed to load dashboard: ' + error.message);
    }
}
        
async function loadChildAccountStatus(childId) {
    const container = document.getElementById('child-status-container');
    
    try {
        container.innerHTML = '<div class="loading">Loading child account status...</div>';
        
        const childDoc = await db.collection('users').doc(childId).get();
        
        if (!childDoc.exists) {
            container.innerHTML = '<div class="feedback error">‚ùå Child account not found</div>';
            return;
        }
        
        const childData = childDoc.data();
        currentChildData = { id: childId, ...childData };
        
        const subscriptionExpiry = childData.subscriptionExpiry?.toDate();
        const coins = childData.coins || 0;
        const now = new Date();
        
        let statusClass = 'active';
        let statusIcon = '‚úÖ';
        let statusTitle = 'Account Active';
        let statusMessage = 'Your child\'s account is active and they can continue learning.';
        let showReopenButton = false;
        
        // Check if subscription expired
        if (subscriptionExpiry && now > subscriptionExpiry) {
            statusClass = '';
            statusIcon = 'üîí';
            statusTitle = 'Account Locked';
            statusMessage = 'Subscription has expired. Your child cannot access learning materials until account is reopened.';
            showReopenButton = true;
        } else if (coins < 300 && subscriptionExpiry) {
            // Check if expiring soon (within 7 days)
            const daysLeft = Math.ceil((subscriptionExpiry - now) / (1000 * 60 * 60 * 24));
            if (daysLeft <= 7) {
                statusClass = 'warning';
                statusIcon = '‚ö†Ô∏è';
                statusTitle = 'Low Coins Warning';
                statusMessage = `Your child has only ${coins} coins and ${daysLeft} days left. They won\'t be able to renew their subscription when it expires.`;
                showReopenButton = false;
            }
        }
        
        const studentId = childData.studentId || `WB-2025-${childId.slice(-4).toUpperCase()}`;
        
        container.innerHTML = `
            <div class="child-status-card ${statusClass}">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">${statusIcon}</div>
                    <h2 style="margin: 0 0 10px 0; color: white;">${statusTitle}</h2>
                    <p style="margin: 0; opacity: 0.95; font-size: 1.1rem;">${statusMessage}</p>
                </div>
                
                <div class="child-info-grid">
                    <div class="child-info-item">
                        <div class="child-info-label">üë§ Child Name</div>
                        <div class="child-info-value">${childData.name || 'Student'}</div>
                    </div>
                    
                    <div class="child-info-item">
                        <div class="child-info-label">üÜî Student ID</div>
                        <div class="child-info-value" style="font-size: 1.2rem;">${studentId}</div>
                    </div>
                    
                    <div class="child-info-item">
                        <div class="child-info-label">ü™ô Coins</div>
                        <div class="child-info-value">${coins} / 1000</div>
                    </div>
                    
                    <div class="child-info-item">
                        <div class="child-info-label">üìÖ Subscription</div>
                        <div class="child-info-value" style="font-size: 1rem;">
                            ${subscriptionExpiry ? 
                                (now > subscriptionExpiry ? 'Expired' : 
                                `${Math.ceil((subscriptionExpiry - now) / (1000 * 60 * 60 * 24))} days left`) 
                                : 'Never activated'}
                        </div>
                    </div>
                </div>
                
                ${showReopenButton ? `
                    <button class="reopen-account-btn" onclick="showPaymentModal()">
                        üí≥ Reopen Account for $6.50 USD
                    </button>
                    
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <p style="margin: 0; font-size: 0.9rem; opacity: 0.95;">
                            ‚ÑπÔ∏è Payment will immediately reopen your child's account for 30 days. 
                            They will regain full access to all learning materials.
                        </p>
                    </div>
                ` : ''}
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading child account status:', error);
        container.innerHTML = '<div class="feedback error">‚ùå Failed to load child account status</div>';
    }
}

async function showPaymentModal() {
    if (!currentChildData) {
        alert('Child data not loaded');
        return;
    }
    
    const modal = document.getElementById('paymentModal');
    const studentId = currentChildData.studentId || `WB-2025-${currentChildData.id.slice(-4).toUpperCase()}`;
    
    document.getElementById('payment-child-name').textContent = currentChildData.name || 'Student';
    document.getElementById('payment-child-id').textContent = studentId;
    
    modal.classList.add('active');
    
    // Load PayPal SDK first, then initialize button
    if (!paypalButtonRendered) {
        try {
            await loadPayPalSDK();
            initializePayPalButton();
        } catch (error) {
            console.error('Failed to load PayPal:', error);
            showPaymentError('Failed to load payment system. Please try again.');
        }
    }
}

function closePaymentModal() {
    document.getElementById('paymentModal').classList.remove('active');
}

function initializePayPalButton() {
    const container = document.getElementById('paypal-button-container');
    container.innerHTML = ''; // Clear any existing buttons
    
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    description: `WordBiz Academy - 30 Day Access for ${currentChildData.name}`,
                    amount: {
                        currency_code: 'USD',
                        value: REOPEN_ACCOUNT_COST.toFixed(2)
                    }
                }]
            });
        },
        onApprove: async function(data, actions) {
            try {
                // Capture the payment
                const order = await actions.order.capture();
                console.log('‚úÖ Payment captured:', order);
                
                // Verify payment with our backend
                const verifyResponse = await fetch(PAYPAL_VERIFY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        orderId: order.id 
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                console.log('‚úÖ Verification result:', verifyResult);
                
                if (verifyResult.success && verifyResult.data.verified) {
                    await processPaymentSuccess(verifyResult.data);
                } else {
                    throw new Error('Payment verification failed');
                }
                
            } catch (error) {
                console.error('‚ùå Payment error:', error);
                showPaymentError('Failed to process payment: ' + error.message);
            }
        },
        onError: function(err) {
            console.error('‚ùå PayPal error:', err);
            showPaymentError('Payment failed. Please try again.');
        },
        onCancel: function(data) {
            console.log('‚ö†Ô∏è Payment cancelled by user');
            showPaymentError('Payment was cancelled.');
        }
    }).render('#paypal-button-container');
    
    paypalButtonRendered = true;
}
        
      async function processPaymentSuccess(order) {
    try {
        const errorDiv = document.getElementById('payment-error');
        const successDiv = document.getElementById('payment-success');
        
        errorDiv.style.display = 'none';
        successDiv.style.display = 'block';
        successDiv.textContent = '‚úÖ Payment captured! Verifying with server...';
        
        console.log('üì§ Sending verification request to server...');
        
        // Verify payment with backend
        const verifyResponse = await fetch(PAYPAL_HANDLER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                action: 'verify_reopen',
                orderId: order.id,
                userId: currentUser.uid,
                childId: currentChildData.id
            })
        });
        
        if (!verifyResponse.ok) {
            const errorText = await verifyResponse.text();
            console.error('‚ùå Server response error:', errorText);
            throw new Error(`Server error: ${verifyResponse.status}`);
        }
        
        const verifyResult = await verifyResponse.json();
        console.log('‚úÖ Verification result:', verifyResult);
        
        if (!verifyResult.success) {
            throw new Error(verifyResult.error || 'Payment verification failed');
        }
        
        successDiv.textContent = '‚úÖ Payment successful! Account reopened for 30 days!';
        
        // Reload child status
        setTimeout(async () => {
            closePaymentModal();
            await loadChildAccountStatus(currentChildData.id);
            
            alert('‚úÖ Success!\n\nYour child\'s account has been reopened for 30 days.\nThey can now resume learning immediately.');
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå Error processing payment:', error);
        showPaymentError('Payment failed: ' + error.message);
    }
}

function showPaymentError(message) {
    const errorDiv = document.getElementById('payment-error');
    const successDiv = document.getElementById('payment-success');
    
    successDiv.style.display = 'none';
    errorDiv.style.display = 'block';
    errorDiv.textContent = message;
}

async function loadTransactionHistory() {
    const container = document.getElementById('transaction-history-container');
    
    try {
        container.innerHTML = '<div class="loading">Loading payment history...</div>';
        
        const transactionsSnapshot = await db.collection('users')
            .doc(currentUser.uid)
            .collection('transactions')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .get();
        
        if (transactionsSnapshot.empty) {
            container.innerHTML = '<div class="loading">No payment history yet</div>';
            return;
        }
        
        let html = '<div class="transaction-history">';
        
        transactionsSnapshot.forEach(doc => {
            const transaction = doc.data();
            const date = transaction.createdAt?.toDate();
            const expiryDate = transaction.expiryDate?.toDate();
            
            html += `
                <div class="transaction-item ${transaction.status === 'failed' ? 'failed' : ''}">
                    <div class="transaction-date">
                        üìÖ ${date ? date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Unknown date'}
                    </div>
                    <div class="transaction-amount">
                        üí≥ $${transaction.amount.toFixed(2)} USD
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <strong>For:</strong> ${transaction.childName}<br>
                        <strong>Service:</strong> 30-Day Access<br>
                        ${expiryDate ? `<strong>Valid Until:</strong> ${expiryDate.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric'
                        })}<br>` : ''}
                        <strong>Status:</strong> ${transaction.status === 'completed' ? '‚úÖ Completed' : '‚ùå Failed'}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading transaction history:', error);
        container.innerHTML = '<div class="feedback error">‚ùå Failed to load payment history</div>';
    }
}

function toggleParentEditMode() {
    document.getElementById('parent-display-name').style.display = 'none';
    document.getElementById('parent-edit-name').style.display = 'block';
    
    document.getElementById('parent-display-phone').style.display = 'none';
    document.getElementById('parent-edit-phone').style.display = 'block';
    
    document.getElementById('parent-display-country').style.display = 'none';
    document.getElementById('parent-edit-country').style.display = 'block';
    
    document.getElementById('parent-edit-profile-btn').style.display = 'none';
    document.getElementById('parent-save-profile-btn').style.display = 'inline-block';
    document.getElementById('parent-cancel-edit-btn').style.display = 'inline-block';
}

function cancelParentEditMode() {
    document.getElementById('parent-display-name').style.display = 'inline';
    document.getElementById('parent-edit-name').style.display = 'none';
    
    document.getElementById('parent-display-phone').style.display = 'inline';
    document.getElementById('parent-edit-phone').style.display = 'none';
    
    document.getElementById('parent-display-country').style.display = 'inline';
    document.getElementById('parent-edit-country').style.display = 'none';
    
    document.getElementById('parent-edit-profile-btn').style.display = 'inline-block';
    document.getElementById('parent-save-profile-btn').style.display = 'none';
    document.getElementById('parent-cancel-edit-btn').style.display = 'none';
}

async function saveParentProfile() {
    if (!currentUser) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        const isOrganization = userData.userType === 'organization';
        
        const newName = document.getElementById('parent-edit-name').value.trim();
        const newPhone = document.getElementById('parent-edit-phone').value.trim();
        const newCountryOrAddress = document.getElementById('parent-edit-country').value;
        
        if (!newName) {
            alert('Name cannot be empty');
            return;
        }
        
        const updateData = {
            phone: newPhone
        };
        
        if (isOrganization) {
            updateData.organizationName = newName;
            updateData.name = newName; // Keep both for consistency
            updateData.address = newCountryOrAddress;
        } else {
            updateData.name = newName;
            updateData.country = newCountryOrAddress;
        }
        
        await db.collection('users').doc(currentUser.uid).update(updateData);
        
        await currentUser.updateProfile({ displayName: newName });
        
        document.getElementById('parent-display-name').textContent = newName;
        document.getElementById('parent-display-phone').textContent = newPhone || 'Not set';
        document.getElementById('parent-display-country').textContent = newCountryOrAddress || 'Not set';
        
        document.getElementById('parent-dashboard-name').textContent = newName;
        
        cancelParentEditMode();
        alert('Profile updated successfully!');
    } catch (error) {
        console.error('Error updating parent profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
}
// Add parent dashboard to navigation
async function goToParentDashboard() {
    if (!currentUser) {
        showAuthModal();
        return;
    }
    
    navigateTo('parent-dashboard');
    await loadParentDashboard();
}    


  // ===== DASHBOARD FUNCTIONS =====
async function goToUserDashboard() {
    if (!currentUser) {
        showAuthModal();
        return;
    }
    
    // Navigate to dashboard first
    navigateTo('student-dashboard');
    
    // Then load user data (with loading state)
    await loadUserDashboard();
}

async function loadUserDashboard() {
    if (!currentUser) return;
    
    try {
        // Show loading state
        document.getElementById('dashboard-name').textContent = 'Loading...';
        document.getElementById('dashboard-email').textContent = 'Loading...';
        
        // Get user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        // ‚úÖ CHECK IF USER IS A COACH
        const isCoach = userData?.userType === 'coach';
        
        // ‚úÖ FIXED: Added parentheses to fix coach name display
        const displayName = userData?.name || currentUser.displayName || (isCoach ? 'Coach' : 'Student');
        document.getElementById('dashboard-name').textContent = displayName;
        document.getElementById('dashboard-email').textContent = userData?.email || currentUser.email || '';
        
        // Update avatar with Google photo or initials
        const dashboardAvatar = document.getElementById('dashboard-avatar');
        if (currentUser.photoURL) {
            dashboardAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            dashboardAvatar.textContent = '';
        } else {
            dashboardAvatar.style.backgroundImage = 'none';
            dashboardAvatar.textContent = displayName.charAt(0).toUpperCase();
        }
        
        // Format join date
        if (userData?.createdAt) {
            const joinDate = userData.createdAt.toDate();
            document.getElementById('dashboard-join-date').textContent = 
                `Member since: ${joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;
            document.getElementById('display-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            document.getElementById('dashboard-join-date').textContent = 'Member since: Recently joined';
            document.getElementById('display-joined').textContent = 'Recently joined';
        }
        
        // Update profile fields
        document.getElementById('display-name').textContent = displayName;
        document.getElementById('edit-name').value = displayName;
        
        document.getElementById('display-email').textContent = userData?.email || currentUser.email || 'N/A';
        
        // ‚úÖ HIDE/SHOW STUDENT ID BASED ON USER TYPE
        const studentIdRow = document.querySelector('.profile-field:has(#display-student-id)');
        if (isCoach) {
            if (studentIdRow) studentIdRow.style.display = 'none';
        } else {
            if (studentIdRow) studentIdRow.style.display = 'flex';
            const studentId = userData?.studentId || `WB-2025-${currentUser.uid.slice(-4).toUpperCase()}`;
            document.getElementById('display-student-id').textContent = studentId;
        }
        
        document.getElementById('display-age').textContent = userData?.age || 'Not specified';
        document.getElementById('edit-age').value = userData?.age || '';
        
        document.getElementById('display-country').textContent = userData?.country || 'Not specified';
        document.getElementById('edit-country').value = userData?.country || '';
        
        // ‚úÖ FIXED: Show proper user type
        document.getElementById('display-usertype').textContent = 
            userData?.userType ? userData.userType.charAt(0).toUpperCase() + userData.userType.slice(1) + ' Account' : 'Student Account';
        
       // ===== COACH-SPECIFIC RESTRICTIONS =====
        if (isCoach) {
            // Hide edit button for coaches
            document.getElementById('edit-profile-btn').style.display = 'none';
            
            // Hide delete account option for coaches
            const deleteAccountOption = document.querySelector('.setting-item[onclick="confirmDeleteAccount()"]');
            if (deleteAccountOption) {
                deleteAccountOption.style.display = 'none';
            }
            
            // ‚úÖ HIDE ONLY SPELLING INCORRECT AND QUIZ INCORRECT FOR COACHES
            const allStatCards = document.querySelectorAll('.dashboard-card');
            allStatCards.forEach(card => {
                const label = card.querySelector('.card-label');
                if (label) {
                    const text = label.textContent;
                    if (text.includes('MISTAKES') || text.includes('INCORRECT')) {
                        card.style.display = 'none';
                    }
                }
            });
            
            // ‚úÖ HIDE SUBSCRIPTION STATUS FOR COACHES
            const subscriptionSection = document.querySelector('.dashboard-section:has(#sub-status-icon)');
            if (subscriptionSection) {
                subscriptionSection.style.display = 'none';
            }
            
        } else {
            // Show everything for students
            document.getElementById('edit-profile-btn').style.display = 'inline-block';
            
            const deleteAccountOption = document.querySelector('.setting-item[onclick="confirmDeleteAccount()"]');
            if (deleteAccountOption) {
                deleteAccountOption.style.display = 'flex';
            }
            
            // Show quick stats for students
            const quickStatsSection = document.querySelector('.dashboard-section:has(.dashboard-grid)');
            if (quickStatsSection) {
                quickStatsSection.style.display = 'block';
            }
            
            // Show subscription status for students
            const subscriptionSection = document.querySelector('.dashboard-section:has(#sub-status-icon)');
            if (subscriptionSection) {
                subscriptionSection.style.display = 'block';
            }
        }
        
        // Update stats (wait for them to be loaded)
        setTimeout(() => {
            // ‚úÖ UPDATE FAVORITES FOR EVERYONE (including coaches)
            const quizFavElement = document.getElementById('stat-quiz-favorites');
            const spellingFavElement = document.getElementById('stat-spelling-favorites');
            
            if (quizFavElement) quizFavElement.textContent = userFavorites.length;
            if (spellingFavElement) spellingFavElement.textContent = userSpellingFavorites.length;
            
            // ‚úÖ ONLY UPDATE INCORRECT STATS FOR STUDENTS
            if (!isCoach) {
                const quizIncorrectElement = document.getElementById('stat-quiz-incorrect');
                const spellingIncorrectElement = document.getElementById('stat-spelling-incorrect');
                
                if (quizIncorrectElement) quizIncorrectElement.textContent = userIncorrect.length;
                if (spellingIncorrectElement) spellingIncorrectElement.textContent = userSpellingIncorrect.length;
                
                // Update subscription status
                updateDashboardSubscriptionStatus();
            }
        }, 500);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('dashboard-name').textContent = 'Error loading profile';
        document.getElementById('dashboard-email').textContent = 'Please try refreshing';
    }
}
        
        // ===== PASSWORD CHANGE FUNCTIONS =====
function showChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.add('active');
    
    // Clear form
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}

function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('active');
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}

async function handleChangePassword(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Please sign in to change password');
        return;
    }
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-new-password').value;
    
    const errorDiv = document.getElementById('change-password-error');
    const successDiv = document.getElementById('change-password-success');
    
    // Hide previous messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'New passwords do not match!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate new password is different
    if (currentPassword === newPassword) {
        errorDiv.textContent = 'New password must be different from current password!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate password strength
    if (newPassword.length < 6) {
        errorDiv.textContent = 'New password must be at least 6 characters!';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Re-authenticate user with current password
        const credential = firebase.auth.EmailAuthProvider.credential(
            currentUser.email,
            currentPassword
        );
        
        await currentUser.reauthenticateWithCredential(credential);
        
        // Update password
        await currentUser.updatePassword(newPassword);
        
        // Success!
        successDiv.textContent = '‚úÖ Password changed successfully!';
        successDiv.style.display = 'block';
        
        // Clear form
        document.getElementById('change-password-form').reset();
        
        // Close modal after 2 seconds
        setTimeout(() => {
            closeChangePasswordModal();
        }, 2000);
        
    } catch (error) {
        console.error('Error changing password:', error);
        
        let errorMessage = 'Failed to change password. ';
        
        if (error.code === 'auth/wrong-password') {
            errorMessage += 'Current password is incorrect.';
        } else if (error.code === 'auth/weak-password') {
            errorMessage += 'New password is too weak.';
        } else if (error.code === 'auth/requires-recent-login') {
            errorMessage += 'Please sign out and sign in again, then try changing your password.';
        } else {
            errorMessage += error.message;
        }
        
        errorDiv.textContent = errorMessage;
        errorDiv.style.display = 'block';
    }
}

// Special handling for Google sign-in users
async function handlePasswordChangeForGoogleUsers() {
    if (currentUser && currentUser.providerData.length > 0) {
        const provider = currentUser.providerData[0].providerId;
        
        if (provider === 'google.com') {
            alert('You signed in with Google. To change your password, please go to your Google Account settings.');
            return true; // Indicates Google user
        }
    }
    return false; // Not a Google user
}

// Update showChangePasswordModal to check for Google users
function showChangePasswordModal() {
    // Check if user signed in with Google
    if (currentUser && currentUser.providerData.length > 0) {
        const provider = currentUser.providerData[0].providerId;
        
        if (provider === 'google.com') {
            alert('üîê You signed in with Google.\n\nTo change your password, please visit:\nhttps://myaccount.google.com/security');
            return;
        }
    }
    
    document.getElementById('changePasswordModal').classList.add('active');
    
    // Clear form
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}
        
async function toggleEditMode() {
    // Check if user is a coach
    if (currentUser) {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData?.userType === 'coach') {
                alert('üõ°Ô∏è Coach profiles cannot be edited.\n\nFor security reasons, coach account information is locked after ID verification.\n\nPlease contact support if you need to update your information.');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // Hide display elements, show edit inputs (for students only)
    document.getElementById('display-name').style.display = 'none';
    document.getElementById('edit-name').style.display = 'block';
    
    document.getElementById('display-age').style.display = 'none';
    document.getElementById('edit-age').style.display = 'block';
    
    document.getElementById('display-country').style.display = 'none';
    document.getElementById('edit-country').style.display = 'block';
    
    // Toggle buttons
    document.getElementById('edit-profile-btn').style.display = 'none';
    document.getElementById('save-profile-btn').style.display = 'inline-block';
    document.getElementById('cancel-edit-btn').style.display = 'inline-block';
}

function cancelEditMode() {
    // Show display elements, hide edit inputs
    document.getElementById('display-name').style.display = 'inline';
    document.getElementById('edit-name').style.display = 'none';
    
    document.getElementById('display-age').style.display = 'inline';
    document.getElementById('edit-age').style.display = 'none';
    
    document.getElementById('display-country').style.display = 'inline';
    document.getElementById('edit-country').style.display = 'none';
    
    // Toggle buttons
    document.getElementById('edit-profile-btn').style.display = 'inline-block';
    document.getElementById('save-profile-btn').style.display = 'none';
    document.getElementById('cancel-edit-btn').style.display = 'none';
    
    document.getElementById('profile-form').classList.remove('edit-mode');
}

async function saveProfile() {
    if (!currentUser) return;
    
    const newName = document.getElementById('edit-name').value.trim();
    const newAge = document.getElementById('edit-age').value;
    const newCountry = document.getElementById('edit-country').value;
    
    if (!newName) {
        alert('Name cannot be empty');
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            name: newName,
            age: newAge,
            country: newCountry
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: newName });
        
        // Update UI
        document.getElementById('display-name').textContent = newName;
        document.getElementById('display-age').textContent = newAge;
        document.getElementById('display-country').textContent = newCountry;
        
        // Update dashboard header
        document.getElementById('dashboard-name').textContent = newName;
        const dashboardAvatar = document.getElementById('dashboard-avatar');
        if (currentUser.photoURL) {
            dashboardAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            dashboardAvatar.textContent = '';
        } else {
            dashboardAvatar.style.backgroundImage = 'none';
            dashboardAvatar.textContent = newName.charAt(0).toUpperCase();
        }
        
        // Update sidebar
        document.getElementById('sidebarUserName').textContent = newName;
        const sidebarAvatar = document.getElementById('sidebarUserAvatar');
        if (currentUser.photoURL) {
            sidebarAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            sidebarAvatar.textContent = '';
        } else {
            sidebarAvatar.style.backgroundImage = 'none';
            sidebarAvatar.textContent = newName.charAt(0).toUpperCase();
        }
        
        cancelEditMode();
        alert('Profile updated successfully!');
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
}

        function showChangePasswordModal() {
    alert('Change password feature coming soon! For now, you can reset your password using the "Forgot Password" link on the sign-in page.');
}

async function confirmDeleteAccount() {
    if (!currentUser) return;
    
    // Check if user is a coach
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData?.userType === 'coach') {
            alert('üõ°Ô∏è Coach accounts cannot be deleted.\n\nFor security and compliance reasons, coach accounts must be deactivated by an administrator.\n\nPlease contact support if you need to deactivate your account.');
            return;
        }
    } catch (error) {
        console.error('Error checking user type:', error);
    }
    
    // Proceed with deletion for non-coach users
    if (confirm('‚ö†Ô∏è WARNING: This will permanently delete your account and all your data. This action cannot be undone.\n\nAre you absolutely sure?')) {
        if (confirm('Final confirmation: Delete your account forever?')) {
            deleteUserAccount();
        }
    }
}

async function deleteUserAccount() {
    if (!currentUser) return;
    
    try {
        // Delete user data from Firestore
        await db.collection('users').doc(currentUser.uid).delete();
        
        // Delete user subcollections
        const collections = ['favorites', 'incorrectQuestions', 'spellingFavorites', 'spellingIncorrect'];
        for (const collection of collections) {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection(collection).get();
            const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);
        }
        
        // Delete Firebase Auth account
        await currentUser.delete();
        
        alert('Your account has been successfully deleted.');
        navigateTo('home');
    } catch (error) {
        console.error('Error deleting account:', error);
        alert('Failed to delete account: ' + error.message);
    }
}

     function typeKey(letter) {
    const input = document.getElementById('spelling-input');
    if (input.disabled) return;
    input.value += letter.toLowerCase();
}

function backspaceKey() {
    const input = document.getElementById('spelling-input');
    if (input.disabled) return;
    input.value = input.value.slice(0, -1);
}          



  // ===== ORGANIZATION PROFILE FUNCTIONS =====
function showOrgProfileModal(user) {
    const modal = document.getElementById('orgProfileModal');
    document.getElementById('org-contact-email').value = user.email;
    modal.classList.add('active');
}

function closeOrgProfileModal() {
    document.getElementById('orgProfileModal').classList.remove('active');
}

async function handleOrgProfileCompletion(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const orgName = document.getElementById('org-name').value.trim();
    const contactEmail = document.getElementById('org-contact-email').value.trim();
    const phone = document.getElementById('org-phone').value.trim();
    const address = document.getElementById('org-address').value.trim();
    
    const errorDiv = document.getElementById('org-profile-error');
    
    if (!orgName || !phone || !address) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            organizationName: orgName,
            contactEmail: contactEmail,
            phone: phone,
            address: address,
            profileComplete: true,
            name: orgName // Set organization name as display name
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: orgName });
        
        errorDiv.style.display = 'none';
        closeOrgProfileModal();
        
        alert(`‚úÖ Organization profile completed!\n\nOrganization: ${orgName}\n\nYou can now manage students from your dashboard.`);
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
        navigateTo('parent-dashboard');
        await loadParentDashboard();
        
    } catch (error) {
        console.error('Error completing organization profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

    // ===== GUARDIAN STUDENT MANAGEMENT =====
function showAddStudentModal() {
    document.getElementById('addStudentModal').classList.add('active');
    document.getElementById('add-student-form').reset();
    document.getElementById('add-student-error').style.display = 'none';
    document.getElementById('add-student-success').style.display = 'none';
}

function closeAddStudentModal() {
    document.getElementById('addStudentModal').classList.remove('active');
}

async function handleAddStudent(event) {
    event.preventDefault();
    if (!currentUser) {
        alert('Please sign in first');
        return;
    }
    const studentId = document.getElementById('add-student-id').value.trim().toUpperCase();
    const studentName = document.getElementById('add-student-name').value.trim();
    const studentAge = parseInt(document.getElementById('add-student-age').value);
    const errorDiv = document.getElementById('add-student-error');
    const successDiv = document.getElementById('add-student-success');
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    const studentIdPattern = /^WB-2025-[A-Z0-9]{4}$/;
    if (!studentIdPattern.test(studentId)) {
        errorDiv.textContent = '‚ùå Invalid student ID format. Must be WB-2025-XXXX';
        errorDiv.style.display = 'block';
        return;
    }
    try {
        const studentQuery = await db.collection('users').where('studentId', '==', studentId).where('userType', '==', 'student').get();
        if (studentQuery.empty) {
            errorDiv.textContent = '‚ùå Student ID not found. Please verify the ID is correct.';
            errorDiv.style.display = 'block';
            return;
        }
        const studentDoc = studentQuery.docs[0];
        const studentData = studentDoc.data();
        if (studentData.name.toLowerCase() !== studentName.toLowerCase()) {
            errorDiv.textContent = `‚ùå Student name does not match. Registered name: ${studentData.name}`;
            errorDiv.style.display = 'block';
            return;
        }
        if (studentData.guardianId) {
            errorDiv.textContent = '‚ùå This student already has a guardian linked.';
            errorDiv.style.display = 'block';
            return;
        }
        const guardianDoc = await db.collection('users').doc(currentUser.uid).get();
        const guardianData = guardianDoc.data();
        const guardianName = guardianData.userType === 'organization' ? guardianData.organizationName : guardianData.name;
        await db.collection('users').doc(studentDoc.id).update({
            guardianId: currentUser.uid,
            guardianName: guardianName,
            guardianEmail: currentUser.email,
            hasGuardian: true,
            guardianLinkedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        successDiv.textContent = `‚úÖ Student "${studentName}" successfully added!`;
        successDiv.style.display = 'block';
        document.getElementById('add-student-form').reset();
        setTimeout(() => {
            closeAddStudentModal();
            loadGuardianStudents();
        }, 2000);
    } catch (error) {
        console.error('Error adding student:', error);
        errorDiv.textContent = 'Failed to add student: ' + error.message;
        errorDiv.style.display = 'block';
    }
}



async function loadGuardianStudents() {
    if (!currentUser) return;
    const container = document.getElementById('guardian-students-container');
    
    try {
        container.innerHTML = '<div class="loading">Loading students...</div>';
        
        const studentsSnapshot = await db.collection('users')
            .where('guardianId', '==', currentUser.uid)
            .where('userType', '==', 'student')
            .get();
        
        // Get all student data with coach information
        const studentPromises = [];
        studentsSnapshot.forEach(doc => {
            studentPromises.push(getStudentFullData(doc.id, doc.data()));
        });
        
        const students = await Promise.all(studentPromises);
        
        let html = '';
        
        if (students.length === 0) {
            html += `
                <div class="loading">
                    <p style="margin-bottom: 15px;">No students added yet.</p>
                </div>
            `;
        } else {
            // Display each student as a card
            students.forEach(student => {
                const now = new Date();
                const coachExpiryDate = student.coachExpiry;
                let coachStatus = 'Not in any class';
                let coachStatusColor = '#868e96';
                
                if (student.coachName && coachExpiryDate) {
                    if (now < coachExpiryDate) {
                        const daysLeft = Math.ceil((coachExpiryDate - now) / (1000 * 60 * 60 * 24));
                        coachStatus = `Expires in ${daysLeft} days`;
                        coachStatusColor = daysLeft > 7 ? '#51cf66' : '#ffc107';
                    } else {
                        coachStatus = 'Expired';
                        coachStatusColor = '#ff6b6b';
                    }
                }
                
                html += `
                    <div style="background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 2px solid #e3f2fd;">
                        
                        <!-- Student Header -->
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e3f2fd;">
                            <div style="width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold;">
                                ${student.photoURL ? 
                                    `<img src="${student.photoURL}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` :
                                    student.name.charAt(0).toUpperCase()
                                }
                            </div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0; color: #0d3b66; font-size: 1.3rem;">${student.name}</h3>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">${student.email}</p>
                                <p style="margin: 5px 0 0 0; color: #666; font-size: 0.85rem; font-family: monospace;"><strong>ID:</strong> ${student.studentId}</p>
                            </div>
                        </div>
                        
                        <!-- Student Stats Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            
                            <!-- Coins -->
                            <div style="background: linear-gradient(135deg, #ffd700, #ffed4e); padding: 15px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 5px;">ü™ô</div>
                                <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66;">${student.coins}</div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 5px;">Coins Available</div>
                            </div>
                            
                            <!-- Coach Class Status -->
                            <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 1.1rem; font-weight: bold; color: #0d3b66; margin-bottom: 8px;">
                                    üë®‚Äçüè´ Coach Class
                                </div>
                                ${student.coachName ? `
                                    <div style="margin-bottom: 5px;">
                                        <strong style="color: #0d3b66;">${student.coachName}</strong>
                                    </div>
                                    <div style="background: ${coachStatusColor}; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem; display: inline-block; margin-top: 5px;">
                                        ${coachStatus}
                                    </div>
                                ` : `
                                    <div style="color: #666; font-size: 0.9rem;">Not enrolled in any class</div>
                                `}
                            </div>
                            
                            <!-- Booking Status -->
                            <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 1.1rem; font-weight: bold; color: #0d3b66; margin-bottom: 8px;">
                                    üéØ Booking Status
                                </div>
                                ${student.bookingEnabled ? `
                                    <div style="background: #51cf66; color: white; padding: 8px 12px; border-radius: 15px; font-size: 0.9rem; text-align: center;">
                                        ‚úÖ Active
                                        ${student.bookingDaysLeft ? `<div style="font-size: 0.8rem; margin-top: 3px;">${student.bookingDaysLeft} days left</div>` : ''}
                                    </div>
                                ` : `
                                    <div style="background: #ff6b6b; color: white; padding: 8px 12px; border-radius: 15px; font-size: 0.9rem; text-align: center;">
                                        ‚ùå Disabled
                                    </div>
                                `}
                            </div>
                            
                        </div>
                        
                        <!-- Action Button -->
                        <div style="text-align: right;">
                            <button class="practice-btn" onclick="removeGuardianStudent('${student.id}', '${student.name}')" 
                                style="padding: 10px 20px; font-size: 0.9rem; background: #dc3545;">
                                üóëÔ∏è Remove Student
                            </button>
                        </div>
                        
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading guardian students:', error);
        container.innerHTML = '<div class="feedback error">‚ùå Failed to load students</div>';
    }
}
        
// Helper function to get full student data including coach info
async function getStudentFullData(studentId, studentData) {
    const now = new Date();
    
    // Get coach information if student has a coach
    let coachName = null;
    let coachExpiry = null;
    
    if (studentData.coachId) {
        try {
            const coachDoc = await db.collection('users').doc(studentData.coachId).get();
            if (coachDoc.exists) {
                const coachData = coachDoc.data();
                coachName = coachData.name || 'Unknown Coach';
                
                // Get class expiry date from student's record
                if (studentData.classExpiryDate) {
                    coachExpiry = studentData.classExpiryDate.toDate();
                } else if (studentData.classJoinedAt) {
                    // Fallback: calculate from join date if expiry not set
                    coachExpiry = new Date(studentData.classJoinedAt.toDate());
                    coachExpiry.setDate(coachExpiry.getDate() + 30);
                }
            }
        } catch (error) {
            console.error('Error fetching coach data:', error);
        }
    }
    
    // Calculate booking days left
    let bookingDaysLeft = null;
    if (studentData.bookingEnabled && studentData.bookingExpiry) {
        const expiryDate = studentData.bookingExpiry.toDate();
        if (now < expiryDate) {
            bookingDaysLeft = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
        }
    }
    
    return {
        id: studentId,
        name: studentData.name || 'Student',
        email: studentData.email || 'No email',
        studentId: studentData.studentId || `WB-2025-${studentId.slice(-4).toUpperCase()}`,
        photoURL: studentData.photoURL || null,
        coins: studentData.coins || 0,
        coachName: coachName,
        coachExpiry: coachExpiry,
        bookingEnabled: studentData.bookingEnabled || false,
        bookingDaysLeft: bookingDaysLeft
    };
}


// ===== CHECK AND REMOVE EXPIRED CLASS ENROLLMENTS =====
async function checkAndRemoveExpiredStudents() {
    try {
        const now = new Date();
        
        // Get all students with expired class enrollment
        const expiredStudentsSnapshot = await db.collection('users')
            .where('userType', '==', 'student')
            .where('classExpiryDate', '<=', firebase.firestore.Timestamp.fromDate(now))
            .get();
        
        if (expiredStudentsSnapshot.empty) {
            return; // No expired students
        }
        
        const batch = db.batch();
        const classUpdates = new Map(); // Track class student count updates
        
        expiredStudentsSnapshot.forEach(doc => {
            const studentData = doc.data();
            
            // Remove student from class
            batch.update(doc.ref, {
                classId: firebase.firestore.FieldValue.delete(),
                coachId: firebase.firestore.FieldValue.delete(),
                classJoinedAt: firebase.firestore.FieldValue.delete(),
                classExpiryDate: firebase.firestore.FieldValue.delete()
            });
            
            // Track which classes need student count updates
            if (studentData.classId) {
                const currentCount = classUpdates.get(studentData.classId) || 0;
                classUpdates.set(studentData.classId, currentCount + 1);
            }
        });
        
        // Update class student counts
        for (const [classId, decrementBy] of classUpdates.entries()) {
            const classRef = db.collection('classes').doc(classId);
            batch.update(classRef, {
                studentCount: firebase.firestore.FieldValue.increment(-decrementBy)
            });
        }
        
        await batch.commit();
        console.log(`‚úÖ Removed ${expiredStudentsSnapshot.size} expired students from classes`);
        
    } catch (error) {
        console.error('‚ùå Error checking expired students:', error);
        // Don't throw - we don't want to block login if this fails
    }
}


async function removeGuardianStudent(studentId, studentName) {
    if (!confirm(`Remove ${studentName} from your students list?\n\nThis will unlink them from your account.`)) {
        return;
    }
    try {
        await db.collection('users').doc(studentId).update({
            guardianId: firebase.firestore.FieldValue.delete(),
            guardianName: firebase.firestore.FieldValue.delete(),
            guardianEmail: firebase.firestore.FieldValue.delete(),
            hasGuardian: false,
            bookingEnabled: false,
            bookingExpiry: firebase.firestore.FieldValue.delete()
        });
        alert(`‚úÖ ${studentName} has been removed from your students list.`);
        await loadGuardianStudents();
    } catch (error) {
        console.error('Error removing student:', error);
        alert('Failed to remove student: ' + error.message);
    }
}
    </script>
</body>
</html>

