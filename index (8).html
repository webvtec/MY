
<body>
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
     <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">
        <div class="sidebar-user-info" id="sidebarUserInfo">
            <div class="user-avatar" id="sidebarUserAvatar" style="background-image: none; background-size: cover; background-position: center;">?</div>
            <span id="sidebarUserName">Guest</span>
            <button class="my-profile-btn" id="myProfileBtn" onclick="goToUserDashboard()" style="display: none;">
                üë§ MY PROFILE
            </button>
        </div>
    </div>
    <div class="sidebar-item sidebar-item-home" onclick="navigateTo('home')">HOME</div>
    <div class="sidebar-item" onclick="navigateTo('word-database')">WORD DATABASE</div>
    <div class="sidebar-item" onclick="navigateTo('coaches')">BOOK COACHES</div>
    <div class="sidebar-item" onclick="navigateTo('students')">OUR STUDENTS</div>
    <div class="sidebar-item" onclick="()">CONTACT US</div>
    <div class="sidebar-item" onclick="navigateTo('about')">ABOUT US</div>
    <div class="sidebar-item" id="admin-nav-link" onclick="navigateTo('admin')" style="display: none;">ADMIN PANEL</div>
    <div class="sidebar-item sign-in" id="sidebar-signin" onclick="showAuthModal()">SIGN IN</div>
    <div class="sidebar-item" id="sidebar-signout" style="display:none;" onclick="signOut()">SIGN OUT</div>
</div>
</div>



  <!-- Admin Panel Section -->
<div id="admin-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2>‚öôÔ∏è ADMIN PANEL</h2>
            <p style="color: #666; margin-top: 10px;">Tournament Management System</p>
        </div>
        
        <div id="admin-container">
            <!-- Admin content will be loaded here -->
        </div>
    </div>
</div>
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        
// ===== PAYPAL CONFIGURATION =====
const PAYPAL_HANDLER_URL = 'https://verificationpaypalpayment-998744778737.us-central1.run.app';
const REOPEN_ACCOUNT_COST = 6.50;
const REOPEN_DAYS = 30;

let paypalButtonRendered = false;
let sponsorPaypalRendered = false;
let currentChildData = null;

        

        let paypalSDKLoaded = false;

async function loadPayPalSDK() {
    if (paypalSDKLoaded) {
        return Promise.resolve();
    }
    
    try {
        // Get client ID from Firebase function
        const response = await fetch(`${PAYPAL_HANDLER_URL}?action=getClientId`);
        const data = await response.json();
        
        if (!data.success || !data.clientId) {
            throw new Error('Failed to get PayPal client ID');
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${data.clientId}&currency=USD&locale=en_US`;
            script.async = true;
            
            script.onload = () => {
                paypalSDKLoaded = true;
                console.log('‚úÖ PayPal SDK loaded');
                resolve();
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load PayPal SDK'));
            };
            
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading PayPal SDK:', error);
        throw error;
    }
}
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // ‚úÖ NEW: Track declined challenges
let presenceInitialized = false; // ‚úÖ NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// ‚úÖ Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;


// ===== TOURNAMENT VARIABLES =====
let currentTournament = null;
let tournamentStage = 0;
let stage1Questions = [];
let stage1CurrentIndex = 0;
let stage1Score = 0;
let stage1Errors = 0;
let stage1Handicaps = 2;
let stage1TimeLeft = 600; // 10 minutes in seconds
let stage1Timer = null;



// ===== STAGE 2: AI AUDIO SPELLING =====
let stage2Words = [];
let stage2CurrentIndex = 0;
let stage2Score = 0;
let stage2Errors = 0;
let stage2TimeLeft = 900; // 15 minutes
let stage2Timer = null;
let stage2HandicapsRemaining = 1; // Base 1 + carried from Stage 1


   // ===== TOURNAMENT STAGE 3 FUNCTIONS =====
let stage3Words = [];
let stage3CurrentIndex = 0;
let stage3Score = 0;
let stage3Errors = 0;
let stage3TimeLeft = 900; // 15 minutes
let stage3Timer = null;
let stage3HandicapsRemaining = 0;
let stage3CurrentLetterOrder = [];
let stage3DraggedElement = null; 

 // ===== LIVE SPELL MASTER STAGES (4-7) =====
let liveStageParticipants = [];
let currentLiveStageIndex = 0;
let liveStageTimer = null;
let callerMode = false; // true if user is the caller
let liveStageWords = [];
let eliminatedPlayers = [];
let currentSpellerIndex = 0;
let finalRoundSpelling = null;

        
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // ‚úÖ Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // ‚úÖ ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // √¢≈ì‚Ä¶ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });
    
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        console.log('üë§ User signed in:', user.email);
        console.log('üñºÔ∏è Auth photoURL:', user.photoURL);
        
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        console.log('üìÑ Firestore photoURL:', userData.photoURL);
        
        if (user.photoURL && !userData.photoURL) {
            console.log('üîÑ Syncing photoURL to Firestore...');
            await userRef.update({
                photoURL: user.photoURL
            });
            console.log('‚úÖ PhotoURL synced!');
        }
        
        // ‚úÖ INITIALIZE SPELLING STATS IF NOT EXISTS
        if (!userData.spellingStats) {
            console.log('üîÑ Initializing spelling stats...');
            await userRef.update({
                spellingStats: {
                    totalChallenges: 0,
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    winStreak: 0,
                    bestStreak: 0
                }
            });
            console.log('‚úÖ Spelling stats initialized!');
        }
        
        // ‚úÖ CHECK ADMIN STATUS HERE (when user is signed in)
        await checkAdminStatus();
        
        // ‚úÖ CHECK USER TYPE AND HANDLE ACCORDINGLY
        if (userData.userType === 'parent') {
            // Parent user - no profile completion needed
            if (!userData.profileComplete) {
                await userRef.update({ profileComplete: true });
            }
            updateUIForAuthenticatedUser(user);
            
            // Navigate to parent dashboard
            navigateTo('parent-dashboard');
            return;
        }
        
        // STUDENT/COACH HANDLING
        if (!userData.profileComplete) {
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // ‚úÖ LOAD USER COINS (for students only)
        if (userData.userType === 'student') {
            await loadUserCoins(user.uid);
            await checkSubscriptionStatus();
        }
        
        await cleanupInvalidFavorites();
        
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // ‚úÖ Initialize presence immediately on login (only for students/coaches)
        if (userData.userType !== 'parent') {
            await initializeOnlinePresence();
        }
        
        // Load appropriate dashboard
        if (userData.userType === 'student') {
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        }
    } else {
        currentUser = null;
        isAdmin = false; // ‚úÖ Reset admin status when signed out
        updateUIForGuestUser();
        // ‚úÖ Update UI to hide admin link
        updateAdminUI();
    }
});
    });
        
        
    
// ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // ‚úÖ CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'parent-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // ‚úÖ ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard' || section === 'parent-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // ‚úÖ PREVENT PARENTS FROM ACCESSING STUDENT FEATURES
    if (currentUser && section !== 'parent-dashboard' && section !== 'home' && section !== 'about' && section !== 'coaches' && section !== 'students') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'parent') {
                alert('‚ö†Ô∏è Parents can only access:\n‚Ä¢ Parent Dashboard\n‚Ä¢ Home\n‚Ä¢ About\n‚Ä¢ Coaches\n‚Ä¢ Students\n\nPlease use the Parent Dashboard to manage your child\'s account.');
                navigateTo('parent-dashboard');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // ‚úÖ Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // ‚úÖ RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // ‚úÖ Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // ‚úÖ Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // ‚úÖ Load student dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    // ‚úÖ Load parent dashboard when navigating to it
    if (section === 'parent-dashboard' && currentUser) {
        await loadParentDashboard();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }

    // Inside navigateTo function, add:
if (section === 'admin' && currentUser) {
    await loadAdminPanel();
}
}
        
       function toggleSidebar(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (forceClose) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }

        // ===== INITIALIZE ALPHABET =====
        function initializeAlphabet() {
            const alphabetNav = document.getElementById('alphabetNav');
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            
            letters.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = letter;
                btn.onclick = () => filterByLetter(letter);
                alphabetNav.appendChild(btn);
            });
        }

        
// New function to load level-specific words
async function loadLevelWords(level) {
    try {
        document.getElementById('statusMessage').innerHTML = 
            `‚è≥ Loading ${level.toUpperCase()} level words... Please wait.`;
        
        // Check if already loaded
        if (levelWords[level].length > 0) {
            allWords = levelWords[level];
            document.getElementById('statusMessage').innerHTML = 
                `‚úÖ ${allWords.length.toLocaleString()} ${level.toUpperCase()} words loaded! Select a letter to filter or search for specific words.`;
            return Promise.resolve();
        }
        
        const googleDocsUrl = LEVEL_DOCS[level];
        const response = await fetch(googleDocsUrl);

        if (!response.ok) throw new Error('Failed to load words');
        
        const text = await response.text();
        const words = text.split(/[\n\r\s,]+/)
            .map(word => word.trim().toLowerCase())
            .filter(word => word.length > 0 && /^[a-z]+$/.test(word))
            .sort(); // Sort alphabetically
        
        // Cache the words
        levelWords[level] = words;
        allWords = words;
        
        console.log(`Loaded ${words.length} ${level} words`);
        
        document.getElementById('statusMessage').innerHTML = 
            `‚úÖ ${words.length.toLocaleString()} ${level.toUpperCase()} words loaded! Select a letter to filter or search for specific words.`;
        
        return Promise.resolve();
    } catch (error) {
        console.error(`Error loading ${level} words:`, error);
        document.getElementById('statusMessage').innerHTML = 
            `‚ùå Error loading ${level} words. Please try again.`;
        return Promise.reject(error);
    }
}

        // Load a specific level
async function loadLevel(level) {
    currentLevel = level;
    
    // Hide level selection
    document.getElementById('level-selection').style.display = 'none';
    document.getElementById('word-database-display').style.display = 'block';
    
    // Update title
    const levelNames = {
        foundation: 'LEVEL 1: FOUNDATION',
        challenge: 'LEVEL 2: CHALLENGE',
        advanced: 'LEVEL 3: ADVANCED',
        championship: 'LEVEL 4: CHAMPIONSHIP'
    };
    document.getElementById('current-level-title').textContent = `üìö ${levelNames[level]}`;
    
    // Load words for this level
    await loadLevelWords(level);
    
    // Display first 100 words
    displayWords(allWords.slice(0, 100));
}

// Back to level selection
function backToLevelSelection() {
    document.getElementById('level-selection').style.display = 'block';
    document.getElementById('word-database-display').style.display = 'none';
    document.getElementById('wordList').innerHTML = '<div class="loading">Select a level to load words</div>';
    
    // Clear active letter
    document.querySelectorAll('.letter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    currentLetter = '';
}

        
        // ===== FILTER BY LETTER =====
        function filterByLetter(letter) {
            currentLetter = letter;
            
            document.querySelectorAll('.letter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === letter) {
                    btn.classList.add('active');
                }
            });

            const filteredWords = allWords.filter(word => 
                word.toLowerCase().startsWith(letter.toLowerCase())
            );

            displayWords(filteredWords);
        }

         // ===== SEARCH WORD =====
        function searchWord() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                alert('Please enter a word to search');
                return;
            }

            const exactMatch = allWords.find(word => word.toLowerCase() === searchTerm);
            
            if (exactMatch) {
                showWordDetail(exactMatch);
            } else {
                const partialMatches = allWords.filter(word => 
                    word.toLowerCase().includes(searchTerm)
                );

                if (partialMatches.length > 0) {
                    displayWords(partialMatches);
                } else {
                    alert(`No words found matching "${searchTerm}"`);
                }
            }
        }

        // ===== DISPLAY WORDS =====
function displayWords(words) {
    const wordList = document.getElementById('wordList');
    
    if (words.length === 0) {
        wordList.innerHTML = '<div class="loading">No words found</div>';
        return;
    }

    wordList.innerHTML = words.map(word => `
        <div class="word-card" onclick="loadPhoneticAndShowDetail('${word}', this)">
            <div class="word-title">
                <span>${word}</span>
                <div class="word-actions">
                    <button class="icon-btn" onclick="event.stopPropagation(); speakWordQuick('${word}')">üîä</button>
                </div>
            </div>
            <div class="word-phonetic-preview" data-word="${word}"></div>
            <div class="word-definition">Click to see AI-powered definition with synonyms & antonyms</div>
        </div>
    `).join('');

    // After rendering, load phonetics for all visible words
    setTimeout(() => loadPhoneticForVisibleWords(), 100);
}
        
       async function loadPhoneticAndShowDetail(word, cardElement) {
    const phoneticDiv = cardElement.querySelector('.word-phonetic-preview');
    
    // Check if phonetic is already loaded and cached
    if (phoneticDiv.textContent && phoneticDiv.textContent !== '' && phoneticDiv.textContent !== 'Loading pronunciation...') {
        // Already loaded from cache, just show the detail
        showWordDetail(word);
        return;
    }
    
    // Show loading state
    phoneticDiv.textContent = 'Loading pronunciation...';
    phoneticDiv.style.color = '#999';
    
    try {
        // Check Firestore cache first
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let phonetic = '';
        
        if (wordDoc.exists && wordDoc.data().phonetic) {
            phonetic = wordDoc.data().phonetic;
        } else {
            // Fetch from API
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: word } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.phonetic) {
                    phonetic = data.result.phonetic;
                }
            }
        }
        
        // Update the phonetic display
       if (phonetic) {
    // Replace slashes with brackets
    const formattedPhonetic = phonetic.replace(/\//g, '');
    phoneticDiv.innerHTML = `<strong>(${formattedPhonetic})</strong>`;
    phoneticDiv.style.color = '#000';
}
        else {
            phoneticDiv.textContent = ''; // Hide if no phonetic available
        }
    } catch (error) {
        console.error('Error loading phonetic:', error);
        phoneticDiv.textContent = ''; // Hide on error
    }
    
    // Now show the full detail modal
    showWordDetail(word);
}

async function loadPhoneticForVisibleWords() {
    const phoneticDivs = document.querySelectorAll('.word-phonetic-preview');
    
    for (const phoneticDiv of phoneticDivs) {
        const word = phoneticDiv.getAttribute('data-word');
        
        // Skip if already loaded
        if (phoneticDiv.textContent && phoneticDiv.textContent !== '') {
            continue;
        }
        
        try {
            // Check Firestore cache
            const wordRef = db.collection('dictionary').doc(word.toLowerCase());
            const wordDoc = await wordRef.get();
            
            if (wordDoc.exists && wordDoc.data().phonetic) {
    // Found in cache - display immediately
    const formattedPhonetic = wordDoc.data().phonetic.replace(/\//g, '');
    phoneticDiv.innerHTML = `<strong>(${formattedPhonetic})</strong>`;
    phoneticDiv.style.color = '#000';
}
            // If not in cache, leave blank (will load when clicked)
        } catch (error) {
            console.error('Error loading phonetic for', word, error);
        }
    }
}
        
        // ===== SHOW WORD DETAIL (CALL CLOUD FUNCTION) =====
       async function showWordDetail(word) {
    currentWord = word;
    
    const modal = document.getElementById('wordModal');
    document.getElementById('modalWord').textContent = word;
    document.getElementById('modalPhonetic').textContent = 'Loading...';
    document.getElementById('modalContent').innerHTML = '<div class="loading">üìö Loading definition...</div>';
    
    modal.classList.add('active');

    try {
        // Step 1: Check if word exists in Firestore cache
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
       if (wordDoc.exists) {
    // Word found in cache - use it (NO API CALL = FREE!)
    console.log('‚úÖ Found in cache - no API call needed!');
    const cachedData = wordDoc.data();
    
    // Check if origin is missing and fetch it
    if (!cachedData.origin) {
        console.log('‚ö†Ô∏è Origin missing - fetching from API...');
        try {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: word } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.origin) {
                    // Update Firestore with origin
                    await wordRef.update({
                        origin: data.result.origin
                    });
                    cachedData.origin = data.result.origin;
                    console.log('‚úÖ Origin fetched and saved!');
                }
            }
        } catch (error) {
            console.error('Error fetching origin:', error);
        }
    }
    
    displayWordDetails(cachedData);
}
       else {
            // Step 2: Word NOT in cache - fetch from API (COSTS MONEY)
            console.log('‚ö†Ô∏è Not in cache - calling paid API...');
            console.log('API URL:', CLOUD_FUNCTION_URL);
            console.log('Request payload:', { data: { word: word } });
            
            document.getElementById('modalContent').innerHTML = '<div class="loading">ü§ñ Fetching from paid API (first time)...</div>';
            
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ data: { word: word } })
            });

            console.log('Response Status:', response.status);
            console.log('Response OK:', response.ok);
            console.log('Response Headers:', [...response.headers.entries()]);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error Response Body:', errorText);
                throw new Error(`API Error (${response.status}): ${errorText || response.statusText}`);
            }

            const data = await response.json();
            console.log('Response Data:', data);
            
            if (data.result) {
                // Step 3: Store in Firestore for future use
                await wordRef.set({
                    ...data.result,
                    word: word.toLowerCase(),
                    cachedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Saved to Firestore cache!');
                
                displayWordDetails(data.result);
            } else {
                throw new Error('No definition found in API response');
            }
        }
    } catch (error) {
        console.error('‚ùå FULL ERROR:', error);
        console.error('Error Type:', error.constructor.name);
        console.error('Error Stack:', error.stack);
        
        let errorDetails = '';
        
        // Detailed error categorization
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
            errorDetails = `
                <strong>üî¥ Network/CORS Error:</strong><br><br>
                <strong>Possible causes:</strong><br>
                1. Cloud Function not deployed or not accessible<br>
                2. CORS not configured on Cloud Function<br>
                3. Function URL incorrect<br>
                4. Network connectivity issue<br><br>
                
                <strong>Your Function URL:</strong><br>
                <code style="background: #f0f0f0; padding: 5px; display: block; word-break: break-all;">
                    ${CLOUD_FUNCTION_URL}
                </code><br>
                
                <strong>To fix:</strong><br>
                ‚Ä¢ Go to Google Cloud Console<br>
                ‚Ä¢ Find your Cloud Function<br>
                ‚Ä¢ Add CORS headers in your function code:<br>
                <code style="background: #f0f0f0; padding: 10px; display: block; margin-top: 5px;">
                res.set('Access-Control-Allow-Origin', '*');<br>
                res.set('Access-Control-Allow-Methods', 'POST');<br>
                res.set('Access-Control-Allow-Headers', 'Content-Type');
                </code>
            `;
        } else if (error.message.includes('API Error')) {
            errorDetails = `
                <strong>üî¥ API Response Error:</strong><br><br>
                ${error.message}<br><br>
                <strong>What this means:</strong><br>
                The Cloud Function responded but with an error status.<br>
                Check the Cloud Function logs in Google Cloud Console.
            `;
        } else if (error.message.includes('No definition found')) {
            errorDetails = `
                <strong>üî¥ Definition Not Available:</strong><br><br>
                The API returned successfully but didn't include a definition.<br>
                The word "${word}" might not be in the dictionary API.
            `;
        } else {
            errorDetails = `
                <strong>üî¥ Unexpected Error:</strong><br><br>
                <strong>Error Message:</strong><br>
                ${error.message}<br><br>
                <strong>Error Type:</strong> ${error.constructor.name}
            `;
        }
        
        document.getElementById('modalContent').innerHTML = `
            <div class="word-definition">
                <strong>Word:</strong> ${word}<br><br>
                ‚ùå <strong>Unable to fetch definition</strong><br><br>
                ${errorDetails}<br><br>
                <details style="margin-top: 20px; background: #f9f9f9; padding: 10px; border-radius: 5px;">
                    <summary style="cursor: pointer; font-weight: bold;">üîß Technical Details (for debugging)</summary>
                    <pre style="overflow-x: auto; font-size: 0.85rem; margin-top: 10px;">${JSON.stringify({
                        errorMessage: error.message,
                        errorType: error.constructor.name,
                        stack: error.stack
                    }, null, 2)}</pre>
                </details>
                <hr style="margin: 20px 0; border: 1px solid #ddd;">
                You can still practice pronunciation using the buttons below.
            </div>
        `;
        document.getElementById('modalPhonetic').textContent = '';
    }
}

function displayWordDetails(wordData) {
    const phonetic = wordData.phonetic || '';
    document.getElementById('modalPhonetic').textContent = phonetic;

    let html = '';

    // ‚úÖ SHOW SIMPLE ORIGIN
    if (wordData.origin) {
        const simpleOrigin = cleanOriginText(wordData.origin);
        
        html += `
            <div style="margin-bottom: 25px; padding: 12px 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                <strong style="color: #856404; font-size: 1rem;">üìú Origin:</strong>
                <span style="color: #856404; margin-left: 10px; font-size: 1rem;">${simpleOrigin}</span>
            </div>
        `;
    }

    // Rest of the function stays the same...
    if (wordData.meanings && wordData.meanings.length > 0) {
        wordData.meanings.forEach((meaning, index) => {
            html += `
                <div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <span class="word-pos">${meaning.partOfSpeech}</span>
                    
                    <div class="word-definition" style="margin-top: 15px;">
                        <strong>Definition:</strong> ${meaning.definition}
                    </div>
            `;

            if (meaning.example) {
                html += `
                    <div class="word-example">
                        <strong>Example:</strong> "${meaning.example}"
                    </div>
                `;
            }

            if (meaning.synonyms && meaning.synonyms.length > 0) {
                html += `
                    <div style="margin-top: 15px;">
                        <strong style="color: #0d3b66;">üìö Synonyms:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${meaning.synonyms.map(syn => `
                                <span style="background: #e3f2fd; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem;">
                                    ${syn}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (meaning.antonyms && meaning.antonyms.length > 0) {
                html += `
                    <div style="margin-top: 15px;">
                        <strong style="color: #0d3b66;">üîÑ Antonyms:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${meaning.antonyms.map(ant => `
                                <span style="background: #ffebee; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem;">
                                    ${ant}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
        });
    } else {
        html = `
            <div class="word-definition">
                <strong>Word:</strong> ${currentWord}<br><br>
                Loading definition...<br>
                You can practice pronunciation using the buttons below.
            </div>
        `;
    }

    document.getElementById('modalContent').innerHTML = html;
}

        // Helper function to clean and shorten origin text
function cleanOriginText(origin) {
    if (!origin) return '';
    
    let cleaned = origin.toLowerCase();
    
    // Extract common language origins
    const languagePatterns = [
        /\b(old english|middle english|modern english|english)\b/i,
        /\b(latin|classical latin|late latin|medieval latin)\b/i,
        /\b(greek|ancient greek|classical greek)\b/i,
        /\b(french|old french|middle french|anglo-french)\b/i,
        /\b(german|old german|middle high german)\b/i,
        /\b(spanish|old spanish)\b/i,
        /\b(italian)\b/i,
        /\b(dutch|old dutch)\b/i,
        /\b(norse|old norse)\b/i,
        /\b(sanskrit)\b/i,
        /\b(hebrew|ancient hebrew)\b/i,
        /\b(arabic|classical arabic)\b/i,
        /\b(persian)\b/i,
        /\b(chinese|mandarin)\b/i,
        /\b(japanese)\b/i,
        /\b(portuguese)\b/i,
        /\b(russian)\b/i,
        /\b(celtic|gaelic|irish)\b/i,
        /\b(proto-germanic|proto-indo-european)\b/i
    ];
    
    // Try to find a language match
    for (let pattern of languagePatterns) {
        const match = cleaned.match(pattern);
        if (match) {
            // Capitalize first letter of each word
            return match[0].split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
    }
    
    // If no specific language found, extract first few words before comma or period
    const shortOrigin = origin.split(/[,.(]/)[0].trim();
    if (shortOrigin.length < 50) {
        return shortOrigin.charAt(0).toUpperCase() + shortOrigin.slice(1);
    }
    
    // Fallback: return first 30 characters
    return origin.substring(0, 30).trim() + '...';
}

        
// ‚≠ê NEW HELPER FUNCTION - Fetch word details with origin
async function fetchWordDetails(word) {
    try {
        // Check Firestore cache first
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();

        if (wordDoc.exists) {
            const data = wordDoc.data();
            
            // Clean the origin if it exists and is too long
            let cleanedOrigin = data.origin;
            if (cleanedOrigin && cleanedOrigin.length > 150) {
                cleanedOrigin = cleanOriginText(cleanedOrigin);
                
                // Update Firestore with cleaned origin
                await wordRef.update({ origin: cleanedOrigin });
            }
            
            return {
                phonetic: data.phonetic || '',
                origin: cleanedOrigin || null,
                definition: data.meanings?.[0]?.definition || ''
            };
        }

        // If not in cache, fetch from Cloud Run
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { word: word } })
        });

        if (!response.ok) {
            throw new Error('Failed to fetch word details');
        }

        const data = await response.json();
        
        if (data.result) {
            // Clean the origin before caching
            let cleanedOrigin = data.result.origin;
            if (cleanedOrigin) {
                cleanedOrigin = cleanOriginText(cleanedOrigin);
            }
            
            // Cache it with cleaned origin
            await wordRef.set({
                ...data.result,
                origin: cleanedOrigin,
                word: word.toLowerCase(),
                cachedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            return {
                phonetic: data.result.phonetic || '',
                origin: cleanedOrigin || null,
                definition: data.result.meanings?.[0]?.definition || ''
            };
        }

        return {};
    } catch (error) {
        console.error('Error fetching word details:', error);
        return {};
    }
}
        

        // ===== CLOSE MODAL =====
        function closeModal() {
            document.getElementById('wordModal').classList.remove('active');
            document.getElementById('practiceFeedback').innerHTML = '';
        }

        // ===== TEXT-TO-SPEECH =====
        function speakWord() {
            if (!currentWord) return;
            
            const utterance = new SpeechSynthesisUtterance(currentWord);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 2;
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        function speakWordQuick(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        // ===== SPEECH RECOGNITION =====
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    checkPronunciation(transcript);
                };

                recognition.onerror = function(event) {
                    isListening = false;
                    document.getElementById('practiceBtn').classList.remove('listening');
                    document.getElementById('practiceFeedback').innerHTML = `
                        <div class="feedback error">
                            ‚ùå Error: ${event.error}. Please try again.
                        </div>
                    `;
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('practiceBtn').classList.remove('listening');
                    document.getElementById('practiceBtn').textContent = 'üé§ Practice Speaking';
                };
            }
        }

        // ===== START PRACTICE =====
        function startPractice() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            if (isListening) {
                recognition.stop();
                return;
            }

            isListening = true;
            document.getElementById('practiceBtn').classList.add('listening');
            document.getElementById('practiceBtn').textContent = 'üé§ Listening...';
            document.getElementById('practiceFeedback').innerHTML = '<div class="feedback">Speak now...</div>';

            try {
                recognition.start();
            } catch (error) {
                console.error('Recognition start error:', error);
                isListening = false;
                document.getElementById('practiceBtn').classList.remove('listening');
            }
        }

        // ===== CHECK PRONUNCIATION =====
        function checkPronunciation(spokenWord) {
            const correctWord = currentWord.toLowerCase();
            const feedbackDiv = document.getElementById('practiceFeedback');
            
            const cleanSpoken = spokenWord.replace(/[^\w\s]/gi, '').trim();
            const cleanCorrect = correctWord.replace(/[^\w\s]/gi, '').trim();

            if (cleanSpoken === cleanCorrect) {
                feedbackDiv.innerHTML = `
                    <div class="feedback success">
                        ‚úÖ Perfect! You said: "${spokenWord}"<br>
                        Accuracy: 100%
                    </div>
                `;
                return;
            }

            const similarity = calculateSimilarity(cleanSpoken, cleanCorrect);
            
            if (similarity > 0.6) {
                feedbackDiv.innerHTML = `
                    <div class="feedback success">
                        ‚úÖ Good effort! You said: "${spokenWord}"<br>
                        Expected: "${correctWord}"<br>
                        Accuracy: ${Math.round(similarity * 100)}%
                    </div>
                `;
            } else {
                feedbackDiv.innerHTML = `
                    <div class="feedback error">
                        ‚ùå Not quite. You said: "${spokenWord}"<br>
                        Expected: "${correctWord}"<br>
                        Try again!
                    </div>
                `;
            }
        }

        // ===== CALCULATE SIMILARITY =====
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = getEditDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function getEditDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

       // ===== AUTHENTICATION FUNCTIONS =====
function showAuthModal() {
    document.getElementById('authModal').classList.add('active');
}

function closeAuthModal() {
    document.getElementById('authModal').classList.remove('active');
    document.getElementById('signin-error').style.display = 'none';
    
    // Hide all signup forms and show selection
    document.getElementById('signup-selection').style.display = 'none';
    document.getElementById('signup-student-form').style.display = 'none';
    document.getElementById('signup-coach-form').style.display = 'none';
    document.getElementById('signup-organization-form').style.display = 'none';
    
    // Clear all error messages
    document.querySelectorAll('.feedback.error').forEach(el => el.style.display = 'none');
}

function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => {
        f.classList.remove('active');
        f.style.display = 'none'; // Force hide all forms
    });
    
    if (tab === 'signin') {
        document.querySelector('.auth-tab:first-child').classList.add('active');
        document.getElementById('signin-form').classList.add('active');
        document.getElementById('signin-form').style.display = 'block';
        
        // Hide all signup forms
        document.getElementById('signup-selection').style.display = 'none';
        document.getElementById('signup-student-form').style.display = 'none';
        document.getElementById('signup-coach-form').style.display = 'none';
        document.getElementById('signup-organization-form').style.display = 'none';
    } else {
        document.querySelector('.auth-tab:last-child').classList.add('active');
        document.getElementById('signup-selection').classList.add('active');
        document.getElementById('signup-selection').style.display = 'block';
        
        // Hide signin form
        document.getElementById('signin-form').style.display = 'none';
    }
}

function showSignUpForm(userType) {
    // Hide selection screen
    document.getElementById('signup-selection').style.display = 'none';
    
    // Show appropriate form
    if (userType === 'student') {
        document.getElementById('signup-student-form').style.display = 'block';
    } else if (userType === 'parent') {
        document.getElementById('signup-parent-form').style.display = 'block';
    } else if (userType === 'coach') {
        document.getElementById('signup-coach-form').style.display = 'block';
    } else if (userType === 'organization') {
        document.getElementById('signup-organization-form').style.display = 'block';
    }
}

function backToUserTypeSelection() {
    // Hide all forms
    document.getElementById('signup-student-form').style.display = 'none';
    document.getElementById('signup-parent-form').style.display = 'none';
    document.getElementById('signup-coach-form').style.display = 'none';
    document.getElementById('signup-organization-form').style.display = 'none';
    
    // Show selection
    document.getElementById('signup-selection').style.display = 'block';
}
        
async function handleSignIn(event) {
    event.preventDefault();
    const email = document.getElementById('signin-email').value;
    const password = document.getElementById('signin-password').value;
    const errorDiv = document.getElementById('signin-error');

    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Check if user document exists in Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
            // User signed in but no profile exists - sign them out
            await auth.signOut();
            errorDiv.textContent = 'No account found with this email. Please sign up first.';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check if profile is complete
        const userData = userDoc.data();
        if (!userData.profileComplete) {
            // Show verification modal
            closeAuthModal();
            showVerificationModal(userData);
            return;
        }
        
        closeAuthModal();
        errorDiv.style.display = 'none';
    } catch (error) {
        if (error.code === 'auth/user-not-found') {
            errorDiv.textContent = 'No account found with this email. Please sign up first.';
        } else if (error.code === 'auth/wrong-password') {
            errorDiv.textContent = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
            errorDiv.textContent = 'Invalid email address.';
        } else {
            errorDiv.textContent = error.message;
        }
        errorDiv.style.display = 'block';
    }
}

async function handleSignUp(event, userType) {
    event.preventDefault();
    
    let name, email, password, errorDiv;
    let additionalData = { 
        userType: userType,
        profileComplete: false // Mark as incomplete
    };
    
    if (userType === 'student') {
        name = document.getElementById('signup-student-name').value;
        email = document.getElementById('signup-student-email').value;
        password = document.getElementById('signup-student-password').value;
        errorDiv = document.getElementById('signup-student-error');
        additionalData.age = document.getElementById('signup-student-age').value;
        additionalData.country = document.getElementById('signup-student-country').value;
        
        // For students, if they provided age and country, mark complete
        if (additionalData.age && additionalData.country) {
            additionalData.profileComplete = true;
        }
    } else if (userType === 'coach') {
        name = document.getElementById('signup-coach-name').value;
        email = document.getElementById('signup-coach-email').value;
        password = document.getElementById('signup-coach-password').value;
        errorDiv = document.getElementById('signup-coach-error');
        additionalData.organization = document.getElementById('signup-coach-organization').value;
        additionalData.profileComplete = true; // Coaches don't need extra verification
    } else if (userType === 'organization') {
        name = document.getElementById('signup-org-name').value;
        email = document.getElementById('signup-org-email').value;
        password = document.getElementById('signup-org-password').value;
        errorDiv = document.getElementById('signup-org-error');
        additionalData.phone = document.getElementById('signup-org-phone').value;
        additionalData.address = document.getElementById('signup-org-address').value;
        additionalData.profileComplete = true; // Organizations don't need extra verification
    }

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: name });
        
        // ‚úÖ GENERATE STUDENT ID FOR STUDENTS
        if (userType === 'student') {
            additionalData.studentId = generateStudentId(userCredential.user.uid);
            console.log('‚úÖ Generated Student ID:', additionalData.studentId);
        }
        
        await db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            ...additionalData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        closeAuthModal();
        errorDiv.style.display = 'none';
        
        // If profile not complete, show verification modal
        if (!additionalData.profileComplete) {
            showVerificationModal({ name, email, userType });
        } else {
            if (userType === 'student') {
                alert(`Welcome, ${name}! Your student account has been created successfully.\n\nYour Student ID: ${additionalData.studentId}\n\nPlease save this ID - your parent will need it to link their account.`);
            } else {
                alert(`Welcome, ${name}! Your ${userType} account has been created successfully.`);
            }
        }
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}
        
function signOut() {
    // Remove online presence before signing out
    removeOnlinePresence();
    
    // ‚úÖ CLEAR DECLINED CHALLENGES
    declinedChallengeIds.clear();
    shownPopupIds.clear();
    shownQuizPopupIds.clear();
    
    // Sign out from Firebase
    auth.signOut();
    
    // Navigate to home
    navigateTo('home');
}

async function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // Check if user document exists
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            // ‚úÖ NOW SAVING photoURL
            await userRef.set({
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL || null, // ‚úÖ ADD THIS
                userType: 'student',
                profileComplete: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            closeAuthModal();
            showVerificationModal({
                name: user.displayName,
                email: user.email,
                userType: 'student'
            });
        } else {
            // Existing user - check if profile is complete
            const userData = userDoc.data();
            if (!userData.profileComplete) {
                closeAuthModal();
                showVerificationModal(userData);
            } else {
                closeAuthModal();
            }
        }
    } catch (error) {
        console.error('Google sign-in error:', error);
        document.getElementById('signin-error').textContent = error.message;
        document.getElementById('signin-error').style.display = 'block';
    }
}
        
async function signUpWithGoogle(userType) {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        const userRef = db.collection('users').doc(user.uid);
        
        // ‚úÖ Generate student ID if signing up as student
        const userData = {
            name: user.displayName,
            email: user.email,
            photoURL: user.photoURL || null,
            userType: userType,
            profileComplete: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (userType === 'student') {
            userData.studentId = generateStudentId(user.uid);
        }
        
        await userRef.set(userData);
        
        closeAuthModal();
        showVerificationModal({
            name: user.displayName,
            email: user.email,
            userType: userType
        });
    } catch (error) {
        console.error('Google sign-up error:', error);
        const errorDiv = document.getElementById(`signup-${userType}-error`);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}

        
        // ===== VERIFICATION MODAL FUNCTIONS =====
function showVerificationModal(userData) {
    const modal = document.getElementById('verificationModal');
    
    // Pre-fill any existing data
    if (userData.name) {
        document.getElementById('verify-name').value = userData.name;
    }
    if (userData.age) {
        document.getElementById('verify-age').value = userData.age;
    }
    if (userData.country) {
        document.getElementById('verify-country').value = userData.country;
    }
    
    modal.classList.add('active');
}

function closeVerificationModal() {
    document.getElementById('verificationModal').classList.remove('active');
}

async function handleVerification(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const name = document.getElementById('verify-name').value.trim();
    const age = document.getElementById('verify-age').value;
    const country = document.getElementById('verify-country').value;
    const errorDiv = document.getElementById('verify-error');
    
    if (!name || !age || !country) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (age < 5 || age > 100) {
        errorDiv.textContent = 'Please enter a valid age between 5 and 100.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            name: name,
            age: parseInt(age),
            country: country,
            profileComplete: true
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: name });
        
        errorDiv.style.display = 'none';
        closeVerificationModal();
        
        alert('‚úÖ Profile completed successfully! Welcome to WordBiz Coaching Academy!');
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
    } catch (error) {
        console.error('Error completing profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

        async function signOutAndSwitchAccount() {
    if (confirm('‚ö†Ô∏è Are you sure you want to sign out? You will need to sign in with a different account.')) {
        try {
            // Close verification modal
            closeVerificationModal();
            
            // Sign out the user
            await auth.signOut();
            
            // Reset UI to guest state
            currentUser = null;
            updateUIForGuestUser();
            
            // Navigate to home
            navigateTo('home');
            
            // Show auth modal for them to sign in/up with different account
            setTimeout(() => {
                showAuthModal();
            }, 500);
            
        } catch (error) {
            console.error('Error signing out:', error);
            alert('Failed to sign out: ' + error.message);
        }
    }
}

        // ===== ID VERIFICATION FUNCTIONS =====

function showVerificationModal(userData) {
    const modal = document.getElementById('verificationModal');
    const idSection = document.getElementById('coachIdVerification');
    const completeBtn = document.getElementById('completeProfileBtn');
    
    // Pre-fill any existing data
    if (userData.name) {
        document.getElementById('verify-name').value = userData.name;
    }
    if (userData.age) {
        document.getElementById('verify-age').value = userData.age;
    }
    if (userData.country) {
        document.getElementById('verify-country').value = userData.country;
    }
    
    // Check if this is a coach
    isCoachVerification = (userData.userType === 'coach');
    
    if (isCoachVerification) {
        idSection.classList.add('show');
        completeBtn.textContent = '‚è≥ Upload ID to Continue';
        completeBtn.disabled = true;
    } else {
        idSection.classList.remove('show');
        completeBtn.textContent = '‚úÖ Complete Profile';
        completeBtn.disabled = false;
    }
    
    // Reset ID verification state
    uploadedIDFile = null;
    uploadedIDBase64 = null;
    idVerificationPassed = false;
    document.getElementById('idPreviewContainer').classList.remove('show');
    document.getElementById('idVerificationStatus').classList.remove('show');
    
    modal.classList.add('active');
}

// Handle ID file upload
function handleIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    // Validate file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    uploadedIDFile = file;
    
    // Convert to base64 for preview and API
    const reader = new FileReader();
    reader.onload = function(e) {
        uploadedIDBase64 = e.target.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
        
        // Show preview for images only
        if (file.type.startsWith('image/')) {
            document.getElementById('idPreviewImage').src = e.target.result;
            document.getElementById('idPreviewContainer').classList.add('show');
        } else {
            document.getElementById('idPreviewContainer').classList.remove('show');
        }
        
        // Automatically start verification
        verifyIDWithAI();
    };
    reader.readAsDataURL(file);
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('idUploadArea');
    
    if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('drag-over');
            }, false);
        });
        
        uploadArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                document.getElementById('verify-id-file').files = files;
                handleIDUpload({ target: { files: files } });
            }
        }, false);
    }
});

function changeIDPhoto() {
    document.getElementById('verify-id-file').value = '';
    document.getElementById('idPreviewContainer').classList.remove('show');
    document.getElementById('idVerificationStatus').classList.remove('show');
    uploadedIDFile = null;
    uploadedIDBase64 = null;
    idVerificationPassed = false;
    document.getElementById('completeProfileBtn').disabled = true;
    document.getElementById('completeProfileBtn').textContent = '‚è≥ Upload ID to Continue';
}

// Verify ID using AI
async function verifyIDWithAI() {
    if (!uploadedIDBase64) {
        alert('Please upload an ID first');
        return;
    }
    
    const statusDiv = document.getElementById('idVerificationStatus');
    const completeBtn = document.getElementById('completeProfileBtn');
    const coachName = document.getElementById('verify-name').value.trim();
    const coachAge = document.getElementById('verify-age').value.trim(); // ‚úÖ GET AGE
    
    if (!coachName) {
        alert('Please enter your full name first');
        return;
    }
    
    if (!coachAge) {
        alert('Please enter your age first');
        return;
    }
    
    // Show verifying status
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.innerHTML = `
        <div class="verification-spinner"></div>
        <strong>Verifying your ID...</strong>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    completeBtn.disabled = true;
    completeBtn.textContent = '‚è≥ Verifying ID...';
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: uploadedIDBase64,
                    coachName: coachName,
                    userAge: coachAge, // ‚úÖ SEND AGE
                    userId: currentUser.uid
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        console.log('Verification result:', result);
        
        // ‚úÖ SIMPLIFIED: Check if verification passed
        if (result.verificationPassed) {
            // ‚úÖ SUCCESS - CLEAN MESSAGE
            idVerificationPassed = true;
            statusDiv.className = 'id-verification-status success show';
            statusDiv.innerHTML = `
                <strong>‚úÖ ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Status:</strong> Text is clear and consistent with a standard passport layout.
                </p>
                <p style="margin-top: 10px; font-size: 0.9rem; font-style: italic;">
                    üîí Your ID photo has not been stored. Only verification status is saved.
                </p>
            `;
            
            completeBtn.disabled = false;
            completeBtn.textContent = '‚úÖ COMPLETE PROFILE';
            
            // Store verification result in Firestore
            await db.collection('users').doc(currentUser.uid).update({
                idVerified: true,
                idVerificationDate: firebase.firestore.FieldValue.serverTimestamp(),
                idDocumentType: result.documentType,
                idVerificationConfidence: result.confidence,
                verifiedAge: result.age
            });
            
        } else {
            // ‚úÖ FAILURE - CLEAN MESSAGE
            idVerificationPassed = false;
            statusDiv.className = 'id-verification-status error show';
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${result.reason || 'Unable to verify your ID.'}</p>
                <p style="margin-top: 10px; font-size: 0.9rem;">
                    <strong>Tips for better verification:</strong><br>
                    ‚Ä¢ Ensure good lighting<br>
                    ‚Ä¢ Avoid glare or shadows<br>
                    ‚Ä¢ Make sure all text is readable<br>
                    ‚Ä¢ Use the original, unedited document<br>
                    ‚Ä¢ Ensure the name you typed matches the ID exactly
                </p>
            `;
            
            completeBtn.disabled = true;
            completeBtn.textContent = '‚ùå Upload Valid ID';
        }
        
    } catch (error) {
        console.error('ID Verification Error:', error);
        idVerificationPassed = false;
        statusDiv.className = 'id-verification-status error show';
        statusDiv.innerHTML = `
            <strong>‚ùå Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify your ID. This could be due to:<br>
                ‚Ä¢ Poor image quality<br>
                ‚Ä¢ Network connection issues<br>
                ‚Ä¢ Unsupported document format
            </p>
            <p style="margin-top: 10px;">
                Error details: ${error.message}
            </p>
            <p style="margin-top: 10px; font-weight: bold;">
                Please try uploading a clearer photo of your ID.
            </p>
        `;
        
        completeBtn.disabled = true;
        completeBtn.textContent = '‚ùå Upload Valid ID';
    }
}
        
// Update handleVerification function to include ID check
async function handleVerification(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const name = document.getElementById('verify-name').value.trim();
    const age = document.getElementById('verify-age').value;
    const country = document.getElementById('verify-country').value;
    const errorDiv = document.getElementById('verify-error');
    
    if (!name || !age || !country) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (age < 5 || age > 100) {
        errorDiv.textContent = 'Please enter a valid age between 5 and 100.';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Check if coach needs ID verification
    if (isCoachVerification && !idVerificationPassed) {
        errorDiv.textContent = 'Please upload and verify your government-issued ID to continue.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // ‚úÖ Update Firestore - PRESERVE photoURL
        const updateData = {
            name: name,
            age: parseInt(age),
            country: country,
            profileComplete: true
        };
        
        // Only add photoURL if it exists (don't overwrite with null)
        if (currentUser.photoURL) {
            updateData.photoURL = currentUser.photoURL;
        }
        
        await db.collection('users').doc(currentUser.uid).update(updateData);
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: name });
        
        errorDiv.style.display = 'none';
        closeVerificationModal();
        
        if (isCoachVerification) {
            alert('‚úÖ Profile and ID verification completed successfully! Welcome to WordBiz Coaching Academy!');
        } else {
            alert('‚úÖ Profile completed successfully! Welcome to WordBiz Coaching Academy!');
        }
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
    } catch (error) {
        console.error('Error completing profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}
        


// ===== PARENT ID UPLOAD FUNCTIONS =====
function handleParentIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    parentIDFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        parentIDBase64 = e.target.result.split(',')[1];
        
        if (file.type.startsWith('image/')) {
            document.getElementById('parent-id-preview-image').src = e.target.result;
            document.getElementById('parent-id-preview').style.display = 'block';
        }
        
        verifyParentID();
    };
    reader.readAsDataURL(file);
}

function changeParentID() {
    document.getElementById('parent-id-file').value = '';
    document.getElementById('parent-id-preview').style.display = 'none';
    document.getElementById('parent-id-status').style.display = 'none';
    parentIDFile = null;
    parentIDBase64 = null;
    parentIDVerified = false;
}

async function verifyParentID() {
    if (!parentIDBase64) {
        alert('Please upload parent ID first');
        return;
    }
    
    const statusDiv = document.getElementById('parent-id-status');
    const parentName = document.getElementById('signup-parent-name').value.trim();
    
    if (!parentName) {
        alert('Please enter parent name first');
        return;
    }
    
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#fff3cd';
    statusDiv.style.borderLeft = '4px solid #ffc107';
    statusDiv.style.padding = '15px';
    statusDiv.style.borderRadius = '8px';
    statusDiv.style.color = '#856404';
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="verification-spinner"></div>
            <strong>Verifying parent ID...</strong>
        </div>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: parentIDBase64,
                    coachName: parentName,
                    userId: 'temp-parent-' + Date.now()
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        if (result.isValid && result.isOver16 && !result.documentAppearsTampered) {
            parentIDVerified = true;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderLeft = '4px solid #28a745';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `
                <strong>‚úÖ Parent ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Document:</strong> ${result.documentType}<br>
                    <strong>Name:</strong> ${result.fullName}<br>
                    <strong>Age:</strong> ${result.age} years old
                </p>
            `;
        } else {
            parentIDVerified = false;
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderLeft = '4px solid #dc3545';
            statusDiv.style.color = '#721c24';
            
            let errorMessage = result.reason || 'Verification failed';
            
            if (!result.isValid) {
                errorMessage = '‚ùå Invalid or unrecognized document. Please upload a clear photo of your Driver\'s License, Passport, or National ID.';
            } else if (!result.isOver16) {
                errorMessage = '‚ùå Parent must be at least 16 years old.';
            } else if (result.documentAppearsTampered) {
                errorMessage = '‚ùå Document appears to be altered. Please upload an original, unedited ID.';
            }
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${errorMessage}</p>
            `;
        }
    } catch (error) {
        console.error('Parent ID Verification Error:', error);
        parentIDVerified = false;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.borderLeft = '4px solid #dc3545';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `
            <strong>‚ùå Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify ID. Please ensure:<br>
                ‚Ä¢ Good lighting<br>
                ‚Ä¢ All text is readable<br>
                ‚Ä¢ No glare or shadows
            </p>
        `;
    }
}

// ===== CHILD ID UPLOAD FUNCTIONS =====
function handleChildIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    childIDFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        childIDBase64 = e.target.result.split(',')[1];
        
        if (file.type.startsWith('image/')) {
            document.getElementById('child-id-preview-image').src = e.target.result;
            document.getElementById('child-id-preview').style.display = 'block';
        }
        
        verifyChildID();
    };
    reader.readAsDataURL(file);
}

function changeChildID() {
    document.getElementById('child-id-file').value = '';
    document.getElementById('child-id-preview').style.display = 'none';
    document.getElementById('child-id-status').style.display = 'none';
    childIDFile = null;
    childIDBase64 = null;
    childIDVerified = false;
}

async function verifyChildID() {
    if (!childIDBase64) {
        alert('Please upload child ID first');
        return;
    }
    
    const statusDiv = document.getElementById('child-id-status');
    const childName = document.getElementById('signup-child-name').value.trim();
    
    if (!childName) {
        alert('Please enter child name first');
        return;
    }
    
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#fff3cd';
    statusDiv.style.borderLeft = '4px solid #ffc107';
    statusDiv.style.padding = '15px';
    statusDiv.style.borderRadius = '8px';
    statusDiv.style.color = '#856404';
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="verification-spinner"></div>
            <strong>Verifying child ID...</strong>
        </div>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: childIDBase64,
                    coachName: childName,
                    userId: 'temp-child-' + Date.now()
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        // ‚úÖ ADD: Check if name matches
        const nameMatches = result.fullName && 
            (result.fullName.toLowerCase().includes(childName.toLowerCase().split(' ')[0]) ||
            childName.toLowerCase().includes(result.fullName.toLowerCase().split(' ')[0]));
        
        // For children, we accept any valid document with matching name
        if (result.isValid && !result.documentAppearsTampered && nameMatches) {
            childIDVerified = true;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderLeft = '4px solid #28a745';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `
                <strong>‚úÖ Child ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Document:</strong> ${result.documentType}<br>
                    <strong>Name on ID:</strong> ${result.fullName}<br>
                    <strong>Your Child's Name:</strong> ${childName}
                    ${result.age ? `<br><strong>Age:</strong> ${result.age} years old` : ''}
                </p>
            `;
        } else {
            childIDVerified = false;
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderLeft = '4px solid #dc3545';
            statusDiv.style.color = '#721c24';
            
            let errorMessage = result.reason || 'Verification failed';
            
            if (!result.isValid) {
                errorMessage = '‚ùå Invalid or unrecognized document. Please upload a clear photo of the child\'s Birth Certificate, Student ID, or Government ID.';
            } else if (result.documentAppearsTampered) {
                errorMessage = '‚ùå Document appears to be altered. Please upload an original, unedited ID.';
            } else if (!nameMatches) {
                errorMessage = `‚ùå Name mismatch! The name on the ID (${result.fullName}) does not match the child's name you entered (${childName}).`;
            }
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${errorMessage}</p>
                ${result.fullName ? `<p style="margin-top: 5px;"><strong>Detected Name:</strong> ${result.fullName}</p>` : ''}
            `;
        }
    } catch (error) {
        console.error('Child ID Verification Error:', error);
        childIDVerified = false;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.borderLeft = '4px solid #dc3545';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `
            <strong>‚ùå Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify ID. Please ensure:<br>
                ‚Ä¢ Good lighting<br>
                ‚Ä¢ All text is readable<br>
                ‚Ä¢ No glare or shadows<br>
                ‚Ä¢ Name matches exactly
            </p>
        `;
    }
}

// ===== PARENT SIGN UP HANDLER =====
async function handleParentSignUp(event) {
    event.preventDefault();
    
    const errorDiv = document.getElementById('signup-parent-error');
    
    // Check ID verifications
    if (!parentIDVerified) {
        errorDiv.textContent = '‚ùå Please upload and verify parent ID first';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!childIDVerified) {
        errorDiv.textContent = '‚ùå Please upload and verify child ID first';
        errorDiv.style.display = 'block';
        return;
    }
    
    const parentName = document.getElementById('signup-parent-name').value.trim();
    const email = document.getElementById('signup-parent-email').value.trim();
    const password = document.getElementById('signup-parent-password').value;
    const phone = document.getElementById('signup-parent-phone').value.trim();
    const country = document.getElementById('signup-parent-country').value;
    
    const childName = document.getElementById('signup-child-name').value.trim();
    const childAge = document.getElementById('signup-child-age').value;
    const childStudentId = document.getElementById('signup-child-student-id').value.trim();
    
    // Validate student ID format
    const studentIdPattern = /^WB-2025-[A-Z0-9]{4}$/;
    if (!studentIdPattern.test(childStudentId)) {
        errorDiv.textContent = '‚ùå Invalid student ID format. Must be WB-2025-XXXX';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Verify student ID exists in database
    try {
        const studentQuery = await db.collection('users')
            .where('studentId', '==', childStudentId)
            .where('userType', '==', 'student')
            .get();
        
        if (studentQuery.empty) {
            errorDiv.textContent = '‚ùå Student ID not found. Please verify the ID is correct.';
            errorDiv.style.display = 'block';
            return;
        }
        
        const studentDoc = studentQuery.docs[0];
        const studentData = studentDoc.data();
        
        // Check if student name matches
        if (studentData.name.toLowerCase() !== childName.toLowerCase()) {
            errorDiv.textContent = `‚ùå Student name does not match. Registered name: ${studentData.name}`;
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check if student already has a parent
        if (studentData.parentId) {
            errorDiv.textContent = '‚ùå This student already has a parent account linked.';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Disable submit button
        const submitBtn = document.getElementById('parent-signup-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Creating account...';
        
        // Create parent account
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: parentName });
        
        // Save parent data to Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
            name: parentName,
            email: email,
            phone: phone,
            country: country,
            userType: 'parent',
            parentIDVerified: true,
            childIDVerified: true,
            childStudentId: childStudentId,
            childName: childName,
            childAge: parseInt(childAge),
            linkedStudentId: studentDoc.id,
            profileComplete: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Link parent to student
        await db.collection('users').doc(studentDoc.id).update({
            parentId: userCredential.user.uid,
            parentName: parentName,
            parentEmail: email,
            parentLinkedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeAuthModal();
        errorDiv.style.display = 'none';
        
        alert(`‚úÖ Parent account created successfully!\n\nYou are now linked to student: ${childName}\nStudent ID: ${childStudentId}`);
        
        // Reset form
        document.getElementById('signup-parent-form').reset();
        parentIDFile = null;
        parentIDBase64 = null;
        childIDFile = null;
        childIDBase64 = null;
        parentIDVerified = false;
        childIDVerified = false;
        
    } catch (error) {
        console.error('Error creating parent account:', error);
        errorDiv.textContent = 'Failed to create account: ' + error.message;
        errorDiv.style.display = 'block';
        
        const submitBtn = document.getElementById('parent-signup-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = '‚úÖ Create Parent Account';
    }
}        
     async function updateUIForAuthenticatedUser(user) {
    const displayName = user.displayName || user.email.split('@')[0];
    const photoURL = user.photoURL;
    
    // Update sidebar
    document.getElementById('sidebarUserName').textContent = displayName;
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    
    if (photoURL) {
        sidebarAvatar.style.backgroundImage = `url(${photoURL})`;
        sidebarAvatar.textContent = '';
    } else {
        sidebarAvatar.style.backgroundImage = 'none';
        sidebarAvatar.textContent = displayName.charAt(0).toUpperCase();
    }
    
    // ‚úÖ SHOW MY PROFILE BUTTON BASED ON USER TYPE
    const myProfileBtn = document.getElementById('myProfileBtn');
    
    try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userData = userDoc.data();
        
        if (userData && userData.userType === 'parent') {
            myProfileBtn.innerHTML = 'üë®‚Äçüë©‚Äçüëß PARENT DASHBOARD';
            myProfileBtn.onclick = () => goToParentDashboard();
        } else if (userData && userData.userType === 'coach') {
            myProfileBtn.innerHTML = 'üë®‚Äçüè´ MY PROFILE';
            myProfileBtn.onclick = () => goToUserDashboard();
        } else {
            myProfileBtn.innerHTML = 'üë§ MY PROFILE';
            myProfileBtn.onclick = () => goToUserDashboard();
        }
        
        myProfileBtn.style.display = 'block';
    } catch (error) {
        console.error('Error loading user type:', error);
        myProfileBtn.innerHTML = 'üë§ MY PROFILE';
        myProfileBtn.onclick = () => goToUserDashboard();
        myProfileBtn.style.display = 'block';
    }
    
    document.getElementById('sidebar-signin').style.display = 'none';
    document.getElementById('sidebar-signout').style.display = 'block';
}

        
      function updateUIForGuestUser() {
    document.getElementById('sidebarUserName').textContent = 'Guest';
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    sidebarAvatar.style.backgroundImage = 'none';
    sidebarAvatar.textContent = '?';
    
    // Hide My Profile button
    document.getElementById('myProfileBtn').style.display = 'none';
    
    document.getElementById('sidebar-signin').style.display = 'block';
    document.getElementById('sidebar-signout').style.display = 'none';
    userFavorites = [];
    userIncorrect = [];
    userSpellingFavorites = [];
    userSpellingIncorrect = [];
    
    // ‚úÖ HIDE COINS
    userCoins = 0;
    hideCoinDisplay();
    
    document.getElementById('favorites-container').innerHTML = '<div class="loading">Please sign in to save favorites</div>';
    document.getElementById('incorrect-container').innerHTML = '<div class="loading">Please sign in to track incorrect answers</div>';
    document.getElementById('spelling-favorites-container').innerHTML = '<div class="loading">Please sign in to save spelling favorites</div>';
    document.getElementById('spelling-incorrect-container').innerHTML = '<div class="loading">Please sign in to track spelling mistakes</div>';
}
        
       
        // ===== QUIZ FUNCTIONS =====
    function switchQuizMode(mode) {
    // Remove active from ALL quiz tabs
    document.querySelectorAll('#quiz-section .quiz-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Add active to clicked tab
    if (mode === 'practice') {
        document.querySelectorAll('#quiz-section .quiz-tab')[0].classList.add('active');
    } else if (mode === 'live') {
        document.querySelectorAll('#quiz-section .quiz-tab')[1].classList.add('active');
    } else if (mode === 'leaderboard') {
        document.querySelectorAll('#quiz-section .quiz-tab')[2].classList.add('active');
    }

    // ‚úÖ Remove active from ALL quiz modes
    document.querySelectorAll('#quiz-section .quiz-mode').forEach(m => {
        m.classList.remove('active');
    });

    // ‚úÖ Show only the selected mode
    if (mode === 'practice') {
        document.getElementById('practice-quiz-mode').classList.add('active');
    } else if (mode === 'live') {
        document.getElementById('live-quiz-mode').classList.add('active');
        
        if (currentUser) {
            initializeOnlinePresence();
            setTimeout(() => loadQuizOnlineUsers(), 100);
        } else {
            alert('Please sign in to access live challenges');
            showAuthModal();
        }
    } else if (mode === 'leaderboard') {
        document.getElementById('leaderboard-quiz-mode').classList.add('active');
        loadQuizLeaderboard();
    }
}

        
     async function startPracticeQuizWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection
    document.getElementById('quiz-level-selection').style.display = 'none';
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üìö Loading words from ' + level.toUpperCase() + ' level...</div>';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üé≤ Generating quiz questions...</div>';
    
    // Initialize IQ tracking
    quizStartTime = Date.now();
    quizAnswerTimes = [];
    
    const quizWords = [];
    for (let i = 0; i < 5; i++) {
        const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
        quizWords.push(randomWord);
    }
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                data: { 
                    action: 'generatePracticeQuiz',
                    words: quizWords 
                } 
            })
        });
        
        const data = await response.json();
        currentQuiz = data.result;
        currentQuestionIndex = 0;
        quizScore = 0;
        
        showQuestion('practice');
    } catch (error) {
        console.error('Error generating quiz:', error);
        document.getElementById('practice-quiz-container').innerHTML = 
            '<div class="feedback error">Failed to generate quiz. Please try again.</div>';
    }
}

// Keep old function name for backwards compatibility but add check
async function startPracticeQuiz() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    await startPracticeQuizWithLevel(selectedGameLevel);
}

function backToQuizLevelSelection() {
    document.getElementById('quiz-level-selection').style.display = 'block';
    document.getElementById('practice-quiz-container').innerHTML = '';
    selectedGameLevel = '';
}


function showQuestion(quizType = 'practice') {
    const question = currentQuiz.questions[currentQuestionIndex];
    const container = document.getElementById('practice-quiz-container');
    
    const isFavorited = userFavorites.some(fav => fav.word === question.word);
    
    // Start timing for this question
    questionStartTime = Date.now();
    
    container.innerHTML = `
        <div class="quiz-question-card" style="position: relative;">
            ${currentUser ? `
                <span class="favorite-heart ${isFavorited ? 'active' : ''}" 
                      onclick="event.stopPropagation(); toggleFavorite('${question.word}', null, this)">
                    ${isFavorited ? '‚ù§Ô∏è' : 'ü§ç'}
                </span>
            ` : ''}
            <div class="quiz-score">Score: ${quizScore} / ${currentQuestionIndex}</div>
            <h3>Question ${currentQuestionIndex + 1} of ${currentQuiz.questions.length}</h3>
            <p style="font-size: 1.3rem; margin: 20px 0;"><strong>${question.question}</strong></p>
            <div class="quiz-options">
                ${question.options.map((option, index) => `
                    <div class="quiz-option" onclick="checkAnswer(${index}, '${quizType}')">
                        ${option}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

       async function checkAnswer(selectedIndex, quizType = 'practice') {
    const question = currentQuiz.questions[currentQuestionIndex];
    const options = document.querySelectorAll('.quiz-option');
    
    // Calculate time taken for this question
    const timeTaken = Date.now() - questionStartTime;
    quizAnswerTimes.push({
        correct: selectedIndex === question.correctAnswer,
        timeTaken: timeTaken
    });
    
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        options[selectedIndex].classList.add('correct');
        quizScore++;
    } else {
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
        
        if (currentUser) {
            await saveIncorrectQuestion(question, quizType, selectedIndex);
        }
        
        if (currentUser) {
            const favoriteRef = db.collection('users').doc(currentUser.uid).collection('favorites').doc(question.word);
            const favoriteDoc = await favoriteRef.get();
            
            if (favoriteDoc.exists) {
                await favoriteRef.update({
                    userAnswerIndex: selectedIndex
                });
                
                const favIndex = userFavorites.findIndex(fav => fav.word === question.word);
                if (favIndex !== -1) {
                    userFavorites[favIndex].userAnswerIndex = selectedIndex;
                }
                
                if (document.getElementById('favorites-section').classList.contains('active')) {
                    displayFavorites();
                }
            }
        }
    }
    
    setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuiz.questions.length) {
            questionStartTime = Date.now(); // Reset timer for next question
            showQuestion(quizType);
        } else {
            showQuizResults();
        }
    }, 3000);
}

        function calculateIQScore(score, total, answerTimes) {
    // Base IQ calculation on accuracy and speed
    const accuracyPercentage = (score / total) * 100;
    
    // Calculate average time per question (in seconds)
    const avgTime = answerTimes.reduce((sum, ans) => sum + ans.timeTaken, 0) / answerTimes.length / 1000;
    
    // Speed score: faster is better (ideal time: 5-10 seconds per question)
    let speedScore = 0;
    if (avgTime < 5) speedScore = 100;
    else if (avgTime < 10) speedScore = 90;
    else if (avgTime < 15) speedScore = 75;
    else if (avgTime < 20) speedScore = 60;
    else speedScore = 40;
    
    // Consistency score: fewer mistakes on easy questions = higher IQ
    const correctAnswers = answerTimes.filter(ans => ans.correct).length;
    const consistencyScore = (correctAnswers / total) * 100;
    
    // Calculate base IQ (scale: 70-145)
    // Formula: 70 + (accuracy * 0.5) + (speed * 0.2) + (consistency * 0.05)
    let iq = 70 + (accuracyPercentage * 0.5) + (speedScore * 0.2) + (consistencyScore * 0.05);
    
    // Cap at 145 (genius level)
    iq = Math.min(145, Math.round(iq));
    
    return {
        iq: iq,
        accuracy: accuracyPercentage,
        avgTime: avgTime.toFixed(1),
        speedScore: speedScore,
        category: getIQCategory(iq)
    };
}

function getIQCategory(iq) {
    if (iq >= 130) return { label: "Genius", color: "#FFD700", emoji: "üß†‚ú®" };
    if (iq >= 120) return { label: "Superior", color: "#4CAF50", emoji: "üåü" };
    if (iq >= 110) return { label: "High Average", color: "#2196F3", emoji: "‚≠ê" };
    if (iq >= 90) return { label: "Average", color: "#FF9800", emoji: "üëç" };
    if (iq >= 80) return { label: "Low Average", color: "#FF5722", emoji: "üìö" };
    return { label: "Keep Practicing", color: "#9E9E9E", emoji: "üí™" };
}
        
        function showQuizResults() {
    const container = document.getElementById('practice-quiz-container');
    const percentage = Math.round((quizScore / currentQuiz.questions.length) * 100);
    
    // Calculate IQ Score
    const iqData = calculateIQScore(quizScore, currentQuiz.questions.length, quizAnswerTimes);
    
    let message = '';
    let emoji = '';
    let showBalloons = false;
    let showSpellingEncouragement = false;
    
    if (percentage >= 80) {
        message = 'Excellent! You\'re a word master!';
        emoji = 'üèÜ';
        showBalloons = true;
        showSpellingEncouragement = true;
    } else if (percentage >= 60) {
        message = 'Great job! Keep practicing!';
        emoji = '‚≠ê';
        showSpellingEncouragement = true;
    } else {
        message = 'Keep practicing! You\'ll get better!';
        emoji = 'üìö';
    }
    
    // Create balloons if score is high
    if (showBalloons) {
        createBalloons();
        createConfetti();
    }
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
            <h2>Quiz Complete!</h2>
            <div class="quiz-score">Final Score: ${quizScore} / ${currentQuiz.questions.length}</div>
            <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
            <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
            
            <!-- IQ Score Display -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; margin: 30px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                <h3 style="color: white; margin-bottom: 15px; font-size: 1.5rem;">üß† Your Vocabulary IQ</h3>
                <div class="iq-badge">${iqData.iq}</div>
                <p style="color: white; font-size: 1.3rem; margin: 15px 0;">
                    ${iqData.category.emoji} <strong>${iqData.category.label}</strong>
                </p>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p style="color: white; margin: 8px 0;"><strong>üìä Accuracy:</strong> ${iqData.accuracy.toFixed(1)}%</p>
                    <p style="color: white; margin: 8px 0;"><strong>‚ö° Avg Response Time:</strong> ${iqData.avgTime}s</p>
                    <p style="color: white; margin: 8px 0;"><strong>üéØ Speed Score:</strong> ${iqData.speedScore}/100</p>
                </div>
            </div>
            
            ${showSpellingEncouragement ? `
                <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 25px; border-radius: 15px; margin: 20px 0; box-shadow: 0 5px 20px rgba(255,215,0,0.4); animation: pulse-glow 2s infinite;">
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">üèÜ You Have Spelling Champion Potential!</h3>
                    <p style="color: #0d3b66; margin: 10px 0; font-size: 1.1rem;">
                        Your strong vocabulary skills show you could excel at spelling competitions!
                    </p>
                    <p style="color: #0d3b66; margin: 10px 0; font-weight: bold;">
                        üí∞ Head to the Spelling section to practice and earn coins in upcoming live challenges!
                    </p>
                    <button class="practice-btn" onclick="navigateTo('spelling')" style="background: #0d3b66; color: white; margin-top: 15px; font-size: 1.1rem; padding: 15px 30px;">
                        üî§ Go to Spelling Practice ‚Üí
                    </button>
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
    <button class="practice-btn" onclick="backToQuizLevelSelection()">‚Üê Back to Levels</button>
    <button class="practice-btn" onclick="startPracticeQuizWithLevel('${selectedGameLevel}')">üîÑ Try Again</button>
    <button class="practice-btn" onclick="navigateTo('home')">üè† Home</button>
</div>
        </div>
    `;
}

function createBalloons() {
    const balloons = ['üéà', 'üéà', 'üéà', 'üéà', 'üéà', 'üéà'];
    const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'pink'];
    
    balloons.forEach((balloon, index) => {
        const balloonEl = document.createElement('div');
        balloonEl.className = 'balloon';
        balloonEl.textContent = balloon;
        balloonEl.style.color = colors[index];
        document.body.appendChild(balloonEl);
        
        // Remove after animation
        setTimeout(() => {
            balloonEl.remove();
        }, 8000);
    });
}

function createConfetti() {
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'];
    
    for (let i = 0; i < 50; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 3000);
        }, i * 50);
    }
}

        // ===== FAVORITES MANAGEMENT =====
     async function loadUserFavorites(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('favorites').get();
        
        // Load all favorites - only filter out truly broken ones
        userFavorites = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(fav => {
                // Keep if it has word and valid question
                return fav.word && 
                       fav.question && 
                       fav.question !== 'undefined';
            });
        
        console.log('Loaded favorites:', userFavorites);
        displayFavorites();
        
        // Enable quiz button based on valid quizzable favorites
        const btn = document.getElementById('favoritesQuizBtn');
        if (btn) {
            const quizzableFavorites = userFavorites.filter(fav => 
                fav.options && 
                Array.isArray(fav.options) && 
                fav.options.length > 0 &&
                typeof fav.correctAnswer === 'number'
            );
            btn.disabled = quizzableFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error loading favorites:', error);
    }
}
        
       async function toggleFavorite(word, questionData, element) {
    if (!currentUser) {
        alert('Please sign in to save favorites');
        return;
    }

    const favoriteRef = db.collection('users').doc(currentUser.uid).collection('favorites').doc(word);
    const favoriteDoc = await favoriteRef.get();

    if (favoriteDoc.exists) {
        await favoriteRef.delete();
        element.textContent = 'ü§ç';
        element.classList.remove('active');
        userFavorites = userFavorites.filter(fav => fav.word !== word);
    } else {
        // Get the current question from the quiz
        const question = currentQuiz.questions[currentQuestionIndex];
        
        const favoriteData = {
            word: word,
            question: question.question,
            options: question.options,
            correctAnswer: question.correctAnswer,
            correctDefinition: question.options[question.correctAnswer],
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Check if this question was already answered incorrectly
        const incorrectAnswer = userIncorrect.find(inc => inc.word === word);
        if (incorrectAnswer && incorrectAnswer.userAnswerIndex !== undefined) {
            favoriteData.userAnswerIndex = incorrectAnswer.userAnswerIndex;
        }
        
        // ALSO check if the user just answered this question wrong (check the DOM)
        const wrongOption = document.querySelector('.quiz-option.wrong');
        if (wrongOption) {
            // Find which index this is
            const allOptions = Array.from(document.querySelectorAll('.quiz-option'));
            const wrongIndex = allOptions.indexOf(wrongOption);
            if (wrongIndex !== -1) {
                favoriteData.userAnswerIndex = wrongIndex;
            }
        }
        
        await favoriteRef.set(favoriteData);
        
        element.textContent = '‚ù§Ô∏è';
        element.classList.add('active');
        
        const newFavorite = {
            word: word,
            question: question.question,
            options: question.options,
            correctAnswer: question.correctAnswer,
            correctDefinition: question.options[question.correctAnswer]
        };
        
        if (favoriteData.userAnswerIndex !== undefined) {
            newFavorite.userAnswerIndex = favoriteData.userAnswerIndex;
        }
        
        userFavorites.push(newFavorite);
    }

    displayFavorites();
}
        
async function startFavoritesQuiz() {
    // Only use favorites that have full question data
    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );
    
    const minQuestions = Math.min(quizzableFavorites.length, 5);
    if (quizzableFavorites.length < minQuestions) {
        alert(`You need at least ${minQuestions} quizzable favorites to generate a quiz`);
        return;
    }

    navigateTo('quiz', true);
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üé≤ Generating quiz from your favorites...</div>';

    // Use the exact saved questions with their options
    const selectedFavorites = [...quizzableFavorites].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

    const quizQuestions = selectedFavorites.map(fav => ({
        word: fav.word,
        question: fav.question,
        options: fav.options,
        correctAnswer: fav.correctAnswer,
        correctDefinition: fav.correctDefinition
    }));

    currentQuiz = { questions: quizQuestions };
    currentQuestionIndex = 0;
    quizScore = 0;

    showQuestion('favorites');
}

function displayFavorites() {
    const container = document.getElementById('favorites-container');
    const btn = document.getElementById('favoritesQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to save favorites</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userFavorites.length === 0) {
        container.innerHTML = '<div class="loading">No favorites yet. Star words from quizzes to add them here!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );

    if (btn) {
        btn.disabled = quizzableFavorites.length < 5;
    }

    container.innerHTML = `
        ${userFavorites.length < 5 ? `
            <div class="loading">
                You have ${userFavorites.length} favorite(s). Add at least ${5 - userFavorites.length} more to generate a quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userFavorites.map(fav => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeFavorite('${fav.word}')">√ó</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">${fav.word}</h3>
                    <p style="color: #666; margin-bottom: 10px;"><strong>Q:</strong> ${fav.question}</p>
                    ${fav.options ? `
                        <div style="margin: 10px 0;">
                            ${fav.options.map((opt, idx) => `
                                <p style="padding: 5px; margin: 3px 0; border-radius: 5px; font-size: 0.9rem; 
                                   background: ${idx === fav.correctAnswer ? '#d4edda' : (fav.userAnswerIndex !== undefined && idx === fav.userAnswerIndex ? '#f8d7da' : '#f9f9f9')};">
                                    ${opt} ${idx === fav.correctAnswer ? '‚úì' : (fav.userAnswerIndex !== undefined && idx === fav.userAnswerIndex ? '‚úó' : '')}
                                </p>
                            `).join('')}
                        </div>
                    ` : `
                        <p style="color: #28a745; margin-top: 10px;"><strong>Definition:</strong> ${fav.correctDefinition || 'No definition saved'}</p>
                    `}
                </div>
            `).join('')}
        </div>
    `;
}
        
        async function removeFavorite(word) {
            if (!currentUser) return;

            await db.collection('users').doc(currentUser.uid).collection('favorites').doc(word).delete();
            userFavorites = userFavorites.filter(fav => fav.word !== word);
            displayFavorites();
        }

      async function startFavoritesQuiz() {
    // Only use favorites that have full question data
    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );
    
    const minQuestions = Math.min(quizzableFavorites.length, 5);
    if (quizzableFavorites.length < minQuestions) {
        alert(`You need at least ${minQuestions} quizzable favorites to generate a quiz`);
        return;
    }

    navigateTo('quiz', true);
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üé≤ Generating quiz from your favorites...</div>';

    // Use the exact saved questions with their options
    const selectedFavorites = [...quizzableFavorites].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

    const quizQuestions = selectedFavorites.map(fav => ({
        word: fav.word,
        question: fav.question,
        options: fav.options,
        correctAnswer: fav.correctAnswer,
        correctDefinition: fav.correctDefinition
    }));

    currentQuiz = { questions: quizQuestions };
    currentQuestionIndex = 0;
    quizScore = 0;

    showQuestion('favorites');
}

        
      async function loadUserIncorrect(userId) {
            try {
                const snapshot = await db.collection('users').doc(userId).collection('incorrectQuestions').get();
                userIncorrect = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayIncorrect();
                
                // Enable quiz button if enough incorrect answers
                const btn = document.getElementById('incorrectQuizBtn');
                if (btn) {
                    btn.disabled = userIncorrect.length < 5;
                }
            } catch (error) {
                console.error('Error loading incorrect questions:', error);
            }
        }
        
       async function saveIncorrectQuestion(question, quizType, selectedIndex) {
            if (!currentUser) return;

            const incorrectRef = db.collection('users').doc(currentUser.uid).collection('incorrectQuestions');
            
            // Save complete question with all options
            const docRef = await incorrectRef.add({
                word: question.word,
                question: question.question,
                options: question.options,
                correctAnswer: question.correctAnswer,
                correctDefinition: question.options[question.correctAnswer],
                userAnswer: question.options[selectedIndex],
                userAnswerIndex: selectedIndex,
                quizType: quizType,
                savedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            userIncorrect.push({
                id: docRef.id,
                word: question.word,
                question: question.question,
                options: question.options,
                correctAnswer: question.correctAnswer,
                correctDefinition: question.options[question.correctAnswer],
                userAnswer: question.options[selectedIndex]
            });
            
            displayIncorrect();
        }

       function displayIncorrect() {
            const container = document.getElementById('incorrect-container');
            const btn = document.getElementById('incorrectQuizBtn');

            if (!currentUser) {
                container.innerHTML = '<div class="loading">Please sign in to track incorrect answers</div>';
                btn.disabled = true;
                return;
            }

            if (userIncorrect.length === 0) {
                container.innerHTML = '<div class="loading">No incorrect answers yet. Take a quiz to get started!</div>';
                btn.disabled = true;
                return;
            }

            const minQuestions = Math.min(userIncorrect.length, 5);
            btn.disabled = userIncorrect.length < minQuestions;

            container.innerHTML = `
                ${userIncorrect.length < 5 ? `
                    <div class="loading">
                        You have ${userIncorrect.length} incorrect answer(s). Add at least ${5 - userIncorrect.length} more to generate a practice quiz.
                    </div>
                ` : ''}
                <div class="favorites-grid">
                    ${userIncorrect.map(inc => `
                        <div class="favorite-card">
                            <button class="delete-btn" onclick="removeIncorrect('${inc.id}')">√ó</button>
                            <h3 style="color: #0d3b66; margin-bottom: 10px;">${inc.word}</h3>
                            <p style="color: #666; margin-bottom: 10px;"><strong>Q:</strong> ${inc.question}</p>
                            ${inc.options ? `
                                <div style="margin: 10px 0;">
                                    ${inc.options.map((opt, idx) => `
                                        <p style="padding: 5px; margin: 3px 0; border-radius: 5px; font-size: 0.9rem; 
                                           background: ${idx === inc.correctAnswer ? '#d4edda' : (opt === inc.userAnswer ? '#f8d7da' : '#f9f9f9')};">
                                            ${opt} ${idx === inc.correctAnswer ? '‚úì' : (opt === inc.userAnswer ? '‚úó' : '')}
                                        </p>
                                    `).join('')}
                                </div>
                            ` : `
                                <p style="color: #dc3545; margin-top: 5px;"><strong>Your answer:</strong> ${inc.userAnswer}</p>
                                <p style="color: #28a745; margin-top: 5px;"><strong>Correct:</strong> ${inc.correctDefinition}</p>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
        }
              

        async function removeIncorrect(id) {
            if (!currentUser) return;

            await db.collection('users').doc(currentUser.uid).collection('incorrectQuestions').doc(id).delete();
            userIncorrect = userIncorrect.filter(inc => inc.id !== id);
            displayIncorrect();
        }

        async function startIncorrectQuiz() {
            const minQuestions = Math.min(userIncorrect.length, 5);
            if (userIncorrect.length < minQuestions) {
                alert(`You need at least ${minQuestions} incorrect answers to generate a practice quiz`);
                return;
            }

            navigateTo('quiz', true);
            document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üé≤ Generating quiz from your incorrect answers...</div>';

            // Use the exact saved questions with their options
            const selectedIncorrect = [...userIncorrect].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

            const quizQuestions = selectedIncorrect.map(inc => ({
                word: inc.word,
                question: inc.question,
                options: inc.options,
                correctAnswer: inc.correctAnswer,
                correctDefinition: inc.correctDefinition
            }));

            currentQuiz = { questions: quizQuestions };
            currentQuestionIndex = 0;
            quizScore = 0;

            showQuestion('incorrect');
        }

        async function cleanupInvalidFavorites() {
    if (!currentUser) return;
    
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid).collection('favorites').get();
        
        const deletions = [];
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            // Only delete if question is literally "undefined" or missing word
            if (!data.word || data.question === 'undefined') {
                console.log('Deleting invalid favorite:', doc.id);
                deletions.push(doc.ref.delete());
            }
        });
        
        if (deletions.length > 0) {
            await Promise.all(deletions);
            console.log(`Cleaned up ${deletions.length} invalid favorites`);
            // Reload favorites
            await loadUserFavorites(currentUser.uid);
        }
    } catch (error) {
        console.error('Error cleaning up favorites:', error);
    }
}



async function startSpellingPracticeWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection and show loading
    document.getElementById('spelling-level-selection').style.display = 'none';
    const gameContainer = document.getElementById('spelling-game');
    gameContainer.innerHTML = '<div class="loading">üìö Loading ' + level.toUpperCase() + ' words...</div>';
    gameContainer.style.display = 'block';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    // Select 10 random words from the entire level (no difficulty filtering)
    if (allWords.length < 10) {
        alert('Not enough words in this level. Try another level.');
        document.getElementById('spelling-level-selection').style.display = 'block';
        gameContainer.style.display = 'none';
        return;
    }
    
    const shuffled = [...allWords].sort(() => 0.5 - Math.random());
    spellingWords = shuffled.slice(0, 10);
    
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    // Clear the loading message and restore the game UI
    gameContainer.innerHTML = `
        <div class="quiz-question-card">
            <div class="quiz-score" id="spelling-score">Score: 0 / 0</div>
            <h3 id="spelling-progress">Word 1 of 10</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="practice-btn" onclick="speakCurrentSpellingWord()" style="font-size: 0.9rem; padding: 10px 15px;">
                        üîä Play Word
                    </button>
                    <button class="practice-btn" onclick="speakWordInSentence()" style="font-size: 0.9rem; padding: 10px 15px;">
                        üí¨ Use in Sentence
                    </button>
                    <button class="practice-btn" id="show-details-btn" onclick="showSpellingWordDetails()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                        üìñ Word Details
                    </button>
                    <button class="practice-btn" id="add-spelling-favorite-btn" onclick="addCurrentSpellingToFavorites()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                        ‚≠ê Add to Favorites
                    </button>
                </div>
                <p style="margin-top: 5px; color: #666; font-style: italic; font-size: 0.9rem;">Listen to the word alone, in a sentence, see details, or add to favorites</p>
            </div>
                            
            <div class="form-group" style="margin: 30px 0;">
                <label style="font-size: 1.2rem;">Type what you hear:</label>
                <input type="text" id="spelling-input" 
                       placeholder="Use the keyboard below..." 
                       style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                       readonly>
            </div>
            
            <!-- Virtual Keyboard -->
            <div class="virtual-keyboard">
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('Q')">Q</button>
                    <button class="keyboard-key" onclick="typeKey('W')">W</button>
                    <button class="keyboard-key" onclick="typeKey('E')">E</button>
                    <button class="keyboard-key" onclick="typeKey('R')">R</button>
                    <button class="keyboard-key" onclick="typeKey('T')">T</button>
                    <button class="keyboard-key" onclick="typeKey('Y')">Y</button>
                    <button class="keyboard-key" onclick="typeKey('U')">U</button>
                    <button class="keyboard-key" onclick="typeKey('I')">I</button>
                    <button class="keyboard-key" onclick="typeKey('O')">O</button>
                    <button class="keyboard-key" onclick="typeKey('P')">P</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('A')">A</button>
                    <button class="keyboard-key" onclick="typeKey('S')">S</button>
                    <button class="keyboard-key" onclick="typeKey('D')">D</button>
                    <button class="keyboard-key" onclick="typeKey('F')">F</button>
                    <button class="keyboard-key" onclick="typeKey('G')">G</button>
                    <button class="keyboard-key" onclick="typeKey('H')">H</button>
                    <button class="keyboard-key" onclick="typeKey('J')">J</button>
                    <button class="keyboard-key" onclick="typeKey('K')">K</button>
                    <button class="keyboard-key" onclick="typeKey('L')">L</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('Z')">Z</button>
                    <button class="keyboard-key" onclick="typeKey('X')">X</button>
                    <button class="keyboard-key" onclick="typeKey('C')">C</button>
                    <button class="keyboard-key" onclick="typeKey('V')">V</button>
                    <button class="keyboard-key" onclick="typeKey('B')">B</button>
                    <button class="keyboard-key" onclick="typeKey('N')">N</button>
                    <button class="keyboard-key" onclick="typeKey('M')">M</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key backspace" onclick="backspaceKey()">‚å´ Delete</button>
                    <button class="keyboard-key space" onclick="typeKey(' ')">Space</button>
                    <button class="keyboard-key enter" onclick="submitSpelling()">‚úì Enter</button>
                </div>
            </div>
                            
            <div style="text-align: center; margin-top: 20px;">
                <button class="practice-btn" onclick="skipSpellingWord()" style="background: #666;">
                    ‚è≠Ô∏è Skip
                </button>
            </div>
                            
            <div id="spelling-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
    
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

function backToSpellingLevelSelection() {
    document.getElementById('spelling-level-selection').style.display = 'block';
    document.getElementById('spelling-game').style.display = 'none';
    document.getElementById('spelling-results').style.display = 'none';
    selectedGameLevel = '';
}

// Keep old function for backwards compatibility
function startSpellingPractice() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    startSpellingPracticeWithLevel(selectedGameLevel);
}
        
        function loadSpellingWord() {
    currentSpellingWord = spellingWords[currentSpellingIndex];
    
    document.getElementById('spelling-progress').textContent = 
        `Word ${currentSpellingIndex + 1} of ${spellingWords.length}`;
    document.getElementById('spelling-score').textContent = 
        `Score: ${spellingScore} / ${currentSpellingIndex}`;
    document.getElementById('spelling-input').value = '';
    document.getElementById('spelling-feedback').innerHTML = '';
    
    // Show favorite button if user is logged in
    const favoriteBtn = document.getElementById('add-spelling-favorite-btn');
    if (favoriteBtn && currentUser) {
        favoriteBtn.style.display = 'inline-block';
    }
    
    // Hide word details button for new word
    const detailsBtn = document.getElementById('show-details-btn');
    if (detailsBtn) {
        detailsBtn.style.display = 'none';
    }
    
    // Re-enable input for new word
    document.getElementById('spelling-input').disabled = false;
    
    // Auto-play the word when loaded
    setTimeout(() => speakCurrentSpellingWord(), 500);
    
    // Focus on input
    document.getElementById('spelling-input').focus();
}
        
       function speakCurrentSpellingWord() {
            if (!currentSpellingWord) return;
            
            const utterance = new SpeechSynthesisUtterance(currentSpellingWord);
            utterance.rate = 0.7; // Slower for spelling
            utterance.pitch = 1;
            utterance.volume = 1;
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
            
            // Visual feedback
            const btn = event?.target;
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = 'scale(1)', 200);
            }
        }

        async function speakWordInSentence() {
    if (!currentSpellingWord) return;
    
    // Show loading state
    const btn = event?.target;
    if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Loading...';
    }
    
    try {
        // Fetch word definition to get example sentence
        const wordRef = db.collection('dictionary').doc(currentSpellingWord.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let exampleSentence = null;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        exampleSentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        // If no cached example, fetch from API
        if (!exampleSentence) {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: currentSpellingWord } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.meanings && data.result.meanings.length > 0) {
                    for (let meaning of data.result.meanings) {
                        if (meaning.example) {
                            exampleSentence = meaning.example;
                            break;
                        }
                    }
                }
            }
        }
        
        // If still no example, create a simple sentence
        if (!exampleSentence) {
            exampleSentence = `The word is ${currentSpellingWord}.`;
        }
        
        // Use SSML to emphasize the target word with volume
        const targetWord = currentSpellingWord;
        const emphasizedSentence = exampleSentence.replace(
            new RegExp(`\\b${targetWord}\\b`, 'gi'),
            `<emphasis level="strong">${targetWord}</emphasis>`
        );
        
        // Speak the entire sentence at once
        const utterance = new SpeechSynthesisUtterance(exampleSentence);
        utterance.rate = 0.8;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        // Fallback: just say the word
        const utterance = new SpeechSynthesisUtterance(`The word is ${currentSpellingWord}.`);
        utterance.rate = 0.8;
        window.speechSynthesis.speak(utterance);
    } finally {
        // Reset button
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'üí¨ Use in Sentence';
        }
    }
}
        
       async function showSpellingWordDetails() {
    if (!currentSpellingWord) return;
    
    const feedbackDiv = document.getElementById('spelling-feedback');
    feedbackDiv.innerHTML = '<div class="loading">üìö Loading word details...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentSpellingWord);
        
        feedbackDiv.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #17a2b8; margin-top: 15px;">
                <h3 style="color: #17a2b8; margin-bottom: 15px;">üìñ Word Information</h3>
                
                ${wordDetails.phonetic ? `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #0d3b66;">üîä Pronunciation:</strong>
                        <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                    </div>
                ` : ''}
                
                ${wordDetails.origin ? `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #0d3b66;">üìú Origin:</strong>
                        <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                    </div>
                ` : ''}
                
                ${wordDetails.definition ? `
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #0d3b66;">üìù Definition:</strong>
                        <p style="color: #333; margin-top: 8px; line-height: 1.6;">${wordDetails.definition}</p>
                    </div>
                ` : ''}
                
                <p style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; color: #0d3b66; font-style: italic; text-align: center;">
                    ‚ö†Ô∏è Remember: Don't use this to cheat! Use it to learn about the word after attempting.
                </p>
            </div>
        `;
    } catch (error) {
        console.error('Error fetching word details:', error);
        feedbackDiv.innerHTML = `
            <div class="feedback error">
                ‚ùå Unable to load word details. Please try again.
            </div>
        `;
    }
}
        function nextSpellingWord() {
    document.getElementById('spelling-input').disabled = false;
    currentSpellingIndex++;
    if (currentSpellingIndex < spellingWords.length) {
        loadSpellingWord();
    } else {
        showSpellingResults();
    }
}
        
   async function submitSpelling() {
    const userAnswer = document.getElementById('spelling-input').value.trim().toLowerCase();
    const correctWord = currentSpellingWord.toLowerCase();
    const feedbackDiv = document.getElementById('spelling-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">‚ö†Ô∏è Please type a word before submitting</div>';
        return;
    }
    
    // Disable input while processing
    document.getElementById('spelling-input').disabled = true;
    
    if (userAnswer === correctWord) {
        spellingScore++;
        
        // Fetch word details to show origin
        feedbackDiv.innerHTML = '<div class="loading">‚úÖ Correct! Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentSpellingWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    ‚úÖ <strong>Correct!</strong> The word is: <strong>${currentSpellingWord}</strong>
                    
                    ${currentUser ? `
                        <button class="practice-btn" onclick="saveSpellingFavorite('${currentSpellingWord}', '${userAnswer}', true)" 
                                style="margin-top: 15px; background: #ffd700; color: #0d3b66;">
                            ‚≠ê Add to Favorites
                        </button>
                    ` : ''}
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üîä Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üìú Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">üìù Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    ‚úÖ Correct! The word is: <strong>${currentSpellingWord}</strong>
                    ${currentUser ? `
                        <button class="practice-btn" onclick="saveSpellingFavorite('${currentSpellingWord}', '${userAnswer}', true)" 
                                style="margin-top: 15px; background: #ffd700; color: #0d3b66;">
                            ‚≠ê Add to Favorites
                        </button>
                    ` : ''}
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        }
    } else {
        // Save incorrect answer automatically
        if (currentUser) {
            await saveSpellingIncorrect(currentSpellingWord, userAnswer);
        }
        
        spellingMistakes.push({
            word: currentSpellingWord,
            userAnswer: userAnswer
        });
        
        // Fetch word details to show origin
        feedbackDiv.innerHTML = '<div class="loading">‚ùå Incorrect. Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentSpellingWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå <strong>Incorrect.</strong> You wrote: <strong>${userAnswer}</strong><br>
                    Correct spelling: <strong>${currentSpellingWord}</strong>
                    
                    ${currentUser ? '<p style="margin-top: 10px; color: #721c24; font-style: italic;">‚úÖ Automatically saved to Spelling Mistakes</p>' : ''}
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üîä Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üìú Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">üìù Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå Incorrect. You wrote: <strong>${userAnswer}</strong><br>
                    Correct spelling: <strong>${currentSpellingWord}</strong>
                    ${currentUser ? '<p style="margin-top: 10px; color: #721c24; font-style: italic;">‚úÖ Automatically saved to Spelling Mistakes</p>' : ''}
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        }
        
        // Speak the correct word again
        setTimeout(() => speakCurrentSpellingWord(), 1000);
    }
    
    // Show the word details button after attempt
    document.getElementById('show-details-btn').style.display = 'inline-block';
}

        
        async function skipSpellingWord() {
    spellingMistakes.push({
        word: currentSpellingWord,
        userAnswer: '(skipped)'
    });
    
    // Disable input while processing
    document.getElementById('spelling-input').disabled = true;
    
    const feedbackDiv = document.getElementById('spelling-feedback');
    feedbackDiv.innerHTML = '<div class="loading">‚è≠Ô∏è Loading word details...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentSpellingWord);
        
        feedbackDiv.innerHTML = `
            <div class="feedback" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
                ‚è≠Ô∏è <strong>Skipped.</strong> The word was: <strong>${currentSpellingWord}</strong>
                
                <div style="margin-top: 15px; padding: 15px; background: #ffe8a1; border-radius: 8px;">
                    ${wordDetails.phonetic ? `
                        <div style="margin-bottom: 10px;">
                            <strong>üîä Pronunciation:</strong>
                            <span style="font-style: italic; margin-left: 8px;">${wordDetails.phonetic}</span>
                        </div>
                    ` : ''}
                    
                    ${wordDetails.origin ? `
                        <div style="margin-bottom: 10px;">
                            <strong>üìú Origin:</strong>
                            <span style="margin-left: 8px;">${wordDetails.origin}</span>
                        </div>
                    ` : ''}
                    
                    ${wordDetails.definition ? `
                        <div>
                            <strong>üìù Definition:</strong>
                            <span style="margin-left: 8px;">${wordDetails.definition}</span>
                        </div>
                    ` : ''}
                </div>
                
                <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    ‚û°Ô∏è Next Word
                </button>
            </div>
        `;
    } catch (error) {
        feedbackDiv.innerHTML = `
            <div class="feedback" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
                ‚è≠Ô∏è Skipped. The word was: <strong>${currentSpellingWord}</strong>
                
                <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    ‚û°Ô∏è Next Word
                </button>
            </div>
        `;
    }
    
    speakCurrentSpellingWord();
    
    // Show the word details button after skip
    document.getElementById('show-details-btn').style.display = 'inline-block';
}
        
        
        function showSpellingResults() {
            document.getElementById('spelling-game').style.display = 'none';
            const resultsDiv = document.getElementById('spelling-results');
            resultsDiv.style.display = 'block';
            
            const percentage = Math.round((spellingScore / spellingWords.length) * 100);
            
            let message = '';
            let emoji = '';
            
            if (percentage >= 90) {
                message = 'Outstanding! You\'re a spelling champion!';
                emoji = 'üèÜ';
            } else if (percentage >= 70) {
                message = 'Great job! Keep practicing!';
                emoji = '‚≠ê';
            } else if (percentage >= 50) {
                message = 'Good effort! Practice makes perfect!';
                emoji = 'üëç';
            } else {
                message = 'Keep practicing! You\'ll improve!';
                emoji = 'üìö';
            }
            
            resultsDiv.innerHTML = `
                <div class="quiz-question-card" style="text-align: center;">
                    <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
                    <h2>Spelling Practice Complete!</h2>
                    <div class="quiz-score">Final Score: ${spellingScore} / ${spellingWords.length}</div>
                    <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
                    <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
                    
                    ${spellingMistakes.length > 0 ? `
                        <div style="margin: 30px 0; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                            <h3 style="color: #0d3b66; margin-bottom: 15px;">üìù Words to Review:</h3>
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                                ${spellingMistakes.map(mistake => `
                                    <div style="padding: 10px; margin: 5px 0; background: white; border-left: 3px solid #dc3545; border-radius: 5px;">
                                        <strong>${mistake.word}</strong> 
                                        <span style="color: #666;">- You wrote: ${mistake.userAnswer}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="startSpellingPracticeWithLevel()">üîÑ Practice Again</button>
                    <button class="practice-btn" onclick="backToSpellingLevelSelection()">‚Üê Back to Levels</button>
                    <button class="practice-btn" onclick="navigateTo('home')">üè† Home</button>
                  </div>
                </div>
            `;
        }

        function restartSpellingSection() {
    document.getElementById('spelling-game').style.display = 'none';
    document.getElementById('spelling-results').style.display = 'none';
    document.getElementById('spelling-level-selection').style.display = 'block';
    selectedGameLevel = '';
}

    function switchSpellingMode(mode) {
    // Remove active from ALL spelling tabs
    const tabs = document.querySelectorAll('#spelling-section .quiz-tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Add active to clicked tab
    if (mode === 'practice') {
        tabs[0].classList.add('active');
    } else if (mode === 'unscramble') {
        tabs[1].classList.add('active');
    } else if (mode === 'live') {
        tabs[2].classList.add('active');
    } else if (mode === 'leaderboard') {
        tabs[3].classList.add('active');
    }

    // ‚úÖ Remove active from ALL spelling modes
    document.querySelectorAll('#spelling-section .quiz-mode').forEach(m => {
        m.classList.remove('active');
    });

    // ‚úÖ Show only the selected mode
    if (mode === 'practice') {
        document.getElementById('practice-spelling-mode').classList.add('active');
    } else if (mode === 'unscramble') {
        document.getElementById('unscramble-mode').classList.add('active');
    } else if (mode === 'live') {
        document.getElementById('live-spelling-mode').classList.add('active');
        
        if (currentUser) {
            initializeOnlinePresence();
            setTimeout(() => loadOnlineUsers(), 100);
        } else {
            alert('Please sign in to access live challenges');
            showAuthModal();
        }
    } else if (mode === 'leaderboard') {
        document.getElementById('leaderboard-spelling-mode').classList.add('active');
        loadSpellingLeaderboard();
    }
}

        // ===== SPELLING FAVORITES FUNCTIONS =====
async function loadUserSpellingFavorites(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('spellingFavorites').get();
        userSpellingFavorites = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displaySpellingFavorites();
        
        const btn = document.getElementById('spellingFavoritesQuizBtn');
        if (btn) {
            btn.disabled = userSpellingFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error loading spelling favorites:', error);
    }
}

async function saveSpellingFavorite(word, userAnswer, wasCorrect) {
    if (!currentUser) return;
    
    try {
        const favoriteRef = db.collection('users').doc(currentUser.uid).collection('spellingFavorites').doc(word);
        
        // Check if already exists
        const existingDoc = await favoriteRef.get();
        if (existingDoc.exists) {
            console.log('Word already in favorites');
            return;
        }
        
        await favoriteRef.set({
            word: word,
            userAnswer: userAnswer || '',
            wasCorrect: wasCorrect,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        userSpellingFavorites.push({
            id: word,
            word: word,
            userAnswer: userAnswer || '',
            wasCorrect: wasCorrect
        });
        
        displaySpellingFavorites();
        
        // Update button state if quiz button exists
        const btn = document.getElementById('spellingFavoritesQuizBtn');
        if (btn) {
            btn.disabled = userSpellingFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error saving spelling favorite:', error);
    }
}

function displaySpellingFavorites() {
    const container = document.getElementById('spelling-favorites-container');
    const btn = document.getElementById('spellingFavoritesQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to save spelling favorites</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userSpellingFavorites.length === 0) {
        container.innerHTML = '<div class="loading">No spelling favorites yet. Star words from spelling practice to add them here!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (btn) {
        btn.disabled = userSpellingFavorites.length < 5;
    }

    container.innerHTML = `
        ${userSpellingFavorites.length < 5 ? `
            <div class="loading">
                You have ${userSpellingFavorites.length} favorite(s). Add at least ${5 - userSpellingFavorites.length} more to generate a quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userSpellingFavorites.map(fav => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeSpellingFavorite('${fav.id}')">√ó</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">üìù ${fav.word}</h3>
                    ${fav.userAnswer && fav.userAnswer !== '' ? `
                    <p style="color: #666; margin: 5px 0;"><strong>Your answer:</strong> ${fav.userAnswer}</p>
                     ` : `
                    <p style="color: #666; margin: 5px 0; font-style: italic;">Added for practice</p>
                    `}
                    <p style="color: ${fav.wasCorrect ? '#28a745' : '#dc3545'}; margin-top: 10px; font-weight: bold;">
                        ${fav.wasCorrect ? '‚úÖ Spelled Correctly' : '‚ùå Needs Practice'}
                    </p>
                </div>
            `).join('')}
        </div>
    `;
}

async function removeSpellingFavorite(id) {
    if (!currentUser) return;

    await db.collection('users').doc(currentUser.uid).collection('spellingFavorites').doc(id).delete();
    userSpellingFavorites = userSpellingFavorites.filter(fav => fav.id !== id);
    displaySpellingFavorites();
}

async function startSpellingFavoritesQuiz() {
    if (userSpellingFavorites.length < 5) {
        alert('You need at least 5 spelling favorites to generate a quiz');
        return;
    }

    navigateTo('spelling', true);
    
    const selected = [...userSpellingFavorites].sort(() => 0.5 - Math.random()).slice(0, Math.min(10, userSpellingFavorites.length));
    
    spellingWords = selected.map(fav => fav.word);
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    document.querySelector('#spelling-container .welcome-section').style.display = 'none';
    document.getElementById('spelling-game').style.display = 'block';
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

// ===== SPELLING INCORRECT FUNCTIONS =====
async function loadUserSpellingIncorrect(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('spellingIncorrect').get();
        userSpellingIncorrect = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displaySpellingIncorrect();
        
        const btn = document.getElementById('spellingIncorrectQuizBtn');
        if (btn) {
            btn.disabled = userSpellingIncorrect.length < 5;
        }
    } catch (error) {
        console.error('Error loading spelling incorrect:', error);
    }
}

async function saveSpellingIncorrect(word, userAnswer) {
    if (!currentUser) return;
    
    try {
        const incorrectRef = db.collection('users').doc(currentUser.uid).collection('spellingIncorrect');
        
        await incorrectRef.add({
            word: word,
            userAnswer: userAnswer,
            savedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        userSpellingIncorrect.push({
            word: word,
            userAnswer: userAnswer
        });
        
        displaySpellingIncorrect();
    } catch (error) {
        console.error('Error saving spelling incorrect:', error);
    }
}

function displaySpellingIncorrect() {
    const container = document.getElementById('spelling-incorrect-container');
    const btn = document.getElementById('spellingIncorrectQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to track spelling mistakes</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userSpellingIncorrect.length === 0) {
        container.innerHTML = '<div class="loading">No spelling mistakes yet. Practice spelling to track your progress!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (btn) {
        btn.disabled = userSpellingIncorrect.length < 5;
    }

    container.innerHTML = `
        ${userSpellingIncorrect.length < 5 ? `
            <div class="loading">
                You have ${userSpellingIncorrect.length} mistake(s). Add at least ${5 - userSpellingIncorrect.length} more to generate a practice quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userSpellingIncorrect.map((inc, index) => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeSpellingIncorrect('${inc.id || index}')">√ó</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">üìù ${inc.word}</h3>
                    <p style="color: #dc3545; margin: 5px 0;"><strong>Your answer:</strong> ${inc.userAnswer}</p>
                    <p style="color: #28a745; margin-top: 10px;"><strong>Correct spelling:</strong> ${inc.word}</p>
                </div>
            `).join('')}
        </div>
    `;
}

async function removeSpellingIncorrect(id) {
    if (!currentUser) return;

    await db.collection('users').doc(currentUser.uid).collection('spellingIncorrect').doc(id).delete();
    userSpellingIncorrect = userSpellingIncorrect.filter(inc => inc.id !== id);
    displaySpellingIncorrect();
}

async function startSpellingIncorrectQuiz() {
    if (userSpellingIncorrect.length < 5) {
        alert('You need at least 5 spelling mistakes to generate a practice quiz');
        return;
    }

    navigateTo('spelling', true);
    
    const selected = [...userSpellingIncorrect].sort(() => 0.5 - Math.random()).slice(0, Math.min(10, userSpellingIncorrect.length));
    
    spellingWords = selected.map(inc => inc.word);
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    document.querySelector('#spelling-container .welcome-section').style.display = 'none';
    document.getElementById('spelling-game').style.display = 'block';
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

async function addCurrentSpellingToFavorites() {
    if (!currentUser) {
        alert('Please sign in to save favorites');
        return;
    }
    
    if (!currentSpellingWord) return;
    
    const btn = document.getElementById('add-spelling-favorite-btn');
    const originalText = btn.textContent;
    
    btn.textContent = '‚è≥ Saving...';
    btn.disabled = true;
    
    try {
        await saveSpellingFavorite(currentSpellingWord, '', false);
        btn.textContent = '‚úÖ Added!';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
    } catch (error) {
        console.error('Error saving favorite:', error);
        btn.textContent = '‚ùå Failed';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
    }
}



        // ===== DASHBOARD FUNCTIONS =====
async function goToUserDashboard() {
    if (!currentUser) {
        showAuthModal();
        return;
    }
    
    // Navigate to dashboard first
    navigateTo('student-dashboard');
    
    // Then load user data (with loading state)
    await loadUserDashboard();
}

async function loadUserDashboard() {
    if (!currentUser) return;
    
    try {
        // Show loading state
        document.getElementById('dashboard-name').textContent = 'Loading...';
        document.getElementById('dashboard-email').textContent = 'Loading...';
        
        // Get user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        // ‚úÖ CHECK IF USER IS A COACH
        const isCoach = userData?.userType === 'coach';
        
        // Update dashboard header
        const displayName = userData?.name || currentUser.displayName || isCoach ? 'Coach' : 'Student';
        document.getElementById('dashboard-name').textContent = displayName;
        document.getElementById('dashboard-email').textContent = userData?.email || currentUser.email || '';
        
        // Update avatar with Google photo or initials
        const dashboardAvatar = document.getElementById('dashboard-avatar');
        if (currentUser.photoURL) {
            dashboardAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            dashboardAvatar.textContent = '';
        } else {
            dashboardAvatar.style.backgroundImage = 'none';
            dashboardAvatar.textContent = displayName.charAt(0).toUpperCase();
        }
        
        // Format join date
        if (userData?.createdAt) {
            const joinDate = userData.createdAt.toDate();
            document.getElementById('dashboard-join-date').textContent = 
                `Member since: ${joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;
            document.getElementById('display-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            document.getElementById('dashboard-join-date').textContent = 'Member since: Recently joined';
            document.getElementById('display-joined').textContent = 'Recently joined';
        }
        
        // Update profile fields
        document.getElementById('display-name').textContent = displayName;
        document.getElementById('edit-name').value = displayName;
        
        document.getElementById('display-email').textContent = userData?.email || currentUser.email || 'N/A';
        
        // ‚úÖ HIDE/SHOW STUDENT ID BASED ON USER TYPE
        const studentIdRow = document.querySelector('.profile-field:has(#display-student-id)');
        if (isCoach) {
            if (studentIdRow) studentIdRow.style.display = 'none';
        } else {
            if (studentIdRow) studentIdRow.style.display = 'flex';
            const studentId = userData?.studentId || `WB-2025-${currentUser.uid.slice(-4).toUpperCase()}`;
            document.getElementById('display-student-id').textContent = studentId;
        }
        
        document.getElementById('display-age').textContent = userData?.age || 'Not specified';
        document.getElementById('edit-age').value = userData?.age || '';
        
        document.getElementById('display-country').textContent = userData?.country || 'Not specified';
        document.getElementById('edit-country').value = userData?.country || '';
        
        document.getElementById('display-usertype').textContent = 
            userData?.userType ? userData.userType.charAt(0).toUpperCase() + userData.userType.slice(1) : 'Student';
        
       // ===== COACH-SPECIFIC RESTRICTIONS =====
if (isCoach) {
    // Hide edit button for coaches
    document.getElementById('edit-profile-btn').style.display = 'none';
    
    // Hide delete account option for coaches
    const deleteAccountOption = document.querySelector('.setting-item[onclick="confirmDeleteAccount()"]');
    if (deleteAccountOption) {
        deleteAccountOption.style.display = 'none';
    }
    
    // ‚úÖ HIDE ONLY SPELLING INCORRECT AND QUIZ INCORRECT FOR COACHES
    const allStatCards = document.querySelectorAll('.dashboard-card');
    allStatCards.forEach(card => {
        const label = card.querySelector('.card-label');
        if (label) {
            const text = label.textContent;
            if (text.includes('MISTAKES') || text.includes('INCORRECT')) {
                card.style.display = 'none';
            }
        }
    });
    
    // ‚úÖ HIDE SUBSCRIPTION STATUS FOR COACHES
    const subscriptionSection = document.querySelector('.dashboard-section:has(#sub-status-icon)');
    if (subscriptionSection) {
        subscriptionSection.style.display = 'none';
    }
            
        } else {
            // Show everything for students
            document.getElementById('edit-profile-btn').style.display = 'inline-block';
            
            const deleteAccountOption = document.querySelector('.setting-item[onclick="confirmDeleteAccount()"]');
            if (deleteAccountOption) {
                deleteAccountOption.style.display = 'flex';
            }
            
            // Show quick stats for students
            const quickStatsSection = document.querySelector('.dashboard-section:has(.dashboard-grid)');
            if (quickStatsSection) {
                quickStatsSection.style.display = 'block';
            }
            
            // Show subscription status for students
            const subscriptionSection = document.querySelector('.dashboard-section:has(#sub-status-icon)');
            if (subscriptionSection) {
                subscriptionSection.style.display = 'block';
            }
        }
        
        // Update stats (wait for them to be loaded)
setTimeout(() => {
    // ‚úÖ UPDATE FAVORITES FOR EVERYONE (including coaches)
    const quizFavElement = document.getElementById('stat-quiz-favorites');
    const spellingFavElement = document.getElementById('stat-spelling-favorites');
    
    if (quizFavElement) quizFavElement.textContent = userFavorites.length;
    if (spellingFavElement) spellingFavElement.textContent = userSpellingFavorites.length;
    
    // ‚úÖ ONLY UPDATE INCORRECT STATS FOR STUDENTS
    if (!isCoach) {
        const quizIncorrectElement = document.getElementById('stat-quiz-incorrect');
        const spellingIncorrectElement = document.getElementById('stat-spelling-incorrect');
        
        if (quizIncorrectElement) quizIncorrectElement.textContent = userIncorrect.length;
        if (spellingIncorrectElement) spellingIncorrectElement.textContent = userSpellingIncorrect.length;
        
        // Update subscription status
        updateDashboardSubscriptionStatus();
    }
}, 500);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('dashboard-name').textContent = 'Error loading profile';
        document.getElementById('dashboard-email').textContent = 'Please try refreshing';
    }
}
        
        // ===== PASSWORD CHANGE FUNCTIONS =====
function showChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.add('active');
    
    // Clear form
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}

function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('active');
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}

async function handleChangePassword(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Please sign in to change password');
        return;
    }
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-new-password').value;
    
    const errorDiv = document.getElementById('change-password-error');
    const successDiv = document.getElementById('change-password-success');
    
    // Hide previous messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'New passwords do not match!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate new password is different
    if (currentPassword === newPassword) {
        errorDiv.textContent = 'New password must be different from current password!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate password strength
    if (newPassword.length < 6) {
        errorDiv.textContent = 'New password must be at least 6 characters!';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Re-authenticate user with current password
        const credential = firebase.auth.EmailAuthProvider.credential(
            currentUser.email,
            currentPassword
        );
        
        await currentUser.reauthenticateWithCredential(credential);
        
        // Update password
        await currentUser.updatePassword(newPassword);
        
        // Success!
        successDiv.textContent = '‚úÖ Password changed successfully!';
        successDiv.style.display = 'block';
        
        // Clear form
        document.getElementById('change-password-form').reset();
        
        // Close modal after 2 seconds
        setTimeout(() => {
            closeChangePasswordModal();
        }, 2000);
        
    } catch (error) {
        console.error('Error changing password:', error);
        
        let errorMessage = 'Failed to change password. ';
        
        if (error.code === 'auth/wrong-password') {
            errorMessage += 'Current password is incorrect.';
        } else if (error.code === 'auth/weak-password') {
            errorMessage += 'New password is too weak.';
        } else if (error.code === 'auth/requires-recent-login') {
            errorMessage += 'Please sign out and sign in again, then try changing your password.';
        } else {
            errorMessage += error.message;
        }
        
        errorDiv.textContent = errorMessage;
        errorDiv.style.display = 'block';
    }
}

// Special handling for Google sign-in users
async function handlePasswordChangeForGoogleUsers() {
    if (currentUser && currentUser.providerData.length > 0) {
        const provider = currentUser.providerData[0].providerId;
        
        if (provider === 'google.com') {
            alert('You signed in with Google. To change your password, please go to your Google Account settings.');
            return true; // Indicates Google user
        }
    }
    return false; // Not a Google user
}

// Update showChangePasswordModal to check for Google users
function showChangePasswordModal() {
    // Check if user signed in with Google
    if (currentUser && currentUser.providerData.length > 0) {
        const provider = currentUser.providerData[0].providerId;
        
        if (provider === 'google.com') {
            alert('üîê You signed in with Google.\n\nTo change your password, please visit:\nhttps://myaccount.google.com/security');
            return;
        }
    }
    
    document.getElementById('changePasswordModal').classList.add('active');
    
    // Clear form
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}
        
async function toggleEditMode() {
    // Check if user is a coach
    if (currentUser) {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData?.userType === 'coach') {
                alert('üõ°Ô∏è Coach profiles cannot be edited.\n\nFor security reasons, coach account information is locked after ID verification.\n\nPlease contact support if you need to update your information.');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // Hide display elements, show edit inputs (for students only)
    document.getElementById('display-name').style.display = 'none';
    document.getElementById('edit-name').style.display = 'block';
    
    document.getElementById('display-age').style.display = 'none';
    document.getElementById('edit-age').style.display = 'block';
    
    document.getElementById('display-country').style.display = 'none';
    document.getElementById('edit-country').style.display = 'block';
    
    // Toggle buttons
    document.getElementById('edit-profile-btn').style.display = 'none';
    document.getElementById('save-profile-btn').style.display = 'inline-block';
    document.getElementById('cancel-edit-btn').style.display = 'inline-block';
}

function cancelEditMode() {
    // Show display elements, hide edit inputs
    document.getElementById('display-name').style.display = 'inline';
    document.getElementById('edit-name').style.display = 'none';
    
    document.getElementById('display-age').style.display = 'inline';
    document.getElementById('edit-age').style.display = 'none';
    
    document.getElementById('display-country').style.display = 'inline';
    document.getElementById('edit-country').style.display = 'none';
    
    // Toggle buttons
    document.getElementById('edit-profile-btn').style.display = 'inline-block';
    document.getElementById('save-profile-btn').style.display = 'none';
    document.getElementById('cancel-edit-btn').style.display = 'none';
    
    document.getElementById('profile-form').classList.remove('edit-mode');
}

async function saveProfile() {
    if (!currentUser) return;
    
    const newName = document.getElementById('edit-name').value.trim();
    const newAge = document.getElementById('edit-age').value;
    const newCountry = document.getElementById('edit-country').value;
    
    if (!newName) {
        alert('Name cannot be empty');
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            name: newName,
            age: newAge,
            country: newCountry
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: newName });
        
        // Update UI
        document.getElementById('display-name').textContent = newName;
        document.getElementById('display-age').textContent = newAge;
        document.getElementById('display-country').textContent = newCountry;
        
        // Update dashboard header
        document.getElementById('dashboard-name').textContent = newName;
        const dashboardAvatar = document.getElementById('dashboard-avatar');
        if (currentUser.photoURL) {
            dashboardAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            dashboardAvatar.textContent = '';
        } else {
            dashboardAvatar.style.backgroundImage = 'none';
            dashboardAvatar.textContent = newName.charAt(0).toUpperCase();
        }
        
        // Update sidebar
        document.getElementById('sidebarUserName').textContent = newName;
        const sidebarAvatar = document.getElementById('sidebarUserAvatar');
        if (currentUser.photoURL) {
            sidebarAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            sidebarAvatar.textContent = '';
        } else {
            sidebarAvatar.style.backgroundImage = 'none';
            sidebarAvatar.textContent = newName.charAt(0).toUpperCase();
        }
        
        cancelEditMode();
        alert('Profile updated successfully!');
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
}

        function showChangePasswordModal() {
    alert('Change password feature coming soon! For now, you can reset your password using the "Forgot Password" link on the sign-in page.');
}

async function confirmDeleteAccount() {
    if (!currentUser) return;
    
    // Check if user is a coach
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData?.userType === 'coach') {
            alert('üõ°Ô∏è Coach accounts cannot be deleted.\n\nFor security and compliance reasons, coach accounts must be deactivated by an administrator.\n\nPlease contact support if you need to deactivate your account.');
            return;
        }
    } catch (error) {
        console.error('Error checking user type:', error);
    }
    
    // Proceed with deletion for non-coach users
    if (confirm('‚ö†Ô∏è WARNING: This will permanently delete your account and all your data. This action cannot be undone.\n\nAre you absolutely sure?')) {
        if (confirm('Final confirmation: Delete your account forever?')) {
            deleteUserAccount();
        }
    }
}

async function deleteUserAccount() {
    if (!currentUser) return;
    
    try {
        // Delete user data from Firestore
        await db.collection('users').doc(currentUser.uid).delete();
        
        // Delete user subcollections
        const collections = ['favorites', 'incorrectQuestions', 'spellingFavorites', 'spellingIncorrect'];
        for (const collection of collections) {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection(collection).get();
            const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);
        }
        
        // Delete Firebase Auth account
        await currentUser.delete();
        
        alert('Your account has been successfully deleted.');
        navigateTo('home');
    } catch (error) {
        console.error('Error deleting account:', error);
        alert('Failed to delete account: ' + error.message);
    }
}

     function typeKey(letter) {
    const input = document.getElementById('spelling-input');
    if (input.disabled) return;
    input.value += letter.toLowerCase();
}

function backspaceKey() {
    const input = document.getElementById('spelling-input');
    if (input.disabled) return;
    input.value = input.value.slice(0, -1);
}  

// ===== UNSCRAMBLE FUNCTIONS =====
async function startUnscrambleWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection and show loading
    document.getElementById('unscramble-level-selection').style.display = 'none';
    const gameContainer = document.getElementById('unscramble-game');
    gameContainer.innerHTML = '<div class="loading">üìö Loading ' + level.toUpperCase() + ' words...</div>';
    gameContainer.style.display = 'block';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    // Select 10 random words from the entire level (no difficulty filtering)
    if (allWords.length < 10) {
        alert('Not enough words in this level. Try another level.');
        document.getElementById('unscramble-level-selection').style.display = 'block';
        gameContainer.style.display = 'none';
        return;
    }
    
    const shuffled = [...allWords].sort(() => 0.5 - Math.random());
    unscrambleWords = shuffled.slice(0, 10);
    
    currentUnscrambleIndex = 0;
    unscrambleScore = 0;
    hintsUsed = 0;
    
    // Clear the loading message and restore the game UI
    gameContainer.innerHTML = `
        <div class="quiz-question-card">
            <div class="quiz-score" id="unscramble-score">Score: 0 / 0</div>
            <h3 id="unscramble-progress">Word 1 of 10</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                
                <div id="letter-tiles" class="letter-tiles-container">
                    <!-- Letter tiles will be inserted here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="shuffleLetters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                        üîÄ Shuffle
                    </button>
                    
                    <button class="practice-btn" onclick="showUnscrambleHint()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px; background: #17a2b8;">
                        üí° Hint
                    </button>
                    
                    <button class="practice-btn" onclick="submitUnscramble()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ‚úì Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="unscramble-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
    
    document.getElementById('unscramble-results').style.display = 'none';
    
    loadUnscrambleWord();
}
function backToUnscrambleLevelSelection() {
    document.getElementById('unscramble-level-selection').style.display = 'block';
    document.getElementById('unscramble-game').style.display = 'none';
    document.getElementById('unscramble-results').style.display = 'none';
    selectedGameLevel = '';
}

// Keep old function for backwards compatibility
function startUnscramble() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    startUnscrambleWithLevel(selectedGameLevel);
}
        
function loadUnscrambleWord() {
    currentUnscrambleWord = unscrambleWords[currentUnscrambleIndex];
    hintsUsed = 0;
    
    document.getElementById('unscramble-progress').textContent = 
        `Word ${currentUnscrambleIndex + 1} of ${unscrambleWords.length}`;
    document.getElementById('unscramble-score').textContent = 
        `Score: ${unscrambleScore} / ${currentUnscrambleIndex}`;
    document.getElementById('unscramble-feedback').innerHTML = '';
    
    // Scramble and display letters
    shuffleLetters();
}

function shuffleLetters() {
    const letters = currentUnscrambleWord.split('');
    let scrambled = [...letters];
    
    // Shuffle the array
    let attempts = 0;
    do {
        for (let i = scrambled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
        }
        attempts++;
    } while (scrambled.join('') === currentUnscrambleWord && attempts < 10);
    
    currentLetterOrder = scrambled;
    renderLetterTiles();
}

function renderLetterTiles() {
    const container = document.getElementById('letter-tiles');
    container.innerHTML = '';
    
    currentLetterOrder.forEach((letter, index) => {
        const tile = document.createElement('div');
        tile.className = 'letter-tile';
        tile.textContent = letter.toUpperCase();
        tile.draggable = true;
        tile.dataset.index = index;
        
        // Drag events
        tile.addEventListener('dragstart', handleDragStart);
        tile.addEventListener('dragend', handleDragEnd);
        tile.addEventListener('dragover', handleDragOver);
        tile.addEventListener('drop', handleDrop);
        tile.addEventListener('dragenter', handleDragEnter);
        tile.addEventListener('dragleave', handleDragLeave);
        
        // Touch events for mobile
        tile.addEventListener('touchstart', handleTouchStart, { passive: false });
        tile.addEventListener('touchmove', handleTouchMove, { passive: false });
        tile.addEventListener('touchend', handleTouchEnd);
        
        container.appendChild(tile);
    });
}

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    
    // Remove drag-over class from all tiles
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    this.classList.remove('drag-over');
    
    if (draggedElement !== this) {
        const draggedIndex = parseInt(draggedElement.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        
        // Swap letters in the array
        [currentLetterOrder[draggedIndex], currentLetterOrder[targetIndex]] = 
        [currentLetterOrder[targetIndex], currentLetterOrder[draggedIndex]];
        
        // Re-render
        renderLetterTiles();
    }
    
    return false;
}

// Touch support for mobile
let touchTarget = null;
let touchClone = null;

function handleTouchStart(e) {
    e.preventDefault();
    touchTarget = this;
    this.classList.add('dragging');
    
    // Create a clone for visual feedback
    touchClone = this.cloneNode(true);
    touchClone.style.position = 'fixed';
    touchClone.style.zIndex = '10000';
    touchClone.style.pointerEvents = 'none';
    touchClone.style.opacity = '0.8';
    document.body.appendChild(touchClone);
    
    updateTouchClonePosition(e.touches[0]);
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!touchTarget) return;
    
    updateTouchClonePosition(e.touches[0]);
    
    // Find element under touch
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    // Remove drag-over from all
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    // Add drag-over to element below
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== touchTarget) {
        elementBelow.classList.add('drag-over');
    }
}

function handleTouchEnd(e) {
    e.preventDefault();
    if (!touchTarget) return;
    
    touchTarget.classList.remove('dragging');
    
    // Remove clone
    if (touchClone) {
        touchClone.remove();
        touchClone = null;
    }
    
    // Find element under touch
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== touchTarget) {
        const draggedIndex = parseInt(touchTarget.dataset.index);
        const targetIndex = parseInt(elementBelow.dataset.index);
        
        // Swap letters
        [currentLetterOrder[draggedIndex], currentLetterOrder[targetIndex]] = 
        [currentLetterOrder[targetIndex], currentLetterOrder[draggedIndex]];
        
        // Re-render
        renderLetterTiles();
    }
    
    // Remove drag-over from all
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    touchTarget = null;
}

function updateTouchClonePosition(touch) {
    if (touchClone) {
        touchClone.style.left = (touch.clientX - 30) + 'px';
        touchClone.style.top = (touch.clientY - 30) + 'px';
    }
}

async function showUnscrambleHint() {
    hintsUsed++;
    const feedbackDiv = document.getElementById('unscramble-feedback');
    
    feedbackDiv.innerHTML = '<div class="loading">üí° Loading hint...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentUnscrambleWord);
        
        let hintText = '';
        if (hintsUsed === 1) {
            // First hint: Show first letter
            hintText = `The word starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else if (hintsUsed === 2) {
            // Second hint: Show word length and first letter
            hintText = `The word has <strong>${currentUnscrambleWord.length} letters</strong> and starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else {
            // Third hint: Show definition
            hintText = `<strong>Definition:</strong> ${wordDetails.definition || 'A word you should know!'}`;
        }
        
        feedbackDiv.innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">üí° Hint ${hintsUsed}:</strong>
                <p style="color: #856404; margin-top: 8px;">${hintText}</p>
            </div>
        `;
    } catch (error) {
        console.error('Error showing hint:', error);
        let hintText = '';
        if (hintsUsed === 1) {
            hintText = `The word starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else {
            hintText = `The word has <strong>${currentUnscrambleWord.length} letters</strong>`;
        }
        
        feedbackDiv.innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">üí° Hint:</strong>
                <p style="color: #856404; margin-top: 8px;">${hintText}</p>
            </div>
        `;
    }
}

async function submitUnscramble() {
    const userWord = currentLetterOrder.join('').toLowerCase();
    const correctWord = currentUnscrambleWord.toLowerCase();
    const feedbackDiv = document.getElementById('unscramble-feedback');
    
    if (userWord === correctWord) {
        unscrambleScore++;
        
        feedbackDiv.innerHTML = '<div class="loading">‚úÖ Correct! Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentUnscrambleWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    ‚úÖ <strong>Correct!</strong> The word is: <strong>${currentUnscrambleWord}</strong>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üîä Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üìú Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">üìù Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    ‚úÖ <strong>Correct!</strong> The word is: <strong>${currentUnscrambleWord}</strong>
                    
                    <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        }
    } else {
        feedbackDiv.innerHTML = `
            <div class="feedback error">
                ‚ùå <strong>Incorrect.</strong> The correct word is: <strong>${correctWord.toUpperCase()}</strong>
                <p style="margin-top: 10px;">Your answer: <strong>${userWord.toUpperCase()}</strong></p>
                
                <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    ‚û°Ô∏è Next Word
                </button>
            </div>
        `;
    }
}

        
function nextUnscrambleWord() {
    currentUnscrambleIndex++;
    if (currentUnscrambleIndex < unscrambleWords.length) {
        loadUnscrambleWord();
    } else {
        showUnscrambleResults();
    }
}

function showUnscrambleResults() {
    document.getElementById('unscramble-game').style.display = 'none';
    const resultsDiv = document.getElementById('unscramble-results');
    resultsDiv.style.display = 'block';
    
    const percentage = Math.round((unscrambleScore / unscrambleWords.length) * 100);
    
    let message = '';
    let emoji = '';
    
    if (percentage >= 90) {
        message = 'Outstanding! You\'re a word master!';
        emoji = 'üèÜ';
    } else if (percentage >= 70) {
        message = 'Great job! Keep it up!';
        emoji = '‚≠ê';
    } else if (percentage >= 50) {
        message = 'Good effort! Practice makes perfect!';
        emoji = 'üëç';
    } else {
        message = 'Keep practicing! You\'ll improve!';
        emoji = 'üìö';
    }
    
    resultsDiv.innerHTML = `
        <div class="quiz-question-card" style="text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
            <h2>Unscramble Complete!</h2>
            <div class="quiz-score">Final Score: ${unscrambleScore} / ${unscrambleWords.length}</div>
            <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
            <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
            <button class="practice-btn" onclick="startUnscrambleWithLevel()">üîÑ Try Again</button>
            <button class="practice-btn" onclick="backToUnscrambleLevelSelection()">‚Üê Back to Levels</button>
            <button class="practice-btn" onclick="navigateTo('home')">üè† Home</button>
           </div>
        </div>
    `;
}

function restartUnscrambleSection() {
    document.getElementById('unscramble-game').style.display = 'none';
    document.getElementById('unscramble-results').style.display = 'none';
    document.getElementById('unscramble-level-selection').style.display = 'block';
    selectedGameLevel = '';
}

   // ===== COACHES DISPLAY FUNCTIONS =====
async function loadAndDisplayCoaches() {
    const container = document.getElementById('coaches-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading coaches...</div>';
        
        console.log('üîç Fetching coaches from Firestore...');
        
        // Fetch all coaches from Firestore
        const coachesSnapshot = await db.collection('users')
            .where('userType', '==', 'coach')
            .get();
        
        console.log('üìä Found coaches:', coachesSnapshot.size);
        
        if (coachesSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üë®‚Äçüè´</div>
                    <h3>No coaches registered yet</h3>
                    <p>Be the first to join as a coach!</p>
                </div>
            `;
            return;
        }
        
        const coaches = [];
        coachesSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Coach:', doc.id, data.name, data.photoURL);
            coaches.push({ id: doc.id, ...data });
        });
        
        // Sort coaches (newest first)
        coaches.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate stats
        const totalCoaches = coaches.length;
        const verifiedCoaches = coaches.filter(c => c.idVerified).length;
        const pendingCoaches = totalCoaches - verifiedCoaches;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Cards -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalCoaches}</div>
                    <div class="stat-label">Total Coaches</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${verifiedCoaches}</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${pendingCoaches}</div>
                    <div class="stat-label">‚è≥ Pending</div>
                </div>
            </div>
            
            <!-- Coaches Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üë®‚Äçüè´ Coach</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => {
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (coach.photoURL) {
                                avatarStyle = `style="background-image: url('${coach.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (coach.name || 'C').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showCoachDetailById('${coach.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${coach.name || 'Unknown Coach'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        ${coach.idVerified ? 
                                            '<span class="verified-badge">Verified</span>' : 
                                            '<span class="unverified-badge">‚è≥ Pending</span>'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">üõ°Ô∏è Safety & Verification</h3>
                <p style="color: #666; line-height: 1.6;">
                    All coaches on WordBiz Coaching Academy undergo ID verification for student safety. 
                    Click on any coach to view their full profile and verification details.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading coaches:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading coaches. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayCoaches()">üîÑ Retry</button>
            </div>
        `;
    }
}

// Load and show coach profile modal
async function showCoachDetailById(coachId) {
    try {
        console.log('üìã Loading coach details for:', coachId);
        const coachDoc = await db.collection('users').doc(coachId).get();
        
        if (coachDoc.exists) {
            const coach = { id: coachDoc.id, ...coachDoc.data() };
            console.log('Coach data loaded:', coach);
            showCoachDetail(coach);
        } else {
            console.error('‚ùå Coach not found');
            alert('Coach profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading coach details:', error);
        alert('Unable to load coach details: ' + error.message);
    }
}

// Display coach detail modal
function showCoachDetail(coach) {
    console.log('Displaying coach modal:', coach.name);
    const modal = document.getElementById('coachDetailModal');
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-coach-avatar');
    if (coach.photoURL) {
        console.log('üñºÔ∏è Setting photo URL:', coach.photoURL);
        avatar.style.backgroundImage = `url('${coach.photoURL}')`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.textContent = '';
    } else {
        console.log('üî§ No photo URL, using initial');
        avatar.style.backgroundImage = 'none';
        avatar.textContent = (coach.name || 'C').charAt(0).toUpperCase();
    }
    
    // Update name
    document.getElementById('modal-coach-name').textContent = coach.name || 'Unknown Coach';
    
    // Update status badge
    const statusBadge = document.getElementById('modal-coach-status');
    if (coach.idVerified) {
        statusBadge.className = 'status-badge verified';
        statusBadge.textContent = 'Verified';
    } else {
        statusBadge.className = 'status-badge pending';
        statusBadge.textContent = '‚è≥ Pending Verification';
    }
    
    // Update email
    document.getElementById('modal-coach-email').textContent = coach.email || 'N/A';
    
    // Update organization
    document.getElementById('modal-coach-organization').textContent = coach.organization || 'Independent';
    
    // Update joined date
    if (coach.createdAt) {
        const joinDate = coach.createdAt.toDate();
        document.getElementById('modal-coach-joined').textContent = 
            joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } else {
        document.getElementById('modal-coach-joined').textContent = 'Recently';
    }
    
    // Show/hide age if available
    const ageRow = document.getElementById('modal-coach-age-row');
    if (coach.verifiedAge) {
        ageRow.style.display = 'flex';
        document.getElementById('modal-coach-age').textContent = coach.verifiedAge + ' years old';
    } else {
        ageRow.style.display = 'none';
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('Modal displayed');
}

// Close coach detail modal
function closeCoachDetailModal() {
    document.getElementById('coachDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('coachDetailModal');
    if (event.target === modal) {
        closeCoachDetailModal();
    }
});

     
// ===== STUDENTS DISPLAY FUNCTIONS =====
async function loadAndDisplayStudents() {
    const container = document.getElementById('students-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading students...</div>';
        
        console.log('üîç Fetching students from Firestore...');
        
        // Fetch all students from Firestore
        const studentsSnapshot = await db.collection('users')
            .where('userType', '==', 'student')
            .get();
        
        console.log('üìä Found students:', studentsSnapshot.size);
        
        if (studentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üéì</div>
                    <h3>No students registered yet</h3>
                    <p>Be the first to join as a student!</p>
                </div>
            `;
            return;
        }
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Student:', doc.id, data.name, data.photoURL);
            students.push({ id: doc.id, ...data });
        });
        
        // Sort students (newest first)
        students.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate total students
        const totalStudents = students.length;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Card -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            </div>
            
            <!-- Students Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üéì Student</th>
                            <th>üÜî Student ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => {
                            // Generate Student ID (WB-2025-XXXX)
                            const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
                            
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (student.photoURL) {
                                avatarStyle = `style="background-image: url('${student.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (student.name || 'S').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showStudentDetailById('${student.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${student.name || 'Student'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span style="font-family: monospace; background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: #0d3b66;">
                                            ${studentId}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                <h3 style="color: white; margin-bottom: 10px;">üåü Growing Community</h3>
                <p style="color: rgba(255,255,255,0.95); line-height: 1.6;">
                    Our students are learning from coaches around the world, building vocabulary skills 
                    through interactive quizzes, spelling challenges, and personalized practice sessions.
                    Click on any student to view their full profile.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading students:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading students. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayStudents()">üîÑ Retry</button>
            </div>
        `;
    }
}
        
// Load and show student profile modal
async function showStudentDetailById(studentId) {
    try {
        console.log('üìã Loading student details for:', studentId);
        const studentDoc = await db.collection('users').doc(studentId).get();
        
        if (studentDoc.exists) {
            const student = { id: studentDoc.id, ...studentDoc.data() };
            console.log('Student data loaded:', student);
            showStudentDetail(student);
        } else {
            console.error('‚ùå Student not found');
            alert('Student profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading student details:', error);
        alert('Unable to load student details: ' + error.message);
    }
}

// Display student detail modal
function showStudentDetail(student) {
    console.log('Displaying student modal:', student.name);
    const modal = document.getElementById('studentDetailModal');
    
    // Generate Student ID
    const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-student-avatar');
    if (student.photoURL) {
        console.log('üñºÔ∏è Setting photo URL:', student.photoURL);
        avatar.style.backgroundImage = `url('${student.photoURL}')`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.textContent = '';
    } else {
        console.log('üî§ No photo URL, using initial');
        avatar.style.backgroundImage = 'none';
        avatar.textContent = (student.name || 'S').charAt(0).toUpperCase();
    }
    
    // Update name
    document.getElementById('modal-student-name').textContent = student.name || 'Student';
    
    // Update Student ID (both places)
    document.getElementById('modal-student-id').textContent = studentId;
    document.getElementById('modal-student-id-display').textContent = studentId;
    
    // Update email
    document.getElementById('modal-student-email').textContent = student.email || 'N/A';
    
    // Update age
    const ageRow = document.getElementById('modal-student-age-row');
    if (student.age) {
        ageRow.style.display = 'flex';
        document.getElementById('modal-student-age').textContent = student.age + ' years old';
    } else {
        ageRow.style.display = 'none';
    }
    
    // Update country
    document.getElementById('modal-student-country').textContent = student.country || 'N/A';
    
    // Update joined date
    if (student.createdAt) {
        const joinDate = student.createdAt.toDate();
        document.getElementById('modal-student-joined').textContent = 
            joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } else {
        document.getElementById('modal-student-joined').textContent = 'Recently';
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('Modal displayed');
}

// Close student detail modal
function closeStudentDetailModal() {
    document.getElementById('studentDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('studentDetailModal');
    if (event.target === modal) {
        closeStudentDetailModal();
    }
});

// ===== LIVE SPELLING FUNCTIONS =====
let presenceInitializing = false; // ADD this at the top with other globals

async function initializeOnlinePresence() {
    if (!currentUser) return;
    
    // IMPROVED: Check both initialized and initializing
    if (presenceInitialized || presenceInitializing) {
        console.log('Presence already initialized or initializing');
        return;
    }
    
    presenceInitializing = true;
    console.log('‚úÖ Initializing online presence for:', currentUser.uid);
    
    try {
        // Set user as online
        presenceRef = db.collection('onlineUsers').doc(currentUser.uid);
        
        await presenceRef.set({
            userId: currentUser.uid,
            name: currentUser.displayName || 'Student',
            photoURL: currentUser.photoURL || null,
            status: 'online',
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Listen for incoming challenges (only once)
        listenForChallenges();
        
        // Listen for MY challenges being accepted (only once)
        listenForMyChallengesAccepted();
        
        // Update presence every 30 seconds
        setInterval(async () => {
            if (currentUser && presenceRef) {
                try {
                    await presenceRef.update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating presence:', error);
                }
            }
        }, 30000);
        
        presenceInitialized = true;
        console.log('‚úÖ Presence initialized successfully');
    } catch (error) {
        console.error('‚ùå Error initializing presence:', error);
        presenceInitialized = false;
    } finally {
        presenceInitializing = false; // ALWAYS reset this flag
    }
}

async function removeOnlinePresence() {
    try {
        console.log('üßπ Removing online presence...');
        
        // Remove ALL challenge listeners
        if (challengeListener) {
            challengeListener();
            challengeListener = null;
        }
        if (myChallengeListener) {
            myChallengeListener();
            myChallengeListener = null;
        }
        if (onlineUsersRef) {
            onlineUsersRef();
            onlineUsersRef = null;
        }
        // ‚úÖ ADD QUIZ LISTENERS TOO
        if (quizChallengeListener) {
            quizChallengeListener();
            quizChallengeListener = null;
        }
        if (myQuizChallengeListener) {
            myQuizChallengeListener();
            myQuizChallengeListener = null;
        }
        if (quizOnlineUsersRef) {
            quizOnlineUsersRef();
            quizOnlineUsersRef = null;
        }
        
        // Remove from online users
        if (presenceRef) {
            await presenceRef.delete();
            presenceRef = null;
        }
        
        // Reset flags
        presenceInitialized = false;
        presenceInitializing = false; // ADD THIS
        
        console.log('‚úÖ Presence removed successfully');
    } catch (error) {
        console.error('Error removing presence:', error);
    }
}

async function loadOnlineUsers() {
    if (!currentUser) {
        const listElement = document.getElementById('online-users-list');
        if (listElement) {
            listElement.innerHTML = '<div class="loading">Please sign in to see online users</div>';
        }
        return;
    }
    
    try {
        // ‚úÖ Detach existing listener before creating new one
        if (onlineUsersRef) {
            onlineUsersRef();
            onlineUsersRef = null;
        }
        
        onlineUsersRef = db.collection('onlineUsers')
            .where('userId', '!=', currentUser.uid)
            .onSnapshot(snapshot => {
                const users = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lastSeen = data.lastSeen?.toDate() || new Date(0);
                    const now = new Date();
                    const diffMinutes = (now - lastSeen) / 1000 / 60;
                    
                    if (diffMinutes < 2) {
                        users.push({ id: doc.id, ...data });
                    }
                });
                
                // ‚úÖ Check if elements exist before updating
                const countElement = document.getElementById('online-count');
                const listElement = document.getElementById('online-users-list');
                
                if (!countElement || !listElement) {
                    // Elements don't exist, user navigated away - detach listener
                    if (onlineUsersRef) {
                        onlineUsersRef();
                        onlineUsersRef = null;
                    }
                    return;
                }
                
                countElement.textContent = users.length;
                
                if (users.length === 0) {
                    listElement.innerHTML = `
                        <div class="loading">
                            No other students online right now. <br>
                            Share the app with friends to challenge them!
                        </div>
                    `;
                } else {
                    displayOnlineUsers(users);
                }
            });
    } catch (error) {
        console.error('Error loading online users:', error);
    }
}

function displayOnlineUsers(users) {
    const container = document.getElementById('online-users-list');
    
    container.innerHTML = users.map(user => {
        let avatarHTML = '';
        
        if (user.photoURL) {
            avatarHTML = `<div style="background-image: url('${user.photoURL}'); background-size: cover; background-position: center; width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px;"></div>`;
        } else {
            const initial = (user.name || 'S').charAt(0).toUpperCase();
            avatarHTML = `<div class="user-avatar" style="margin: 0 auto 10px;">${initial}</div>`;
        }
        
        return `
            <div class="online-user-card" data-user-id="${user.userId}" data-user-name="${user.name}" onclick="sendChallenge(this.dataset.userId, this.dataset.userName)">
                ${avatarHTML}
                <h3 style="color: #0d3b66; margin: 10px 0;">${user.name}</h3>
                <span class="online-status"></span>
                <span style="color: #28a745; font-weight: bold;">Online</span>
                <button class="practice-btn" style="margin-top: 15px; font-size: 0.9rem; padding: 10px 20px; pointer-events: none;">
                    ‚öîÔ∏è Challenge
                </button>
            </div>
        `;
    }).join('');
}

// ===== REPLACE THE sendChallenge FUNCTION =====
// ===== REPLACE THE sendChallenge FUNCTION =====
async function sendChallenge(opponentId, opponentName) {
    if (!currentUser) return;
    
    try {
        const challengeRef = db.collection('challenges').doc();
        
        await challengeRef.set({
            challenger: {
                id: currentUser.uid,
                name: currentUser.displayName || 'Student',
                photoURL: currentUser.photoURL || null
            },
            opponent: {
                id: opponentId,
                name: opponentName
            },
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ‚úÖ Show message and auto-hide after 3 seconds
        showCustomPopup(`‚öîÔ∏è SENT TO ${opponentName.toUpperCase()}`);
        setTimeout(() => hideCustomPopup(), 3000);
        
    } catch (error) {
        console.error('Error sending challenge:', error);
        showCustomPopup('‚ùå FAILED TO SEND');
        setTimeout(() => hideCustomPopup(), 2000);
    }
}

function listenForChallenges() {
    if (!currentUser) return;
    
    // Detach existing listener
    if (challengeListener) {
        challengeListener();
    }
    
    challengeListener = db.collection('challenges')
        .where('opponent.id', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                const challenge = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'added' || change.type === 'modified') {
                    if (challenge.status === 'pending') {
                        // ‚úÖ CHECK IF ALREADY DECLINED
                        if (declinedChallengeIds.has(challenge.id)) {
                            console.log('üö´ Challenge already declined - skipping');
                            return;
                        }
                        
                        // ‚úÖ CHECK IF CHALLENGER IS STILL ONLINE
                        const challengerId = challenge.challenger.id;
                        const challengerPresence = await db.collection('onlineUsers').doc(challengerId).get();
                        
                        if (!challengerPresence.exists) {
                            // Challenger went offline - delete the challenge
                            console.log('üö´ Challenger went offline - removing challenge');
                            await db.collection('challenges').doc(challenge.id).delete();
                            
                            // Remove popup if exists
                            const popup = document.getElementById('challenge-popup-notification');
                            if (popup) popup.remove();
                            
                            // Remove from shown set
                            shownPopupIds.delete(challenge.id);
                            
                            return;
                        }
                        
                        // Challenger is online - show challenge
                        showChallengePopup(challenge);
                        displayIncomingChallenges([challenge]);
                    } else if (challenge.status === 'active') {
                        // This handles the case where challenge is accepted
                        // But we already start it in acceptChallenge(), so only start if not already active
                        if (!activeChallenge || activeChallenge.id !== challenge.id) {
                            startLiveChallenge(challenge.id);
                        }
                    }
                }
                
                // Handle challenge deletion/decline
                if (change.type === 'removed') {
                    const popup = document.getElementById('challenge-popup-notification');
                    if (popup) popup.remove();
                    
                    // Remove from shown set
                    shownPopupIds.delete(challenge.id);
                }
            });
        });
}
        
function listenForMyChallengesAccepted() {
    if (!currentUser) return;
    
    if (myChallengeListener) {
        myChallengeListener();
    }
    
    myChallengeListener = db.collection('challenges')
        .where('challenger.id', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const challenge = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'modified' && challenge.status === 'active') {
                    if (!activeChallenge || activeChallenge.id !== challenge.id) {
                        // ‚úÖ Hide popup immediately when accepted
                        hideCustomPopup();
                        
                        showBottomNotification(`${challenge.opponent.name} accepted your challenge! Starting game...`, 'success');
                        
                        navigateTo('spelling');
                        switchSpellingMode('live');
                        
                        startLiveChallenge(change.doc.id);
                    }
                }
            });
        });
}

function showBottomNotification(message, type = 'success') {
    // Remove existing notification if any
    const existing = document.getElementById('bottom-notification');
    if (existing) existing.remove();
    
    const notification = document.createElement('div');
    notification.id = 'bottom-notification';
    notification.className = 'bottom-notification';
    
    const bgColor = type === 'success' ? 
        'linear-gradient(135deg, #28a745, #20c997)' : 
        'linear-gradient(135deg, #ff6b6b, #ee5a6f)';
    
    notification.style.background = bgColor;
    
    notification.innerHTML = `
        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">
            ${type === 'success' ? '‚úÖ' : '‚ö°'} ${message}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide after 4 seconds
    setTimeout(() => {
        notification.classList.add('hide');
        setTimeout(() => notification.remove(), 500);
    }, 4000);
}

        
function displayIncomingChallenges(challenges) {
    const section = document.getElementById('incoming-challenges-section');
    const container = document.getElementById('incoming-challenges-list');
    
    if (challenges.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    container.innerHTML = challenges.map(challenge => `
        <div class="challenge-notification">
            <h3 style="margin: 0 0 10px 0;">‚öîÔ∏è ${challenge.challenger.name} challenges you!</h3>
            <p style="margin: 10px 0;">Ready for a spelling battle?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button class="practice-btn" onclick="acceptChallenge('${challenge.id}')" 
                        style="background: #28a745;">
                    ‚úÖ Accept
                </button>
                <button class="practice-btn" onclick="declineChallenge('${challenge.id}')" 
                        style="background: #dc3545;">
                    ‚ùå Decline
                </button>
            </div>
        </div>
    `).join('');
}

// ===== REPLACE THE acceptChallenge FUNCTION =====
async function acceptChallenge(challengeId) {
    console.log('‚úÖ Starting acceptChallenge for:', challengeId);
    
    // ‚úÖ CHECK IF ALREADY IN A CHALLENGE
    if (activeChallenge && activeChallenge.status === 'active') {
        showCustomPopup('‚ö†Ô∏è COMPLETE CURRENT CHALLENGE FIRST');
        setTimeout(() => hideCustomPopup(), 3000);
        
        // Remove the popup for this new challenge
        const popup = document.getElementById('challenge-popup-notification');
        if (popup) popup.remove();
        
        return;
    }
    
    try {
        const challengeRef = db.collection('challenges').doc(challengeId);
        const challengeDoc = await challengeRef.get();
        
        if (!challengeDoc.exists) {
            console.error('‚ùå Challenge not found:', challengeId);
            alert('Challenge not found');
            return;
        }
        
        const challengeData = challengeDoc.data();
        console.log('üìÑ Challenge data:', challengeData);
        
        // Generate 5 random words
        if (!selectedGameLevel) {
            selectedGameLevel = 'foundation';
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            console.log('üìö Loading words for level:', selectedGameLevel);
            await loadLevelWords(selectedGameLevel);
        }
        
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        const words = shuffled.slice(0, 5);
        
        console.log('üî§ Selected words:', words);
        
        await challengeRef.update({
            status: 'active',
            words: words,
            scores: {
                [currentUser.uid]: 0,
                [challengeData.challenger.id]: 0
            },
            completed: {
                [currentUser.uid]: false,
                [challengeData.challenger.id]: false
            },
            currentWord: 0,
            acceptedBy: currentUser.uid,
            startedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Challenge updated to active');
        
        // ‚úÖ Navigate to spelling section and switch to live mode
        navigateTo('spelling', true); // true = skip sidebar close
        
        // ‚úÖ Wait a moment for navigation to complete
        setTimeout(() => {
            switchSpellingMode('live');
            
            // ‚úÖ Wait another moment for mode switch to complete
            setTimeout(() => {
                startLiveChallenge(challengeId);
            }, 300);
        }, 300);
        
    } catch (error) {
        console.error('‚ùå Error accepting challenge:', error);
        alert('Failed to accept challenge: ' + error.message);
    }
}

        
async function declineChallenge(challengeId) {
    try {
        // ‚úÖ ADD TO DECLINED LIST FIRST (before deleting)
        declinedChallengeIds.add(challengeId);
        
        // Delete the challenge from Firestore
        await db.collection('challenges').doc(challengeId).delete();
        
        // Remove from shown popups set
        shownPopupIds.delete(challengeId);
        
        // Remove the popup if it exists
        const popup = document.getElementById('challenge-popup-notification');
        if (popup) popup.remove();
        
        // Hide incoming challenges section
        const section = document.getElementById('incoming-challenges-section');
        if (section) section.style.display = 'none';
        
        console.log('‚úÖ Challenge declined and deleted');
    } catch (error) {
        console.error('Error declining challenge:', error);
    }
}

        
// ===== REPLACE THE showChallengePopup FUNCTION =====
function showChallengePopup(challenge) {
    const challengeId = challenge.id; // Use document ID only
    
    // Prevent duplicate popups
    if (shownPopupIds.has(challengeId)) return;
    shownPopupIds.add(challengeId);
    
    const existingPopup = document.getElementById('challenge-popup-notification');
    if (existingPopup) existingPopup.remove();
    
    const popup = document.createElement('div');
    popup.id = 'challenge-popup-notification';
    popup.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(255,107,107,0.5);
        z-index: 9999;
        min-width: 320px;
        animation: slideInRight 0.5s ease-out;
    `;
    
    let avatarHTML = '';
    if (challenge.challenger.photoURL) {
        avatarHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background-image: url('${challenge.challenger.photoURL}'); background-size: cover; background-position: center; margin: 0 auto 10px;"></div>`;
    } else {
        const initial = (challenge.challenger.name || 'S').charAt(0).toUpperCase();
        avatarHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background: #ffd700; color: #0d3b66; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 0 auto 10px;">${initial}</div>`;
    }
    
    popup.innerHTML = `
        <div style="text-align: center;">
            ${avatarHTML}
            <h3 style="margin: 0 0 10px 0; font-size: 1.3rem;">‚öîÔ∏è SPELLING CHALLENGE!</h3>
            <p style="margin: 10px 0; font-size: 1.1rem;"><strong>${challenge.challenger.name}</strong> challenges you!</p>
            <p style="margin: 10px 0; font-size: 0.9rem; opacity: 0.9;">Ready for a spelling battle?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button onclick="acceptChallengeFromPopup('${challengeId}')" 
                        style="padding: 12px 25px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                    ‚úÖ Accept
                </button>
                <button onclick="declineChallengeFromPopup('${challengeId}')" 
                        style="padding: 12px 25px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                    ‚ùå Decline
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}


// ===== REPLACE THE declineChallengeFromPopup FUNCTION =====
async function declineChallengeFromPopup(challengeId) {
    console.log('‚ùå Declining challenge from popup:', challengeId);
    
    // Remove popup immediately
    const popup = document.getElementById('challenge-popup-notification');
    if (popup) popup.remove();
    
    // Delete from shown popups set so it won't show again
    shownPopupIds.delete(challengeId);
    
    // Decline and delete the challenge
    await declineChallenge(challengeId);
}

        
// ===== REPLACE THE acceptChallengeFromPopup FUNCTION =====
async function acceptChallengeFromPopup(challengeId) {
    console.log('üéØ Accepting challenge from popup:', challengeId);
    
    // ‚úÖ CHECK IF ALREADY IN A CHALLENGE
    if (activeChallenge && activeChallenge.status === 'active') {
        showCustomPopup('‚ö†Ô∏è COMPLETE CURRENT CHALLENGE FIRST');
        setTimeout(() => hideCustomPopup(), 3000);
        
        // Remove the popup
        const popup = document.getElementById('challenge-popup-notification');
        if (popup) popup.remove();
        
        return;
    }
    
    // Remove popup
    const popup = document.getElementById('challenge-popup-notification');
    if (popup) popup.remove();
    
    shownPopupIds.delete(challengeId);
    
    // Call acceptChallenge with the correct ID
    await acceptChallenge(challengeId);
}
        
// ===== REPLACE THE startLiveChallenge FUNCTION (UPDATE THE LISTENER PART) =====
async function startLiveChallenge(challengeId) {
    try {
        console.log('üéÆ Starting live challenge:', challengeId);
        
        // ‚úÖ CRITICAL: Detach online users listener before starting challenge
        if (onlineUsersRef) {
            onlineUsersRef();
            onlineUsersRef = null;
            console.log('‚úÖ Detached online users listener');
        }
        
        const challengeDoc = await db.collection('challenges').doc(challengeId).get();
        
        if (!challengeDoc.exists) {
            alert('Challenge not found');
            return;
        }
        
        const challenge = challengeDoc.data();
        
        activeChallenge = { id: challengeId, ...challenge };
        challengeWords = challenge.words || [];
        currentChallengeIndex = 0;
        myScore = 0;
        opponentScore = 0;
        
        // ‚úÖ HIDE the online users and incoming challenges sections
        const onlineUsersSection = document.getElementById('online-users-section');
        const incomingChallengesSection = document.getElementById('incoming-challenges-section');
        
        if (onlineUsersSection) onlineUsersSection.style.display = 'none';
        if (incomingChallengesSection) incomingChallengesSection.style.display = 'none';
        
        // ‚úÖ SHOW the challenge directly in the live-spelling-mode div
        const liveSpellingMode = document.getElementById('live-spelling-mode');
        if (!liveSpellingMode) {
            console.error('‚ùå live-spelling-mode not found');
            alert('Failed to start challenge - page element missing');
            return;
        }
        
        let welcomeSection = liveSpellingMode.querySelector('.welcome-section');
        
        if (!welcomeSection) {
            welcomeSection = document.createElement('div');
            welcomeSection.className = 'welcome-section';
            liveSpellingMode.appendChild(welcomeSection);
        }
        
        welcomeSection.innerHTML = '<div id="live-challenge-container"></div>';
        
        // ‚úÖ Start challenge timeout (5 minutes max)
        startChallengeTimeout(challengeId);
        
        // ‚úÖ Start offline detection
        startOfflineDetection(challengeId);
        
        // ‚úÖ Listen for challenge updates
        db.collection('challenges').doc(challengeId).onSnapshot(doc => {
            const data = doc.data();
            
            if (!data) return;
            
            // ‚úÖ UPDATED: Check endReason to determine what happened
            if (data.status === 'completed') {
                clearChallengeTimers();
                
                if (data.endReason === 'finished') {
                    // Normal completion - show results
                    showChallengeResults(data);
                } else {
                    // Abandoned/timeout - show abandoned screen
                    showChallengeAbandoned(data);
                }
                return;
            }
            
            if (data.status === 'abandoned') {
                clearChallengeTimers();
                showChallengeAbandoned(data);
                return;
            }
            
            // ‚úÖ Update opponent score
            const opponentId = activeChallenge.challenger.id === currentUser.uid ? 
                activeChallenge.opponent.id : activeChallenge.challenger.id;
            opponentScore = data.scores?.[opponentId] || 0;
            
            // ‚úÖ Check if elements exist before updating
            const scoreElements = document.querySelectorAll('.player-score .score');
            if (scoreElements && scoreElements.length > 1) {
                scoreElements[1].textContent = opponentScore;
            }
        });
        
        loadChallengeWord();
    } catch (error) {
        console.error('Error starting challenge:', error);
        alert('Failed to start challenge: ' + error.message);
    }
}



// Check if challengers are still online every 10 seconds
setInterval(async () => {
    if (!currentUser) return;
    
    try {
        // Get all pending challenges where I'm the opponent
        const pendingChallenges = await db.collection('challenges')
            .where('opponent.id', '==', currentUser.uid)
            .where('status', '==', 'pending')
            .get();
        
        for (const doc of pendingChallenges.docs) {
            const challenge = doc.data();
            const challengerId = challenge.challenger.id;
            
            // Check if challenger is still online
            const challengerPresence = await db.collection('onlineUsers').doc(challengerId).get();
            
            if (!challengerPresence.exists) {
                // Challenger went offline - delete the challenge
                console.log('üö´ Challenger offline - removing challenge:', doc.id);
                await doc.ref.delete();
                
                // Remove popup if exists
                const popup = document.getElementById('challenge-popup-notification');
                if (popup) popup.remove();
                
                // Remove from shown set
                shownPopupIds.delete(doc.id);
            }
        }
    } catch (error) {
        console.error('Error checking challenger presence:', error);
    }
}, 10000); // Check every 10 seconds
        
function loadChallengeWord() {
    if (!challengeWords || challengeWords.length === 0) {
        alert('No words available for challenge');
        return;
    }
    
    const word = challengeWords[currentChallengeIndex];
    const container = document.getElementById('live-challenge-container');
    
    if (!container) {
        console.error('‚ùå live-challenge-container not found');
        return;
    }
    
    const opponentName = activeChallenge.challenger.id === currentUser.uid ? 
        activeChallenge.opponent.name : activeChallenge.challenger.name;
    
    container.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1);">
            <h2 style="color: #0d3b66; margin-bottom: 20px; text-align: center;">‚öîÔ∏è Live Spelling Battle!</h2>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">You</div>
                    <div class="score">${myScore}</div>
                </div>
                <div style="font-size: 2rem; align-self: center;">VS</div>
                <div class="player-score">
                    <div class="name">${opponentName}</div>
                    <div class="score">${opponentScore}</div>
                </div>
            </div>
            
            <div class="quiz-question-card">
                <h3>Word ${currentChallengeIndex + 1} of ${challengeWords.length}</h3>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="practice-btn" onclick="speakChallengeWord()" 
                                style="font-size: 1.1rem; padding: 15px 30px;">
                            üîä Play Word
                        </button>
                        <button class="practice-btn" onclick="speakChallengeWordInSentence()" 
                                style="font-size: 1.1rem; padding: 15px 30px; background: #17a2b8;">
                            üí¨ Use in Sentence
                        </button>
                    </div>
                </div>
                
                <div class="form-group" style="margin: 30px 0;">
                    <label style="font-size: 1.2rem;">Type what you hear:</label>
                    <input type="text" id="challenge-spelling-input" 
                           placeholder="Use the keyboard below..." 
                           style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                           readonly>
                </div>
                
                <div class="virtual-keyboard">
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeChallengeKey('Q')">Q</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('W')">W</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('E')">E</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('R')">R</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('T')">T</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('Y')">Y</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('U')">U</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('I')">I</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('O')">O</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('P')">P</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeChallengeKey('A')">A</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('S')">S</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('D')">D</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('F')">F</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('G')">G</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('H')">H</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('J')">J</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('K')">K</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('L')">L</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeChallengeKey('Z')">Z</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('X')">X</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('C')">C</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('V')">V</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('B')">B</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('N')">N</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('M')">M</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key backspace" onclick="backspaceChallengeKey()">‚å´ Delete</button>
                        <button class="keyboard-key space" onclick="typeChallengeKey(' ')">Space</button>
                        <button class="keyboard-key enter" onclick="submitChallengeAnswer()">‚úì Enter</button>
                    </div>
                </div>
                
                <div id="challenge-feedback" style="margin-top: 20px;"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="practice-btn" onclick="exitChallenge()" style="background: #dc3545;">
                    üö™ Exit Challenge
                </button>
            </div>
        </div>
    `;
    
    setTimeout(() => speakChallengeWord(), 500);
}
function speakChallengeWord() {
    if (!challengeWords || !challengeWords[currentChallengeIndex]) return;
    
    const word = challengeWords[currentChallengeIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

 async function speakChallengeWordInSentence() {
    if (!challengeWords || !challengeWords[currentChallengeIndex]) return;
    
    const word = challengeWords[currentChallengeIndex];
    
    const btn = event?.target;
    if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Loading...';
    }
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let exampleSentence = null;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        exampleSentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        if (!exampleSentence) {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: word } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.meanings && data.result.meanings.length > 0) {
                    for (let meaning of data.result.meanings) {
                        if (meaning.example) {
                            exampleSentence = meaning.example;
                            break;
                        }
                    }
                }
            }
        }
        
        if (!exampleSentence) {
            exampleSentence = `The word is ${word}.`;
        }
        
        const utterance = new SpeechSynthesisUtterance(exampleSentence);
        utterance.rate = 0.8;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        const utterance = new SpeechSynthesisUtterance(`The word is ${word}.`);
        utterance.rate = 0.8;
        window.speechSynthesis.speak(utterance);
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'üí¨ Use in Sentence';
        }
    }
}       

function typeChallengeKey(letter) {
    const input = document.getElementById('challenge-spelling-input');
    if (!input) return;
    input.value += letter.toLowerCase();
}

function backspaceChallengeKey() {
    const input = document.getElementById('challenge-spelling-input');
    if (!input) return;
    input.value = input.value.slice(0, -1);
}

// ===== REPLACE THE submitChallengeAnswer FUNCTION =====
async function submitChallengeAnswer() {
    const input = document.getElementById('challenge-spelling-input');
    if (!input) return;
    
    const userAnswer = input.value.trim().toLowerCase();
    const correctWord = challengeWords[currentChallengeIndex].toLowerCase();
    const feedbackDiv = document.getElementById('challenge-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">‚ö†Ô∏è Please type a word</div>';
        return;
    }
    
    // ‚úÖ Disable input while processing
    input.disabled = true;
    
    const isCorrect = userAnswer === correctWord;
    
    if (isCorrect) {
        myScore++;
        feedbackDiv.innerHTML = '<div class="feedback success">‚úÖ Correct!</div>';
    } else {
        feedbackDiv.innerHTML = `<div class="feedback error">‚ùå Wrong! Correct: ${correctWord}</div>`;
    }
    
    try {
        const challengeRef = db.collection('challenges').doc(activeChallenge.id);
        const scoreKey = `scores.${currentUser.uid}`;
        const completedKey = `completed.${currentUser.uid}`;
        
        // ‚úÖ Update score
        await challengeRef.update({
            [scoreKey]: myScore,
            [`lastAnswerTime.${currentUser.uid}`]: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ‚úÖ Check if this is the last word
        currentChallengeIndex++;
        
        if (currentChallengeIndex >= challengeWords.length) {
            // Mark that I've completed all words
            await challengeRef.update({
                [completedKey]: true
            });
            
            // Check if opponent also completed
            const challengeDoc = await challengeRef.get();
            const challengeData = challengeDoc.data();
            const opponentId = activeChallenge.challenger.id === currentUser.uid ? 
                activeChallenge.opponent.id : activeChallenge.challenger.id;
            
            if (challengeData.completed && challengeData.completed[opponentId]) {
                // Both completed - end the challenge properly
                await challengeRef.update({
                    status: 'completed',
                    endReason: 'finished', // ‚úÖ Mark as normally finished
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Don't show waiting screen, results will show automatically via listener
            } else {
                // Show waiting screen
                showWaitingForOpponent();
            }
        } else {
            // Continue to next word
            setTimeout(() => {
                input.disabled = false;
                loadChallengeWord();
            }, 2000);
        }
    } catch (error) {
        console.error('Error updating score:', error);
    }
}

function showWaitingForOpponent() {
    const container = document.getElementById('live-challenge-container');
    
    if (!container) {
        console.error('‚ùå live-challenge-container not found');
        return;
    }
    
    const opponentName = activeChallenge.challenger.id === currentUser.uid ? 
        activeChallenge.opponent.name : activeChallenge.challenger.name;
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0; animation: pulse 2s infinite;">‚è≥</div>
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 20px;">
                Waiting for ${opponentName}...
            </h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You've completed all words! <br>
                Waiting for your opponent to finish.
            </p>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">Your Score</div>
                    <div class="score">${myScore}</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <div class="loading">Challenge will end when both players finish...</div>
            </div>
        </div>
    `;
}
        

async function showChallengeResults(challenge) {
    const myId = currentUser.uid;
    const opponentId = challenge.challenger.id === myId ? challenge.opponent.id : challenge.challenger.id;
    
    const myFinalScore = challenge.scores[myId] || 0;
    const opponentFinalScore = challenge.scores[opponentId] || 0;
    
    const won = myFinalScore > opponentFinalScore;
    const tied = myFinalScore === opponentFinalScore;
    
    // ‚úÖ UPDATE SPELLING STATS IN FIRESTORE
    try {
        const userRef = db.collection('users').doc(myId);
        const userDoc = await userRef.get();
        const currentStats = userDoc.data().spellingStats || {
            totalChallenges: 0,
            wins: 0,
            losses: 0,
            totalScore: 0,
            winStreak: 0,
            bestStreak: 0
        };
        
        let newStats = {
            totalChallenges: currentStats.totalChallenges + 1,
            wins: currentStats.wins + (won ? 1 : 0),
            losses: currentStats.losses + (tied ? 0 : (won ? 0 : 1)),
            totalScore: currentStats.totalScore + myFinalScore,
            winStreak: won ? currentStats.winStreak + 1 : 0,
            bestStreak: won ? Math.max(currentStats.bestStreak, currentStats.winStreak + 1) : currentStats.bestStreak,
            lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await userRef.update({
            spellingStats: newStats
        });
        
        console.log('‚úÖ Spelling stats updated:', newStats);
    } catch (error) {
        console.error('Error updating spelling stats:', error);
    }
    
    // ‚úÖ AWARD COINS FOR WIN
    if (won) {
        await awardCoins(COINS_PER_WIN);
    }
    
    const container = document.getElementById('live-challenge-container');
    
    if (!container) {
        console.error('‚ùå live-challenge-container not found');
        return;
    }
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">
                ${won ? 'üèÜ' : tied ? 'ü§ù' : 'üòî'}
            </div>
            <h2 style="color: #0d3b66; font-size: 2.5rem; margin-bottom: 20px;">
                ${won ? 'Victory!' : tied ? "It's a Tie!" : 'Better Luck Next Time'}
            </h2>
            
            ${won ? `
                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 20px; border-radius: 15px; margin: 20px 0;">
                    <h3 style="color: #0d3b66; font-size: 1.5rem; margin-bottom: 10px;">ü™ô Coins Earned!</h3>
                    <p style="color: #0d3b66; font-size: 2rem; font-weight: bold;">+${COINS_PER_WIN} Coins</p>
                    <p style="color: #0d3b66; font-size: 1rem; margin-top: 5px;">Total: ${userCoins} / ${MAX_COINS}</p>
                </div>
            ` : ''}
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">You</div>
                    <div class="score">${myFinalScore}</div>
                </div>
                <div style="font-size: 2rem; align-self: center;">-</div>
                <div class="player-score">
                    <div class="name">Opponent</div>
                    <div class="score">${opponentFinalScore}</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="practice-btn" onclick="navigateTo('spelling'); switchSpellingMode('leaderboard');" style="background: #667eea; margin: 5px;">
                    üìä View Leaderboard
                </button>
                <button class="practice-btn" onclick="exitChallenge()" style="margin: 5px;">
                    üè† Back to Lobby
                </button>
            </div>
        </div>
    `;
}




// ===== SPELLING LEADERBOARD FUNCTIONS =====
async function loadSpellingLeaderboard() {
    const container = document.getElementById('leaderboard-container');
    
    if (!container) {
        console.error('‚ùå Leaderboard container not found');
        return;
    }
    
    try {
        container.innerHTML = '<div class="loading">üìä Loading leaderboard...</div>';
        
        // Fetch all users with spelling stats, ordered by wins
        const usersSnapshot = await db.collection('users')
            .where('spellingStats.wins', '>', 0)
            .orderBy('spellingStats.wins', 'desc')
            .limit(50)
            .get();
        
        if (usersSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üèÜ</div>
                    <h3>No ranked players yet</h3>
                    <p>Be the first to win a spelling challenge!</p>
                </div>
            `;
            return;
        }
        
        const players = [];
        usersSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.spellingStats) {
                players.push({
                    id: doc.id,
                    name: data.name,
                    email: data.email,
                    photoURL: data.photoURL,
                    country: data.country,
                    age: data.age,
                    createdAt: data.createdAt,
                    stats: data.spellingStats
                });
            }
        });
        
        // Sort by wins, then by win rate as tiebreaker
        players.sort((a, b) => {
            if (b.stats.wins !== a.stats.wins) {
                return b.stats.wins - a.stats.wins;
            }
            const aWinRate = a.stats.wins / a.stats.totalChallenges;
            const bWinRate = b.stats.wins / b.stats.totalChallenges;
            return bWinRate - aWinRate;
        });
        
        // Find current user's rank
        const myRank = players.findIndex(p => p.id === currentUser?.uid) + 1;
        
        // Display leaderboard
        container.innerHTML = `
            ${currentUser && myRank > 0 ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 25px; color: white; text-align: center;">
                    <h3 style="margin: 0 0 10px 0; color: white;">üéØ Your Rank</h3>
                    <p style="font-size: 2.5rem; margin: 10px 0; font-weight: bold;">#${myRank}</p>
                    <p style="margin: 5px 0; opacity: 0.9;">
                        ${players[myRank - 1].stats.wins} Wins ‚Ä¢ 
                        ${players[myRank - 1].stats.totalChallenges} Challenges
                    </p>
                </div>
            ` : ''}
            
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: center;">üèÜ Rank</th>
                            <th>üë§ Player</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${players.map((player, index) => {
                            const isCurrentUser = currentUser && player.id === currentUser.uid;
                            
                            let rankEmoji = '';
                            if (index === 0) rankEmoji = 'ü•á';
                            else if (index === 1) rankEmoji = 'ü•à';
                            else if (index === 2) rankEmoji = 'ü•â';
                            
                            let avatarHTML = '';
                            if (player.photoURL) {
                                avatarHTML = `<div style="width: 45px; height: 45px; min-width: 45px; border-radius: 50%; background-image: url('${player.photoURL}'); background-size: cover; background-position: center;"></div>`;
                            } else {
                                const initial = (player.name || 'P').charAt(0).toUpperCase();
                                avatarHTML = `<div class="coach-avatar" style="width: 45px; height: 45px; min-width: 45px;">${initial}</div>`;
                            }
                            
                            return `
                                <tr onclick="showLeaderboardPlayerDetail('${player.id}', ${index + 1})" style="cursor: pointer; ${isCurrentUser ? 'background: #e3f2fd;' : ''}">
                                    <td style="text-align: center; font-size: 1.3rem; font-weight: bold; color: #0d3b66;">
                                        ${rankEmoji || (index + 1)}
                                    </td>
                                    <td>
                                        <div class="coach-profile-cell">
                                            ${avatarHTML}
                                            <div class="coach-name">${player.name}${isCurrentUser ? ' (You)' : ''}</div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">üèÜ How Rankings Work</h3>
                <p style="color: #666; line-height: 1.6;">
                    ‚Ä¢ Players are ranked by <strong>total wins</strong> in live spelling challenges<br>
                    ‚Ä¢ Click on any player to view their detailed stats<br>
                    ‚Ä¢ Challenge top players to climb the leaderboard!
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading leaderboard:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading leaderboard. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadSpellingLeaderboard()">üîÑ Retry</button>
            </div>
        `;
    }
}


  // Show leaderboard player details
async function showLeaderboardPlayerDetail(playerId, rank) {
    try {
        console.log('üìã Loading player details for:', playerId);
        const playerDoc = await db.collection('users').doc(playerId).get();
        
        if (!playerDoc.exists) {
            console.error('‚ùå Player not found');
            alert('Player profile not found');
            return;
        }
        
        const player = { id: playerDoc.id, ...playerDoc.data() };
        console.log('Player data loaded:', player);
        
        const modal = document.getElementById('leaderboardPlayerModal');
        
        // Generate Student ID
        const studentId = `WB-2025-${player.id.slice(-4).toUpperCase()}`;
        
        // Calculate stats
        const stats = player.spellingStats || {
            wins: 0,
            losses: 0,
            totalChallenges: 0,
            winStreak: 0,
            bestStreak: 0,
            totalScore: 0
        };
        
        const winRate = stats.totalChallenges > 0 
            ? ((stats.wins / stats.totalChallenges) * 100).toFixed(1) 
            : '0.0';
        
        const avgScore = stats.totalChallenges > 0 
            ? (stats.totalScore / stats.totalChallenges).toFixed(1) 
            : '0.0';
        
        // Rank emoji
        let rankEmoji = '';
        if (rank === 1) rankEmoji = 'ü•á';
        else if (rank === 2) rankEmoji = 'ü•à';
        else if (rank === 3) rankEmoji = 'ü•â';
        
        // Update avatar with photo
        const avatar = document.getElementById('modal-leaderboard-avatar');
        if (player.photoURL) {
            console.log('üñºÔ∏è Setting photo URL:', player.photoURL);
            avatar.style.backgroundImage = `url('${player.photoURL}')`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
            avatar.textContent = '';
        } else {
            console.log('üî§ No photo URL, using initial');
            avatar.style.backgroundImage = 'none';
            avatar.textContent = (player.name || 'P').charAt(0).toUpperCase();
        }
        
        // Update name
        document.getElementById('modal-leaderboard-name').textContent = player.name || 'Player';
        
        // Update rank badge
        document.getElementById('modal-leaderboard-rank').innerHTML = `${rankEmoji} Rank #${rank}`;
        
        // Update Student ID
        document.getElementById('modal-leaderboard-id').textContent = studentId;
        document.getElementById('modal-leaderboard-id-display').textContent = studentId;
        
        // Update email
        document.getElementById('modal-leaderboard-email').textContent = player.email || 'N/A';
        
        // Update country
        document.getElementById('modal-leaderboard-country').textContent = player.country || 'N/A';
        
        // Update age
        const ageRow = document.getElementById('modal-leaderboard-age-row');
        if (player.age) {
            ageRow.style.display = 'flex';
            document.getElementById('modal-leaderboard-age').textContent = player.age + ' years old';
        } else {
            ageRow.style.display = 'none';
        }
        
        // Update member since
        if (player.createdAt) {
            const joinDate = player.createdAt.toDate();
            document.getElementById('modal-leaderboard-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            document.getElementById('modal-leaderboard-joined').textContent = 'Recently';
        }
        
        // Update stats
        document.getElementById('modal-leaderboard-wins').textContent = stats.wins;
        document.getElementById('modal-leaderboard-losses').textContent = stats.losses;
        document.getElementById('modal-leaderboard-total').textContent = stats.totalChallenges;
        document.getElementById('modal-leaderboard-winrate').textContent = winRate + '%';
        document.getElementById('modal-leaderboard-streak').textContent = stats.winStreak > 0 ? 'üî• ' + stats.winStreak : '-';
        document.getElementById('modal-leaderboard-best').textContent = stats.bestStreak;
        document.getElementById('modal-leaderboard-avgscore').textContent = avgScore;
        
        // Show modal
        modal.classList.add('active');
        console.log('Modal displayed');
        
    } catch (error) {
        console.error('‚ùå Error loading player details:', error);
        alert('Unable to load player details: ' + error.message);
    }
}

// Close leaderboard player modal
function closeLeaderboardPlayerModal() {
    document.getElementById('leaderboardPlayerModal').classList.remove('active');
}      
        
// ===== REPLACE THE exitChallenge FUNCTION =====
async function exitChallenge() {
    try {
        // ‚úÖ Only mark as abandoned if challenge is still active AND user hasn't completed
        if (activeChallenge && activeChallenge.status === 'active') {
            const challengeDoc = await db.collection('challenges').doc(activeChallenge.id).get();
            const challengeData = challengeDoc.data();
            
            // Check if user has completed their words
            const userCompleted = challengeData.completed && challengeData.completed[currentUser.uid];
            
            if (!userCompleted) {
                // User is leaving before finishing - opponent wins
                const opponentId = activeChallenge.challenger.id === currentUser.uid ? 
                    activeChallenge.opponent.id : activeChallenge.challenger.id;
                
                await db.collection('challenges').doc(activeChallenge.id).update({
                    status: 'abandoned',
                    endReason: 'opponent_left',
                    winner: opponentId,
                    loser: currentUser.uid,
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ Challenge abandoned - opponent wins');
            } else {
                // User completed their part, just exiting to lobby
                console.log('‚úÖ User completed challenge, just returning to lobby');
            }
        }
    } catch (error) {
        console.error('Error updating challenge on exit:', error);
    }
    
    // ‚úÖ Clear all timers
    clearChallengeTimers();
    
    activeChallenge = null;
    challengeWords = [];
    currentChallengeIndex = 0;
    myScore = 0;
    opponentScore = 0;
    shownPopupIds.clear();
    
    // ‚úÖ Check if elements exist before trying to modify them
    const onlineUsersSection = document.getElementById('online-users-section');
    const incomingChallengesSection = document.getElementById('incoming-challenges-section');
    
    if (onlineUsersSection) {
        onlineUsersSection.style.display = 'block';
    }
    
    if (incomingChallengesSection) {
        incomingChallengesSection.style.display = 'none';
    }
    
    // ‚úÖ Restore the welcome section content
    const liveSpellingMode = document.getElementById('live-spelling-mode');
    if (!liveSpellingMode) {
        console.error('‚ùå live-spelling-mode not found');
        return;
    }
    
    let welcomeSection = liveSpellingMode.querySelector('.welcome-section');
    
    if (!welcomeSection) {
        welcomeSection = document.createElement('div');
        welcomeSection.className = 'welcome-section';
        liveSpellingMode.appendChild(welcomeSection);
    }
    
    welcomeSection.innerHTML = `
        <h2>üèÜ Live Spelling Challenges</h2>
        <p style="margin: 20px 0;">Challenge other students to spelling battles in real-time!</p>
        
        <!-- Online Users Section -->
        <div id="online-users-section">
            <h3 style="color: #0d3b66; margin: 20px 0;">üë• Online Students (<span id="online-count">0</span>)</h3>
            <div id="online-users-list" class="favorites-grid">
                <div class="loading">Loading online users...</div>
            </div>
        </div>
        
        <!-- Incoming Challenges -->
        <div id="incoming-challenges-section" style="margin-top: 30px; display: none;">
            <h3 style="color: #dc3545; margin: 20px 0;">‚ö° Incoming Challenges</h3>
            <div id="incoming-challenges-list"></div>
        </div>
    `;
    
    // ‚úÖ Restart online users listener
    loadOnlineUsers();
}
        
// Start challenge timeout
function startChallengeTimeout(challengeId) {
    challengeTimeoutTimer = setTimeout(async () => {
        console.log('‚è∞ Challenge timeout reached');
        await endChallengeByTimeout(challengeId);
    }, CHALLENGE_TIMEOUT);
}

// Start offline detection
function startOfflineDetection(challengeId) {
    offlineCheckTimer = setInterval(async () => {
        if (!activeChallenge) {
            clearInterval(offlineCheckTimer);
            return;
        }
        
        const opponentId = activeChallenge.challenger.id === currentUser.uid ? 
            activeChallenge.opponent.id : activeChallenge.challenger.id;
        
        // Check if opponent is still online
        try {
            const opponentPresence = await db.collection('onlineUsers').doc(opponentId).get();
            
            if (!opponentPresence.exists) {
                console.log('üö´ Opponent went offline');
                await endChallengeByOpponentOffline(challengeId);
                return;
            }
            
            const lastSeen = opponentPresence.data().lastSeen?.toDate();
            if (!lastSeen) return;
            
            const now = new Date();
            const diffMinutes = (now - lastSeen) / 1000 / 60;
            
            if (diffMinutes > 2) {
                console.log('üö´ Opponent inactive for 2+ minutes');
                await endChallengeByOpponentOffline(challengeId);
            }
        } catch (error) {
            console.error('Error checking opponent presence:', error);
        }
    }, OFFLINE_CHECK_INTERVAL);
}

// Clear all challenge timers
function clearChallengeTimers() {
    if (challengeTimeoutTimer) {
        clearTimeout(challengeTimeoutTimer);
        challengeTimeoutTimer = null;
    }
    if (turnTimeoutTimer) {
        clearTimeout(turnTimeoutTimer);
        turnTimeoutTimer = null;
    }
    if (offlineCheckTimer) {
        clearInterval(offlineCheckTimer);
        offlineCheckTimer = null;
    }
}

// End challenge by timeout
async function endChallengeByTimeout(challengeId) {
    try {
        clearChallengeTimers();
        
        await db.collection('challenges').doc(challengeId).update({
            status: 'completed',
            endReason: 'timeout',
            endedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const challengeDoc = await db.collection('challenges').doc(challengeId).get();
        if (challengeDoc.exists) {
            showChallengeResults(challengeDoc.data());
        }
    } catch (error) {
        console.error('Error ending challenge by timeout:', error);
    }
}

// End challenge by opponent offline
async function endChallengeByOpponentOffline(challengeId) {
    try {
        clearChallengeTimers();
        
        await db.collection('challenges').doc(challengeId).update({
            status: 'abandoned',
            endReason: 'opponent_offline',
            winner: currentUser.uid,
            endedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
    } catch (error) {
        console.error('Error ending challenge by opponent offline:', error);
    }
}

// Show abandoned challenge screen
function showChallengeAbandoned(challenge) {
    const container = document.getElementById('live-challenge-container');
    
    if (!container) {
        console.error('‚ùå live-challenge-container not found');
        return;
    }
    
    // ‚úÖ Check if current user is the winner
    const iWon = challenge.winner === currentUser.uid;
    
    let message = '';
    if (challenge.endReason === 'opponent_left') {
        message = 'Your opponent left the challenge.';
    } else if (challenge.endReason === 'opponent_offline') {
        message = 'Your opponent went offline.';
    } else {
        message = 'The challenge was cancelled.';
    }
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${iWon ? 'üèÜ' : 'üö´'}</div>
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 15px;">Challenge Ended</h2>
            <p style="font-size: 1.2rem; margin: 20px 0; color: #666;">
                ${message}
            </p>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">Your Score</div>
                    <div class="score">${myScore}</div>
                </div>
            </div>
            
            ${iWon ? `
                <p style="margin: 20px 0; font-size: 1.5rem; color: #28a745; font-weight: bold;">
                    üéâ You win by default!
                </p>
            ` : `
                <p style="margin: 20px 0; font-size: 1.2rem; color: #dc3545; font-weight: bold;">
                    You left the challenge
                </p>
            `}
            
            <button class="practice-btn" onclick="exitChallenge()" style="margin-top: 30px; font-size: 1.2rem; padding: 15px 40px;">
                üè† Back to Lobby
            </button>
        </div>
    `;
}

        

// Cleanup old challenges (run on page load)
async function cleanupOldChallenges() {
    if (!currentUser) {
        console.log('‚è≠Ô∏è Skipping cleanup - no user logged in');
        return;
    }
    
    try {
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        
        // ‚úÖ Only cleanup challenges where current user is involved
        const myChallenges = await db.collection('challenges')
            .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(oneDayAgo))
            .get();
        
        const deletePromises = [];
        myChallenges.docs.forEach(doc => {
            const data = doc.data();
            // Only delete if I'm the challenger or opponent
            if (data.challenger?.id === currentUser.uid || data.opponent?.id === currentUser.uid) {
                deletePromises.push(doc.ref.delete());
            }
        });
        
        if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            console.log(`üßπ Cleaned up ${deletePromises.length} old challenges`);
        }
    } catch (error) {
        console.log('‚ÑπÔ∏è Could not cleanup old challenges (this is normal):', error.message);
        // Don't throw error - this is not critical
    }
} 

  
// Show custom popup - simplified
function showCustomPopup(message) {
    const popup = document.getElementById('customPopup');
    popup.textContent = message;
    popup.classList.add('show');
}

// Hide custom popup
function hideCustomPopup() {
    const popup = document.getElementById('customPopup');
    popup.classList.remove('show');
}

        
// Auto-hide popup after delay
function autoHidePopup(delay = 3000) {
    setTimeout(() => {
        hideCustomPopup();
    }, delay);
}  


// ===== COIN SYSTEM FUNCTIONS =====
async function loadUserCoins(userId) {
    try {
        const userDoc = await db.collection('users').doc(userId).get();
        const userData = userDoc.data();
        
        // Initialize coins if not exists
        if (userData.coins === undefined) {
            userCoins = 0;
            await db.collection('users').doc(userId).update({
                coins: 0
            });
        } else {
            userCoins = userData.coins || 0;
        }
        
        // Show coin display for students only
        if (userData.userType === 'student') {
            updateCoinDisplay();
        }
    } catch (error) {
        console.error('Error loading coins:', error);
        userCoins = 0;
    }
}

function updateCoinDisplay() {
    const coinDisplay = document.getElementById('coinDisplay');
    const coinAmount = document.getElementById('coinAmount');
    
    if (coinDisplay && coinAmount) {
        coinAmount.textContent = userCoins;
        coinDisplay.classList.add('show');
    }
}

function hideCoinDisplay() {
    const coinDisplay = document.getElementById('coinDisplay');
    if (coinDisplay) {
        coinDisplay.classList.remove('show');
    }
}

async function awardCoins(amount) {
    if (!currentUser) return;
    
    try {
        // Check if user is a student
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData.userType !== 'student') {
            console.log('Only students can earn coins');
            return;
        }
        
        // Calculate new coin amount (capped at MAX_COINS)
        const newCoins = Math.min(userCoins + amount, MAX_COINS);
        const actualCoinsEarned = newCoins - userCoins;
        
        if (actualCoinsEarned <= 0) {
            console.log('Maximum coins reached');
            return;
        }
        
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            coins: newCoins,
            lastCoinEarned: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update local variable
        userCoins = newCoins;
        
        // Show coin earned animation
        showCoinEarnedAnimation(actualCoinsEarned);
        
        // Update display
        setTimeout(() => {
            updateCoinDisplay();
        }, 1500);
        
    } catch (error) {
        console.error('Error awarding coins:', error);
    }
}

function showCoinEarnedAnimation(amount) {
    const coinEarned = document.createElement('div');
    coinEarned.className = 'coin-earned';
    coinEarned.innerHTML = `ü™ô +${amount} Coins!`;
    
    document.body.appendChild(coinEarned);
    
    // Remove after animation
    setTimeout(() => {
        coinEarned.remove();
    }, 2000);
}        


// ===== SUBSCRIPTION SYSTEM =====
const SUBSCRIPTION_COST = 300;
const SUBSCRIPTION_DAYS = 30;
let subscriptionActive = false;

async function checkSubscriptionStatus() {
    if (!currentUser) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        // ‚úÖ ADD: Check if user data exists first
        if (!userData) {
            console.log('‚ö†Ô∏è User data not loaded yet');
            subscriptionActive = false;
            return;
        }
        
        // Only check for students
        if (userData.userType !== 'student') {
            subscriptionActive = true;
            return;
        }
        
        // Check if subscription exists and is valid
        let subscriptionExpiry = userData.subscriptionExpiry?.toDate();
        
        // If no subscription, give 1 month free trial from account creation
        if (!subscriptionExpiry) {
            const createdAt = userData.createdAt?.toDate() || new Date();
            subscriptionExpiry = new Date(createdAt.getTime() + (30 * 24 * 60 * 60 * 1000));
            
            await db.collection('users').doc(currentUser.uid).update({
                subscriptionExpiry: firebase.firestore.Timestamp.fromDate(subscriptionExpiry),
                subscriptionType: 'trial'
            });
        }
        
        const now = new Date();
        
        // Check if subscription has expired
        if (now > subscriptionExpiry) {
            console.log('‚ùå Subscription expired');
            subscriptionActive = false;
            showSubscriptionModal();
        } else {
            console.log('‚úÖ Subscription active until:', subscriptionExpiry);
            subscriptionActive = true;
        }
        
        // Update dashboard if on dashboard page
        if (document.getElementById('student-dashboard-section').classList.contains('active')) {
            updateDashboardSubscriptionStatus();
        }
        
    } catch (error) {
        console.error('Error checking subscription:', error);
        // ‚úÖ DON'T set subscriptionActive to false on error
        subscriptionActive = true; // Assume active on error to avoid blocking user
    }
}

function showSubscriptionModal() {
    const modal = document.getElementById('subscriptionModal');
    
    if (!currentUser) {
        console.error('No current user for subscription modal');
        return;
    }
    
    // Update coin display
    const coinsElement = document.getElementById('sub-modal-coins');
    if (coinsElement) {
        coinsElement.textContent = userCoins;
    }
    
    // Update Student ID
    const studentIdElement = document.getElementById('sub-modal-student-id');
    if (studentIdElement) {
        db.collection('users').doc(currentUser.uid).get().then(doc => {
            const userData = doc.data();
            const studentId = userData?.studentId || `WB-2025-${currentUser.uid.slice(-4).toUpperCase()}`;
            studentIdElement.textContent = studentId;
        }).catch(error => {
            console.error('Error loading student ID:', error);
            studentIdElement.textContent = `WB-2025-${currentUser.uid.slice(-4).toUpperCase()}`;
        });
    }
    
    // Check if user has enough coins
    const redeemBtn = document.getElementById('redeem-sub-btn');
    const insufficientDiv = document.getElementById('sub-modal-insufficient');
    const coinsNeededSpan = document.getElementById('coins-needed');
    
    if (redeemBtn && insufficientDiv && coinsNeededSpan) {
        if (userCoins >= SUBSCRIPTION_COST) {
            redeemBtn.disabled = false;
            insufficientDiv.style.display = 'none';
        } else {
            redeemBtn.disabled = true;
            insufficientDiv.style.display = 'block';
            coinsNeededSpan.textContent = SUBSCRIPTION_COST - userCoins;
        }
    }
    
    // Reset UI
    const buttonsDiv = document.getElementById('sub-modal-buttons');
    const successDiv = document.getElementById('sub-modal-success');
    const errorDiv = document.getElementById('sub-modal-error');
    
    if (buttonsDiv) buttonsDiv.style.display = 'block';
    if (successDiv) successDiv.style.display = 'none';
    if (errorDiv) errorDiv.style.display = 'none';
    
    modal.classList.add('active');
}
        
function closeSubscriptionModal() {
    // Only close if subscription was successfully redeemed
    if (subscriptionActive) {
        document.getElementById('subscriptionModal').classList.remove('active');
    }
}

async function redeemSubscription() {
    if (!currentUser || userCoins < SUBSCRIPTION_COST) {
        return;
    }
    
    try {
        const redeemBtn = document.getElementById('redeem-sub-btn');
        redeemBtn.disabled = true;
        redeemBtn.textContent = '‚è≥ Processing...';
        
        // Calculate new expiry date (30 days from now)
        const newExpiry = new Date();
        newExpiry.setDate(newExpiry.getDate() + SUBSCRIPTION_DAYS);
        
        // Deduct coins and update subscription
        const newCoins = userCoins - SUBSCRIPTION_COST;
        
        await db.collection('users').doc(currentUser.uid).update({
            coins: newCoins,
            subscriptionExpiry: firebase.firestore.Timestamp.fromDate(newExpiry),
            subscriptionType: 'paid',
            lastSubscriptionRenewal: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update local coins
        userCoins = newCoins;
        updateCoinDisplay();
        
        // Mark subscription as active
        subscriptionActive = true;
        
        // Show success message
        document.getElementById('sub-modal-buttons').style.display = 'none';
        document.getElementById('sub-modal-success').style.display = 'block';
        
        console.log('‚úÖ Subscription renewed successfully');
        
    } catch (error) {
        console.error('Error redeeming subscription:', error);
        const errorDiv = document.getElementById('sub-modal-error');
        errorDiv.textContent = 'Failed to process subscription: ' + error.message;
        errorDiv.style.display = 'block';
        
        const redeemBtn = document.getElementById('redeem-sub-btn');
        redeemBtn.disabled = false;
        redeemBtn.textContent = '‚úÖ Redeem 300 Coins for 30 Days';
    }
}

async function redeemSubscriptionFromDashboard() {
    await redeemSubscription();
    
    // Reload dashboard after successful redemption
    setTimeout(() => {
        loadUserDashboard();
        if (subscriptionActive) {
            closeSubscriptionModal();
        }
    }, 2000);
}

function signOutFromSubscription() {
    subscriptionActive = false;
    signOut();
}

async function updateDashboardSubscriptionStatus() {
    if (!currentUser) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData.userType !== 'student') return;
        
        const subscriptionExpiry = userData.subscriptionExpiry?.toDate();
        const subscriptionType = userData.subscriptionType || 'trial';
        const now = new Date();
        
        const statusIcon = document.getElementById('sub-status-icon');
        const statusTitle = document.getElementById('sub-status-title');
        const statusText = document.getElementById('sub-status-text');
        const renewSection = document.getElementById('sub-renew-section');
        const dashboardCoins = document.getElementById('dashboard-coins');
        
        if (!statusIcon || !statusTitle || !statusText || !renewSection || !dashboardCoins) return;
        
        // Update coin display
        dashboardCoins.textContent = userCoins;
        
        // Format date nicely
        const formatDate = (date) => {
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        };
        
        if (!subscriptionExpiry) {
            statusIcon.textContent = 'üîí';
            statusTitle.textContent = 'No Subscription';
            statusText.innerHTML = `Subscribe to continue learning`;
            renewSection.style.display = 'block';
            return;
        }
        
        const daysLeft = Math.ceil((subscriptionExpiry - now) / (1000 * 60 * 60 * 24));
        
        if (now > subscriptionExpiry) {
            // Expired
            statusIcon.textContent = 'üîí';
            statusTitle.textContent = 'Subscription Expired';
            statusText.innerHTML = `
                Expires: ${formatDate(subscriptionExpiry)}<br>
                <span style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px; display: block;">
                    ${subscriptionType === 'trial' ? 
                        '‚ö†Ô∏è Your first month free trial has ended. You need coins to continue. If you don\'t have coins, your parents will need to pay $1000 JMD to regain access.' : 
                        'Renew to continue learning'}
                </span>
            `;
            renewSection.style.display = 'block';
        } else if (daysLeft <= 7) {
            // Expiring soon
            statusIcon.textContent = '‚ö†Ô∏è';
            statusTitle.textContent = 'Expiring Soon';
            statusText.innerHTML = `
                Expires: ${formatDate(subscriptionExpiry)} (${daysLeft} day${daysLeft !== 1 ? 's' : ''} remaining)
                ${subscriptionType === 'trial' ? 
                    '<br><span style="font-size: 0.85rem; opacity: 0.8; margin-top: 8px; display: block;">‚ö†Ô∏è This is your first month free trial. After it expires, you\'ll need coins to continue. If you don\'t have coins, your parents will need to pay $1000 JMD.</span>' : 
                    ''}
            `;
            renewSection.style.display = 'block';
        } else {
            // Active
            statusIcon.textContent = 'üîì';
            statusTitle.textContent = subscriptionType === 'trial' ? 'Free Trial Active' : 'Active Subscription';
            statusText.innerHTML = `
                Expires: ${formatDate(subscriptionExpiry)} (${daysLeft} days left)
                ${subscriptionType === 'trial' ? 
                    '<br><span style="font-size: 0.85rem; opacity: 0.8; margin-top: 8px; display: block;">‚ö†Ô∏è This is your first month free trial. After it expires, you\'ll need 300 coins to continue. If you don\'t have coins, your parents will need to pay $1000 JMD.</span>' : 
                    ''}
            `;
            renewSection.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Error updating dashboard subscription status:', error);
    }
}


 // ===== LIVE QUIZ FUNCTIONS =====

async function loadQuizOnlineUsers() {
    if (!currentUser) {
        const listElement = document.getElementById('quiz-online-users-list');
        if (listElement) {
            listElement.innerHTML = '<div class="loading">Please sign in to see online users</div>';
        }
        return;
    }
    
    try {
        // Detach existing listener before creating new one
        if (quizOnlineUsersRef) {
            quizOnlineUsersRef();
            quizOnlineUsersRef = null;
        }
        
        quizOnlineUsersRef = db.collection('onlineUsers')
            .where('userId', '!=', currentUser.uid)
            .onSnapshot(snapshot => {
                const users = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lastSeen = data.lastSeen?.toDate() || new Date(0);
                    const now = new Date();
                    const diffMinutes = (now - lastSeen) / 1000 / 60;
                    
                    if (diffMinutes < 2) {
                        users.push({ id: doc.id, ...data });
                    }
                });
                
                const countElement = document.getElementById('quiz-online-count');
                const listElement = document.getElementById('quiz-online-users-list');
                
                if (!countElement || !listElement) {
                    if (quizOnlineUsersRef) {
                        quizOnlineUsersRef();
                        quizOnlineUsersRef = null;
                    }
                    return;
                }
                
                countElement.textContent = users.length;
                
                if (users.length === 0) {
                    listElement.innerHTML = `
                        <div class="loading">
                            No other students online right now. <br>
                            Share the app with friends to challenge them!
                        </div>
                    `;
                } else {
                    displayQuizOnlineUsers(users);
                }
            });
    } catch (error) {
        console.error('Error loading online users:', error);
    }
}

function displayQuizOnlineUsers(users) {
    const container = document.getElementById('quiz-online-users-list');
    
    container.innerHTML = users.map(user => {
        let avatarHTML = '';
        
        if (user.photoURL) {
            avatarHTML = `<div style="background-image: url('${user.photoURL}'); background-size: cover; background-position: center; width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px;"></div>`;
        } else {
            const initial = (user.name || 'S').charAt(0).toUpperCase();
            avatarHTML = `<div class="user-avatar" style="margin: 0 auto 10px;">${initial}</div>`;
        }
        
        return `
            <div class="online-user-card" data-user-id="${user.userId}" data-user-name="${user.name}" onclick="sendQuizChallenge(this.dataset.userId, this.dataset.userName)">
                ${avatarHTML}
                <h3 style="color: #0d3b66; margin: 10px 0;">${user.name}</h3>
                <span class="online-status"></span>
                <span style="color: #28a745; font-weight: bold;">Online</span>
                <button class="practice-btn" style="margin-top: 15px; font-size: 0.9rem; padding: 10px 20px; pointer-events: none;">
                    ‚öîÔ∏è Challenge
                </button>
            </div>
        `;
    }).join('');
}

async function sendQuizChallenge(opponentId, opponentName) {
    if (!currentUser) return;
    
    try {
        const challengeRef = db.collection('quizChallenges').doc();
        
        await challengeRef.set({
            challenger: {
                id: currentUser.uid,
                name: currentUser.displayName || 'Student',
                photoURL: currentUser.photoURL || null
            },
            opponent: {
                id: opponentId,
                name: opponentName
            },
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showCustomPopup(`‚öîÔ∏è QUIZ CHALLENGE SENT TO ${opponentName.toUpperCase()}`);
        setTimeout(() => hideCustomPopup(), 3000);
        
    } catch (error) {
        console.error('Error sending quiz challenge:', error);
        showCustomPopup('‚ùå FAILED TO SEND');
        setTimeout(() => hideCustomPopup(), 2000);
    }
}

function listenForQuizChallenges() {
    if (!currentUser) return;
    
    if (quizChallengeListener) {
        quizChallengeListener();
    }
    
    quizChallengeListener = db.collection('quizChallenges')
        .where('opponent.id', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                const challenge = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'added' || change.type === 'modified') {
                    if (challenge.status === 'pending') {
                        const challengerId = challenge.challenger.id;
                        const challengerPresence = await db.collection('onlineUsers').doc(challengerId).get();
                        
                        if (!challengerPresence.exists) {
                            console.log('üö´ Challenger went offline - removing quiz challenge');
                            await db.collection('quizChallenges').doc(challenge.id).delete();
                            
                            const popup = document.getElementById('quiz-challenge-popup-notification');
                            if (popup) popup.remove();
                            
                            shownQuizPopupIds.delete(challenge.id);
                            return;
                        }
                        
                        showQuizChallengePopup(challenge);
                        displayIncomingQuizChallenges([challenge]);
                    } else if (challenge.status === 'active') {
                        if (!activeQuizChallenge || activeQuizChallenge.id !== challenge.id) {
                            startLiveQuizChallenge(challenge.id);
                        }
                    }
                }
                
                if (change.type === 'removed') {
                    const popup = document.getElementById('quiz-challenge-popup-notification');
                    if (popup) popup.remove();
                    
                    shownQuizPopupIds.delete(challenge.id);
                }
            });
        });
}

function listenForMyQuizChallengesAccepted() {
    if (!currentUser) return;
    
    if (myQuizChallengeListener) {
        myQuizChallengeListener();
    }
    
    myQuizChallengeListener = db.collection('quizChallenges')
        .where('challenger.id', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const challenge = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'modified' && challenge.status === 'active') {
                    if (!activeQuizChallenge || activeQuizChallenge.id !== challenge.id) {
                        hideCustomPopup();
                        
                        showBottomNotification(`${challenge.opponent.name} accepted your quiz challenge! Starting game...`, 'success');
                        
                        navigateTo('quiz');
                        switchQuizMode('live');
                        
                        startLiveQuizChallenge(change.doc.id);
                    }
                }
            });
        });
}

function showQuizChallengePopup(challenge) {
    const challengeId = challenge.id;
    
    if (shownQuizPopupIds.has(challengeId)) return;
    shownQuizPopupIds.add(challengeId);
    
    const existingPopup = document.getElementById('quiz-challenge-popup-notification');
    if (existingPopup) existingPopup.remove();
    
    const popup = document.createElement('div');
    popup.id = 'quiz-challenge-popup-notification';
    popup.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(102,126,234,0.5);
        z-index: 9999;
        min-width: 320px;
        animation: slideInRight 0.5s ease-out;
    `;
    
    let avatarHTML = '';
    if (challenge.challenger.photoURL) {
        avatarHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background-image: url('${challenge.challenger.photoURL}'); background-size: cover; background-position: center; margin: 0 auto 10px;"></div>`;
    } else {
        const initial = (challenge.challenger.name || 'S').charAt(0).toUpperCase();
        avatarHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background: #ffd700; color: #0d3b66; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 0 auto 10px;">${initial}</div>`;
    }
    
    popup.innerHTML = `
        <div style="text-align: center;">
            ${avatarHTML}
            <h3 style="margin: 0 0 10px 0; font-size: 1.3rem;">üéØ QUIZ CHALLENGE!</h3>
            <p style="margin: 10px 0; font-size: 1.1rem;"><strong>${challenge.challenger.name}</strong> challenges you!</p>
            <p style="margin: 10px 0; font-size: 0.9rem; opacity: 0.9;">Ready for a vocabulary quiz battle?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button onclick="acceptQuizChallengeFromPopup('${challengeId}')" 
                        style="padding: 12px 25px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                    ‚úÖ Accept
                </button>
                <button onclick="declineQuizChallengeFromPopup('${challengeId}')" 
                        style="padding: 12px 25px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                    ‚ùå Decline
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}

function displayIncomingQuizChallenges(challenges) {
    const section = document.getElementById('quiz-incoming-challenges-section');
    const container = document.getElementById('quiz-incoming-challenges-list');
    
    if (challenges.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    container.innerHTML = challenges.map(challenge => `
        <div class="challenge-notification">
            <h3 style="margin: 0 0 10px 0;">üéØ ${challenge.challenger.name} challenges you to a quiz!</h3>
            <p style="margin: 10px 0;">Ready for a vocabulary battle?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button class="practice-btn" onclick="acceptQuizChallenge('${challenge.id}')" 
                        style="background: #28a745;">
                    ‚úÖ Accept
                </button>
                <button class="practice-btn" onclick="declineQuizChallenge('${challenge.id}')" 
                        style="background: #dc3545;">
                    ‚ùå Decline
                </button>
            </div>
        </div>
    `).join('');
}

async function acceptQuizChallenge(challengeId) {
    console.log('‚úÖ Starting acceptQuizChallenge for:', challengeId);
    
    if (activeQuizChallenge && activeQuizChallenge.status === 'active') {
        showCustomPopup('‚ö†Ô∏è COMPLETE CURRENT QUIZ FIRST');
        setTimeout(() => hideCustomPopup(), 3000);
        
        const popup = document.getElementById('quiz-challenge-popup-notification');
        if (popup) popup.remove();
        
        return;
    }
    
    try {
        const challengeRef = db.collection('quizChallenges').doc(challengeId);
        const challengeDoc = await challengeRef.get();
        
        if (!challengeDoc.exists) {
            console.error('‚ùå Quiz challenge not found:', challengeId);
            alert('Quiz challenge not found');
            return;
        }
        
        const challengeData = challengeDoc.data();
        console.log('üìÑ Quiz challenge data:', challengeData);
        
        // Generate 5 random words and quiz questions
        if (!selectedGameLevel) {
            selectedGameLevel = 'foundation';
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            console.log('üìö Loading words for level:', selectedGameLevel);
            await loadLevelWords(selectedGameLevel);
        }
        
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        const quizWords = shuffled.slice(0, 5);
        
        console.log('üéØ Selected quiz words:', quizWords);
        
        // Generate quiz questions for these words
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                data: { 
                    action: 'generatePracticeQuiz',
                    words: quizWords 
                } 
            })
        });
        
        const data = await response.json();
        const quizQuestions = data.result.questions;
        
        await challengeRef.update({
            status: 'active',
            questions: quizQuestions,
            scores: {
                [currentUser.uid]: 0,
                [challengeData.challenger.id]: 0
            },
            completed: {
                [currentUser.uid]: false,
                [challengeData.challenger.id]: false
            },
            currentQuestion: 0,
            acceptedBy: currentUser.uid,
            startedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Quiz challenge updated to active');
        
        navigateTo('quiz', true);
        
        setTimeout(() => {
            switchQuizMode('live');
            
            setTimeout(() => {
                startLiveQuizChallenge(challengeId);
            }, 300);
        }, 300);
        
    } catch (error) {
        console.error('‚ùå Error accepting quiz challenge:', error);
        alert('Failed to accept quiz challenge: ' + error.message);
    }
}

async function acceptQuizChallengeFromPopup(challengeId) {
    console.log('üéØ Accepting quiz challenge from popup:', challengeId);
    
    if (activeQuizChallenge && activeQuizChallenge.status === 'active') {
        showCustomPopup('‚ö†Ô∏è COMPLETE CURRENT QUIZ FIRST');
        setTimeout(() => hideCustomPopup(), 3000);
        
        const popup = document.getElementById('quiz-challenge-popup-notification');
        if (popup) popup.remove();
        
        return;
    }
    
    const popup = document.getElementById('quiz-challenge-popup-notification');
    if (popup) popup.remove();
    
    shownQuizPopupIds.delete(challengeId);
    
    await acceptQuizChallenge(challengeId);
}

async function declineQuizChallenge(challengeId) {
    try {
        await db.collection('quizChallenges').doc(challengeId).delete();
        
        shownQuizPopupIds.delete(challengeId);
        
        const popup = document.getElementById('quiz-challenge-popup-notification');
        if (popup) popup.remove();
        
        const section = document.getElementById('quiz-incoming-challenges-section');
        if (section) section.style.display = 'none';
        
        console.log('‚úÖ Quiz challenge declined and deleted');
    } catch (error) {
        console.error('Error declining quiz challenge:', error);
    }
}

async function declineQuizChallengeFromPopup(challengeId) {
    console.log('‚ùå Declining quiz challenge from popup:', challengeId);
    
    const popup = document.getElementById('quiz-challenge-popup-notification');
    if (popup) popup.remove();
    
    shownQuizPopupIds.delete(challengeId);
    
    await declineQuizChallenge(challengeId);
}

async function startLiveQuizChallenge(challengeId) {
    try {
        console.log('üéÆ Starting live quiz challenge:', challengeId);
        
        if (quizOnlineUsersRef) {
            quizOnlineUsersRef();
            quizOnlineUsersRef = null;
            console.log('‚úÖ Detached quiz online users listener');
        }
        
        const challengeDoc = await db.collection('quizChallenges').doc(challengeId).get();
        
        if (!challengeDoc.exists) {
            alert('Quiz challenge not found');
            return;
        }
        
        const challenge = challengeDoc.data();
        
        activeQuizChallenge = { id: challengeId, ...challenge };
        quizChallengeWords = challenge.questions || [];
        currentQuizChallengeIndex = 0;
        myQuizScore = 0;
        opponentQuizScore = 0;
        
        const onlineUsersSection = document.getElementById('quiz-online-users-section');
        const incomingChallengesSection = document.getElementById('quiz-incoming-challenges-section');
        
        if (onlineUsersSection) onlineUsersSection.style.display = 'none';
        if (incomingChallengesSection) incomingChallengesSection.style.display = 'none';
        
        const liveQuizMode = document.getElementById('live-quiz-mode');
        if (!liveQuizMode) {
            console.error('‚ùå live-quiz-mode not found');
            alert('Failed to start quiz challenge - page element missing');
            return;
        }
        
        let welcomeSection = liveQuizMode.querySelector('.welcome-section');
        
        if (!welcomeSection) {
            welcomeSection = document.createElement('div');
            welcomeSection.className = 'welcome-section';
            liveQuizMode.appendChild(welcomeSection);
        }
        
        welcomeSection.innerHTML = '<div id="live-quiz-challenge-container"></div>';
        
        startChallengeTimeout(challengeId);
        startOfflineDetection(challengeId);
        
        db.collection('quizChallenges').doc(challengeId).onSnapshot(doc => {
            const data = doc.data();
            
            if (!data) return;
            
            if (data.status === 'completed') {
                clearChallengeTimers();
                
                if (data.endReason === 'finished') {
                    showQuizChallengeResults(data);
                } else {
                    showQuizChallengeAbandoned(data);
                }
                return;
            }
            
            if (data.status === 'abandoned') {
                clearChallengeTimers();
                showQuizChallengeAbandoned(data);
                return;
            }
            
            const opponentId = activeQuizChallenge.challenger.id === currentUser.uid ? 
                activeQuizChallenge.opponent.id : activeQuizChallenge.challenger.id;
            opponentQuizScore = data.scores?.[opponentId] || 0;
            
            const scoreElements = document.querySelectorAll('.player-score .score');
            if (scoreElements && scoreElements.length > 1) {
                scoreElements[1].textContent = opponentQuizScore;
            }
        });
        
        loadQuizChallengeQuestion();
    } catch (error) {
        console.error('Error starting quiz challenge:', error);
        alert('Failed to start quiz challenge: ' + error.message);
    }
}

function loadQuizChallengeQuestion() {
    if (!quizChallengeWords || quizChallengeWords.length === 0) {
        alert('No questions available for challenge');
        return;
    }
    
    const question = quizChallengeWords[currentQuizChallengeIndex];
    const container = document.getElementById('live-quiz-challenge-container');
    
    if (!container) {
        console.error('‚ùå live-quiz-challenge-container not found');
        return;
    }
    
    const opponentName = activeQuizChallenge.challenger.id === currentUser.uid ? 
        activeQuizChallenge.opponent.name : activeQuizChallenge.challenger.name;
    
    container.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1);">
            <h2 style="color: #0d3b66; margin-bottom: 20px; text-align: center;">üéØ Live Quiz Battle!</h2>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">You</div>
                    <div class="score">${myQuizScore}</div>
                </div>
                <div style="font-size: 2rem; align-self: center;">VS</div>
                <div class="player-score">
                    <div class="name">${opponentName}</div>
                    <div class="score">${opponentQuizScore}</div>
                </div>
            </div>
            
            <div class="quiz-question-card">
                <h3>Question ${currentQuizChallengeIndex + 1} of ${quizChallengeWords.length}</h3>
                <p style="font-size: 1.3rem; margin: 20px 0;"><strong>${question.question}</strong></p>
                <div class="quiz-options">
                    ${question.options.map((option, index) => `
                        <div class="quiz-option" onclick="submitQuizChallengeAnswer(${index})">
                            ${option}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="practice-btn" onclick="exitQuizChallenge()" style="background: #dc3545;">
                    üö™ Exit Challenge
                </button>
            </div>
        </div>
    `;
}

async function submitQuizChallengeAnswer(selectedIndex) {
    const question = quizChallengeWords[currentQuizChallengeIndex];
    const options = document.querySelectorAll('.quiz-option');
    
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        myQuizScore++;
        options[selectedIndex].classList.add('correct');
    } else {
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
    }
    
    try {
        const challengeRef = db.collection('quizChallenges').doc(activeQuizChallenge.id);
        const scoreKey = `scores.${currentUser.uid}`;
        const completedKey = `completed.${currentUser.uid}`;
        
        await challengeRef.update({
            [scoreKey]: myQuizScore,
            [`lastAnswerTime.${currentUser.uid}`]: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentQuizChallengeIndex++;
        
        if (currentQuizChallengeIndex >= quizChallengeWords.length) {
            await challengeRef.update({
                [completedKey]: true
            });
            
            const challengeDoc = await challengeRef.get();
            const challengeData = challengeDoc.data();
            const opponentId = activeQuizChallenge.challenger.id === currentUser.uid ? 
                activeQuizChallenge.opponent.id : activeQuizChallenge.challenger.id;
            
            if (challengeData.completed && challengeData.completed[opponentId]) {
                await challengeRef.update({
                    status: 'completed',
                    endReason: 'finished',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                showWaitingForQuizOpponent();
            }
        } else {
            setTimeout(() => {
                loadQuizChallengeQuestion();
            }, 2000);
        }
    } catch (error) {
        console.error('Error updating quiz score:', error);
    }
}

function showWaitingForQuizOpponent() {
    const container = document.getElementById('live-quiz-challenge-container');
    
    if (!container) {
        console.error('‚ùå live-quiz-challenge-container not found');
        return;
    }
    
    const opponentName = activeQuizChallenge.challenger.id === currentUser.uid ? 
        activeQuizChallenge.opponent.name : activeQuizChallenge.challenger.name;
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0; animation: pulse 2s infinite;">‚è≥</div>
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 20px;">
                Waiting for ${opponentName}...
            </h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You've completed all questions! <br>
                Waiting for your opponent to finish.
            </p>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">Your Score</div>
                    <div class="score">${myQuizScore}</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <div class="loading">Challenge will end when both players finish...</div>
            </div>
        </div>
    `;
}

async function showQuizChallengeResults(challenge) {
    const myId = currentUser.uid;
    const opponentId = challenge.challenger.id === myId ? challenge.opponent.id : challenge.challenger.id;
    
    const myFinalScore = challenge.scores[myId] || 0;
    const opponentFinalScore = challenge.scores[opponentId] || 0;
    
    const won = myFinalScore > opponentFinalScore;
    const tied = myFinalScore === opponentFinalScore;
    
    // Update quiz stats
    try {
        const userRef = db.collection('users').doc(myId);
        const userDoc = await userRef.get();
        const currentStats = userDoc.data().quizStats || {
            totalChallenges: 0,
            wins: 0,
            losses: 0,
            totalScore: 0,
            winStreak: 0,
            bestStreak: 0
        };
        
        let newStats = {
            totalChallenges: currentStats.totalChallenges + 1,
            wins: currentStats.wins + (won ? 1 : 0),
            losses: currentStats.losses + (tied ? 0 : (won ? 0 : 1)),
            totalScore: currentStats.totalScore + myFinalScore,
            winStreak: won ? currentStats.winStreak + 1 : 0,
            bestStreak: won ? Math.max(currentStats.bestStreak, currentStats.winStreak + 1) : currentStats.bestStreak,
            lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await userRef.update({
            quizStats: newStats
        });
        
        console.log('‚úÖ Quiz stats updated:', newStats);
    } catch (error) {
        console.error('Error updating quiz stats:', error);
    }
    
    // Award coins for win
    if (won) {
        await awardCoins(COINS_PER_WIN);
    }
    
    const container = document.getElementById('live-quiz-challenge-container');
    
    if (!container) {
        console.error('‚ùå live-quiz-challenge-container not found');
        return;
    }
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">
                ${won ? 'üèÜ' : tied ? 'ü§ù' : 'üòî'}
            </div>
            <h2 style="color: #0d3b66; font-size: 2.5rem; margin-bottom: 20px;">
                ${won ? 'Victory!' : tied ? "It's a Tie!" : 'Better Luck Next Time'}
            </h2>
            
            ${won ? `
                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 20px; border-radius: 15px; margin: 20px 0;">
                    <h3 style="color: #0d3b66; font-size: 1.5rem; margin-bottom: 10px;">ü™ô Coins Earned!</h3>
                    <p style="color: #0d3b66; font-size: 2rem; font-weight: bold;">+${COINS_PER_WIN} Coins</p>
                    <p style="color: #0d3b66; font-size: 1rem; margin-top: 5px;">Total: ${userCoins} / ${MAX_COINS}</p>
                </div>
            ` : ''}
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">You</div>
                    <div class="score">${myFinalScore}</div>
                </div>
                <div style="font-size: 2rem; align-self: center;">-</div>
                <div class="player-score">
                    <div class="name">Opponent</div>
                    <div class="score">${opponentFinalScore}</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="practice-btn" onclick="navigateTo('quiz'); switchQuizMode('leaderboard');" style="background: #667eea; margin: 5px;">
                    üìä View Leaderboard
                </button>
                <button class="practice-btn" onclick="exitQuizChallenge()" style="margin: 5px;">
                    üè† Back to Lobby
                </button>
            </div>
        </div>
    `;
}

function showQuizChallengeAbandoned(challenge) {
    const container = document.getElementById('live-quiz-challenge-container');
    
    if (!container) {
        console.error('‚ùå live-quiz-challenge-container not found');
        return;
    }
    
    const iWon = challenge.winner === currentUser.uid;
    
    let message = '';
    if (challenge.endReason === 'opponent_left') {
        message = 'Your opponent left the challenge.';
    } else if (challenge.endReason === 'opponent_offline') {
        message = 'Your opponent went offline.';
    } else {
        message = 'The challenge was cancelled.';
    }
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${iWon ? 'üèÜ' : 'üö´'}</div>
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 15px;">Challenge Ended</h2>
            <p style="font-size: 1.2rem; margin: 20px 0; color: #666;">
                ${message}
            </p>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">Your Score</div>
                    <div class="score">${myQuizScore}</div>
                </div>
            </div>
            
            ${iWon ? `
                <p style="margin: 20px 0; font-size: 1.5rem; color: #28a745; font-weight: bold;">
                    üéâ You win by default!
                </p>
            ` : `
                <p style="margin: 20px 0; font-size: 1.2rem; color: #dc3545; font-weight: bold;">
                    You left the challenge
                </p>
            `}
            
            <button class="practice-btn" onclick="exitQuizChallenge()" style="margin-top: 30px; font-size: 1.2rem; padding: 15px 40px;">
                üè† Back to Lobby
            </button>
        </div>
    `;
}

async function exitQuizChallenge() {
    try {
        if (activeQuizChallenge && activeQuizChallenge.status === 'active') {
            const challengeDoc = await db.collection('quizChallenges').doc(activeQuizChallenge.id).get();
            const challengeData = challengeDoc.data();
            
            const userCompleted = challengeData.completed && challengeData.completed[currentUser.uid];
            
            if (!userCompleted) {
                const opponentId = activeQuizChallenge.challenger.id === currentUser.uid ? 
                    activeQuizChallenge.opponent.id : activeQuizChallenge.challenger.id;
                
                await db.collection('quizChallenges').doc(activeQuizChallenge.id).update({
                    status: 'abandoned',
                    endReason: 'opponent_left',
                    winner: opponentId,
                    loser: currentUser.uid,
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ Quiz challenge abandoned - opponent wins');
            } else {
                console.log('‚úÖ User completed quiz challenge, just returning to lobby');
            }
        }
    } catch (error) {
        console.error('Error updating quiz challenge on exit:', error);
    }
    
    clearChallengeTimers();
    
    activeQuizChallenge = null;
    quizChallengeWords = [];
    currentQuizChallengeIndex = 0;
    myQuizScore = 0;
    opponentQuizScore = 0;
    shownQuizPopupIds.clear();
    
    const onlineUsersSection = document.getElementById('quiz-online-users-section');
    const incomingChallengesSection = document.getElementById('quiz-incoming-challenges-section');
    
    if (onlineUsersSection) {
        onlineUsersSection.style.display = 'block';
    }
    
    if (incomingChallengesSection) {
        incomingChallengesSection.style.display = 'none';
    }
    
    const liveQuizMode = document.getElementById('live-quiz-mode');
    if (!liveQuizMode) {
        console.error('‚ùå live-quiz-mode not found');
        return;
    }
    
    let welcomeSection = liveQuizMode.querySelector('.welcome-section');
    
    if (!welcomeSection) {
        welcomeSection = document.createElement('div');
        welcomeSection.className = 'welcome-section';
        liveQuizMode.appendChild(welcomeSection);
    }
    
    welcomeSection.innerHTML = `
        <h2>‚ö° Live Quiz Challenges</h2>
        <p style="margin: 20px 0;">Challenge other students to vocabulary quiz battles in real-time!</p>
        
        <!-- Online Users Section -->
        <div id="quiz-online-users-section">
            <h3 style="color: #0d3b66; margin: 20px 0;">üë• Online Students (<span id="quiz-online-count">0</span>)</h3>
            <div id="quiz-online-users-list" class="favorites-grid">
                <div class="loading">Loading online users...</div>
            </div>
        </div>
        
        <!-- Incoming Challenges -->
        <div id="quiz-incoming-challenges-section" style="margin-top: 30px; display: none;">
            <h3 style="color: #dc3545; margin: 20px 0;">‚ö° Incoming Quiz Challenges</h3>
            <div id="quiz-incoming-challenges-list"></div>
        </div>
    `;
    
    loadQuizOnlineUsers();
}

// Quiz Leaderboard Functions
async function loadQuizLeaderboard() {
    const container = document.getElementById('quiz-leaderboard-container');
    
    if (!container) {
        console.error('‚ùå Quiz leaderboard container not found');
        return;
    }
    
    try {
        container.innerHTML = '<div class="loading">üìä Loading quiz leaderboard...</div>';
        
        const usersSnapshot = await db.collection('users')
            .where('quizStats.wins', '>', 0)
            .orderBy('quizStats.wins', 'desc')
            .limit(50)
            .get();
        
        if (usersSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üèÜ</div>
                    <h3>No ranked players yet</h3>
                    <p>Be the first to win a quiz challenge!</p>
                </div>
            `;
            return;
        }
        
        const players = [];
        usersSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.quizStats) {
                players.push({
                    id: doc.id,
                    name: data.name,
                    email: data.email,
                    photoURL: data.photoURL,
                    country: data.country,
                    age: data.age,
                    createdAt: data.createdAt,
                    stats: data.quizStats
                });
            }
        });
        
        players.sort((a, b) => {
            if (b.stats.wins !== a.stats.wins) {
                return b.stats.wins - a.stats.wins;
            }
            const aWinRate = a.stats.wins / a.stats.totalChallenges;
            const bWinRate = b.stats.wins / b.stats.totalChallenges;
            return bWinRate - aWinRate;
        });
        
        const myRank = players.findIndex(p => p.id === currentUser?.uid) + 1;
        
        container.innerHTML = `
            ${currentUser && myRank > 0 ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 25px; color: white; text-align: center;">
                    <h3 style="margin: 0 0 10px 0; color: white;">üéØ Your Rank</h3>
                    <p style="font-size: 2.5rem; margin: 10px 0; font-weight: bold;">#${myRank}</p>
                    <p style="margin: 5px 0; opacity: 0.9;">
                        ${players[myRank - 1].stats.wins} Wins ‚Ä¢ 
                        ${players[myRank - 1].stats.totalChallenges} Challenges
                    </p>
                </div>
            ` : ''}
            
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: center;">üèÜ Rank</th>
                            <th>üë§ Player</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${players.map((player, index) => {
                            const isCurrentUser = currentUser && player.id === currentUser.uid;
                            
                            let rankEmoji = '';
                            if (index === 0) rankEmoji = 'ü•á';
                            else if (index === 1) rankEmoji = 'ü•à';
                            else if (index === 2) rankEmoji = 'ü•â';
                            
                            let avatarHTML = '';
                            if (player.photoURL) {
                                avatarHTML = `<div style="width: 45px; height: 45px; min-width: 45px; border-radius: 50%; background-image: url('${player.photoURL}'); background-size: cover; background-position: center;"></div>`;
                            } else {
                                const initial = (player.name || 'P').charAt(0).toUpperCase();
                                avatarHTML = `<div class="coach-avatar" style="width: 45px; height: 45px; min-width: 45px;">${initial}</div>`;
                            }
                            
                            return `
                                <tr onclick="showQuizLeaderboardPlayerDetail('${player.id}', ${index + 1})" style="cursor: pointer; ${isCurrentUser ? 'background: #e3f2fd;' : ''}">
                                    <td style="text-align: center; font-size: 1.3rem; font-weight: bold; color: #0d3b66;">
                                        ${rankEmoji || (index + 1)}
                                    </td>
                                    <td>
                                        <div class="coach-profile-cell">
                                            ${avatarHTML}
                                            <div class="coach-name">${player.name}${isCurrentUser ? ' (You)' : ''}</div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">üèÜ How Rankings Work</h3>
                <p style="color: #666; line-height: 1.6;">
                    ‚Ä¢ Players are ranked by <strong>total wins</strong> in live quiz challenges<br>
                    ‚Ä¢ Click on any player to view their detailed stats<br>
                    ‚Ä¢ Challenge top players to climb the leaderboard!
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading quiz leaderboard:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading leaderboard. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadQuizLeaderboard()">üîÑ Retry</button>
            </div>
        `;
    }
}

async function showQuizLeaderboardPlayerDetail(playerId, rank) {
    try {
        console.log('üìã Loading quiz player details for:', playerId);
        const playerDoc = await db.collection('users').doc(playerId).get();
        
        if (!playerDoc.exists) {
            console.error('‚ùå Player not found');
            alert('Player profile not found');
            return;
        }
        
        const player = { id: playerDoc.id, ...playerDoc.data() };
        console.log('Player data loaded:', player);
        
        const modal = document.getElementById('quizLeaderboardPlayerModal');
        
        const studentId = `WB-2025-${player.id.slice(-4).toUpperCase()}`;
        
        const stats = player.quizStats || {
            wins: 0,
            losses: 0,
            totalChallenges: 0,
            winStreak: 0,
            bestStreak: 0,
            totalScore: 0
        };
        
        const winRate = stats.totalChallenges > 0 
            ? ((stats.wins / stats.totalChallenges) * 100).toFixed(1) 
            : '0.0';
        
        let rankEmoji = '';
        if (rank === 1) rankEmoji = 'ü•á';
        else if (rank === 2) rankEmoji = 'ü•à';
        else if (rank === 3) rankEmoji = 'ü•â';
        
        const avatar = document.getElementById('modal-quiz-leaderboard-avatar');
        if (player.photoURL) {
            console.log('üñºÔ∏è Setting photo URL:', player.photoURL);
            avatar.style.backgroundImage = `url('${player.photoURL}')`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
            avatar.textContent = '';
        } else {
            console.log('üî§ No photo URL, using initial');
            avatar.style.backgroundImage = 'none';
            avatar.textContent = (player.name || 'P').charAt(0).toUpperCase();
        }
        
        document.getElementById('modal-quiz-leaderboard-name').textContent = player.name || 'Player';
        document.getElementById('modal-quiz-leaderboard-rank').innerHTML = `${rankEmoji} Rank #${rank}`;
        document.getElementById('modal-quiz-leaderboard-id').textContent = studentId;
        document.getElementById('modal-quiz-leaderboard-email').textContent = player.email || 'N/A';
        document.getElementById('modal-quiz-leaderboard-country').textContent = player.country || 'N/A';
        
        const ageRow = document.getElementById('modal-quiz-leaderboard-age-row');
        if (player.age) {
            ageRow.style.display = 'flex';
            document.getElementById('modal-quiz-leaderboard-age').textContent = player.age + ' years old';
        } else {
            ageRow.style.display = 'none';
        }
        
        if (player.createdAt) {
            const joinDate = player.createdAt.toDate();
            document.getElementById('modal-quiz-leaderboard-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            document.getElementById('modal-quiz-leaderboard-joined').textContent = 'Recently';
        }
        
        document.getElementById('modal-quiz-leaderboard-wins').textContent = stats.wins;
        document.getElementById('modal-quiz-leaderboard-losses').textContent = stats.losses;
        document.getElementById('modal-quiz-leaderboard-total').textContent = stats.totalChallenges;
        document.getElementById('modal-quiz-leaderboard-winrate').textContent = winRate + '%';
        document.getElementById('modal-quiz-leaderboard-streak').textContent = stats.winStreak > 0 ? 'üî• ' + stats.winStreak : '-';
        document.getElementById('modal-quiz-leaderboard-best').textContent = stats.bestStreak;
        
        modal.classList.add('active');
        console.log('Modal displayed');
        
    } catch (error) {
       console.error('‚ùå Error loading quiz player details:', error);
        alert('Unable to load player details: ' + error.message);
    }
}

function closeQuizLeaderboardPlayerModal() {
    document.getElementById('quizLeaderboardPlayerModal').classList.remove('active');
}

// Initialize quiz listeners when switching to live mode
document.addEventListener('DOMContentLoaded', function() {
    // Listen for quiz challenges when user signs in
    auth.onAuthStateChanged(user => {
        if (user) {
            listenForQuizChallenges();
            listenForMyQuizChallengesAccepted();
        }
    });
});

// Cleanup old quiz challenges on page load
async function cleanupOldQuizChallenges() {
    if (!currentUser) {
        console.log('‚è≠Ô∏è Skipping quiz challenge cleanup - no user logged in');
        return;
    }
    
    try {
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        
        const myQuizChallenges = await db.collection('quizChallenges')
            .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(oneDayAgo))
            .get();
        
        const deletePromises = [];
        myQuizChallenges.docs.forEach(doc => {
            const data = doc.data();
            if (data.challenger?.id === currentUser.uid || data.opponent?.id === currentUser.uid) {
                deletePromises.push(doc.ref.delete());
            }
        });
        
        if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            console.log(`üßπ Cleaned up ${deletePromises.length} old quiz challenges`);
        }
    } catch (error) {
        console.log('‚ÑπÔ∏è Could not cleanup old quiz challenges (this is normal):', error.message);
    }
}

// Check quiz challenger presence every 10 seconds
setInterval(async () => {
    if (!currentUser) return;
    
    try {
        const pendingQuizChallenges = await db.collection('quizChallenges')
            .where('opponent.id', '==', currentUser.uid)
            .where('status', '==', 'pending')
            .get();
        
        for (const doc of pendingQuizChallenges.docs) {
            const challenge = doc.data();
            const challengerId = challenge.challenger.id;
            
            const challengerPresence = await db.collection('onlineUsers').doc(challengerId).get();
            
            if (!challengerPresence.exists) {
                console.log('üö´ Quiz challenger offline - removing challenge:', doc.id);
                await doc.ref.delete();
                
                const popup = document.getElementById('quiz-challenge-popup-notification');
                if (popup) popup.remove();
                
                shownQuizPopupIds.delete(doc.id);
            }
        }
    } catch (error) {
        console.error('Error checking quiz challenger presence:', error);
    }
}, 10000);

// Call cleanup on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        cleanupOldChallenges();
        cleanupOldQuizChallenges();
    }, 2000);
});



// ===== STUDENT ID GENERATION =====
function generateStudentId(userId) {
    return `WB-2025-${userId.slice(-4).toUpperCase()}`;
}  


 // ===== PARENT DASHBOARD FUNCTIONS =====
async function loadParentDashboard() {
    if (!currentUser) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData.userType !== 'parent') {
            alert('Access denied. Parent accounts only.');
            navigateTo('home');
            return;
        }
        
        // Update parent profile
        document.getElementById('parent-dashboard-name').textContent = userData.name || 'Parent';
        document.getElementById('parent-dashboard-email').textContent = userData.email || '';
        
        const parentAvatar = document.getElementById('parent-dashboard-avatar');
        if (currentUser.photoURL) {
            parentAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            parentAvatar.textContent = '';
        } else {
            parentAvatar.style.backgroundImage = 'none';
            parentAvatar.textContent = userData.name.charAt(0).toUpperCase();
        }
        
        // Update profile fields
        document.getElementById('parent-display-name').textContent = userData.name;
        document.getElementById('parent-edit-name').value = userData.name;
        document.getElementById('parent-display-email').textContent = userData.email;
        document.getElementById('parent-display-phone').textContent = userData.phone || 'Not set';
        document.getElementById('parent-edit-phone').value = userData.phone || '';
        document.getElementById('parent-display-country').textContent = userData.country || 'Not set';
        document.getElementById('parent-edit-country').value = userData.country || '';
        
        if (userData.createdAt) {
            const joinDate = userData.createdAt.toDate();
            document.getElementById('parent-display-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        // Load child information
        await loadChildAccountStatus(userData.linkedStudentId);
        
        // Load transaction history
        await loadTransactionHistory();
        
    } catch (error) {
        console.error('Error loading parent dashboard:', error);
        alert('Failed to load dashboard: ' + error.message);
    }
}

async function loadChildAccountStatus(childId) {
    const container = document.getElementById('child-status-container');
    
    try {
        container.innerHTML = '<div class="loading">Loading child account status...</div>';
        
        const childDoc = await db.collection('users').doc(childId).get();
        
        if (!childDoc.exists) {
            container.innerHTML = '<div class="feedback error">‚ùå Child account not found</div>';
            return;
        }
        
        const childData = childDoc.data();
        currentChildData = { id: childId, ...childData };
        
        const subscriptionExpiry = childData.subscriptionExpiry?.toDate();
        const coins = childData.coins || 0;
        const now = new Date();
        
        let statusClass = 'active';
        let statusIcon = '‚úÖ';
        let statusTitle = 'Account Active';
        let statusMessage = 'Your child\'s account is active and they can continue learning.';
        let showReopenButton = false;
        
        // Check if subscription expired
        if (subscriptionExpiry && now > subscriptionExpiry) {
            statusClass = '';
            statusIcon = 'üîí';
            statusTitle = 'Account Locked';
            statusMessage = 'Subscription has expired. Your child cannot access learning materials until account is reopened.';
            showReopenButton = true;
        } else if (coins < 300 && subscriptionExpiry) {
            // Check if expiring soon (within 7 days)
            const daysLeft = Math.ceil((subscriptionExpiry - now) / (1000 * 60 * 60 * 24));
            if (daysLeft <= 7) {
                statusClass = 'warning';
                statusIcon = '‚ö†Ô∏è';
                statusTitle = 'Low Coins Warning';
                statusMessage = `Your child has only ${coins} coins and ${daysLeft} days left. They won\'t be able to renew their subscription when it expires.`;
                showReopenButton = false;
            }
        }
        
        const studentId = childData.studentId || `WB-2025-${childId.slice(-4).toUpperCase()}`;
        
        container.innerHTML = `
            <div class="child-status-card ${statusClass}">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 4rem; margin-bottom: 10px;">${statusIcon}</div>
                    <h2 style="margin: 0 0 10px 0; color: white;">${statusTitle}</h2>
                    <p style="margin: 0; opacity: 0.95; font-size: 1.1rem;">${statusMessage}</p>
                </div>
                
                <div class="child-info-grid">
                    <div class="child-info-item">
                        <div class="child-info-label">üë§ Child Name</div>
                        <div class="child-info-value">${childData.name || 'Student'}</div>
                    </div>
                    
                    <div class="child-info-item">
                        <div class="child-info-label">üÜî Student ID</div>
                        <div class="child-info-value" style="font-size: 1.2rem;">${studentId}</div>
                    </div>
                    
                    <div class="child-info-item">
                        <div class="child-info-label">ü™ô Coins</div>
                        <div class="child-info-value">${coins} / 1000</div>
                    </div>
                    
                    <div class="child-info-item">
                        <div class="child-info-label">üìÖ Subscription</div>
                        <div class="child-info-value" style="font-size: 1rem;">
                            ${subscriptionExpiry ? 
                                (now > subscriptionExpiry ? 'Expired' : 
                                `${Math.ceil((subscriptionExpiry - now) / (1000 * 60 * 60 * 24))} days left`) 
                                : 'Never activated'}
                        </div>
                    </div>
                </div>
                
                ${showReopenButton ? `
                    <button class="reopen-account-btn" onclick="showPaymentModal()">
                        üí≥ Reopen Account for $6.50 USD
                    </button>
                    
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">
                        <p style="margin: 0; font-size: 0.9rem; opacity: 0.95;">
                            ‚ÑπÔ∏è Payment will immediately reopen your child's account for 30 days. 
                            They will regain full access to all learning materials.
                        </p>
                    </div>
                ` : ''}
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading child account status:', error);
        container.innerHTML = '<div class="feedback error">‚ùå Failed to load child account status</div>';
    }
}

async function showPaymentModal() {
    if (!currentChildData) {
        alert('Child data not loaded');
        return;
    }
    
    const modal = document.getElementById('paymentModal');
    const studentId = currentChildData.studentId || `WB-2025-${currentChildData.id.slice(-4).toUpperCase()}`;
    
    document.getElementById('payment-child-name').textContent = currentChildData.name || 'Student';
    document.getElementById('payment-child-id').textContent = studentId;
    
    modal.classList.add('active');
    
    // Load PayPal SDK first, then initialize button
    if (!paypalButtonRendered) {
        try {
            await loadPayPalSDK();
            initializePayPalButton();
        } catch (error) {
            console.error('Failed to load PayPal:', error);
            showPaymentError('Failed to load payment system. Please try again.');
        }
    }
}

function closePaymentModal() {
    document.getElementById('paymentModal').classList.remove('active');
}

function initializePayPalButton() {
    const container = document.getElementById('paypal-button-container');
    container.innerHTML = ''; // Clear any existing buttons
    
    paypal.Buttons({
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    description: `WordBiz Academy - 30 Day Access for ${currentChildData.name}`,
                    amount: {
                        currency_code: 'USD',
                        value: REOPEN_ACCOUNT_COST.toFixed(2)
                    }
                }]
            });
        },
        onApprove: async function(data, actions) {
            try {
                // Capture the payment
                const order = await actions.order.capture();
                console.log('‚úÖ Payment captured:', order);
                
                // Verify payment with our backend
                const verifyResponse = await fetch(PAYPAL_VERIFY_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        orderId: order.id 
                    })
                });
                
                const verifyResult = await verifyResponse.json();
                console.log('‚úÖ Verification result:', verifyResult);
                
                if (verifyResult.success && verifyResult.data.verified) {
                    await processPaymentSuccess(verifyResult.data);
                } else {
                    throw new Error('Payment verification failed');
                }
                
            } catch (error) {
                console.error('‚ùå Payment error:', error);
                showPaymentError('Failed to process payment: ' + error.message);
            }
        },
        onError: function(err) {
            console.error('‚ùå PayPal error:', err);
            showPaymentError('Payment failed. Please try again.');
        },
        onCancel: function(data) {
            console.log('‚ö†Ô∏è Payment cancelled by user');
            showPaymentError('Payment was cancelled.');
        }
    }).render('#paypal-button-container');
    
    paypalButtonRendered = true;
}
        
      async function processPaymentSuccess(order) {
    try {
        const errorDiv = document.getElementById('payment-error');
        const successDiv = document.getElementById('payment-success');
        
        errorDiv.style.display = 'none';
        successDiv.style.display = 'block';
        successDiv.textContent = '‚úÖ Payment captured! Verifying with server...';
        
        console.log('üì§ Sending verification request to server...');
        
        // Verify payment with backend
        const verifyResponse = await fetch(PAYPAL_HANDLER_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                action: 'verify_reopen',
                orderId: order.id,
                userId: currentUser.uid,
                childId: currentChildData.id
            })
        });
        
        if (!verifyResponse.ok) {
            const errorText = await verifyResponse.text();
            console.error('‚ùå Server response error:', errorText);
            throw new Error(`Server error: ${verifyResponse.status}`);
        }
        
        const verifyResult = await verifyResponse.json();
        console.log('‚úÖ Verification result:', verifyResult);
        
        if (!verifyResult.success) {
            throw new Error(verifyResult.error || 'Payment verification failed');
        }
        
        successDiv.textContent = '‚úÖ Payment successful! Account reopened for 30 days!';
        
        // Reload child status
        setTimeout(async () => {
            closePaymentModal();
            await loadChildAccountStatus(currentChildData.id);
            
            alert('‚úÖ Success!\n\nYour child\'s account has been reopened for 30 days.\nThey can now resume learning immediately.');
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå Error processing payment:', error);
        showPaymentError('Payment failed: ' + error.message);
    }
}

function showPaymentError(message) {
    const errorDiv = document.getElementById('payment-error');
    const successDiv = document.getElementById('payment-success');
    
    successDiv.style.display = 'none';
    errorDiv.style.display = 'block';
    errorDiv.textContent = message;
}

async function loadTransactionHistory() {
    const container = document.getElementById('transaction-history-container');
    
    try {
        container.innerHTML = '<div class="loading">Loading payment history...</div>';
        
        const transactionsSnapshot = await db.collection('users')
            .doc(currentUser.uid)
            .collection('transactions')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .get();
        
        if (transactionsSnapshot.empty) {
            container.innerHTML = '<div class="loading">No payment history yet</div>';
            return;
        }
        
        let html = '<div class="transaction-history">';
        
        transactionsSnapshot.forEach(doc => {
            const transaction = doc.data();
            const date = transaction.createdAt?.toDate();
            const expiryDate = transaction.expiryDate?.toDate();
            
            html += `
                <div class="transaction-item ${transaction.status === 'failed' ? 'failed' : ''}">
                    <div class="transaction-date">
                        üìÖ ${date ? date.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Unknown date'}
                    </div>
                    <div class="transaction-amount">
                        üí≥ $${transaction.amount.toFixed(2)} USD
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                        <strong>For:</strong> ${transaction.childName}<br>
                        <strong>Service:</strong> 30-Day Access<br>
                        ${expiryDate ? `<strong>Valid Until:</strong> ${expiryDate.toLocaleDateString('en-US', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric'
                        })}<br>` : ''}
                        <strong>Status:</strong> ${transaction.status === 'completed' ? '‚úÖ Completed' : '‚ùå Failed'}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Error loading transaction history:', error);
        container.innerHTML = '<div class="feedback error">‚ùå Failed to load payment history</div>';
    }
}

function toggleParentEditMode() {
    document.getElementById('parent-display-name').style.display = 'none';
    document.getElementById('parent-edit-name').style.display = 'block';
    
    document.getElementById('parent-display-phone').style.display = 'none';
    document.getElementById('parent-edit-phone').style.display = 'block';
    
    document.getElementById('parent-display-country').style.display = 'none';
    document.getElementById('parent-edit-country').style.display = 'block';
    
    document.getElementById('parent-edit-profile-btn').style.display = 'none';
    document.getElementById('parent-save-profile-btn').style.display = 'inline-block';
    document.getElementById('parent-cancel-edit-btn').style.display = 'inline-block';
}

function cancelParentEditMode() {
    document.getElementById('parent-display-name').style.display = 'inline';
    document.getElementById('parent-edit-name').style.display = 'none';
    
    document.getElementById('parent-display-phone').style.display = 'inline';
    document.getElementById('parent-edit-phone').style.display = 'none';
    
    document.getElementById('parent-display-country').style.display = 'inline';
    document.getElementById('parent-edit-country').style.display = 'none';
    
    document.getElementById('parent-edit-profile-btn').style.display = 'inline-block';
    document.getElementById('parent-save-profile-btn').style.display = 'none';
    document.getElementById('parent-cancel-edit-btn').style.display = 'none';
}

async function saveParentProfile() {
    if (!currentUser) return;
    
    const newName = document.getElementById('parent-edit-name').value.trim();
    const newPhone = document.getElementById('parent-edit-phone').value.trim();
    const newCountry = document.getElementById('parent-edit-country').value;
    
    if (!newName) {
        alert('Name cannot be empty');
        return;
    }
    
    try {
        await db.collection('users').doc(currentUser.uid).update({
            name: newName,
            phone: newPhone,
            country: newCountry
        });
        
        await currentUser.updateProfile({ displayName: newName });
        
        document.getElementById('parent-display-name').textContent = newName;
        document.getElementById('parent-display-phone').textContent = newPhone || 'Not set';
        document.getElementById('parent-display-country').textContent = newCountry || 'Not set';
        
        document.getElementById('parent-dashboard-name').textContent = newName;
        
        cancelParentEditMode();
        alert('Profile updated successfully!');
    } catch (error) {
        console.error('Error updating parent profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
}

// Add parent dashboard to navigation
async function goToParentDashboard() {
    if (!currentUser) {
        showAuthModal();
        return;
    }
    
    navigateTo('parent-dashboard');
    await loadParentDashboard();
}       

// ===== SPONSOR FUNCTIONS =====

function showSponsorModal() {
    const modal = document.getElementById('sponsorModal');
    if (modal) {
        modal.classList.add('active');
    } else {
        console.error('Sponsor modal not found');
    }
}
        
function closeSponsorModal() {
    const modal = document.getElementById('sponsorModal');
    if (modal) {
        modal.classList.remove('active');
    }
}



     // ===== TOURNAMENT STAGE 1 FUNCTIONS =====

async function startTournamentStage1(tournamentId) {
    try {
        console.log('üèÜ Starting Tournament Stage 1:', tournamentId);
        
        currentTournament = tournamentId;
        tournamentStage = 1;
        stage1CurrentIndex = 0;
        stage1Score = 0;
        stage1Errors = 0;
        stage1Handicaps = 2;
        stage1TimeLeft = 600; // 10 minutes
        
        // Hide lobby, show stage 1
        document.getElementById('tournament-lobby').style.display = 'none';
        document.getElementById('tournament-stage1').style.display = 'block';
        
        // Generate 25 antonym/synonym questions
        await generateStage1Questions();
        
        // Start timer
        startStage1Timer();
        
        // Load first question
        loadStage1Question();
        
    } catch (error) {
        console.error('Error starting Stage 1:', error);
        alert('Failed to start tournament: ' + error.message);
    }
}

async function generateStage1Questions() {
    try {
        // Load words from current level
        if (!selectedGameLevel) {
            selectedGameLevel = 'challenge'; // Default to challenge level
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select 25 random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        const selectedWords = shuffled.slice(0, 25);
        
        console.log('üìù Generating questions for:', selectedWords);
        
        // Generate questions using AI
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                data: { 
                    action: 'generateAntonymSynonymQuestions',
                    words: selectedWords 
                } 
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to generate questions');
        }
        
        const data = await response.json();
        stage1Questions = data.result.questions;
        
        console.log('‚úÖ Generated', stage1Questions.length, 'questions');
        
    } catch (error) {
        console.error('Error generating Stage 1 questions:', error);
        throw error;
    }
}

function loadStage1Question() {
    if (stage1CurrentIndex >= stage1Questions.length) {
        completeStage1();
        return;
    }
    
    const question = stage1Questions[stage1CurrentIndex];
    const container = document.getElementById('stage1-question-container');
    
    document.getElementById('stage1-progress').textContent = 
        `Question ${stage1CurrentIndex + 1} of ${stage1Questions.length}`;
    
    container.innerHTML = `
        <div style="margin: 30px 0;">
            <p style="font-size: 1.3rem; margin-bottom: 20px; line-height: 1.6;">
                <strong>${question.sentence}</strong>
            </p>
            <p style="color: #666; margin-bottom: 10px;">
                Select the best ${question.type === 'synonym' ? 'SYNONYM' : 'ANTONYM'} for the word: 
                <strong style="color: #0d3b66;">${question.targetWord}</strong>
            </p>
        </div>
        
        <div class="quiz-options">
            ${question.options.map((option, index) => `
                <div class="quiz-option" onclick="checkStage1Answer(${index})">
                    ${option}
                </div>
            `).join('')}
        </div>
        
        <div id="stage1-feedback" style="margin-top: 20px;"></div>
    `;
}

function checkStage1Answer(selectedIndex) {
    const question = stage1Questions[stage1CurrentIndex];
    const options = document.querySelectorAll('.quiz-option');
    const feedbackDiv = document.getElementById('stage1-feedback');
    
    // Disable all options
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        stage1Score++;
        options[selectedIndex].classList.add('correct');
        feedbackDiv.innerHTML = '<div class="feedback success">‚úÖ Correct!</div>';
        
        // Update score display
        document.getElementById('stage1-score').textContent = stage1Score;
        
        // Move to next question after 1 second
        setTimeout(() => {
            stage1CurrentIndex++;
            loadStage1Question();
        }, 1000);
        
    } else {
        stage1Errors++;
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
        
        // Update errors display
        document.getElementById('stage1-errors').textContent = stage1Errors;
        
        // Check if eliminated
        if (stage1Errors >= 2 && stage1Handicaps === 0) {
            feedbackDiv.innerHTML = '<div class="feedback error">‚ùå Eliminated! You made 2 errors with no handicaps remaining.</div>';
            setTimeout(() => eliminateFromStage1(), 2000);
        } else if (stage1Errors >= 2 && stage1Handicaps > 0) {
            // Use handicap
            stage1Handicaps--;
            stage1Errors = 0; // Reset errors
            document.getElementById('stage1-handicaps').textContent = stage1Handicaps;
            document.getElementById('stage1-errors').textContent = stage1Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå Wrong answer!<br>
                    üõ°Ô∏è Handicap used! Errors reset. Handicaps remaining: ${stage1Handicaps}
                </div>
            `;
            
            setTimeout(() => {
                stage1CurrentIndex++;
                loadStage1Question();
            }, 2000);
        } else {
            feedbackDiv.innerHTML = `<div class="feedback error">‚ùå Wrong! Correct answer: ${question.options[question.correctAnswer]}</div>`;
            setTimeout(() => {
                stage1CurrentIndex++;
                loadStage1Question();
            }, 2000);
        }
    }
}

function startStage1Timer() {
    if (stage1Timer) clearInterval(stage1Timer);
    
    stage1Timer = setInterval(() => {
        stage1TimeLeft--;
        
        const minutes = Math.floor(stage1TimeLeft / 60);
        const seconds = stage1TimeLeft % 60;
        document.getElementById('stage1-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is low
        if (stage1TimeLeft <= 60) {
            document.getElementById('stage1-timer').style.color = '#dc3545';
        }
        
        if (stage1TimeLeft <= 0) {
            clearInterval(stage1Timer);
            completeStage1();
        }
    }, 1000);
}

function completeStage1() {
    clearInterval(stage1Timer);
    
    const container = document.getElementById('stage1-question-container');
    const feedbackDiv = document.getElementById('stage1-feedback');
    
    const percentage = Math.round((stage1Score / stage1Questions.length) * 100);
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'üèÜ' : percentage >= 60 ? '‚≠ê' : 'üìö'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 1 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage1Score} / ${stage1Questions.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                üõ°Ô∏è Handicaps Remaining: ${stage1Handicaps}
            </p>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ Qualified for Stage 2!</h3>
                    <p style="color: #155724;">
                        You'll carry ${stage1Handicaps} handicap(s) into the next round.
                    </p>
                </div>
                <button class="practice-btn" onclick="proceedToStage2()" style="font-size: 1.2rem; padding: 15px 40px;">
                    ‚û°Ô∏è Proceed to Stage 2
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">‚ùå Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance to Stage 2.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    üè† Return to Lobby
                </button>
            `}
        </div>
    `;
    
    feedbackDiv.innerHTML = '';
}

function eliminateFromStage1() {
    clearInterval(stage1Timer);
    
    const container = document.getElementById('stage1-question-container');
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üò¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 1</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You made 2 errors with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage1Score} / ${stage1CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                üè† Return to Lobby
            </button>
        </div>
    `;
}

function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    // Reload tournament list
    loadTournamentList();
}

function proceedToStage2() {
    alert('Stage 2 will be implemented next! üéâ');
    // This will be implemented in the next step
}

async function loadTournamentList() {
    const container = document.getElementById('tournament-list-container');
    container.innerHTML = '<div class="loading">Loading tournaments...</div>';
    
    try {
        // Load tournaments from Firestore
        const tournamentsSnapshot = await db.collection('tournaments')
            .where('status', 'in', ['upcoming', 'active'])
            .orderBy('startDate', 'asc')
            .get();
        
        if (tournamentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üèÜ</div>
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">No Active Tournaments</h3>
                    <p style="color: #666;">Check back later for upcoming spelling tournaments!</p>
                    ${isAdmin ? `
                        <button class="practice-btn" onclick="navigateTo('admin')" style="margin-top: 20px; background: linear-gradient(135deg, #667eea, #764ba2);">
                            ‚öôÔ∏è Go to Admin Panel
                        </button>
                    ` : ''}
                </div>
            `;
            return;
        }
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            tournaments.push({ id: doc.id, ...doc.data() });
        });
        
        container.innerHTML = tournaments.map(tournament => {
            const isFull = tournament.participants >= tournament.maxParticipants;
            const isRegistered = tournament.registeredUsers?.includes(currentUser?.uid);
            
            const levelEmoji = {
                'foundation': 'üå±',
                'challenge': 'üéØ',
                'advanced': 'üöÄ',
                'championship': 'üèÜ'
            };
            
            const statusColor = {
                'upcoming': '#ffc107',
                'active': '#28a745',
                'completed': '#6c757d',
                'cancelled': '#dc3545'
            };
            
            return `
                <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-left: 5px solid ${statusColor[tournament.status]};">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="color: #0d3b66; margin: 0 0 10px 0; font-size: 1.5rem;">${levelEmoji[tournament.level]} ${tournament.name}</h3>
                            <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">${tournament.description}</p>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">üìÖ</span>
                                    <span style="color: #666;">${new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">üïê</span>
                                    <span style="color: #666;">${tournament.startTime}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">üë•</span>
                                    <span style="color: #666;">${tournament.participants} / ${tournament.maxParticipants} registered</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="background: ${statusColor[tournament.status]}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; margin-bottom: 15px;">
                                ${tournament.status === 'upcoming' ? 'üìÖ Upcoming' : tournament.status === 'active' ? '‚ñ∂Ô∏è Active' : '‚úÖ Completed'}
                            </div>
                            
                            ${currentUser ? (
                                isRegistered ? `
                                    <button class="practice-btn" disabled style="background: #28a745; opacity: 0.7; cursor: not-allowed;">
                                        ‚úÖ Registered
                                    </button>
                                ` : isFull ? `
                                    <button class="practice-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                                        üîí Full
                                    </button>
                                ` : tournament.status === 'active' ? `
                                    <button class="practice-btn" onclick="startTournamentStage1('${tournament.id}')" style="font-size: 1.1rem; padding: 12px 30px;">
                                        üéØ Join Now
                                    </button>
                                ` : `
                                    <button class="practice-btn" onclick="registerForTournament('${tournament.id}')" style="font-size: 1.1rem; padding: 12px 30px;">
                                        üìù Register
                                    </button>
                                `
                            ) : `
                                <button class="practice-btn" onclick="showAuthModal()" style="font-size: 1.1rem; padding: 12px 30px;">
                                    üîê Sign In to Join
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading tournaments:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load tournaments: ${error.message}
            </div>
        `;
    }
}

async function registerForTournament(tournamentId) {
    if (!currentUser) {
        alert('Please sign in to register');
        showAuthModal();
        return;
    }
    
    try {
        const tournamentRef = db.collection('tournaments').doc(tournamentId);
        const tournamentDoc = await tournamentRef.get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Check if already registered
        if (tournament.registeredUsers?.includes(currentUser.uid)) {
            alert('You are already registered for this tournament');
            return;
        }
        
        // Check if full
        if (tournament.participants >= tournament.maxParticipants) {
            alert('This tournament is full');
            return;
        }
        
        // Register user
        await tournamentRef.update({
            participants: firebase.firestore.FieldValue.increment(1),
            registeredUsers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        
        alert('‚úÖ Successfully registered for the tournament!');
        
        // Reload list
        loadTournamentList();
        
    } catch (error) {
        console.error('Error registering for tournament:', error);
        alert('Failed to register: ' + error.message);
    }
}

  
async function proceedToStage2() {
    try {
        console.log('üéØ Starting Stage 2: AI Audio Spelling');
        
        tournamentStage = 2;
        stage2CurrentIndex = 0;
        stage2Score = 0;
        stage2Errors = 0;
        stage2TimeLeft = 900;
        stage2HandicapsRemaining = 1 + stage1Handicaps; // Add carried handicaps
        
        // Hide Stage 1
        document.getElementById('tournament-stage1').style.display = 'none';
        
        // Create Stage 2 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage2Container = document.getElementById('tournament-stage2');
        
        if (!stage2Container) {
            stage2Container = document.createElement('div');
            stage2Container.id = 'tournament-stage2';
            tournamentsSection.appendChild(stage2Container);
        }
        
        stage2Container.style.display = 'block';
        
        // Show loading
        stage2Container.innerHTML = '<div class="loading">üìö Loading Stage 2 words...</div>';
        
        // Generate words
        await generateStage2Words();
        
        // Build Stage 2 UI
        buildStage2UI();
        
        // Start timer
        startStage2Timer();
        
        // Load first word
        loadStage2Word();
        
    } catch (error) {
        console.error('Error starting Stage 2:', error);
        alert('Failed to start Stage 2: ' + error.message);
    }
}

async function generateStage2Words() {
    try {
        // Use words from current level
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select 25 random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        stage2Words = shuffled.slice(0, 25);
        
        console.log('‚úÖ Generated 25 words for Stage 2:', stage2Words);
        
    } catch (error) {
        console.error('Error generating Stage 2 words:', error);
        throw error;
    }
}

function buildStage2UI() {
    const container = document.getElementById('tournament-stage2');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: #0d3b66; margin: 0;">üé§ Stage 2: AI Audio Spelling</h2>
                <button class="practice-btn" onclick="exitTournament()" style="background: #dc3545; padding: 10px 20px;">
                    üö™ Exit
                </button>
            </div>
            
            <!-- Timer and Stats -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚è±Ô∏è Time Remaining</div>
                    <div id="stage2-timer" style="font-size: 2rem; font-weight: bold; color: #0d3b66;">15:00</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚úÖ Correct</div>
                    <div id="stage2-score" style="font-size: 2rem; font-weight: bold; color: #28a745;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚ùå Errors</div>
                    <div id="stage2-errors" style="font-size: 2rem; font-weight: bold; color: #dc3545;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">üõ°Ô∏è Handicaps</div>
                    <div id="stage2-handicaps" style="font-size: 2rem; font-weight: bold; color: #667eea;">${stage2HandicapsRemaining}</div>
                </div>
            </div>
            
            <!-- Progress -->
            <h3 id="stage2-progress">Word 1 of 25</h3>
            
            <!-- Audio Controls -->
            <div style="text-align: center; margin: 30px 0;">
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="practice-btn" onclick="speakStage2Word()" style="font-size: 1.1rem; padding: 15px 30px;">
                        üîä Play Word
                    </button>
                    <button class="practice-btn" onclick="speakStage2Sentence()" style="font-size: 1.1rem; padding: 15px 30px; background: #17a2b8;">
                        üí¨ Use in Sentence
                    </button>
                </div>
                <p style="color: #666; font-style: italic; font-size: 0.9rem;">Listen and spell the word you hear</p>
            </div>
            
            <!-- Input Field -->
            <div class="form-group" style="margin: 30px 0;">
                <label style="font-size: 1.2rem;">Type what you hear:</label>
                <input type="text" id="stage2-input" 
                       placeholder="Use the keyboard below..." 
                       style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                       readonly>
            </div>
            
            <!-- Virtual Keyboard -->
            <div class="virtual-keyboard">
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('Q')">Q</button>
                    <button class="keyboard-key" onclick="typeStage2Key('W')">W</button>
                    <button class="keyboard-key" onclick="typeStage2Key('E')">E</button>
                    <button class="keyboard-key" onclick="typeStage2Key('R')">R</button>
                    <button class="keyboard-key" onclick="typeStage2Key('T')">T</button>
                    <button class="keyboard-key" onclick="typeStage2Key('Y')">Y</button>
                    <button class="keyboard-key" onclick="typeStage2Key('U')">U</button>
                    <button class="keyboard-key" onclick="typeStage2Key('I')">I</button>
                    <button class="keyboard-key" onclick="typeStage2Key('O')">O</button>
                    <button class="keyboard-key" onclick="typeStage2Key('P')">P</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('A')">A</button>
                    <button class="keyboard-key" onclick="typeStage2Key('S')">S</button>
                    <button class="keyboard-key" onclick="typeStage2Key('D')">D</button>
                    <button class="keyboard-key" onclick="typeStage2Key('F')">F</button>
                    <button class="keyboard-key" onclick="typeStage2Key('G')">G</button>
                    <button class="keyboard-key" onclick="typeStage2Key('H')">H</button>
                    <button class="keyboard-key" onclick="typeStage2Key('J')">J</button>
                    <button class="keyboard-key" onclick="typeStage2Key('K')">K</button>
                    <button class="keyboard-key" onclick="typeStage2Key('L')">L</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('Z')">Z</button>
                    <button class="keyboard-key" onclick="typeStage2Key('X')">X</button>
                    <button class="keyboard-key" onclick="typeStage2Key('C')">C</button>
                    <button class="keyboard-key" onclick="typeStage2Key('V')">V</button>
                    <button class="keyboard-key" onclick="typeStage2Key('B')">B</button>
                    <button class="keyboard-key" onclick="typeStage2Key('N')">N</button>
                    <button class="keyboard-key" onclick="typeStage2Key('M')">M</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key backspace" onclick="backspaceStage2Key()">‚å´ Delete</button>
                    <button class="keyboard-key space" onclick="typeStage2Key(' ')">Space</button>
                    <button class="keyboard-key enter" onclick="submitStage2Answer()">‚úì Enter</button>
                </div>
            </div>
            
            <div id="stage2-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
}

function startStage2Timer() {
    if (stage2Timer) clearInterval(stage2Timer);
    
    stage2Timer = setInterval(() => {
        stage2TimeLeft--;
        
        const minutes = Math.floor(stage2TimeLeft / 60);
        const seconds = stage2TimeLeft % 60;
        document.getElementById('stage2-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (stage2TimeLeft <= 60) {
            document.getElementById('stage2-timer').style.color = '#dc3545';
        }
        
        if (stage2TimeLeft <= 0) {
            clearInterval(stage2Timer);
            completeStage2();
        }
    }, 1000);
}

function loadStage2Word() {
    if (stage2CurrentIndex >= stage2Words.length) {
        completeStage2();
        return;
    }
    
    document.getElementById('stage2-progress').textContent = 
        `Word ${stage2CurrentIndex + 1} of ${stage2Words.length}`;
    
    document.getElementById('stage2-input').value = '';
    document.getElementById('stage2-feedback').innerHTML = '';
    
    // Auto-play word
    setTimeout(() => speakStage2Word(), 500);
}

function speakStage2Word() {
    const word = stage2Words[stage2CurrentIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage2Sentence() {
    const word = stage2Words[stage2CurrentIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage2Word();
    }
}

function typeStage2Key(letter) {
    const input = document.getElementById('stage2-input');
    input.value += letter.toLowerCase();
}

function backspaceStage2Key() {
    const input = document.getElementById('stage2-input');
    input.value = input.value.slice(0, -1);
}

function submitStage2Answer() {
    const userAnswer = document.getElementById('stage2-input').value.trim().toLowerCase();
    const correctWord = stage2Words[stage2CurrentIndex].toLowerCase();
    const feedbackDiv = document.getElementById('stage2-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">‚ö†Ô∏è Please type a word</div>';
        return;
    }
    
    const isCorrect = userAnswer === correctWord;
    
    if (isCorrect) {
        stage2Score++;
        feedbackDiv.innerHTML = '<div class="feedback success">‚úÖ Correct!</div>';
        document.getElementById('stage2-score').textContent = stage2Score;
        
        setTimeout(() => {
            stage2CurrentIndex++;
            loadStage2Word();
        }, 1000);
        
    } else {
        stage2Errors++;
        document.getElementById('stage2-errors').textContent = stage2Errors;
        
        // Check elimination
        if (stage2Errors >= 1 && stage2HandicapsRemaining === 0) {
            feedbackDiv.innerHTML = `<div class="feedback error">‚ùå Eliminated! Wrong spelling. Correct: ${correctWord}</div>`;
            setTimeout(() => eliminateFromStage2(), 2000);
        } else if (stage2Errors >= 1 && stage2HandicapsRemaining > 0) {
            // Use handicap
            stage2HandicapsRemaining--;
            stage2Errors = 0;
            document.getElementById('stage2-handicaps').textContent = stage2HandicapsRemaining;
            document.getElementById('stage2-errors').textContent = stage2Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå Wrong! Correct: ${correctWord}<br>
                    üõ°Ô∏è Handicap used! Errors reset. Handicaps remaining: ${stage2HandicapsRemaining}
                </div>
            `;
            
            setTimeout(() => {
                stage2CurrentIndex++;
                loadStage2Word();
            }, 2000);
        }
    }
}

function completeStage2() {
    clearInterval(stage2Timer);
    
    const container = document.getElementById('tournament-stage2');
    const percentage = Math.round((stage2Score / stage2Words.length) * 100);
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'üèÜ' : percentage >= 60 ? '‚≠ê' : 'üìö'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 2 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage2Score} / ${stage2Words.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                üõ°Ô∏è Handicaps Remaining: ${stage2HandicapsRemaining}
            </p>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ Qualified for Stage 3!</h3>
                    <p style="color: #155724;">
                        You'll carry ${stage2HandicapsRemaining} handicap(s) into Stage 3.
                    </p>
                </div>
                <button class="practice-btn" onclick="proceedToStage3()" style="font-size: 1.2rem; padding: 15px 40px;">
                    ‚û°Ô∏è Proceed to Stage 3
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">‚ùå Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance to Stage 3.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    üè† Return to Lobby
                </button>
            `}
        </div>
    `;
}

function eliminateFromStage2() {
    clearInterval(stage2Timer);
    
    const container = document.getElementById('tournament-stage2');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üò¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 2</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                One error with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage2Score} / ${stage2CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                üè† Return to Lobby
            </button>
        </div>
    `;
}


     

async function proceedToStage3() {
    try {
        console.log('üéØ Starting Stage 3: Spelling Challenge');
        
        tournamentStage = 3;
        stage3CurrentIndex = 0;
        stage3Score = 0;
        stage3Errors = 0;
        stage3TimeLeft = 900;
        stage3HandicapsRemaining = stage2HandicapsRemaining; // Carry from Stage 2
        
        // Hide Stage 2
        document.getElementById('tournament-stage2').style.display = 'none';
        
        // Create Stage 3 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage3Container = document.getElementById('tournament-stage3');
        
        if (!stage3Container) {
            stage3Container = document.createElement('div');
            stage3Container.id = 'tournament-stage3';
            tournamentsSection.appendChild(stage3Container);
        }
        
        stage3Container.style.display = 'block';
        stage3Container.innerHTML = '<div class="loading">üìö Loading Stage 3 words...</div>';
        
        // Generate words
        await generateStage3Words();
        
        // Build UI
        buildStage3UI();
        
        // Start timer
        startStage3Timer();
        
        // Load first word
        loadStage3Word();
        
    } catch (error) {
        console.error('Error starting Stage 3:', error);
        alert('Failed to start Stage 3: ' + error.message);
    }
}

async function generateStage3Words() {
    try {
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select 25 random words for unscrambling
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        stage3Words = shuffled.slice(0, 25);
        
        console.log('‚úÖ Generated 25 words for Stage 3:', stage3Words);
        
    } catch (error) {
        console.error('Error generating Stage 3 words:', error);
        throw error;
    }
}

function buildStage3UI() {
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: #0d3b66; margin: 0;">üî§ Stage 3: Unscramble Challenge</h2>
                <button class="practice-btn" onclick="exitTournament()" style="background: #dc3545; padding: 10px 20px;">
                    üö™ Exit
                </button>
            </div>
            
            <!-- Timer and Stats -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚è±Ô∏è Time Remaining</div>
                    <div id="stage3-timer" style="font-size: 2rem; font-weight: bold; color: #0d3b66;">15:00</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚úÖ Correct</div>
                    <div id="stage3-score" style="font-size: 2rem; font-weight: bold; color: #28a745;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚ùå Errors</div>
                    <div id="stage3-errors" style="font-size: 2rem; font-weight: bold; color: #dc3545;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">üõ°Ô∏è Handicaps</div>
                    <div id="stage3-handicaps" style="font-size: 2rem; font-weight: bold; color: #667eea;">${stage3HandicapsRemaining}</div>
                </div>
            </div>
            
            <h3 id="stage3-progress">Word 1 of 25</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                
                <div id="stage3-letter-tiles" class="letter-tiles-container">
                    <!-- Letter tiles will be inserted here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="shuffleStage3Letters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                        üîÄ Shuffle
                    </button>
                    
                    <button class="practice-btn" onclick="submitStage3Answer()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ‚úì Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="stage3-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
}

function startStage3Timer() {
    if (stage3Timer) clearInterval(stage3Timer);
    
    stage3Timer = setInterval(() => {
        stage3TimeLeft--;
        
        const minutes = Math.floor(stage3TimeLeft / 60);
        const seconds = stage3TimeLeft % 60;
        document.getElementById('stage3-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (stage3TimeLeft <= 60) {
            document.getElementById('stage3-timer').style.color = '#dc3545';
        }
        
        if (stage3TimeLeft <= 0) {
            clearInterval(stage3Timer);
            completeStage3();
        }
    }, 1000);
}

function loadStage3Word() {
    if (stage3CurrentIndex >= stage3Words.length) {
        completeStage3();
        return;
    }
    
    const word = stage3Words[stage3CurrentIndex];
    
    document.getElementById('stage3-progress').textContent = 
        `Word ${stage3CurrentIndex + 1} of ${stage3Words.length}`;
    
    document.getElementById('stage3-feedback').innerHTML = '';
    
    // Scramble the letters
    shuffleStage3Letters();
}

function shuffleStage3Letters() {
    const word = stage3Words[stage3CurrentIndex];
    const letters = word.split('');
    let scrambled = [...letters];
    
    // Shuffle the array
    let attempts = 0;
    do {
        for (let i = scrambled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
        }
        attempts++;
    } while (scrambled.join('') === word && attempts < 10);
    
    stage3CurrentLetterOrder = scrambled;
    renderStage3LetterTiles();
}

function renderStage3LetterTiles() {
    const container = document.getElementById('stage3-letter-tiles');
    container.innerHTML = '';
    
    stage3CurrentLetterOrder.forEach((letter, index) => {
        const tile = document.createElement('div');
        tile.className = 'letter-tile';
        tile.textContent = letter.toUpperCase();
        tile.draggable = true;
        tile.dataset.index = index;
        
        // Drag events
        tile.addEventListener('dragstart', handleStage3DragStart);
        tile.addEventListener('dragend', handleStage3DragEnd);
        tile.addEventListener('dragover', handleStage3DragOver);
        tile.addEventListener('drop', handleStage3Drop);
        tile.addEventListener('dragenter', handleStage3DragEnter);
        tile.addEventListener('dragleave', handleStage3DragLeave);
        
        // Touch events for mobile
        tile.addEventListener('touchstart', handleStage3TouchStart, { passive: false });
        tile.addEventListener('touchmove', handleStage3TouchMove, { passive: false });
        tile.addEventListener('touchend', handleStage3TouchEnd);
        
        container.appendChild(tile);
    });
}

function handleStage3DragStart(e) {
    stage3DraggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleStage3DragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
}

function handleStage3DragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleStage3DragEnter(e) {
    if (this !== stage3DraggedElement) {
        this.classList.add('drag-over');
    }
}

function handleStage3DragLeave(e) {
    this.classList.remove('drag-over');
}

function handleStage3Drop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    this.classList.remove('drag-over');
    
    if (stage3DraggedElement !== this) {
        const draggedIndex = parseInt(stage3DraggedElement.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        
        [stage3CurrentLetterOrder[draggedIndex], stage3CurrentLetterOrder[targetIndex]] = 
        [stage3CurrentLetterOrder[targetIndex], stage3CurrentLetterOrder[draggedIndex]];
        
        renderStage3LetterTiles();
    }
    
    return false;
}

// Touch support for mobile
let stage3TouchTarget = null;
let stage3TouchClone = null;

function handleStage3TouchStart(e) {
    e.preventDefault();
    stage3TouchTarget = this;
    this.classList.add('dragging');
    
    stage3TouchClone = this.cloneNode(true);
    stage3TouchClone.style.position = 'fixed';
    stage3TouchClone.style.zIndex = '10000';
    stage3TouchClone.style.pointerEvents = 'none';
    stage3TouchClone.style.opacity = '0.8';
    document.body.appendChild(stage3TouchClone);
    
    updateStage3TouchClonePosition(e.touches[0]);
}

function handleStage3TouchMove(e) {
    e.preventDefault();
    if (!stage3TouchTarget) return;
    
    updateStage3TouchClonePosition(e.touches[0]);
    
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== stage3TouchTarget) {
        elementBelow.classList.add('drag-over');
    }
}

function handleStage3TouchEnd(e) {
    e.preventDefault();
    if (!stage3TouchTarget) return;
    
    stage3TouchTarget.classList.remove('dragging');
    
    if (stage3TouchClone) {
        stage3TouchClone.remove();
        stage3TouchClone = null;
    }
    
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== stage3TouchTarget) {
        const draggedIndex = parseInt(stage3TouchTarget.dataset.index);
        const targetIndex = parseInt(elementBelow.dataset.index);
        
        [stage3CurrentLetterOrder[draggedIndex], stage3CurrentLetterOrder[targetIndex]] = 
        [stage3CurrentLetterOrder[targetIndex], stage3CurrentLetterOrder[draggedIndex]];
        
        renderStage3LetterTiles();
    }
    
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    stage3TouchTarget = null;
}

function updateStage3TouchClonePosition(touch) {
    if (stage3TouchClone) {
        stage3TouchClone.style.left = (touch.clientX - 30) + 'px';
        stage3TouchClone.style.top = (touch.clientY - 30) + 'px';
    }
}

function submitStage3Answer() {
    const userWord = stage3CurrentLetterOrder.join('').toLowerCase();
    const correctWord = stage3Words[stage3CurrentIndex].toLowerCase();
    const feedbackDiv = document.getElementById('stage3-feedback');
    
    if (userWord === correctWord) {
        stage3Score++;
        feedbackDiv.innerHTML = '<div class="feedback success">‚úÖ Correct!</div>';
        document.getElementById('stage3-score').textContent = stage3Score;
        
        setTimeout(() => {
            stage3CurrentIndex++;
            loadStage3Word();
        }, 1000);
        
    } else {
        stage3Errors++;
        document.getElementById('stage3-errors').textContent = stage3Errors;
        
        // Check elimination
        if (stage3Errors >= 1 && stage3HandicapsRemaining === 0) {
            feedbackDiv.innerHTML = `<div class="feedback error">‚ùå Eliminated! Wrong word. Correct: ${correctWord}</div>`;
            setTimeout(() => eliminateFromStage3(), 2000);
        } else if (stage3Errors >= 1 && stage3HandicapsRemaining > 0) {
            // Use handicap
            stage3HandicapsRemaining--;
            stage3Errors = 0;
            document.getElementById('stage3-handicaps').textContent = stage3HandicapsRemaining;
            document.getElementById('stage3-errors').textContent = stage3Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå Wrong! Correct: ${correctWord}<br>
                    üõ°Ô∏è Handicap used! Errors reset. Handicaps remaining: ${stage3HandicapsRemaining}
                </div>
            `;
            
            setTimeout(() => {
                stage3CurrentIndex++;
                loadStage3Word();
            }, 2000);
        }
    }
}

function completeStage3() {
    clearInterval(stage3Timer);
    
    const container = document.getElementById('tournament-stage3');
    const percentage = Math.round((stage3Score / stage3Words.length) * 100);
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'üèÜ' : percentage >= 60 ? '‚≠ê' : 'üìö'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 3 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage3Score} / ${stage3Words.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                üõ°Ô∏è Handicaps Remaining: ${stage3HandicapsRemaining}
            </p>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ Qualified for Stage 4!</h3>
                    <p style="color: #155724;">
                        Congratulations! You've reached the Live Spell Master rounds.<br>
                        <strong>Next:</strong> Top 10 compete with live human caller
                    </p>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin: 0 0 15px 0;">üé≠ Choose Your Role:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <button class="practice-btn" onclick="joinAsSpeller()" style="background: #667eea; font-size: 1rem; padding: 15px;">
                            üéØ Join as Speller
                        </button>
                        <button class="practice-btn" onclick="joinAsCaller()" style="background: #764ba2; font-size: 1rem; padding: 15px;">
                            üé§ Join as Caller
                        </button>
                    </div>
                    <p style="color: #856404; margin: 15px 0 0 0; font-size: 0.9rem;">
                        ‚ÑπÔ∏è <strong>Speller:</strong> Compete to spell words correctly<br>
                        ‚ÑπÔ∏è <strong>Caller:</strong> Read words aloud for spellers
                    </p>
                </div>
                
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d;">
                    üè† Return to Lobby
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">‚ùå Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance to the Live Rounds.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    üè† Return to Lobby
                </button>
            `}
        </div>
    `;
}

function eliminateFromStage3() {
    clearInterval(stage3Timer);
    
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üò¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 3</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                One error with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage3Score} / ${stage3CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                üè† Return to Lobby
            </button>
        </div>
    `;
}

// Update exitTournament to handle all stages
function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    if (stage2Timer) clearInterval(stage2Timer);
    if (stage3Timer) clearInterval(stage3Timer);
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    const stage2 = document.getElementById('tournament-stage2');
    if (stage2) stage2.style.display = 'none';
    
    const stage3 = document.getElementById('tournament-stage3');
    if (stage3) stage3.style.display = 'none';
    
    loadTournamentList();
} 


 async function joinAsSpeller() {
    callerMode = false;
    
    // Show waiting room
    const container = document.getElementById('tournament-stage3');
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin: 20px 0; animation: pulse 2s infinite;">‚è≥</div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Waiting for Stage 4 to Begin...</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You've joined as a <strong style="color: #667eea;">SPELLER</strong>
            </p>
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 15px;">üìã Stage 4: Live Spell Master (Top 10)</h3>
                <p style="color: #666; line-height: 1.8;">
                    ‚Ä¢ Live human caller will read words<br>
                    ‚Ä¢ One mistake = eliminated (unless you have a Shield)<br>
                    ‚Ä¢ Top 10 spellers advance<br>
                    ‚Ä¢ 5-minute break after this round
                </p>
            </div>
            <div class="loading">Waiting for a caller to start the round...</div>
            
            <button class="practice-btn" onclick="exitTournament()" style="margin-top: 20px; background: #6c757d;">
                üö™ Leave Waiting Room
            </button>
        </div>
    `;
    
    // In a real implementation, this would connect to a live session
    // For demo purposes, we'll simulate
    setTimeout(() => {
        alert('‚è∞ In a live tournament, you would wait here for a caller to start Stage 4.\n\nFor demo purposes, the caller interface is available by choosing "Join as Caller".');
    }, 2000);
}

async function joinAsCaller() {
    callerMode = true;
    
    try {
        // Hide Stage 3
        document.getElementById('tournament-stage3').style.display = 'none';
        
        // Generate words for Stage 4
        await generateLiveStageWords(10); // 10 words for Stage 4
        
        // Show caller interface
        startStage4AsCaller();
        
    } catch (error) {
        console.error('Error starting as caller:', error);
        alert('Failed to start as caller: ' + error.message);
    }
}

  async function generateLiveStageWords(count) {
    try {
        if (!selectedGameLevel) {
            selectedGameLevel = 'championship'; // Use hardest level for finals
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        liveStageWords = shuffled.slice(0, count);
        
        console.log(`‚úÖ Generated ${count} words for live stage:`, liveStageWords);
        
    } catch (error) {
        console.error('Error generating live stage words:', error);
        throw error;
    }
}

 function startStage4AsCaller() {
    tournamentStage = 4;
    currentLiveStageIndex = 0;
    liveStageParticipants = ['Demo Player 1', 'Demo Player 2', 'Demo Player 3']; // Simulated players
    eliminatedPlayers = [];
    
    const tournamentsSection = document.querySelector('#tournaments-section .word-database');
    let stage4Container = document.getElementById('tournament-stage4');
    
    if (!stage4Container) {
        stage4Container = document.createElement('div');
        stage4Container.id = 'tournament-stage4';
        tournamentsSection.appendChild(stage4Container);
    }
    
    stage4Container.style.display = 'block';
    
    buildStage4CallerUI();
}

function buildStage4CallerUI() {
    const container = document.getElementById('tournament-stage4');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">üé§ Stage 4: Live Spell Master (Caller Mode)</h2>
                <p style="margin: 0; opacity: 0.9;">You are the human caller for this round</p>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">üë• Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #d4edda; padding: 10px 20px; border-radius: 20px; color: #155724; font-weight: bold;">
                            ‚úÖ ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">‚ùå Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: white;">üìù Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="caller-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length ? `
                    <button class="practice-btn" onclick="speakCallerWord()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        üîä Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakCallerSentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        üí¨ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="caller-controls">
                ${currentLiveStageIndex < liveStageWords.length ? `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 15px 0;">üìã Caller Instructions:</h4>
                        <ol style="color: #856404; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Pronounce the word clearly</li>
                            <li>Use it in a sentence if requested</li>
                            <li>Mark each speller as correct or incorrect</li>
                            <li>One mistake eliminates a speller (unless they have a Shield)</li>
                        </ol>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markSpellerCorrect(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚úÖ Correct
                                    </button>
                                    <button class="practice-btn" onclick="markSpellerIncorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚ùå Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextCallerWord()" style="font-size: 1.2rem; padding: 15px 40px; background: #667eea;">
                            ‚û°Ô∏è Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 4 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} spellers advance to Stage 5
                        </p>
                        
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3 style="color: #155724; margin-bottom: 15px;">‚úÖ Qualified for Stage 5:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                ${liveStageParticipants.map(player => `
                                    <div style="background: white; padding: 15px 25px; border-radius: 10px; color: #155724; font-weight: bold; font-size: 1.1rem;">
                                        üåü ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage5()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            ‚û°Ô∏è Proceed to Stage 5 (Top 5)
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            üè† Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}   

    // ===== TOURNAMENT STAGE 5 FUNCTIONS (Top 10 ‚Üí Top 5) =====

async function proceedToStage5() {
    try {
        console.log('üéØ Starting Stage 5: Live Spell Master (Top 10 ‚Üí Top 5)');
        
        tournamentStage = 5;
        currentLiveStageIndex = 0;
        
        // Keep current participants from Stage 4
        if (liveStageParticipants.length > 10) {
            liveStageParticipants = liveStageParticipants.slice(0, 10);
        }
        
        eliminatedPlayers = [];
        
        // Generate words for Stage 5
        await generateLiveStageWords(15); // 15 words for Stage 5
        
        // Hide Stage 4
        const stage4 = document.getElementById('tournament-stage4');
        if (stage4) stage4.style.display = 'none';
        
        // Create Stage 5 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage5Container = document.getElementById('tournament-stage5');
        
        if (!stage5Container) {
            stage5Container = document.createElement('div');
            stage5Container.id = 'tournament-stage5';
            tournamentsSection.appendChild(stage5Container);
        }
        
        stage5Container.style.display = 'block';
        
        // Show caller interface for Stage 5
        buildStage5CallerUI();
        
    } catch (error) {
        console.error('Error starting Stage 5:', error);
        alert('Failed to start Stage 5: ' + error.message);
    }
}

function buildStage5CallerUI() {
    const container = document.getElementById('tournament-stage5');
    const targetCount = 5; // Advance top 5
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">üé§ Stage 5: Live Spell Master (Top 10 ‚Üí Top 5)</h2>
                <p style="margin: 0; opacity: 0.9;">Spell until ${targetCount} spellers remain</p>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666; font-weight: bold;">Active: ${liveStageParticipants.length}</span>
                    <span style="color: #667eea; font-weight: bold;">Target: ${targetCount}</span>
                    <span style="color: #dc3545; font-weight: bold;">Eliminated: ${eliminatedPlayers.length}</span>
                </div>
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${((liveStageParticipants.length / 10) * 100)}%; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">üë• Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #d4edda; padding: 10px 20px; border-radius: 20px; color: #155724; font-weight: bold;">
                            ‚úÖ ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">‚ùå Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: white;">üìù Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="stage5-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length && liveStageParticipants.length > targetCount ? `
                    <button class="practice-btn" onclick="speakStage5Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        üîä Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage5Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        üí¨ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="stage5-caller-controls">
                ${liveStageParticipants.length > targetCount && currentLiveStageIndex < liveStageWords.length ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markStage5Correct(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚úÖ Correct
                                    </button>
                                    <button class="practice-btn" onclick="markStage5Incorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚ùå Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextStage5Word()" style="font-size: 1.2rem; padding: 15px 40px; background: #667eea;">
                            ‚û°Ô∏è Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 5 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} spellers advance to Stage 6
                        </p>
                        
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3 style="color: #155724; margin-bottom: 15px;">‚úÖ Qualified for Stage 6:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                ${liveStageParticipants.map(player => `
                                    <div style="background: white; padding: 15px 25px; border-radius: 10px; color: #155724; font-weight: bold; font-size: 1.1rem;">
                                        üåü ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage6()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            ‚û°Ô∏è Proceed to Stage 6 (Top 5 ‚Üí Top 3)
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            üè† Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function speakStage5Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage5Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage5Word();
    }
}

function markStage5Correct(playerIndex) {
    // Player stays in the game
    console.log(`‚úÖ ${liveStageParticipants[playerIndex]} spelled correctly`);
}

function markStage5Incorrect(playerIndex) {
    const player = liveStageParticipants[playerIndex];
    
    if (confirm(`‚ùå Are you sure ${player} spelled incorrectly? This will eliminate them.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(playerIndex, 1);
        
        // Rebuild UI
        buildStage5CallerUI();
    }
}

function nextStage5Word() {
    currentLiveStageIndex++;
    
    if (liveStageParticipants.length <= 5) {
        // Reached target - complete stage
        buildStage5CallerUI();
    } else if (currentLiveStageIndex >= liveStageWords.length) {
        // Ran out of words but still too many players - generate more
        alert('‚ö†Ô∏è Need more words! Generating additional words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage5CallerUI();
        });
    } else {
        // Continue to next word
        buildStage5CallerUI();
    }
}

// ===== TOURNAMENT STAGE 6 FUNCTIONS (Top 5 ‚Üí Top 3) =====

async function proceedToStage6() {
    try {
        console.log('üéØ Starting Stage 6: Live Spell Master (Top 5 ‚Üí Top 3)');
        
        tournamentStage = 6;
        currentLiveStageIndex = 0;
        
        // Keep top 5 from Stage 5
        if (liveStageParticipants.length > 5) {
            liveStageParticipants = liveStageParticipants.slice(0, 5);
        }
        
        eliminatedPlayers = [];
        
        // Generate words for Stage 6
        await generateLiveStageWords(12); // 12 words for Stage 6
        
        // Hide Stage 5
        const stage5 = document.getElementById('tournament-stage5');
        if (stage5) stage5.style.display = 'none';
        
        // Create Stage 6 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage6Container = document.getElementById('tournament-stage6');
        
        if (!stage6Container) {
            stage6Container = document.createElement('div');
            stage6Container.id = 'tournament-stage6';
            tournamentsSection.appendChild(stage6Container);
        }
        
        stage6Container.style.display = 'block';
        
        // Show caller interface for Stage 6
        buildStage6CallerUI();
        
    } catch (error) {
        console.error('Error starting Stage 6:', error);
        alert('Failed to start Stage 6: ' + error.message);
    }
}

function buildStage6CallerUI() {
    const container = document.getElementById('tournament-stage6');
    const targetCount = 3; // Advance top 3
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: #0d3b66;">
                <h2 style="margin: 0 0 10px 0;">üé§ Stage 6: Live Spell Master (Top 5 ‚Üí Top 3)</h2>
                <p style="margin: 0; opacity: 0.9;">Spell until ${targetCount} finalists remain</p>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666; font-weight: bold;">Active: ${liveStageParticipants.length}</span>
                    <span style="color: #FFD700; font-weight: bold;">Target: ${targetCount}</span>
                    <span style="color: #dc3545; font-weight: bold;">Eliminated: ${eliminatedPlayers.length}</span>
                </div>
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #FFD700, #FFA500); height: 100%; width: ${((liveStageParticipants.length / 5) * 100)}%; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">üë• Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #fff3cd; padding: 10px 20px; border-radius: 20px; color: #856404; font-weight: bold; border: 2px solid #FFD700;">
                            ‚≠ê ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">‚ùå Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: #0d3b66; text-align: center;">
                <h3 style="margin: 0 0 15px 0;">üìù Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="stage6-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length && liveStageParticipants.length > targetCount ? `
                    <button class="practice-btn" onclick="speakStage6Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        üîä Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage6Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        üí¨ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="stage6-caller-controls">
                ${liveStageParticipants.length > targetCount && currentLiveStageIndex < liveStageWords.length ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #FFD700; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">‚≠ê ${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markStage6Correct(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚úÖ Correct
                                    </button>
                                    <button class="practice-btn" onclick="markStage6Incorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚ùå Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextStage6Word()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #0d3b66;">
                            ‚û°Ô∏è Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 6 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} finalists advance to the <strong>FINAL SPELL-OFF</strong>
                        </p>
                        
                        <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 30px; border-radius: 15px; margin: 20px 0;">
                            <h3 style="margin-bottom: 15px; color: #0d3b66;">üåü FINALISTS:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                                ${liveStageParticipants.map((player, idx) => `
                                    <div style="background: white; padding: 20px 30px; border-radius: 15px; color: #0d3b66; font-weight: bold; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                                        ${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'} ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage7()" style="font-size: 1.3rem; padding: 20px 50px; margin: 10px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #0d3b66; font-weight: bold;">
                            üèÜ START FINAL SPELL-OFF
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            üè† Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function speakStage6Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage6Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage6Word();
    }
}

function markStage6Correct(playerIndex) {
    console.log(`‚úÖ ${liveStageParticipants[playerIndex]} spelled correctly`);
}

function markStage6Incorrect(playerIndex) {
    const player = liveStageParticipants[playerIndex];
    
    if (confirm(`‚ùå Are you sure ${player} spelled incorrectly? This will eliminate them from the finals.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(playerIndex, 1);
        
        buildStage6CallerUI();
    }
}

function nextStage6Word() {
    currentLiveStageIndex++;
    
    if (liveStageParticipants.length <= 3) {
        buildStage6CallerUI();
    } else if (currentLiveStageIndex >= liveStageWords.length) {
        alert('‚ö†Ô∏è Need more words! Generating additional words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage6CallerUI();
        });
    } else {
        buildStage6CallerUI();
    }
}

// ===== TOURNAMENT STAGE 7 FUNCTIONS (Final Spell-Off: Top 3 ‚Üí Champion) =====

async function proceedToStage7() {
    try {
        console.log('üèÜ Starting Stage 7: FINAL SPELL-OFF');
        
        tournamentStage = 7;
        currentLiveStageIndex = 0;
        currentSpellerIndex = 0;
        
        // Keep top 3 from Stage 6
        if (liveStageParticipants.length > 3) {
            liveStageParticipants = liveStageParticipants.slice(0, 3);
        }
        
        eliminatedPlayers = [];
        finalRoundSpelling = null;
        
        // Generate words for Final Round (championship level)
        selectedGameLevel = 'championship';
        await generateLiveStageWords(20); // 20 championship words
        
        // Hide Stage 6
        const stage6 = document.getElementById('tournament-stage6');
        if (stage6) stage6.style.display = 'none';
        
        // Create Stage 7 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage7Container = document.getElementById('tournament-stage7');
        
        if (!stage7Container) {
            stage7Container = document.createElement('div');
            stage7Container.id = 'tournament-stage7';
            tournamentsSection.appendChild(stage7Container);
        }
        
        stage7Container.style.display = 'block';
        
        // Show final spell-off interface
        buildStage7UI();
        
    } catch (error) {
        console.error('Error starting Stage 7:', error);
        alert('Failed to start Final Spell-Off: ' + error.message);
    }
}

// ===== COMPLETE STAGE 7 FUNCTIONS =====

function buildStage7UI() {
    const container = document.getElementById('tournament-stage7');
    
    // Check if we have a winner
    if (liveStageParticipants.length === 1) {
        showTournamentWinner();
        return;
    }
    
    const currentSpeller = liveStageParticipants[currentSpellerIndex];
    const currentWord = liveStageWords[currentLiveStageIndex];
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 20px; color: white; text-align: center;">
                <h1 style="margin: 0 0 10px 0; color: white; font-size: 2.5rem;">üèÜ FINAL SPELL-OFF üèÜ</h1>
                <p style="margin: 0; opacity: 0.9; font-size: 1.2rem;">Classic Turn-Based Spelling ‚Ä¢ One Wrong Disqualifies</p>
            </div>
            
            <!-- Remaining Finalists -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0; text-align: center;">üåü Remaining Finalists (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    ${liveStageParticipants.map((player, idx) => `
                        <div style="background: ${player === currentSpeller ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'white'}; padding: 20px 30px; border-radius: 15px; color: #0d3b66; font-weight: bold; font-size: 1.2rem; border: 3px solid ${player === currentSpeller ? '#FFD700' : '#e0e0e0'}; box-shadow: ${player === currentSpeller ? '0 5px 20px rgba(255,215,0,0.5)' : '0 2px 8px rgba(0,0,0,0.1)'}; transition: all 0.3s;">
                            ${player === currentSpeller ? '‚û§ ' : ''}${player}${player === currentSpeller ? ' ‚¨ÖÔ∏è' : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0; text-align: center;">‚ùå Eliminated</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Turn -->
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: #0d3b66; text-align: center;">
                <h3 style="margin: 0 0 15px 0;">üéØ ${currentSpeller}'s Turn</h3>
                <div style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentWord.toUpperCase()}
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="speakStage7Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        üîä Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage7Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        üí¨ Use in Sentence
                    </button>
                </div>
            </div>
            
            <!-- Caller Controls -->
            <div style="text-align: center; margin: 30px 0;">
                <h4 style="color: #0d3b66; margin-bottom: 20px;">Did ${currentSpeller} spell "${currentWord}" correctly?</h4>
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button class="practice-btn" onclick="markStage7Correct()" style="background: #28a745; font-size: 1.2rem; padding: 15px 40px;">
                        ‚úÖ CORRECT
                    </button>
                    <button class="practice-btn" onclick="markStage7Incorrect()" style="background: #dc3545; font-size: 1.2rem; padding: 15px 40px;">
                        ‚ùå WRONG
                    </button>
                </div>
            </div>
        </div>
    `;
}

function speakStage7Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage7Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage7Word();
    }
}

function markStage7Correct() {
    console.log(`‚úÖ ${liveStageParticipants[currentSpellerIndex]} spelled correctly`);
    
    // Move to next speller
    currentSpellerIndex++;
    if (currentSpellerIndex >= liveStageParticipants.length) {
        currentSpellerIndex = 0; // Loop back to first speller
        currentLiveStageIndex++; // New word for next round
    }
    
    // Check if we ran out of words
    if (currentLiveStageIndex >= liveStageWords.length) {
        alert('‚ö†Ô∏è Need more words! Generating additional championship words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage7UI();
        });
    } else {
        buildStage7UI();
    }
}

function markStage7Incorrect() {
    const player = liveStageParticipants[currentSpellerIndex];
    
    if (confirm(`‚ùå Are you sure ${player} spelled incorrectly? This will eliminate them from the finals.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(currentSpellerIndex, 1);
        
        // Adjust current speller index
        if (currentSpellerIndex >= liveStageParticipants.length) {
            currentSpellerIndex = 0;
        }
        
        // Check if we have a winner
        if (liveStageParticipants.length === 1) {
            showTournamentWinner();
        } else {
            // Move to next word
            currentLiveStageIndex++;
            buildStage7UI();
        }
    }
}

function showTournamentWinner() {
    const container = document.getElementById('tournament-stage7');
    const winner = liveStageParticipants[0];
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 50px; background: linear-gradient(135deg, #FFD700, #FFA500);">
            <div style="font-size: 6rem; margin-bottom: 30px; animation: bounce 2s infinite;">üèÜ</div>
            
            <h1 style="color: #0d3b66; font-size: 3rem; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                SPELLING CHAMPION
            </h1>
            
            <div style="background: white; padding: 40px; border-radius: 20px; margin: 30px 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="font-size: 2.5rem; font-weight: bold; color: #0d3b66; margin-bottom: 20px;">
                    üåü ${winner} üåü
                </div>
                <p style="font-size: 1.3rem; color: #666; margin: 15px 0;">
                    Conquered all 7 stages to become the ultimate spelling champion!
                </p>
            </div>
            
            <div style="background: rgba(255,255,255,0.9); padding: 30px; border-radius: 15px; margin: 30px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 20px;">üéØ Tournament Journey</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 1</div>
                        <div style="color: #666; font-size: 0.9rem;">Antonym/Synonym</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 2</div>
                        <div style="color: #666; font-size: 0.9rem;">AI Audio Spelling</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 3</div>
                        <div style="color: #666; font-size: 0.9rem;">Unscramble</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 4</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 10</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 5</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 5</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 6</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 3</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66;">Stage 7</div>
                        <div style="color: #0d3b66; font-size: 0.9rem; font-weight: bold;">üèÜ CHAMPION</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 40px;">
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.3rem; padding: 20px 50px; background: white; color: #0d3b66; font-weight: bold;">
                    üè† Return to Lobby
                </button>
            </div>
        </div>
    `;
    
    // Add bounce animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
    `;
    document.head.appendChild(style);
}




// ===== ADMIN CONFIGURATION =====
const ADMIN_EMAIL = 'carlanviroberts@gmail.com'; // üî¥ CHANGE THIS TO YOUR ADMIN EMAIL
let isAdmin = false;

// Check if current user is admin
async function checkAdminStatus() {
    if (!currentUser) {
        isAdmin = false;
        updateAdminUI(); // Update UI when no user
        return false;
    }
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (!userDoc.exists) {
            console.log('‚ùå User document not found');
            isAdmin = false;
            updateAdminUI();
            return false;
        }
        
        const userData = userDoc.data();
        
        // Check if user email matches admin email
        isAdmin = (userData?.email === ADMIN_EMAIL || currentUser.email === ADMIN_EMAIL);
        
        console.log('üë§ Checking admin status for:', currentUser.email);
        console.log('üë§ Admin status:', isAdmin);
        
        // Show/hide admin controls
        updateAdminUI();
        
        return isAdmin;
    } catch (error) {
        console.error('‚ùå Error checking admin status:', error);
        isAdmin = false;
        updateAdminUI();
        return false;
    }
}

function updateAdminUI() {
    console.log('üîÑ Updating admin UI. isAdmin:', isAdmin);
    
    // Show/hide admin section in sidebar
    const adminLink = document.getElementById('admin-nav-link');
    if (adminLink) {
        adminLink.style.display = isAdmin ? 'block' : 'none';
        console.log('‚úÖ Admin link display set to:', isAdmin ? 'block' : 'none');
    } else {
        console.log('‚ö†Ô∏è Admin link element not found in DOM');
    }
    
    // Show/hide create tournament button (if on admin page)
    const createBtn = document.getElementById('create-tournament-section');
    if (createBtn) {
        createBtn.style.display = isAdmin ? 'block' : 'none';
    }
}


// ===== ADMIN TOURNAMENT MANAGEMENT =====

async function loadAdminPanel() {
    if (!isAdmin) {
        document.getElementById('admin-container').innerHTML = `
            <div class="feedback error">
                ‚ùå Access Denied. Admin privileges required.
            </div>
        `;
        return;
    }
    
    const container = document.getElementById('admin-container');
    container.innerHTML = '<div class="loading">Loading admin panel...</div>';
    
    try {
        // Load all tournaments
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('createdAt', 'desc')
            .get();
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            tournaments.push({ id: doc.id, ...doc.data() });
        });
        
        container.innerHTML = `
            <div class="admin-panel">
                <!-- Create Tournament Button -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="practice-btn" onclick="showCreateTournamentModal()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2);">
                        ‚ûï Create New Tournament
                    </button>
                </div>
                
                <!-- Tournaments List -->
                <h3 style="color: #0d3b66; margin-bottom: 20px;">üìã Manage Tournaments (${tournaments.length})</h3>
                
                ${tournaments.length === 0 ? `
                    <div class="loading">
                        No tournaments created yet. Click "Create New Tournament" to get started.
                    </div>
                ` : `
                    <div class="coaches-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>üèÜ Tournament</th>
                                    <th>üìÖ Date</th>
                                    <th>üë• Participants</th>
                                    <th>‚öôÔ∏è Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tournaments.map(tournament => `
                                    <tr>
                                        <td>
                                            <div style="font-weight: bold; color: #0d3b66;">${tournament.name}</div>
                                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                                Level: ${tournament.level} ‚Ä¢ Status: ${tournament.status}
                                            </div>
                                        </td>
                                        <td>
                                            <div>${tournament.startDate ? new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not scheduled'}</div>
                                            <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                                ${tournament.startTime || 'Time TBD'}
                                            </div>
                                        </td>
                                        <td style="text-align: center;">
                                            <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #0d3b66;">
                                                ${tournament.participants || 0}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 5px; justify-content: center;">
                                                <button class="practice-btn" onclick="viewTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8;">
                                                    üëÅÔ∏è View
                                                </button>
                                                <button class="practice-btn" onclick="editTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                    ‚úèÔ∏è Edit
                                                </button>
                                                <button class="practice-btn" onclick="deleteTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                                    üóëÔ∏è Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading admin panel:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load admin panel: ${error.message}
            </div>
        `;
    }
}

function showCreateTournamentModal() {
    const modal = document.createElement('div');
    modal.className = 'auth-modal';
    modal.id = 'createTournamentModal';
    modal.style.display = 'block';
    modal.classList.add('active');
    
    modal.innerHTML = `
        <div class="auth-content" style="max-width: 600px;">
            <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h2 style="color: white;">‚ûï Create New Tournament</h2>
                <button class="modal-close" onclick="closeCreateTournamentModal()" style="color: white;">√ó</button>
            </div>
            <div class="auth-body">
                <form id="create-tournament-form" onsubmit="handleCreateTournament(event)">
                    <div class="form-group">
                        <label>Tournament Name *</label>
                        <input type="text" id="tournament-name" required placeholder="e.g., Summer Spelling Championship 2025">
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;" placeholder="Describe the tournament..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty Level *</label>
                        <select id="tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="">Select level</option>
                            <option value="foundation">üå± Foundation</option>
                            <option value="challenge">üéØ Challenge</option>
                            <option value="advanced">üöÄ Advanced</option>
                            <option value="championship">üèÜ Championship</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="tournament-date" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="tournament-time" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Max Participants</label>
                        <input type="number" id="tournament-max-participants" min="10" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="upcoming">üìÖ Upcoming (Open for Registration)</option>
                            <option value="active">‚ñ∂Ô∏è Active (In Progress)</option>
                            <option value="completed">‚úÖ Completed</option>
                            <option value="cancelled">‚ùå Cancelled</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        ‚úÖ Create Tournament
                    </button>
                    
                    <div id="create-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                </form>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeCreateTournamentModal() {
    const modal = document.getElementById('createTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleCreateTournament(event) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('‚ùå Admin access required');
        return;
    }
    
    const name = document.getElementById('tournament-name').value.trim();
    const description = document.getElementById('tournament-description').value.trim();
    const level = document.getElementById('tournament-level').value;
    const date = document.getElementById('tournament-date').value;
    const time = document.getElementById('tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('tournament-max-participants').value);
    const status = document.getElementById('tournament-status').value;
    
    const errorDiv = document.getElementById('create-tournament-error');
    
    try {
        // Create tournament in Firestore
        const tournamentRef = await db.collection('tournaments').add({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            participants: 0,
            registeredUsers: [],
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Tournament created:', tournamentRef.id);
        
        closeCreateTournamentModal();
        
        alert('‚úÖ Tournament created successfully!');
        
        // Reload admin panel
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error creating tournament:', error);
        errorDiv.textContent = 'Failed to create tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function viewTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = { id: tournamentDoc.id, ...tournamentDoc.data() };
        
        alert(`
üèÜ ${tournament.name}

üìù Description: ${tournament.description}
üìä Level: ${tournament.level}
üìÖ Date: ${tournament.startDate} at ${tournament.startTime}
üë• Participants: ${tournament.participants} / ${tournament.maxParticipants}
‚ö° Status: ${tournament.status}

Created: ${tournament.createdAt ? new Date(tournament.createdAt.toDate()).toLocaleString() : 'Unknown'}
        `);
        
    } catch (error) {
        console.error('Error viewing tournament:', error);
        alert('Failed to load tournament details');
    }
}

async function editTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Pre-fill edit modal (similar to create modal)
        const modal = document.createElement('div');
        modal.className = 'auth-modal';
        modal.id = 'editTournamentModal';
        modal.style.display = 'block';
        modal.classList.add('active');
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 600px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #ffc107, #ff9800);">
                    <h2 style="color: #0d3b66;">‚úèÔ∏è Edit Tournament</h2>
                    <button class="modal-close" onclick="closeEditTournamentModal()" style="color: #0d3b66;">√ó</button>
                </div>
                <div class="auth-body">
                    <form id="edit-tournament-form" onsubmit="handleEditTournament(event, '${tournamentId}')">
                        <div class="form-group">
                            <label>Tournament Name *</label>
                            <input type="text" id="edit-tournament-name" required value="${tournament.name}">
                        </div>
                        
                        <div class="form-group">
                            <label>Description *</label>
                            <textarea id="edit-tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;">${tournament.description}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Difficulty Level *</label>
                            <select id="edit-tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                                <option value="foundation" ${tournament.level === 'foundation' ? 'selected' : ''}>üå± Foundation</option>
                                <option value="challenge" ${tournament.level === 'challenge' ? 'selected' : ''}>üéØ Challenge</option>
                                <option value="advanced" ${tournament.level === 'advanced' ? 'selected' : ''}>üöÄ Advanced</option>
                                <option value="championship" ${tournament.level === 'championship' ? 'selected' : ''}>üèÜ Championship</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Start Date *</label>
                            <input type="date" id="edit-tournament-date" required value="${tournament.startDate}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Start Time *</label>
                            <input type="time" id="edit-tournament-time" required value="${tournament.startTime}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Max Participants</label>
                            <input type="number" id="edit-tournament-max-participants" min="10" max="100" value="${tournament.maxParticipants}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="edit-tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                                <option value="upcoming" ${tournament.status === 'upcoming' ? 'selected' : ''}>üìÖ Upcoming</option>
                                <option value="active" ${tournament.status === 'active' ? 'selected' : ''}>‚ñ∂Ô∏è Active</option>
                                <option value="completed" ${tournament.status === 'completed' ? 'selected' : ''}>‚úÖ Completed</option>
                                <option value="cancelled" ${tournament.status === 'cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #ffc107, #ff9800); color: #0d3b66;">
                            ‚úÖ Save Changes
                        </button>
                        
                        <div id="edit-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error loading tournament for edit:', error);
        alert('Failed to load tournament: ' + error.message);
    }
}

function closeEditTournamentModal() {
    const modal = document.getElementById('editTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleEditTournament(event, tournamentId) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('‚ùå Admin access required');
        return;
    }
    
    const name = document.getElementById('edit-tournament-name').value.trim();
    const description = document.getElementById('edit-tournament-description').value.trim();
    const level = document.getElementById('edit-tournament-level').value;
    const date = document.getElementById('edit-tournament-date').value;
    const time = document.getElementById('edit-tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('edit-tournament-max-participants').value);
    const status = document.getElementById('edit-tournament-status').value;
    
    const errorDiv = document.getElementById('edit-tournament-error');
    
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Tournament updated:', tournamentId);
        
        closeEditTournamentModal();
        
        alert('‚úÖ Tournament updated successfully!');
        
        // Reload admin panel
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error updating tournament:', error);
        errorDiv.textContent = 'Failed to update tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function deleteTournament(tournamentId) {
    if (!isAdmin) {
        alert('‚ùå Admin access required');
        return;
    }
    
    if (confirm('üóëÔ∏è Are you sure you want to delete this tournament? This action cannot be undone.')) {
        try {
            await db.collection('tournaments').doc(tournamentId).delete();
            
            console.log('‚úÖ Tournament deleted:', tournamentId);
            
            alert('‚úÖ Tournament deleted successfully');
            
            // Reload admin panel
            loadAdminPanel();
            
        } catch (error) {
            console.error('Error deleting tournament:', error);
            alert('Failed to delete tournament: ' + error.message);
        }
    }
}        
    </script>
</body>
</html>
