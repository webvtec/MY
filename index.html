<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORD BIZ COACHING ACADEMY</title>
    <style>
        /* ===== GLOBAL RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Georgia, 'Times New Roman', serif;
            overflow-x: hidden;
            background: #f5f5f5;
        }
        
        html {
            overflow-x: hidden;
        }

        /* ===== HEADER STYLES ===== */
        .header {
            background: #0d3b66;
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            max-width: 100vw;
        }

        .top-bar {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            width: 100%;
            gap: 15px;
            position: relative;
        }

        .left-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
        }

        .menu-icon:hover span {
            background: #ffd700;
        }

        .menu-icon span {
            width: 30px;
            height: 4px;
            background: white;
            border-radius: 2px;
        }

        .logo {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.6rem;
            font-weight: bold;
            font-style: italic;
            color: white;
            letter-spacing: 2px;
            white-space: nowrap;
            pointer-events: none;
        }
    
        .nav-bar {
            display: flex;
            background: #0a2f4d;
            justify-content: space-evenly;
            width: 100%;
            overflow-x: auto;
        }

        .nav-item {
            padding: 14px 15px;
            text-align: center;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            font-style: italic;
            letter-spacing: 1.2px;
            cursor: pointer;
            white-space: nowrap;
            flex: 1;
            min-width: fit-content;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        /* ===== SIDEBAR STYLES ===== */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: #0a2f4d;
            transition: left 0.3s;
            z-index: 2000;
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 30px 20px;
            background: #0d3b66;
            color: white;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar-user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-user-info .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ffd700;
            color: #0d3b66;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 2rem;
        }
        
        .sidebar-user-info span {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }

        .sidebar-item {
            padding: 18px 25px;
            color: white;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }

        .sidebar-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .sidebar-item.sign-in {
            background: #0d3b66;
            font-weight: bold;
            font-style: italic;
            letter-spacing: 1.5px;
            text-align: center;
            margin-top: 10px;
        }

        .sidebar-item-home {
            text-align: center;
            background: #0d3b66;
            font-weight: bold;
            font-style: italic;
            letter-spacing: 1.5px;
            margin-top: 10px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .overlay.active {
            display: block;
        }

        /* ===== MAIN CONTENT STYLES ===== */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .welcome-section {
            background: white;
            padding: 40px 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: left;
            position: relative;
            z-index: 1;
        }

        /* Outer glowing border - blue, pink, purple theme */
        .welcome-section::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            background: linear-gradient(45deg, 
                #0d3b66 0%, 
                #667eea 14%, 
                #764ba2 28%, 
                #f093fb 42%, 
                #4facfe 57%, 
                #00f2fe 71%, 
                #667eea 85%, 
                #0d3b66 100%);
            border-radius: 15px;
            z-index: -1;
            filter: blur(8px);
        }

        /* Inner chasing border */
        .welcome-section::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border-radius: 15px;
            z-index: -1;
        }

        .welcome-section h1 {
            color: #0d3b66;
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin-bottom: 15px;
            text-align: center;
            white-space: nowrap;
        }
        
        .welcome-section p {
            color: #666;
            font-size: 1.2rem;
            line-height: 1.6;
        }

        /* ===== WORD DATABASE SECTION ===== */
        .word-database {
            background: white;
            padding: 30px 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .database-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .database-header h2 {
            color: #0d3b66;
            font-size: 2rem;
        }

        .search-box {
            display: flex;
            gap: 10px;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #0d3b66;
            border-radius: 5px;
            font-size: 1rem;
            font-family: Georgia, serif;
        }

        .search-box button {
            padding: 12px 25px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
        }

        .search-box button:hover {
            background: #0a2f4d;
        }

        /* ===== ALPHABET NAVIGATION ===== */
        .alphabet-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .letter-btn {
            width: 40px;
            height: 40px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
            transition: all 0.2s;
        }

        .letter-btn:hover {
            background: #ffd700;
            color: #0d3b66;
            transform: scale(1.1);
        }

        .letter-btn.active {
            background: #ffd700;
            color: #0d3b66;
        }

        /* ===== LOADING & STATUS ===== */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }

        .status-message {
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #0d3b66;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        /* ===== WORD CARD STYLES ===== */
        .word-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .word-card {
            background: #f9f9f9;
            border: 2px solid #0d3b66;
            border-radius: 8px;
            padding: 12px 18px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .word-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .word-title {
            font-size: 1.8rem;
            color: #0d3b66;
            font-weight: bold;
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-actions {
            display: flex;
            gap: 10px;
        }

        .icon-btn {
            background: #0d3b66;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #ffd700;
            color: #0d3b66;
            transform: scale(1.1);
        }

        .icon-btn.favorited {
            background: #ffd700;
            color: #0d3b66;
        }

        .word-phonetic {
            color: #666;
            font-style: italic;
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.2;
        }

        .word-phonetic-preview {
            color: #000; 
            font-style: italic;
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.2;
            min-height: 16px;
        }

        .word-pos {
            display: inline-block;
            background: #0d3b66;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .word-definition {
            color: #666;
            line-height: 1.3;
            margin: 0;
            font-size: 0.9rem;
            font-weight: 400;
        }

        .word-example {
            background: #e3f2fd;
            padding: 10px;
            border-left: 3px solid #0d3b66;
            font-style: italic;
            color: #555;
            margin-top: 10px;
        }

        .user-type-btn {
            width: 100%;
            padding: 20px;
            background: white;
            border: 3px solid #0d3b66;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: Georgia, serif;
            text-align: center;
        }

        .user-type-btn:hover {
            background: #e3f2fd;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* ===== WORD DETAIL MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            background: #0d3b66;
            color: white;
            padding: 25px;
            border-radius: 10px 10px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        .modal-body {
            padding: 30px;
        }

        .practice-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .practice-btn {
            padding: 15px 30px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            font-family: Georgia, serif;
            transition: all 0.2s;
        }

        .practice-btn:hover {
            background: #ffd700;
            color: #0d3b66;
            transform: translateY(-2px);
        }

        .practice-btn:active {
            transform: translateY(0);
        }

        .practice-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .practice-btn.listening {
            background: #ff6b6b;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .feedback.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        /* ===== QUIZ STYLES ===== */
        .quiz-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 3px solid #0d3b66;
            flex-wrap: wrap;
        }

        .quiz-tab {
            padding: 15px 30px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px 10px 0 0;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
            color: #0d3b66;
            transition: all 0.3s;
        }

        .quiz-tab:hover {
            background: #e3f2fd;
        }

        .quiz-tab.active {
            background: #0d3b66;
            color: white;
        }

        .quiz-mode {
            display: none;
        }

        .quiz-mode.active {
            display: block;
        }

        .quiz-question-card {
            background: white;
            padding: 10px 10px; 
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin: 20px 0;
            max-width: 100%;
        }

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .quiz-option {
            padding: 15px 20px;
            background: #f9f9f9;
            border: 2px solid #0d3b66;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
            text-align: left;
        }

        .quiz-option:hover {
            background: #e3f2fd;
            transform: translateX(10px);
        }

        .quiz-option.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .quiz-option.wrong {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .quiz-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d3b66;
            margin: 20px 0;
            text-align: center;
        }

        .favorite-heart {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .favorite-heart:hover {
            transform: scale(1.2);
        }

        .favorite-heart.active {
            color: #ff6b6b;
        }

        /* ===== VERIFICATION MODAL ===== */
        .verification-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .verification-modal.active {
            display: flex;
        }

        .verification-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 50px rgba(255,0,0,0.3);
            border: 3px solid #dc3545;
        }

        .verification-header {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 15px 15px 0 0;
        }

        .verification-header h2 {
            margin: 0;
            font-size: 1.8rem;
        }

        .verification-body {
            padding: 30px;
        }

        .verification-body .form-group {
            margin-bottom: 20px;
        }

        .verification-body .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #0d3b66;
            font-weight: bold;
        }

        .verification-body .form-group input,
        .verification-body .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #0d3b66;
            border-radius: 5px;
            font-size: 1rem;
            font-family: Georgia, serif;
        }

        .verification-body .auth-submit {
            width: 100%;
            padding: 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .verification-body .auth-submit:hover {
            background: #218838;
        }

        /* ===== AUTH MODAL ===== */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .auth-modal.active {
            display: flex;
        }

        .auth-content {
            background: white;
            border-radius: 10px;
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            margin: auto;
        }

        .auth-header {
            background: #0d3b66;
            color: white;
            padding: 25px;
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 2px solid #0d3b66;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: #f5f5f5;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: white;
            color: #0d3b66;
        }

        .auth-body {
            padding: 30px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #0d3b66;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #0d3b66;
            border-radius: 5px;
            font-size: 1rem;
            font-family: Georgia, serif;
        }

        .auth-submit {
            width: 100%;
            padding: 15px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .auth-submit:hover {
            background: #0a2f4d;
        }

        /* ===== FAVORITES GRID ===== */
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .favorite-card {
            background: #f9f9f9;
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        /* ===== VIRTUAL KEYBOARD - OPTIMIZED ===== */
        .virtual-keyboard {
            margin: 20px auto;
            max-width: 100%;
            padding: 0 5px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 3px;
            margin-bottom: 5px;
        }

        .keyboard-key {
            padding: 14px 6px;
            min-width: 32px;
            flex: 1;
            max-width: 45px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
            transition: all 0.1s;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .keyboard-key:active {
            background: #ffd700;
            color: #0d3b66;
            transform: scale(0.95);
        }

        .keyboard-key.space {
            min-width: 180px;
            max-width: 250px;
            flex: 2;
        }

        .keyboard-key.backspace,
        .keyboard-key.enter {
            min-width: 65px;
            max-width: 90px;
            background: #dc3545;
            font-size: 0.85rem;
        }

        .keyboard-key.backspace:active,
        .keyboard-key.enter:active {
            background: #c82333;
            color: white;
        }

        /* ===== BALLOON & CONFETTI ANIMATIONS ===== */
        @keyframes float {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
            }
            25% {
                transform: translateY(-20px) rotate(5deg);
            }
            75% {
                transform: translateY(-10px) rotate(-5deg);
            }
        }

        @keyframes rise {
            0% {
                bottom: -100px;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                bottom: 100%;
                opacity: 0;
            }
        }

        .balloon {
            position: fixed;
            font-size: 3rem;
            animation: rise 8s ease-in infinite;
            z-index: 1000;
            pointer-events: none;
        }

        .balloon:nth-child(1) { left: 10%; animation-delay: 0s; }
        .balloon:nth-child(2) { left: 25%; animation-delay: 1s; }
        .balloon:nth-child(3) { left: 40%; animation-delay: 2s; }
        .balloon:nth-child(4) { left: 55%; animation-delay: 3s; }
        .balloon:nth-child(5) { left: 70%; animation-delay: 4s; }
        .balloon:nth-child(6) { left: 85%; animation-delay: 5s; }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            top: -10px;
            z-index: 1000;
            animation: confetti-fall 3s linear;
            pointer-events: none;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* ===== IQ BADGE ===== */
        .iq-badge {
            display: inline-block;
            padding: 20px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50px;
            font-size: 2.5rem;
            font-weight: bold;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: pulse-glow 2s infinite;
            margin: 20px 0;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 15px 40px rgba(118, 75, 162, 0.8);
                transform: scale(1.05);
            }
        }

        /* ===== DRAGGABLE LETTER TILES ===== */
        .letter-tiles-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 30px 0;
            flex-wrap: nowrap;
            overflow-x: auto;
            min-height: 80px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .letter-tile {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #0d3b66, #1a5490);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            border-radius: 10px;
            cursor: move;
            user-select: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.3s;
            touch-action: none;
        }

        .letter-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .letter-tile.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .letter-tile.drag-over {
            transform: scale(1.1);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0d3b66;
        }

        /* ===== DASHBOARD STYLES ===== */
        .dashboard-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard-welcome-card {
            background: linear-gradient(135deg, #0d3b66 0%, #1a5490 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .dashboard-profile-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            min-width: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0d3b66;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
            border: 4px solid rgba(255,255,255,0.3);
        }

        .profile-info h1 {
            color: white;
            font-size: 1.8rem;
            margin: 0 0 5px 0;
        }

        .profile-info p {
            color: rgba(255,255,255,0.9);
            margin: 3px 0;
            font-size: 1rem;
        }

        .dashboard-section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #0d3b66;
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #0d3b66;
            display: inline-block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .profile-action-btn {
            padding: 10px 20px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .profile-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13,59,102,0.3);
        }

        .profile-action-btn-save {
            background: #28a745;
        }

        .profile-action-btn-save:hover {
            background: #218838;
        }

        .profile-action-btn-cancel {
            background: #6c757d;
        }

        .profile-action-btn-cancel:hover {
            background: #5a6268;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #0d3b66, #ffd700);
            transform: scaleX(0);
            transition: transform 0.3s;
        }

        .dashboard-card:hover::before {
            transform: scaleX(1);
        }

        .dashboard-card-clickable {
            cursor: pointer;
        }

        .dashboard-card-clickable:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .card-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #0d3b66;
            margin: 10px 0;
        }

        .card-label {
            color: #666;
            font-size: 1rem;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .card-action {
            color: #0d3b66;
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .dashboard-card-clickable:hover .card-action {
            opacity: 1;
        }

        .profile-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }

        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .field-label {
            font-weight: bold;
            color: #0d3b66;
            font-size: 1rem;
            min-width: 150px;
        }

        .field-value {
            flex: 1;
            text-align: right;
            color: #333;
        }

        .field-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #0d3b66;
            border-radius: 8px;
            font-size: 1rem;
            font-family: Georgia, serif;
        }

        .settings-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .setting-item {
            display: flex;
            align-items: center;
            padding: 20px 25px;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-item:hover {
            background: #f8f9fa;
        }

        .setting-icon {
            font-size: 1.8rem;
            margin-right: 15px;
            min-width: 40px;
            text-align: center;
        }

        .setting-content {
            flex: 1;
        }

        .setting-title {
            font-weight: bold;
            color: #0d3b66;
            font-size: 1.1rem;
            margin-bottom: 3px;
        }

        .setting-description {
            color: #666;
            font-size: 0.9rem;
        }

        .setting-arrow {
            color: #0d3b66;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .my-profile-btn {
            margin-top: 12px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0d3b66;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .my-profile-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
            background: linear-gradient(135deg, #ffed4e, #ffd700);
        }

        .my-profile-btn:active {
            transform: translateY(0);
        }

        /* ===== ID VERIFICATION STYLES ===== */
        .id-verification-section {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .id-verification-section.show {
            display: block;
        }

        .id-verification-section h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .id-verification-section p {
            color: rgba(255,255,255,0.9);
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .id-upload-area {
            background: rgba(255,255,255,0.95);
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .id-upload-area:hover {
            background: white;
            border-color: #764ba2;
            transform: translateY(-2px);
        }

        .id-upload-area.drag-over {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .id-upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        .id-upload-text {
            font-size: 1.1rem;
            color: #0d3b66;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .id-upload-hint {
            font-size: 0.9rem;
            color: #666;
        }

        .id-preview-container {
            margin-top: 20px;
            display: none;
        }

        .id-preview-container.show {
            display: block;
        }

        .id-preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            margin-bottom: 15px;
        }

        .id-verification-status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .id-verification-status.show {
            display: block;
        }

        .id-verification-status.verifying {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .id-verification-status.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }

        .id-verification-status.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }

        .verification-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #856404;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .id-requirements {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .id-requirements ul {
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }

        .id-requirements li {
            color: white;
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }

        .id-requirements li:before {
            content: "âœ“";
            position: absolute;
            left: 0;
            color: #FFD700;
            font-weight: bold;
        }

        #verify-id-file {
            display: none;
        }

        .btn-change-id {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .btn-change-id:hover {
            background: #c82333;
        }

        /* ===== COACHES TABLE STYLES ===== */
        .coaches-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .coaches-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .coaches-table thead {
            background: linear-gradient(135deg, #0d3b66 0%, #1a5490 100%);
            color: white;
        }

        .coaches-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
            font-size: 1rem;
        }

        .coaches-table td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            color: #333;
        }

        .coaches-table tbody tr {
            cursor: pointer;
            transition: all 0.3s;
        }

        .coaches-table tbody tr:hover {
            background: #f8f9fa;
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .coaches-table tbody tr:last-child td {
            border-bottom: none;
        }

        .coach-profile-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .coach-avatar {
            width: 45px;
            height: 45px;
            min-width: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0d3b66, #1a5490);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(13,59,102,0.3);
        }

        .coach-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #0d3b66;
        }

        .verified-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 14px;
            background: #d4edda;
            color: #155724;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .unverified-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 14px;
            background: #fff3cd;
            color: #856404;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .coach-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .coach-stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
        }

        .coach-stat-card .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #0d3b66;
            margin: 10px 0;
        }

        .coach-stat-card .stat-label {
            color: #666;
            font-size: 1rem;
        }

        /* ===== COACH DETAIL MODAL ===== */
        .coach-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .coach-detail-modal.active {
            display: flex;
        }

        .coach-detail-content {
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
        }

        .coach-detail-header {
            background: linear-gradient(135deg, #0d3b66 0%, #1a5490 100%);
            color: white;
            padding: 30px;
            border-radius: 15px 15px 0 0;
            text-align: center;
            position: relative;
        }

        .coach-detail-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .coach-detail-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .coach-detail-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #0d3b66;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            margin: 0 auto 15px auto;
            box-shadow: 0 4px 15px rgba(255,215,0,0.4);
            border: 4px solid rgba(255,255,255,0.3);
        }

        .coach-detail-header h2 {
            margin: 0 0 10px 0;
            font-size: 1.8rem;
        }

        .coach-detail-header .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: bold;
            margin-top: 10px;
        }

        .coach-detail-header .verified {
            background: #d4edda;
            color: #155724;
        }

        .coach-detail-header .pending {
            background: #fff3cd;
            color: #856404;
        }

        .coach-detail-body {
            padding: 30px;
        }

        .coach-info-row {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            gap: 10px;
        }

        .coach-info-row:last-child {
            border-bottom: none;
        }

        .coach-info-label {
            font-weight: bold;
            color: #0d3b66;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .coach-info-value {
            flex: 1;
            color: #333;
            font-size: 1rem;
            word-break: break-word;
        }

        .coach-verification-notice {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #0d3b66;
            margin-top: 20px;
        }

        .coach-verification-notice h3 {
            color: #0d3b66;
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .coach-verification-notice ul {
            margin: 10px 0 0 20px;
            color: #666;
            line-height: 1.8;
        }

        /* ===== LIVE SPELLING STYLES ===== */
        .online-user-card {
            background: white;
            border: 2px solid #0d3b66;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .online-user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .online-user-card.offline {
            opacity: 0.5;
            border-color: #ccc;
            cursor: not-allowed;
        }

        .online-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 8px;
            animation: pulse-online 2s infinite;
        }

        @keyframes pulse-online {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .challenge-notification {
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(255,107,107,0.4);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .challenge-score-card {
            display: flex;
            justify-content: space-around;
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player-score {
            text-align: center;
        }

        .player-score .name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #0d3b66;
        }

        .player-score .score {
            font-size: 2rem;
            font-weight: bold;
            color: #28a745;
            margin: 10px 0;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== BOTTOM NOTIFICATION ===== */
        .bottom-notification {
            position: fixed;
            top: -200px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(40, 167, 69, 0.5);
            z-index: 9999;
            min-width: 350px;
            max-width: 500px;
            text-align: center;
            animation: slideDownNotification 0.5s ease-out forwards;
        }

        @keyframes slideDownNotification {
            to {
                top: 80px;
            }
        }

        .bottom-notification.hide {
            animation: slideUpNotification 0.5s ease-out forwards;
        }

        @keyframes slideUpNotification {
            to {
                top: -200px;
            }
        }

        /* ===== CUSTOM POPUP ===== */
        .custom-popup {
            display: none;
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.5);
            z-index: 9999;
            animation: slideDown 0.3s ease-out;
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
        }

        .custom-popup.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                top: 50px;
                opacity: 0;
            }
            to {
                top: 90px;
                opacity: 1;
            }
        }

        /* ===== COIN DISPLAY ===== */
        .coin-display {
            position: fixed;
            top: 125px;
            right: 20px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #0d3b66;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            z-index: 999;
            display: none;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            font-size: 1.2rem;
            border: 3px solid #fff;
            transition: top 0.3s ease;
        }

        .coin-display.show {
            display: flex;
        }

        .coin-display.scrolled {
            top: 65px;
        }

        .coin-icon {
            font-size: 1.8rem;
        }

        /* ===== COIN EARNED ANIMATION ===== */
        .coin-earned {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #0d3b66;
            padding: 30px 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6);
            z-index: 10000;
            font-size: 3rem;
            font-weight: bold;
            animation: coinEarnedAnimation 2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes coinEarnedAnimation {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -200%) scale(0.8);
            }
        }

        /* ===== RESPONSIVE STYLES ===== */
        @media (max-width: 768px) {
            .logo {
                font-size: 1rem;
                letter-spacing: 0.5px;
            }
            
            .nav-item {
                font-size: 1rem;
                padding: 14px 10px;
                letter-spacing: 0.5px;
            }

            .welcome-section h1 {
                font-size: 2rem;
            }

            .database-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }

            .favorites-grid {
                grid-template-columns: 1fr;
            }

            .letter-tile {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }

            .keyboard-key {
                padding: 12px 4px;
                min-width: 28px;
                max-width: 38px;
                font-size: 0.9rem;
            }

            .keyboard-key.space {
                min-width: 140px;
                max-width: 200px;
            }

            .keyboard-key.backspace,
            .keyboard-key.enter {
                min-width: 55px;
                max-width: 75px;
                font-size: 0.75rem;
                padding: 12px 3px;
            }

            .dashboard-container {
                padding: 15px;
            }
            
            .dashboard-welcome-card {
                padding: 20px;
            }
            
            .dashboard-profile-section {
                flex-direction: column;
                text-align: center;
            }
            
            .profile-avatar-large {
                width: 70px;
                height: 70px;
                font-size: 2rem;
            }
            
            .profile-info h1 {
                font-size: 1.5rem;
            }
            
            .dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            
            .card-icon {
                font-size: 2rem;
            }
            
            .stat-number {
                font-size: 2rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .profile-actions {
                width: 100%;
            }
            
            .profile-action-btn {
                flex: 1;
                min-width: 100px;
            }
            
            .profile-field {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .field-label {
                min-width: auto;
            }
            
            .field-value {
                text-align: left;
                width: 100%;
            }
            
            .setting-item {
                padding: 15px;
            }
            
            .setting-icon {
                font-size: 1.5rem;
                margin-right: 12px;
            }

            .coaches-table th:not(:first-child):not(:last-child),
            .coaches-table td:not(:first-child):not(:last-child) {
                display: none;
            }
            
            .coach-avatar {
                width: 40px;
                height: 40px;
                min-width: 40px;
                font-size: 1rem;
            }
            
            .coach-name {
                font-size: 1rem;
            }
            
            .verified-badge,
            .unverified-badge {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
            
            .coach-detail-content {
                margin: 20px;
            }
            
            .coach-detail-header {
                padding: 20px;
            }
            
            .coach-detail-avatar-large {
                width: 80px;
                height: 80px;
                font-size: 2.5rem;
            }
            
            .coach-detail-body {
                padding: 20px;
            }
            
            .coach-info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .coach-info-label {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .logo {
                font-size: 0.95rem;
                letter-spacing: 0.3px;
            }
            
            .menu-icon span {
                width: 25px;
                height: 3px;
            }
            
            .user-avatar {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
            
            .user-info span {
                font-size: 0.9rem;
            }

            .keyboard-row {
                gap: 2px;
                margin-bottom: 4px;
            }

            .keyboard-key {
                padding: 10px 2px;
                min-width: 24px;
                max-width: 32px;
                font-size: 0.85rem;
            }

            .keyboard-key.space {
                min-width: 100px;
                max-width: 150px;
            }

            .keyboard-key.backspace,
            .keyboard-key.enter {
                min-width: 45px;
                max-width: 60px;
                font-size: 0.7rem;
                padding: 10px 2px;
            }

            .profile-info h1 {
                font-size: 1.3rem;
            }
            
            .profile-info p {
                font-size: 0.9rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .section-title {
                font-size: 1.3rem;
            }

            .welcome-section h1 {
                font-size: clamp(1.2rem, 4.5vw, 2rem);
            }
        }

        @media (max-width: 600px) {
            .welcome-section h1 {
                font-size: clamp(1.2rem, 4.5vw, 2rem);
            }
        }

        @media (max-width: 400px) {
            .welcome-section h1 {
                font-size: clamp(1rem, 4vw, 1.5rem);
            }

            .keyboard-key {
                padding: 8px 1px;
                min-width: 20px;
                max-width: 28px;
                font-size: 0.8rem;
            }

            .keyboard-key.space {
                min-width: 80px;
                max-width: 120px;
            }

            .keyboard-key.backspace,
            .keyboard-key.enter {
                min-width: 38px;
                max-width: 50px;
                font-size: 0.65rem;
            }
        }

        /* WhatsApp Channel Button Hover Effect */
        a[href*="whatsapp.com/channel"]:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
        }

        /* Level selection styling */
        #quiz-level-selection,
        #spelling-level-selection,
        #spelling-difficulty-selection,
        #unscramble-level-selection,
        #unscramble-difficulty-selection {
            transition: opacity 0.3s ease;
        }

        #spelling-level-name,
        #unscramble-level-name {
            font-size: 1.2rem;
            color: #0d3b66;
            font-weight: bold;
            margin: 15px 0;
        }
    </style>
</head>
    </style>
</head>
<body>
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
     <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">
        <div class="sidebar-user-info" id="sidebarUserInfo">
            <div class="user-avatar" id="sidebarUserAvatar" style="background-image: none; background-size: cover; background-position: center;">?</div>
            <span id="sidebarUserName">Guest</span>
            <button class="my-profile-btn" id="myProfileBtn" onclick="goToUserDashboard()" style="display: none;">
                ðŸ‘¤ MY PROFILE
            </button>
        </div>
    </div>
    <div class="sidebar-item sidebar-item-home" onclick="navigateTo('home')">HOME</div>
    <div class="sidebar-item" onclick="navigateTo('word-database')">WORD DATABASE</div>
    <div class="sidebar-item" onclick="navigateTo('coaches')">BOOK COACHES</div>
    <div class="sidebar-item" onclick="navigateTo('students')">OUR STUDENTS</div>
    <div class="sidebar-item" onclick="()">CONTACT US</div>
    <div class="sidebar-item" onclick="navigateTo('about')">ABOUT US</div>
    <div class="sidebar-item sign-in" id="sidebar-signin" onclick="showAuthModal()">SIGN IN</div>
    <div class="sidebar-item" id="sidebar-signout" style="display:none;" onclick="signOut()">SIGN OUT</div>
</div>
</div>


  
    <!-- Header -->
    <header class="header">
       <div class="top-bar">
            <div class="logo">WORD BIZ COACHING ACADEMY</div>
            <div class="left-section">
                <div class="menu-icon" onclick="toggleSidebar()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>

<nav class="nav-bar">
            <div class="nav-item" onclick="navigateTo('quiz', true)">QUIZ</div>
            <div class="nav-item">TOURNAMENTS</div>
           <div class="nav-item" onclick="navigateTo('spelling', true)">SPELLING</div>
        </nav>
    </header>


    <!-- Coin Display (Top Right) -->
<div class="coin-display" id="coinDisplay">
    <span class="coin-icon">ðŸª™</span>
    <span id="coinAmount">0</span>
</div>

    
    <!-- Main Content -->
    <div class="container">
        <!-- Home Section -->
<div id="home-section" class="content-section active">
    <div class="welcome-section" style="padding-bottom: 0;">
        <img src="https://res.cloudinary.com/dqqr9udcs/image/upload/v1760911020/preview_2_u1bya5.webp" alt="WordBiz Logo" style="max-width: 150px; height: auto; margin: 0 auto 20px auto; display: block;">
        <h1>WORD BIZ COACHING ACADEMY</h1>
        <p>Welcome to Word Biz Coaching Academy where children are committed to striving for the absolute best and coaches are committed to helping each and every child master over 15,000 English words with AI-Powered learning tools to ensure each child's knowledge is significantly boosted.</p>
        
        <!-- WhatsApp Channel Button -->
        <a href="https://whatsapp.com/channel/0029VbBQ7HcAzNbx4tLhPh2E" 
           target="_blank" 
           style="display: block; width: calc(100% + 40px); margin-top: 30px; margin-left: -20px; margin-right: -20px; margin-bottom: -40px; padding: 20px; background: #25D366; color: white; text-decoration: none; border-radius: 0 0 15px 15px; font-weight: bold; font-size: 1.2rem; text-align: center; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); transition: all 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            JOIN OUR WHATSAPP!!
        </a>
    </div>
</div>
         <!-- Word Database Section -->
<div id="word-database-section" class="content-section">
    <div class="word-database">
        <!-- Level Selection Screen -->
        <div id="level-selection" class="welcome-section">
            <h2>ðŸ“š CHOOSE YOUR LEVEL</h2>
            <p style="margin: 20px 0;">Select a difficulty level to access words:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                <button class="user-type-btn" onclick="loadLevel('foundation')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŒ±</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 1</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">FOUNDATION</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Basic vocabulary building</div>
                </button>
                
                <button class="user-type-btn" onclick="loadLevel('challenge')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŽ¯</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 2</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHALLENGE</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Intermediate vocabulary</div>
                </button>
                
                <button class="user-type-btn" onclick="loadLevel('advanced')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸš€</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 3</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">ADVANCED</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Complex vocabulary</div>
                </button>
                
                <button class="user-type-btn" onclick="loadLevel('championship')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ†</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 4</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHAMPIONSHIP</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Expert vocabulary</div>
                </button>
            </div>
        </div>
        
        <!-- Word Database Display (Hidden Initially) -->
        <div id="word-database-display" style="display: none;">
            <div class="database-header">
                <button class="practice-btn" onclick="backToLevelSelection()" style="background: #6c757d; padding: 10px 20px; font-size: 0.9rem;">
                    â† Back to Levels
                </button>
                <h2 id="current-level-title">ðŸ“š WORD DATABASE</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search for any word..." />
                    <button onclick="searchWord()">Search</button>
                </div>
            </div>

            <div class="status-message" id="statusMessage">
                Select a level to load words...
            </div>

            <!-- Alphabet Navigation -->
            <div class="alphabet-nav" id="alphabetNav"></div>

            <!-- Word List -->
            <div class="word-list" id="wordList">
                <div class="loading">Select a letter or search for a word to begin</div>
            </div>
        </div>
    </div>
</div>

      <!-- Quiz Section -->
        <div id="quiz-section" class="content-section">
            <div class="word-database">
                <div class="quiz-tabs">
                    <button class="quiz-tab active" onclick="switchQuizMode('practice')">PRACTICE QUIZ</button>
                    <button class="quiz-tab" onclick="switchQuizMode('live')">LIVE QUIZ</button>
                    <button class="quiz-tab" onclick="switchQuizMode('leaderboard')">QUIZ LEADERBOARD</button>
                </div>

                <div id="practice-quiz-mode" class="quiz-mode active">
                    <!-- Level Selection -->
                    <div id="quiz-level-selection" class="welcome-section">
                        <h2>ðŸŽ¯ PRACTICE QUIZ</h2>
                        <p style="margin: 20px 0;">Select a difficulty level for your quiz:</p>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                            <button class="user-type-btn" onclick="startPracticeQuizWithLevel('foundation')">
                                <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŒ±</div>
                                <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 1</div>
                                <div style="font-size: 1.1rem; margin: 5px 0;">FOUNDATION</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Basic vocabulary quiz</div>
                            </button>
                            
                            <button class="user-type-btn" onclick="startPracticeQuizWithLevel('challenge')">
                                <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŽ¯</div>
                                <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 2</div>
                                <div style="font-size: 1.1rem; margin: 5px 0;">CHALLENGE</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Intermediate vocabulary quiz</div>
                            </button>
                            
                            <button class="user-type-btn" onclick="startPracticeQuizWithLevel('advanced')">
                                <div style="font-size: 2rem; margin-bottom: 10px;">ðŸš€</div>
                                <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 3</div>
                                <div style="font-size: 1.1rem; margin: 5px 0;">ADVANCED</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Complex vocabulary quiz</div>
                            </button>
                            
                            <button class="user-type-btn" onclick="startPracticeQuizWithLevel('championship')">
                                <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ†</div>
                                <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 4</div>
                                <div style="font-size: 1.1rem; margin: 5px 0;">CHAMPIONSHIP</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Expert vocabulary quiz</div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quiz Container -->
                    <div id="practice-quiz-container"></div>
                </div>

                <!-- Live Quiz Mode -->
                <div id="live-quiz-mode" class="quiz-mode">
                    <div class="welcome-section">
                        <h2>âš¡ Live Quiz Challenges</h2>
                        <p style="margin: 20px 0;">Challenge other students to vocabulary quiz battles in real-time!</p>
                        
                        <!-- Online Users Section -->
                        <div id="quiz-online-users-section">
                            <h3 style="color: #0d3b66; margin: 20px 0;">ðŸ‘¥ Online Students (<span id="quiz-online-count">0</span>)</h3>
                            <div id="quiz-online-users-list" class="favorites-grid">
                                <div class="loading">Loading online users...</div>
                            </div>
                        </div>
                        
                        <!-- Incoming Challenges -->
                        <div id="quiz-incoming-challenges-section" style="margin-top: 30px; display: none;">
                            <h3 style="color: #dc3545; margin: 20px 0;">âš¡ Incoming Quiz Challenges</h3>
                            <div id="quiz-incoming-challenges-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Quiz Leaderboard Mode -->
                <div id="leaderboard-quiz-mode" class="quiz-mode">
                    <div class="welcome-section">
                        <h2>ðŸ“Š Quiz Leaderboard</h2>
                        <p>Top quiz champions ranked by wins and performance!</p>
                        
                        <div id="quiz-leaderboard-container" class="loading">
                            Loading leaderboard...
                        </div>
                    </div>
                </div>
            </div>
        </div>

       
        <!-- Favorites Section -->
        <div id="favorites-section" class="content-section">
            <div class="word-database">
                <div class="database-header">
                    <h2>MY FAVORITES</h2>
                    <button class="practice-btn" id="favoritesQuizBtn" onclick="startFavoritesQuiz()" disabled>
                        Generate Quiz from Favorites
                    </button>
                </div>
                <div id="favorites-container" class="loading">
                    Please sign in to save favorites
                </div>
            </div>
        </div>

        <!-- Incorrect Quiz Section -->
        <div id="incorrect-quiz-section" class="content-section">
            <div class="word-database">
                <div class="database-header">
                    <h2>INCORRECT QUESTIONS</h2>
                    <button class="practice-btn" id="incorrectQuizBtn" onclick="startIncorrectQuiz()" disabled>
                        Practice Incorrect Questions
                    </button>
                </div>
                <div id="incorrect-container" class="loading">
                    Please sign in to track incorrect answers
                </div>
            </div>
        </div>
    </div>

</div>


    
    <!-- Word Detail Modal -->
    <div class="modal" id="wordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalWord">Word</h2>
                <button class="modal-close" onclick="closeModal()">Ã—</button>
                <div class="word-phonetic" id="modalPhonetic"></div>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
                <div class="practice-section">
                    <h3>ðŸŽ¤ PRACTICE PRONUNCIATION</h3>
                    <button class="practice-btn" onclick="speakWord()">ðŸ”Š LISTEN</button>
                    <button class="practice-btn" id="practiceBtn" onclick="startPractice()">ðŸŽ¤ PRACTICE SPEAKING</button>
                    <div id="practiceFeedback"></div>
                </div>
            </div>
        </div>
    </div>

   <!-- Verification Modal (Cannot be closed) -->
<div class="verification-modal" id="verificationModal">
    <div class="verification-content">
        <div class="verification-header">
            <h2>âš ï¸ Complete Your Profile</h2>
            <p style="margin-top: 10px; font-size: 0.95rem;">Please complete your profile to continue using WordBiz</p>
        </div>
        <div class="verification-body">
            <form id="verification-form" onsubmit="handleVerification(event)">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="verify-name" required>
                </div>
                
                <div class="form-group">
                    <label>Age *</label>
                    <input type="number" id="verify-age" min="5" max="100" required>
                </div>
                
                <div class="form-group">
                    <label>Country *</label>
                    <select id="verify-country" required>
                        <option value="">Select your country</option>
                        <option value="United States">United States</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="Canada">Canada</option>
                        <option value="Australia">Australia</option>
                        <option value="Jamaica">Jamaica</option>
                        <option value="India">India</option>
                        <option value="Nigeria">Nigeria</option>
                        <option value="South Africa">South Africa</option>
                        <option value="Kenya">Kenya</option>
                        <option value="Ghana">Ghana</option>
                        <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                        <option value="Barbados">Barbados</option>
                        <option value="Bahamas">Bahamas</option>
                        <option value="Philippines">Philippines</option>
                        <option value="Singapore">Singapore</option>
                        <option value="New Zealand">New Zealand</option>
                        <option value="Ireland">Ireland</option>
                        <option value="Pakistan">Pakistan</option>
                        <option value="Bangladesh">Bangladesh</option>
                        <option value="Malaysia">Malaysia</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- ID Verification Section for Coaches ONLY -->
                <div class="id-verification-section" id="coachIdVerification">
                    <h3>ðŸ†” Coach ID Verification Required</h3>
                    <p>For the safety of our students, all coaches must verify their identity with a government-issued ID.</p>
                    
                    <div class="id-requirements">
                        <strong style="color: white;">Accepted Documents:</strong>
                        <ul>
                            <li>Driver's License</li>
                            <li>Passport</li>
                            <li>National ID Card</li>
                        </ul>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: rgba(255,255,255,0.9);">
                            âœ“ Must be at least 16 years old<br>
                            âœ“ Name must match your profile<br>
                            âœ“ Document must be valid and unaltered<br>
                            ðŸ”’ Your ID photo is never stored - only verification status
                        </p>
                    </div>

                    <div class="id-upload-area" id="idUploadArea" onclick="document.getElementById('verify-id-file').click()">
                        <div class="id-upload-icon">ðŸ“·</div>
                        <div class="id-upload-text">Click or Drag to Upload ID</div>
                        <div class="id-upload-hint">Supported: JPG, PNG, PDF (Max 10MB)</div>
                        <input type="file" id="verify-id-file" accept="image/*,.pdf" onchange="handleIDUpload(event)">
                    </div>

                    <div class="id-preview-container" id="idPreviewContainer">
                        <img id="idPreviewImage" class="id-preview-image" alt="ID Preview">
                        <button type="button" class="btn-change-id" onclick="changeIDPhoto()">Change Photo</button>
                    </div>

                    <div class="id-verification-status" id="idVerificationStatus"></div>
                </div>
                
                <button type="submit" class="auth-submit" id="completeProfileBtn">âœ… Complete Profile</button>
                
                <button type="button" class="auth-submit" onclick="signOutAndSwitchAccount()" 
                        style="background: #6c757d; margin-top: 10px;">
                    ðŸ”„ Sign Out & Use Different Account
                </button>
                
                <div id="verify-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>
        </div>
    </div>
</div>


    <!-- Change Password Modal -->
<div class="auth-modal" id="changePasswordModal">
    <div class="auth-content">
        <div class="auth-header">
            <h2>ðŸ”’ Change Password</h2>
            <button class="modal-close" onclick="closeChangePasswordModal()">Ã—</button>
        </div>
        <div class="auth-body">
            <form id="change-password-form" onsubmit="handleChangePassword(event)">
                <div class="form-group">
                    <label>Current Password *</label>
                    <input type="password" id="current-password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label>New Password * (minimum 6 characters)</label>
                    <input type="password" id="new-password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label>Confirm New Password *</label>
                    <input type="password" id="confirm-new-password" required minlength="6">
                </div>
                
                <button type="submit" class="auth-submit">âœ… Change Password</button>
                
                <div id="change-password-error" class="feedback error" style="display:none; margin-top:15px;"></div>
                <div id="change-password-success" class="feedback success" style="display:none; margin-top:15px;"></div>
            </form>
        </div>
    </div>
</div>
    
    <!-- Auth Modal -->
<div class="auth-modal" id="authModal">
    <div class="auth-content">
        <div class="auth-header">
            <h2>Welcome to WordBiz</h2>
            <button class="modal-close" onclick="closeAuthModal()">Ã—</button>
        </div>
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('signin')">SIGN IN</button>
            <button class="auth-tab" onclick="switchAuthTab('signup')">SIGN UP</button>
        </div>
        <div class="auth-body">
            <!-- Sign In Form -->
            <form id="signin-form" class="auth-form active" onsubmit="handleSignIn(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signin-email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signin-password" required>
                </div>
                <button type="submit" class="auth-submit">SIGN IN    </button>
                <button type="button" class="auth-submit" onclick="signInWithGoogle()" style="background: #db4437; margin-top: 10px;">
                    SIGN IN WITH GOOGLE
                </button>
                <div id="signin-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>

          <!-- Sign Up - User Type Selection -->
<div id="signup-selection" class="auth-form">
    <h3 style="color: #0d3b66; margin-bottom: 20px; text-align: center;">Choose Your Account Type</h3>
    
    <div style="display: flex; flex-direction: column; gap: 15px;">
        <button type="button" class="user-type-btn" onclick="showSignUpForm('student')">
            <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŽ“</div>
            <div style="font-size: 1.2rem; font-weight: bold;">Student</div>
            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Practice spelling & vocabulary</div>
        </button>
        
        <button type="button" class="user-type-btn" onclick="showSignUpForm('parent')">
            <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§</div>
            <div style="font-size: 1.2rem; font-weight: bold;">Parent</div>
            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Register your child & monitor progress</div>
        </button>
        
        <button type="button" class="user-type-btn" onclick="showSignUpForm('coach')">
            <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ‘¨â€ðŸ«</div>
            <div style="font-size: 1.2rem; font-weight: bold;">Coach</div>
            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Manage students & track progress</div>
        </button>
        
        <button type="button" class="user-type-btn" onclick="showSignUpForm('organization')">
            <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ«</div>
            <div style="font-size: 1.2rem; font-weight: bold;">School/Organization</div>
            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Manage coaches & students</div>
        </button>
    </div>
</div>

            <!-- Sign Up Form - Student -->
<form id="signup-student-form" class="auth-form" onsubmit="handleSignUp(event, 'student')" style="display: none;">
    <button type="button" onclick="backToUserTypeSelection()" style="background: none; border: none; color: #0d3b66; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
        â† Back to selection
    </button>
    
    <h3 style="color: #0d3b66; margin-bottom: 15px; text-align: center;">ðŸŽ“ Student Sign Up</h3>
    
    <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="signup-student-name" required>
    </div>
    <div class="form-group">
        <label>Email</label>
        <input type="email" id="signup-student-email" required>
    </div>
    <div class="form-group">
        <label>Password (min 6 characters)</label>
        <input type="password" id="signup-student-password" required minlength="6">
    </div>
    <div class="form-group">
        <label>Age</label>
        <input type="number" id="signup-student-age" min="5" max="100" required>
    </div>
    <div class="form-group">
        <label>Country</label>
        <select id="signup-student-country" required style="width: 100%; padding: 12px 15px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem; font-family: Georgia, serif;">
            <option value="">Select your country</option>
            <option value="United States">United States</option>
            <option value="United Kingdom">United Kingdom</option>
            <option value="Canada">Canada</option>
            <option value="Australia">Australia</option>
            <option value="Jamaica">Jamaica</option>
            <option value="India">India</option>
            <option value="Nigeria">Nigeria</option>
            <option value="South Africa">South Africa</option>
            <option value="Kenya">Kenya</option>
            <option value="Ghana">Ghana</option>
            <option value="Trinidad and Tobago">Trinidad and Tobago</option>
            <option value="Barbados">Barbados</option>
            <option value="Bahamas">Bahamas</option>
            <option value="Philippines">Philippines</option>
            <option value="Singapore">Singapore</option>
            <option value="New Zealand">New Zealand</option>
            <option value="Ireland">Ireland</option>
            <option value="Pakistan">Pakistan</option>
            <option value="Bangladesh">Bangladesh</option>
            <option value="Malaysia">Malaysia</option>
            <option value="Other">Other</option>
        </select>
    </div>
    <button type="submit" class="auth-submit">Create Student Account</button>
    <button type="button" class="auth-submit" onclick="signUpWithGoogle('student')" style="background: #db4437; margin-top: 10px;">
        Sign Up with Google
    </button>
    <div id="signup-student-error" class="feedback error" style="display:none; margin-top:15px;"></div>
</form>

        <!-- Sign Up Form - Parent -->
<form id="signup-parent-form" class="auth-form" onsubmit="handleParentSignUp(event)" style="display: none;">
    <button type="button" onclick="backToUserTypeSelection()" style="background: none; border: none; color: #0d3b66; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
        â† Back to selection
    </button>
    
    <h3 style="color: #0d3b66; margin-bottom: 15px; text-align: center;">ðŸ‘¨â€ðŸ‘©â€ðŸ‘§ Parent Sign Up</h3>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <strong style="color: #856404;">ðŸ“‹ Requirements:</strong>
        <ul style="color: #856404; margin: 10px 0 0 20px; line-height: 1.8;">
            <li>Parent's government-issued ID</li>
            <li>Child's government-issued ID or birth certificate</li>
            <li>Valid student ID from WordBiz</li>
        </ul>
    </div>
    
    <!-- Parent Information -->
    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="color: #0d3b66; margin: 0 0 15px 0;">ðŸ‘¤ Parent Information</h4>
        
        <div class="form-group">
            <label>Parent's Full Name *</label>
            <input type="text" id="signup-parent-name" required>
        </div>
        
        <div class="form-group">
            <label>Email *</label>
            <input type="email" id="signup-parent-email" required>
        </div>
        
        <div class="form-group">
            <label>Password * (min 6 characters)</label>
            <input type="password" id="signup-parent-password" required minlength="6">
        </div>
        
        <div class="form-group">
            <label>Phone Number *</label>
            <input type="tel" id="signup-parent-phone" required>
        </div>
        
        <div class="form-group">
            <label>Country *</label>
            <select id="signup-parent-country" required style="width: 100%; padding: 12px 15px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem; font-family: Georgia, serif;">
                <option value="">Select your country</option>
                <option value="United States">United States</option>
                <option value="United Kingdom">United Kingdom</option>
                <option value="Canada">Canada</option>
                <option value="Australia">Australia</option>
                <option value="Jamaica">Jamaica</option>
                <option value="India">India</option>
                <option value="Nigeria">Nigeria</option>
                <option value="South Africa">South Africa</option>
                <option value="Kenya">Kenya</option>
                <option value="Ghana">Ghana</option>
                <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                <option value="Barbados">Barbados</option>
                <option value="Bahamas">Bahamas</option>
                <option value="Philippines">Philippines</option>
                <option value="Singapore">Singapore</option>
                <option value="New Zealand">New Zealand</option>
                <option value="Ireland">Ireland</option>
                <option value="Pakistan">Pakistan</option>
                <option value="Bangladesh">Bangladesh</option>
                <option value="Malaysia">Malaysia</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <!-- Parent ID Upload -->
        <div class="form-group">
            <label>Parent's ID Photo * (Driver's License, Passport, or National ID)</label>
            <div class="id-upload-area" onclick="document.getElementById('parent-id-file').click()" style="background: rgba(255,255,255,0.95); border: 3px dashed #0d3b66; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s;">
                <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ“·</div>
                <div style="font-weight: bold; margin-bottom: 5px;">Click to Upload Parent's ID</div>
                <div style="font-size: 0.9rem; color: #666;">JPG, PNG, PDF (Max 10MB)</div>
                <input type="file" id="parent-id-file" accept="image/*,.pdf" onchange="handleParentIDUpload(event)" style="display: none;" required>
            </div>
            <div id="parent-id-preview" style="display: none; margin-top: 10px;">
                <img id="parent-id-preview-image" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <button type="button" onclick="changeParentID()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Change Photo</button>
            </div>
            <div id="parent-id-status" style="margin-top: 10px; display: none;"></div>
        </div>
    </div>
    
    <!-- Child Information -->
    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4 style="color: #0d3b66; margin: 0 0 15px 0;">ðŸ‘¶ Child Information</h4>
        
        <div class="form-group">
            <label>Child's Full Name *</label>
            <input type="text" id="signup-child-name" required>
        </div>
        
        <div class="form-group">
            <label>Child's Age *</label>
            <input type="number" id="signup-child-age" min="5" max="18" required>
        </div>
        
        <div class="form-group">
            <label>Child's Student ID * (Format: WB-2025-XXXX)</label>
            <input type="text" id="signup-child-student-id" placeholder="WB-2025-XXXX" pattern="WB-2025-[A-Z0-9]{4}" required>
            <small style="color: #666; margin-top: 5px; display: block;">This ID was provided when your child registered as a student</small>
        </div>
        
        <!-- Child ID Upload -->
        <div class="form-group">
            <label>Child's ID Photo * (Birth Certificate, Student ID, or Government ID)</label>
            <div class="id-upload-area" onclick="document.getElementById('child-id-file').click()" style="background: rgba(255,255,255,0.95); border: 3px dashed #9c27b0; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s;">
                <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ“·</div>
                <div style="font-weight: bold; margin-bottom: 5px;">Click to Upload Child's ID</div>
                <div style="font-size: 0.9rem; color: #666;">JPG, PNG, PDF (Max 10MB)</div>
                <input type="file" id="child-id-file" accept="image/*,.pdf" onchange="handleChildIDUpload(event)" style="display: none;" required>
            </div>
            <div id="child-id-preview" style="display: none; margin-top: 10px;">
                <img id="child-id-preview-image" style="max-width: 100%; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                <button type="button" onclick="changeChildID()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Change Photo</button>
            </div>
            <div id="child-id-status" style="margin-top: 10px; display: none;"></div>
        </div>
    </div>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <strong style="color: #856404;">ðŸ”’ Privacy & Security:</strong>
        <p style="color: #856404; margin: 10px 0 0 0; font-size: 0.9rem; line-height: 1.6;">
            ID photos are used only for verification purposes and are not stored permanently. Only verification status is saved in our database.
        </p>
    </div>
    
    <button type="submit" class="auth-submit" id="parent-signup-btn">âœ… Create Parent Account</button>
    
    <div id="signup-parent-error" class="feedback error" style="display:none; margin-top:15px;"></div>
</form>    
            <!-- Sign Up Form - Coach -->
            <form id="signup-coach-form" class="auth-form" onsubmit="handleSignUp(event, 'coach')" style="display: none;">
                <button type="button" onclick="backToUserTypeSelection()" style="background: none; border: none; color: #0d3b66; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
                    â† Back to selection
                </button>
                
                <h3 style="color: #0d3b66; margin-bottom: 15px; text-align: center;">ðŸ‘¨â€ðŸ« Coach Sign Up</h3>
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signup-coach-name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signup-coach-email" required>
                </div>
                <div class="form-group">
                    <label>Password (min 6 characters)</label>
                    <input type="password" id="signup-coach-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Organization/School Name (Optional)</label>
                    <input type="text" id="signup-coach-organization">
                </div>
                <button type="submit" class="auth-submit">Create Coach Account</button>
                <button type="button" class="auth-submit" onclick="signUpWithGoogle('coach')" style="background: #db4437; margin-top: 10px;">
                    Sign Up with Google
                </button>
                <div id="signup-coach-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>

            <!-- Sign Up Form - Organization -->
            <form id="signup-organization-form" class="auth-form" onsubmit="handleSignUp(event, 'organization')" style="display: none;">
                <button type="button" onclick="backToUserTypeSelection()" style="background: none; border: none; color: #0d3b66; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
                    â† Back to selection
                </button>
                
                <h3 style="color: #0d3b66; margin-bottom: 15px; text-align: center;">ðŸ« Organization Sign Up</h3>
                
                <div class="form-group">
                    <label>Organization/School Name</label>
                    <input type="text" id="signup-org-name" required>
                </div>
                <div class="form-group">
                    <label>Administrator Email</label>
                    <input type="email" id="signup-org-email" required>
                </div>
                <div class="form-group">
                    <label>Password (min 6 characters)</label>
                    <input type="password" id="signup-org-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Contact Phone</label>
                    <input type="tel" id="signup-org-phone" required>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="signup-org-address" required>
                </div>
                <button type="submit" class="auth-submit">Create Organization Account</button>
                <button type="button" class="auth-submit" onclick="signUpWithGoogle('organization')" style="background: #db4437; margin-top: 10px;">
                    Sign Up with Google
                </button>
                <div id="signup-org-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>
        </div>
    </div>
</div>

<!-- Coaches Section -->
<div id="coaches-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2>ðŸ‘¨â€ðŸ« OUR COACHES</h2>
            <p style="color: #666; margin-top: 10px;">Meet our verified professional coaches</p>
        </div>
        
        <div id="coaches-container" class="loading">
            Loading coaches...
        </div>
    </div>
</div>

   
    <!-- Spelling Section -->
        <div id="spelling-section" class="content-section">
            <div class="word-database">
               <div class="quiz-tabs">
    <button class="quiz-tab active" onclick="switchSpellingMode('practice')">Practice Spelling</button>
    <button class="quiz-tab" onclick="switchSpellingMode('unscramble')">Unscramble Words</button>
    <button class="quiz-tab" onclick="switchSpellingMode('live')">Live Spelling</button>
    <button class="quiz-tab" onclick="switchSpellingMode('leaderboard')">Spelling Leaderboard</button>
</div>

               <!-- Practice Spelling Mode -->
<div id="practice-spelling-mode" class="quiz-mode active">
    <div id="spelling-container">
        <!-- Level Selection -->
        <div id="spelling-level-selection" class="welcome-section">
            <h2>Practice Spelling</h2>
            <p>Select a word level to practice spelling:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                <button class="user-type-btn" onclick="startSpellingPracticeWithLevel('foundation')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŒ±</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 1</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">FOUNDATION</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Practice basic spelling</div>
                </button>
                
                <button class="user-type-btn" onclick="startSpellingPracticeWithLevel('challenge')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŽ¯</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 2</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHALLENGE</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Intermediate spelling</div>
                </button>
                
                <button class="user-type-btn" onclick="startSpellingPracticeWithLevel('advanced')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸš€</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 3</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">ADVANCED</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Complex spelling</div>
                </button>
                
                <button class="user-type-btn" onclick="startSpellingPracticeWithLevel('championship')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ†</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 4</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHAMPIONSHIP</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Expert spelling</div>
                </button>
            </div>
        </div>
        
        <div id="spelling-game" style="display: none;">
            <div class="quiz-question-card">
                <div class="quiz-score" id="spelling-score">Score: 0 / 0</div>
                <h3 id="spelling-progress">Word 1 of 10</h3>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="practice-btn" onclick="speakCurrentSpellingWord()" style="font-size: 0.9rem; padding: 10px 15px;">
                            ðŸ”Š Play Word
                        </button>
                        <button class="practice-btn" onclick="speakWordInSentence()" style="font-size: 0.9rem; padding: 10px 15px;">
                            ðŸ’¬ Use in Sentence
                        </button>
                        <button class="practice-btn" id="show-details-btn" onclick="showSpellingWordDetails()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                            ðŸ“– Word Details
                        </button>
                        <button class="practice-btn" id="add-spelling-favorite-btn" onclick="addCurrentSpellingToFavorites()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                            â­ Add to Favorites
                        </button>
                    </div>
                    <p style="margin-top: 5px; color: #666; font-style: italic; font-size: 0.9rem;">Listen to the word alone, in a sentence, see details, or add to favorites</p>
                </div>
                                
                <div class="form-group" style="margin: 30px 0;">
                    <label style="font-size: 1.2rem;">Type what you hear:</label>
                    <input type="text" id="spelling-input" 
                           placeholder="Use the keyboard below..." 
                           style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                           readonly>
                </div>
                
                <!-- Virtual Keyboard -->
                <div class="virtual-keyboard">
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeKey('Q')">Q</button>
                        <button class="keyboard-key" onclick="typeKey('W')">W</button>
                        <button class="keyboard-key" onclick="typeKey('E')">E</button>
                        <button class="keyboard-key" onclick="typeKey('R')">R</button>
                        <button class="keyboard-key" onclick="typeKey('T')">T</button>
                        <button class="keyboard-key" onclick="typeKey('Y')">Y</button>
                        <button class="keyboard-key" onclick="typeKey('U')">U</button>
                        <button class="keyboard-key" onclick="typeKey('I')">I</button>
                        <button class="keyboard-key" onclick="typeKey('O')">O</button>
                        <button class="keyboard-key" onclick="typeKey('P')">P</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeKey('A')">A</button>
                        <button class="keyboard-key" onclick="typeKey('S')">S</button>
                        <button class="keyboard-key" onclick="typeKey('D')">D</button>
                        <button class="keyboard-key" onclick="typeKey('F')">F</button>
                        <button class="keyboard-key" onclick="typeKey('G')">G</button>
                        <button class="keyboard-key" onclick="typeKey('H')">H</button>
                        <button class="keyboard-key" onclick="typeKey('J')">J</button>
                        <button class="keyboard-key" onclick="typeKey('K')">K</button>
                        <button class="keyboard-key" onclick="typeKey('L')">L</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeKey('Z')">Z</button>
                        <button class="keyboard-key" onclick="typeKey('X')">X</button>
                        <button class="keyboard-key" onclick="typeKey('C')">C</button>
                        <button class="keyboard-key" onclick="typeKey('V')">V</button>
                        <button class="keyboard-key" onclick="typeKey('B')">B</button>
                        <button class="keyboard-key" onclick="typeKey('N')">N</button>
                        <button class="keyboard-key" onclick="typeKey('M')">M</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key backspace" onclick="backspaceKey()">âŒ« Delete</button>
                        <button class="keyboard-key space" onclick="typeKey(' ')">Space</button>
                        <button class="keyboard-key enter" onclick="submitSpelling()">âœ“ Enter</button>
                    </div>
                </div>
                                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="practice-btn" onclick="skipSpellingWord()" style="background: #666;">
                        â­ï¸ Skip
                    </button>
                </div>
                                
                <div id="spelling-feedback" style="margin-top: 20px;"></div>
            </div>
        </div>
                        
        <div id="spelling-results" style="display: none;"></div>
    </div>
</div>

                <!-- Unscramble Mode -->
<div id="unscramble-mode" class="quiz-mode">
    <div id="unscramble-container">
        <!-- Level Selection -->
        <div id="unscramble-level-selection" class="welcome-section">
            <h2>Unscramble Words</h2>
            <p>Select a word level to unscramble:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                <button class="user-type-btn" onclick="startUnscrambleWithLevel('foundation')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŒ±</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 1</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">FOUNDATION</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Unscramble basic words</div>
                </button>
                
                <button class="user-type-btn" onclick="startUnscrambleWithLevel('challenge')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸŽ¯</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 2</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHALLENGE</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Intermediate unscramble</div>
                </button>
                
                <button class="user-type-btn" onclick="startUnscrambleWithLevel('advanced')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸš€</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 3</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">ADVANCED</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Complex unscramble</div>
                </button>
                
                <button class="user-type-btn" onclick="startUnscrambleWithLevel('championship')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ðŸ†</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 4</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHAMPIONSHIP</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Expert unscramble</div>
                </button>
            </div>
        </div>
        
        <div id="unscramble-game" style="display: none;">
            <div class="quiz-question-card">
                <div class="quiz-score" id="unscramble-score">Score: 0 / 0</div>
                <h3 id="unscramble-progress">Word 1 of 10</h3>
                
                <div style="text-align: center; margin: 30px 0;">
                    <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                    
                    <div id="letter-tiles" class="letter-tiles-container">
                        <!-- Letter tiles will be inserted here -->
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="practice-btn" onclick="shuffleLetters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                            ðŸ”€ Shuffle
                        </button>
                        
                        <button class="practice-btn" onclick="showUnscrambleHint()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px; background: #17a2b8;">
                            ðŸ’¡ Hint
                        </button>
                        
                        <button class="practice-btn" onclick="submitUnscramble()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            âœ“ Submit Answer
                        </button>
                    </div>
                </div>
                
                <div id="unscramble-feedback" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <div id="unscramble-results" style="display: none;"></div>
    </div>
</div>
                <!-- Live Spelling Mode -->
<div id="live-spelling-mode" class="quiz-mode">
    <div class="welcome-section">
        <h2>Live Spelling Challenges</h2>
        <p style="margin: 20px 0;">Challenge other students to spelling battles in real-time!</p>
        
        <!-- Online Users Section -->
        <div id="online-users-section">
            <h3 style="color: #0d3b66; margin: 20px 0;">ðŸ‘¥ Online Students (<span id="online-count">0</span>)</h3>
            <div id="online-users-list" class="favorites-grid">
                <div class="loading">Loading online users...</div>
            </div>
        </div>
        
        <!-- Incoming Challenges -->
        <div id="incoming-challenges-section" style="margin-top: 30px; display: none;">
            <h3 style="color: #dc3545; margin: 20px 0;">âš¡ Incoming Challenges</h3>
            <div id="incoming-challenges-list"></div>
        </div>
        
    </div>
</div>

                <!-- Spelling Leaderboard Mode -->
<div id="leaderboard-spelling-mode" class="quiz-mode">
    <div class="welcome-section">
        <h2>ðŸ“Š Spelling Leaderboard</h2>
        <p>Top spelling champions ranked by wins and performance!</p>
        
        <div id="leaderboard-container" class="loading">
            Loading leaderboard...
        </div>
    </div>
  </div>
</div>
</div>



    
    <!-- Spelling Favorites Section -->
<div id="spelling-favorites-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2>â­ MY SPELLING FAVORITES</h2>
            <button class="practice-btn" id="spellingFavoritesQuizBtn" onclick="startSpellingFavoritesQuiz()" disabled>
                Practice Spelling Favorites
            </button>
        </div>
        <div id="spelling-favorites-container" class="loading">
            Please sign in to save spelling favorites
        </div>
    </div>
</div>

<!-- Spelling Incorrect Section -->
<div id="spelling-incorrect-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2>SPELLING MISTAKES</h2>
            <button class="practice-btn" id="spellingIncorrectQuizBtn" onclick="startSpellingIncorrectQuiz()" disabled>
                Practice Spelling Mistakes
            </button>
        </div>
        <div id="spelling-incorrect-container" class="loading">
            Please sign in to track spelling mistakes
        </div>
    </div>
</div>


   <!-- Student Dashboard Section -->
<div id="student-dashboard-section" class="content-section">
    <div class="dashboard-container">
        <!-- Welcome Header -->
        <div class="dashboard-welcome-card">
            <div class="dashboard-profile-section">
                <div class="profile-avatar-large" id="dashboard-avatar" style="background-image: none; background-size: cover; background-position: center;">S</div>
                <div class="profile-info">
                    <h1 id="dashboard-name">Student Name</h1>
                    <p id="dashboard-email">student@email.com</p>
                    <p id="dashboard-join-date" style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">Member since: Loading...</p>
                </div>
            </div>
        </div>

        <!-- Quick Stats Grid -->
        <div class="dashboard-section">
            <h2 class="section-title">ðŸ“Š QUICK STATS</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card dashboard-card-clickable" onclick="navigateTo('favorites')">
                    <div class="card-icon">â­</div>
                    <div class="stat-number" id="stat-quiz-favorites">0</div>
                    <div class="card-label">QUIZ FAVORITES</div>
                    <div class="card-action">View all â†’</div>
                </div>

                <div class="dashboard-card dashboard-card-clickable" onclick="navigateTo('incorrect-quiz')">
                    <div class="card-icon">ðŸš«</div>
                    <div class="stat-number" id="stat-quiz-incorrect">0</div>
                    <div class="card-label">QUIZ MISTAKES</div>
                    <div class="card-action">Practice â†’</div>
                </div>

                <div class="dashboard-card dashboard-card-clickable" onclick="navigateTo('spelling-favorites')">
                    <div class="card-icon">â­</div>
                    <div class="stat-number" id="stat-spelling-favorites">0</div>
                    <div class="card-label">SPELLING FAVORITES</div>
                    <div class="card-action">View all â†’</div>
                </div>

                <div class="dashboard-card dashboard-card-clickable" onclick="navigateTo('spelling-incorrect')">
                    <div class="card-icon">ðŸš«</div>
                    <div class="stat-number" id="stat-spelling-incorrect">0</div>
                    <div class="card-label">SPELLING MISTAKES</div>
                    <div class="card-action">Practice â†’</div>
                </div>
            </div>
        </div>

        <!-- Subscription Status Section -->
        <div class="dashboard-section">
            <h2 class="section-title">ðŸ’Ž SUBSCRIPTION STATUS</h2>
            <div class="profile-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 3rem; margin-bottom: 15px;" id="sub-status-icon">ðŸ”“</div>
                    <h3 style="color: white; margin-bottom: 10px;" id="sub-status-title">Active Subscription</h3>
                    <p style="font-size: 1.2rem; opacity: 0.9; margin-bottom: 20px;" id="sub-status-text">Expires: Loading...</p>
                    
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <p style="font-size: 0.9rem; margin-bottom: 5px; opacity: 0.9;">Your Coins</p>
                        <p style="font-size: 2.5rem; font-weight: bold; margin: 5px 0;" id="dashboard-coins">0</p>
                        <p style="font-size: 0.8rem; opacity: 0.8;">/ 1000 max</p>
                    </div>
                    
                    <div id="sub-renew-section" style="display: none;">
                        <button class="auth-submit" onclick="redeemSubscriptionFromDashboard()" 
                                style="background: #FFD700; color: #0d3b66; font-weight: bold;">
                            ðŸª™ Renew for 300 Coins (30 Days)
                        </button>
                    </div>
                    
                    <p style="font-size: 0.9rem; opacity: 0.9; margin-top: 15px; font-style: italic;">
                        ðŸ’¡ Win spelling challenges to earn coins!
                    </p>
                </div>
            </div>
        </div>

        
        <!-- Profile Information -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">ðŸ‘¤ PROFILE INFORMATION</h2>
                <div class="profile-actions">
                    <button class="profile-action-btn" id="edit-profile-btn" onclick="toggleEditMode()">
                        âœï¸ Edit
                    </button>
                    
                    <button class="profile-action-btn profile-action-btn-cancel" id="cancel-edit-btn" onclick="cancelEditMode()" style="display: none;">
                        âœ–ï¸ Cancel
                    </button>

                    <button class="profile-action-btn profile-action-btn-save" id="save-profile-btn" onclick="saveProfile()" style="display: none;">
                        âœ… Save
                    </button>
                </div>
            </div>

            <div class="profile-card">
                <div class="profile-field">
                    <div class="field-label">ðŸ“› Full Name</div>
                    <div class="field-value">
                        <span id="display-name">Loading...</span>
                        <input type="text" id="edit-name" class="field-input" style="display: none;">
                    </div>
                </div>

                <div class="profile-field">
    <div class="field-label">ðŸ“§ Email</div>
    <div class="field-value">
        <span id="display-email">Loading...</span>
    </div>
</div>

<div class="profile-field">
    <div class="field-label">ðŸ†” Student ID</div>
    <div class="field-value">
        <span id="display-student-id" style="font-family: monospace; background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: #0d3b66;">Loading...</span>
    </div>
</div>

                <div class="profile-field">
                    <div class="field-label">ðŸŽ‚ Age</div>
                    <div class="field-value">
                        <span id="display-age">Loading...</span>
                        <input type="number" id="edit-age" class="field-input" min="5" max="100" style="display: none;">
                    </div>
                </div>

                <div class="profile-field">
                    <div class="field-label">ðŸŒ Country</div>
                    <div class="field-value">
                        <span id="display-country">Loading...</span>
                        <select id="edit-country" class="field-input" style="display: none;">
                            <option value="">Select your country</option>
                            <option value="United States">United States</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="Canada">Canada</option>
                            <option value="Australia">Australia</option>
                            <option value="Jamaica">Jamaica</option>
                            <option value="India">India</option>
                            <option value="Nigeria">Nigeria</option>
                            <option value="South Africa">South Africa</option>
                            <option value="Kenya">Kenya</option>
                            <option value="Ghana">Ghana</option>
                            <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                            <option value="Barbados">Barbados</option>
                            <option value="Bahamas">Bahamas</option>
                            <option value="Philippines">Philippines</option>
                            <option value="Singapore">Singapore</option>
                            <option value="New Zealand">New Zealand</option>
                            <option value="Ireland">Ireland</option>
                            <option value="Pakistan">Pakistan</option>
                            <option value="Bangladesh">Bangladesh</option>
                            <option value="Malaysia">Malaysia</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="profile-field">
                    <div class="field-label">ðŸ‘¥ Account Type</div>
                    <div class="field-value">
                        <span id="display-usertype">Student</span>
                    </div>
                </div>

                <div class="profile-field">
                    <div class="field-label">ðŸ“… Member Since</div>
                    <div class="field-value">
                        <span id="display-joined">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="dashboard-section">
            <h2 class="section-title">âš™ï¸ Settings</h2>
            <div class="settings-card">
                <div class="setting-item" onclick="showChangePasswordModal()">
                    <div class="setting-icon"></div>
                    <div class="setting-content">
                        <div class="setting-title">Change Password</div>
                        <div class="setting-description">Update your account password</div>
                    </div>
                    <div class="setting-arrow">â†’</div>
                </div>

                <div class="setting-item" onclick="confirmDeleteAccount()">
                    <div class="setting-icon"></div>
                    <div class="setting-content">
                        <div class="setting-title" style="color: #dc3545;">Delete Account</div>
                        <div class="setting-description">Permanently delete your account and data</div>
                    </div>
                    <div class="setting-arrow">â†’</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Coach Detail Modal -->
<div class="coach-detail-modal" id="coachDetailModal">
    <div class="coach-detail-content">
        <div class="coach-detail-header">
            <button class="coach-detail-close" onclick="closeCoachDetailModal()">Ã—</button>
            <div class="coach-detail-avatar-large" id="modal-coach-avatar">C</div>
            <h2 id="modal-coach-name">Coach Name</h2>
            <div class="status-badge" id="modal-coach-status">Verified</div>
        </div>
        
        <div class="coach-detail-body">
            <div class="coach-info-row">
                <div class="coach-info-label">Member Since:</div>
                <div class="coach-info-value" id="modal-coach-joined">Loading...</div>
            </div>
            
            <div class="coach-info-row">
                <div class="coach-info-label">Organization:</div>
                <div class="coach-info-value" id="modal-coach-organization">Loading...</div>
            </div>
            
            <div class="coach-info-row">
                <div class="coach-info-label">Email:</div>
                <div class="coach-info-value" id="modal-coach-email">Loading...</div>
            </div>
            
            <div class="coach-info-row" id="modal-coach-age-row" style="display: none;">
                <div class="coach-info-label">Age:</div>
                <div class="coach-info-value" id="modal-coach-age">N/A</div>
            </div>
        </div>

        <div class="coach-verification-notice">
            <h3>ðŸ›¡ï¸ Verified Coach</h3>
            <p>This coach has completed our verification process:</p>
            <ul>
                <li>âœ… Government-issued ID verified</li>
                <li>âœ… Age verification</li>
                <li>âœ… Name Verified</li>
            </ul>
        </div>
    </div>
</div>


    <!-- Students Section -->
<div id="students-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2>ðŸ“š OUR STUDENTS</h2>
            <p style="color: #666; margin-top: 10px;">Meet our dedicated learners from around the world</p>
        </div>
        
        <div id="students-container" class="loading">
            Loading students...
        </div>
    </div>
</div>

<!-- Student Detail Modal -->
<div class="coach-detail-modal" id="studentDetailModal">
    <div class="coach-detail-content">
        <div class="coach-detail-header">
            <button class="coach-detail-close" onclick="closeStudentDetailModal()">Ã—</button>
            <div class="coach-detail-avatar-large" id="modal-student-avatar">S</div>
            <h2 id="modal-student-name">Student Name</h2>
            <div class="status-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;" id="modal-student-id">WB-2025-XXXX</div>
        </div>
        
        <div class="coach-detail-body">
            <div class="coach-info-row">
                <div class="coach-info-label">ðŸ†” Student ID:</div>
                <div class="coach-info-value" id="modal-student-id-display">WB-2025-XXXX</div>
            </div>
            
            <div class="coach-info-row">
                <div class="coach-info-label">ðŸ“§ Email:</div>
                <div class="coach-info-value" id="modal-student-email">Loading...</div>
            </div>
            
            <div class="coach-info-row" id="modal-student-age-row">
                <div class="coach-info-label">ðŸŽ‚ Age:</div>
                <div class="coach-info-value" id="modal-student-age">N/A</div>
            </div>
            
            <div class="coach-info-row">
                <div class="coach-info-label">ðŸŒ Country:</div>
                <div class="coach-info-value" id="modal-student-country">Loading...</div>
            </div>
            
            <div class="coach-info-row">
                <div class="coach-info-label">ðŸ“… Member Since:</div>
                <div class="coach-info-value" id="modal-student-joined">Loading...</div>
            </div>
        </div>

        <div class="coach-verification-notice" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-left-color: #667eea;">
            <h3 style="color: white;">ðŸ“š Active Learner</h3>
            <p style="color: rgba(255,255,255,0.95);">This student is actively improving their vocabulary skills through:</p>
            <ul style="color: rgba(255,255,255,0.95);">
                <li>âœ… Interactive quizzes and practice tests</li>
                <li>âœ… Spelling challenges and word games</li>
                <li>âœ… Building vocabulary across multiple levels</li>
            </ul>
        </div>
    </div>
</div>


<!-- Quiz Leaderboard Player Detail Modal -->
<div class="coach-detail-modal" id="quizLeaderboardPlayerModal">
    <div class="coach-detail-content">
        <div class="coach-detail-header">
            <button class="coach-detail-close" onclick="closeQuizLeaderboardPlayerModal()">Ã—</button>
            <div class="coach-detail-avatar-large" id="modal-quiz-leaderboard-avatar">P</div>
            <h2 id="modal-quiz-leaderboard-name">Player Name</h2>
            <div class="status-badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;" id="modal-quiz-leaderboard-rank">ðŸ¥‡ Rank #1</div>
        </div>
        
        <div class="coach-detail-body">
            <div class="coach-info-row">
                <div class="coach-info-label">ðŸ†” Student ID:</div>
                <div class="coach-info-value" id="modal-quiz-leaderboard-id">WB-2025-XXXX</div>
            </div>
            
            <div class="coach-info-row" id="modal-quiz-leaderboard-id-row">
                <div class="coach-info-label">ðŸ“§ Email:</div>
                <div class="coach-info-value" id="modal-quiz-leaderboard-email">Loading...</div>
            </div>
            
            <div class="coach-info-row">
                <div class="coach-info-label">ðŸŒ Country:</div>
                <div class="coach-info-value" id="modal-quiz-leaderboard-country">Loading...</div>
            </div>
            
            <div class="coach-info-row" id="modal-quiz-leaderboard-age-row">
                <div class="coach-info-label">ðŸŽ‚ Age:</div>
                <div class="coach-info-value" id="modal-quiz-leaderboard-age">N/A</div>
            </div>
            
            <div class="coach-info-row">
                <div class="coach-info-label">ðŸ“… Member Since:</div>
                <div class="coach-info-value" id="modal-quiz-leaderboard-joined">Loading...</div>
            </div>
        </div>

        <div class="coach-verification-notice" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-left-color: #667eea;">
            <h3 style="color: white;">ðŸ“Š Quiz Statistics</h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 5px;">ðŸ† Wins</p>
                    <p style="color: white; font-size: 2rem; font-weight: bold; margin: 0;" id="modal-quiz-leaderboard-wins">0</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 5px;">âŒ Losses</p>
                    <p style="color: white; font-size: 2rem; font-weight: bold; margin: 0;" id="modal-quiz-leaderboard-losses">0</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 5px;">ðŸ“Š Total Games</p>
                    <p style="color: white; font-size: 2rem; font-weight: bold; margin: 0;" id="modal-quiz-leaderboard-total">0</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 5px;">ðŸ“ˆ Win Rate</p>
                    <p style="color: white; font-size: 2rem; font-weight: bold; margin: 0;" id="modal-quiz-leaderboard-winrate">0%</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 5px;">ðŸ”¥ Current Streak</p>
                    <p style="color: white; font-size: 2rem; font-weight: bold; margin: 0;" id="modal-quiz-leaderboard-streak">0</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center;">
                    <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin-bottom: 5px;">â­ Best Streak</p>
                    <p style="color: white; font-size: 2rem; font-weight: bold; margin: 0;" id="modal-quiz-leaderboard-best">0</p>
                </div>
            </div>
        </div>
    </div>
</div>    

    <!-- About Us Section -->
<div id="about-section" class="content-section">
    <div class="word-database">
        <div style="text-align: center; margin-bottom: 50px;">
            <img src="https://res.cloudinary.com/dqqr9udcs/image/upload/v1760911020/preview_2_u1bya5.webp" alt="WordBiz Logo" style="max-width: 150px; height: auto; margin: 0 auto 20px auto; display: block;">
            <h1 style="color: #0d3b66; font-size: 2.5rem; margin-bottom: 15px;">About WordBiz Coaching Academy</h1>
            <p style="color: #666; font-size: 1.3rem; max-width: 800px; margin: 0 auto; line-height: 1.8;">
                We help children master over <strong>15,000 English words</strong> through AI-powered tools, 
                interactive games, and personalized coaching. Learning vocabulary has never been this engaging.
            </p>
        </div>

        <!-- What We Offer -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 50px;">
            <!-- Card 1 -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 35px; border-radius: 15px; text-align: center; color: white;">
                <div style="font-size: 3.5rem; margin-bottom: 15px;">ðŸŽ¯</div>
                <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: white;">Interactive Quizzes</h3>
                <p style="line-height: 1.6; opacity: 0.95;">
                    Test your knowledge with multiple-choice questions, track your progress, and challenge yourself across 4 difficulty levels.
                </p>
            </div>

            <!-- Card 2 -->
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 35px; border-radius: 15px; text-align: center; color: white;">
                <div style="font-size: 3.5rem; margin-bottom: 15px;">ðŸ”¤</div>
                <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: white;">Spelling Practice</h3>
                <p style="line-height: 1.6; opacity: 0.95;">
                    Listen, spell, and learn with our virtual keyboard. Unscramble words and master pronunciation with AI voice technology.
                </p>
            </div>

            <!-- Card 3 -->
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 35px; border-radius: 15px; text-align: center; color: white;">
                <div style="font-size: 3.5rem; margin-bottom: 15px;">ðŸ“š</div>
                <h3 style="font-size: 1.5rem; margin-bottom: 15px; color: white;">15,000+ Words</h3>
                <p style="line-height: 1.6; opacity: 0.95;">
                    Access a massive database with AI-generated definitions, origins, synonyms, antonyms, and example sentences for every word.
                </p>
            </div>
        </div>

        <!-- Why WordBiz -->
        <div style="background: white; padding: 50px 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); margin-bottom: 50px;">
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 30px; text-align: center;">Why WordBiz?</h2>
            
            <div style="max-width: 900px; margin: 0 auto;">
                <div style="display: flex; align-items: start; margin-bottom: 25px; gap: 15px;">
                    <div style="font-size: 2rem; min-width: 50px;">âœ¨</div>
                    <div>
                        <h3 style="color: #0d3b66; font-size: 1.3rem; margin-bottom: 8px;">Learn at Your Own Pace</h3>
                        <p style="color: #666; line-height: 1.6;">Progress through Foundation, Challenge, Advanced, and Championship levels. No pressure, no deadlinesâ€”just steady improvement.</p>
                    </div>
                </div>

                <div style="display: flex; align-items: start; margin-bottom: 25px; gap: 15px;">
                    <div style="font-size: 2rem; min-width: 50px;">ðŸŽ®</div>
                    <div>
                        <h3 style="color: #0d3b66; font-size: 1.3rem; margin-bottom: 8px;">Make Learning Fun</h3>
                        <p style="color: #666; line-height: 1.6;">No boring textbooks. Play games, compete in challenges, and earn IQ scores that show your vocabulary mastery.</p>
                    </div>
                </div>

                <div style="display: flex; align-items: start; margin-bottom: 25px; gap: 15px;">
                    <div style="font-size: 2rem; min-width: 50px;">ðŸŒ</div>
                    <div>
                        <h3 style="color: #0d3b66; font-size: 1.3rem; margin-bottom: 8px;">Global Community</h3>
                        <p style="color: #666; line-height: 1.6;">Join students and coaches from around the world. Learn together, compete together, grow together.</p>
                    </div>
                </div>

                <div style="display: flex; align-items: start; gap: 15px;">
                    <div style="font-size: 2rem; min-width: 50px;">ðŸš€</div>
                    <div>
                        <h3 style="color: #0d3b66; font-size: 1.3rem; margin-bottom: 8px;">Track Your Growth</h3>
                        <p style="color: #666; line-height: 1.6;">Save favorite words, review mistakes, and watch your vocabulary expand. Every practice session makes you stronger.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Call to Action -->
        <div style="background: linear-gradient(135deg, #0d3b66 0%, #1a5490 100%); padding: 50px 30px; border-radius: 15px; text-align: center; color: white;">
            <h2 style="font-size: 2.2rem; margin-bottom: 20px; color: white;">Ready to Master 15,000 Words?</h2>
            <p style="font-size: 1.2rem; margin-bottom: 30px; opacity: 0.95; max-width: 700px; margin-left: auto; margin-right: auto; line-height: 1.7;">
                Whether you're 5 or 50, WordBiz Coaching Academy makes vocabulary building engaging, effective, and fun. 
                Start your journey today.
            </p>
        </div>
    </div>
</div>

   <!-- Custom Popup -->
<div class="custom-popup" id="customPopup"></div>

            


    <!-- Subscription Modal (Cannot be closed) -->
<div class="auth-modal" id="subscriptionModal" style="z-index: 9999;">
    <div class="auth-content" style="max-width: 500px;">
        <div class="auth-header" style="background: linear-gradient(135deg, #FFD700, #FFA500);">
            <h2 style="color: #0d3b66;">ðŸª™ SUBSCRIPTION REQUIRED</h2>
        </div>
        <div class="auth-body" style="text-align: center;">
            <div style="font-size: 3rem; margin: 20px 0;">ðŸ”’</div>
            <h3 style="color: #0d3b66; margin-bottom: 15px;">Your subscription has ended</h3>
            <p style="color: #666; margin: 15px 0; line-height: 1.6;">
                 Please redeem your coins to continue learning at WordBiz Academy, if you have an insufficent amount of coins please allow a parent to sign up for a PARENTS PROFILE and pay a fee of $1,000 JMD so you can regain access.
            </p>
            
            <!-- Student ID Display -->
            <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 10px;">
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 5px;">ðŸ†” Your Student ID</p>
                <p style="font-family: monospace; font-size: 1.3rem; font-weight: bold; color: #0d3b66;" id="sub-modal-student-id">Loading...</p>
            </div>
            
            <!-- Coins Display -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <p style="font-size: 1.2rem; color: #666; margin-bottom: 10px;">Your Coins</p>
                <p style="font-size: 3rem; font-weight: bold; color: #0d3b66; margin: 10px 0;" id="sub-modal-coins">0</p>
                <p style="font-size: 0.9rem; color: #999; margin-top: 5px;">/ 1000 max</p>
            </div>
            
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin: 20px 0; color: white;">
                <h3 style="margin: 0 0 10px 0; color: white;">ðŸ’Ž Monthly Subscription</h3>
                <p style="font-size: 2.5rem; font-weight: bold; margin: 10px 0;">300 Coins</p>
                <p style="font-size: 0.9rem; opacity: 0.9; margin: 5px 0;">= 30 Days Full Access</p>
            </div>
            
            <div id="sub-modal-insufficient" style="display: none; background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
                <p style="color: #856404; margin: 0;">
                    âš ï¸ You need <strong><span id="coins-needed">300</span> more coins</strong> to subscribe.<br>
                    Your account is currently locked.
                </p>
            </div>
            
            <div id="sub-modal-buttons">
                <button class="auth-submit" id="redeem-sub-btn" onclick="redeemSubscription()" style="background: #28a745; margin-bottom: 10px;">
                    âœ… Redeem 300 Coins for 30 Days
                </button>
                
                <button class="auth-submit" onclick="signOutFromSubscription()" 
                        style="background: #dc3545;">
                    ðŸšª Sign Out
                </button>
            </div>
            
            <div id="sub-modal-success" style="display: none;">
                <div style="font-size: 3rem; margin: 20px 0;">ðŸŽ‰</div>
                <h3 style="color: #28a745; margin-bottom: 15px;">Subscription Activated!</h3>
                <p style="color: #666; margin: 15px 0;">
                    You now have 30 days of full access to WordBiz Academy!
                </p>
                <button class="auth-submit" onclick="closeSubscriptionModal()" style="background: #28a745;">
                    âœ… Continue Learning
                </button>
            </div>
            
            <div id="sub-modal-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>
</div>
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // âœ… NEW: Track declined challenges
let presenceInitialized = false; // âœ… NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// âœ… Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;
      
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // âœ… Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // âœ… ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // Ã¢Å“â€¦ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });
    
   auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            
            console.log('ðŸ‘¤ User signed in:', user.email);
            console.log('ðŸ–¼ï¸ Auth photoURL:', user.photoURL);
            
            const userRef = db.collection('users').doc(user.uid);
            const userDoc = await userRef.get();
            
            if (!userDoc.exists) {
                await auth.signOut();
                alert('Account error. Please sign up again.');
                return;
            }
            
            const userData = userDoc.data();
            console.log('ðŸ“„ Firestore photoURL:', userData.photoURL);
            
            if (user.photoURL && !userData.photoURL) {
                console.log('ðŸ”„ Syncing photoURL to Firestore...');
                await userRef.update({
                    photoURL: user.photoURL
                });
                console.log('âœ… PhotoURL synced!');
            }
            
            // âœ… INITIALIZE SPELLING STATS IF NOT EXISTS
            if (!userData.spellingStats) {
                console.log('ðŸ”„ Initializing spelling stats...');
                await userRef.update({
                    spellingStats: {
                        totalChallenges: 0,
                        wins: 0,
                        losses: 0,
                        totalScore: 0,
                        winStreak: 0,
                        bestStreak: 0
                    }
                });
                console.log('âœ… Spelling stats initialized!');
            }
            
            if (!userData.profileComplete) {
                showVerificationModal(userData);
                return;
            }
            
            updateUIForAuthenticatedUser(user);
            
            // âœ… LOAD USER COINS
            await loadUserCoins(user.uid);
            
            // âœ… CHECK SUBSCRIPTION STATUS
            await checkSubscriptionStatus();
            
            await cleanupInvalidFavorites();
            
            await Promise.all([
                loadUserFavorites(user.uid),
                loadUserIncorrect(user.uid),
                loadUserSpellingFavorites(user.uid),
                loadUserSpellingIncorrect(user.uid)
            ]);
            
            // âœ… Initialize presence immediately on login
            await initializeOnlinePresence();
            
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        } else {
            currentUser = null;
            updateUIForGuestUser();
        }
      });
    });
        
        
     // ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // âœ… CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // âœ… ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // âœ… Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // âœ… RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // âœ… Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // âœ… Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // Load dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }
}

        
        
       function toggleSidebar(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (forceClose) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }

        // ===== INITIALIZE ALPHABET =====
        function initializeAlphabet() {
            const alphabetNav = document.getElementById('alphabetNav');
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            
            letters.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = letter;
                btn.onclick = () => filterByLetter(letter);
                alphabetNav.appendChild(btn);
            });
        }

        
// New function to load level-specific words
async function loadLevelWords(level) {
    try {
        document.getElementById('statusMessage').innerHTML = 
            `â³ Loading ${level.toUpperCase()} level words... Please wait.`;
        
        // Check if already loaded
        if (levelWords[level].length > 0) {
            allWords = levelWords[level];
            document.getElementById('statusMessage').innerHTML = 
                `âœ… ${allWords.length.toLocaleString()} ${level.toUpperCase()} words loaded! Select a letter to filter or search for specific words.`;
            return Promise.resolve();
        }
        
        const googleDocsUrl = LEVEL_DOCS[level];
        const response = await fetch(googleDocsUrl);

        if (!response.ok) throw new Error('Failed to load words');
        
        const text = await response.text();
        const words = text.split(/[\n\r\s,]+/)
            .map(word => word.trim().toLowerCase())
            .filter(word => word.length > 0 && /^[a-z]+$/.test(word))
            .sort(); // Sort alphabetically
        
        // Cache the words
        levelWords[level] = words;
        allWords = words;
        
        console.log(`Loaded ${words.length} ${level} words`);
        
        document.getElementById('statusMessage').innerHTML = 
            `âœ… ${words.length.toLocaleString()} ${level.toUpperCase()} words loaded! Select a letter to filter or search for specific words.`;
        
        return Promise.resolve();
    } catch (error) {
        console.error(`Error loading ${level} words:`, error);
        document.getElementById('statusMessage').innerHTML = 
            `âŒ Error loading ${level} words. Please try again.`;
        return Promise.reject(error);
    }
}

        // Load a specific level
async function loadLevel(level) {
    currentLevel = level;
    
    // Hide level selection
    document.getElementById('level-selection').style.display = 'none';
    document.getElementById('word-database-display').style.display = 'block';
    
    // Update title
    const levelNames = {
        foundation: 'LEVEL 1: FOUNDATION',
        challenge: 'LEVEL 2: CHALLENGE',
        advanced: 'LEVEL 3: ADVANCED',
        championship: 'LEVEL 4: CHAMPIONSHIP'
    };
    document.getElementById('current-level-title').textContent = `ðŸ“š ${levelNames[level]}`;
    
    // Load words for this level
    await loadLevelWords(level);
    
    // Display first 100 words
    displayWords(allWords.slice(0, 100));
}

// Back to level selection
function backToLevelSelection() {
    document.getElementById('level-selection').style.display = 'block';
    document.getElementById('word-database-display').style.display = 'none';
    document.getElementById('wordList').innerHTML = '<div class="loading">Select a level to load words</div>';
    
    // Clear active letter
    document.querySelectorAll('.letter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    currentLetter = '';
}

        
        // ===== FILTER BY LETTER =====
        function filterByLetter(letter) {
            currentLetter = letter;
            
            document.querySelectorAll('.letter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === letter) {
                    btn.classList.add('active');
                }
            });

            const filteredWords = allWords.filter(word => 
                word.toLowerCase().startsWith(letter.toLowerCase())
            );

            displayWords(filteredWords);
        }

         // ===== SEARCH WORD =====
        function searchWord() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                alert('Please enter a word to search');
                return;
            }

            const exactMatch = allWords.find(word => word.toLowerCase() === searchTerm);
            
            if (exactMatch) {
                showWordDetail(exactMatch);
            } else {
                const partialMatches = allWords.filter(word => 
                    word.toLowerCase().includes(searchTerm)
                );

                if (partialMatches.length > 0) {
                    displayWords(partialMatches);
                } else {
                    alert(`No words found matching "${searchTerm}"`);
                }
            }
        }

        // ===== DISPLAY WORDS =====
function displayWords(words) {
    const wordList = document.getElementById('wordList');
    
    if (words.length === 0) {
        wordList.innerHTML = '<div class="loading">No words found</div>';
        return;
    }

    wordList.innerHTML = words.map(word => `
        <div class="word-card" onclick="loadPhoneticAndShowDetail('${word}', this)">
            <div class="word-title">
                <span>${word}</span>
                <div class="word-actions">
                    <button class="icon-btn" onclick="event.stopPropagation(); speakWordQuick('${word}')">ðŸ”Š</button>
                </div>
            </div>
            <div class="word-phonetic-preview" data-word="${word}"></div>
            <div class="word-definition">Click to see AI-powered definition with synonyms & antonyms</div>
        </div>
    `).join('');

    // After rendering, load phonetics for all visible words
    setTimeout(() => loadPhoneticForVisibleWords(), 100);
}
        
       async function loadPhoneticAndShowDetail(word, cardElement) {
    const phoneticDiv = cardElement.querySelector('.word-phonetic-preview');
    
    // Check if phonetic is already loaded and cached
    if (phoneticDiv.textContent && phoneticDiv.textContent !== '' && phoneticDiv.textContent !== 'Loading pronunciation...') {
        // Already loaded from cache, just show the detail
        showWordDetail(word);
        return;
    }
    
    // Show loading state
    phoneticDiv.textContent = 'Loading pronunciation...';
    phoneticDiv.style.color = '#999';
    
    try {
        // Check Firestore cache first
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let phonetic = '';
        
        if (wordDoc.exists && wordDoc.data().phonetic) {
            phonetic = wordDoc.data().phonetic;
        } else {
            // Fetch from API
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: word } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.phonetic) {
                    phonetic = data.result.phonetic;
                }
            }
        }
        
        // Update the phonetic display
       if (phonetic) {
    // Replace slashes with brackets
    const formattedPhonetic = phonetic.replace(/\//g, '');
    phoneticDiv.innerHTML = `<strong>(${formattedPhonetic})</strong>`;
    phoneticDiv.style.color = '#000';
}
        else {
            phoneticDiv.textContent = ''; // Hide if no phonetic available
        }
    } catch (error) {
        console.error('Error loading phonetic:', error);
        phoneticDiv.textContent = ''; // Hide on error
    }
    
    // Now show the full detail modal
    showWordDetail(word);
}

async function loadPhoneticForVisibleWords() {
    const phoneticDivs = document.querySelectorAll('.word-phonetic-preview');
    
    for (const phoneticDiv of phoneticDivs) {
        const word = phoneticDiv.getAttribute('data-word');
        
        // Skip if already loaded
        if (phoneticDiv.textContent && phoneticDiv.textContent !== '') {
            continue;
        }
        
        try {
            // Check Firestore cache
            const wordRef = db.collection('dictionary').doc(word.toLowerCase());
            const wordDoc = await wordRef.get();
            
            if (wordDoc.exists && wordDoc.data().phonetic) {
    // Found in cache - display immediately
    const formattedPhonetic = wordDoc.data().phonetic.replace(/\//g, '');
    phoneticDiv.innerHTML = `<strong>(${formattedPhonetic})</strong>`;
    phoneticDiv.style.color = '#000';
}
            // If not in cache, leave blank (will load when clicked)
        } catch (error) {
            console.error('Error loading phonetic for', word, error);
        }
    }
}
        
        // ===== SHOW WORD DETAIL (CALL CLOUD FUNCTION) =====
       async function showWordDetail(word) {
    currentWord = word;
    
    const modal = document.getElementById('wordModal');
    document.getElementById('modalWord').textContent = word;
    document.getElementById('modalPhonetic').textContent = 'Loading...';
    document.getElementById('modalContent').innerHTML = '<div class="loading">ðŸ“š Loading definition...</div>';
    
    modal.classList.add('active');

    try {
        // Step 1: Check if word exists in Firestore cache
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
       if (wordDoc.exists) {
    // Word found in cache - use it (NO API CALL = FREE!)
    console.log('âœ… Found in cache - no API call needed!');
    const cachedData = wordDoc.data();
    
    // Check if origin is missing and fetch it
    if (!cachedData.origin) {
        console.log('âš ï¸ Origin missing - fetching from API...');
        try {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: word } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.origin) {
                    // Update Firestore with origin
                    await wordRef.update({
                        origin: data.result.origin
                    });
                    cachedData.origin = data.result.origin;
                    console.log('âœ… Origin fetched and saved!');
                }
            }
        } catch (error) {
            console.error('Error fetching origin:', error);
        }
    }
    
    displayWordDetails(cachedData);
}
       else {
            // Step 2: Word NOT in cache - fetch from API (COSTS MONEY)
            console.log('âš ï¸ Not in cache - calling paid API...');
            console.log('API URL:', CLOUD_FUNCTION_URL);
            console.log('Request payload:', { data: { word: word } });
            
            document.getElementById('modalContent').innerHTML = '<div class="loading">ðŸ¤– Fetching from paid API (first time)...</div>';
            
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ data: { word: word } })
            });

            console.log('Response Status:', response.status);
            console.log('Response OK:', response.ok);
            console.log('Response Headers:', [...response.headers.entries()]);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error Response Body:', errorText);
                throw new Error(`API Error (${response.status}): ${errorText || response.statusText}`);
            }

            const data = await response.json();
            console.log('Response Data:', data);
            
            if (data.result) {
                // Step 3: Store in Firestore for future use
                await wordRef.set({
                    ...data.result,
                    word: word.toLowerCase(),
                    cachedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('âœ… Saved to Firestore cache!');
                
                displayWordDetails(data.result);
            } else {
                throw new Error('No definition found in API response');
            }
        }
    } catch (error) {
        console.error('âŒ FULL ERROR:', error);
        console.error('Error Type:', error.constructor.name);
        console.error('Error Stack:', error.stack);
        
        let errorDetails = '';
        
        // Detailed error categorization
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
            errorDetails = `
                <strong>ðŸ”´ Network/CORS Error:</strong><br><br>
                <strong>Possible causes:</strong><br>
                1. Cloud Function not deployed or not accessible<br>
                2. CORS not configured on Cloud Function<br>
                3. Function URL incorrect<br>
                4. Network connectivity issue<br><br>
                
                <strong>Your Function URL:</strong><br>
                <code style="background: #f0f0f0; padding: 5px; display: block; word-break: break-all;">
                    ${CLOUD_FUNCTION_URL}
                </code><br>
                
                <strong>To fix:</strong><br>
                â€¢ Go to Google Cloud Console<br>
                â€¢ Find your Cloud Function<br>
                â€¢ Add CORS headers in your function code:<br>
                <code style="background: #f0f0f0; padding: 10px; display: block; margin-top: 5px;">
                res.set('Access-Control-Allow-Origin', '*');<br>
                res.set('Access-Control-Allow-Methods', 'POST');<br>
                res.set('Access-Control-Allow-Headers', 'Content-Type');
                </code>
            `;
        } else if (error.message.includes('API Error')) {
            errorDetails = `
                <strong>ðŸ”´ API Response Error:</strong><br><br>
                ${error.message}<br><br>
                <strong>What this means:</strong><br>
                The Cloud Function responded but with an error status.<br>
                Check the Cloud Function logs in Google Cloud Console.
            `;
        } else if (error.message.includes('No definition found')) {
            errorDetails = `
                <strong>ðŸ”´ Definition Not Available:</strong><br><br>
                The API returned successfully but didn't include a definition.<br>
                The word "${word}" might not be in the dictionary API.
            `;
        } else {
            errorDetails = `
                <strong>ðŸ”´ Unexpected Error:</strong><br><br>
                <strong>Error Message:</strong><br>
                ${error.message}<br><br>
                <strong>Error Type:</strong> ${error.constructor.name}
            `;
        }
        
        document.getElementById('modalContent').innerHTML = `
            <div class="word-definition">
                <strong>Word:</strong> ${word}<br><br>
                âŒ <strong>Unable to fetch definition</strong><br><br>
                ${errorDetails}<br><br>
                <details style="margin-top: 20px; background: #f9f9f9; padding: 10px; border-radius: 5px;">
                    <summary style="cursor: pointer; font-weight: bold;">ðŸ”§ Technical Details (for debugging)</summary>
                    <pre style="overflow-x: auto; font-size: 0.85rem; margin-top: 10px;">${JSON.stringify({
                        errorMessage: error.message,
                        errorType: error.constructor.name,
                        stack: error.stack
                    }, null, 2)}</pre>
                </details>
                <hr style="margin: 20px 0; border: 1px solid #ddd;">
                You can still practice pronunciation using the buttons below.
            </div>
        `;
        document.getElementById('modalPhonetic').textContent = '';
    }
}

function displayWordDetails(wordData) {
    const phonetic = wordData.phonetic || '';
    document.getElementById('modalPhonetic').textContent = phonetic;

    let html = '';

    // âœ… SHOW SIMPLE ORIGIN
    if (wordData.origin) {
        const simpleOrigin = cleanOriginText(wordData.origin);
        
        html += `
            <div style="margin-bottom: 25px; padding: 12px 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                <strong style="color: #856404; font-size: 1rem;">ðŸ“œ Origin:</strong>
                <span style="color: #856404; margin-left: 10px; font-size: 1rem;">${simpleOrigin}</span>
            </div>
        `;
    }

    // Rest of the function stays the same...
    if (wordData.meanings && wordData.meanings.length > 0) {
        wordData.meanings.forEach((meaning, index) => {
            html += `
                <div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <span class="word-pos">${meaning.partOfSpeech}</span>
                    
                    <div class="word-definition" style="margin-top: 15px;">
                        <strong>Definition:</strong> ${meaning.definition}
                    </div>
            `;

            if (meaning.example) {
                html += `
                    <div class="word-example">
                        <strong>Example:</strong> "${meaning.example}"
                    </div>
                `;
            }

            if (meaning.synonyms && meaning.synonyms.length > 0) {
                html += `
                    <div style="margin-top: 15px;">
                        <strong style="color: #0d3b66;">ðŸ“š Synonyms:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${meaning.synonyms.map(syn => `
                                <span style="background: #e3f2fd; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem;">
                                    ${syn}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (meaning.antonyms && meaning.antonyms.length > 0) {
                html += `
                    <div style="margin-top: 15px;">
                        <strong style="color: #0d3b66;">ðŸ”„ Antonyms:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${meaning.antonyms.map(ant => `
                                <span style="background: #ffebee; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem;">
                                    ${ant}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
        });
    } else {
        html = `
            <div class="word-definition">
                <strong>Word:</strong> ${currentWord}<br><br>
                Loading definition...<br>
                You can practice pronunciation using the buttons below.
            </div>
        `;
    }

    document.getElementById('modalContent').innerHTML = html;
}

        // Helper function to clean and shorten origin text
function cleanOriginText(origin) {
    if (!origin) return '';
    
    let cleaned = origin.toLowerCase();
    
    // Extract common language origins
    const languagePatterns = [
        /\b(old english|middle english|modern english|english)\b/i,
        /\b(latin|classical latin|late latin|medieval latin)\b/i,
        /\b(greek|ancient greek|classical greek)\b/i,
        /\b(french|old french|middle french|anglo-french)\b/i,
        /\b(german|old german|middle high german)\b/i,
        /\b(spanish|old spanish)\b/i,
        /\b(italian)\b/i,
        /\b(dutch|old dutch)\b/i,
        /\b(norse|old norse)\b/i,
        /\b(sanskrit)\b/i,
        /\b(hebrew|ancient hebrew)\b/i,
        /\b(arabic|classical arabic)\b/i,
        /\b(persian)\b/i,
        /\b(chinese|mandarin)\b/i,
        /\b(japanese)\b/i,
        /\b(portuguese)\b/i,
        /\b(russian)\b/i,
        /\b(celtic|gaelic|irish)\b/i,
        /\b(proto-germanic|proto-indo-european)\b/i
    ];
    
    // Try to find a language match
    for (let pattern of languagePatterns) {
        const match = cleaned.match(pattern);
        if (match) {
            // Capitalize first letter of each word
            return match[0].split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
    }
    
    // If no specific language found, extract first few words before comma or period
    const shortOrigin = origin.split(/[,.(]/)[0].trim();
    if (shortOrigin.length < 50) {
        return shortOrigin.charAt(0).toUpperCase() + shortOrigin.slice(1);
    }
    
    // Fallback: return first 30 characters
    return origin.substring(0, 30).trim() + '...';
}

        
// â­ NEW HELPER FUNCTION - Fetch word details with origin
async function fetchWordDetails(word) {
    try {
        // Check Firestore cache first
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();

        if (wordDoc.exists) {
            const data = wordDoc.data();
            
            // Clean the origin if it exists and is too long
            let cleanedOrigin = data.origin;
            if (cleanedOrigin && cleanedOrigin.length > 150) {
                cleanedOrigin = cleanOriginText(cleanedOrigin);
                
                // Update Firestore with cleaned origin
                await wordRef.update({ origin: cleanedOrigin });
            }
            
            return {
                phonetic: data.phonetic || '',
                origin: cleanedOrigin || null,
                definition: data.meanings?.[0]?.definition || ''
            };
        }

        // If not in cache, fetch from Cloud Run
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { word: word } })
        });

        if (!response.ok) {
            throw new Error('Failed to fetch word details');
        }

        const data = await response.json();
        
        if (data.result) {
            // Clean the origin before caching
            let cleanedOrigin = data.result.origin;
            if (cleanedOrigin) {
                cleanedOrigin = cleanOriginText(cleanedOrigin);
            }
            
            // Cache it with cleaned origin
            await wordRef.set({
                ...data.result,
                origin: cleanedOrigin,
                word: word.toLowerCase(),
                cachedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            return {
                phonetic: data.result.phonetic || '',
                origin: cleanedOrigin || null,
                definition: data.result.meanings?.[0]?.definition || ''
            };
        }

        return {};
    } catch (error) {
        console.error('Error fetching word details:', error);
        return {};
    }
}
        

        // ===== CLOSE MODAL =====
        function closeModal() {
            document.getElementById('wordModal').classList.remove('active');
            document.getElementById('practiceFeedback').innerHTML = '';
        }

        // ===== TEXT-TO-SPEECH =====
        function speakWord() {
            if (!currentWord) return;
            
            const utterance = new SpeechSynthesisUtterance(currentWord);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 2;
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        function speakWordQuick(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        // ===== SPEECH RECOGNITION =====
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    checkPronunciation(transcript);
                };

                recognition.onerror = function(event) {
                    isListening = false;
                    document.getElementById('practiceBtn').classList.remove('listening');
                    document.getElementById('practiceFeedback').innerHTML = `
                        <div class="feedback error">
                            âŒ Error: ${event.error}. Please try again.
                        </div>
                    `;
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('practiceBtn').classList.remove('listening');
                    document.getElementById('practiceBtn').textContent = 'ðŸŽ¤ Practice Speaking';
                };
            }
        }

        // ===== START PRACTICE =====
        function startPractice() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            if (isListening) {
                recognition.stop();
                return;
            }

            isListening = true;
            document.getElementById('practiceBtn').classList.add('listening');
            document.getElementById('practiceBtn').textContent = 'ðŸŽ¤ Listening...';
            document.getElementById('practiceFeedback').innerHTML = '<div class="feedback">Speak now...</div>';

            try {
                recognition.start();
            } catch (error) {
                console.error('Recognition start error:', error);
                isListening = false;
                document.getElementById('practiceBtn').classList.remove('listening');
            }
        }

        // ===== CHECK PRONUNCIATION =====
        function checkPronunciation(spokenWord) {
            const correctWord = currentWord.toLowerCase();
            const feedbackDiv = document.getElementById('practiceFeedback');
            
            const cleanSpoken = spokenWord.replace(/[^\w\s]/gi, '').trim();
            const cleanCorrect = correctWord.replace(/[^\w\s]/gi, '').trim();

            if (cleanSpoken === cleanCorrect) {
                feedbackDiv.innerHTML = `
                    <div class="feedback success">
                        âœ… Perfect! You said: "${spokenWord}"<br>
                        Accuracy: 100%
                    </div>
                `;
                return;
            }

            const similarity = calculateSimilarity(cleanSpoken, cleanCorrect);
            
            if (similarity > 0.6) {
                feedbackDiv.innerHTML = `
                    <div class="feedback success">
                        âœ… Good effort! You said: "${spokenWord}"<br>
                        Expected: "${correctWord}"<br>
                        Accuracy: ${Math.round(similarity * 100)}%
                    </div>
                `;
            } else {
                feedbackDiv.innerHTML = `
                    <div class="feedback error">
                        âŒ Not quite. You said: "${spokenWord}"<br>
                        Expected: "${correctWord}"<br>
                        Try again!
                    </div>
                `;
            }
        }

        // ===== CALCULATE SIMILARITY =====
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = getEditDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function getEditDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

       // ===== AUTHENTICATION FUNCTIONS =====
function showAuthModal() {
    document.getElementById('authModal').classList.add('active');
}

function closeAuthModal() {
    document.getElementById('authModal').classList.remove('active');
    document.getElementById('signin-error').style.display = 'none';
    
    // Hide all signup forms and show selection
    document.getElementById('signup-selection').style.display = 'none';
    document.getElementById('signup-student-form').style.display = 'none';
    document.getElementById('signup-coach-form').style.display = 'none';
    document.getElementById('signup-organization-form').style.display = 'none';
    
    // Clear all error messages
    document.querySelectorAll('.feedback.error').forEach(el => el.style.display = 'none');
}

function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => {
        f.classList.remove('active');
        f.style.display = 'none'; // Force hide all forms
    });
    
    if (tab === 'signin') {
        document.querySelector('.auth-tab:first-child').classList.add('active');
        document.getElementById('signin-form').classList.add('active');
        document.getElementById('signin-form').style.display = 'block';
        
        // Hide all signup forms
        document.getElementById('signup-selection').style.display = 'none';
        document.getElementById('signup-student-form').style.display = 'none';
        document.getElementById('signup-coach-form').style.display = 'none';
        document.getElementById('signup-organization-form').style.display = 'none';
    } else {
        document.querySelector('.auth-tab:last-child').classList.add('active');
        document.getElementById('signup-selection').classList.add('active');
        document.getElementById('signup-selection').style.display = 'block';
        
        // Hide signin form
        document.getElementById('signin-form').style.display = 'none';
    }
}

function showSignUpForm(userType) {
    // Hide selection screen
    document.getElementById('signup-selection').style.display = 'none';
    
    // Show appropriate form
    if (userType === 'student') {
        document.getElementById('signup-student-form').style.display = 'block';
    } else if (userType === 'parent') {
        document.getElementById('signup-parent-form').style.display = 'block';
    } else if (userType === 'coach') {
        document.getElementById('signup-coach-form').style.display = 'block';
    } else if (userType === 'organization') {
        document.getElementById('signup-organization-form').style.display = 'block';
    }
}

function backToUserTypeSelection() {
    // Hide all forms
    document.getElementById('signup-student-form').style.display = 'none';
    document.getElementById('signup-parent-form').style.display = 'none';
    document.getElementById('signup-coach-form').style.display = 'none';
    document.getElementById('signup-organization-form').style.display = 'none';
    
    // Show selection
    document.getElementById('signup-selection').style.display = 'block';
}
        
async function handleSignIn(event) {
    event.preventDefault();
    const email = document.getElementById('signin-email').value;
    const password = document.getElementById('signin-password').value;
    const errorDiv = document.getElementById('signin-error');

    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Check if user document exists in Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
            // User signed in but no profile exists - sign them out
            await auth.signOut();
            errorDiv.textContent = 'No account found with this email. Please sign up first.';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check if profile is complete
        const userData = userDoc.data();
        if (!userData.profileComplete) {
            // Show verification modal
            closeAuthModal();
            showVerificationModal(userData);
            return;
        }
        
        closeAuthModal();
        errorDiv.style.display = 'none';
    } catch (error) {
        if (error.code === 'auth/user-not-found') {
            errorDiv.textContent = 'No account found with this email. Please sign up first.';
        } else if (error.code === 'auth/wrong-password') {
            errorDiv.textContent = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
            errorDiv.textContent = 'Invalid email address.';
        } else {
            errorDiv.textContent = error.message;
        }
        errorDiv.style.display = 'block';
    }
}

async function handleSignUp(event, userType) {
    event.preventDefault();
    
    let name, email, password, errorDiv;
    let additionalData = { 
        userType: userType,
        profileComplete: false // Mark as incomplete
    };
    
    if (userType === 'student') {
        name = document.getElementById('signup-student-name').value;
        email = document.getElementById('signup-student-email').value;
        password = document.getElementById('signup-student-password').value;
        errorDiv = document.getElementById('signup-student-error');
        additionalData.age = document.getElementById('signup-student-age').value;
        additionalData.country = document.getElementById('signup-student-country').value;
        
        // For students, if they provided age and country, mark complete
        if (additionalData.age && additionalData.country) {
            additionalData.profileComplete = true;
        }
    } else if (userType === 'coach') {
        name = document.getElementById('signup-coach-name').value;
        email = document.getElementById('signup-coach-email').value;
        password = document.getElementById('signup-coach-password').value;
        errorDiv = document.getElementById('signup-coach-error');
        additionalData.organization = document.getElementById('signup-coach-organization').value;
        additionalData.profileComplete = true; // Coaches don't need extra verification
    } else if (userType === 'organization') {
        name = document.getElementById('signup-org-name').value;
        email = document.getElementById('signup-org-email').value;
        password = document.getElementById('signup-org-password').value;
        errorDiv = document.getElementById('signup-org-error');
        additionalData.phone = document.getElementById('signup-org-phone').value;
        additionalData.address = document.getElementById('signup-org-address').value;
        additionalData.profileComplete = true; // Organizations don't need extra verification
    }

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: name });
        
        // âœ… GENERATE STUDENT ID FOR STUDENTS
        if (userType === 'student') {
            additionalData.studentId = generateStudentId(userCredential.user.uid);
            console.log('âœ… Generated Student ID:', additionalData.studentId);
        }
        
        await db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            ...additionalData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        closeAuthModal();
        errorDiv.style.display = 'none';
        
        // If profile not complete, show verification modal
        if (!additionalData.profileComplete) {
            showVerificationModal({ name, email, userType });
        } else {
            if (userType === 'student') {
                alert(`Welcome, ${name}! Your student account has been created successfully.\n\nYour Student ID: ${additionalData.studentId}\n\nPlease save this ID - your parent will need it to link their account.`);
            } else {
                alert(`Welcome, ${name}! Your ${userType} account has been created successfully.`);
            }
        }
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}
        
function signOut() {
    // Remove online presence before signing out
    removeOnlinePresence();
    
    // âœ… CLEAR DECLINED CHALLENGES
    declinedChallengeIds.clear();
    shownPopupIds.clear();
    shownQuizPopupIds.clear();
    
    // Sign out from Firebase
    auth.signOut();
    
    // Navigate to home
    navigateTo('home');
}

async function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // Check if user document exists
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            // âœ… NOW SAVING photoURL
            await userRef.set({
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL || null, // âœ… ADD THIS
                userType: 'student',
                profileComplete: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            closeAuthModal();
            showVerificationModal({
                name: user.displayName,
                email: user.email,
                userType: 'student'
            });
        } else {
            // Existing user - check if profile is complete
            const userData = userDoc.data();
            if (!userData.profileComplete) {
                closeAuthModal();
                showVerificationModal(userData);
            } else {
                closeAuthModal();
            }
        }
    } catch (error) {
        console.error('Google sign-in error:', error);
        document.getElementById('signin-error').textContent = error.message;
        document.getElementById('signin-error').style.display = 'block';
    }
}
        
async function signUpWithGoogle(userType) {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        const userRef = db.collection('users').doc(user.uid);
        
        // âœ… Generate student ID if signing up as student
        const userData = {
            name: user.displayName,
            email: user.email,
            photoURL: user.photoURL || null,
            userType: userType,
            profileComplete: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (userType === 'student') {
            userData.studentId = generateStudentId(user.uid);
        }
        
        await userRef.set(userData);
        
        closeAuthModal();
        showVerificationModal({
            name: user.displayName,
            email: user.email,
            userType: userType
        });
    } catch (error) {
        console.error('Google sign-up error:', error);
        const errorDiv = document.getElementById(`signup-${userType}-error`);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}

        
        // ===== VERIFICATION MODAL FUNCTIONS =====
function showVerificationModal(userData) {
    const modal = document.getElementById('verificationModal');
    
    // Pre-fill any existing data
    if (userData.name) {
        document.getElementById('verify-name').value = userData.name;
    }
    if (userData.age) {
        document.getElementById('verify-age').value = userData.age;
    }
    if (userData.country) {
        document.getElementById('verify-country').value = userData.country;
    }
    
    modal.classList.add('active');
}

function closeVerificationModal() {
    document.getElementById('verificationModal').classList.remove('active');
}

async function handleVerification(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const name = document.getElementById('verify-name').value.trim();
    const age = document.getElementById('verify-age').value;
    const country = document.getElementById('verify-country').value;
    const errorDiv = document.getElementById('verify-error');
    
    if (!name || !age || !country) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (age < 5 || age > 100) {
        errorDiv.textContent = 'Please enter a valid age between 5 and 100.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            name: name,
            age: parseInt(age),
            country: country,
            profileComplete: true
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: name });
        
        errorDiv.style.display = 'none';
        closeVerificationModal();
        
        alert('âœ… Profile completed successfully! Welcome to WordBiz Coaching Academy!');
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
    } catch (error) {
        console.error('Error completing profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

        async function signOutAndSwitchAccount() {
    if (confirm('âš ï¸ Are you sure you want to sign out? You will need to sign in with a different account.')) {
        try {
            // Close verification modal
            closeVerificationModal();
            
            // Sign out the user
            await auth.signOut();
            
            // Reset UI to guest state
            currentUser = null;
            updateUIForGuestUser();
            
            // Navigate to home
            navigateTo('home');
            
            // Show auth modal for them to sign in/up with different account
            setTimeout(() => {
                showAuthModal();
            }, 500);
            
        } catch (error) {
            console.error('Error signing out:', error);
            alert('Failed to sign out: ' + error.message);
        }
    }
}

        // ===== ID VERIFICATION FUNCTIONS =====

function showVerificationModal(userData) {
    const modal = document.getElementById('verificationModal');
    const idSection = document.getElementById('coachIdVerification');
    const completeBtn = document.getElementById('completeProfileBtn');
    
    // Pre-fill any existing data
    if (userData.name) {
        document.getElementById('verify-name').value = userData.name;
    }
    if (userData.age) {
        document.getElementById('verify-age').value = userData.age;
    }
    if (userData.country) {
        document.getElementById('verify-country').value = userData.country;
    }
    
    // Check if this is a coach
    isCoachVerification = (userData.userType === 'coach');
    
    if (isCoachVerification) {
        idSection.classList.add('show');
        completeBtn.textContent = 'â³ Upload ID to Continue';
        completeBtn.disabled = true;
    } else {
        idSection.classList.remove('show');
        completeBtn.textContent = 'âœ… Complete Profile';
        completeBtn.disabled = false;
    }
    
    // Reset ID verification state
    uploadedIDFile = null;
    uploadedIDBase64 = null;
    idVerificationPassed = false;
    document.getElementById('idPreviewContainer').classList.remove('show');
    document.getElementById('idVerificationStatus').classList.remove('show');
    
    modal.classList.add('active');
}

// Handle ID file upload
function handleIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    // Validate file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    uploadedIDFile = file;
    
    // Convert to base64 for preview and API
    const reader = new FileReader();
    reader.onload = function(e) {
        uploadedIDBase64 = e.target.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
        
        // Show preview for images only
        if (file.type.startsWith('image/')) {
            document.getElementById('idPreviewImage').src = e.target.result;
            document.getElementById('idPreviewContainer').classList.add('show');
        } else {
            document.getElementById('idPreviewContainer').classList.remove('show');
        }
        
        // Automatically start verification
        verifyIDWithAI();
    };
    reader.readAsDataURL(file);
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('idUploadArea');
    
    if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('drag-over');
            }, false);
        });
        
        uploadArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                document.getElementById('verify-id-file').files = files;
                handleIDUpload({ target: { files: files } });
            }
        }, false);
    }
});

function changeIDPhoto() {
    document.getElementById('verify-id-file').value = '';
    document.getElementById('idPreviewContainer').classList.remove('show');
    document.getElementById('idVerificationStatus').classList.remove('show');
    uploadedIDFile = null;
    uploadedIDBase64 = null;
    idVerificationPassed = false;
    document.getElementById('completeProfileBtn').disabled = true;
    document.getElementById('completeProfileBtn').textContent = 'â³ Upload ID to Continue';
}

// Verify ID using AI
async function verifyIDWithAI() {
    if (!uploadedIDBase64) {
        alert('Please upload an ID first');
        return;
    }
    
    const statusDiv = document.getElementById('idVerificationStatus');
    const completeBtn = document.getElementById('completeProfileBtn');
    const coachName = document.getElementById('verify-name').value.trim();
    const coachAge = document.getElementById('verify-age').value.trim(); // âœ… GET AGE
    
    if (!coachName) {
        alert('Please enter your full name first');
        return;
    }
    
    if (!coachAge) {
        alert('Please enter your age first');
        return;
    }
    
    // Show verifying status
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.innerHTML = `
        <div class="verification-spinner"></div>
        <strong>Verifying your ID...</strong>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    completeBtn.disabled = true;
    completeBtn.textContent = 'â³ Verifying ID...';
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: uploadedIDBase64,
                    coachName: coachName,
                    userAge: coachAge, // âœ… SEND AGE
                    userId: currentUser.uid
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        console.log('Verification result:', result);
        
        // âœ… SIMPLIFIED: Check if verification passed
        if (result.verificationPassed) {
            // âœ… SUCCESS - CLEAN MESSAGE
            idVerificationPassed = true;
            statusDiv.className = 'id-verification-status success show';
            statusDiv.innerHTML = `
                <strong>âœ… ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Status:</strong> Text is clear and consistent with a standard passport layout.
                </p>
                <p style="margin-top: 10px; font-size: 0.9rem; font-style: italic;">
                    ðŸ”’ Your ID photo has not been stored. Only verification status is saved.
                </p>
            `;
            
            completeBtn.disabled = false;
            completeBtn.textContent = 'âœ… COMPLETE PROFILE';
            
            // Store verification result in Firestore
            await db.collection('users').doc(currentUser.uid).update({
                idVerified: true,
                idVerificationDate: firebase.firestore.FieldValue.serverTimestamp(),
                idDocumentType: result.documentType,
                idVerificationConfidence: result.confidence,
                verifiedAge: result.age
            });
            
        } else {
            // âœ… FAILURE - CLEAN MESSAGE
            idVerificationPassed = false;
            statusDiv.className = 'id-verification-status error show';
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${result.reason || 'Unable to verify your ID.'}</p>
                <p style="margin-top: 10px; font-size: 0.9rem;">
                    <strong>Tips for better verification:</strong><br>
                    â€¢ Ensure good lighting<br>
                    â€¢ Avoid glare or shadows<br>
                    â€¢ Make sure all text is readable<br>
                    â€¢ Use the original, unedited document<br>
                    â€¢ Ensure the name you typed matches the ID exactly
                </p>
            `;
            
            completeBtn.disabled = true;
            completeBtn.textContent = 'âŒ Upload Valid ID';
        }
        
    } catch (error) {
        console.error('ID Verification Error:', error);
        idVerificationPassed = false;
        statusDiv.className = 'id-verification-status error show';
        statusDiv.innerHTML = `
            <strong>âŒ Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify your ID. This could be due to:<br>
                â€¢ Poor image quality<br>
                â€¢ Network connection issues<br>
                â€¢ Unsupported document format
            </p>
            <p style="margin-top: 10px;">
                Error details: ${error.message}
            </p>
            <p style="margin-top: 10px; font-weight: bold;">
                Please try uploading a clearer photo of your ID.
            </p>
        `;
        
        completeBtn.disabled = true;
        completeBtn.textContent = 'âŒ Upload Valid ID';
    }
}
        
// Update handleVerification function to include ID check
async function handleVerification(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const name = document.getElementById('verify-name').value.trim();
    const age = document.getElementById('verify-age').value;
    const country = document.getElementById('verify-country').value;
    const errorDiv = document.getElementById('verify-error');
    
    if (!name || !age || !country) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (age < 5 || age > 100) {
        errorDiv.textContent = 'Please enter a valid age between 5 and 100.';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Check if coach needs ID verification
    if (isCoachVerification && !idVerificationPassed) {
        errorDiv.textContent = 'Please upload and verify your government-issued ID to continue.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // âœ… Update Firestore - PRESERVE photoURL
        const updateData = {
            name: name,
            age: parseInt(age),
            country: country,
            profileComplete: true
        };
        
        // Only add photoURL if it exists (don't overwrite with null)
        if (currentUser.photoURL) {
            updateData.photoURL = currentUser.photoURL;
        }
        
        await db.collection('users').doc(currentUser.uid).update(updateData);
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: name });
        
        errorDiv.style.display = 'none';
        closeVerificationModal();
        
        if (isCoachVerification) {
            alert('âœ… Profile and ID verification completed successfully! Welcome to WordBiz Coaching Academy!');
        } else {
            alert('âœ… Profile completed successfully! Welcome to WordBiz Coaching Academy!');
        }
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
    } catch (error) {
        console.error('Error completing profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}
        


// ===== PARENT ID UPLOAD FUNCTIONS =====
function handleParentIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    parentIDFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        parentIDBase64 = e.target.result.split(',')[1];
        
        if (file.type.startsWith('image/')) {
            document.getElementById('parent-id-preview-image').src = e.target.result;
            document.getElementById('parent-id-preview').style.display = 'block';
        }
        
        verifyParentID();
    };
    reader.readAsDataURL(file);
}

function changeParentID() {
    document.getElementById('parent-id-file').value = '';
    document.getElementById('parent-id-preview').style.display = 'none';
    document.getElementById('parent-id-status').style.display = 'none';
    parentIDFile = null;
    parentIDBase64 = null;
    parentIDVerified = false;
}

async function verifyParentID() {
    if (!parentIDBase64) {
        alert('Please upload parent ID first');
        return;
    }
    
    const statusDiv = document.getElementById('parent-id-status');
    const parentName = document.getElementById('signup-parent-name').value.trim();
    
    if (!parentName) {
        alert('Please enter parent name first');
        return;
    }
    
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#fff3cd';
    statusDiv.style.borderLeft = '4px solid #ffc107';
    statusDiv.style.padding = '15px';
    statusDiv.style.borderRadius = '8px';
    statusDiv.style.color = '#856404';
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="verification-spinner"></div>
            <strong>Verifying parent ID...</strong>
        </div>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: parentIDBase64,
                    coachName: parentName,
                    userId: 'temp-parent-' + Date.now()
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        if (result.isValid && result.isOver16 && !result.documentAppearsTampered) {
            parentIDVerified = true;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderLeft = '4px solid #28a745';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `
                <strong>âœ… Parent ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Document:</strong> ${result.documentType}<br>
                    <strong>Name:</strong> ${result.fullName}<br>
                    <strong>Age:</strong> ${result.age} years old
                </p>
            `;
        } else {
            parentIDVerified = false;
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderLeft = '4px solid #dc3545';
            statusDiv.style.color = '#721c24';
            
            let errorMessage = result.reason || 'Verification failed';
            
            if (!result.isValid) {
                errorMessage = 'âŒ Invalid or unrecognized document. Please upload a clear photo of your Driver\'s License, Passport, or National ID.';
            } else if (!result.isOver16) {
                errorMessage = 'âŒ Parent must be at least 16 years old.';
            } else if (result.documentAppearsTampered) {
                errorMessage = 'âŒ Document appears to be altered. Please upload an original, unedited ID.';
            }
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${errorMessage}</p>
            `;
        }
    } catch (error) {
        console.error('Parent ID Verification Error:', error);
        parentIDVerified = false;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.borderLeft = '4px solid #dc3545';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `
            <strong>âŒ Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify ID. Please ensure:<br>
                â€¢ Good lighting<br>
                â€¢ All text is readable<br>
                â€¢ No glare or shadows
            </p>
        `;
    }
}

// ===== CHILD ID UPLOAD FUNCTIONS =====
function handleChildIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    childIDFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        childIDBase64 = e.target.result.split(',')[1];
        
        if (file.type.startsWith('image/')) {
            document.getElementById('child-id-preview-image').src = e.target.result;
            document.getElementById('child-id-preview').style.display = 'block';
        }
        
        verifyChildID();
    };
    reader.readAsDataURL(file);
}

function changeChildID() {
    document.getElementById('child-id-file').value = '';
    document.getElementById('child-id-preview').style.display = 'none';
    document.getElementById('child-id-status').style.display = 'none';
    childIDFile = null;
    childIDBase64 = null;
    childIDVerified = false;
}

async function verifyChildID() {
    if (!childIDBase64) {
        alert('Please upload child ID first');
        return;
    }
    
    const statusDiv = document.getElementById('child-id-status');
    const childName = document.getElementById('signup-child-name').value.trim();
    
    if (!childName) {
        alert('Please enter child name first');
        return;
    }
    
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.style.display = 'block';
    statusDiv.style.background = '#fff3cd';
    statusDiv.style.borderLeft = '4px solid #ffc107';
    statusDiv.style.padding = '15px';
    statusDiv.style.borderRadius = '8px';
    statusDiv.style.color = '#856404';
    statusDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <div class="verification-spinner"></div>
            <strong>Verifying child ID...</strong>
        </div>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: childIDBase64,
                    coachName: childName,
                    userId: 'temp-child-' + Date.now()
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        // âœ… ADD: Check if name matches
        const nameMatches = result.fullName && 
            (result.fullName.toLowerCase().includes(childName.toLowerCase().split(' ')[0]) ||
            childName.toLowerCase().includes(result.fullName.toLowerCase().split(' ')[0]));
        
        // For children, we accept any valid document with matching name
        if (result.isValid && !result.documentAppearsTampered && nameMatches) {
            childIDVerified = true;
            statusDiv.style.background = '#d4edda';
            statusDiv.style.borderLeft = '4px solid #28a745';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = `
                <strong>âœ… Child ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Document:</strong> ${result.documentType}<br>
                    <strong>Name on ID:</strong> ${result.fullName}<br>
                    <strong>Your Child's Name:</strong> ${childName}
                    ${result.age ? `<br><strong>Age:</strong> ${result.age} years old` : ''}
                </p>
            `;
        } else {
            childIDVerified = false;
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.borderLeft = '4px solid #dc3545';
            statusDiv.style.color = '#721c24';
            
            let errorMessage = result.reason || 'Verification failed';
            
            if (!result.isValid) {
                errorMessage = 'âŒ Invalid or unrecognized document. Please upload a clear photo of the child\'s Birth Certificate, Student ID, or Government ID.';
            } else if (result.documentAppearsTampered) {
                errorMessage = 'âŒ Document appears to be altered. Please upload an original, unedited ID.';
            } else if (!nameMatches) {
                errorMessage = `âŒ Name mismatch! The name on the ID (${result.fullName}) does not match the child's name you entered (${childName}).`;
            }
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${errorMessage}</p>
                ${result.fullName ? `<p style="margin-top: 5px;"><strong>Detected Name:</strong> ${result.fullName}</p>` : ''}
            `;
        }
    } catch (error) {
        console.error('Child ID Verification Error:', error);
        childIDVerified = false;
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.borderLeft = '4px solid #dc3545';
        statusDiv.style.color = '#721c24';
        statusDiv.innerHTML = `
            <strong>âŒ Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify ID. Please ensure:<br>
                â€¢ Good lighting<br>
                â€¢ All text is readable<br>
                â€¢ No glare or shadows<br>
                â€¢ Name matches exactly
            </p>
        `;
    }
}

// ===== PARENT SIGN UP HANDLER =====
async function handleParentSignUp(event) {
    event.preventDefault();
    
    const errorDiv = document.getElementById('signup-parent-error');
    
    // Check ID verifications
    if (!parentIDVerified) {
        errorDiv.textContent = 'âŒ Please upload and verify parent ID first';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (!childIDVerified) {
        errorDiv.textContent = 'âŒ Please upload and verify child ID first';
        errorDiv.style.display = 'block';
        return;
    }
    
    const parentName = document.getElementById('signup-parent-name').value.trim();
    const email = document.getElementById('signup-parent-email').value.trim();
    const password = document.getElementById('signup-parent-password').value;
    const phone = document.getElementById('signup-parent-phone').value.trim();
    const country = document.getElementById('signup-parent-country').value;
    
    const childName = document.getElementById('signup-child-name').value.trim();
    const childAge = document.getElementById('signup-child-age').value;
    const childStudentId = document.getElementById('signup-child-student-id').value.trim();
    
    // Validate student ID format
    const studentIdPattern = /^WB-2025-[A-Z0-9]{4}$/;
    if (!studentIdPattern.test(childStudentId)) {
        errorDiv.textContent = 'âŒ Invalid student ID format. Must be WB-2025-XXXX';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Verify student ID exists in database
    try {
        const studentQuery = await db.collection('users')
            .where('studentId', '==', childStudentId)
            .where('userType', '==', 'student')
            .get();
        
        if (studentQuery.empty) {
            errorDiv.textContent = 'âŒ Student ID not found. Please verify the ID is correct.';
            errorDiv.style.display = 'block';
            return;
        }
        
        const studentDoc = studentQuery.docs[0];
        const studentData = studentDoc.data();
        
        // Check if student name matches
        if (studentData.name.toLowerCase() !== childName.toLowerCase()) {
            errorDiv.textContent = `âŒ Student name does not match. Registered name: ${studentData.name}`;
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check if student already has a parent
        if (studentData.parentId) {
            errorDiv.textContent = 'âŒ This student already has a parent account linked.';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Disable submit button
        const submitBtn = document.getElementById('parent-signup-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'â³ Creating account...';
        
        // Create parent account
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: parentName });
        
        // Save parent data to Firestore
        await db.collection('users').doc(userCredential.user.uid).set({
            name: parentName,
            email: email,
            phone: phone,
            country: country,
            userType: 'parent',
            parentIDVerified: true,
            childIDVerified: true,
            childStudentId: childStudentId,
            childName: childName,
            childAge: parseInt(childAge),
            linkedStudentId: studentDoc.id,
            profileComplete: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Link parent to student
        await db.collection('users').doc(studentDoc.id).update({
            parentId: userCredential.user.uid,
            parentName: parentName,
            parentEmail: email,
            parentLinkedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeAuthModal();
        errorDiv.style.display = 'none';
        
        alert(`âœ… Parent account created successfully!\n\nYou are now linked to student: ${childName}\nStudent ID: ${childStudentId}`);
        
        // Reset form
        document.getElementById('signup-parent-form').reset();
        parentIDFile = null;
        parentIDBase64 = null;
        childIDFile = null;
        childIDBase64 = null;
        parentIDVerified = false;
        childIDVerified = false;
        
    } catch (error) {
        console.error('Error creating parent account:', error);
        errorDiv.textContent = 'Failed to create account: ' + error.message;
        errorDiv.style.display = 'block';
        
        const submitBtn = document.getElementById('parent-signup-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'âœ… Create Parent Account';
    }
}        
       function updateUIForAuthenticatedUser(user) {
    const displayName = user.displayName || user.email.split('@')[0];
    const photoURL = user.photoURL;
    
    // Update sidebar
    document.getElementById('sidebarUserName').textContent = displayName;
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    
    if (photoURL) {
        sidebarAvatar.style.backgroundImage = `url(${photoURL})`;
        sidebarAvatar.textContent = '';
    } else {
        sidebarAvatar.style.backgroundImage = 'none';
        sidebarAvatar.textContent = displayName.charAt(0).toUpperCase();
    }
    
    // Show My Profile button
    document.getElementById('myProfileBtn').style.display = 'block';
    
    document.getElementById('sidebar-signin').style.display = 'none';
    document.getElementById('sidebar-signout').style.display = 'block';
    
    // âœ… REMOVED: Do NOT initialize presence here
    // Let it be initialized only when user goes to Live Spelling
}

        
      function updateUIForGuestUser() {
    document.getElementById('sidebarUserName').textContent = 'Guest';
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    sidebarAvatar.style.backgroundImage = 'none';
    sidebarAvatar.textContent = '?';
    
    // Hide My Profile button
    document.getElementById('myProfileBtn').style.display = 'none';
    
    document.getElementById('sidebar-signin').style.display = 'block';
    document.getElementById('sidebar-signout').style.display = 'none';
    userFavorites = [];
    userIncorrect = [];
    userSpellingFavorites = [];
    userSpellingIncorrect = [];
    
    // âœ… HIDE COINS
    userCoins = 0;
    hideCoinDisplay();
    
    document.getElementById('favorites-container').innerHTML = '<div class="loading">Please sign in to save favorites</div>';
    document.getElementById('incorrect-container').innerHTML = '<div class="loading">Please sign in to track incorrect answers</div>';
    document.getElementById('spelling-favorites-container').innerHTML = '<div class="loading">Please sign in to save spelling favorites</div>';
    document.getElementById('spelling-incorrect-container').innerHTML = '<div class="loading">Please sign in to track spelling mistakes</div>';
}
        
       
        // ===== QUIZ FUNCTIONS =====
    function switchQuizMode(mode) {
    // Remove active from ALL quiz tabs
    document.querySelectorAll('#quiz-section .quiz-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Add active to clicked tab
    if (mode === 'practice') {
        document.querySelectorAll('#quiz-section .quiz-tab')[0].classList.add('active');
    } else if (mode === 'live') {
        document.querySelectorAll('#quiz-section .quiz-tab')[1].classList.add('active');
    } else if (mode === 'leaderboard') {
        document.querySelectorAll('#quiz-section .quiz-tab')[2].classList.add('active');
    }

    // âœ… Remove active from ALL quiz modes
    document.querySelectorAll('#quiz-section .quiz-mode').forEach(m => {
        m.classList.remove('active');
    });

    // âœ… Show only the selected mode
    if (mode === 'practice') {
        document.getElementById('practice-quiz-mode').classList.add('active');
    } else if (mode === 'live') {
        document.getElementById('live-quiz-mode').classList.add('active');
        
        if (currentUser) {
            initializeOnlinePresence();
            setTimeout(() => loadQuizOnlineUsers(), 100);
        } else {
            alert('Please sign in to access live challenges');
            showAuthModal();
        }
    } else if (mode === 'leaderboard') {
        document.getElementById('leaderboard-quiz-mode').classList.add('active');
        loadQuizLeaderboard();
    }
}

        
     async function startPracticeQuizWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection
    document.getElementById('quiz-level-selection').style.display = 'none';
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">ðŸ“š Loading words from ' + level.toUpperCase() + ' level...</div>';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">ðŸŽ² Generating quiz questions...</div>';
    
    // Initialize IQ tracking
    quizStartTime = Date.now();
    quizAnswerTimes = [];
    
    const quizWords = [];
    for (let i = 0; i < 5; i++) {
        const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
        quizWords.push(randomWord);
    }
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                data: { 
                    action: 'generatePracticeQuiz',
                    words: quizWords 
                } 
            })
        });
        
        const data = await response.json();
        currentQuiz = data.result;
        currentQuestionIndex = 0;
        quizScore = 0;
        
        showQuestion('practice');
    } catch (error) {
        console.error('Error generating quiz:', error);
        document.getElementById('practice-quiz-container').innerHTML = 
            '<div class="feedback error">Failed to generate quiz. Please try again.</div>';
    }
}

// Keep old function name for backwards compatibility but add check
async function startPracticeQuiz() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    await startPracticeQuizWithLevel(selectedGameLevel);
}

function backToQuizLevelSelection() {
    document.getElementById('quiz-level-selection').style.display = 'block';
    document.getElementById('practice-quiz-container').innerHTML = '';
    selectedGameLevel = '';
}


function showQuestion(quizType = 'practice') {
    const question = currentQuiz.questions[currentQuestionIndex];
    const container = document.getElementById('practice-quiz-container');
    
    const isFavorited = userFavorites.some(fav => fav.word === question.word);
    
    // Start timing for this question
    questionStartTime = Date.now();
    
    container.innerHTML = `
        <div class="quiz-question-card" style="position: relative;">
            ${currentUser ? `
                <span class="favorite-heart ${isFavorited ? 'active' : ''}" 
                      onclick="event.stopPropagation(); toggleFavorite('${question.word}', null, this)">
                    ${isFavorited ? 'â¤ï¸' : 'ðŸ¤'}
                </span>
            ` : ''}
            <div class="quiz-score">Score: ${quizScore} / ${currentQuestionIndex}</div>
            <h3>Question ${currentQuestionIndex + 1} of ${currentQuiz.questions.length}</h3>
            <p style="font-size: 1.3rem; margin: 20px 0;"><strong>${question.question}</strong></p>
            <div class="quiz-options">
                ${question.options.map((option, index) => `
                    <div class="quiz-option" onclick="checkAnswer(${index}, '${quizType}')">
                        ${option}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

       async function checkAnswer(selectedIndex, quizType = 'practice') {
    const question = currentQuiz.questions[currentQuestionIndex];
    const options = document.querySelectorAll('.quiz-option');
    
    // Calculate time taken for this question
    const timeTaken = Date.now() - questionStartTime;
    quizAnswerTimes.push({
        correct: selectedIndex === question.correctAnswer,
        timeTaken: timeTaken
    });
    
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        options[selectedIndex].classList.add('correct');
        quizScore++;
    } else {
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
        
        if (currentUser) {
            await saveIncorrectQuestion(question, quizType, selectedIndex);
        }
        
        if (currentUser) {
            const favoriteRef = db.collection('users').doc(currentUser.uid).collection('favorites').doc(question.word);
            const favoriteDoc = await favoriteRef.get();
            
            if (favoriteDoc.exists) {
                await favoriteRef.update({
                    userAnswerIndex: selectedIndex
                });
                
                const favIndex = userFavorites.findIndex(fav => fav.word === question.word);
                if (favIndex !== -1) {
                    userFavorites[favIndex].userAnswerIndex = selectedIndex;
                }
                
                if (document.getElementById('favorites-section').classList.contains('active')) {
                    displayFavorites();
                }
            }
        }
    }
    
    setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuiz.questions.length) {
            questionStartTime = Date.now(); // Reset timer for next question
            showQuestion(quizType);
        } else {
            showQuizResults();
        }
    }, 3000);
}

        function calculateIQScore(score, total, answerTimes) {
    // Base IQ calculation on accuracy and speed
    const accuracyPercentage = (score / total) * 100;
    
    // Calculate average time per question (in seconds)
    const avgTime = answerTimes.reduce((sum, ans) => sum + ans.timeTaken, 0) / answerTimes.length / 1000;
    
    // Speed score: faster is better (ideal time: 5-10 seconds per question)
    let speedScore = 0;
    if (avgTime < 5) speedScore = 100;
    else if (avgTime < 10) speedScore = 90;
    else if (avgTime < 15) speedScore = 75;
    else if (avgTime < 20) speedScore = 60;
    else speedScore = 40;
    
    // Consistency score: fewer mistakes on easy questions = higher IQ
    const correctAnswers = answerTimes.filter(ans => ans.correct).length;
    const consistencyScore = (correctAnswers / total) * 100;
    
    // Calculate base IQ (scale: 70-145)
    // Formula: 70 + (accuracy * 0.5) + (speed * 0.2) + (consistency * 0.05)
    let iq = 70 + (accuracyPercentage * 0.5) + (speedScore * 0.2) + (consistencyScore * 0.05);
    
    // Cap at 145 (genius level)
    iq = Math.min(145, Math.round(iq));
    
    return {
        iq: iq,
        accuracy: accuracyPercentage,
        avgTime: avgTime.toFixed(1),
        speedScore: speedScore,
        category: getIQCategory(iq)
    };
}

function getIQCategory(iq) {
    if (iq >= 130) return { label: "Genius", color: "#FFD700", emoji: "ðŸ§ âœ¨" };
    if (iq >= 120) return { label: "Superior", color: "#4CAF50", emoji: "ðŸŒŸ" };
    if (iq >= 110) return { label: "High Average", color: "#2196F3", emoji: "â­" };
    if (iq >= 90) return { label: "Average", color: "#FF9800", emoji: "ðŸ‘" };
    if (iq >= 80) return { label: "Low Average", color: "#FF5722", emoji: "ðŸ“š" };
    return { label: "Keep Practicing", color: "#9E9E9E", emoji: "ðŸ’ª" };
}
        
        function showQuizResults() {
    const container = document.getElementById('practice-quiz-container');
    const percentage = Math.round((quizScore / currentQuiz.questions.length) * 100);
    
    // Calculate IQ Score
    const iqData = calculateIQScore(quizScore, currentQuiz.questions.length, quizAnswerTimes);
    
    let message = '';
    let emoji = '';
    let showBalloons = false;
    let showSpellingEncouragement = false;
    
    if (percentage >= 80) {
        message = 'Excellent! You\'re a word master!';
        emoji = 'ðŸ†';
        showBalloons = true;
        showSpellingEncouragement = true;
    } else if (percentage >= 60) {
        message = 'Great job! Keep practicing!';
        emoji = 'â­';
        showSpellingEncouragement = true;
    } else {
        message = 'Keep practicing! You\'ll get better!';
        emoji = 'ðŸ“š';
    }
    
    // Create balloons if score is high
    if (showBalloons) {
        createBalloons();
        createConfetti();
    }
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
            <h2>Quiz Complete!</h2>
            <div class="quiz-score">Final Score: ${quizScore} / ${currentQuiz.questions.length}</div>
            <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
            <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
            
            <!-- IQ Score Display -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; margin: 30px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                <h3 style="color: white; margin-bottom: 15px; font-size: 1.5rem;">ðŸ§  Your Vocabulary IQ</h3>
                <div class="iq-badge">${iqData.iq}</div>
                <p style="color: white; font-size: 1.3rem; margin: 15px 0;">
                    ${iqData.category.emoji} <strong>${iqData.category.label}</strong>
                </p>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p style="color: white; margin: 8px 0;"><strong>ðŸ“Š Accuracy:</strong> ${iqData.accuracy.toFixed(1)}%</p>
                    <p style="color: white; margin: 8px 0;"><strong>âš¡ Avg Response Time:</strong> ${iqData.avgTime}s</p>
                    <p style="color: white; margin: 8px 0;"><strong>ðŸŽ¯ Speed Score:</strong> ${iqData.speedScore}/100</p>
                </div>
            </div>
            
            ${showSpellingEncouragement ? `
                <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 25px; border-radius: 15px; margin: 20px 0; box-shadow: 0 5px 20px rgba(255,215,0,0.4); animation: pulse-glow 2s infinite;">
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">ðŸ† You Have Spelling Champion Potential!</h3>
                    <p style="color: #0d3b66; margin: 10px 0; font-size: 1.1rem;">
                        Your strong vocabulary skills show you could excel at spelling competitions!
                    </p>
                    <p style="color: #0d3b66; margin: 10px 0; font-weight: bold;">
                        ðŸ’° Head to the Spelling section to practice and earn coins in upcoming live challenges!
                    </p>
                    <button class="practice-btn" onclick="navigateTo('spelling')" style="background: #0d3b66; color: white; margin-top: 15px; font-size: 1.1rem; padding: 15px 30px;">
                        ðŸ”¤ Go to Spelling Practice â†’
                    </button>
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
    <button class="practice-btn" onclick="backToQuizLevelSelection()">â† Back to Levels</button>
    <button class="practice-btn" onclick="startPracticeQuizWithLevel('${selectedGameLevel}')">ðŸ”„ Try Again</button>
    <button class="practice-btn" onclick="navigateTo('home')">ðŸ  Home</button>
</div>
        </div>
    `;
}

function createBalloons() {
    const balloons = ['ðŸŽˆ', 'ðŸŽˆ', 'ðŸŽˆ', 'ðŸŽˆ', 'ðŸŽˆ', 'ðŸŽˆ'];
    const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'pink'];
    
    balloons.forEach((balloon, index) => {
        const balloonEl = document.createElement('div');
        balloonEl.className = 'balloon';
        balloonEl.textContent = balloon;
        balloonEl.style.color = colors[index];
        document.body.appendChild(balloonEl);
        
        // Remove after animation
        setTimeout(() => {
            balloonEl.remove();
        }, 8000);
    });
}

function createConfetti() {
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'];
    
    for (let i = 0; i < 50; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 3000);
        }, i * 50);
    }
}

        // ===== FAVORITES MANAGEMENT =====
     async function loadUserFavorites(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('favorites').get();
        
        // Load all favorites - only filter out truly broken ones
        userFavorites = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(fav => {
                // Keep if it has word and valid question
                return fav.word && 
                       fav.question && 
                       fav.question !== 'undefined';
            });
        
        console.log('Loaded favorites:', userFavorites);
        displayFavorites();
        
        // Enable quiz button based on valid quizzable favorites
        const btn = document.getElementById('favoritesQuizBtn');
        if (btn) {
            const quizzableFavorites = userFavorites.filter(fav => 
                fav.options && 
                Array.isArray(fav.options) && 
                fav.options.length > 0 &&
                typeof fav.correctAnswer === 'number'
            );
            btn.disabled = quizzableFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error loading favorites:', error);
    }
}
        
       async function toggleFavorite(word, questionData, element) {
    if (!currentUser) {
        alert('Please sign in to save favorites');
        return;
    }

    const favoriteRef = db.collection('users').doc(currentUser.uid).collection('favorites').doc(word);
    const favoriteDoc = await favoriteRef.get();

    if (favoriteDoc.exists) {
        await favoriteRef.delete();
        element.textContent = 'ðŸ¤';
        element.classList.remove('active');
        userFavorites = userFavorites.filter(fav => fav.word !== word);
    } else {
        // Get the current question from the quiz
        const question = currentQuiz.questions[currentQuestionIndex];
        
        const favoriteData = {
            word: word,
            question: question.question,
            options: question.options,
            correctAnswer: question.correctAnswer,
            correctDefinition: question.options[question.correctAnswer],
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Check if this question was already answered incorrectly
        const incorrectAnswer = userIncorrect.find(inc => inc.word === word);
        if (incorrectAnswer && incorrectAnswer.userAnswerIndex !== undefined) {
            favoriteData.userAnswerIndex = incorrectAnswer.userAnswerIndex;
        }
        
        // ALSO check if the user just answered this question wrong (check the DOM)
        const wrongOption = document.querySelector('.quiz-option.wrong');
        if (wrongOption) {
            // Find which index this is
            const allOptions = Array.from(document.querySelectorAll('.quiz-option'));
            const wrongIndex = allOptions.indexOf(wrongOption);
            if (wrongIndex !== -1) {
                favoriteData.userAnswerIndex = wrongIndex;
            }
        }
        
        await favoriteRef.set(favoriteData);
        
        element.textContent = 'â¤ï¸';
        element.classList.add('active');
        
        const newFavorite = {
            word: word,
            question: question.question,
            options: question.options,
            correctAnswer: question.correctAnswer,
            correctDefinition: question.options[question.correctAnswer]
        };
        
        if (favoriteData.userAnswerIndex !== undefined) {
            newFavorite.userAnswerIndex = favoriteData.userAnswerIndex;
        }
        
        userFavorites.push(newFavorite);
    }

    displayFavorites();
}
        
async function startFavoritesQuiz() {
    // Only use favorites that have full question data
    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );
    
    const minQuestions = Math.min(quizzableFavorites.length, 5);
    if (quizzableFavorites.length < minQuestions) {
        alert(`You need at least ${minQuestions} quizzable favorites to generate a quiz`);
        return;
    }

    navigateTo('quiz', true);
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">ðŸŽ² Generating quiz from your favorites...</div>';

    // Use the exact saved questions with their options
    const selectedFavorites = [...quizzableFavorites].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

    const quizQuestions = selectedFavorites.map(fav => ({
        word: fav.word,
        question: fav.question,
        options: fav.options,
        correctAnswer: fav.correctAnswer,
        correctDefinition: fav.correctDefinition
    }));

    currentQuiz = { questions: quizQuestions };
    currentQuestionIndex = 0;
    quizScore = 0;

    showQuestion('favorites');
}

function displayFavorites() {
    const container = document.getElementById('favorites-container');
    const btn = document.getElementById('favoritesQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to save favorites</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userFavorites.length === 0) {
        container.innerHTML = '<div class="loading">No favorites yet. Star words from quizzes to add them here!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );

    if (btn) {
        btn.disabled = quizzableFavorites.length < 5;
    }

    container.innerHTML = `
        ${userFavorites.length < 5 ? `
            <div class="loading">
                You have ${userFavorites.length} favorite(s). Add at least ${5 - userFavorites.length} more to generate a quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userFavorites.map(fav => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeFavorite('${fav.word}')">Ã—</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">${fav.word}</h3>
                    <p style="color: #666; margin-bottom: 10px;"><strong>Q:</strong> ${fav.question}</p>
                    ${fav.options ? `
                        <div style="margin: 10px 0;">
                            ${fav.options.map((opt, idx) => `
                                <p style="padding: 5px; margin: 3px 0; border-radius: 5px; font-size: 0.9rem; 
                                   background: ${idx === fav.correctAnswer ? '#d4edda' : (fav.userAnswerIndex !== undefined && idx === fav.userAnswerIndex ? '#f8d7da' : '#f9f9f9')};">
                                    ${opt} ${idx === fav.correctAnswer ? 'âœ“' : (fav.userAnswerIndex !== undefined && idx === fav.userAnswerIndex ? 'âœ—' : '')}
                                </p>
                            `).join('')}
                        </div>
                    ` : `
                        <p style="color: #28a745; margin-top: 10px;"><strong>Definition:</strong> ${fav.correctDefinition || 'No definition saved'}</p>
                    `}
                </div>
            `).join('')}
        </div>
    `;
}
        
        async function removeFavorite(word) {
            if (!currentUser) return;

            await db.collection('users').doc(currentUser.uid).collection('favorites').doc(word).delete();
            userFavorites = userFavorites.filter(fav => fav.word !== word);
            displayFavorites();
        }

      async function startFavoritesQuiz() {
    // Only use favorites that have full question data
    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );
    
    const minQuestions = Math.min(quizzableFavorites.length, 5);
    if (quizzableFavorites.length < minQuestions) {
        alert(`You need at least ${minQuestions} quizzable favorites to generate a quiz`);
        return;
    }

    navigateTo('quiz', true);
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">ðŸŽ² Generating quiz from your favorites...</div>';

    // Use the exact saved questions with their options
    const selectedFavorites = [...quizzableFavorites].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

    const quizQuestions = selectedFavorites.map(fav => ({
        word: fav.word,
        question: fav.question,
        options: fav.options,
        correctAnswer: fav.correctAnswer,
        correctDefinition: fav.correctDefinition
    }));

    currentQuiz = { questions: quizQuestions };
    currentQuestionIndex = 0;
    quizScore = 0;

    showQuestion('favorites');
}

        
      async function loadUserIncorrect(userId) {
            try {
                const snapshot = await db.collection('users').doc(userId).collection('incorrectQuestions').get();
                userIncorrect = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayIncorrect();
                
                // Enable quiz button if enough incorrect answers
                const btn = document.getElementById('incorrectQuizBtn');
                if (btn) {
                    btn.disabled = userIncorrect.length < 5;
                }
            } catch (error) {
                console.error('Error loading incorrect questions:', error);
            }
        }
        
       async function saveIncorrectQuestion(question, quizType, selectedIndex) {
            if (!currentUser) return;

            const incorrectRef = db.collection('users').doc(currentUser.uid).collection('incorrectQuestions');
            
            // Save complete question with all options
            const docRef = await incorrectRef.add({
                word: question.word,
                question: question.question,
                options: question.options,
                correctAnswer: question.correctAnswer,
                correctDefinition: question.options[question.correctAnswer],
                userAnswer: question.options[selectedIndex],
                userAnswerIndex: selectedIndex,
                quizType: quizType,
                savedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            userIncorrect.push({
                id: docRef.id,
                word: question.word,
                question: question.question,
                options: question.options,
                correctAnswer: question.correctAnswer,
                correctDefinition: question.options[question.correctAnswer],
                userAnswer: question.options[selectedIndex]
            });
            
            displayIncorrect();
        }

       function displayIncorrect() {
            const container = document.getElementById('incorrect-container');
            const btn = document.getElementById('incorrectQuizBtn');

            if (!currentUser) {
                container.innerHTML = '<div class="loading">Please sign in to track incorrect answers</div>';
                btn.disabled = true;
                return;
            }

            if (userIncorrect.length === 0) {
                container.innerHTML = '<div class="loading">No incorrect answers yet. Take a quiz to get started!</div>';
                btn.disabled = true;
                return;
            }

            const minQuestions = Math.min(userIncorrect.length, 5);
            btn.disabled = userIncorrect.length < minQuestions;

            container.innerHTML = `
                ${userIncorrect.length < 5 ? `
                    <div class="loading">
                        You have ${userIncorrect.length} incorrect answer(s). Add at least ${5 - userIncorrect.length} more to generate a practice quiz.
                    </div>
                ` : ''}
                <div class="favorites-grid">
                    ${userIncorrect.map(inc => `
                        <div class="favorite-card">
                            <button class="delete-btn" onclick="removeIncorrect('${inc.id}')">Ã—</button>
                            <h3 style="color: #0d3b66; margin-bottom: 10px;">${inc.word}</h3>
                            <p style="color: #666; margin-bottom: 10px;"><strong>Q:</strong> ${inc.question}</p>
                            ${inc.options ? `
                                <div style="margin: 10px 0;">
                                    ${inc.options.map((opt, idx) => `
                                        <p style="padding: 5px; margin: 3px 0; border-radius: 5px; font-size: 0.9rem; 
                                           background: ${idx === inc.correctAnswer ? '#d4edda' : (opt === inc.userAnswer ? '#f8d7da' : '#f9f9f9')};">
                                            ${opt} ${idx === inc.correctAnswer ? 'âœ“' : (opt === inc.userAnswer ? 'âœ—' : '')}
                                        </p>
                                    `).join('')}
                                </div>
                            ` : `
                                <p style="color: #dc3545; margin-top: 5px;"><strong>Your answer:</strong> ${inc.userAnswer}</p>
                                <p style="color: #28a745; margin-top: 5px;"><strong>Correct:</strong> ${inc.correctDefinition}</p>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
        }
              

        async function removeIncorrect(id) {
            if (!currentUser) return;

            await db.collection('users').doc(currentUser.uid).collection('incorrectQuestions').doc(id).delete();
            userIncorrect = userIncorrect.filter(inc => inc.id !== id);
            displayIncorrect();
        }

        async function startIncorrectQuiz() {
            const minQuestions = Math.min(userIncorrect.length, 5);
            if (userIncorrect.length < minQuestions) {
                alert(`You need at least ${minQuestions} incorrect answers to generate a practice quiz`);
                return;
            }

            navigateTo('quiz', true);
            document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">ðŸŽ² Generating quiz from your incorrect answers...</div>';

            // Use the exact saved questions with their options
            const selectedIncorrect = [...userIncorrect].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

            const quizQuestions = selectedIncorrect.map(inc => ({
                word: inc.word,
                question: inc.question,
                options: inc.options,
                correctAnswer: inc.correctAnswer,
                correctDefinition: inc.correctDefinition
            }));

            currentQuiz = { questions: quizQuestions };
            currentQuestionIndex = 0;
            quizScore = 0;

            showQuestion('incorrect');
        }

        async function cleanupInvalidFavorites() {
    if (!currentUser) return;
    
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid).collection('favorites').get();
        
        const deletions = [];
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            // Only delete if question is literally "undefined" or missing word
            if (!data.word || data.question === 'undefined') {
                console.log('Deleting invalid favorite:', doc.id);
                deletions.push(doc.ref.delete());
            }
        });
        
        if (deletions.length > 0) {
            await Promise.all(deletions);
            console.log(`Cleaned up ${deletions.length} invalid favorites`);
            // Reload favorites
            await loadUserFavorites(currentUser.uid);
        }
    } catch (error) {
        console.error('Error cleaning up favorites:', error);
    }
}



async function startSpellingPracticeWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection and show loading
    document.getElementById('spelling-level-selection').style.display = 'none';
    const gameContainer = document.getElementById('spelling-game');
    gameContainer.innerHTML = '<div class="loading">ðŸ“š Loading ' + level.toUpperCase() + ' words...</div>';
    gameContainer.style.display = 'block';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    // Select 10 random words from the entire level (no difficulty filtering)
    if (allWords.length < 10) {
        alert('Not enough words in this level. Try another level.');
        document.getElementById('spelling-level-selection').style.display = 'block';
        gameContainer.style.display = 'none';
        return;
    }
    
    const shuffled = [...allWords].sort(() => 0.5 - Math.random());
    spellingWords = shuffled.slice(0, 10);
    
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    // Clear the loading message and restore the game UI
    gameContainer.innerHTML = `
        <div class="quiz-question-card">
            <div class="quiz-score" id="spelling-score">Score: 0 / 0</div>
            <h3 id="spelling-progress">Word 1 of 10</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="practice-btn" onclick="speakCurrentSpellingWord()" style="font-size: 0.9rem; padding: 10px 15px;">
                        ðŸ”Š Play Word
                    </button>
                    <button class="practice-btn" onclick="speakWordInSentence()" style="font-size: 0.9rem; padding: 10px 15px;">
                        ðŸ’¬ Use in Sentence
                    </button>
                    <button class="practice-btn" id="show-details-btn" onclick="showSpellingWordDetails()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                        ðŸ“– Word Details
                    </button>
                    <button class="practice-btn" id="add-spelling-favorite-btn" onclick="addCurrentSpellingToFavorites()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                        â­ Add to Favorites
                    </button>
                </div>
                <p style="margin-top: 5px; color: #666; font-style: italic; font-size: 0.9rem;">Listen to the word alone, in a sentence, see details, or add to favorites</p>
            </div>
                            
            <div class="form-group" style="margin: 30px 0;">
                <label style="font-size: 1.2rem;">Type what you hear:</label>
                <input type="text" id="spelling-input" 
                       placeholder="Use the keyboard below..." 
                       style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                       readonly>
            </div>
            
            <!-- Virtual Keyboard -->
            <div class="virtual-keyboard">
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('Q')">Q</button>
                    <button class="keyboard-key" onclick="typeKey('W')">W</button>
                    <button class="keyboard-key" onclick="typeKey('E')">E</button>
                    <button class="keyboard-key" onclick="typeKey('R')">R</button>
                    <button class="keyboard-key" onclick="typeKey('T')">T</button>
                    <button class="keyboard-key" onclick="typeKey('Y')">Y</button>
                    <button class="keyboard-key" onclick="typeKey('U')">U</button>
                    <button class="keyboard-key" onclick="typeKey('I')">I</button>
                    <button class="keyboard-key" onclick="typeKey('O')">O</button>
                    <button class="keyboard-key" onclick="typeKey('P')">P</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('A')">A</button>
                    <button class="keyboard-key" onclick="typeKey('S')">S</button>
                    <button class="keyboard-key" onclick="typeKey('D')">D</button>
                    <button class="keyboard-key" onclick="typeKey('F')">F</button>
                    <button class="keyboard-key" onclick="typeKey('G')">G</button>
                    <button class="keyboard-key" onclick="typeKey('H')">H</button>
                    <button class="keyboard-key" onclick="typeKey('J')">J</button>
                    <button class="keyboard-key" onclick="typeKey('K')">K</button>
                    <button class="keyboard-key" onclick="typeKey('L')">L</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('Z')">Z</button>
                    <button class="keyboard-key" onclick="typeKey('X')">X</button>
                    <button class="keyboard-key" onclick="typeKey('C')">C</button>
                    <button class="keyboard-key" onclick="typeKey('V')">V</button>
                    <button class="keyboard-key" onclick="typeKey('B')">B</button>
                    <button class="keyboard-key" onclick="typeKey('N')">N</button>
                    <button class="keyboard-key" onclick="typeKey('M')">M</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key backspace" onclick="backspaceKey()">âŒ« Delete</button>
                    <button class="keyboard-key space" onclick="typeKey(' ')">Space</button>
                    <button class="keyboard-key enter" onclick="submitSpelling()">âœ“ Enter</button>
                </div>
            </div>
                            
            <div style="text-align: center; margin-top: 20px;">
                <button class="practice-btn" onclick="skipSpellingWord()" style="background: #666;">
                    â­ï¸ Skip
                </button>
            </div>
                            
            <div id="spelling-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
    
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

function backToSpellingLevelSelection() {
    document.getElementById('spelling-level-selection').style.display = 'block';
    document.getElementById('spelling-game').style.display = 'none';
    document.getElementById('spelling-results').style.display = 'none';
    selectedGameLevel = '';
}

// Keep old function for backwards compatibility
function startSpellingPractice() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    startSpellingPracticeWithLevel(selectedGameLevel);
}
        
        function loadSpellingWord() {
    currentSpellingWord = spellingWords[currentSpellingIndex];
    
    document.getElementById('spelling-progress').textContent = 
        `Word ${currentSpellingIndex + 1} of ${spellingWords.length}`;
    document.getElementById('spelling-score').textContent = 
        `Score: ${spellingScore} / ${currentSpellingIndex}`;
    document.getElementById('spelling-input').value = '';
    document.getElementById('spelling-feedback').innerHTML = '';
    
    // Show favorite button if user is logged in
    const favoriteBtn = document.getElementById('add-spelling-favorite-btn');
    if (favoriteBtn && currentUser) {
        favoriteBtn.style.display = 'inline-block';
    }
    
    // Hide word details button for new word
    const detailsBtn = document.getElementById('show-details-btn');
    if (detailsBtn) {
        detailsBtn.style.display = 'none';
    }
    
    // Re-enable input for new word
    document.getElementById('spelling-input').disabled = false;
    
    // Auto-play the word when loaded
    setTimeout(() => speakCurrentSpellingWord(), 500);
    
    // Focus on input
    document.getElementById('spelling-input').focus();
}
        
       function speakCurrentSpellingWord() {
            if (!currentSpellingWord) return;
            
            const utterance = new SpeechSynthesisUtterance(currentSpellingWord);
            utterance.rate = 0.7; // Slower for spelling
            utterance.pitch = 1;
            utterance.volume = 1;
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
            
            // Visual feedback
            const btn = event?.target;
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = 'scale(1)', 200);
            }
        }

        async function speakWordInSentence() {
    if (!currentSpellingWord) return;
    
    // Show loading state
    const btn = event?.target;
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'â³ Loading...';
    }
    
    try {
        // Fetch word definition to get example sentence
        const wordRef = db.collection('dictionary').doc(currentSpellingWord.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let exampleSentence = null;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        exampleSentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        // If no cached example, fetch from API
        if (!exampleSentence) {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: currentSpellingWord } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.meanings && data.result.meanings.length > 0) {
                    for (let meaning of data.result.meanings) {
                        if (meaning.example) {
                            exampleSentence = meaning.example;
                            break;
                        }
                    }
                }
            }
        }
        
        // If still no example, create a simple sentence
        if (!exampleSentence) {
            exampleSentence = `The word is ${currentSpellingWord}.`;
        }
        
        // Use SSML to emphasize the target word with volume
        const targetWord = currentSpellingWord;
        const emphasizedSentence = exampleSentence.replace(
            new RegExp(`\\b${targetWord}\\b`, 'gi'),
            `<emphasis level="strong">${targetWord}</emphasis>`
        );
        
        // Speak the entire sentence at once
        const utterance = new SpeechSynthesisUtterance(exampleSentence);
        utterance.rate = 0.8;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        // Fallback: just say the word
        const utterance = new SpeechSynthesisUtterance(`The word is ${currentSpellingWord}.`);
        utterance.rate = 0.8;
        window.speechSynthesis.speak(utterance);
    } finally {
        // Reset button
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'ðŸ’¬ Use in Sentence';
        }
    }
}
        
       async function showSpellingWordDetails() {
    if (!currentSpellingWord) return;
    
    const feedbackDiv = document.getElementById('spelling-feedback');
    feedbackDiv.innerHTML = '<div class="loading">ðŸ“š Loading word details...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentSpellingWord);
        
        feedbackDiv.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #17a2b8; margin-top: 15px;">
                <h3 style="color: #17a2b8; margin-bottom: 15px;">ðŸ“– Word Information</h3>
                
                ${wordDetails.phonetic ? `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #0d3b66;">ðŸ”Š Pronunciation:</strong>
                        <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                    </div>
                ` : ''}
                
                ${wordDetails.origin ? `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #0d3b66;">ðŸ“œ Origin:</strong>
                        <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                    </div>
                ` : ''}
                
                ${wordDetails.definition ? `
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #0d3b66;">ðŸ“ Definition:</strong>
                        <p style="color: #333; margin-top: 8px; line-height: 1.6;">${wordDetails.definition}</p>
                    </div>
                ` : ''}
                
                <p style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; color: #0d3b66; font-style: italic; text-align: center;">
                    âš ï¸ Remember: Don't use this to cheat! Use it to learn about the word after attempting.
                </p>
            </div>
        `;
    } catch (error) {
        console.error('Error fetching word details:', error);
        feedbackDiv.innerHTML = `
            <div class="feedback error">
                âŒ Unable to load word details. Please try again.
            </div>
        `;
    }
}
        function nextSpellingWord() {
    document.getElementById('spelling-input').disabled = false;
    currentSpellingIndex++;
    if (currentSpellingIndex < spellingWords.length) {
        loadSpellingWord();
    } else {
        showSpellingResults();
    }
}
        
   async function submitSpelling() {
    const userAnswer = document.getElementById('spelling-input').value.trim().toLowerCase();
    const correctWord = currentSpellingWord.toLowerCase();
    const feedbackDiv = document.getElementById('spelling-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">âš ï¸ Please type a word before submitting</div>';
        return;
    }
    
    // Disable input while processing
    document.getElementById('spelling-input').disabled = true;
    
    if (userAnswer === correctWord) {
        spellingScore++;
        
        // Fetch word details to show origin
        feedbackDiv.innerHTML = '<div class="loading">âœ… Correct! Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentSpellingWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    âœ… <strong>Correct!</strong> The word is: <strong>${currentSpellingWord}</strong>
                    
                    ${currentUser ? `
                        <button class="practice-btn" onclick="saveSpellingFavorite('${currentSpellingWord}', '${userAnswer}', true)" 
                                style="margin-top: 15px; background: #ffd700; color: #0d3b66;">
                            â­ Add to Favorites
                        </button>
                    ` : ''}
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">ðŸ”Š Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">ðŸ“œ Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">ðŸ“ Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        âž¡ï¸ Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    âœ… Correct! The word is: <strong>${currentSpellingWord}</strong>
                    ${currentUser ? `
                        <button class="practice-btn" onclick="saveSpellingFavorite('${currentSpellingWord}', '${userAnswer}', true)" 
                                style="margin-top: 15px; background: #ffd700; color: #0d3b66;">
                            â­ Add to Favorites
                        </button>
                    ` : ''}
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        âž¡ï¸ Next Word
                    </button>
                </div>
            `;
        }
    } else {
        // Save incorrect answer automatically
        if (currentUser) {
            await saveSpellingIncorrect(currentSpellingWord, userAnswer);
        }
        
        spellingMistakes.push({
            word: currentSpellingWord,
            userAnswer: userAnswer
        });
        
        // Fetch word details to show origin
        feedbackDiv.innerHTML = '<div class="loading">âŒ Incorrect. Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentSpellingWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    âŒ <strong>Incorrect.</strong> You wrote: <strong>${userAnswer}</strong><br>
                    Correct spelling: <strong>${currentSpellingWord}</strong>
                    
                    ${currentUser ? '<p style="margin-top: 10px; color: #721c24; font-style: italic;">âœ… Automatically saved to Spelling Mistakes</p>' : ''}
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">ðŸ”Š Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">ðŸ“œ Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">ðŸ“ Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        âž¡ï¸ Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    âŒ Incorrect. You wrote: <strong>${userAnswer}</strong><br>
                    Correct spelling: <strong>${currentSpellingWord}</strong>
                    ${currentUser ? '<p style="margin-top: 10px; color: #721c24; font-style: italic;">âœ… Automatically saved to Spelling Mistakes</p>' : ''}
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        âž¡ï¸ Next Word
                    </button>
                </div>
            `;
        }
        
        // Speak the correct word again
        setTimeout(() => speakCurrentSpellingWord(), 1000);
    }
    
    // Show the word details button after attempt
    document.getElementById('show-details-btn').style.display = 'inline-block';
}

        
        async function skipSpellingWord() {
    spellingMistakes.push({
        word: currentSpellingWord,
        userAnswer: '(skipped)'
    });
    
    // Disable input while processing
    document.getElementById('spelling-input').disabled = true;
    
    const feedbackDiv = document.getElementById('spelling-feedback');
    feedbackDiv.innerHTML = '<div class="loading">â­ï¸ Loading word details...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentSpellingWord);
        
        feedbackDiv.innerHTML = `
            <div class="feedback" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
                â­ï¸ <strong>Skipped.</strong> The word was: <strong>${currentSpellingWord}</strong>
                
                <div style="margin-top: 15px; padding: 15px; background: #ffe8a1; border-radius: 8px;">
                    ${wordDetails.phonetic ? `
                        <div style="margin-bottom: 10px;">
                            <strong>ðŸ”Š Pronunciation:</strong>
                            <span style="font-style: italic; margin-left: 8px;">${wordDetails.phonetic}</span>
                        </div>
                    ` : ''}
                    
                    ${wordDetails.origin ? `
                        <div style="margin-bottom: 10px;">
                            <strong>ðŸ“œ Origin:</strong>
                            <span style="margin-left: 8px;">${wordDetails.origin}</span>
                        </div>
                    ` : ''}
                    
                    ${wordDetails.definition ? `
                        <div>
                            <strong>ðŸ“ Definition:</strong>
                            <span style="margin-left: 8px;">${wordDetails.definition}</span>
                        </div>
                    ` : ''}
                </div>
                
                <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    âž¡ï¸ Next Word
                </button>
            </div>
        `;
    } catch (error) {
        feedbackDiv.innerHTML = `
            <div class="feedback" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
                â­ï¸ Skipped. The word was: <strong>${currentSpellingWord}</strong>
                
                <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    âž¡ï¸ Next Word
                </button>
            </div>
        `;
    }
    
    speakCurrentSpellingWord();
    
    // Show the word details button after skip
    document.getElementById('show-details-btn').style.display = 'inline-block';
}
        
        
        function showSpellingResults() {
            document.getElementById('spelling-game').style.display = 'none';
            const resultsDiv = document.getElementById('spelling-results');
            resultsDiv.style.display = 'block';
            
            const percentage = Math.round((spellingScore / spellingWords.length) * 100);
            
            let message = '';
            let emoji = '';
            
            if (percentage >= 90) {
                message = 'Outstanding! You\'re a spelling champion!';
                emoji = 'ðŸ†';
            } else if (percentage >= 70) {
                message = 'Great job! Keep practicing!';
                emoji = 'â­';
            } else if (percentage >= 50) {
                message = 'Good effort! Practice makes perfect!';
                emoji = 'ðŸ‘';
            } else {
                message = 'Keep practicing! You\'ll improve!';
                emoji = 'ðŸ“š';
            }
            
            resultsDiv.innerHTML = `
                <div class="quiz-question-card" style="text-align: center;">
                    <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
                    <h2>Spelling Practice Complete!</h2>
                    <div class="quiz-score">Final Score: ${spellingScore} / ${spellingWords.length}</div>
                    <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
                    <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
                    
                    ${spellingMistakes.length > 0 ? `
                        <div style="margin: 30px 0; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                            <h3 style="color: #0d3b66; margin-bottom: 15px;">ðŸ“ Words to Review:</h3>
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                                ${spellingMistakes.map(mistake => `
                                    <div style="padding: 10px; margin: 5px 0; background: white; border-left: 3px solid #dc3545; border-radius: 5px;">
                                        <strong>${mistake.word}</strong> 
                                        <span style="color: #666;">- You wrote: ${mistake.userAnswer}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="startSpellingPracticeWithLevel()">ðŸ”„ Practice Again</button>
                    <button class="practice-btn" onclick="backToSpellingLevelSelection()">â† Back to Levels</button>
                    <button class="practice-btn" onclick="navigateTo('home')">ðŸ  Home</button>
                  </div>
                </div>
            `;
        }

        function restartSpellingSection() {
    document.getElementById('spelling-game').style.display = 'none';
    document.getElementById('spelling-results').style.display = 'none';
    document.getElementById('spelling-level-selection').style.display = 'block';
    selectedGameLevel = '';
}

    function switchSpellingMode(mode) {
    // Remove active from ALL spelling tabs
    const tabs = document.querySelectorAll('#spelling-section .quiz-tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    
    // Add active to clicked tab
    if (mode === 'practice') {
        tabs[0].classList.add('active');
    } else if (mode === 'unscramble') {
        tabs[1].classList.add('active');
    } else if (mode === 'live') {
        tabs[2].classList.add('active');
    } else if (mode === 'leaderboard') {
        tabs[3].classList.add('active');
    }

    // âœ… Remove active from ALL spelling modes
    document.querySelectorAll('#spelling-section .quiz-mode').forEach(m => {
        m.classList.remove('active');
    });

    // âœ… Show only the selected mode
    if (mode === 'practice') {
        document.getElementById('practice-spelling-mode').classList.add('active');
    } else if (mode === 'unscramble') {
        document.getElementById('unscramble-mode').classList.add('active');
    } else if (mode === 'live') {
        document.getElementById('live-spelling-mode').classList.add('active');
        
        if (currentUser) {
            initializeOnlinePresence();
            setTimeout(() => loadOnlineUsers(), 100);
        } else {
            alert('Please sign in to access live challenges');
            showAuthModal();
        }
    } else if (mode === 'leaderboard') {
        document.getElementById('leaderboard-spelling-mode').classList.add('active');
        loadSpellingLeaderboard();
    }
}

        // ===== SPELLING FAVORITES FUNCTIONS =====
async function loadUserSpellingFavorites(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('spellingFavorites').get();
        userSpellingFavorites = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displaySpellingFavorites();
        
        const btn = document.getElementById('spellingFavoritesQuizBtn');
        if (btn) {
            btn.disabled = userSpellingFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error loading spelling favorites:', error);
    }
}

async function saveSpellingFavorite(word, userAnswer, wasCorrect) {
    if (!currentUser) return;
    
    try {
        const favoriteRef = db.collection('users').doc(currentUser.uid).collection('spellingFavorites').doc(word);
        
        // Check if already exists
        const existingDoc = await favoriteRef.get();
        if (existingDoc.exists) {
            console.log('Word already in favorites');
            return;
        }
        
        await favoriteRef.set({
            word: word,
            userAnswer: userAnswer || '',
            wasCorrect: wasCorrect,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        userSpellingFavorites.push({
            id: word,
            word: word,
            userAnswer: userAnswer || '',
            wasCorrect: wasCorrect
        });
        
        displaySpellingFavorites();
        
        // Update button state if quiz button exists
        const btn = document.getElementById('spellingFavoritesQuizBtn');
        if (btn) {
            btn.disabled = userSpellingFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error saving spelling favorite:', error);
    }
}

function displaySpellingFavorites() {
    const container = document.getElementById('spelling-favorites-container');
    const btn = document.getElementById('spellingFavoritesQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to save spelling favorites</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userSpellingFavorites.length === 0) {
        container.innerHTML = '<div class="loading">No spelling favorites yet. Star words from spelling practice to add them here!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (btn) {
        btn.disabled = userSpellingFavorites.length < 5;
    }

    container.innerHTML = `
        ${userSpellingFavorites.length < 5 ? `
            <div class="loading">
                You have ${userSpellingFavorites.length} favorite(s). Add at least ${5 - userSpellingFavorites.length} more to generate a quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userSpellingFavorites.map(fav => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeSpellingFavorite('${fav.id}')">Ã—</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">ðŸ“ ${fav.word}</h3>
                    ${fav.userAnswer && fav.userAnswer !== '' ? `
                    <p style="color: #666; margin: 5px 0;"><strong>Your answer:</strong> ${fav.userAnswer}</p>
                     ` : `
                    <p style="color: #666; margin: 5px 0; font-style: italic;">Added for practice</p>
                    `}
                    <p style="color: ${fav.wasCorrect ? '#28a745' : '#dc3545'}; margin-top: 10px; font-weight: bold;">
                        ${fav.wasCorrect ? 'âœ… Spelled Correctly' : 'âŒ Needs Practice'}
                    </p>
                </div>
            `).join('')}
        </div>
    `;
}

async function removeSpellingFavorite(id) {
    if (!currentUser) return;

    await db.collection('users').doc(currentUser.uid).collection('spellingFavorites').doc(id).delete();
    userSpellingFavorites = userSpellingFavorites.filter(fav => fav.id !== id);
    displaySpellingFavorites();
}

async function startSpellingFavoritesQuiz() {
    if (userSpellingFavorites.length < 5) {
        alert('You need at least 5 spelling favorites to generate a quiz');
        return;
    }

    navigateTo('spelling', true);
    
    const selected = [...userSpellingFavorites].sort(() => 0.5 - Math.random()).slice(0, Math.min(10, userSpellingFavorites.length));
    
    spellingWords = selected.map(fav => fav.word);
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    document.querySelector('#spelling-container .welcome-section').style.display = 'none';
    document.getElementById('spelling-game').style.display = 'block';
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

// ===== SPELLING INCORRECT FUNCTIONS =====
async function loadUserSpellingIncorrect(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('spellingIncorrect').get();
        userSpellingIncorrect = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displaySpellingIncorrect();
        
        const btn = document.getElementById('spellingIncorrectQuizBtn');
        if (btn) {
            btn.disabled = userSpellingIncorrect.length < 5;
        }
    } catch (error) {
        console.error('Error loading spelling incorrect:', error);
    }
}

async function saveSpellingIncorrect(word, userAnswer) {
    if (!currentUser) return;
    
    try {
        const incorrectRef = db.collection('users').doc(currentUser.uid).collection('spellingIncorrect');
        
        await incorrectRef.add({
            word: word,
            userAnswer: userAnswer,
            savedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        userSpellingIncorrect.push({
            word: word,
            userAnswer: userAnswer
        });
        
        displaySpellingIncorrect();
    } catch (error) {
        console.error('Error saving spelling incorrect:', error);
    }
}

function displaySpellingIncorrect() {
    const container = document.getElementById('spelling-incorrect-container');
    const btn = document.getElementById('spellingIncorrectQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to track spelling mistakes</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userSpellingIncorrect.length === 0) {
        container.innerHTML = '<div class="loading">No spelling mistakes yet. Practice spelling to track your progress!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (btn) {
        btn.disabled = userSpellingIncorrect.length < 5;
    }

    container.innerHTML = `
        ${userSpellingIncorrect.length < 5 ? `
            <div class="loading">
                You have ${userSpellingIncorrect.length} mistake(s). Add at least ${5 - userSpellingIncorrect.length} more to generate a practice quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userSpellingIncorrect.map((inc, index) => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeSpellingIncorrect('${inc.id || index}')">Ã—</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">ðŸ“ ${inc.word}</h3>
                    <p style="color: #dc3545; margin: 5px 0;"><strong>Your answer:</strong> ${inc.userAnswer}</p>
                    <p style="color: #28a745; margin-top: 10px;"><strong>Correct spelling:</strong> ${inc.word}</p>
                </div>
            `).join('')}
        </div>
    `;
}

async function removeSpellingIncorrect(id) {
    if (!currentUser) return;

    await db.collection('users').doc(currentUser.uid).collection('spellingIncorrect').doc(id).delete();
    userSpellingIncorrect = userSpellingIncorrect.filter(inc => inc.id !== id);
    displaySpellingIncorrect();
}

async function startSpellingIncorrectQuiz() {
    if (userSpellingIncorrect.length < 5) {
        alert('You need at least 5 spelling mistakes to generate a practice quiz');
        return;
    }

    navigateTo('spelling', true);
    
    const selected = [...userSpellingIncorrect].sort(() => 0.5 - Math.random()).slice(0, Math.min(10, userSpellingIncorrect.length));
    
    spellingWords = selected.map(inc => inc.word);
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    document.querySelector('#spelling-container .welcome-section').style.display = 'none';
    document.getElementById('spelling-game').style.display = 'block';
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

async function addCurrentSpellingToFavorites() {
    if (!currentUser) {
        alert('Please sign in to save favorites');
        return;
    }
    
    if (!currentSpellingWord) return;
    
    const btn = document.getElementById('add-spelling-favorite-btn');
    const originalText = btn.textContent;
    
    btn.textContent = 'â³ Saving...';
    btn.disabled = true;
    
    try {
        await saveSpellingFavorite(currentSpellingWord, '', false);
        btn.textContent = 'âœ… Added!';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
    } catch (error) {
        console.error('Error saving favorite:', error);
        btn.textContent = 'âŒ Failed';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
    }
}



        // ===== DASHBOARD FUNCTIONS =====
async function goToUserDashboard() {
    if (!currentUser) {
        showAuthModal();
        return;
    }
    
    // Navigate to dashboard first
    navigateTo('student-dashboard');
    
    // Then load user data (with loading state)
    await loadUserDashboard();
}

async function loadUserDashboard() {
    if (!currentUser) return;
    
    try {
        // Show loading state
        document.getElementById('dashboard-name').textContent = 'Loading...';
        document.getElementById('dashboard-email').textContent = 'Loading...';
        
        // Get user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        // Update dashboard header
        const displayName = userData?.name || currentUser.displayName || 'Student';
        document.getElementById('dashboard-name').textContent = displayName;
        document.getElementById('dashboard-email').textContent = userData?.email || currentUser.email || '';
        
        // Update avatar with Google photo or initials
        const dashboardAvatar = document.getElementById('dashboard-avatar');
        if (currentUser.photoURL) {
            dashboardAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            dashboardAvatar.textContent = '';
        } else {
            dashboardAvatar.style.backgroundImage = 'none';
            dashboardAvatar.textContent = displayName.charAt(0).toUpperCase();
        }
        
        // Format join date
        if (userData?.createdAt) {
            const joinDate = userData.createdAt.toDate();
            document.getElementById('dashboard-join-date').textContent = 
                `Member since: ${joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;
            document.getElementById('display-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            // Fallback for accounts without createdAt
            document.getElementById('dashboard-join-date').textContent = 'Member since: Recently joined';
            document.getElementById('display-joined').textContent = 'Recently joined';
        }
        
        // Update profile fields
        document.getElementById('display-name').textContent = displayName;
        document.getElementById('edit-name').value = displayName;
        
        document.getElementById('display-email').textContent = userData?.email || currentUser.email || 'N/A';
        // Update Student ID
        const studentId = userData?.studentId || `WB-2025-${currentUser.uid.slice(-4).toUpperCase()}`;
        document.getElementById('display-student-id').textContent = studentId;
        document.getElementById('display-age').textContent = userData?.age || 'Not specified';
        document.getElementById('edit-age').value = userData?.age || '';
        
        document.getElementById('display-country').textContent = userData?.country || 'Not specified';
        document.getElementById('edit-country').value = userData?.country || '';
        
        document.getElementById('display-usertype').textContent = 
            userData?.userType ? userData.userType.charAt(0).toUpperCase() + userData.userType.slice(1) : 'Student';
        
        // ===== COACH-SPECIFIC RESTRICTIONS =====
        const isCoach = userData?.userType === 'coach';
        
        if (isCoach) {
            // Hide edit button for coaches
            document.getElementById('edit-profile-btn').style.display = 'none';
            
            // Hide delete account option for coaches
            const deleteAccountOption = document.querySelector('.setting-item[onclick="confirmDeleteAccount()"]');
            if (deleteAccountOption) {
                deleteAccountOption.style.display = 'none';
            }
            
            // Hide quiz mistakes and spelling mistakes navigation items for coaches
            const quizMistakesNav = document.querySelector('a[href="#quiz-mistakes"]');
            if (quizMistakesNav) {
                quizMistakesNav.style.display = 'none';
            }
            
            const spellingMistakesNav = document.querySelector('a[href="#spelling-mistakes"]');
            if (spellingMistakesNav) {
                spellingMistakesNav.style.display = 'none';
            }
        } else {
            // Show edit button for non-coaches (students)
            document.getElementById('edit-profile-btn').style.display = 'inline-block';
            
            // Show delete account option for non-coaches
            const deleteAccountOption = document.querySelector('.setting-item[onclick="confirmDeleteAccount()"]');
            if (deleteAccountOption) {
                deleteAccountOption.style.display = 'flex';
            }
            
            // Show quiz mistakes and spelling mistakes navigation items for students
            const quizMistakesNav = document.querySelector('a[href="#quiz-mistakes"]');
            if (quizMistakesNav) {
                quizMistakesNav.style.display = 'flex';
            }
            
            const spellingMistakesNav = document.querySelector('a[href="#spelling-mistakes"]');
            if (spellingMistakesNav) {
                spellingMistakesNav.style.display = 'flex';
            }
        }
        
        // Update stats (wait for them to be loaded)
        setTimeout(() => {
            document.getElementById('stat-quiz-favorites').textContent = userFavorites.length;
            document.getElementById('stat-quiz-incorrect').textContent = userIncorrect.length;
            document.getElementById('stat-spelling-favorites').textContent = userSpellingFavorites.length;
            document.getElementById('stat-spelling-incorrect').textContent = userSpellingIncorrect.length;
            
            // âœ… UPDATE SUBSCRIPTION STATUS
            updateDashboardSubscriptionStatus();
        }, 500);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('dashboard-name').textContent = 'Error loading profile';
        document.getElementById('dashboard-email').textContent = 'Please try refreshing';
    }
}
        
        // ===== PASSWORD CHANGE FUNCTIONS =====
function showChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.add('active');
    
    // Clear form
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}

function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('active');
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}

async function handleChangePassword(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Please sign in to change password');
        return;
    }
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-new-password').value;
    
    const errorDiv = document.getElementById('change-password-error');
    const successDiv = document.getElementById('change-password-success');
    
    // Hide previous messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'New passwords do not match!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate new password is different
    if (currentPassword === newPassword) {
        errorDiv.textContent = 'New password must be different from current password!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate password strength
    if (newPassword.length < 6) {
        errorDiv.textContent = 'New password must be at least 6 characters!';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Re-authenticate user with current password
        const credential = firebase.auth.EmailAuthProvider.credential(
            currentUser.email,
            currentPassword
        );
        
        await currentUser.reauthenticateWithCredential(credential);
        
        // Update password
        await currentUser.updatePassword(newPassword);
        
        // Success!
        successDiv.textContent = 'âœ… Password changed successfully!';
        successDiv.style.display = 'block';
        
        // Clear form
        document.getElementById('change-password-form').reset();
        
        // Close modal after 2 seconds
        setTimeout(() => {
            closeChangePasswordModal();
        }, 2000);
        
    } catch (error) {
        console.error('Error changing password:', error);
        
        let errorMessage = 'Failed to change password. ';
        
        if (error.code === 'auth/wrong-password') {
            errorMessage += 'Current password is incorrect.';
        } else if (error.code === 'auth/weak-password') {
            errorMessage += 'New password is too weak.';
        } else if (error.code === 'auth/requires-recent-login') {
            errorMessage += 'Please sign out and sign in again, then try changing your password.';
        } else {
            errorMessage += error.message;
        }
        
        errorDiv.textContent = errorMessage;
        errorDiv.style.display = 'block';
    }
}

// Special handling for Google sign-in users
async function handlePasswordChangeForGoogleUsers() {
    if (currentUser && currentUser.providerData.length > 0) {
        const provider = currentUser.providerData[0].providerId;
        
        if (provider === 'google.com') {
            alert('You signed in with Google. To change your password, please go to your Google Account settings.');
            return true; // Indicates Google user
        }
    }
    return false; // Not a Google user
}

// Update showChangePasswordModal to check for Google users
function showChangePasswordModal() {
    // Check if user signed in with Google
    if (currentUser && currentUser.providerData.length > 0) {
        const provider = currentUser.providerData[0].providerId;
        
        if (provider === 'google.com') {
            alert('ðŸ” You signed in with Google.\n\nTo change your password, please visit:\nhttps://myaccount.google.com/security');
            return;
        }
    }
    
    document.getElementById('changePasswordModal').classList.add('active');
    
    // Clear form
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}
        
async function toggleEditMode() {
    // Check if user is a coach
    if (currentUser) {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData?.userType === 'coach') {
                alert('ðŸ›¡ï¸ Coach profiles cannot be edited.\n\nFor security reasons, coach account information is locked after ID verification.\n\nPlease contact support if you need to update your information.');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // Hide display elements, show edit inputs (for students only)
    document.getElementById('display-name').style.display = 'none';
    document.getElementById('edit-name').style.display = 'block';
    
    document.getElementById('display-age').style.display = 'none';
    document.getElementById('edit-age').style.display = 'block';
    
    document.getElementById('display-country').style.display = 'none';
    document.getElementById('edit-country').style.display = 'block';
    
    // Toggle buttons
    document.getElementById('edit-profile-btn').style.display = 'none';
    document.getElementById('save-profile-btn').style.display = 'inline-block';
    document.getElementById('cancel-edit-btn').style.display = 'inline-block';
}

function cancelEditMode() {
    // Show display elements, hide edit inputs
    document.getElementById('display-name').style.display = 'inline';
    document.getElementById('edit-name').style.display = 'none';
    
    document.getElementById('display-age').style.display = 'inline';
    document.getElementById('edit-age').style.display = 'none';
    
    document.getElementById('display-country').style.display = 'inline';
    document.getElementById('edit-country').style.display = 'none';
    
    // Toggle buttons
    document.getElementById('edit-profile-btn').style.display = 'inline-block';
    document.getElementById('save-profile-btn').style.display = 'none';
    document.getElementById('cancel-edit-btn').style.display = 'none';
    
    document.getElementById('profile-form').classList.remove('edit-mode');
}

async function saveProfile() {
    if (!currentUser) return;
    
    const newName = document.getElementById('edit-name').value.trim();
    const newAge = document.getElementById('edit-age').value;
    const newCountry = document.getElementById('edit-country').value;
    
    if (!newName) {
        alert('Name cannot be empty');
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            name: newName,
            age: newAge,
            country: newCountry
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: newName });
        
        // Update UI
        document.getElementById('display-name').textContent = newName;
        document.getElementById('display-age').textContent = newAge;
        document.getElementById('display-country').textContent = newCountry;
        
        // Update dashboard header
        document.getElementById('dashboard-name').textContent = newName;
        const dashboardAvatar = document.getElementById('dashboard-avatar');
        if (currentUser.photoURL) {
            dashboardAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            dashboardAvatar.textContent = '';
        } else {
            dashboardAvatar.style.backgroundImage = 'none';
            dashboardAvatar.textContent = newName.charAt(0).toUpperCase();
        }
        
        // Update sidebar
        document.getElementById('sidebarUserName').textContent = newName;
        const sidebarAvatar = document.getElementById('sidebarUserAvatar');
        if (currentUser.photoURL) {
            sidebarAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            sidebarAvatar.textContent = '';
        } else {
            sidebarAvatar.style.backgroundImage = 'none';
            sidebarAvatar.textContent = newName.charAt(0).toUpperCase();
        }
        
        cancelEditMode();
        alert('Profile updated successfully!');
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
}

        function showChangePasswordModal() {
    alert('Change password feature coming soon! For now, you can reset your password using the "Forgot Password" link on the sign-in page.');
}

async function confirmDeleteAccount() {
    if (!currentUser) return;
    
    // Check if user is a coach
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData?.userType === 'coach') {
            alert('ðŸ›¡ï¸ Coach accounts cannot be deleted.\n\nFor security and compliance reasons, coach accounts must be deactivated by an administrator.\n\nPlease contact support if you need to deactivate your account.');
            return;
        }
    } catch (error) {
        console.error('Error checking user type:', error);
    }
    
    // Proceed with deletion for non-coach users
    if (confirm('âš ï¸ WARNING: This will permanently delete your account and all your data. This action cannot be undone.\n\nAre you absolutely sure?')) {
        if (confirm('Final confirmation: Delete your account forever?')) {
            deleteUserAccount();
        }
    }
}

async function deleteUserAccount() {
    if (!currentUser) return;
    
    try {
        // Delete user data from Firestore
        await db.collection('users').doc(currentUser.uid).delete();
        
        // Delete user subcollections
        const collections = ['favorites', 'incorrectQuestions', 'spellingFavorites', 'spellingIncorrect'];
        for (const collection of collections) {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection(collection).get();
            const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);
        }
        
        // Delete Firebase Auth account
        await currentUser.delete();
        
        alert('Your account has been successfully deleted.');
        navigateTo('home');
    } catch (error) {
        console.error('Error deleting account:', error);
        alert('Failed to delete account: ' + error.message);
    }
}

     function typeKey(letter) {
    const input = document.getElementById('spelling-input');
    if (input.disabled) return;
    input.value += letter.toLowerCase();
}

function backspaceKey() {
    const input = document.getElementById('spelling-input');
    if (input.disabled) return;
    input.value = input.value.slice(0, -1);
}  

// ===== UNSCRAMBLE FUNCTIONS =====
async function startUnscrambleWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection and show loading
    document.getElementById('unscramble-level-selection').style.display = 'none';
    const gameContainer = document.getElementById('unscramble-game');
    gameContainer.innerHTML = '<div class="loading">ðŸ“š Loading ' + level.toUpperCase() + ' words...</div>';
    gameContainer.style.display = 'block';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    // Select 10 random words from the entire level (no difficulty filtering)
    if (allWords.length < 10) {
        alert('Not enough words in this level. Try another level.');
        document.getElementById('unscramble-level-selection').style.display = 'block';
        gameContainer.style.display = 'none';
        return;
    }
    
    const shuffled = [...allWords].sort(() => 0.5 - Math.random());
    unscrambleWords = shuffled.slice(0, 10);
    
    currentUnscrambleIndex = 0;
    unscrambleScore = 0;
    hintsUsed = 0;
    
    // Clear the loading message and restore the game UI
    gameContainer.innerHTML = `
        <div class="quiz-question-card">
            <div class="quiz-score" id="unscramble-score">Score: 0 / 0</div>
            <h3 id="unscramble-progress">Word 1 of 10</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                
                <div id="letter-tiles" class="letter-tiles-container">
                    <!-- Letter tiles will be inserted here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="shuffleLetters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                        ðŸ”€ Shuffle
                    </button>
                    
                    <button class="practice-btn" onclick="showUnscrambleHint()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px; background: #17a2b8;">
                        ðŸ’¡ Hint
                    </button>
                    
                    <button class="practice-btn" onclick="submitUnscramble()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        âœ“ Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="unscramble-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
    
    document.getElementById('unscramble-results').style.display = 'none';
    
    loadUnscrambleWord();
}
function backToUnscrambleLevelSelection() {
    document.getElementById('unscramble-level-selection').style.display = 'block';
    document.getElementById('unscramble-game').style.display = 'none';
    document.getElementById('unscramble-results').style.display = 'none';
    selectedGameLevel = '';
}

// Keep old function for backwards compatibility
function startUnscramble() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    startUnscrambleWithLevel(selectedGameLevel);
}
        
function loadUnscrambleWord() {
    currentUnscrambleWord = unscrambleWords[currentUnscrambleIndex];
    hintsUsed = 0;
    
    document.getElementById('unscramble-progress').textContent = 
        `Word ${currentUnscrambleIndex + 1} of ${unscrambleWords.length}`;
    document.getElementById('unscramble-score').textContent = 
        `Score: ${unscrambleScore} / ${currentUnscrambleIndex}`;
    document.getElementById('unscramble-feedback').innerHTML = '';
    
    // Scramble and display letters
    shuffleLetters();
}

function shuffleLetters() {
    const letters = currentUnscrambleWord.split('');
    let scrambled = [...letters];
    
    // Shuffle the array
    let attempts = 0;
    do {
        for (let i = scrambled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
        }
        attempts++;
    } while (scrambled.join('') === currentUnscrambleWord && attempts < 10);
    
    currentLetterOrder = scrambled;
    renderLetterTiles();
}

function renderLetterTiles() {
    const container = document.getElementById('letter-tiles');
    container.innerHTML = '';
    
    currentLetterOrder.forEach((letter, index) => {
        const tile = document.createElement('div');
        tile.className = 'letter-tile';
        tile.textContent = letter.toUpperCase();
        tile.draggable = true;
        tile.dataset.index = index;
        
        // Drag events
        tile.addEventListener('dragstart', handleDragStart);
        tile.addEventListener('dragend', handleDragEnd);
        tile.addEventListener('dragover', handleDragOver);
        tile.addEventListener('drop', handleDrop);
        tile.addEventListener('dragenter', handleDragEnter);
        tile.addEventListener('dragleave', handleDragLeave);
        
        // Touch events for mobile
        tile.addEventListener('touchstart', handleTouchStart, { passive: false });
        tile.addEventListener('touchmove', handleTouchMove, { passive: false });
        tile.addEventListener('touchend', handleTouchEnd);
        
        container.appendChild(tile);
    });
}

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    
    // Remove drag-over class from all tiles
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    this.classList.remove('drag-over');
    
    if (draggedElement !== this) {
        const draggedIndex = parseInt(draggedElement.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        
        // Swap letters in the array
        [currentLetterOrder[draggedIndex], currentLetterOrder[targetIndex]] = 
        [currentLetterOrder[targetIndex], currentLetterOrder[draggedIndex]];
        
        // Re-render
        renderLetterTiles();
    }
    
    return false;
}

// Touch support for mobile
let touchTarget = null;
let touchClone = null;

function handleTouchStart(e) {
    e.preventDefault();
    touchTarget = this;
    this.classList.add('dragging');
    
    // Create a clone for visual feedback
    touchClone = this.cloneNode(true);
    touchClone.style.position = 'fixed';
    touchClone.style.zIndex = '10000';
    touchClone.style.pointerEvents = 'none';
    touchClone.style.opacity = '0.8';
    document.body.appendChild(touchClone);
    
    updateTouchClonePosition(e.touches[0]);
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!touchTarget) return;
    
    updateTouchClonePosition(e.touches[0]);
    
    // Find element under touch
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    // Remove drag-over from all
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    // Add drag-over to element below
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== touchTarget) {
        elementBelow.classList.add('drag-over');
    }
}

function handleTouchEnd(e) {
    e.preventDefault();
    if (!touchTarget) return;
    
    touchTarget.classList.remove('dragging');
    
    // Remove clone
    if (touchClone) {
        touchClone.remove();
        touchClone = null;
    }
    
    // Find element under touch
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== touchTarget) {
        const draggedIndex = parseInt(touchTarget.dataset.index);
        const targetIndex = parseInt(elementBelow.dataset.index);
        
        // Swap letters
        [currentLetterOrder[draggedIndex], currentLetterOrder[targetIndex]] = 
        [currentLetterOrder[targetIndex], currentLetterOrder[draggedIndex]];
        
        // Re-render
        renderLetterTiles();
    }
    
    // Remove drag-over from all
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    touchTarget = null;
}

function updateTouchClonePosition(touch) {
    if (touchClone) {
        touchClone.style.left = (touch.clientX - 30) + 'px';
        touchClone.style.top = (touch.clientY - 30) + 'px';
    }
}

async function showUnscrambleHint() {
    hintsUsed++;
    const feedbackDiv = document.getElementById('unscramble-feedback');
    
    feedbackDiv.innerHTML = '<div class="loading">ðŸ’¡ Loading hint...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentUnscrambleWord);
        
        let hintText = '';
        if (hintsUsed === 1) {
            // First hint: Show first letter
            hintText = `The word starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else if (hintsUsed === 2) {
            // Second hint: Show word length and first letter
            hintText = `The word has <strong>${currentUnscrambleWord.length} letters</strong> and starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else {
            // Third hint: Show definition
            hintText = `<strong>Definition:</strong> ${wordDetails.definition || 'A word you should know!'}`;
        }
        
        feedbackDiv.innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">ðŸ’¡ Hint ${hintsUsed}:</strong>
                <p style="color: #856404; margin-top: 8px;">${hintText}</p>
            </div>
        `;
    } catch (error) {
        console.error('Error showing hint:', error);
        let hintText = '';
        if (hintsUsed === 1) {
            hintText = `The word starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else {
            hintText = `The word has <strong>${currentUnscrambleWord.length} letters</strong>`;
        }
        
        feedbackDiv.innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">ðŸ’¡ Hint:</strong>
                <p style="color: #856404; margin-top: 8px;">${hintText}</p>
            </div>
        `;
    }
}

async function submitUnscramble() {
    const userWord = currentLetterOrder.join('').toLowerCase();
    const correctWord = currentUnscrambleWord.toLowerCase();
    const feedbackDiv = document.getElementById('unscramble-feedback');
    
    if (userWord === correctWord) {
        unscrambleScore++;
        
        feedbackDiv.innerHTML = '<div class="loading">âœ… Correct! Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentUnscrambleWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    âœ… <strong>Correct!</strong> The word is: <strong>${currentUnscrambleWord}</strong>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">ðŸ”Š Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">ðŸ“œ Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">ðŸ“ Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        âž¡ï¸ Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    âœ… <strong>Correct!</strong> The word is: <strong>${currentUnscrambleWord}</strong>
                    
                    <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        âž¡ï¸ Next Word
                    </button>
                </div>
            `;
        }
    } else {
        feedbackDiv.innerHTML = `
            <div class="feedback error">
                âŒ <strong>Incorrect.</strong> The correct word is: <strong>${correctWord.toUpperCase()}</strong>
                <p style="margin-top: 10px;">Your answer: <strong>${userWord.toUpperCase()}</strong></p>
                
                <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    âž¡ï¸ Next Word
                </button>
            </div>
        `;
    }
}

        
function nextUnscrambleWord() {
    currentUnscrambleIndex++;
    if (currentUnscrambleIndex < unscrambleWords.length) {
        loadUnscrambleWord();
    } else {
        showUnscrambleResults();
    }
}

function showUnscrambleResults() {
    document.getElementById('unscramble-game').style.display = 'none';
    const resultsDiv = document.getElementById('unscramble-results');
    resultsDiv.style.display = 'block';
    
    const percentage = Math.round((unscrambleScore / unscrambleWords.length) * 100);
    
    let message = '';
    let emoji = '';
    
    if (percentage >= 90) {
        message = 'Outstanding! You\'re a word master!';
        emoji = 'ðŸ†';
    } else if (percentage >= 70) {
        message = 'Great job! Keep it up!';
        emoji = 'â­';
    } else if (percentage >= 50) {
        message = 'Good effort! Practice makes perfect!';
        emoji = 'ðŸ‘';
    } else {
        message = 'Keep practicing! You\'ll improve!';
        emoji = 'ðŸ“š';
    }
    
    resultsDiv.innerHTML = `
        <div class="quiz-question-card" style="text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
            <h2>Unscramble Complete!</h2>
            <div class="quiz-score">Final Score: ${unscrambleScore} / ${unscrambleWords.length}</div>
            <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
            <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
            <button class="practice-btn" onclick="startUnscrambleWithLevel()">ðŸ”„ Try Again</button>
            <button class="practice-btn" onclick="backToUnscrambleLevelSelection()">â† Back to Levels</button>
            <button class="practice-btn" onclick="navigateTo('home')">ðŸ  Home</button>
           </div>
        </div>
    `;
}

function restartUnscrambleSection() {
    document.getElementById('unscramble-game').style.display = 'none';
    document.getElementById('unscramble-results').style.display = 'none';
    document.getElementById('unscramble-level-selection').style.display = 'block';
    selectedGameLevel = '';
}

   // ===== COACHES DISPLAY FUNCTIONS =====
async function loadAndDisplayCoaches() {
    const container = document.getElementById('coaches-container');
    
    try {
        container.innerHTML = '<div class="loading">ðŸ“š Loading coaches...</div>';
        
        console.log('ðŸ” Fetching coaches from Firestore...');
        
        // Fetch all coaches from Firestore
        const coachesSnapshot = await db.collection('users')
            .where('userType', '==', 'coach')
            .get();
        
        console.log('ðŸ“Š Found coaches:', coachesSnapshot.size);
        
        if (coachesSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ‘¨â€ðŸ«</div>
                    <h3>No coaches registered yet</h3>
                    <p>Be the first to join as a coach!</p>
                </div>
            `;
            return;
        }
        
        const coaches = [];
        coachesSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('ðŸ‘¤ Coach:', doc.id, data.name, data.photoURL);
            coaches.push({ id: doc.id, ...data });
        });
        
        // Sort coaches (newest first)
        coaches.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate stats
        const totalCoaches = coaches.length;
        const verifiedCoaches = coaches.filter(c => c.idVerified).length;
        const pendingCoaches = totalCoaches - verifiedCoaches;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Cards -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalCoaches}</div>
                    <div class="stat-label">Total Coaches</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${verifiedCoaches}</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${pendingCoaches}</div>
                    <div class="stat-label">â³ Pending</div>
                </div>
            </div>
            
            <!-- Coaches Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>ðŸ‘¨â€ðŸ« Coach</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => {
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (coach.photoURL) {
                                avatarStyle = `style="background-image: url('${coach.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (coach.name || 'C').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showCoachDetailById('${coach.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${coach.name || 'Unknown Coach'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        ${coach.idVerified ? 
                                            '<span class="verified-badge">Verified</span>' : 
                                            '<span class="unverified-badge">â³ Pending</span>'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">ðŸ›¡ï¸ Safety & Verification</h3>
                <p style="color: #666; line-height: 1.6;">
                    All coaches on WordBiz Coaching Academy undergo ID verification for student safety. 
                    Click on any coach to view their full profile and verification details.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('âŒ Error loading coaches:', error);
        container.innerHTML = `
            <div class="feedback error">
                âŒ Error loading coaches. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayCoaches()">ðŸ”„ Retry</button>
            </div>
        `;
    }
}

// Load and show coach profile modal
async function showCoachDetailById(coachId) {
    try {
        console.log('ðŸ“‹ Loading coach details for:', coachId);
        const coachDoc = await db.collection('users').doc(coachId).get();
        
        if (coachDoc.exists) {
            const coach = { id: coachDoc.id, ...coachDoc.data() };
            console.log('Coach data loaded:', coach);
            showCoachDetail(coach);
        } else {
            console.error('âŒ Coach not found');
            alert('Coach profile not found');
        }
    } catch (error) {
        console.error('âŒ Error loading coach details:', error);
        alert('Unable to load coach details: ' + error.message);
    }
}

// Display coach detail modal
function showCoachDetail(coach) {
    console.log('Displaying coach modal:', coach.name);
    const modal = document.getElementById('coachDetailModal');
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-coach-avatar');
    if (coach.photoURL) {
        console.log('ðŸ–¼ï¸ Setting photo URL:', coach.photoURL);
        avatar.style.backgroundImage = `url('${coach.photoURL}')`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.textContent = '';
    } else {
        console.log('ðŸ”¤ No photo URL, using initial');
        avatar.style.backgroundImage = 'none';
        avatar.textContent = (coach.name || 'C').charAt(0).toUpperCase();
    }
    
    // Update name
    document.getElementById('modal-coach-name').textContent = coach.name || 'Unknown Coach';
    
    // Update status badge
    const statusBadge = document.getElementById('modal-coach-status');
    if (coach.idVerified) {
        statusBadge.className = 'status-badge verified';
        statusBadge.textContent = 'Verified';
    } else {
        statusBadge.className = 'status-badge pending';
        statusBadge.textContent = 'â³ Pending Verification';
    }
    
    // Update email
    document.getElementById('modal-coach-email').textContent = coach.email || 'N/A';
    
    // Update organization
    document.getElementById('modal-coach-organization').textContent = coach.organization || 'Independent';
    
    // Update joined date
    if (coach.createdAt) {
        const joinDate = coach.createdAt.toDate();
        document.getElementById('modal-coach-joined').textContent = 
            joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } else {
        document.getElementById('modal-coach-joined').textContent = 'Recently';
    }
    
    // Show/hide age if available
    const ageRow = document.getElementById('modal-coach-age-row');
    if (coach.verifiedAge) {
        ageRow.style.display = 'flex';
        document.getElementById('modal-coach-age').textContent = coach.verifiedAge + ' years old';
    } else {
        ageRow.style.display = 'none';
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('Modal displayed');
}

// Close coach detail modal
function closeCoachDetailModal() {
    document.getElementById('coachDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('coachDetailModal');
    if (event.target === modal) {
        closeCoachDetailModal();
    }
});

     
// ===== STUDENTS DISPLAY FUNCTIONS =====
async function loadAndDisplayStudents() {
    const container = document.getElementById('students-container');
    
    try {
        container.innerHTML = '<div class="loading">ðŸ“š Loading students...</div>';
        
        console.log('ðŸ” Fetching students from Firestore...');
        
        // Fetch all students from Firestore
        const studentsSnapshot = await db.collection('users')
            .where('userType', '==', 'student')
            .get();
        
        console.log('ðŸ“Š Found students:', studentsSnapshot.size);
        
        if (studentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ðŸŽ“</div>
                    <h3>No students registered yet</h3>
                    <p>Be the first to join as a student!</p>
                </div>
            `;
            return;
        }
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('ðŸ‘¤ Student:', doc.id, data.name, data.photoURL);
            students.push({ id: doc.id, ...data });
        });
        
        // Sort students (newest first)
        students.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate total students
        const totalStudents = students.length;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Card -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            </div>
            
            <!-- Students Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>ðŸŽ“ Student</th>
                            <th>ðŸ†” Student ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => {
                            // Generate Student ID (WB-2025-XXXX)
                            const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
                            
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (student.photoURL) {
                                avatarStyle = `style="background-image: url('${student.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (student.name || 'S').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showStudentDetailById('${student.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${student.name || 'Student'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span style="font-family: monospace; background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: #0d3b66;">
                                            ${studentId}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                <h3 style="color: white; margin-bottom: 10px;">ðŸŒŸ Growing Community</h3>
                <p style="color: rgba(255,255,255,0.95); line-height: 1.6;">
                    Our students are learning from coaches around the world, building vocabulary skills 
                    through interactive quizzes, spelling challenges, and personalized practice sessions.
                    Click on any student to view their full profile.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('âŒ Error loading students:', error);
        container.innerHTML = `
            <div class="feedback error">
                âŒ Error loading students. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayStudents()">ðŸ”„ Retry</button>
            </div>
        `;
    }
}
        
// Load and show student profile modal
async function showStudentDetailById(studentId) {
    try {
        console.log('ðŸ“‹ Loading student details for:', studentId);
        const studentDoc = await db.collection('users').doc(studentId).get();
        
        if (studentDoc.exists) {
            const student = { id: studentDoc.id, ...studentDoc.data() };
            console.log('Student data loaded:', student);
            showStudentDetail(student);
        } else {
            console.error('âŒ Student not found');
            alert('Student profile not found');
        }
    } catch (error) {
        console.error('âŒ Error loading student details:', error);
        alert('Unable to load student details: ' + error.message);
    }
}

// Display student detail modal
function showStudentDetail(student) {
    console.log('Displaying student modal:', student.name);
    const modal = document.getElementById('studentDetailModal');
    
    // Generate Student ID
    const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-student-avatar');
    if (student.photoURL) {
        console.log('ðŸ–¼ï¸ Setting photo URL:', student.photoURL);
        avatar.style.backgroundImage = `url('${student.photoURL}')`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.textContent = '';
    } else {
        console.log('ðŸ”¤ No photo URL, using initial');
        avatar.style.backgroundImage = 'none';
        avatar.textContent = (student.name || 'S').charAt(0).toUpperCase();
    }
    
    // Update name
    document.getElementById('modal-student-name').textContent = student.name || 'Student';
    
    // Update Student ID (both places)
    document.getElementById('modal-student-id').textContent = studentId;
    document.getElementById('modal-student-id-display').textContent = studentId;
    
    // Update email
    document.getElementById('modal-student-email').textContent = student.email || 'N/A';
    
    // Update age
    const ageRow = document.getElementById('modal-student-age-row');
    if (student.age) {
        ageRow.style.display = 'flex';
        document.getElementById('modal-student-age').textContent = student.age + ' years old';
    } else {
        ageRow.style.display = 'none';
    }
    
    // Update country
    document.getElementById('modal-student-country').textContent = student.country || 'N/A';
    
    // Update joined date
    if (student.createdAt) {
        const joinDate = student.createdAt.toDate();
        document.getElementById('modal-student-joined').textContent = 
            joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } else {
        document.getElementById('modal-student-joined').textContent = 'Recently';
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('Modal displayed');
}

// Close student detail modal
function closeStudentDetailModal() {
    document.getElementById('studentDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('studentDetailModal');
    if (event.target === modal) {
        closeStudentDetailModal();
    }
});

// ===== LIVE SPELLING FUNCTIONS =====
async function initializeOnlinePresence() {
    if (!currentUser) return;
    
    // âœ… CRITICAL: Prevent multiple initializations
    if (presenceInitialized) {
        console.log('Presence already initialized');
        return;
    }
    
    presenceInitialized = true;
    console.log('âœ… Initializing online presence for:', currentUser.uid);
    
    try {
        // Set user as online
        presenceRef = db.collection('onlineUsers').doc(currentUser.uid);
        
        await presenceRef.set({
            userId: currentUser.uid,
            name: currentUser.displayName || 'Student',
            photoURL: currentUser.photoURL || null,
            status: 'online',
            lastSeen: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Listen for incoming challenges (only once)
        listenForChallenges();
        
        // Listen for MY challenges being accepted (only once)
        listenForMyChallengesAccepted();
        
        // Update presence every 30 seconds
        setInterval(async () => {
            if (currentUser && presenceRef) {
                try {
                    await presenceRef.update({
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error updating presence:', error);
                }
            }
        }, 30000);
        
        console.log('âœ… Presence initialized successfully');
    } catch (error) {
        console.error('âŒ Error initializing presence:', error);
        presenceInitialized = false; // Reset on error
    }
}

async function removeOnlinePresence() {
    try {
        console.log('ðŸ§¹ Removing online presence...');
        
        // Remove challenge listeners
        if (challengeListener) {
            challengeListener();
            challengeListener = null;
        }
        if (myChallengeListener) {
            myChallengeListener();
            myChallengeListener = null;
        }
        // âœ… Add this
        if (onlineUsersRef) {
            onlineUsersRef();
            onlineUsersRef = null;
        }
        
        // Remove from online users
        if (presenceRef) {
            await presenceRef.delete();
            presenceRef = null;
        }
        
        // Reset flag
        presenceInitialized = false;
        
        console.log('âœ… Presence removed successfully');
    } catch (error) {
        console.error('Error removing presence:', error);
    }
}
        


async function loadOnlineUsers() {
    if (!currentUser) {
        const listElement = document.getElementById('online-users-list');
        if (listElement) {
            listElement.innerHTML = '<div class="loading">Please sign in to see online users</div>';
        }
        return;
    }
    
    try {
        // âœ… Detach existing listener before creating new one
        if (onlineUsersRef) {
            onlineUsersRef();
            onlineUsersRef = null;
        }
        
        onlineUsersRef = db.collection('onlineUsers')
            .where('userId', '!=', currentUser.uid)
            .onSnapshot(snapshot => {
                const users = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lastSeen = data.lastSeen?.toDate() || new Date(0);
                    const now = new Date();
                    const diffMinutes = (now - lastSeen) / 1000 / 60;
                    
                    if (diffMinutes < 2) {
                        users.push({ id: doc.id, ...data });
                    }
                });
                
                // âœ… Check if elements exist before updating
                const countElement = document.getElementById('online-count');
                const listElement = document.getElementById('online-users-list');
                
                if (!countElement || !listElement) {
                    // Elements don't exist, user navigated away - detach listener
                    if (onlineUsersRef) {
                        onlineUsersRef();
                        onlineUsersRef = null;
                    }
                    return;
                }
                
                countElement.textContent = users.length;
                
                if (users.length === 0) {
                    listElement.innerHTML = `
                        <div class="loading">
                            No other students online right now. <br>
                            Share the app with friends to challenge them!
                        </div>
                    `;
                } else {
                    displayOnlineUsers(users);
                }
            });
    } catch (error) {
        console.error('Error loading online users:', error);
    }
}

function displayOnlineUsers(users) {
    const container = document.getElementById('online-users-list');
    
    container.innerHTML = users.map(user => {
        let avatarHTML = '';
        
        if (user.photoURL) {
            avatarHTML = `<div style="background-image: url('${user.photoURL}'); background-size: cover; background-position: center; width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px;"></div>`;
        } else {
            const initial = (user.name || 'S').charAt(0).toUpperCase();
            avatarHTML = `<div class="user-avatar" style="margin: 0 auto 10px;">${initial}</div>`;
        }
        
        return `
            <div class="online-user-card" data-user-id="${user.userId}" data-user-name="${user.name}" onclick="sendChallenge(this.dataset.userId, this.dataset.userName)">
                ${avatarHTML}
                <h3 style="color: #0d3b66; margin: 10px 0;">${user.name}</h3>
                <span class="online-status"></span>
                <span style="color: #28a745; font-weight: bold;">Online</span>
                <button class="practice-btn" style="margin-top: 15px; font-size: 0.9rem; padding: 10px 20px; pointer-events: none;">
                    âš”ï¸ Challenge
                </button>
            </div>
        `;
    }).join('');
}

// ===== REPLACE THE sendChallenge FUNCTION =====
// ===== REPLACE THE sendChallenge FUNCTION =====
async function sendChallenge(opponentId, opponentName) {
    if (!currentUser) return;
    
    try {
        const challengeRef = db.collection('challenges').doc();
        
        await challengeRef.set({
            challenger: {
                id: currentUser.uid,
                name: currentUser.displayName || 'Student',
                photoURL: currentUser.photoURL || null
            },
            opponent: {
                id: opponentId,
                name: opponentName
            },
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // âœ… Show message and auto-hide after 3 seconds
        showCustomPopup(`âš”ï¸ SENT TO ${opponentName.toUpperCase()}`);
        setTimeout(() => hideCustomPopup(), 3000);
        
    } catch (error) {
        console.error('Error sending challenge:', error);
        showCustomPopup('âŒ FAILED TO SEND');
        setTimeout(() => hideCustomPopup(), 2000);
    }
}

function listenForChallenges() {
    if (!currentUser) return;
    
    // Detach existing listener
    if (challengeListener) {
        challengeListener();
    }
    
    challengeListener = db.collection('challenges')
        .where('opponent.id', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                const challenge = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'added' || change.type === 'modified') {
                    if (challenge.status === 'pending') {
                        // âœ… CHECK IF ALREADY DECLINED
                        if (declinedChallengeIds.has(challenge.id)) {
                            console.log('ðŸš« Challenge already declined - skipping');
                            return;
                        }
                        
                        // âœ… CHECK IF CHALLENGER IS STILL ONLINE
                        const challengerId = challenge.challenger.id;
                        const challengerPresence = await db.collection('onlineUsers').doc(challengerId).get();
                        
                        if (!challengerPresence.exists) {
                            // Challenger went offline - delete the challenge
                            console.log('ðŸš« Challenger went offline - removing challenge');
                            await db.collection('challenges').doc(challenge.id).delete();
                            
                            // Remove popup if exists
                            const popup = document.getElementById('challenge-popup-notification');
                            if (popup) popup.remove();
                            
                            // Remove from shown set
                            shownPopupIds.delete(challenge.id);
                            
                            return;
                        }
                        
                        // Challenger is online - show challenge
                        showChallengePopup(challenge);
                        displayIncomingChallenges([challenge]);
                    } else if (challenge.status === 'active') {
                        // This handles the case where challenge is accepted
                        // But we already start it in acceptChallenge(), so only start if not already active
                        if (!activeChallenge || activeChallenge.id !== challenge.id) {
                            startLiveChallenge(challenge.id);
                        }
                    }
                }
                
                // Handle challenge deletion/decline
                if (change.type === 'removed') {
                    const popup = document.getElementById('challenge-popup-notification');
                    if (popup) popup.remove();
                    
                    // Remove from shown set
                    shownPopupIds.delete(challenge.id);
                }
            });
        });
}
        
function listenForMyChallengesAccepted() {
    if (!currentUser) return;
    
    if (myChallengeListener) {
        myChallengeListener();
    }
    
    myChallengeListener = db.collection('challenges')
        .where('challenger.id', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const challenge = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'modified' && challenge.status === 'active') {
                    if (!activeChallenge || activeChallenge.id !== challenge.id) {
                        // âœ… Hide popup immediately when accepted
                        hideCustomPopup();
                        
                        showBottomNotification(`${challenge.opponent.name} accepted your challenge! Starting game...`, 'success');
                        
                        navigateTo('spelling');
                        switchSpellingMode('live');
                        
                        startLiveChallenge(change.doc.id);
                    }
                }
            });
        });
}

function showBottomNotification(message, type = 'success') {
    // Remove existing notification if any
    const existing = document.getElementById('bottom-notification');
    if (existing) existing.remove();
    
    const notification = document.createElement('div');
    notification.id = 'bottom-notification';
    notification.className = 'bottom-notification';
    
    const bgColor = type === 'success' ? 
        'linear-gradient(135deg, #28a745, #20c997)' : 
        'linear-gradient(135deg, #ff6b6b, #ee5a6f)';
    
    notification.style.background = bgColor;
    
    notification.innerHTML = `
        <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">
            ${type === 'success' ? 'âœ…' : 'âš¡'} ${message}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide after 4 seconds
    setTimeout(() => {
        notification.classList.add('hide');
        setTimeout(() => notification.remove(), 500);
    }, 4000);
}

        
function displayIncomingChallenges(challenges) {
    const section = document.getElementById('incoming-challenges-section');
    const container = document.getElementById('incoming-challenges-list');
    
    if (challenges.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    container.innerHTML = challenges.map(challenge => `
        <div class="challenge-notification">
            <h3 style="margin: 0 0 10px 0;">âš”ï¸ ${challenge.challenger.name} challenges you!</h3>
            <p style="margin: 10px 0;">Ready for a spelling battle?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button class="practice-btn" onclick="acceptChallenge('${challenge.id}')" 
                        style="background: #28a745;">
                    âœ… Accept
                </button>
                <button class="practice-btn" onclick="declineChallenge('${challenge.id}')" 
                        style="background: #dc3545;">
                    âŒ Decline
                </button>
            </div>
        </div>
    `).join('');
}

// ===== REPLACE THE acceptChallenge FUNCTION =====
async function acceptChallenge(challengeId) {
    console.log('âœ… Starting acceptChallenge for:', challengeId);
    
    // âœ… CHECK IF ALREADY IN A CHALLENGE
    if (activeChallenge && activeChallenge.status === 'active') {
        showCustomPopup('âš ï¸ COMPLETE CURRENT CHALLENGE FIRST');
        setTimeout(() => hideCustomPopup(), 3000);
        
        // Remove the popup for this new challenge
        const popup = document.getElementById('challenge-popup-notification');
        if (popup) popup.remove();
        
        return;
    }
    
    try {
        const challengeRef = db.collection('challenges').doc(challengeId);
        const challengeDoc = await challengeRef.get();
        
        if (!challengeDoc.exists) {
            console.error('âŒ Challenge not found:', challengeId);
            alert('Challenge not found');
            return;
        }
        
        const challengeData = challengeDoc.data();
        console.log('ðŸ“„ Challenge data:', challengeData);
        
        // Generate 5 random words
        if (!selectedGameLevel) {
            selectedGameLevel = 'foundation';
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            console.log('ðŸ“š Loading words for level:', selectedGameLevel);
            await loadLevelWords(selectedGameLevel);
        }
        
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        const words = shuffled.slice(0, 5);
        
        console.log('ðŸ”¤ Selected words:', words);
        
        await challengeRef.update({
            status: 'active',
            words: words,
            scores: {
                [currentUser.uid]: 0,
                [challengeData.challenger.id]: 0
            },
            completed: {
                [currentUser.uid]: false,
                [challengeData.challenger.id]: false
            },
            currentWord: 0,
            acceptedBy: currentUser.uid,
            startedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Challenge updated to active');
        
        // âœ… Navigate to spelling section and switch to live mode
        navigateTo('spelling', true); // true = skip sidebar close
        
        // âœ… Wait a moment for navigation to complete
        setTimeout(() => {
            switchSpellingMode('live');
            
            // âœ… Wait another moment for mode switch to complete
            setTimeout(() => {
                startLiveChallenge(challengeId);
            }, 300);
        }, 300);
        
    } catch (error) {
        console.error('âŒ Error accepting challenge:', error);
        alert('Failed to accept challenge: ' + error.message);
    }
}

        
async function declineChallenge(challengeId) {
    try {
        // âœ… ADD TO DECLINED LIST FIRST (before deleting)
        declinedChallengeIds.add(challengeId);
        
        // Delete the challenge from Firestore
        await db.collection('challenges').doc(challengeId).delete();
        
        // Remove from shown popups set
        shownPopupIds.delete(challengeId);
        
        // Remove the popup if it exists
        const popup = document.getElementById('challenge-popup-notification');
        if (popup) popup.remove();
        
        // Hide incoming challenges section
        const section = document.getElementById('incoming-challenges-section');
        if (section) section.style.display = 'none';
        
        console.log('âœ… Challenge declined and deleted');
    } catch (error) {
        console.error('Error declining challenge:', error);
    }
}

        
// ===== REPLACE THE showChallengePopup FUNCTION =====
function showChallengePopup(challenge) {
    const challengeId = challenge.id; // Use document ID only
    
    // Prevent duplicate popups
    if (shownPopupIds.has(challengeId)) return;
    shownPopupIds.add(challengeId);
    
    const existingPopup = document.getElementById('challenge-popup-notification');
    if (existingPopup) existingPopup.remove();
    
    const popup = document.createElement('div');
    popup.id = 'challenge-popup-notification';
    popup.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
        color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(255,107,107,0.5);
        z-index: 9999;
        min-width: 320px;
        animation: slideInRight 0.5s ease-out;
    `;
    
    let avatarHTML = '';
    if (challenge.challenger.photoURL) {
        avatarHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background-image: url('${challenge.challenger.photoURL}'); background-size: cover; background-position: center; margin: 0 auto 10px;"></div>`;
    } else {
        const initial = (challenge.challenger.name || 'S').charAt(0).toUpperCase();
        avatarHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background: #ffd700; color: #0d3b66; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 0 auto 10px;">${initial}</div>`;
    }
    
    popup.innerHTML = `
        <div style="text-align: center;">
            ${avatarHTML}
            <h3 style="margin: 0 0 10px 0; font-size: 1.3rem;">âš”ï¸ SPELLING CHALLENGE!</h3>
            <p style="margin: 10px 0; font-size: 1.1rem;"><strong>${challenge.challenger.name}</strong> challenges you!</p>
            <p style="margin: 10px 0; font-size: 0.9rem; opacity: 0.9;">Ready for a spelling battle?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button onclick="acceptChallengeFromPopup('${challengeId}')" 
                        style="padding: 12px 25px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                    âœ… Accept
                </button>
                <button onclick="declineChallengeFromPopup('${challengeId}')" 
                        style="padding: 12px 25px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                    âŒ Decline
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}


// ===== REPLACE THE declineChallengeFromPopup FUNCTION =====
async function declineChallengeFromPopup(challengeId) {
    console.log('âŒ Declining challenge from popup:', challengeId);
    
    // Remove popup immediately
    const popup = document.getElementById('challenge-popup-notification');
    if (popup) popup.remove();
    
    // Delete from shown popups set so it won't show again
    shownPopupIds.delete(challengeId);
    
    // Decline and delete the challenge
    await declineChallenge(challengeId);
}

        
// ===== REPLACE THE acceptChallengeFromPopup FUNCTION =====
async function acceptChallengeFromPopup(challengeId) {
    console.log('ðŸŽ¯ Accepting challenge from popup:', challengeId);
    
    // âœ… CHECK IF ALREADY IN A CHALLENGE
    if (activeChallenge && activeChallenge.status === 'active') {
        showCustomPopup('âš ï¸ COMPLETE CURRENT CHALLENGE FIRST');
        setTimeout(() => hideCustomPopup(), 3000);
        
        // Remove the popup
        const popup = document.getElementById('challenge-popup-notification');
        if (popup) popup.remove();
        
        return;
    }
    
    // Remove popup
    const popup = document.getElementById('challenge-popup-notification');
    if (popup) popup.remove();
    
    shownPopupIds.delete(challengeId);
    
    // Call acceptChallenge with the correct ID
    await acceptChallenge(challengeId);
}
        
// ===== REPLACE THE startLiveChallenge FUNCTION (UPDATE THE LISTENER PART) =====
async function startLiveChallenge(challengeId) {
    try {
        console.log('ðŸŽ® Starting live challenge:', challengeId);
        
        // âœ… CRITICAL: Detach online users listener before starting challenge
        if (onlineUsersRef) {
            onlineUsersRef();
            onlineUsersRef = null;
            console.log('âœ… Detached online users listener');
        }
        
        const challengeDoc = await db.collection('challenges').doc(challengeId).get();
        
        if (!challengeDoc.exists) {
            alert('Challenge not found');
            return;
        }
        
        const challenge = challengeDoc.data();
        
        activeChallenge = { id: challengeId, ...challenge };
        challengeWords = challenge.words || [];
        currentChallengeIndex = 0;
        myScore = 0;
        opponentScore = 0;
        
        // âœ… HIDE the online users and incoming challenges sections
        const onlineUsersSection = document.getElementById('online-users-section');
        const incomingChallengesSection = document.getElementById('incoming-challenges-section');
        
        if (onlineUsersSection) onlineUsersSection.style.display = 'none';
        if (incomingChallengesSection) incomingChallengesSection.style.display = 'none';
        
        // âœ… SHOW the challenge directly in the live-spelling-mode div
        const liveSpellingMode = document.getElementById('live-spelling-mode');
        if (!liveSpellingMode) {
            console.error('âŒ live-spelling-mode not found');
            alert('Failed to start challenge - page element missing');
            return;
        }
        
        let welcomeSection = liveSpellingMode.querySelector('.welcome-section');
        
        if (!welcomeSection) {
            welcomeSection = document.createElement('div');
            welcomeSection.className = 'welcome-section';
            liveSpellingMode.appendChild(welcomeSection);
        }
        
        welcomeSection.innerHTML = '<div id="live-challenge-container"></div>';
        
        // âœ… Start challenge timeout (5 minutes max)
        startChallengeTimeout(challengeId);
        
        // âœ… Start offline detection
        startOfflineDetection(challengeId);
        
        // âœ… Listen for challenge updates
        db.collection('challenges').doc(challengeId).onSnapshot(doc => {
            const data = doc.data();
            
            if (!data) return;
            
            // âœ… UPDATED: Check endReason to determine what happened
            if (data.status === 'completed') {
                clearChallengeTimers();
                
                if (data.endReason === 'finished') {
                    // Normal completion - show results
                    showChallengeResults(data);
                } else {
                    // Abandoned/timeout - show abandoned screen
                    showChallengeAbandoned(data);
                }
                return;
            }
            
            if (data.status === 'abandoned') {
                clearChallengeTimers();
                showChallengeAbandoned(data);
                return;
            }
            
            // âœ… Update opponent score
            const opponentId = activeChallenge.challenger.id === currentUser.uid ? 
                activeChallenge.opponent.id : activeChallenge.challenger.id;
            opponentScore = data.scores?.[opponentId] || 0;
            
            // âœ… Check if elements exist before updating
            const scoreElements = document.querySelectorAll('.player-score .score');
            if (scoreElements && scoreElements.length > 1) {
                scoreElements[1].textContent = opponentScore;
            }
        });
        
        loadChallengeWord();
    } catch (error) {
        console.error('Error starting challenge:', error);
        alert('Failed to start challenge: ' + error.message);
    }
}



// Check if challengers are still online every 10 seconds
setInterval(async () => {
    if (!currentUser) return;
    
    try {
        // Get all pending challenges where I'm the opponent
        const pendingChallenges = await db.collection('challenges')
            .where('opponent.id', '==', currentUser.uid)
            .where('status', '==', 'pending')
            .get();
        
        for (const doc of pendingChallenges.docs) {
            const challenge = doc.data();
            const challengerId = challenge.challenger.id;
            
            // Check if challenger is still online
            const challengerPresence = await db.collection('onlineUsers').doc(challengerId).get();
            
            if (!challengerPresence.exists) {
                // Challenger went offline - delete the challenge
                console.log('ðŸš« Challenger offline - removing challenge:', doc.id);
                await doc.ref.delete();
                
                // Remove popup if exists
                const popup = document.getElementById('challenge-popup-notification');
                if (popup) popup.remove();
                
                // Remove from shown set
                shownPopupIds.delete(doc.id);
            }
        }
    } catch (error) {
        console.error('Error checking challenger presence:', error);
    }
}, 10000); // Check every 10 seconds
        
function loadChallengeWord() {
    if (!challengeWords || challengeWords.length === 0) {
        alert('No words available for challenge');
        return;
    }
    
    const word = challengeWords[currentChallengeIndex];
    const container = document.getElementById('live-challenge-container');
    
    if (!container) {
        console.error('âŒ live-challenge-container not found');
        return;
    }
    
    const opponentName = activeChallenge.challenger.id === currentUser.uid ? 
        activeChallenge.opponent.name : activeChallenge.challenger.name;
    
    container.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1);">
            <h2 style="color: #0d3b66; margin-bottom: 20px; text-align: center;">âš”ï¸ Live Spelling Battle!</h2>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">You</div>
                    <div class="score">${myScore}</div>
                </div>
                <div style="font-size: 2rem; align-self: center;">VS</div>
                <div class="player-score">
                    <div class="name">${opponentName}</div>
                    <div class="score">${opponentScore}</div>
                </div>
            </div>
            
            <div class="quiz-question-card">
                <h3>Word ${currentChallengeIndex + 1} of ${challengeWords.length}</h3>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <button class="practice-btn" onclick="speakChallengeWord()" 
                                style="font-size: 1.1rem; padding: 15px 30px;">
                            ðŸ”Š Play Word
                        </button>
                        <button class="practice-btn" onclick="speakChallengeWordInSentence()" 
                                style="font-size: 1.1rem; padding: 15px 30px; background: #17a2b8;">
                            ðŸ’¬ Use in Sentence
                        </button>
                    </div>
                </div>
                
                <div class="form-group" style="margin: 30px 0;">
                    <label style="font-size: 1.2rem;">Type what you hear:</label>
                    <input type="text" id="challenge-spelling-input" 
                           placeholder="Use the keyboard below..." 
                           style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                           readonly>
                </div>
                
                <div class="virtual-keyboard">
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeChallengeKey('Q')">Q</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('W')">W</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('E')">E</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('R')">R</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('T')">T</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('Y')">Y</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('U')">U</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('I')">I</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('O')">O</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('P')">P</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeChallengeKey('A')">A</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('S')">S</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('D')">D</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('F')">F</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('G')">G</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('H')">H</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('J')">J</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('K')">K</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('L')">L</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeChallengeKey('Z')">Z</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('X')">X</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('C')">C</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('V')">V</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('B')">B</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('N')">N</button>
                        <button class="keyboard-key" onclick="typeChallengeKey('M')">M</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key backspace" onclick="backspaceChallengeKey()">âŒ« Delete</button>
                        <button class="keyboard-key space" onclick="typeChallengeKey(' ')">Space</button>
                        <button class="keyboard-key enter" onclick="submitChallengeAnswer()">âœ“ Enter</button>
                    </div>
                </div>
                
                <div id="challenge-feedback" style="margin-top: 20px;"></div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="practice-btn" onclick="exitChallenge()" style="background: #dc3545;">
                    ðŸšª Exit Challenge
                </button>
            </div>
        </div>
    `;
    
    setTimeout(() => speakChallengeWord(), 500);
}
function speakChallengeWord() {
    if (!challengeWords || !challengeWords[currentChallengeIndex]) return;
    
    const word = challengeWords[currentChallengeIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

 async function speakChallengeWordInSentence() {
    if (!challengeWords || !challengeWords[currentChallengeIndex]) return;
    
    const word = challengeWords[currentChallengeIndex];
    
    const btn = event?.target;
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'â³ Loading...';
    }
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let exampleSentence = null;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        exampleSentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        if (!exampleSentence) {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: word } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.meanings && data.result.meanings.length > 0) {
                    for (let meaning of data.result.meanings) {
                        if (meaning.example) {
                            exampleSentence = meaning.example;
                            break;
                        }
                    }
                }
            }
        }
        
        if (!exampleSentence) {
            exampleSentence = `The word is ${word}.`;
        }
        
        const utterance = new SpeechSynthesisUtterance(exampleSentence);
        utterance.rate = 0.8;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        const utterance = new SpeechSynthesisUtterance(`The word is ${word}.`);
        utterance.rate = 0.8;
        window.speechSynthesis.speak(utterance);
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'ðŸ’¬ Use in Sentence';
        }
    }
}       

function typeChallengeKey(letter) {
    const input = document.getElementById('challenge-spelling-input');
    if (!input) return;
    input.value += letter.toLowerCase();
}

function backspaceChallengeKey() {
    const input = document.getElementById('challenge-spelling-input');
    if (!input) return;
    input.value = input.value.slice(0, -1);
}

// ===== REPLACE THE submitChallengeAnswer FUNCTION =====
async function submitChallengeAnswer() {
    const input = document.getElementById('challenge-spelling-input');
    if (!input) return;
    
    const userAnswer = input.value.trim().toLowerCase();
    const correctWord = challengeWords[currentChallengeIndex].toLowerCase();
    const feedbackDiv = document.getElementById('challenge-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">âš ï¸ Please type a word</div>';
        return;
    }
    
    // âœ… Disable input while processing
    input.disabled = true;
    
    const isCorrect = userAnswer === correctWord;
    
    if (isCorrect) {
        myScore++;
        feedbackDiv.innerHTML = '<div class="feedback success">âœ… Correct!</div>';
    } else {
        feedbackDiv.innerHTML = `<div class="feedback error">âŒ Wrong! Correct: ${correctWord}</div>`;
    }
    
    try {
        const challengeRef = db.collection('challenges').doc(activeChallenge.id);
        const scoreKey = `scores.${currentUser.uid}`;
        const completedKey = `completed.${currentUser.uid}`;
        
        // âœ… Update score
        await challengeRef.update({
            [scoreKey]: myScore,
            [`lastAnswerTime.${currentUser.uid}`]: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // âœ… Check if this is the last word
        currentChallengeIndex++;
        
        if (currentChallengeIndex >= challengeWords.length) {
            // Mark that I've completed all words
            await challengeRef.update({
                [completedKey]: true
            });
            
            // Check if opponent also completed
            const challengeDoc = await challengeRef.get();
            const challengeData = challengeDoc.data();
            const opponentId = activeChallenge.challenger.id === currentUser.uid ? 
                activeChallenge.opponent.id : activeChallenge.challenger.id;
            
            if (challengeData.completed && challengeData.completed[opponentId]) {
                // Both completed - end the challenge properly
                await challengeRef.update({
                    status: 'completed',
                    endReason: 'finished', // âœ… Mark as normally finished
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Don't show waiting screen, results will show automatically via listener
            } else {
                // Show waiting screen
                showWaitingForOpponent();
            }
        } else {
            // Continue to next word
            setTimeout(() => {
                input.disabled = false;
                loadChallengeWord();
            }, 2000);
        }
    } catch (error) {
        console.error('Error updating score:', error);
    }
}

function showWaitingForOpponent() {
    const container = document.getElementById('live-challenge-container');
    
    if (!container) {
        console.error('âŒ live-challenge-container not found');
        return;
    }
    
    const opponentName = activeChallenge.challenger.id === currentUser.uid ? 
        activeChallenge.opponent.name : activeChallenge.challenger.name;
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0; animation: pulse 2s infinite;">â³</div>
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 20px;">
                Waiting for ${opponentName}...
            </h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You've completed all words! <br>
                Waiting for your opponent to finish.
            </p>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">Your Score</div>
                    <div class="score">${myScore}</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <div class="loading">Challenge will end when both players finish...</div>
            </div>
        </div>
    `;
}
        

async function showChallengeResults(challenge) {
    const myId = currentUser.uid;
    const opponentId = challenge.challenger.id === myId ? challenge.opponent.id : challenge.challenger.id;
    
    const myFinalScore = challenge.scores[myId] || 0;
    const opponentFinalScore = challenge.scores[opponentId] || 0;
    
    const won = myFinalScore > opponentFinalScore;
    const tied = myFinalScore === opponentFinalScore;
    
    // âœ… UPDATE SPELLING STATS IN FIRESTORE
    try {
        const userRef = db.collection('users').doc(myId);
        const userDoc = await userRef.get();
        const currentStats = userDoc.data().spellingStats || {
            totalChallenges: 0,
            wins: 0,
            losses: 0,
            totalScore: 0,
            winStreak: 0,
            bestStreak: 0
        };
        
        let newStats = {
            totalChallenges: currentStats.totalChallenges + 1,
            wins: currentStats.wins + (won ? 1 : 0),
            losses: currentStats.losses + (tied ? 0 : (won ? 0 : 1)),
            totalScore: currentStats.totalScore + myFinalScore,
            winStreak: won ? currentStats.winStreak + 1 : 0,
            bestStreak: won ? Math.max(currentStats.bestStreak, currentStats.winStreak + 1) : currentStats.bestStreak,
            lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await userRef.update({
            spellingStats: newStats
        });
        
        console.log('âœ… Spelling stats updated:', newStats);
    } catch (error) {
        console.error('Error updating spelling stats:', error);
    }
    
    // âœ… AWARD COINS FOR WIN
    if (won) {
        await awardCoins(COINS_PER_WIN);
    }
    
    const container = document.getElementById('live-challenge-container');
    
    if (!container) {
        console.error('âŒ live-challenge-container not found');
        return;
    }
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">
                ${won ? 'ðŸ†' : tied ? 'ðŸ¤' : 'ðŸ˜”'}
            </div>
            <h2 style="color: #0d3b66; font-size: 2.5rem; margin-bottom: 20px;">
                ${won ? 'Victory!' : tied ? "It's a Tie!" : 'Better Luck Next Time'}
            </h2>
            
            ${won ? `
                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 20px; border-radius: 15px; margin: 20px 0;">
                    <h3 style="color: #0d3b66; font-size: 1.5rem; margin-bottom: 10px;">ðŸª™ Coins Earned!</h3>
                    <p style="color: #0d3b66; font-size: 2rem; font-weight: bold;">+${COINS_PER_WIN} Coins</p>
                    <p style="color: #0d3b66; font-size: 1rem; margin-top: 5px;">Total: ${userCoins} / ${MAX_COINS}</p>
                </div>
            ` : ''}
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">You</div>
                    <div class="score">${myFinalScore}</div>
                </div>
                <div style="font-size: 2rem; align-self: center;">-</div>
                <div class="player-score">
                    <div class="name">Opponent</div>
                    <div class="score">${opponentFinalScore}</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="practice-btn" onclick="navigateTo('spelling'); switchSpellingMode('leaderboard');" style="background: #667eea; margin: 5px;">
                    ðŸ“Š View Leaderboard
                </button>
                <button class="practice-btn" onclick="exitChallenge()" style="margin: 5px;">
                    ðŸ  Back to Lobby
                </button>
            </div>
        </div>
    `;
}




// ===== SPELLING LEADERBOARD FUNCTIONS =====
async function loadSpellingLeaderboard() {
    const container = document.getElementById('leaderboard-container');
    
    if (!container) {
        console.error('âŒ Leaderboard container not found');
        return;
    }
    
    try {
        container.innerHTML = '<div class="loading">ðŸ“Š Loading leaderboard...</div>';
        
        // Fetch all users with spelling stats, ordered by wins
        const usersSnapshot = await db.collection('users')
            .where('spellingStats.wins', '>', 0)
            .orderBy('spellingStats.wins', 'desc')
            .limit(50)
            .get();
        
        if (usersSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ†</div>
                    <h3>No ranked players yet</h3>
                    <p>Be the first to win a spelling challenge!</p>
                </div>
            `;
            return;
        }
        
        const players = [];
        usersSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.spellingStats) {
                players.push({
                    id: doc.id,
                    name: data.name,
                    email: data.email,
                    photoURL: data.photoURL,
                    country: data.country,
                    age: data.age,
                    createdAt: data.createdAt,
                    stats: data.spellingStats
                });
            }
        });
        
        // Sort by wins, then by win rate as tiebreaker
        players.sort((a, b) => {
            if (b.stats.wins !== a.stats.wins) {
                return b.stats.wins - a.stats.wins;
            }
            const aWinRate = a.stats.wins / a.stats.totalChallenges;
            const bWinRate = b.stats.wins / b.stats.totalChallenges;
            return bWinRate - aWinRate;
        });
        
        // Find current user's rank
        const myRank = players.findIndex(p => p.id === currentUser?.uid) + 1;
        
        // Display leaderboard
        container.innerHTML = `
            ${currentUser && myRank > 0 ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 25px; color: white; text-align: center;">
                    <h3 style="margin: 0 0 10px 0; color: white;">ðŸŽ¯ Your Rank</h3>
                    <p style="font-size: 2.5rem; margin: 10px 0; font-weight: bold;">#${myRank}</p>
                    <p style="margin: 5px 0; opacity: 0.9;">
                        ${players[myRank - 1].stats.wins} Wins â€¢ 
                        ${players[myRank - 1].stats.totalChallenges} Challenges
                    </p>
                </div>
            ` : ''}
            
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: center;">ðŸ† Rank</th>
                            <th>ðŸ‘¤ Player</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${players.map((player, index) => {
                            const isCurrentUser = currentUser && player.id === currentUser.uid;
                            
                            let rankEmoji = '';
                            if (index === 0) rankEmoji = 'ðŸ¥‡';
                            else if (index === 1) rankEmoji = 'ðŸ¥ˆ';
                            else if (index === 2) rankEmoji = 'ðŸ¥‰';
                            
                            let avatarHTML = '';
                            if (player.photoURL) {
                                avatarHTML = `<div style="width: 45px; height: 45px; min-width: 45px; border-radius: 50%; background-image: url('${player.photoURL}'); background-size: cover; background-position: center;"></div>`;
                            } else {
                                const initial = (player.name || 'P').charAt(0).toUpperCase();
                                avatarHTML = `<div class="coach-avatar" style="width: 45px; height: 45px; min-width: 45px;">${initial}</div>`;
                            }
                            
                            return `
                                <tr onclick="showLeaderboardPlayerDetail('${player.id}', ${index + 1})" style="cursor: pointer; ${isCurrentUser ? 'background: #e3f2fd;' : ''}">
                                    <td style="text-align: center; font-size: 1.3rem; font-weight: bold; color: #0d3b66;">
                                        ${rankEmoji || (index + 1)}
                                    </td>
                                    <td>
                                        <div class="coach-profile-cell">
                                            ${avatarHTML}
                                            <div class="coach-name">${player.name}${isCurrentUser ? ' (You)' : ''}</div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">ðŸ† How Rankings Work</h3>
                <p style="color: #666; line-height: 1.6;">
                    â€¢ Players are ranked by <strong>total wins</strong> in live spelling challenges<br>
                    â€¢ Click on any player to view their detailed stats<br>
                    â€¢ Challenge top players to climb the leaderboard!
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('âŒ Error loading leaderboard:', error);
        container.innerHTML = `
            <div class="feedback error">
                âŒ Error loading leaderboard. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadSpellingLeaderboard()">ðŸ”„ Retry</button>
            </div>
        `;
    }
}


  // Show leaderboard player details
async function showLeaderboardPlayerDetail(playerId, rank) {
    try {
        console.log('ðŸ“‹ Loading player details for:', playerId);
        const playerDoc = await db.collection('users').doc(playerId).get();
        
        if (!playerDoc.exists) {
            console.error('âŒ Player not found');
            alert('Player profile not found');
            return;
        }
        
        const player = { id: playerDoc.id, ...playerDoc.data() };
        console.log('Player data loaded:', player);
        
        const modal = document.getElementById('leaderboardPlayerModal');
        
        // Generate Student ID
        const studentId = `WB-2025-${player.id.slice(-4).toUpperCase()}`;
        
        // Calculate stats
        const stats = player.spellingStats || {
            wins: 0,
            losses: 0,
            totalChallenges: 0,
            winStreak: 0,
            bestStreak: 0,
            totalScore: 0
        };
        
        const winRate = stats.totalChallenges > 0 
            ? ((stats.wins / stats.totalChallenges) * 100).toFixed(1) 
            : '0.0';
        
        const avgScore = stats.totalChallenges > 0 
            ? (stats.totalScore / stats.totalChallenges).toFixed(1) 
            : '0.0';
        
        // Rank emoji
        let rankEmoji = '';
        if (rank === 1) rankEmoji = 'ðŸ¥‡';
        else if (rank === 2) rankEmoji = 'ðŸ¥ˆ';
        else if (rank === 3) rankEmoji = 'ðŸ¥‰';
        
        // Update avatar with photo
        const avatar = document.getElementById('modal-leaderboard-avatar');
        if (player.photoURL) {
            console.log('ðŸ–¼ï¸ Setting photo URL:', player.photoURL);
            avatar.style.backgroundImage = `url('${player.photoURL}')`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
            avatar.textContent = '';
        } else {
            console.log('ðŸ”¤ No photo URL, using initial');
            avatar.style.backgroundImage = 'none';
            avatar.textContent = (player.name || 'P').charAt(0).toUpperCase();
        }
        
        // Update name
        document.getElementById('modal-leaderboard-name').textContent = player.name || 'Player';
        
        // Update rank badge
        document.getElementById('modal-leaderboard-rank').innerHTML = `${rankEmoji} Rank #${rank}`;
        
        // Update Student ID
        document.getElementById('modal-leaderboard-id').textContent = studentId;
        document.getElementById('modal-leaderboard-id-display').textContent = studentId;
        
        // Update email
        document.getElementById('modal-leaderboard-email').textContent = player.email || 'N/A';
        
        // Update country
        document.getElementById('modal-leaderboard-country').textContent = player.country || 'N/A';
        
        // Update age
        const ageRow = document.getElementById('modal-leaderboard-age-row');
        if (player.age) {
            ageRow.style.display = 'flex';
            document.getElementById('modal-leaderboard-age').textContent = player.age + ' years old';
        } else {
            ageRow.style.display = 'none';
        }
        
        // Update member since
        if (player.createdAt) {
            const joinDate = player.createdAt.toDate();
            document.getElementById('modal-leaderboard-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            document.getElementById('modal-leaderboard-joined').textContent = 'Recently';
        }
        
        // Update stats
        document.getElementById('modal-leaderboard-wins').textContent = stats.wins;
        document.getElementById('modal-leaderboard-losses').textContent = stats.losses;
        document.getElementById('modal-leaderboard-total').textContent = stats.totalChallenges;
        document.getElementById('modal-leaderboard-winrate').textContent = winRate + '%';
        document.getElementById('modal-leaderboard-streak').textContent = stats.winStreak > 0 ? 'ðŸ”¥ ' + stats.winStreak : '-';
        document.getElementById('modal-leaderboard-best').textContent = stats.bestStreak;
        document.getElementById('modal-leaderboard-avgscore').textContent = avgScore;
        
        // Show modal
        modal.classList.add('active');
        console.log('Modal displayed');
        
    } catch (error) {
        console.error('âŒ Error loading player details:', error);
        alert('Unable to load player details: ' + error.message);
    }
}

// Close leaderboard player modal
function closeLeaderboardPlayerModal() {
    document.getElementById('leaderboardPlayerModal').classList.remove('active');
}      
        
// ===== REPLACE THE exitChallenge FUNCTION =====
async function exitChallenge() {
    try {
        // âœ… Only mark as abandoned if challenge is still active AND user hasn't completed
        if (activeChallenge && activeChallenge.status === 'active') {
            const challengeDoc = await db.collection('challenges').doc(activeChallenge.id).get();
            const challengeData = challengeDoc.data();
            
            // Check if user has completed their words
            const userCompleted = challengeData.completed && challengeData.completed[currentUser.uid];
            
            if (!userCompleted) {
                // User is leaving before finishing - opponent wins
                const opponentId = activeChallenge.challenger.id === currentUser.uid ? 
                    activeChallenge.opponent.id : activeChallenge.challenger.id;
                
                await db.collection('challenges').doc(activeChallenge.id).update({
                    status: 'abandoned',
                    endReason: 'opponent_left',
                    winner: opponentId,
                    loser: currentUser.uid,
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('âœ… Challenge abandoned - opponent wins');
            } else {
                // User completed their part, just exiting to lobby
                console.log('âœ… User completed challenge, just returning to lobby');
            }
        }
    } catch (error) {
        console.error('Error updating challenge on exit:', error);
    }
    
    // âœ… Clear all timers
    clearChallengeTimers();
    
    activeChallenge = null;
    challengeWords = [];
    currentChallengeIndex = 0;
    myScore = 0;
    opponentScore = 0;
    shownPopupIds.clear();
    
    // âœ… Check if elements exist before trying to modify them
    const onlineUsersSection = document.getElementById('online-users-section');
    const incomingChallengesSection = document.getElementById('incoming-challenges-section');
    
    if (onlineUsersSection) {
        onlineUsersSection.style.display = 'block';
    }
    
    if (incomingChallengesSection) {
        incomingChallengesSection.style.display = 'none';
    }
    
    // âœ… Restore the welcome section content
    const liveSpellingMode = document.getElementById('live-spelling-mode');
    if (!liveSpellingMode) {
        console.error('âŒ live-spelling-mode not found');
        return;
    }
    
    let welcomeSection = liveSpellingMode.querySelector('.welcome-section');
    
    if (!welcomeSection) {
        welcomeSection = document.createElement('div');
        welcomeSection.className = 'welcome-section';
        liveSpellingMode.appendChild(welcomeSection);
    }
    
    welcomeSection.innerHTML = `
        <h2>ðŸ† Live Spelling Challenges</h2>
        <p style="margin: 20px 0;">Challenge other students to spelling battles in real-time!</p>
        
        <!-- Online Users Section -->
        <div id="online-users-section">
            <h3 style="color: #0d3b66; margin: 20px 0;">ðŸ‘¥ Online Students (<span id="online-count">0</span>)</h3>
            <div id="online-users-list" class="favorites-grid">
                <div class="loading">Loading online users...</div>
            </div>
        </div>
        
        <!-- Incoming Challenges -->
        <div id="incoming-challenges-section" style="margin-top: 30px; display: none;">
            <h3 style="color: #dc3545; margin: 20px 0;">âš¡ Incoming Challenges</h3>
            <div id="incoming-challenges-list"></div>
        </div>
    `;
    
    // âœ… Restart online users listener
    loadOnlineUsers();
}
        
// Start challenge timeout
function startChallengeTimeout(challengeId) {
    challengeTimeoutTimer = setTimeout(async () => {
        console.log('â° Challenge timeout reached');
        await endChallengeByTimeout(challengeId);
    }, CHALLENGE_TIMEOUT);
}

// Start offline detection
function startOfflineDetection(challengeId) {
    offlineCheckTimer = setInterval(async () => {
        if (!activeChallenge) {
            clearInterval(offlineCheckTimer);
            return;
        }
        
        const opponentId = activeChallenge.challenger.id === currentUser.uid ? 
            activeChallenge.opponent.id : activeChallenge.challenger.id;
        
        // Check if opponent is still online
        try {
            const opponentPresence = await db.collection('onlineUsers').doc(opponentId).get();
            
            if (!opponentPresence.exists) {
                console.log('ðŸš« Opponent went offline');
                await endChallengeByOpponentOffline(challengeId);
                return;
            }
            
            const lastSeen = opponentPresence.data().lastSeen?.toDate();
            if (!lastSeen) return;
            
            const now = new Date();
            const diffMinutes = (now - lastSeen) / 1000 / 60;
            
            if (diffMinutes > 2) {
                console.log('ðŸš« Opponent inactive for 2+ minutes');
                await endChallengeByOpponentOffline(challengeId);
            }
        } catch (error) {
            console.error('Error checking opponent presence:', error);
        }
    }, OFFLINE_CHECK_INTERVAL);
}

// Clear all challenge timers
function clearChallengeTimers() {
    if (challengeTimeoutTimer) {
        clearTimeout(challengeTimeoutTimer);
        challengeTimeoutTimer = null;
    }
    if (turnTimeoutTimer) {
        clearTimeout(turnTimeoutTimer);
        turnTimeoutTimer = null;
    }
    if (offlineCheckTimer) {
        clearInterval(offlineCheckTimer);
        offlineCheckTimer = null;
    }
}

// End challenge by timeout
async function endChallengeByTimeout(challengeId) {
    try {
        clearChallengeTimers();
        
        await db.collection('challenges').doc(challengeId).update({
            status: 'completed',
            endReason: 'timeout',
            endedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const challengeDoc = await db.collection('challenges').doc(challengeId).get();
        if (challengeDoc.exists) {
            showChallengeResults(challengeDoc.data());
        }
    } catch (error) {
        console.error('Error ending challenge by timeout:', error);
    }
}

// End challenge by opponent offline
async function endChallengeByOpponentOffline(challengeId) {
    try {
        clearChallengeTimers();
        
        await db.collection('challenges').doc(challengeId).update({
            status: 'abandoned',
            endReason: 'opponent_offline',
            winner: currentUser.uid,
            endedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
    } catch (error) {
        console.error('Error ending challenge by opponent offline:', error);
    }
}

// Show abandoned challenge screen
function showChallengeAbandoned(challenge) {
    const container = document.getElementById('live-challenge-container');
    
    if (!container) {
        console.error('âŒ live-challenge-container not found');
        return;
    }
    
    // âœ… Check if current user is the winner
    const iWon = challenge.winner === currentUser.uid;
    
    let message = '';
    if (challenge.endReason === 'opponent_left') {
        message = 'Your opponent left the challenge.';
    } else if (challenge.endReason === 'opponent_offline') {
        message = 'Your opponent went offline.';
    } else {
        message = 'The challenge was cancelled.';
    }
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${iWon ? 'ðŸ†' : 'ðŸš«'}</div>
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 15px;">Challenge Ended</h2>
            <p style="font-size: 1.2rem; margin: 20px 0; color: #666;">
                ${message}
            </p>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">Your Score</div>
                    <div class="score">${myScore}</div>
                </div>
            </div>
            
            ${iWon ? `
                <p style="margin: 20px 0; font-size: 1.5rem; color: #28a745; font-weight: bold;">
                    ðŸŽ‰ You win by default!
                </p>
            ` : `
                <p style="margin: 20px 0; font-size: 1.2rem; color: #dc3545; font-weight: bold;">
                    You left the challenge
                </p>
            `}
            
            <button class="practice-btn" onclick="exitChallenge()" style="margin-top: 30px; font-size: 1.2rem; padding: 15px 40px;">
                ðŸ  Back to Lobby
            </button>
        </div>
    `;
}

        

// Cleanup old challenges (run on page load)
async function cleanupOldChallenges() {
    if (!currentUser) {
        console.log('â­ï¸ Skipping cleanup - no user logged in');
        return;
    }
    
    try {
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        
        // âœ… Only cleanup challenges where current user is involved
        const myChallenges = await db.collection('challenges')
            .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(oneDayAgo))
            .get();
        
        const deletePromises = [];
        myChallenges.docs.forEach(doc => {
            const data = doc.data();
            // Only delete if I'm the challenger or opponent
            if (data.challenger?.id === currentUser.uid || data.opponent?.id === currentUser.uid) {
                deletePromises.push(doc.ref.delete());
            }
        });
        
        if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            console.log(`ðŸ§¹ Cleaned up ${deletePromises.length} old challenges`);
        }
    } catch (error) {
        console.log('â„¹ï¸ Could not cleanup old challenges (this is normal):', error.message);
        // Don't throw error - this is not critical
    }
} 

  
// Show custom popup - simplified
function showCustomPopup(message) {
    const popup = document.getElementById('customPopup');
    popup.textContent = message;
    popup.classList.add('show');
}

// Hide custom popup
function hideCustomPopup() {
    const popup = document.getElementById('customPopup');
    popup.classList.remove('show');
}

        
// Auto-hide popup after delay
function autoHidePopup(delay = 3000) {
    setTimeout(() => {
        hideCustomPopup();
    }, delay);
}  


// ===== COIN SYSTEM FUNCTIONS =====
async function loadUserCoins(userId) {
    try {
        const userDoc = await db.collection('users').doc(userId).get();
        const userData = userDoc.data();
        
        // Initialize coins if not exists
        if (userData.coins === undefined) {
            userCoins = 0;
            await db.collection('users').doc(userId).update({
                coins: 0
            });
        } else {
            userCoins = userData.coins || 0;
        }
        
        // Show coin display for students only
        if (userData.userType === 'student') {
            updateCoinDisplay();
        }
    } catch (error) {
        console.error('Error loading coins:', error);
        userCoins = 0;
    }
}

function updateCoinDisplay() {
    const coinDisplay = document.getElementById('coinDisplay');
    const coinAmount = document.getElementById('coinAmount');
    
    if (coinDisplay && coinAmount) {
        coinAmount.textContent = userCoins;
        coinDisplay.classList.add('show');
    }
}

function hideCoinDisplay() {
    const coinDisplay = document.getElementById('coinDisplay');
    if (coinDisplay) {
        coinDisplay.classList.remove('show');
    }
}

async function awardCoins(amount) {
    if (!currentUser) return;
    
    try {
        // Check if user is a student
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData.userType !== 'student') {
            console.log('Only students can earn coins');
            return;
        }
        
        // Calculate new coin amount (capped at MAX_COINS)
        const newCoins = Math.min(userCoins + amount, MAX_COINS);
        const actualCoinsEarned = newCoins - userCoins;
        
        if (actualCoinsEarned <= 0) {
            console.log('Maximum coins reached');
            return;
        }
        
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            coins: newCoins,
            lastCoinEarned: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update local variable
        userCoins = newCoins;
        
        // Show coin earned animation
        showCoinEarnedAnimation(actualCoinsEarned);
        
        // Update display
        setTimeout(() => {
            updateCoinDisplay();
        }, 1500);
        
    } catch (error) {
        console.error('Error awarding coins:', error);
    }
}

function showCoinEarnedAnimation(amount) {
    const coinEarned = document.createElement('div');
    coinEarned.className = 'coin-earned';
    coinEarned.innerHTML = `ðŸª™ +${amount} Coins!`;
    
    document.body.appendChild(coinEarned);
    
    // Remove after animation
    setTimeout(() => {
        coinEarned.remove();
    }, 2000);
}        


// ===== SUBSCRIPTION SYSTEM =====
const SUBSCRIPTION_COST = 300;
const SUBSCRIPTION_DAYS = 30;
let subscriptionActive = false;

async function checkSubscriptionStatus() {
    if (!currentUser) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        // âœ… ADD: Check if user data exists first
        if (!userData) {
            console.log('âš ï¸ User data not loaded yet');
            subscriptionActive = false;
            return;
        }
        
        // Only check for students
        if (userData.userType !== 'student') {
            subscriptionActive = true;
            return;
        }
        
        // Check if subscription exists and is valid
        let subscriptionExpiry = userData.subscriptionExpiry?.toDate();
        
        // If no subscription, give 1 month free trial from account creation
        if (!subscriptionExpiry) {
            const createdAt = userData.createdAt?.toDate() || new Date();
            subscriptionExpiry = new Date(createdAt.getTime() + (30 * 24 * 60 * 60 * 1000));
            
            await db.collection('users').doc(currentUser.uid).update({
                subscriptionExpiry: firebase.firestore.Timestamp.fromDate(subscriptionExpiry),
                subscriptionType: 'trial'
            });
        }
        
        const now = new Date();
        
        // Check if subscription has expired
        if (now > subscriptionExpiry) {
            console.log('âŒ Subscription expired');
            subscriptionActive = false;
            showSubscriptionModal();
        } else {
            console.log('âœ… Subscription active until:', subscriptionExpiry);
            subscriptionActive = true;
        }
        
        // Update dashboard if on dashboard page
        if (document.getElementById('student-dashboard-section').classList.contains('active')) {
            updateDashboardSubscriptionStatus();
        }
        
    } catch (error) {
        console.error('Error checking subscription:', error);
        // âœ… DON'T set subscriptionActive to false on error
        subscriptionActive = true; // Assume active on error to avoid blocking user
    }
}

function showSubscriptionModal() {
    const modal = document.getElementById('subscriptionModal');
    
    if (!currentUser) {
        console.error('No current user for subscription modal');
        return;
    }
    
    // Update coin display
    const coinsElement = document.getElementById('sub-modal-coins');
    if (coinsElement) {
        coinsElement.textContent = userCoins;
    }
    
    // Update Student ID
    const studentIdElement = document.getElementById('sub-modal-student-id');
    if (studentIdElement) {
        db.collection('users').doc(currentUser.uid).get().then(doc => {
            const userData = doc.data();
            const studentId = userData?.studentId || `WB-2025-${currentUser.uid.slice(-4).toUpperCase()}`;
            studentIdElement.textContent = studentId;
        }).catch(error => {
            console.error('Error loading student ID:', error);
            studentIdElement.textContent = `WB-2025-${currentUser.uid.slice(-4).toUpperCase()}`;
        });
    }
    
    // Check if user has enough coins
    const redeemBtn = document.getElementById('redeem-sub-btn');
    const insufficientDiv = document.getElementById('sub-modal-insufficient');
    const coinsNeededSpan = document.getElementById('coins-needed');
    
    if (redeemBtn && insufficientDiv && coinsNeededSpan) {
        if (userCoins >= SUBSCRIPTION_COST) {
            redeemBtn.disabled = false;
            insufficientDiv.style.display = 'none';
        } else {
            redeemBtn.disabled = true;
            insufficientDiv.style.display = 'block';
            coinsNeededSpan.textContent = SUBSCRIPTION_COST - userCoins;
        }
    }
    
    // Reset UI
    const buttonsDiv = document.getElementById('sub-modal-buttons');
    const successDiv = document.getElementById('sub-modal-success');
    const errorDiv = document.getElementById('sub-modal-error');
    
    if (buttonsDiv) buttonsDiv.style.display = 'block';
    if (successDiv) successDiv.style.display = 'none';
    if (errorDiv) errorDiv.style.display = 'none';
    
    modal.classList.add('active');
}
        
function closeSubscriptionModal() {
    // Only close if subscription was successfully redeemed
    if (subscriptionActive) {
        document.getElementById('subscriptionModal').classList.remove('active');
    }
}

async function redeemSubscription() {
    if (!currentUser || userCoins < SUBSCRIPTION_COST) {
        return;
    }
    
    try {
        const redeemBtn = document.getElementById('redeem-sub-btn');
        redeemBtn.disabled = true;
        redeemBtn.textContent = 'â³ Processing...';
        
        // Calculate new expiry date (30 days from now)
        const newExpiry = new Date();
        newExpiry.setDate(newExpiry.getDate() + SUBSCRIPTION_DAYS);
        
        // Deduct coins and update subscription
        const newCoins = userCoins - SUBSCRIPTION_COST;
        
        await db.collection('users').doc(currentUser.uid).update({
            coins: newCoins,
            subscriptionExpiry: firebase.firestore.Timestamp.fromDate(newExpiry),
            subscriptionType: 'paid',
            lastSubscriptionRenewal: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update local coins
        userCoins = newCoins;
        updateCoinDisplay();
        
        // Mark subscription as active
        subscriptionActive = true;
        
        // Show success message
        document.getElementById('sub-modal-buttons').style.display = 'none';
        document.getElementById('sub-modal-success').style.display = 'block';
        
        console.log('âœ… Subscription renewed successfully');
        
    } catch (error) {
        console.error('Error redeeming subscription:', error);
        const errorDiv = document.getElementById('sub-modal-error');
        errorDiv.textContent = 'Failed to process subscription: ' + error.message;
        errorDiv.style.display = 'block';
        
        const redeemBtn = document.getElementById('redeem-sub-btn');
        redeemBtn.disabled = false;
        redeemBtn.textContent = 'âœ… Redeem 300 Coins for 30 Days';
    }
}

async function redeemSubscriptionFromDashboard() {
    await redeemSubscription();
    
    // Reload dashboard after successful redemption
    setTimeout(() => {
        loadUserDashboard();
        if (subscriptionActive) {
            closeSubscriptionModal();
        }
    }, 2000);
}

function signOutFromSubscription() {
    subscriptionActive = false;
    signOut();
}

async function updateDashboardSubscriptionStatus() {
    if (!currentUser) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData.userType !== 'student') return;
        
        const subscriptionExpiry = userData.subscriptionExpiry?.toDate();
        const subscriptionType = userData.subscriptionType || 'trial';
        const now = new Date();
        
        const statusIcon = document.getElementById('sub-status-icon');
        const statusTitle = document.getElementById('sub-status-title');
        const statusText = document.getElementById('sub-status-text');
        const renewSection = document.getElementById('sub-renew-section');
        const dashboardCoins = document.getElementById('dashboard-coins');
        
        if (!statusIcon || !statusTitle || !statusText || !renewSection || !dashboardCoins) return;
        
        // Update coin display
        dashboardCoins.textContent = userCoins;
        
        // Format date nicely
        const formatDate = (date) => {
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        };
        
        if (!subscriptionExpiry) {
            statusIcon.textContent = 'ðŸ”’';
            statusTitle.textContent = 'No Subscription';
            statusText.innerHTML = `Subscribe to continue learning`;
            renewSection.style.display = 'block';
            return;
        }
        
        const daysLeft = Math.ceil((subscriptionExpiry - now) / (1000 * 60 * 60 * 24));
        
        if (now > subscriptionExpiry) {
            // Expired
            statusIcon.textContent = 'ðŸ”’';
            statusTitle.textContent = 'Subscription Expired';
            statusText.innerHTML = `
                Expires: ${formatDate(subscriptionExpiry)}<br>
                <span style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px; display: block;">
                    ${subscriptionType === 'trial' ? 
                        'âš ï¸ Your first month free trial has ended. You need coins to continue. If you don\'t have coins, your parents will need to pay $1000 JMD to regain access.' : 
                        'Renew to continue learning'}
                </span>
            `;
            renewSection.style.display = 'block';
        } else if (daysLeft <= 7) {
            // Expiring soon
            statusIcon.textContent = 'âš ï¸';
            statusTitle.textContent = 'Expiring Soon';
            statusText.innerHTML = `
                Expires: ${formatDate(subscriptionExpiry)} (${daysLeft} day${daysLeft !== 1 ? 's' : ''} remaining)
                ${subscriptionType === 'trial' ? 
                    '<br><span style="font-size: 0.85rem; opacity: 0.8; margin-top: 8px; display: block;">âš ï¸ This is your first month free trial. After it expires, you\'ll need coins to continue. If you don\'t have coins, your parents will need to pay $1000 JMD.</span>' : 
                    ''}
            `;
            renewSection.style.display = 'block';
        } else {
            // Active
            statusIcon.textContent = 'ðŸ”“';
            statusTitle.textContent = subscriptionType === 'trial' ? 'Free Trial Active' : 'Active Subscription';
            statusText.innerHTML = `
                Expires: ${formatDate(subscriptionExpiry)} (${daysLeft} days left)
                ${subscriptionType === 'trial' ? 
                    '<br><span style="font-size: 0.85rem; opacity: 0.8; margin-top: 8px; display: block;">âš ï¸ This is your first month free trial. After it expires, you\'ll need 300 coins to continue. If you don\'t have coins, your parents will need to pay $1000 JMD.</span>' : 
                    ''}
            `;
            renewSection.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Error updating dashboard subscription status:', error);
    }
}


 // ===== LIVE QUIZ FUNCTIONS =====

async function loadQuizOnlineUsers() {
    if (!currentUser) {
        const listElement = document.getElementById('quiz-online-users-list');
        if (listElement) {
            listElement.innerHTML = '<div class="loading">Please sign in to see online users</div>';
        }
        return;
    }
    
    try {
        // Detach existing listener before creating new one
        if (quizOnlineUsersRef) {
            quizOnlineUsersRef();
            quizOnlineUsersRef = null;
        }
        
        quizOnlineUsersRef = db.collection('onlineUsers')
            .where('userId', '!=', currentUser.uid)
            .onSnapshot(snapshot => {
                const users = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lastSeen = data.lastSeen?.toDate() || new Date(0);
                    const now = new Date();
                    const diffMinutes = (now - lastSeen) / 1000 / 60;
                    
                    if (diffMinutes < 2) {
                        users.push({ id: doc.id, ...data });
                    }
                });
                
                const countElement = document.getElementById('quiz-online-count');
                const listElement = document.getElementById('quiz-online-users-list');
                
                if (!countElement || !listElement) {
                    if (quizOnlineUsersRef) {
                        quizOnlineUsersRef();
                        quizOnlineUsersRef = null;
                    }
                    return;
                }
                
                countElement.textContent = users.length;
                
                if (users.length === 0) {
                    listElement.innerHTML = `
                        <div class="loading">
                            No other students online right now. <br>
                            Share the app with friends to challenge them!
                        </div>
                    `;
                } else {
                    displayQuizOnlineUsers(users);
                }
            });
    } catch (error) {
        console.error('Error loading online users:', error);
    }
}

function displayQuizOnlineUsers(users) {
    const container = document.getElementById('quiz-online-users-list');
    
    container.innerHTML = users.map(user => {
        let avatarHTML = '';
        
        if (user.photoURL) {
            avatarHTML = `<div style="background-image: url('${user.photoURL}'); background-size: cover; background-position: center; width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px;"></div>`;
        } else {
            const initial = (user.name || 'S').charAt(0).toUpperCase();
            avatarHTML = `<div class="user-avatar" style="margin: 0 auto 10px;">${initial}</div>`;
        }
        
        return `
            <div class="online-user-card" data-user-id="${user.userId}" data-user-name="${user.name}" onclick="sendQuizChallenge(this.dataset.userId, this.dataset.userName)">
                ${avatarHTML}
                <h3 style="color: #0d3b66; margin: 10px 0;">${user.name}</h3>
                <span class="online-status"></span>
                <span style="color: #28a745; font-weight: bold;">Online</span>
                <button class="practice-btn" style="margin-top: 15px; font-size: 0.9rem; padding: 10px 20px; pointer-events: none;">
                    âš”ï¸ Challenge
                </button>
            </div>
        `;
    }).join('');
}

async function sendQuizChallenge(opponentId, opponentName) {
    if (!currentUser) return;
    
    try {
        const challengeRef = db.collection('quizChallenges').doc();
        
        await challengeRef.set({
            challenger: {
                id: currentUser.uid,
                name: currentUser.displayName || 'Student',
                photoURL: currentUser.photoURL || null
            },
            opponent: {
                id: opponentId,
                name: opponentName
            },
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showCustomPopup(`âš”ï¸ QUIZ CHALLENGE SENT TO ${opponentName.toUpperCase()}`);
        setTimeout(() => hideCustomPopup(), 3000);
        
    } catch (error) {
        console.error('Error sending quiz challenge:', error);
        showCustomPopup('âŒ FAILED TO SEND');
        setTimeout(() => hideCustomPopup(), 2000);
    }
}

function listenForQuizChallenges() {
    if (!currentUser) return;
    
    if (quizChallengeListener) {
        quizChallengeListener();
    }
    
    quizChallengeListener = db.collection('quizChallenges')
        .where('opponent.id', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                const challenge = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'added' || change.type === 'modified') {
                    if (challenge.status === 'pending') {
                        const challengerId = challenge.challenger.id;
                        const challengerPresence = await db.collection('onlineUsers').doc(challengerId).get();
                        
                        if (!challengerPresence.exists) {
                            console.log('ðŸš« Challenger went offline - removing quiz challenge');
                            await db.collection('quizChallenges').doc(challenge.id).delete();
                            
                            const popup = document.getElementById('quiz-challenge-popup-notification');
                            if (popup) popup.remove();
                            
                            shownQuizPopupIds.delete(challenge.id);
                            return;
                        }
                        
                        showQuizChallengePopup(challenge);
                        displayIncomingQuizChallenges([challenge]);
                    } else if (challenge.status === 'active') {
                        if (!activeQuizChallenge || activeQuizChallenge.id !== challenge.id) {
                            startLiveQuizChallenge(challenge.id);
                        }
                    }
                }
                
                if (change.type === 'removed') {
                    const popup = document.getElementById('quiz-challenge-popup-notification');
                    if (popup) popup.remove();
                    
                    shownQuizPopupIds.delete(challenge.id);
                }
            });
        });
}

function listenForMyQuizChallengesAccepted() {
    if (!currentUser) return;
    
    if (myQuizChallengeListener) {
        myQuizChallengeListener();
    }
    
    myQuizChallengeListener = db.collection('quizChallenges')
        .where('challenger.id', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const challenge = { id: change.doc.id, ...change.doc.data() };
                
                if (change.type === 'modified' && challenge.status === 'active') {
                    if (!activeQuizChallenge || activeQuizChallenge.id !== challenge.id) {
                        hideCustomPopup();
                        
                        showBottomNotification(`${challenge.opponent.name} accepted your quiz challenge! Starting game...`, 'success');
                        
                        navigateTo('quiz');
                        switchQuizMode('live');
                        
                        startLiveQuizChallenge(change.doc.id);
                    }
                }
            });
        });
}

function showQuizChallengePopup(challenge) {
    const challengeId = challenge.id;
    
    if (shownQuizPopupIds.has(challengeId)) return;
    shownQuizPopupIds.add(challengeId);
    
    const existingPopup = document.getElementById('quiz-challenge-popup-notification');
    if (existingPopup) existingPopup.remove();
    
    const popup = document.createElement('div');
    popup.id = 'quiz-challenge-popup-notification';
    popup.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(102,126,234,0.5);
        z-index: 9999;
        min-width: 320px;
        animation: slideInRight 0.5s ease-out;
    `;
    
    let avatarHTML = '';
    if (challenge.challenger.photoURL) {
        avatarHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background-image: url('${challenge.challenger.photoURL}'); background-size: cover; background-position: center; margin: 0 auto 10px;"></div>`;
    } else {
        const initial = (challenge.challenger.name || 'S').charAt(0).toUpperCase();
        avatarHTML = `<div style="width: 50px; height: 50px; border-radius: 50%; background: #ffd700; color: #0d3b66; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; margin: 0 auto 10px;">${initial}</div>`;
    }
    
    popup.innerHTML = `
        <div style="text-align: center;">
            ${avatarHTML}
            <h3 style="margin: 0 0 10px 0; font-size: 1.3rem;">ðŸŽ¯ QUIZ CHALLENGE!</h3>
            <p style="margin: 10px 0; font-size: 1.1rem;"><strong>${challenge.challenger.name}</strong> challenges you!</p>
            <p style="margin: 10px 0; font-size: 0.9rem; opacity: 0.9;">Ready for a vocabulary quiz battle?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button onclick="acceptQuizChallengeFromPopup('${challengeId}')" 
                        style="padding: 12px 25px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                    âœ… Accept
                </button>
                <button onclick="declineQuizChallengeFromPopup('${challengeId}')" 
                        style="padding: 12px 25px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                    âŒ Decline
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(popup);
}

function displayIncomingQuizChallenges(challenges) {
    const section = document.getElementById('quiz-incoming-challenges-section');
    const container = document.getElementById('quiz-incoming-challenges-list');
    
    if (challenges.length === 0) {
        section.style.display = 'none';
        return;
    }
    
    section.style.display = 'block';
    
    container.innerHTML = challenges.map(challenge => `
        <div class="challenge-notification">
            <h3 style="margin: 0 0 10px 0;">ðŸŽ¯ ${challenge.challenger.name} challenges you to a quiz!</h3>
            <p style="margin: 10px 0;">Ready for a vocabulary battle?</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button class="practice-btn" onclick="acceptQuizChallenge('${challenge.id}')" 
                        style="background: #28a745;">
                    âœ… Accept
                </button>
                <button class="practice-btn" onclick="declineQuizChallenge('${challenge.id}')" 
                        style="background: #dc3545;">
                    âŒ Decline
                </button>
            </div>
        </div>
    `).join('');
}

async function acceptQuizChallenge(challengeId) {
    console.log('âœ… Starting acceptQuizChallenge for:', challengeId);
    
    if (activeQuizChallenge && activeQuizChallenge.status === 'active') {
        showCustomPopup('âš ï¸ COMPLETE CURRENT QUIZ FIRST');
        setTimeout(() => hideCustomPopup(), 3000);
        
        const popup = document.getElementById('quiz-challenge-popup-notification');
        if (popup) popup.remove();
        
        return;
    }
    
    try {
        const challengeRef = db.collection('quizChallenges').doc(challengeId);
        const challengeDoc = await challengeRef.get();
        
        if (!challengeDoc.exists) {
            console.error('âŒ Quiz challenge not found:', challengeId);
            alert('Quiz challenge not found');
            return;
        }
        
        const challengeData = challengeDoc.data();
        console.log('ðŸ“„ Quiz challenge data:', challengeData);
        
        // Generate 5 random words and quiz questions
        if (!selectedGameLevel) {
            selectedGameLevel = 'foundation';
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            console.log('ðŸ“š Loading words for level:', selectedGameLevel);
            await loadLevelWords(selectedGameLevel);
        }
        
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        const quizWords = shuffled.slice(0, 5);
        
        console.log('ðŸŽ¯ Selected quiz words:', quizWords);
        
        // Generate quiz questions for these words
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                data: { 
                    action: 'generatePracticeQuiz',
                    words: quizWords 
                } 
            })
        });
        
        const data = await response.json();
        const quizQuestions = data.result.questions;
        
        await challengeRef.update({
            status: 'active',
            questions: quizQuestions,
            scores: {
                [currentUser.uid]: 0,
                [challengeData.challenger.id]: 0
            },
            completed: {
                [currentUser.uid]: false,
                [challengeData.challenger.id]: false
            },
            currentQuestion: 0,
            acceptedBy: currentUser.uid,
            startedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Quiz challenge updated to active');
        
        navigateTo('quiz', true);
        
        setTimeout(() => {
            switchQuizMode('live');
            
            setTimeout(() => {
                startLiveQuizChallenge(challengeId);
            }, 300);
        }, 300);
        
    } catch (error) {
        console.error('âŒ Error accepting quiz challenge:', error);
        alert('Failed to accept quiz challenge: ' + error.message);
    }
}

async function acceptQuizChallengeFromPopup(challengeId) {
    console.log('ðŸŽ¯ Accepting quiz challenge from popup:', challengeId);
    
    if (activeQuizChallenge && activeQuizChallenge.status === 'active') {
        showCustomPopup('âš ï¸ COMPLETE CURRENT QUIZ FIRST');
        setTimeout(() => hideCustomPopup(), 3000);
        
        const popup = document.getElementById('quiz-challenge-popup-notification');
        if (popup) popup.remove();
        
        return;
    }
    
    const popup = document.getElementById('quiz-challenge-popup-notification');
    if (popup) popup.remove();
    
    shownQuizPopupIds.delete(challengeId);
    
    await acceptQuizChallenge(challengeId);
}

async function declineQuizChallenge(challengeId) {
    try {
        await db.collection('quizChallenges').doc(challengeId).delete();
        
        shownQuizPopupIds.delete(challengeId);
        
        const popup = document.getElementById('quiz-challenge-popup-notification');
        if (popup) popup.remove();
        
        const section = document.getElementById('quiz-incoming-challenges-section');
        if (section) section.style.display = 'none';
        
        console.log('âœ… Quiz challenge declined and deleted');
    } catch (error) {
        console.error('Error declining quiz challenge:', error);
    }
}

async function declineQuizChallengeFromPopup(challengeId) {
    console.log('âŒ Declining quiz challenge from popup:', challengeId);
    
    const popup = document.getElementById('quiz-challenge-popup-notification');
    if (popup) popup.remove();
    
    shownQuizPopupIds.delete(challengeId);
    
    await declineQuizChallenge(challengeId);
}

async function startLiveQuizChallenge(challengeId) {
    try {
        console.log('ðŸŽ® Starting live quiz challenge:', challengeId);
        
        if (quizOnlineUsersRef) {
            quizOnlineUsersRef();
            quizOnlineUsersRef = null;
            console.log('âœ… Detached quiz online users listener');
        }
        
        const challengeDoc = await db.collection('quizChallenges').doc(challengeId).get();
        
        if (!challengeDoc.exists) {
            alert('Quiz challenge not found');
            return;
        }
        
        const challenge = challengeDoc.data();
        
        activeQuizChallenge = { id: challengeId, ...challenge };
        quizChallengeWords = challenge.questions || [];
        currentQuizChallengeIndex = 0;
        myQuizScore = 0;
        opponentQuizScore = 0;
        
        const onlineUsersSection = document.getElementById('quiz-online-users-section');
        const incomingChallengesSection = document.getElementById('quiz-incoming-challenges-section');
        
        if (onlineUsersSection) onlineUsersSection.style.display = 'none';
        if (incomingChallengesSection) incomingChallengesSection.style.display = 'none';
        
        const liveQuizMode = document.getElementById('live-quiz-mode');
        if (!liveQuizMode) {
            console.error('âŒ live-quiz-mode not found');
            alert('Failed to start quiz challenge - page element missing');
            return;
        }
        
        let welcomeSection = liveQuizMode.querySelector('.welcome-section');
        
        if (!welcomeSection) {
            welcomeSection = document.createElement('div');
            welcomeSection.className = 'welcome-section';
            liveQuizMode.appendChild(welcomeSection);
        }
        
        welcomeSection.innerHTML = '<div id="live-quiz-challenge-container"></div>';
        
        startChallengeTimeout(challengeId);
        startOfflineDetection(challengeId);
        
        db.collection('quizChallenges').doc(challengeId).onSnapshot(doc => {
            const data = doc.data();
            
            if (!data) return;
            
            if (data.status === 'completed') {
                clearChallengeTimers();
                
                if (data.endReason === 'finished') {
                    showQuizChallengeResults(data);
                } else {
                    showQuizChallengeAbandoned(data);
                }
                return;
            }
            
            if (data.status === 'abandoned') {
                clearChallengeTimers();
                showQuizChallengeAbandoned(data);
                return;
            }
            
            const opponentId = activeQuizChallenge.challenger.id === currentUser.uid ? 
                activeQuizChallenge.opponent.id : activeQuizChallenge.challenger.id;
            opponentQuizScore = data.scores?.[opponentId] || 0;
            
            const scoreElements = document.querySelectorAll('.player-score .score');
            if (scoreElements && scoreElements.length > 1) {
                scoreElements[1].textContent = opponentQuizScore;
            }
        });
        
        loadQuizChallengeQuestion();
    } catch (error) {
        console.error('Error starting quiz challenge:', error);
        alert('Failed to start quiz challenge: ' + error.message);
    }
}

function loadQuizChallengeQuestion() {
    if (!quizChallengeWords || quizChallengeWords.length === 0) {
        alert('No questions available for challenge');
        return;
    }
    
    const question = quizChallengeWords[currentQuizChallengeIndex];
    const container = document.getElementById('live-quiz-challenge-container');
    
    if (!container) {
        console.error('âŒ live-quiz-challenge-container not found');
        return;
    }
    
    const opponentName = activeQuizChallenge.challenger.id === currentUser.uid ? 
        activeQuizChallenge.opponent.name : activeQuizChallenge.challenger.name;
    
    container.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1);">
            <h2 style="color: #0d3b66; margin-bottom: 20px; text-align: center;">ðŸŽ¯ Live Quiz Battle!</h2>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">You</div>
                    <div class="score">${myQuizScore}</div>
                </div>
                <div style="font-size: 2rem; align-self: center;">VS</div>
                <div class="player-score">
                    <div class="name">${opponentName}</div>
                    <div class="score">${opponentQuizScore}</div>
                </div>
            </div>
            
            <div class="quiz-question-card">
                <h3>Question ${currentQuizChallengeIndex + 1} of ${quizChallengeWords.length}</h3>
                <p style="font-size: 1.3rem; margin: 20px 0;"><strong>${question.question}</strong></p>
                <div class="quiz-options">
                    ${question.options.map((option, index) => `
                        <div class="quiz-option" onclick="submitQuizChallengeAnswer(${index})">
                            ${option}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="practice-btn" onclick="exitQuizChallenge()" style="background: #dc3545;">
                    ðŸšª Exit Challenge
                </button>
            </div>
        </div>
    `;
}

async function submitQuizChallengeAnswer(selectedIndex) {
    const question = quizChallengeWords[currentQuizChallengeIndex];
    const options = document.querySelectorAll('.quiz-option');
    
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        myQuizScore++;
        options[selectedIndex].classList.add('correct');
    } else {
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
    }
    
    try {
        const challengeRef = db.collection('quizChallenges').doc(activeQuizChallenge.id);
        const scoreKey = `scores.${currentUser.uid}`;
        const completedKey = `completed.${currentUser.uid}`;
        
        await challengeRef.update({
            [scoreKey]: myQuizScore,
            [`lastAnswerTime.${currentUser.uid}`]: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentQuizChallengeIndex++;
        
        if (currentQuizChallengeIndex >= quizChallengeWords.length) {
            await challengeRef.update({
                [completedKey]: true
            });
            
            const challengeDoc = await challengeRef.get();
            const challengeData = challengeDoc.data();
            const opponentId = activeQuizChallenge.challenger.id === currentUser.uid ? 
                activeQuizChallenge.opponent.id : activeQuizChallenge.challenger.id;
            
            if (challengeData.completed && challengeData.completed[opponentId]) {
                await challengeRef.update({
                    status: 'completed',
                    endReason: 'finished',
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                showWaitingForQuizOpponent();
            }
        } else {
            setTimeout(() => {
                loadQuizChallengeQuestion();
            }, 2000);
        }
    } catch (error) {
        console.error('Error updating quiz score:', error);
    }
}

function showWaitingForQuizOpponent() {
    const container = document.getElementById('live-quiz-challenge-container');
    
    if (!container) {
        console.error('âŒ live-quiz-challenge-container not found');
        return;
    }
    
    const opponentName = activeQuizChallenge.challenger.id === currentUser.uid ? 
        activeQuizChallenge.opponent.name : activeQuizChallenge.challenger.name;
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0; animation: pulse 2s infinite;">â³</div>
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 20px;">
                Waiting for ${opponentName}...
            </h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You've completed all questions! <br>
                Waiting for your opponent to finish.
            </p>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">Your Score</div>
                    <div class="score">${myQuizScore}</div>
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <div class="loading">Challenge will end when both players finish...</div>
            </div>
        </div>
    `;
}

async function showQuizChallengeResults(challenge) {
    const myId = currentUser.uid;
    const opponentId = challenge.challenger.id === myId ? challenge.opponent.id : challenge.challenger.id;
    
    const myFinalScore = challenge.scores[myId] || 0;
    const opponentFinalScore = challenge.scores[opponentId] || 0;
    
    const won = myFinalScore > opponentFinalScore;
    const tied = myFinalScore === opponentFinalScore;
    
    // Update quiz stats
    try {
        const userRef = db.collection('users').doc(myId);
        const userDoc = await userRef.get();
        const currentStats = userDoc.data().quizStats || {
            totalChallenges: 0,
            wins: 0,
            losses: 0,
            totalScore: 0,
            winStreak: 0,
            bestStreak: 0
        };
        
        let newStats = {
            totalChallenges: currentStats.totalChallenges + 1,
            wins: currentStats.wins + (won ? 1 : 0),
            losses: currentStats.losses + (tied ? 0 : (won ? 0 : 1)),
            totalScore: currentStats.totalScore + myFinalScore,
            winStreak: won ? currentStats.winStreak + 1 : 0,
            bestStreak: won ? Math.max(currentStats.bestStreak, currentStats.winStreak + 1) : currentStats.bestStreak,
            lastPlayed: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await userRef.update({
            quizStats: newStats
        });
        
        console.log('âœ… Quiz stats updated:', newStats);
    } catch (error) {
        console.error('Error updating quiz stats:', error);
    }
    
    // Award coins for win
    if (won) {
        await awardCoins(COINS_PER_WIN);
    }
    
    const container = document.getElementById('live-quiz-challenge-container');
    
    if (!container) {
        console.error('âŒ live-quiz-challenge-container not found');
        return;
    }
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">
                ${won ? 'ðŸ†' : tied ? 'ðŸ¤' : 'ðŸ˜”'}
            </div>
            <h2 style="color: #0d3b66; font-size: 2.5rem; margin-bottom: 20px;">
                ${won ? 'Victory!' : tied ? "It's a Tie!" : 'Better Luck Next Time'}
            </h2>
            
            ${won ? `
                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 20px; border-radius: 15px; margin: 20px 0;">
                    <h3 style="color: #0d3b66; font-size: 1.5rem; margin-bottom: 10px;">ðŸª™ Coins Earned!</h3>
                    <p style="color: #0d3b66; font-size: 2rem; font-weight: bold;">+${COINS_PER_WIN} Coins</p>
                    <p style="color: #0d3b66; font-size: 1rem; margin-top: 5px;">Total: ${userCoins} / ${MAX_COINS}</p>
                </div>
            ` : ''}
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">You</div>
                    <div class="score">${myFinalScore}</div>
                </div>
                <div style="font-size: 2rem; align-self: center;">-</div>
                <div class="player-score">
                    <div class="name">Opponent</div>
                    <div class="score">${opponentFinalScore}</div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <button class="practice-btn" onclick="navigateTo('quiz'); switchQuizMode('leaderboard');" style="background: #667eea; margin: 5px;">
                    ðŸ“Š View Leaderboard
                </button>
                <button class="practice-btn" onclick="exitQuizChallenge()" style="margin: 5px;">
                    ðŸ  Back to Lobby
                </button>
            </div>
        </div>
    `;
}

function showQuizChallengeAbandoned(challenge) {
    const container = document.getElementById('live-quiz-challenge-container');
    
    if (!container) {
        console.error('âŒ live-quiz-challenge-container not found');
        return;
    }
    
    const iWon = challenge.winner === currentUser.uid;
    
    let message = '';
    if (challenge.endReason === 'opponent_left') {
        message = 'Your opponent left the challenge.';
    } else if (challenge.endReason === 'opponent_offline') {
        message = 'Your opponent went offline.';
    } else {
        message = 'The challenge was cancelled.';
    }
    
    container.innerHTML = `
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${iWon ? 'ðŸ†' : 'ðŸš«'}</div>
            <h2 style="color: #0d3b66; font-size: 2rem; margin-bottom: 15px;">Challenge Ended</h2>
            <p style="font-size: 1.2rem; margin: 20px 0; color: #666;">
                ${message}
            </p>
            
            <div class="challenge-score-card">
                <div class="player-score">
                    <div class="name">Your Score</div>
                    <div class="score">${myQuizScore}</div>
                </div>
            </div>
            
            ${iWon ? `
                <p style="margin: 20px 0; font-size: 1.5rem; color: #28a745; font-weight: bold;">
                    ðŸŽ‰ You win by default!
                </p>
            ` : `
                <p style="margin: 20px 0; font-size: 1.2rem; color: #dc3545; font-weight: bold;">
                    You left the challenge
                </p>
            `}
            
            <button class="practice-btn" onclick="exitQuizChallenge()" style="margin-top: 30px; font-size: 1.2rem; padding: 15px 40px;">
                ðŸ  Back to Lobby
            </button>
        </div>
    `;
}

async function exitQuizChallenge() {
    try {
        if (activeQuizChallenge && activeQuizChallenge.status === 'active') {
            const challengeDoc = await db.collection('quizChallenges').doc(activeQuizChallenge.id).get();
            const challengeData = challengeDoc.data();
            
            const userCompleted = challengeData.completed && challengeData.completed[currentUser.uid];
            
            if (!userCompleted) {
                const opponentId = activeQuizChallenge.challenger.id === currentUser.uid ? 
                    activeQuizChallenge.opponent.id : activeQuizChallenge.challenger.id;
                
                await db.collection('quizChallenges').doc(activeQuizChallenge.id).update({
                    status: 'abandoned',
                    endReason: 'opponent_left',
                    winner: opponentId,
                    loser: currentUser.uid,
                    endedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('âœ… Quiz challenge abandoned - opponent wins');
            } else {
                console.log('âœ… User completed quiz challenge, just returning to lobby');
            }
        }
    } catch (error) {
        console.error('Error updating quiz challenge on exit:', error);
    }
    
    clearChallengeTimers();
    
    activeQuizChallenge = null;
    quizChallengeWords = [];
    currentQuizChallengeIndex = 0;
    myQuizScore = 0;
    opponentQuizScore = 0;
    shownQuizPopupIds.clear();
    
    const onlineUsersSection = document.getElementById('quiz-online-users-section');
    const incomingChallengesSection = document.getElementById('quiz-incoming-challenges-section');
    
    if (onlineUsersSection) {
        onlineUsersSection.style.display = 'block';
    }
    
    if (incomingChallengesSection) {
        incomingChallengesSection.style.display = 'none';
    }
    
    const liveQuizMode = document.getElementById('live-quiz-mode');
    if (!liveQuizMode) {
        console.error('âŒ live-quiz-mode not found');
        return;
    }
    
    let welcomeSection = liveQuizMode.querySelector('.welcome-section');
    
    if (!welcomeSection) {
        welcomeSection = document.createElement('div');
        welcomeSection.className = 'welcome-section';
        liveQuizMode.appendChild(welcomeSection);
    }
    
    welcomeSection.innerHTML = `
        <h2>âš¡ Live Quiz Challenges</h2>
        <p style="margin: 20px 0;">Challenge other students to vocabulary quiz battles in real-time!</p>
        
        <!-- Online Users Section -->
        <div id="quiz-online-users-section">
            <h3 style="color: #0d3b66; margin: 20px 0;">ðŸ‘¥ Online Students (<span id="quiz-online-count">0</span>)</h3>
            <div id="quiz-online-users-list" class="favorites-grid">
                <div class="loading">Loading online users...</div>
            </div>
        </div>
        
        <!-- Incoming Challenges -->
        <div id="quiz-incoming-challenges-section" style="margin-top: 30px; display: none;">
            <h3 style="color: #dc3545; margin: 20px 0;">âš¡ Incoming Quiz Challenges</h3>
            <div id="quiz-incoming-challenges-list"></div>
        </div>
    `;
    
    loadQuizOnlineUsers();
}

// Quiz Leaderboard Functions
async function loadQuizLeaderboard() {
    const container = document.getElementById('quiz-leaderboard-container');
    
    if (!container) {
        console.error('âŒ Quiz leaderboard container not found');
        return;
    }
    
    try {
        container.innerHTML = '<div class="loading">ðŸ“Š Loading quiz leaderboard...</div>';
        
        const usersSnapshot = await db.collection('users')
            .where('quizStats.wins', '>', 0)
            .orderBy('quizStats.wins', 'desc')
            .limit(50)
            .get();
        
        if (usersSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ðŸ†</div>
                    <h3>No ranked players yet</h3>
                    <p>Be the first to win a quiz challenge!</p>
                </div>
            `;
            return;
        }
        
        const players = [];
        usersSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.quizStats) {
                players.push({
                    id: doc.id,
                    name: data.name,
                    email: data.email,
                    photoURL: data.photoURL,
                    country: data.country,
                    age: data.age,
                    createdAt: data.createdAt,
                    stats: data.quizStats
                });
            }
        });
        
        players.sort((a, b) => {
            if (b.stats.wins !== a.stats.wins) {
                return b.stats.wins - a.stats.wins;
            }
            const aWinRate = a.stats.wins / a.stats.totalChallenges;
            const bWinRate = b.stats.wins / b.stats.totalChallenges;
            return bWinRate - aWinRate;
        });
        
        const myRank = players.findIndex(p => p.id === currentUser?.uid) + 1;
        
        container.innerHTML = `
            ${currentUser && myRank > 0 ? `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 25px; color: white; text-align: center;">
                    <h3 style="margin: 0 0 10px 0; color: white;">ðŸŽ¯ Your Rank</h3>
                    <p style="font-size: 2.5rem; margin: 10px 0; font-weight: bold;">#${myRank}</p>
                    <p style="margin: 5px 0; opacity: 0.9;">
                        ${players[myRank - 1].stats.wins} Wins â€¢ 
                        ${players[myRank - 1].stats.totalChallenges} Challenges
                    </p>
                </div>
            ` : ''}
            
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th style="text-align: center;">ðŸ† Rank</th>
                            <th>ðŸ‘¤ Player</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${players.map((player, index) => {
                            const isCurrentUser = currentUser && player.id === currentUser.uid;
                            
                            let rankEmoji = '';
                            if (index === 0) rankEmoji = 'ðŸ¥‡';
                            else if (index === 1) rankEmoji = 'ðŸ¥ˆ';
                            else if (index === 2) rankEmoji = 'ðŸ¥‰';
                            
                            let avatarHTML = '';
                            if (player.photoURL) {
                                avatarHTML = `<div style="width: 45px; height: 45px; min-width: 45px; border-radius: 50%; background-image: url('${player.photoURL}'); background-size: cover; background-position: center;"></div>`;
                            } else {
                                const initial = (player.name || 'P').charAt(0).toUpperCase();
                                avatarHTML = `<div class="coach-avatar" style="width: 45px; height: 45px; min-width: 45px;">${initial}</div>`;
                            }
                            
                            return `
                                <tr onclick="showQuizLeaderboardPlayerDetail('${player.id}', ${index + 1})" style="cursor: pointer; ${isCurrentUser ? 'background: #e3f2fd;' : ''}">
                                    <td style="text-align: center; font-size: 1.3rem; font-weight: bold; color: #0d3b66;">
                                        ${rankEmoji || (index + 1)}
                                    </td>
                                    <td>
                                        <div class="coach-profile-cell">
                                            ${avatarHTML}
                                            <div class="coach-name">${player.name}${isCurrentUser ? ' (You)' : ''}</div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">ðŸ† How Rankings Work</h3>
                <p style="color: #666; line-height: 1.6;">
                    â€¢ Players are ranked by <strong>total wins</strong> in live quiz challenges<br>
                    â€¢ Click on any player to view their detailed stats<br>
                    â€¢ Challenge top players to climb the leaderboard!
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('âŒ Error loading quiz leaderboard:', error);
        container.innerHTML = `
            <div class="feedback error">
                âŒ Error loading leaderboard. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadQuizLeaderboard()">ðŸ”„ Retry</button>
            </div>
        `;
    }
}

async function showQuizLeaderboardPlayerDetail(playerId, rank) {
    try {
        console.log('ðŸ“‹ Loading quiz player details for:', playerId);
        const playerDoc = await db.collection('users').doc(playerId).get();
        
        if (!playerDoc.exists) {
            console.error('âŒ Player not found');
            alert('Player profile not found');
            return;
        }
        
        const player = { id: playerDoc.id, ...playerDoc.data() };
        console.log('Player data loaded:', player);
        
        const modal = document.getElementById('quizLeaderboardPlayerModal');
        
        const studentId = `WB-2025-${player.id.slice(-4).toUpperCase()}`;
        
        const stats = player.quizStats || {
            wins: 0,
            losses: 0,
            totalChallenges: 0,
            winStreak: 0,
            bestStreak: 0,
            totalScore: 0
        };
        
        const winRate = stats.totalChallenges > 0 
            ? ((stats.wins / stats.totalChallenges) * 100).toFixed(1) 
            : '0.0';
        
        let rankEmoji = '';
        if (rank === 1) rankEmoji = 'ðŸ¥‡';
        else if (rank === 2) rankEmoji = 'ðŸ¥ˆ';
        else if (rank === 3) rankEmoji = 'ðŸ¥‰';
        
        const avatar = document.getElementById('modal-quiz-leaderboard-avatar');
        if (player.photoURL) {
            console.log('ðŸ–¼ï¸ Setting photo URL:', player.photoURL);
            avatar.style.backgroundImage = `url('${player.photoURL}')`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
            avatar.textContent = '';
        } else {
            console.log('ðŸ”¤ No photo URL, using initial');
            avatar.style.backgroundImage = 'none';
            avatar.textContent = (player.name || 'P').charAt(0).toUpperCase();
        }
        
        document.getElementById('modal-quiz-leaderboard-name').textContent = player.name || 'Player';
        document.getElementById('modal-quiz-leaderboard-rank').innerHTML = `${rankEmoji} Rank #${rank}`;
        document.getElementById('modal-quiz-leaderboard-id').textContent = studentId;
        document.getElementById('modal-quiz-leaderboard-email').textContent = player.email || 'N/A';
        document.getElementById('modal-quiz-leaderboard-country').textContent = player.country || 'N/A';
        
        const ageRow = document.getElementById('modal-quiz-leaderboard-age-row');
        if (player.age) {
            ageRow.style.display = 'flex';
            document.getElementById('modal-quiz-leaderboard-age').textContent = player.age + ' years old';
        } else {
            ageRow.style.display = 'none';
        }
        
        if (player.createdAt) {
            const joinDate = player.createdAt.toDate();
            document.getElementById('modal-quiz-leaderboard-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            document.getElementById('modal-quiz-leaderboard-joined').textContent = 'Recently';
        }
        
        document.getElementById('modal-quiz-leaderboard-wins').textContent = stats.wins;
        document.getElementById('modal-quiz-leaderboard-losses').textContent = stats.losses;
        document.getElementById('modal-quiz-leaderboard-total').textContent = stats.totalChallenges;
        document.getElementById('modal-quiz-leaderboard-winrate').textContent = winRate + '%';
        document.getElementById('modal-quiz-leaderboard-streak').textContent = stats.winStreak > 0 ? 'ðŸ”¥ ' + stats.winStreak : '-';
        document.getElementById('modal-quiz-leaderboard-best').textContent = stats.bestStreak;
        
        modal.classList.add('active');
        console.log('Modal displayed');
        
    } catch (error) {
       console.error('âŒ Error loading quiz player details:', error);
        alert('Unable to load player details: ' + error.message);
    }
}

function closeQuizLeaderboardPlayerModal() {
    document.getElementById('quizLeaderboardPlayerModal').classList.remove('active');
}

// Initialize quiz listeners when switching to live mode
document.addEventListener('DOMContentLoaded', function() {
    // Listen for quiz challenges when user signs in
    auth.onAuthStateChanged(user => {
        if (user) {
            listenForQuizChallenges();
            listenForMyQuizChallengesAccepted();
        }
    });
});

// Cleanup old quiz challenges on page load
async function cleanupOldQuizChallenges() {
    if (!currentUser) {
        console.log('â­ï¸ Skipping quiz challenge cleanup - no user logged in');
        return;
    }
    
    try {
        const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
        
        const myQuizChallenges = await db.collection('quizChallenges')
            .where('createdAt', '<', firebase.firestore.Timestamp.fromDate(oneDayAgo))
            .get();
        
        const deletePromises = [];
        myQuizChallenges.docs.forEach(doc => {
            const data = doc.data();
            if (data.challenger?.id === currentUser.uid || data.opponent?.id === currentUser.uid) {
                deletePromises.push(doc.ref.delete());
            }
        });
        
        if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            console.log(`ðŸ§¹ Cleaned up ${deletePromises.length} old quiz challenges`);
        }
    } catch (error) {
        console.log('â„¹ï¸ Could not cleanup old quiz challenges (this is normal):', error.message);
    }
}

// Check quiz challenger presence every 10 seconds
setInterval(async () => {
    if (!currentUser) return;
    
    try {
        const pendingQuizChallenges = await db.collection('quizChallenges')
            .where('opponent.id', '==', currentUser.uid)
            .where('status', '==', 'pending')
            .get();
        
        for (const doc of pendingQuizChallenges.docs) {
            const challenge = doc.data();
            const challengerId = challenge.challenger.id;
            
            const challengerPresence = await db.collection('onlineUsers').doc(challengerId).get();
            
            if (!challengerPresence.exists) {
                console.log('ðŸš« Quiz challenger offline - removing challenge:', doc.id);
                await doc.ref.delete();
                
                const popup = document.getElementById('quiz-challenge-popup-notification');
                if (popup) popup.remove();
                
                shownQuizPopupIds.delete(doc.id);
            }
        }
    } catch (error) {
        console.error('Error checking quiz challenger presence:', error);
    }
}, 10000);

// Call cleanup on page load
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        cleanupOldChallenges();
        cleanupOldQuizChallenges();
    }, 2000);
});



// ===== STUDENT ID GENERATION =====
function generateStudentId(userId) {
    return `WB-2025-${userId.slice(-4).toUpperCase()}`;
}        
    </script>
</body>
</html>
