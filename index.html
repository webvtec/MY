<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORD BIZ COACHING ACADEMY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Georgia, 'Times New Roman', serif;
            overflow-x: hidden;
            background: #f5f5f5;
        }
        
        html {
            overflow-x: hidden;
        }

        /* ===== HEADER STYLES ===== */
        .header {
            background: #0d3b66;
            position: sticky;
            top: 0;
            z-index: 1000;
            width: 100%;
            max-width: 100vw;
        }

.top-bar {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            width: 100%;
            gap: 15px;
            position: relative;
        }

        .left-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-icon {
            display: flex;
            flex-direction: column;
            gap: 4px;
            cursor: pointer;
        }

        .menu-icon:hover span {
            background: #ffd700;
        }

        .menu-icon span {
            width: 30px;
            height: 4px;
            background: white;
            border-radius: 2px;
        }

.logo {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.6rem;
            font-weight: bold;
            font-style: italic;
            color: white;
            letter-spacing: 2px;
            white-space: nowrap;
            pointer-events: none;
        }
    
.nav-bar {
            display: flex;
            background: #0a2f4d;
            justify-content: space-evenly;
            width: 100%;
            overflow-x: auto;
        }

        .nav-item {
            padding: 14px 15px;
            text-align: center;
            color: white;
            font-size: 1.1rem;
            font-weight: bold;
            font-style: italic;
            letter-spacing: 1.2px;
            cursor: pointer;
            white-space: nowrap;
            flex: 1;
            min-width: fit-content;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        /* ===== SIDEBAR STYLES ===== */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: #0a2f4d;
            transition: left 0.3s;
            z-index: 2000;
            overflow-y: auto;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 30px 20px;
            background: #0d3b66;
            color: white;
            border-bottom: 2px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        .sidebar-user-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-user-info .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ffd700;
            color: #0d3b66;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 2rem;
        }
        
        .sidebar-user-info span {
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }

        .sidebar-item {
            padding: 18px 25px;
            color: white;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
        }

        .sidebar-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .sidebar-item.sign-in {
            background: #0d3b66;
            font-weight: bold;
            font-style: italic;
            letter-spacing: 1.5px;
            text-align: center;
            margin-top: 10px;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
        }

        .overlay.active {
            display: block;
        }

        /* ===== MAIN CONTENT STYLES ===== */
       .container {
    max-width: 1200px;
    margin: 30px auto;
    padding: 0 20px;
}

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

       .welcome-section {
    background: white;
    padding: 40px 20px;
    border-radius: 15px;
    margin-bottom: 30px;
    text-align: left;
    position: relative;
    z-index: 1;
}

/* Outer glowing border - blue, pink, purple theme */
/* Outer glowing border - blue, pink, purple theme */
.welcome-section::before {
    content: '';
    position: absolute;
    top: -4px;
    left: -4px;
    right: -4px;
    bottom: -4px;
    background: linear-gradient(45deg, 
        #0d3b66 0%, 
        #667eea 14%, 
        #764ba2 28%, 
        #f093fb 42%, 
        #4facfe 57%, 
        #00f2fe 71%, 
        #667eea 85%, 
        #0d3b66 100%);
    border-radius: 15px;
    z-index: -1;
    filter: blur(8px);
}
/* Inner chasing border */
.welcome-section::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: white; /* Solid white background */
    border-radius: 15px;
    z-index: -1;
}
        .welcome-section h1 {
    color: #0d3b66;
    font-size: clamp(1.5rem, 5vw, 2.5rem);
    margin-bottom: 15px;
    text-align: center;
    white-space: nowrap;
}
        
        .welcome-section p {
            color: #666;
            font-size: 1.2rem;
            line-height: 1.6;
        }

        /* ===== WORD DATABASE SECTION ===== */
        .word-database {
    background: white;
    padding: 30px 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

        .database-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .database-header h2 {
            color: #0d3b66;
            font-size: 2rem;
        }

        .search-box {
            display: flex;
            gap: 10px;
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #0d3b66;
            border-radius: 5px;
            font-size: 1rem;
            font-family: Georgia, serif;
        }

        .search-box button {
            padding: 12px 25px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
        }

        .search-box button:hover {
            background: #0a2f4d;
        }

        /* ===== ALPHABET NAVIGATION ===== */
        .alphabet-nav {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 25px;
            justify-content: center;
        }

        .letter-btn {
            width: 40px;
            height: 40px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
        }

        .letter-btn:hover {
            background: #ffd700;
            color: #0d3b66;
        }

        .letter-btn.active {
            background: #ffd700;
            color: #0d3b66;
        }

        /* ===== LOADING & STATUS ===== */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2rem;
        }

        .status-message {
            padding: 15px;
            background: #e3f2fd;
            border-left: 4px solid #0d3b66;
            margin-bottom: 20px;
            border-radius: 5px;
        }

      /* ===== WORD CARD STYLES ===== */
.word-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
    max-height: 70vh;
    overflow-y: auto;
}

.word-card {
    background: #f9f9f9;
    border: 2px solid #0d3b66;
    border-radius: 8px;
    padding: 12px 18px;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.word-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.word-title {
    font-size: 1.8rem;
    color: #0d3b66;
    font-weight: bold;
    margin: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.word-actions {
    display: flex;
    gap: 10px;
}

.icon-btn {
    background: #0d3b66;
    color: white;
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
}

.icon-btn:hover {
    background: #ffd700;
    color: #0d3b66;
}

.icon-btn.favorited {
    background: #ffd700;
    color: #0d3b66;
}

.word-phonetic {
    color: #666;
    font-style: italic;
    margin: 0;
    font-size: 0.9rem;
    line-height: 1.2;
}

.word-phonetic-preview {
    color: #000; 
    font-style: italic;
    margin: 0;
    font-size: 0.9rem;
    line-height: 1.2;
    min-height: 16px;
}

.word-pos {
    display: inline-block;
    background: #0d3b66;
    color: white;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.word-definition {
    color: #666;
    line-height: 1.3;
    margin: 0;
    font-size: 0.9rem;
    font-weight: 400;
}

.word-example {
    background: #e3f2fd;
    padding: 10px;
    border-left: 3px solid #0d3b66;
    font-style: italic;
    color: #555;
    margin-top: 10px;
}

.user-type-btn {
    width: 100%;
    padding: 20px;
    background: white;
    border: 3px solid #0d3b66;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s;
    font-family: Georgia, serif;
    text-align: center;
}

.user-type-btn:hover {
    background: #e3f2fd;
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
        
        /* ===== WORD DETAIL MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            background: #0d3b66;
            color: white;
            padding: 25px;
            border-radius: 10px 10px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        .modal-body {
            padding: 30px;
        }

        .practice-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .practice-btn {
            padding: 15px 30px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            font-family: Georgia, serif;
        }

        .practice-btn:hover {
            background: #ffd700;
            color: #0d3b66;
        }

        .practice-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .practice-btn.listening {
            background: #ff6b6b;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-weight: bold;
        }

        .feedback.success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .feedback.error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        /* ===== QUIZ STYLES ===== */
        .quiz-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 3px solid #0d3b66;
            flex-wrap: wrap;
        }

        .quiz-tab {
            padding: 15px 30px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px 10px 0 0;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
            color: #0d3b66;
            transition: all 0.3s;
        }

        .quiz-tab:hover {
            background: #e3f2fd;
        }

        .quiz-tab.active {
            background: #0d3b66;
            color: white;
        }

        .quiz-mode {
            display: none;
        }

        .quiz-mode.active {
            display: block;
        }

        .quiz-question-card {
    background: white;
    padding: 10px 10px; 
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin: 20px 0;
    max-width: 100%;
}

        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }

        .quiz-option {
            padding: 15px 20px;
            background: #f9f9f9;
            border: 2px solid #0d3b66;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s;
            text-align: left;
        }

        .quiz-option:hover {
            background: #e3f2fd;
            transform: translateX(10px);
        }

        .quiz-option.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .quiz-option.wrong {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .quiz-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0d3b66;
            margin: 20px 0;
            text-align: center;
        }

        .favorite-heart {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .favorite-heart:hover {
            transform: scale(1.2);
        }

        .favorite-heart.active {
            color: #ff6b6b;
        }

        /* ===== VERIFICATION MODAL ===== */
.verification-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
}

.verification-modal.active {
    display: flex;
}

.verification-content {
    background: white;
    border-radius: 15px;
    max-width: 500px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 10px 50px rgba(255,0,0,0.3);
    border: 3px solid #dc3545;
}

.verification-header {
    background: linear-gradient(135deg, #dc3545, #c82333);
    color: white;
    padding: 30px;
    text-align: center;
    border-radius: 15px 15px 0 0;
}

.verification-header h2 {
    margin: 0;
    font-size: 1.8rem;
}

.verification-body {
    padding: 30px;
}

.verification-body .form-group {
    margin-bottom: 20px;
}

.verification-body .form-group label {
    display: block;
    margin-bottom: 8px;
    color: #0d3b66;
    font-weight: bold;
}

.verification-body .form-group input,
.verification-body .form-group select {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #0d3b66;
    border-radius: 5px;
    font-size: 1rem;
    font-family: Georgia, serif;
}

.verification-body .auth-submit {
    width: 100%;
    padding: 15px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 1.1rem;
    font-weight: bold;
    cursor: pointer;
    font-family: Georgia, serif;
    margin-top: 10px;
}

.verification-body .auth-submit:hover {
    background: #218838;
}

        /* ===== AUTH MODAL ===== */
        .auth-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 3000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto; /* Add scrolling */
}
        .auth-modal.active {
            display: flex;
        }

       .auth-content {
    background: white;
    border-radius: 10px;
    max-width: 450px;
    width: 100%;
    max-height: 90vh; /* Limit height */
    overflow-y: auto; /* Make scrollable */
    position: relative;
    margin: auto; /* Center it */
}
        .auth-header {
            background: #0d3b66;
            color: white;
            padding: 25px;
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 2px solid #0d3b66;
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            background: #f5f5f5;
            border: none;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
        }

        .auth-tab.active {
            background: white;
            color: #0d3b66;
        }

        .auth-body {
            padding: 30px;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #0d3b66;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #0d3b66;
            border-radius: 5px;
            font-size: 1rem;
            font-family: Georgia, serif;
        }

        .auth-submit {
            width: 100%;
            padding: 15px;
            background: #0d3b66;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            font-family: Georgia, serif;
            margin-top: 10px;
        }

        .auth-submit:hover {
            background: #0a2f4d;
        }

    
        .favorites-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .favorite-card {
            background: #f9f9f9;
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 20px;
            position: relative;
        }

        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        /* ===== RESPONSIVE ===== */
    @media (max-width: 768px) {
            .logo {
                font-size: 1rem;
                letter-spacing: 0.5px;
            }
            
            .nav-item {
                font-size: 1rem;
                padding: 14px 10px;
                letter-spacing: 0.5px;
            }

            .welcome-section h1 {
                font-size: 2rem;
            }

            .database-header {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }

            .favorites-grid {
                grid-template-columns: 1fr;
            }
        }

@media (max-width: 480px) {
            .logo {
                font-size: 0.95rem;
                letter-spacing: 0.3px;
            }
            
            .menu-icon span {
                width: 25px;
                height: 3px;
            }
            
            .user-avatar {
                width: 30px;
                height: 30px;
                font-size: 0.9rem;
            }
            
            .user-info span {
                font-size: 0.9rem;
            }
        }


       /* ===== DASHBOARD STYLES ===== */
.dashboard-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
}

.dashboard-welcome-card {
    background: linear-gradient(135deg, #0d3b66 0%, #1a5490 100%);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.dashboard-profile-section {
    display: flex;
    align-items: center;
    gap: 20px;
}

.profile-avatar-large {
    width: 80px;
    height: 80px;
    min-width: 80px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #0d3b66;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(255,215,0,0.4);
    border: 4px solid rgba(255,255,255,0.3);
}

.profile-info h1 {
    color: white;
    font-size: 1.8rem;
    margin: 0 0 5px 0;
}

.profile-info p {
    color: rgba(255,255,255,0.9);
    margin: 3px 0;
    font-size: 1rem;
}

.dashboard-section {
    margin-bottom: 30px;
}

.section-title {
    color: #0d3b66;
    font-size: 1.5rem;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 3px solid #0d3b66;
    display: inline-block;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
}

.profile-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.profile-action-btn {
    padding: 10px 20px;
    background: #0d3b66;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 0.9rem;
}

.profile-action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(13,59,102,0.3);
}

.profile-action-btn-save {
    background: #28a745;
}

.profile-action-btn-save:hover {
    background: #218838;
}

.profile-action-btn-cancel {
    background: #6c757d;
}

.profile-action-btn-cancel:hover {
    background: #5a6268;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.dashboard-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
    text-align: center;
}

.dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, #0d3b66, #ffd700);
    transform: scaleX(0);
    transition: transform 0.3s;
}

.dashboard-card:hover::before {
    transform: scaleX(1);
}

.dashboard-card-clickable {
    cursor: pointer;
}

.dashboard-card-clickable:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.card-icon {
    font-size: 2.5rem;
    margin-bottom: 10px;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #0d3b66;
    margin: 10px 0;
}

.card-label {
    color: #666;
    font-size: 1rem;
    margin-bottom: 10px;
    font-weight: 500;
}

.card-action {
    color: #0d3b66;
    font-size: 0.9rem;
    font-weight: bold;
    opacity: 0;
    transition: opacity 0.3s;
}

.dashboard-card-clickable:hover .card-action {
    opacity: 1;
}

.profile-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
}

.profile-field {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
}

.profile-field:last-child {
    border-bottom: none;
}

.field-label {
    font-weight: bold;
    color: #0d3b66;
    font-size: 1rem;
    min-width: 150px;
}

.field-value {
    flex: 1;
    text-align: right;
    color: #333;
}

.field-input {
    width: 100%;
    padding: 10px;
    border: 2px solid #0d3b66;
    border-radius: 8px;
    font-size: 1rem;
    font-family: Georgia, serif;
}

.settings-card {
    background: white;
    border-radius: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    overflow: hidden;
}

.setting-item {
    display: flex;
    align-items: center;
    padding: 20px 25px;
    cursor: pointer;
    transition: all 0.3s;
    border-bottom: 1px solid #f0f0f0;
}

.setting-item:last-child {
    border-bottom: none;
}

.setting-item:hover {
    background: #f8f9fa;
}

.setting-icon {
    font-size: 1.8rem;
    margin-right: 15px;
    min-width: 40px;
    text-align: center;
}

.setting-content {
    flex: 1;
}

.setting-title {
    font-weight: bold;
    color: #0d3b66;
    font-size: 1.1rem;
    margin-bottom: 3px;
}

.setting-description {
    color: #666;
    font-size: 0.9rem;
}

.setting-arrow {
    color: #0d3b66;
    font-size: 1.5rem;
    font-weight: bold;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .dashboard-container {
        padding: 15px;
    }
    
    .dashboard-welcome-card {
        padding: 20px;
    }
    
    .dashboard-profile-section {
        flex-direction: column;
        text-align: center;
    }
    
    .profile-avatar-large {
        width: 70px;
        height: 70px;
        font-size: 2rem;
    }
    
    .profile-info h1 {
        font-size: 1.5rem;
    }
    
    .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }
    
    .card-icon {
        font-size: 2rem;
    }
    
    .stat-number {
        font-size: 2rem;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .profile-actions {
        width: 100%;
    }
    
    .profile-action-btn {
        flex: 1;
        min-width: 100px;
    }
    
    .profile-field {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .field-label {
        min-width: auto;
    }
    
    .field-value {
        text-align: left;
        width: 100%;
    }
    
    .setting-item {
        padding: 15px;
    }
    
    .setting-icon {
        font-size: 1.5rem;
        margin-right: 12px;
    }
}

@media (max-width: 480px) {
    .profile-info h1 {
        font-size: 1.3rem;
    }
    
    .profile-info p {
        font-size: 0.9rem;
    }
    
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    .section-title {
        font-size: 1.3rem;
    }
}


        .my-profile-btn {
    margin-top: 12px;
    padding: 10px 20px;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #0d3b66;
    border: none;
    border-radius: 25px;
    font-weight: bold;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
    letter-spacing: 0.5px;
}

.my-profile-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
    background: linear-gradient(135deg, #ffed4e, #ffd700);
}

.my-profile-btn:active {
    transform: translateY(0);
}

        /* Virtual Keyboard */
.virtual-keyboard {
    margin: 20px auto;
    max-width: 600px;
}

.keyboard-row {
    display: flex;
    justify-content: center;
    gap: 5px;
    margin-bottom: 8px;
}

.keyboard-key {
    padding: 12px 8px;
    min-width: 40px;
    background: #0d3b66;
    color: white;
    border: 2px solid #0a2f4d;
    border-radius: 5px;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s;
    font-family: Georgia, serif;
}

.keyboard-key:hover {
    background: #ffd700;
    color: #0d3b66;
    transform: translateY(-2px);
}

.keyboard-key:active {
    transform: translateY(0);
}

.keyboard-key.space {
    min-width: 200px;
}

.keyboard-key.backspace, .keyboard-key.enter {
    min-width: 80px;
    background: #dc3545;
}

.keyboard-key.backspace:hover, .keyboard-key.enter:hover {
    background: #c82333;
    color: white;
}

        /* Balloon Animation */
@keyframes float {
    0%, 100% {
        transform: translateY(0) rotate(0deg);
    }
    25% {
        transform: translateY(-20px) rotate(5deg);
    }
    75% {
        transform: translateY(-10px) rotate(-5deg);
    }
}

@keyframes rise {
    0% {
        bottom: -100px;
        opacity: 0;
    }
    10% {
        opacity: 1;
    }
    90% {
        opacity: 1;
    }
    100% {
        bottom: 100%;
        opacity: 0;
    }
}

.balloon {
    position: fixed;
    font-size: 3rem;
    animation: rise 8s ease-in infinite;
    z-index: 1000;
    pointer-events: none;
}

.balloon:nth-child(1) { left: 10%; animation-delay: 0s; }
.balloon:nth-child(2) { left: 25%; animation-delay: 1s; }
.balloon:nth-child(3) { left: 40%; animation-delay: 2s; }
.balloon:nth-child(4) { left: 55%; animation-delay: 3s; }
.balloon:nth-child(5) { left: 70%; animation-delay: 4s; }
.balloon:nth-child(6) { left: 85%; animation-delay: 5s; }

.confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    top: -10px;
    z-index: 1000;
    animation: confetti-fall 3s linear;
    pointer-events: none;
}

@keyframes confetti-fall {
    to {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
    }
}

.iq-badge {
    display: inline-block;
    padding: 20px 40px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 50px;
    font-size: 2.5rem;
    font-weight: bold;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: pulse-glow 2s infinite;
    margin: 20px 0;
}

@keyframes pulse-glow {
    0%, 100% {
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 15px 40px rgba(118, 75, 162, 0.8);
        transform: scale(1.05);
    }
}

      .sidebar-item-home {
    text-align: center;
    background: #0d3b66;
    font-weight: bold;
    font-style: italic;
    letter-spacing: 1.5px;
    margin-top: 10px;
}

        /* Draggable Letter Tiles */
.letter-tiles-container {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 30px 0;
    flex-wrap: nowrap;  /* Changed from wrap */
    overflow-x: auto;    /* Added this */
    min-height: 80px;
    padding: 20px;
    background: #f5f5f5;
    border-radius: 10px;
}

.letter-tile {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #0d3b66, #1a5490);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    font-weight: bold;
    border-radius: 10px;
    cursor: move;
    user-select: none;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    transition: all 0.3s;
    touch-action: none;
}

.letter-tile:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

.letter-tile.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.letter-tile.drag-over {
    transform: scale(1.1);
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #0d3b66;
}

@media (max-width: 768px) {
    .letter-tile {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
    }
}
        
@media (max-width: 600px) {
    .welcome-section h1 {
        font-size: clamp(1.2rem, 4.5vw, 2rem);
    }
}

@media (max-width: 400px) {
    .welcome-section h1 {
        font-size: clamp(1rem, 4vw, 1.5rem);
    }
}
        
    /* WhatsApp Channel Button Hover Effect */
a[href*="whatsapp.com/channel"]:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.6);
}

      /* Level selection styling */
#quiz-level-selection,
#spelling-level-selection,
#spelling-difficulty-selection,
#unscramble-level-selection,
#unscramble-difficulty-selection {
    transition: opacity 0.3s ease;
}

#spelling-level-name,
#unscramble-level-name {
    font-size: 1.2rem;
    color: #0d3b66;
    font-weight: bold;
    margin: 15px 0;
}  

        /* ID Verification Styles */
.id-verification-section {
    display: none;
    margin-top: 30px;
    padding: 25px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.id-verification-section.show {
    display: block;
}

.id-verification-section h3 {
    color: white;
    margin-bottom: 15px;
    font-size: 1.3rem;
}

.id-verification-section p {
    color: rgba(255,255,255,0.9);
    margin-bottom: 20px;
    line-height: 1.6;
}

.id-upload-area {
    background: rgba(255,255,255,0.95);
    border: 3px dashed #667eea;
    border-radius: 12px;
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.id-upload-area:hover {
    background: white;
    border-color: #764ba2;
    transform: translateY(-2px);
}

.id-upload-area.drag-over {
    background: #e3f2fd;
    border-color: #2196F3;
}

.id-upload-icon {
    font-size: 3rem;
    margin-bottom: 15px;
    color: #667eea;
}

.id-upload-text {
    font-size: 1.1rem;
    color: #0d3b66;
    font-weight: bold;
    margin-bottom: 10px;
}

.id-upload-hint {
    font-size: 0.9rem;
    color: #666;
}

.id-preview-container {
    margin-top: 20px;
    display: none;
}

.id-preview-container.show {
    display: block;
}

.id-preview-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    margin-bottom: 15px;
}

.id-verification-status {
    margin-top: 20px;
    padding: 15px;
    border-radius: 8px;
    display: none;
}

.id-verification-status.show {
    display: block;
}

.id-verification-status.verifying {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    color: #856404;
}

.id-verification-status.success {
    background: #d4edda;
    border-left: 4px solid #28a745;
    color: #155724;
}

.id-verification-status.error {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
    color: #721c24;
}

.verification-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0,0,0,0.1);
    border-top-color: #856404;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-right: 10px;
    vertical-align: middle;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.id-requirements {
    background: rgba(255,255,255,0.15);
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.id-requirements ul {
    list-style: none;
    padding: 0;
    margin: 10px 0 0 0;
}

.id-requirements li {
    color: white;
    padding: 5px 0;
    padding-left: 25px;
    position: relative;
}

.id-requirements li:before {
    content: "‚úì";
    position: absolute;
    left: 0;
    color: #FFD700;
    font-weight: bold;
}

#verify-id-file {
    display: none;
}

.btn-change-id {
    background: #dc3545;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 10px;
}

.btn-change-id:hover {
    background: #c82333;
}

   /* Coaches Table Styles - Simplified */
.coaches-table {
    width: 100%;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-top: 20px;
}

.coaches-table table {
    width: 100%;
    border-collapse: collapse;
}

.coaches-table thead {
    background: linear-gradient(135deg, #0d3b66 0%, #1a5490 100%);
    color: white;
}

.coaches-table th {
    padding: 15px;
    text-align: left;
    font-weight: bold;
    font-size: 1rem;
}

.coaches-table td {
    padding: 15px;
    border-bottom: 1px solid #f0f0f0;
    color: #333;
}

.coaches-table tbody tr {
    cursor: pointer;
    transition: all 0.3s;
}

.coaches-table tbody tr:hover {
    background: #f8f9fa;
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.coaches-table tbody tr:last-child td {
    border-bottom: none;
}

.coach-profile-cell {
    display: flex;
    align-items: center;
    gap: 12px;
}

.coach-avatar {
    width: 45px;
    height: 45px;
    min-width: 45px;
    border-radius: 50%;
    background: linear-gradient(135deg, #0d3b66, #1a5490);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(13,59,102,0.3);
}

.coach-name {
    font-size: 1.1rem;
    font-weight: bold;
    color: #0d3b66;
}

.verified-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 14px;
    background: #d4edda;
    color: #155724;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: bold;
}

.unverified-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 6px 14px;
    background: #fff3cd;
    color: #856404;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: bold;
}

.coach-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.coach-stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    text-align: center;
}

.coach-stat-card .stat-number {
    font-size: 2.5rem;
    font-weight: bold;
    color: #0d3b66;
    margin: 10px 0;
}

.coach-stat-card .stat-label {
    color: #666;
    font-size: 1rem;
}

/* Coach Detail Modal */
.coach-detail-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 3000;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
}

.coach-detail-modal.active {
    display: flex;
}

.coach-detail-content {
    background: white;
    border-radius: 15px;
    max-width: 600px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}

.coach-detail-header {
    background: linear-gradient(135deg, #0d3b66 0%, #1a5490 100%);
    color: white;
    padding: 30px;
    border-radius: 15px 15px 0 0;
    text-align: center;
    position: relative;
}

.coach-detail-close {
    position: absolute;
    top: 15px;
    right: 20px;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
}

.coach-detail-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
}

.coach-detail-avatar-large {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #0d3b66;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    font-weight: bold;
    margin: 0 auto 15px auto;
    box-shadow: 0 4px 15px rgba(255,215,0,0.4);
    border: 4px solid rgba(255,255,255,0.3);
}

.coach-detail-header h2 {
    margin: 0 0 10px 0;
    font-size: 1.8rem;
}

.coach-detail-header .status-badge {
    display: inline-block;
    padding: 8px 20px;
    border-radius: 25px;
    font-size: 0.95rem;
    font-weight: bold;
    margin-top: 10px;
}

.coach-detail-header .verified {
    background: #d4edda;
    color: #155724;
}

.coach-detail-header .pending {
    background: #fff3cd;
    color: #856404;
}

.coach-detail-body {
    padding: 30px;
}

.coach-info-row {
    display: flex;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
    align-items: center;
}

.coach-info-row:last-child {
    border-bottom: none;
}

.coach-info-label {
    font-weight: bold;
    color: #0d3b66;
    font-size: 1rem;
    min-width: 140px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.coach-info-value {
    flex: 1;
    color: #333;
    font-size: 1rem;
}

.coach-verification-notice {
    background: #e3f2fd;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #0d3b66;
    margin-top: 20px;
}

.coach-verification-notice h3 {
    color: #0d3b66;
    margin: 0 0 10px 0;
    font-size: 1.1rem;
}

.coach-verification-notice ul {
    margin: 10px 0 0 20px;
    color: #666;
    line-height: 1.8;
}

@media (max-width: 768px) {
    .coaches-table th:not(:first-child):not(:last-child),
    .coaches-table td:not(:first-child):not(:last-child) {
        display: none;
    }
    
    .coach-avatar {
        width: 40px;
        height: 40px;
        min-width: 40px;
        font-size: 1rem;
    }
    
    .coach-name {
        font-size: 1rem;
    }
    
    .verified-badge,
    .unverified-badge {
        font-size: 0.8rem;
        padding: 5px 10px;
    }
    
    .coach-detail-content {
        margin: 20px;
    }
    
    .coach-detail-header {
        padding: 20px;
    }
    
    .coach-detail-avatar-large {
        width: 80px;
        height: 80px;
        font-size: 2.5rem;
    }
    
    .coach-detail-body {
        padding: 20px;
    }
    
    .coach-info-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    
    .coach-info-label {
        min-width: auto;
    }
}  
    </style>
</head>
<body>
    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>
    
     <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">
        <div class="sidebar-user-info" id="sidebarUserInfo">
            <div class="user-avatar" id="sidebarUserAvatar" style="background-image: none; background-size: cover; background-position: center;">?</div>
            <span id="sidebarUserName">Guest</span>
            <button class="my-profile-btn" id="myProfileBtn" onclick="goToUserDashboard()" style="display: none;">
                üë§ MY PROFILE
            </button>
        </div>
    </div>
    <div class="sidebar-item sidebar-item-home" onclick="navigateTo('home')">HOME</div>
    <div class="sidebar-item" onclick="navigateTo('word-database')">WORD DATABASE</div>
    <div class="sidebar-item" onclick="navigateTo('coaches')">BOOK COACHES</div>
    <div class="sidebar-item" onclick="()">CONTACT US</div>
    <div class="sidebar-item" onclick="navigateTo('about')">ABOUT US</div>
    <div class="sidebar-item sign-in" id="sidebar-signin" onclick="showAuthModal()">SIGN IN</div>
    <div class="sidebar-item" id="sidebar-signout" style="display:none;" onclick="signOut()">SIGN OUT</div>
</div>
</div>


  
    <!-- Header -->
    <header class="header">
       <div class="top-bar">
            <div class="logo">WORD BIZ COACHING ACADEMY</div>
            <div class="left-section">
                <div class="menu-icon" onclick="toggleSidebar()">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
        
<nav class="nav-bar">
            <div class="nav-item" onclick="navigateTo('quiz', true)">QUIZ</div>
            <div class="nav-item">TOURNAMENTS</div>
           <div class="nav-item" onclick="navigateTo('spelling', true)">SPELLING</div>
        </nav>
    </header>

    <!-- Main Content -->
    <div class="container">
        <!-- Home Section -->
<div id="home-section" class="content-section active">
    <div class="welcome-section" style="padding-bottom: 0;">
        <img src="https://res.cloudinary.com/dqqr9udcs/image/upload/v1760911020/preview_2_u1bya5.webp" alt="WordBiz Logo" style="max-width: 150px; height: auto; margin: 0 auto 20px auto; display: block;">
        <h1>WORD BIZ COACHING ACADEMY</h1>
        <p>Welcome to Word Biz Coaching Academy where children are committed to striving for the absolute best and coaches are committed to helping each and every child master over 15,000 English words with AI-Powered learning tools to ensure each child's knowledge is significantly boosted.</p>
        
        <!-- WhatsApp Channel Button -->
        <a href="https://whatsapp.com/channel/0029VbBQ7HcAzNbx4tLhPh2E" 
           target="_blank" 
           style="display: block; width: calc(100% + 40px); margin-top: 30px; margin-left: -20px; margin-right: -20px; margin-bottom: -40px; padding: 20px; background: #25D366; color: white; text-decoration: none; border-radius: 0 0 15px 15px; font-weight: bold; font-size: 1.2rem; text-align: center; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4); transition: all 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            JOIN OUR WHATSAPP!!
        </a>
    </div>
</div>
         <!-- Word Database Section -->
<div id="word-database-section" class="content-section">
    <div class="word-database">
        <!-- Level Selection Screen -->
        <div id="level-selection" class="welcome-section">
            <h2>üìö CHOOSE YOUR LEVEL</h2>
            <p style="margin: 20px 0;">Select a difficulty level to access words:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                <button class="user-type-btn" onclick="loadLevel('foundation')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üå±</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 1</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">FOUNDATION</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Basic vocabulary building</div>
                </button>
                
                <button class="user-type-btn" onclick="loadLevel('challenge')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üéØ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 2</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHALLENGE</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Intermediate vocabulary</div>
                </button>
                
                <button class="user-type-btn" onclick="loadLevel('advanced')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üöÄ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 3</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">ADVANCED</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Complex vocabulary</div>
                </button>
                
                <button class="user-type-btn" onclick="loadLevel('championship')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üèÜ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 4</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHAMPIONSHIP</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Expert vocabulary</div>
                </button>
            </div>
        </div>
        
        <!-- Word Database Display (Hidden Initially) -->
        <div id="word-database-display" style="display: none;">
            <div class="database-header">
                <button class="practice-btn" onclick="backToLevelSelection()" style="background: #6c757d; padding: 10px 20px; font-size: 0.9rem;">
                    ‚Üê Back to Levels
                </button>
                <h2 id="current-level-title">üìö WORD DATABASE</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search for any word..." />
                    <button onclick="searchWord()">Search</button>
                </div>
            </div>

            <div class="status-message" id="statusMessage">
                Select a level to load words...
            </div>

            <!-- Alphabet Navigation -->
            <div class="alphabet-nav" id="alphabetNav"></div>

            <!-- Word List -->
            <div class="word-list" id="wordList">
                <div class="loading">Select a letter or search for a word to begin</div>
            </div>
        </div>
    </div>
</div>

        <!-- Quiz Section -->
        <div id="quiz-section" class="content-section">
            <div class="word-database">
        <div class="quiz-tabs">
            <button class="quiz-tab active" onclick="switchQuizMode('practice')">PRACTICE QUIZ</button>
            <button class="quiz-tab" onclick="switchQuizMode('live')">LIVE QUIZ</button>
            <button class="quiz-tab" onclick="switchQuizMode('leaderboard')">QUIZ LEADERBOARD</button>
        </div>

               <div id="practice-quiz-mode" class="quiz-mode active">
    <!-- Level Selection -->
    <div id="quiz-level-selection" class="welcome-section">
        <h2>üéØ PRACTICE QUIZ</h2>
        <p style="margin: 20px 0;">Select a difficulty level for your quiz:</p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
            <button class="user-type-btn" onclick="startPracticeQuizWithLevel('foundation')">
                <div style="font-size: 2rem; margin-bottom: 10px;">üå±</div>
                <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 1</div>
                <div style="font-size: 1.1rem; margin: 5px 0;">FOUNDATION</div>
                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Basic vocabulary quiz</div>
            </button>
            
            <button class="user-type-btn" onclick="startPracticeQuizWithLevel('challenge')">
                <div style="font-size: 2rem; margin-bottom: 10px;">üéØ</div>
                <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 2</div>
                <div style="font-size: 1.1rem; margin: 5px 0;">CHALLENGE</div>
                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Intermediate vocabulary quiz</div>
            </button>
            
            <button class="user-type-btn" onclick="startPracticeQuizWithLevel('advanced')">
                <div style="font-size: 2rem; margin-bottom: 10px;">üöÄ</div>
                <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 3</div>
                <div style="font-size: 1.1rem; margin: 5px 0;">ADVANCED</div>
                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Complex vocabulary quiz</div>
            </button>
            
            <button class="user-type-btn" onclick="startPracticeQuizWithLevel('championship')">
                <div style="font-size: 2rem; margin-bottom: 10px;">üèÜ</div>
                <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 4</div>
                <div style="font-size: 1.1rem; margin: 5px 0;">CHAMPIONSHIP</div>
                <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Expert vocabulary quiz</div>
            </button>
        </div>
    </div>
    
    <!-- Quiz Container -->
    <div id="practice-quiz-container"></div>
             </div>
            </div>
        </div>

        <!-- Favorites Section -->
        <div id="favorites-section" class="content-section">
            <div class="word-database">
                <div class="database-header">
                    <h2>MY FAVORITES</h2>
                    <button class="practice-btn" id="favoritesQuizBtn" onclick="startFavoritesQuiz()" disabled>
                        Generate Quiz from Favorites
                    </button>
                </div>
                <div id="favorites-container" class="loading">
                    Please sign in to save favorites
                </div>
            </div>
        </div>

        <!-- Incorrect Quiz Section -->
        <div id="incorrect-quiz-section" class="content-section">
            <div class="word-database">
                <div class="database-header">
                    <h2>INCORRECT QUESTIONS</h2>
                    <button class="practice-btn" id="incorrectQuizBtn" onclick="startIncorrectQuiz()" disabled>
                        Practice Incorrect Questions
                    </button>
                </div>
                <div id="incorrect-container" class="loading">
                    Please sign in to track incorrect answers
                </div>
            </div>
        </div>
    </div>

    <!-- Word Detail Modal -->
    <div class="modal" id="wordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalWord">Word</h2>
                <button class="modal-close" onclick="closeModal()">√ó</button>
                <div class="word-phonetic" id="modalPhonetic"></div>
            </div>
            <div class="modal-body">
                <div id="modalContent"></div>
                <div class="practice-section">
                    <h3>üé§ PRACTICE PRONUNCIATION</h3>
                    <button class="practice-btn" onclick="speakWord()">üîä LISTEN</button>
                    <button class="practice-btn" id="practiceBtn" onclick="startPractice()">üé§ PRACTICE SPEAKING</button>
                    <div id="practiceFeedback"></div>
                </div>
            </div>
        </div>
    </div>

   <!-- Verification Modal (Cannot be closed) -->
<div class="verification-modal" id="verificationModal">
    <div class="verification-content">
        <div class="verification-header">
            <h2>‚ö†Ô∏è Complete Your Profile</h2>
            <p style="margin-top: 10px; font-size: 0.95rem;">Please complete your profile to continue using WordBiz</p>
        </div>
        <div class="verification-body">
            <form id="verification-form" onsubmit="handleVerification(event)">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" id="verify-name" required>
                </div>
                
                <div class="form-group">
                    <label>Age *</label>
                    <input type="number" id="verify-age" min="5" max="100" required>
                </div>
                
                <div class="form-group">
                    <label>Country *</label>
                    <select id="verify-country" required>
                        <option value="">Select your country</option>
                        <option value="United States">United States</option>
                        <option value="United Kingdom">United Kingdom</option>
                        <option value="Canada">Canada</option>
                        <option value="Australia">Australia</option>
                        <option value="Jamaica">Jamaica</option>
                        <option value="India">India</option>
                        <option value="Nigeria">Nigeria</option>
                        <option value="South Africa">South Africa</option>
                        <option value="Kenya">Kenya</option>
                        <option value="Ghana">Ghana</option>
                        <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                        <option value="Barbados">Barbados</option>
                        <option value="Bahamas">Bahamas</option>
                        <option value="Philippines">Philippines</option>
                        <option value="Singapore">Singapore</option>
                        <option value="New Zealand">New Zealand</option>
                        <option value="Ireland">Ireland</option>
                        <option value="Pakistan">Pakistan</option>
                        <option value="Bangladesh">Bangladesh</option>
                        <option value="Malaysia">Malaysia</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- ID Verification Section for Coaches ONLY -->
                <div class="id-verification-section" id="coachIdVerification">
                    <h3>üÜî Coach ID Verification Required</h3>
                    <p>For the safety of our students, all coaches must verify their identity with a government-issued ID.</p>
                    
                    <div class="id-requirements">
                        <strong style="color: white;">Accepted Documents:</strong>
                        <ul>
                            <li>Driver's License</li>
                            <li>Passport</li>
                            <li>National ID Card</li>
                        </ul>
                        <p style="margin-top: 10px; font-size: 0.9rem; color: rgba(255,255,255,0.9);">
                            ‚úì Must be at least 16 years old<br>
                            ‚úì Name must match your profile<br>
                            ‚úì Document must be valid and unaltered<br>
                            üîí Your ID photo is never stored - only verification status
                        </p>
                    </div>

                    <div class="id-upload-area" id="idUploadArea" onclick="document.getElementById('verify-id-file').click()">
                        <div class="id-upload-icon">üì∑</div>
                        <div class="id-upload-text">Click or Drag to Upload ID</div>
                        <div class="id-upload-hint">Supported: JPG, PNG, PDF (Max 10MB)</div>
                        <input type="file" id="verify-id-file" accept="image/*,.pdf" onchange="handleIDUpload(event)">
                    </div>

                    <div class="id-preview-container" id="idPreviewContainer">
                        <img id="idPreviewImage" class="id-preview-image" alt="ID Preview">
                        <button type="button" class="btn-change-id" onclick="changeIDPhoto()">Change Photo</button>
                    </div>

                    <div class="id-verification-status" id="idVerificationStatus"></div>
                </div>
                
                <button type="submit" class="auth-submit" id="completeProfileBtn">‚úÖ Complete Profile</button>
                
                <button type="button" class="auth-submit" onclick="signOutAndSwitchAccount()" 
                        style="background: #6c757d; margin-top: 10px;">
                    üîÑ Sign Out & Use Different Account
                </button>
                
                <div id="verify-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>
        </div>
    </div>
</div>


    <!-- Change Password Modal -->
<div class="auth-modal" id="changePasswordModal">
    <div class="auth-content">
        <div class="auth-header">
            <h2>üîí Change Password</h2>
            <button class="modal-close" onclick="closeChangePasswordModal()">√ó</button>
        </div>
        <div class="auth-body">
            <form id="change-password-form" onsubmit="handleChangePassword(event)">
                <div class="form-group">
                    <label>Current Password *</label>
                    <input type="password" id="current-password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label>New Password * (minimum 6 characters)</label>
                    <input type="password" id="new-password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label>Confirm New Password *</label>
                    <input type="password" id="confirm-new-password" required minlength="6">
                </div>
                
                <button type="submit" class="auth-submit">‚úÖ Change Password</button>
                
                <div id="change-password-error" class="feedback error" style="display:none; margin-top:15px;"></div>
                <div id="change-password-success" class="feedback success" style="display:none; margin-top:15px;"></div>
            </form>
        </div>
    </div>
</div>
    
    <!-- Auth Modal -->
<div class="auth-modal" id="authModal">
    <div class="auth-content">
        <div class="auth-header">
            <h2>Welcome to WordBiz</h2>
            <button class="modal-close" onclick="closeAuthModal()">√ó</button>
        </div>
        <div class="auth-tabs">
            <button class="auth-tab active" onclick="switchAuthTab('signin')">SIGN IN</button>
            <button class="auth-tab" onclick="switchAuthTab('signup')">SIGN UP</button>
        </div>
        <div class="auth-body">
            <!-- Sign In Form -->
            <form id="signin-form" class="auth-form active" onsubmit="handleSignIn(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signin-email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="signin-password" required>
                </div>
                <button type="submit" class="auth-submit">SIGN IN    </button>
                <button type="button" class="auth-submit" onclick="signInWithGoogle()" style="background: #db4437; margin-top: 10px;">
                    SIGN IN WITH GOOGLE
                </button>
                <div id="signin-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>

            <!-- Sign Up - User Type Selection -->
            <div id="signup-selection" class="auth-form">
                <h3 style="color: #0d3b66; margin-bottom: 20px; text-align: center;">Choose Your Account Type</h3>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button type="button" class="user-type-btn" onclick="showSignUpForm('student')">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üéì</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">Student</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Practice spelling & vocabulary</div>
                    </button>
                    
                    <button type="button" class="user-type-btn" onclick="showSignUpForm('coach')">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üë®‚Äçüè´</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">Coach</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Manage students & track progress</div>
                    </button>
                    
                    <button type="button" class="user-type-btn" onclick="showSignUpForm('organization')">
                        <div style="font-size: 2rem; margin-bottom: 10px;">üè´</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">School/Organization</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Manage coaches & students</div>
                    </button>
                </div>
            </div>

            <!-- Sign Up Form - Student -->
<form id="signup-student-form" class="auth-form" onsubmit="handleSignUp(event, 'student')" style="display: none;">
    <button type="button" onclick="backToUserTypeSelection()" style="background: none; border: none; color: #0d3b66; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
        ‚Üê Back to selection
    </button>
    
    <h3 style="color: #0d3b66; margin-bottom: 15px; text-align: center;">üéì Student Sign Up</h3>
    
    <div class="form-group">
        <label>Full Name</label>
        <input type="text" id="signup-student-name" required>
    </div>
    <div class="form-group">
        <label>Email</label>
        <input type="email" id="signup-student-email" required>
    </div>
    <div class="form-group">
        <label>Password (min 6 characters)</label>
        <input type="password" id="signup-student-password" required minlength="6">
    </div>
    <div class="form-group">
        <label>Age</label>
        <input type="number" id="signup-student-age" min="5" max="100" required>
    </div>
    <div class="form-group">
        <label>Country</label>
        <select id="signup-student-country" required style="width: 100%; padding: 12px 15px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem; font-family: Georgia, serif;">
            <option value="">Select your country</option>
            <option value="United States">United States</option>
            <option value="United Kingdom">United Kingdom</option>
            <option value="Canada">Canada</option>
            <option value="Australia">Australia</option>
            <option value="Jamaica">Jamaica</option>
            <option value="India">India</option>
            <option value="Nigeria">Nigeria</option>
            <option value="South Africa">South Africa</option>
            <option value="Kenya">Kenya</option>
            <option value="Ghana">Ghana</option>
            <option value="Trinidad and Tobago">Trinidad and Tobago</option>
            <option value="Barbados">Barbados</option>
            <option value="Bahamas">Bahamas</option>
            <option value="Philippines">Philippines</option>
            <option value="Singapore">Singapore</option>
            <option value="New Zealand">New Zealand</option>
            <option value="Ireland">Ireland</option>
            <option value="Pakistan">Pakistan</option>
            <option value="Bangladesh">Bangladesh</option>
            <option value="Malaysia">Malaysia</option>
            <option value="Other">Other</option>
        </select>
    </div>
    <button type="submit" class="auth-submit">Create Student Account</button>
    <button type="button" class="auth-submit" onclick="signUpWithGoogle('student')" style="background: #db4437; margin-top: 10px;">
        Sign Up with Google
    </button>
    <div id="signup-student-error" class="feedback error" style="display:none; margin-top:15px;"></div>
</form>
            <!-- Sign Up Form - Coach -->
            <form id="signup-coach-form" class="auth-form" onsubmit="handleSignUp(event, 'coach')" style="display: none;">
                <button type="button" onclick="backToUserTypeSelection()" style="background: none; border: none; color: #0d3b66; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
                    ‚Üê Back to selection
                </button>
                
                <h3 style="color: #0d3b66; margin-bottom: 15px; text-align: center;">üë®‚Äçüè´ Coach Sign Up</h3>
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="signup-coach-name" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signup-coach-email" required>
                </div>
                <div class="form-group">
                    <label>Password (min 6 characters)</label>
                    <input type="password" id="signup-coach-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Organization/School Name (Optional)</label>
                    <input type="text" id="signup-coach-organization">
                </div>
                <button type="submit" class="auth-submit">Create Coach Account</button>
                <button type="button" class="auth-submit" onclick="signUpWithGoogle('coach')" style="background: #db4437; margin-top: 10px;">
                    Sign Up with Google
                </button>
                <div id="signup-coach-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>

            <!-- Sign Up Form - Organization -->
            <form id="signup-organization-form" class="auth-form" onsubmit="handleSignUp(event, 'organization')" style="display: none;">
                <button type="button" onclick="backToUserTypeSelection()" style="background: none; border: none; color: #0d3b66; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; gap: 5px;">
                    ‚Üê Back to selection
                </button>
                
                <h3 style="color: #0d3b66; margin-bottom: 15px; text-align: center;">üè´ Organization Sign Up</h3>
                
                <div class="form-group">
                    <label>Organization/School Name</label>
                    <input type="text" id="signup-org-name" required>
                </div>
                <div class="form-group">
                    <label>Administrator Email</label>
                    <input type="email" id="signup-org-email" required>
                </div>
                <div class="form-group">
                    <label>Password (min 6 characters)</label>
                    <input type="password" id="signup-org-password" required minlength="6">
                </div>
                <div class="form-group">
                    <label>Contact Phone</label>
                    <input type="tel" id="signup-org-phone" required>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <input type="text" id="signup-org-address" required>
                </div>
                <button type="submit" class="auth-submit">Create Organization Account</button>
                <button type="button" class="auth-submit" onclick="signUpWithGoogle('organization')" style="background: #db4437; margin-top: 10px;">
                    Sign Up with Google
                </button>
                <div id="signup-org-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>
        </div>
    </div>
</div>

<!-- Coaches Section -->
<div id="coaches-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2>üë®‚Äçüè´ OUR COACHES</h2>
            <p style="color: #666; margin-top: 10px;">Meet our verified professional coaches</p>
        </div>
        
        <div id="coaches-container" class="loading">
            Loading coaches...
        </div>
    </div>
</div>

   
    <!-- Spelling Section -->
        <div id="spelling-section" class="content-section">
            <div class="word-database">
               <div class="quiz-tabs">
    <button class="quiz-tab active" onclick="switchSpellingMode('practice')">Practice Spelling</button>
    <button class="quiz-tab" onclick="switchSpellingMode('unscramble')">Unscramble Words</button>
    <button class="quiz-tab" onclick="switchSpellingMode('live')">Live Spelling</button>
    <button class="quiz-tab" onclick="switchSpellingMode('leaderboard')">Spelling Leaderboard</button>
</div>

               <!-- Practice Spelling Mode -->
<div id="practice-spelling-mode" class="quiz-mode active">
    <div id="spelling-container">
        <!-- Level Selection -->
        <div id="spelling-level-selection" class="welcome-section">
            <h2>üî§ Practice Spelling</h2>
            <p>Select a word level to practice spelling:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                <button class="user-type-btn" onclick="startSpellingPracticeWithLevel('foundation')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üå±</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 1</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">FOUNDATION</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Practice basic spelling</div>
                </button>
                
                <button class="user-type-btn" onclick="startSpellingPracticeWithLevel('challenge')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üéØ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 2</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHALLENGE</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Intermediate spelling</div>
                </button>
                
                <button class="user-type-btn" onclick="startSpellingPracticeWithLevel('advanced')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üöÄ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 3</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">ADVANCED</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Complex spelling</div>
                </button>
                
                <button class="user-type-btn" onclick="startSpellingPracticeWithLevel('championship')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üèÜ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 4</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHAMPIONSHIP</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Expert spelling</div>
                </button>
            </div>
        </div>
        
        <div id="spelling-game" style="display: none;">
            <div class="quiz-question-card">
                <div class="quiz-score" id="spelling-score">Score: 0 / 0</div>
                <h3 id="spelling-progress">Word 1 of 10</h3>
                
                <div style="text-align: center; margin: 30px 0;">
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="practice-btn" onclick="speakCurrentSpellingWord()" style="font-size: 0.9rem; padding: 10px 15px;">
                            üîä Play Word
                        </button>
                        <button class="practice-btn" onclick="speakWordInSentence()" style="font-size: 0.9rem; padding: 10px 15px;">
                            üí¨ Use in Sentence
                        </button>
                        <button class="practice-btn" id="show-details-btn" onclick="showSpellingWordDetails()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                            üìñ Word Details
                        </button>
                        <button class="practice-btn" id="add-spelling-favorite-btn" onclick="addCurrentSpellingToFavorites()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                            ‚≠ê Add to Favorites
                        </button>
                    </div>
                    <p style="margin-top: 5px; color: #666; font-style: italic; font-size: 0.9rem;">Listen to the word alone, in a sentence, see details, or add to favorites</p>
                </div>
                                
                <div class="form-group" style="margin: 30px 0;">
                    <label style="font-size: 1.2rem;">Type what you hear:</label>
                    <input type="text" id="spelling-input" 
                           placeholder="Use the keyboard below..." 
                           style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                           readonly>
                </div>
                
                <!-- Virtual Keyboard -->
                <div class="virtual-keyboard">
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeKey('Q')">Q</button>
                        <button class="keyboard-key" onclick="typeKey('W')">W</button>
                        <button class="keyboard-key" onclick="typeKey('E')">E</button>
                        <button class="keyboard-key" onclick="typeKey('R')">R</button>
                        <button class="keyboard-key" onclick="typeKey('T')">T</button>
                        <button class="keyboard-key" onclick="typeKey('Y')">Y</button>
                        <button class="keyboard-key" onclick="typeKey('U')">U</button>
                        <button class="keyboard-key" onclick="typeKey('I')">I</button>
                        <button class="keyboard-key" onclick="typeKey('O')">O</button>
                        <button class="keyboard-key" onclick="typeKey('P')">P</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeKey('A')">A</button>
                        <button class="keyboard-key" onclick="typeKey('S')">S</button>
                        <button class="keyboard-key" onclick="typeKey('D')">D</button>
                        <button class="keyboard-key" onclick="typeKey('F')">F</button>
                        <button class="keyboard-key" onclick="typeKey('G')">G</button>
                        <button class="keyboard-key" onclick="typeKey('H')">H</button>
                        <button class="keyboard-key" onclick="typeKey('J')">J</button>
                        <button class="keyboard-key" onclick="typeKey('K')">K</button>
                        <button class="keyboard-key" onclick="typeKey('L')">L</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key" onclick="typeKey('Z')">Z</button>
                        <button class="keyboard-key" onclick="typeKey('X')">X</button>
                        <button class="keyboard-key" onclick="typeKey('C')">C</button>
                        <button class="keyboard-key" onclick="typeKey('V')">V</button>
                        <button class="keyboard-key" onclick="typeKey('B')">B</button>
                        <button class="keyboard-key" onclick="typeKey('N')">N</button>
                        <button class="keyboard-key" onclick="typeKey('M')">M</button>
                    </div>
                    <div class="keyboard-row">
                        <button class="keyboard-key backspace" onclick="backspaceKey()">‚å´ Delete</button>
                        <button class="keyboard-key space" onclick="typeKey(' ')">Space</button>
                        <button class="keyboard-key enter" onclick="submitSpelling()">‚úì Enter</button>
                    </div>
                </div>
                                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="practice-btn" onclick="skipSpellingWord()" style="background: #666;">
                        ‚è≠Ô∏è Skip
                    </button>
                </div>
                                
                <div id="spelling-feedback" style="margin-top: 20px;"></div>
            </div>
        </div>
                        
        <div id="spelling-results" style="display: none;"></div>
    </div>
</div>

                <!-- Unscramble Mode -->
<div id="unscramble-mode" class="quiz-mode">
    <div id="unscramble-container">
        <!-- Level Selection -->
        <div id="unscramble-level-selection" class="welcome-section">
            <h2>üîÄ Unscramble Words</h2>
            <p>Select a word level to unscramble:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 30px;">
                <button class="user-type-btn" onclick="startUnscrambleWithLevel('foundation')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üå±</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 1</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">FOUNDATION</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Unscramble basic words</div>
                </button>
                
                <button class="user-type-btn" onclick="startUnscrambleWithLevel('challenge')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üéØ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 2</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHALLENGE</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Intermediate unscramble</div>
                </button>
                
                <button class="user-type-btn" onclick="startUnscrambleWithLevel('advanced')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üöÄ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 3</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">ADVANCED</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Complex unscramble</div>
                </button>
                
                <button class="user-type-btn" onclick="startUnscrambleWithLevel('championship')">
                    <div style="font-size: 2rem; margin-bottom: 10px;">üèÜ</div>
                    <div style="font-size: 1.3rem; font-weight: bold;">LEVEL 4</div>
                    <div style="font-size: 1.1rem; margin: 5px 0;">CHAMPIONSHIP</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">Expert unscramble</div>
                </button>
            </div>
        </div>
        
        <div id="unscramble-game" style="display: none;">
            <div class="quiz-question-card">
                <div class="quiz-score" id="unscramble-score">Score: 0 / 0</div>
                <h3 id="unscramble-progress">Word 1 of 10</h3>
                
                <div style="text-align: center; margin: 30px 0;">
                    <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                    
                    <div id="letter-tiles" class="letter-tiles-container">
                        <!-- Letter tiles will be inserted here -->
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="practice-btn" onclick="shuffleLetters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                            üîÄ Shuffle
                        </button>
                        
                        <button class="practice-btn" onclick="showUnscrambleHint()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px; background: #17a2b8;">
                            üí° Hint
                        </button>
                        
                        <button class="practice-btn" onclick="submitUnscramble()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            ‚úì Submit Answer
                        </button>
                    </div>
                </div>
                
                <div id="unscramble-feedback" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <div id="unscramble-results" style="display: none;"></div>
    </div>
</div>
                <!-- Live Spelling Mode -->
                <div id="live-spelling-mode" class="quiz-mode">
                    <div class="welcome-section">
                        <h2>üèÜ Live Spelling</h2>
                        <p>Coming soon! Compete with other students in real-time spelling competitions.</p>
                    </div>
                </div>

                <!-- Spelling Leaderboard Mode -->
                <div id="leaderboard-spelling-mode" class="quiz-mode">
                    <div class="welcome-section">
                        <h2>üìä Spelling Leaderboard</h2>
                        <p>Coming soon! See the top spellers and track your ranking.</p>
                    </div>
                </div>
            </div>
        </div>



    
    <!-- Spelling Favorites Section -->
<div id="spelling-favorites-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2>‚≠ê MY SPELLING FAVORITES</h2>
            <button class="practice-btn" id="spellingFavoritesQuizBtn" onclick="startSpellingFavoritesQuiz()" disabled>
                Practice Spelling Favorites
            </button>
        </div>
        <div id="spelling-favorites-container" class="loading">
            Please sign in to save spelling favorites
        </div>
    </div>
</div>

<!-- Spelling Incorrect Section -->
<div id="spelling-incorrect-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2>üî§ SPELLING MISTAKES</h2>
            <button class="practice-btn" id="spellingIncorrectQuizBtn" onclick="startSpellingIncorrectQuiz()" disabled>
                Practice Spelling Mistakes
            </button>
        </div>
        <div id="spelling-incorrect-container" class="loading">
            Please sign in to track spelling mistakes
        </div>
    </div>
</div>


   <!-- Student Dashboard Section -->
<div id="student-dashboard-section" class="content-section">
    <div class="dashboard-container">
        <!-- Welcome Header -->
        <div class="dashboard-welcome-card">
            <div class="dashboard-profile-section">
                <div class="profile-avatar-large" id="dashboard-avatar" style="background-image: none; background-size: cover; background-position: center;">S</div>
                <div class="profile-info">
                    <h1 id="dashboard-name">Student Name</h1>
                    <p id="dashboard-email">student@email.com</p>
                    <p id="dashboard-join-date" style="font-size: 0.9rem; opacity: 0.8; margin-top: 5px;">Member since: Loading...</p>
                </div>
            </div>
        </div>

        <!-- Quick Stats Grid -->
        <div class="dashboard-section">
            <h2 class="section-title">üìä QUICK STATS</h2>
            <div class="dashboard-grid">
                <div class="dashboard-card dashboard-card-clickable" onclick="navigateTo('favorites')">
                    <div class="card-icon">‚≠ê</div>
                    <div class="stat-number" id="stat-quiz-favorites">0</div>
                    <div class="card-label">QUIZ FAVORITES</div>
                    <div class="card-action">View all ‚Üí</div>
                </div>

                <div class="dashboard-card dashboard-card-clickable" onclick="navigateTo('incorrect-quiz')">
                    <div class="card-icon">üö´</div>
                    <div class="stat-number" id="stat-quiz-incorrect">0</div>
                    <div class="card-label">QUIZ MISTAKES</div>
                    <div class="card-action">Practice ‚Üí</div>
                </div>

                <div class="dashboard-card dashboard-card-clickable" onclick="navigateTo('spelling-favorites')">
                    <div class="card-icon">‚≠ê</div>
                    <div class="stat-number" id="stat-spelling-favorites">0</div>
                    <div class="card-label">SPELLING FAVORITES</div>
                    <div class="card-action">View all ‚Üí</div>
                </div>

                <div class="dashboard-card dashboard-card-clickable" onclick="navigateTo('spelling-incorrect')">
                    <div class="card-icon">üö´</div>
                    <div class="stat-number" id="stat-spelling-incorrect">0</div>
                    <div class="card-label">SPELLING MISTAKES</div>
                    <div class="card-action">Practice ‚Üí</div>
                </div>
            </div>
        </div>

        <!-- Profile Information -->
        <div class="dashboard-section">
            <div class="section-header">
                <h2 class="section-title">üë§ PROFILE INFORMATION</h2>
                <div class="profile-actions">
                    <button class="profile-action-btn" id="edit-profile-btn" onclick="toggleEditMode()">
                        ‚úèÔ∏è Edit
                    </button>
                    
                    <button class="profile-action-btn profile-action-btn-cancel" id="cancel-edit-btn" onclick="cancelEditMode()" style="display: none;">
                        ‚úñÔ∏è Cancel
                    </button>

                    <button class="profile-action-btn profile-action-btn-save" id="save-profile-btn" onclick="saveProfile()" style="display: none;">
                        ‚úÖ Save
                    </button>
                </div>
            </div>

            <div class="profile-card">
                <div class="profile-field">
                    <div class="field-label">üìõ Full Name</div>
                    <div class="field-value">
                        <span id="display-name">Loading...</span>
                        <input type="text" id="edit-name" class="field-input" style="display: none;">
                    </div>
                </div>

                <div class="profile-field">
                    <div class="field-label">üìß Email</div>
                    <div class="field-value">
                        <span id="display-email">Loading...</span>
                    </div>
                </div>

                <div class="profile-field">
                    <div class="field-label">üéÇ Age</div>
                    <div class="field-value">
                        <span id="display-age">Loading...</span>
                        <input type="number" id="edit-age" class="field-input" min="5" max="100" style="display: none;">
                    </div>
                </div>

                <div class="profile-field">
                    <div class="field-label">üåç Country</div>
                    <div class="field-value">
                        <span id="display-country">Loading...</span>
                        <select id="edit-country" class="field-input" style="display: none;">
                            <option value="">Select your country</option>
                            <option value="United States">United States</option>
                            <option value="United Kingdom">United Kingdom</option>
                            <option value="Canada">Canada</option>
                            <option value="Australia">Australia</option>
                            <option value="Jamaica">Jamaica</option>
                            <option value="India">India</option>
                            <option value="Nigeria">Nigeria</option>
                            <option value="South Africa">South Africa</option>
                            <option value="Kenya">Kenya</option>
                            <option value="Ghana">Ghana</option>
                            <option value="Trinidad and Tobago">Trinidad and Tobago</option>
                            <option value="Barbados">Barbados</option>
                            <option value="Bahamas">Bahamas</option>
                            <option value="Philippines">Philippines</option>
                            <option value="Singapore">Singapore</option>
                            <option value="New Zealand">New Zealand</option>
                            <option value="Ireland">Ireland</option>
                            <option value="Pakistan">Pakistan</option>
                            <option value="Bangladesh">Bangladesh</option>
                            <option value="Malaysia">Malaysia</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="profile-field">
                    <div class="field-label">üë• Account Type</div>
                    <div class="field-value">
                        <span id="display-usertype">Student</span>
                    </div>
                </div>

                <div class="profile-field">
                    <div class="field-label">üìÖ Member Since</div>
                    <div class="field-value">
                        <span id="display-joined">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="dashboard-section">
            <h2 class="section-title">‚öôÔ∏è Settings</h2>
            <div class="settings-card">
                <div class="setting-item" onclick="showChangePasswordModal()">
                    <div class="setting-icon"></div>
                    <div class="setting-content">
                        <div class="setting-title">Change Password</div>
                        <div class="setting-description">Update your account password</div>
                    </div>
                    <div class="setting-arrow">‚Üí</div>
                </div>

                <div class="setting-item" onclick="confirmDeleteAccount()">
                    <div class="setting-icon"></div>
                    <div class="setting-content">
                        <div class="setting-title" style="color: #dc3545;">Delete Account</div>
                        <div class="setting-description">Permanently delete your account and data</div>
                    </div>
                    <div class="setting-arrow">‚Üí</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Coach Detail Modal -->
<div class="coach-detail-modal" id="coachDetailModal">
    <div class="coach-detail-content">
        <div class="coach-detail-header">
            <button class="coach-detail-close" onclick="closeCoachDetailModal()">√ó</button>
            <div class="coach-detail-avatar-large" id="modal-coach-avatar">C</div>
            <h2 id="modal-coach-name">Coach Name</h2>
            <div class="status-badge" id="modal-coach-status">‚úÖ Verified</div>
        </div>
        <div class="coach-detail-body">
            <div class="coach-info-row">
                <div class="coach-info-label">üìß Email</div>
                <div class="coach-info-value" id="modal-coach-email">Loading...</div>
            </div>

            <div class="coach-info-row">
                <div class="coach-info-label">üè´ Organization</div>
                <div class="coach-info-value" id="modal-coach-organization">Loading...</div>
            </div>

            <div class="coach-info-row">
                <div class="coach-info-label">üÜî Verification Status</div>
                <div class="coach-info-value" id="modal-coach-verification">Loading...</div>
            </div>

            <div class="coach-info-row" id="modal-coach-age-row" style="display: none;">
                <div class="coach-info-label">üéÇ Age</div>
                <div class="coach-info-value" id="modal-coach-age">N/A</div>
            </div>

            <div class="coach-info-row">
                <div class="coach-info-label">üìÖ Member Since</div>
                <div class="coach-info-value" id="modal-coach-joined">Loading...</div>
            </div>
        </div>

        <div class="coach-verification-notice">
            <h3>üõ°Ô∏è Verified Coach</h3>
            <p>This coach has completed our verification process:</p>
            <ul>
                <li>‚úÖ Government-issued ID verified</li>
                <li>‚úÖ Age verification (16+ years)</li>
                <li>‚úÖ Document authenticity confirmed</li>
            </ul>
        </div>
    </div>
</div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/YOUR_CHAMPIONSHIP_DOC_ID/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;



// ID Verification variables
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;
        // ===== INITIALIZE =====
        document.addEventListener('DOMContentLoaded', function() {
            initializeAlphabet();
            initializeSpeechRecognition();
            
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchWord();
            });


// Listen for auth state changes
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        // Check if profile is complete
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
            // User authenticated but no Firestore doc - sign them out
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        
        if (!userData.profileComplete) {
            // Force verification modal
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // Load all user data
        await cleanupInvalidFavorites();
        
        // Load collections in parallel
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // If user is on dashboard, refresh it
        if (document.getElementById('student-dashboard-section').classList.contains('active')) {
            loadUserDashboard();
        }
    } else {
        currentUser = null;
        updateUIForGuestUser();
    }
});
        });
        
     // ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // Reset Quiz section to level selection
    if (section === 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // Reset Spelling section to level selection
    if (section === 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        loadAndDisplayCoaches();
    }
    
    // Load dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }
}
        
       function toggleSidebar(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            
            if (forceClose) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            } else {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }

        // ===== INITIALIZE ALPHABET =====
        function initializeAlphabet() {
            const alphabetNav = document.getElementById('alphabetNav');
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
            
            letters.forEach(letter => {
                const btn = document.createElement('button');
                btn.className = 'letter-btn';
                btn.textContent = letter;
                btn.onclick = () => filterByLetter(letter);
                alphabetNav.appendChild(btn);
            });
        }

        
// New function to load level-specific words
async function loadLevelWords(level) {
    try {
        document.getElementById('statusMessage').innerHTML = 
            `‚è≥ Loading ${level.toUpperCase()} level words... Please wait.`;
        
        // Check if already loaded
        if (levelWords[level].length > 0) {
            allWords = levelWords[level];
            document.getElementById('statusMessage').innerHTML = 
                `‚úÖ ${allWords.length.toLocaleString()} ${level.toUpperCase()} words loaded! Select a letter to filter or search for specific words.`;
            return Promise.resolve();
        }
        
        const googleDocsUrl = LEVEL_DOCS[level];
        const response = await fetch(googleDocsUrl);

        if (!response.ok) throw new Error('Failed to load words');
        
        const text = await response.text();
        const words = text.split(/[\n\r\s,]+/)
            .map(word => word.trim().toLowerCase())
            .filter(word => word.length > 0 && /^[a-z]+$/.test(word))
            .sort(); // Sort alphabetically
        
        // Cache the words
        levelWords[level] = words;
        allWords = words;
        
        console.log(`Loaded ${words.length} ${level} words`);
        
        document.getElementById('statusMessage').innerHTML = 
            `‚úÖ ${words.length.toLocaleString()} ${level.toUpperCase()} words loaded! Select a letter to filter or search for specific words.`;
        
        return Promise.resolve();
    } catch (error) {
        console.error(`Error loading ${level} words:`, error);
        document.getElementById('statusMessage').innerHTML = 
            `‚ùå Error loading ${level} words. Please try again.`;
        return Promise.reject(error);
    }
}

        // Load a specific level
async function loadLevel(level) {
    currentLevel = level;
    
    // Hide level selection
    document.getElementById('level-selection').style.display = 'none';
    document.getElementById('word-database-display').style.display = 'block';
    
    // Update title
    const levelNames = {
        foundation: 'LEVEL 1: FOUNDATION',
        challenge: 'LEVEL 2: CHALLENGE',
        advanced: 'LEVEL 3: ADVANCED',
        championship: 'LEVEL 4: CHAMPIONSHIP'
    };
    document.getElementById('current-level-title').textContent = `üìö ${levelNames[level]}`;
    
    // Load words for this level
    await loadLevelWords(level);
    
    // Display first 100 words
    displayWords(allWords.slice(0, 100));
}

// Back to level selection
function backToLevelSelection() {
    document.getElementById('level-selection').style.display = 'block';
    document.getElementById('word-database-display').style.display = 'none';
    document.getElementById('wordList').innerHTML = '<div class="loading">Select a level to load words</div>';
    
    // Clear active letter
    document.querySelectorAll('.letter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    currentLetter = '';
}

        
        // ===== FILTER BY LETTER =====
        function filterByLetter(letter) {
            currentLetter = letter;
            
            document.querySelectorAll('.letter-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === letter) {
                    btn.classList.add('active');
                }
            });

            const filteredWords = allWords.filter(word => 
                word.toLowerCase().startsWith(letter.toLowerCase())
            );

            displayWords(filteredWords);
        }

         // ===== SEARCH WORD =====
        function searchWord() {
            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            
            if (!searchTerm) {
                alert('Please enter a word to search');
                return;
            }

            const exactMatch = allWords.find(word => word.toLowerCase() === searchTerm);
            
            if (exactMatch) {
                showWordDetail(exactMatch);
            } else {
                const partialMatches = allWords.filter(word => 
                    word.toLowerCase().includes(searchTerm)
                );

                if (partialMatches.length > 0) {
                    displayWords(partialMatches);
                } else {
                    alert(`No words found matching "${searchTerm}"`);
                }
            }
        }

        // ===== DISPLAY WORDS =====
function displayWords(words) {
    const wordList = document.getElementById('wordList');
    
    if (words.length === 0) {
        wordList.innerHTML = '<div class="loading">No words found</div>';
        return;
    }

    wordList.innerHTML = words.map(word => `
        <div class="word-card" onclick="loadPhoneticAndShowDetail('${word}', this)">
            <div class="word-title">
                <span>${word}</span>
                <div class="word-actions">
                    <button class="icon-btn" onclick="event.stopPropagation(); speakWordQuick('${word}')">üîä</button>
                </div>
            </div>
            <div class="word-phonetic-preview" data-word="${word}"></div>
            <div class="word-definition">Click to see AI-powered definition with synonyms & antonyms</div>
        </div>
    `).join('');

    // After rendering, load phonetics for all visible words
    setTimeout(() => loadPhoneticForVisibleWords(), 100);
}
        
       async function loadPhoneticAndShowDetail(word, cardElement) {
    const phoneticDiv = cardElement.querySelector('.word-phonetic-preview');
    
    // Check if phonetic is already loaded and cached
    if (phoneticDiv.textContent && phoneticDiv.textContent !== '' && phoneticDiv.textContent !== 'Loading pronunciation...') {
        // Already loaded from cache, just show the detail
        showWordDetail(word);
        return;
    }
    
    // Show loading state
    phoneticDiv.textContent = 'Loading pronunciation...';
    phoneticDiv.style.color = '#999';
    
    try {
        // Check Firestore cache first
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let phonetic = '';
        
        if (wordDoc.exists && wordDoc.data().phonetic) {
            phonetic = wordDoc.data().phonetic;
        } else {
            // Fetch from API
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: word } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.phonetic) {
                    phonetic = data.result.phonetic;
                }
            }
        }
        
        // Update the phonetic display
       if (phonetic) {
    // Replace slashes with brackets
    const formattedPhonetic = phonetic.replace(/\//g, '');
    phoneticDiv.innerHTML = `<strong>(${formattedPhonetic})</strong>`;
    phoneticDiv.style.color = '#000';
}
        else {
            phoneticDiv.textContent = ''; // Hide if no phonetic available
        }
    } catch (error) {
        console.error('Error loading phonetic:', error);
        phoneticDiv.textContent = ''; // Hide on error
    }
    
    // Now show the full detail modal
    showWordDetail(word);
}

async function loadPhoneticForVisibleWords() {
    const phoneticDivs = document.querySelectorAll('.word-phonetic-preview');
    
    for (const phoneticDiv of phoneticDivs) {
        const word = phoneticDiv.getAttribute('data-word');
        
        // Skip if already loaded
        if (phoneticDiv.textContent && phoneticDiv.textContent !== '') {
            continue;
        }
        
        try {
            // Check Firestore cache
            const wordRef = db.collection('dictionary').doc(word.toLowerCase());
            const wordDoc = await wordRef.get();
            
            if (wordDoc.exists && wordDoc.data().phonetic) {
    // Found in cache - display immediately
    const formattedPhonetic = wordDoc.data().phonetic.replace(/\//g, '');
    phoneticDiv.innerHTML = `<strong>(${formattedPhonetic})</strong>`;
    phoneticDiv.style.color = '#000';
}
            // If not in cache, leave blank (will load when clicked)
        } catch (error) {
            console.error('Error loading phonetic for', word, error);
        }
    }
}
        
        // ===== SHOW WORD DETAIL (CALL CLOUD FUNCTION) =====
       async function showWordDetail(word) {
    currentWord = word;
    
    const modal = document.getElementById('wordModal');
    document.getElementById('modalWord').textContent = word;
    document.getElementById('modalPhonetic').textContent = 'Loading...';
    document.getElementById('modalContent').innerHTML = '<div class="loading">üìö Loading definition...</div>';
    
    modal.classList.add('active');

    try {
        // Step 1: Check if word exists in Firestore cache
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
       if (wordDoc.exists) {
    // Word found in cache - use it (NO API CALL = FREE!)
    console.log('‚úÖ Found in cache - no API call needed!');
    const cachedData = wordDoc.data();
    
    // Check if origin is missing and fetch it
    if (!cachedData.origin) {
        console.log('‚ö†Ô∏è Origin missing - fetching from API...');
        try {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: word } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.origin) {
                    // Update Firestore with origin
                    await wordRef.update({
                        origin: data.result.origin
                    });
                    cachedData.origin = data.result.origin;
                    console.log('‚úÖ Origin fetched and saved!');
                }
            }
        } catch (error) {
            console.error('Error fetching origin:', error);
        }
    }
    
    displayWordDetails(cachedData);
}
       else {
            // Step 2: Word NOT in cache - fetch from API (COSTS MONEY)
            console.log('‚ö†Ô∏è Not in cache - calling paid API...');
            console.log('API URL:', CLOUD_FUNCTION_URL);
            console.log('Request payload:', { data: { word: word } });
            
            document.getElementById('modalContent').innerHTML = '<div class="loading">ü§ñ Fetching from paid API (first time)...</div>';
            
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ data: { word: word } })
            });

            console.log('Response Status:', response.status);
            console.log('Response OK:', response.ok);
            console.log('Response Headers:', [...response.headers.entries()]);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Error Response Body:', errorText);
                throw new Error(`API Error (${response.status}): ${errorText || response.statusText}`);
            }

            const data = await response.json();
            console.log('Response Data:', data);
            
            if (data.result) {
                // Step 3: Store in Firestore for future use
                await wordRef.set({
                    ...data.result,
                    word: word.toLowerCase(),
                    cachedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Saved to Firestore cache!');
                
                displayWordDetails(data.result);
            } else {
                throw new Error('No definition found in API response');
            }
        }
    } catch (error) {
        console.error('‚ùå FULL ERROR:', error);
        console.error('Error Type:', error.constructor.name);
        console.error('Error Stack:', error.stack);
        
        let errorDetails = '';
        
        // Detailed error categorization
        if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
            errorDetails = `
                <strong>üî¥ Network/CORS Error:</strong><br><br>
                <strong>Possible causes:</strong><br>
                1. Cloud Function not deployed or not accessible<br>
                2. CORS not configured on Cloud Function<br>
                3. Function URL incorrect<br>
                4. Network connectivity issue<br><br>
                
                <strong>Your Function URL:</strong><br>
                <code style="background: #f0f0f0; padding: 5px; display: block; word-break: break-all;">
                    ${CLOUD_FUNCTION_URL}
                </code><br>
                
                <strong>To fix:</strong><br>
                ‚Ä¢ Go to Google Cloud Console<br>
                ‚Ä¢ Find your Cloud Function<br>
                ‚Ä¢ Add CORS headers in your function code:<br>
                <code style="background: #f0f0f0; padding: 10px; display: block; margin-top: 5px;">
                res.set('Access-Control-Allow-Origin', '*');<br>
                res.set('Access-Control-Allow-Methods', 'POST');<br>
                res.set('Access-Control-Allow-Headers', 'Content-Type');
                </code>
            `;
        } else if (error.message.includes('API Error')) {
            errorDetails = `
                <strong>üî¥ API Response Error:</strong><br><br>
                ${error.message}<br><br>
                <strong>What this means:</strong><br>
                The Cloud Function responded but with an error status.<br>
                Check the Cloud Function logs in Google Cloud Console.
            `;
        } else if (error.message.includes('No definition found')) {
            errorDetails = `
                <strong>üî¥ Definition Not Available:</strong><br><br>
                The API returned successfully but didn't include a definition.<br>
                The word "${word}" might not be in the dictionary API.
            `;
        } else {
            errorDetails = `
                <strong>üî¥ Unexpected Error:</strong><br><br>
                <strong>Error Message:</strong><br>
                ${error.message}<br><br>
                <strong>Error Type:</strong> ${error.constructor.name}
            `;
        }
        
        document.getElementById('modalContent').innerHTML = `
            <div class="word-definition">
                <strong>Word:</strong> ${word}<br><br>
                ‚ùå <strong>Unable to fetch definition</strong><br><br>
                ${errorDetails}<br><br>
                <details style="margin-top: 20px; background: #f9f9f9; padding: 10px; border-radius: 5px;">
                    <summary style="cursor: pointer; font-weight: bold;">üîß Technical Details (for debugging)</summary>
                    <pre style="overflow-x: auto; font-size: 0.85rem; margin-top: 10px;">${JSON.stringify({
                        errorMessage: error.message,
                        errorType: error.constructor.name,
                        stack: error.stack
                    }, null, 2)}</pre>
                </details>
                <hr style="margin: 20px 0; border: 1px solid #ddd;">
                You can still practice pronunciation using the buttons below.
            </div>
        `;
        document.getElementById('modalPhonetic').textContent = '';
    }
}

function displayWordDetails(wordData) {
    const phonetic = wordData.phonetic || '';
    document.getElementById('modalPhonetic').textContent = phonetic;

    let html = '';

    // ‚úÖ SHOW SIMPLE ORIGIN
    if (wordData.origin) {
        const simpleOrigin = cleanOriginText(wordData.origin);
        
        html += `
            <div style="margin-bottom: 25px; padding: 12px 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 5px;">
                <strong style="color: #856404; font-size: 1rem;">üìú Origin:</strong>
                <span style="color: #856404; margin-left: 10px; font-size: 1rem;">${simpleOrigin}</span>
            </div>
        `;
    }

    // Rest of the function stays the same...
    if (wordData.meanings && wordData.meanings.length > 0) {
        wordData.meanings.forEach((meaning, index) => {
            html += `
                <div style="margin-bottom: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px;">
                    <span class="word-pos">${meaning.partOfSpeech}</span>
                    
                    <div class="word-definition" style="margin-top: 15px;">
                        <strong>Definition:</strong> ${meaning.definition}
                    </div>
            `;

            if (meaning.example) {
                html += `
                    <div class="word-example">
                        <strong>Example:</strong> "${meaning.example}"
                    </div>
                `;
            }

            if (meaning.synonyms && meaning.synonyms.length > 0) {
                html += `
                    <div style="margin-top: 15px;">
                        <strong style="color: #0d3b66;">üìö Synonyms:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${meaning.synonyms.map(syn => `
                                <span style="background: #e3f2fd; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem;">
                                    ${syn}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (meaning.antonyms && meaning.antonyms.length > 0) {
                html += `
                    <div style="margin-top: 15px;">
                        <strong style="color: #0d3b66;">üîÑ Antonyms:</strong>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                            ${meaning.antonyms.map(ant => `
                                <span style="background: #ffebee; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem;">
                                    ${ant}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div>';
        });
    } else {
        html = `
            <div class="word-definition">
                <strong>Word:</strong> ${currentWord}<br><br>
                Loading definition...<br>
                You can practice pronunciation using the buttons below.
            </div>
        `;
    }

    document.getElementById('modalContent').innerHTML = html;
}

        // Helper function to clean and shorten origin text
function cleanOriginText(origin) {
    if (!origin) return '';
    
    let cleaned = origin.toLowerCase();
    
    // Extract common language origins
    const languagePatterns = [
        /\b(old english|middle english|modern english|english)\b/i,
        /\b(latin|classical latin|late latin|medieval latin)\b/i,
        /\b(greek|ancient greek|classical greek)\b/i,
        /\b(french|old french|middle french|anglo-french)\b/i,
        /\b(german|old german|middle high german)\b/i,
        /\b(spanish|old spanish)\b/i,
        /\b(italian)\b/i,
        /\b(dutch|old dutch)\b/i,
        /\b(norse|old norse)\b/i,
        /\b(sanskrit)\b/i,
        /\b(hebrew|ancient hebrew)\b/i,
        /\b(arabic|classical arabic)\b/i,
        /\b(persian)\b/i,
        /\b(chinese|mandarin)\b/i,
        /\b(japanese)\b/i,
        /\b(portuguese)\b/i,
        /\b(russian)\b/i,
        /\b(celtic|gaelic|irish)\b/i,
        /\b(proto-germanic|proto-indo-european)\b/i
    ];
    
    // Try to find a language match
    for (let pattern of languagePatterns) {
        const match = cleaned.match(pattern);
        if (match) {
            // Capitalize first letter of each word
            return match[0].split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
    }
    
    // If no specific language found, extract first few words before comma or period
    const shortOrigin = origin.split(/[,.(]/)[0].trim();
    if (shortOrigin.length < 50) {
        return shortOrigin.charAt(0).toUpperCase() + shortOrigin.slice(1);
    }
    
    // Fallback: return first 30 characters
    return origin.substring(0, 30).trim() + '...';
}

        
// ‚≠ê NEW HELPER FUNCTION - Fetch word details with origin
async function fetchWordDetails(word) {
    try {
        // Check Firestore cache first
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();

        if (wordDoc.exists) {
            const data = wordDoc.data();
            
            // Clean the origin if it exists and is too long
            let cleanedOrigin = data.origin;
            if (cleanedOrigin && cleanedOrigin.length > 150) {
                cleanedOrigin = cleanOriginText(cleanedOrigin);
                
                // Update Firestore with cleaned origin
                await wordRef.update({ origin: cleanedOrigin });
            }
            
            return {
                phonetic: data.phonetic || '',
                origin: cleanedOrigin || null,
                definition: data.meanings?.[0]?.definition || ''
            };
        }

        // If not in cache, fetch from Cloud Run
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: { word: word } })
        });

        if (!response.ok) {
            throw new Error('Failed to fetch word details');
        }

        const data = await response.json();
        
        if (data.result) {
            // Clean the origin before caching
            let cleanedOrigin = data.result.origin;
            if (cleanedOrigin) {
                cleanedOrigin = cleanOriginText(cleanedOrigin);
            }
            
            // Cache it with cleaned origin
            await wordRef.set({
                ...data.result,
                origin: cleanedOrigin,
                word: word.toLowerCase(),
                cachedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            return {
                phonetic: data.result.phonetic || '',
                origin: cleanedOrigin || null,
                definition: data.result.meanings?.[0]?.definition || ''
            };
        }

        return {};
    } catch (error) {
        console.error('Error fetching word details:', error);
        return {};
    }
}
        

        // ===== CLOSE MODAL =====
        function closeModal() {
            document.getElementById('wordModal').classList.remove('active');
            document.getElementById('practiceFeedback').innerHTML = '';
        }

        // ===== TEXT-TO-SPEECH =====
        function speakWord() {
            if (!currentWord) return;
            
            const utterance = new SpeechSynthesisUtterance(currentWord);
            utterance.rate = 0.8;
            utterance.pitch = 1;
            utterance.volume = 2;
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
        }

        function speakWordQuick(word) {
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.rate = 0.8;
            window.speechSynthesis.speak(utterance);
        }

        // ===== SPEECH RECOGNITION =====
        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript.toLowerCase().trim();
                    checkPronunciation(transcript);
                };

                recognition.onerror = function(event) {
                    isListening = false;
                    document.getElementById('practiceBtn').classList.remove('listening');
                    document.getElementById('practiceFeedback').innerHTML = `
                        <div class="feedback error">
                            ‚ùå Error: ${event.error}. Please try again.
                        </div>
                    `;
                };

                recognition.onend = function() {
                    isListening = false;
                    document.getElementById('practiceBtn').classList.remove('listening');
                    document.getElementById('practiceBtn').textContent = 'üé§ Practice Speaking';
                };
            }
        }

        // ===== START PRACTICE =====
        function startPractice() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser. Please use Chrome or Edge.');
                return;
            }

            if (isListening) {
                recognition.stop();
                return;
            }

            isListening = true;
            document.getElementById('practiceBtn').classList.add('listening');
            document.getElementById('practiceBtn').textContent = 'üé§ Listening...';
            document.getElementById('practiceFeedback').innerHTML = '<div class="feedback">Speak now...</div>';

            try {
                recognition.start();
            } catch (error) {
                console.error('Recognition start error:', error);
                isListening = false;
                document.getElementById('practiceBtn').classList.remove('listening');
            }
        }

        // ===== CHECK PRONUNCIATION =====
        function checkPronunciation(spokenWord) {
            const correctWord = currentWord.toLowerCase();
            const feedbackDiv = document.getElementById('practiceFeedback');
            
            const cleanSpoken = spokenWord.replace(/[^\w\s]/gi, '').trim();
            const cleanCorrect = correctWord.replace(/[^\w\s]/gi, '').trim();

            if (cleanSpoken === cleanCorrect) {
                feedbackDiv.innerHTML = `
                    <div class="feedback success">
                        ‚úÖ Perfect! You said: "${spokenWord}"<br>
                        Accuracy: 100%
                    </div>
                `;
                return;
            }

            const similarity = calculateSimilarity(cleanSpoken, cleanCorrect);
            
            if (similarity > 0.6) {
                feedbackDiv.innerHTML = `
                    <div class="feedback success">
                        ‚úÖ Good effort! You said: "${spokenWord}"<br>
                        Expected: "${correctWord}"<br>
                        Accuracy: ${Math.round(similarity * 100)}%
                    </div>
                `;
            } else {
                feedbackDiv.innerHTML = `
                    <div class="feedback error">
                        ‚ùå Not quite. You said: "${spokenWord}"<br>
                        Expected: "${correctWord}"<br>
                        Try again!
                    </div>
                `;
            }
        }

        // ===== CALCULATE SIMILARITY =====
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1.0;
            
            const editDistance = getEditDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function getEditDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

       // ===== AUTHENTICATION FUNCTIONS =====
function showAuthModal() {
    document.getElementById('authModal').classList.add('active');
}

function closeAuthModal() {
    document.getElementById('authModal').classList.remove('active');
    document.getElementById('signin-error').style.display = 'none';
    
    // Hide all signup forms and show selection
    document.getElementById('signup-selection').style.display = 'none';
    document.getElementById('signup-student-form').style.display = 'none';
    document.getElementById('signup-coach-form').style.display = 'none';
    document.getElementById('signup-organization-form').style.display = 'none';
    
    // Clear all error messages
    document.querySelectorAll('.feedback.error').forEach(el => el.style.display = 'none');
}

function switchAuthTab(tab) {
    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.auth-form').forEach(f => {
        f.classList.remove('active');
        f.style.display = 'none'; // Force hide all forms
    });
    
    if (tab === 'signin') {
        document.querySelector('.auth-tab:first-child').classList.add('active');
        document.getElementById('signin-form').classList.add('active');
        document.getElementById('signin-form').style.display = 'block';
        
        // Hide all signup forms
        document.getElementById('signup-selection').style.display = 'none';
        document.getElementById('signup-student-form').style.display = 'none';
        document.getElementById('signup-coach-form').style.display = 'none';
        document.getElementById('signup-organization-form').style.display = 'none';
    } else {
        document.querySelector('.auth-tab:last-child').classList.add('active');
        document.getElementById('signup-selection').classList.add('active');
        document.getElementById('signup-selection').style.display = 'block';
        
        // Hide signin form
        document.getElementById('signin-form').style.display = 'none';
    }
}

function showSignUpForm(userType) {
    // Hide selection screen
    document.getElementById('signup-selection').style.display = 'none';
    
    // Show appropriate form
    if (userType === 'student') {
        document.getElementById('signup-student-form').style.display = 'block';
    } else if (userType === 'coach') {
        document.getElementById('signup-coach-form').style.display = 'block';
    } else if (userType === 'organization') {
        document.getElementById('signup-organization-form').style.display = 'block';
    }
}

function backToUserTypeSelection() {
    // Hide all forms
    document.getElementById('signup-student-form').style.display = 'none';
    document.getElementById('signup-coach-form').style.display = 'none';
    document.getElementById('signup-organization-form').style.display = 'none';
    
    // Show selection
    document.getElementById('signup-selection').style.display = 'block';
}

async function handleSignIn(event) {
    event.preventDefault();
    const email = document.getElementById('signin-email').value;
    const password = document.getElementById('signin-password').value;
    const errorDiv = document.getElementById('signin-error');

    try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Check if user document exists in Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();
        
        if (!userDoc.exists) {
            // User signed in but no profile exists - sign them out
            await auth.signOut();
            errorDiv.textContent = 'No account found with this email. Please sign up first.';
            errorDiv.style.display = 'block';
            return;
        }
        
        // Check if profile is complete
        const userData = userDoc.data();
        if (!userData.profileComplete) {
            // Show verification modal
            closeAuthModal();
            showVerificationModal(userData);
            return;
        }
        
        closeAuthModal();
        errorDiv.style.display = 'none';
    } catch (error) {
        if (error.code === 'auth/user-not-found') {
            errorDiv.textContent = 'No account found with this email. Please sign up first.';
        } else if (error.code === 'auth/wrong-password') {
            errorDiv.textContent = 'Incorrect password. Please try again.';
        } else if (error.code === 'auth/invalid-email') {
            errorDiv.textContent = 'Invalid email address.';
        } else {
            errorDiv.textContent = error.message;
        }
        errorDiv.style.display = 'block';
    }
}

async function handleSignUp(event, userType) {
    event.preventDefault();
    
    let name, email, password, errorDiv;
    let additionalData = { 
        userType: userType,
        profileComplete: false // Mark as incomplete
    };
    
    if (userType === 'student') {
        name = document.getElementById('signup-student-name').value;
        email = document.getElementById('signup-student-email').value;
        password = document.getElementById('signup-student-password').value;
        errorDiv = document.getElementById('signup-student-error');
        additionalData.age = document.getElementById('signup-student-age').value;
        additionalData.country = document.getElementById('signup-student-country').value;
        
        // For students, if they provided age and country, mark complete
        if (additionalData.age && additionalData.country) {
            additionalData.profileComplete = true;
        }
    } else if (userType === 'coach') {
        name = document.getElementById('signup-coach-name').value;
        email = document.getElementById('signup-coach-email').value;
        password = document.getElementById('signup-coach-password').value;
        errorDiv = document.getElementById('signup-coach-error');
        additionalData.organization = document.getElementById('signup-coach-organization').value;
        additionalData.profileComplete = true; // Coaches don't need extra verification
    } else if (userType === 'organization') {
        name = document.getElementById('signup-org-name').value;
        email = document.getElementById('signup-org-email').value;
        password = document.getElementById('signup-org-password').value;
        errorDiv = document.getElementById('signup-org-error');
        additionalData.phone = document.getElementById('signup-org-phone').value;
        additionalData.address = document.getElementById('signup-org-address').value;
        additionalData.profileComplete = true; // Organizations don't need extra verification
    }

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await userCredential.user.updateProfile({ displayName: name });
        
        await db.collection('users').doc(userCredential.user.uid).set({
            name: name,
            email: email,
            ...additionalData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        closeAuthModal();
        errorDiv.style.display = 'none';
        
        // If profile not complete, show verification modal
        if (!additionalData.profileComplete) {
            showVerificationModal({ name, email, userType });
        } else {
            alert(`Welcome, ${name}! Your ${userType} account has been created successfully.`);
        }
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}
        
function signOut() {
    auth.signOut();
    navigateTo('home');
}

async function signInWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // Check if user document exists
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            // ‚úÖ NOW SAVING photoURL
            await userRef.set({
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL || null, // ‚úÖ ADD THIS
                userType: 'student',
                profileComplete: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            closeAuthModal();
            showVerificationModal({
                name: user.displayName,
                email: user.email,
                userType: 'student'
            });
        } else {
            // Existing user - check if profile is complete
            const userData = userDoc.data();
            if (!userData.profileComplete) {
                closeAuthModal();
                showVerificationModal(userData);
            } else {
                closeAuthModal();
            }
        }
    } catch (error) {
        console.error('Google sign-in error:', error);
        document.getElementById('signin-error').textContent = error.message;
        document.getElementById('signin-error').style.display = 'block';
    }
}
        
async function signUpWithGoogle(userType) {
    const provider = new firebase.auth.GoogleAuthProvider();
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // ‚úÖ NOW SAVING photoURL
        const userRef = db.collection('users').doc(user.uid);
        await userRef.set({
            name: user.displayName,
            email: user.email,
            photoURL: user.photoURL || null, // ‚úÖ ADD THIS
            userType: userType,
            profileComplete: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        closeAuthModal();
        showVerificationModal({
            name: user.displayName,
            email: user.email,
            userType: userType
        });
    } catch (error) {
        console.error('Google sign-up error:', error);
        const errorDiv = document.getElementById(`signup-${userType}-error`);
        errorDiv.textContent = error.message;
        errorDiv.style.display = 'block';
    }
}

        // ===== VERIFICATION MODAL FUNCTIONS =====
function showVerificationModal(userData) {
    const modal = document.getElementById('verificationModal');
    
    // Pre-fill any existing data
    if (userData.name) {
        document.getElementById('verify-name').value = userData.name;
    }
    if (userData.age) {
        document.getElementById('verify-age').value = userData.age;
    }
    if (userData.country) {
        document.getElementById('verify-country').value = userData.country;
    }
    
    modal.classList.add('active');
}

function closeVerificationModal() {
    document.getElementById('verificationModal').classList.remove('active');
}

async function handleVerification(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const name = document.getElementById('verify-name').value.trim();
    const age = document.getElementById('verify-age').value;
    const country = document.getElementById('verify-country').value;
    const errorDiv = document.getElementById('verify-error');
    
    if (!name || !age || !country) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (age < 5 || age > 100) {
        errorDiv.textContent = 'Please enter a valid age between 5 and 100.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            name: name,
            age: parseInt(age),
            country: country,
            profileComplete: true
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: name });
        
        errorDiv.style.display = 'none';
        closeVerificationModal();
        
        alert('‚úÖ Profile completed successfully! Welcome to WordBiz Coaching Academy!');
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
    } catch (error) {
        console.error('Error completing profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

        async function signOutAndSwitchAccount() {
    if (confirm('‚ö†Ô∏è Are you sure you want to sign out? You will need to sign in with a different account.')) {
        try {
            // Close verification modal
            closeVerificationModal();
            
            // Sign out the user
            await auth.signOut();
            
            // Reset UI to guest state
            currentUser = null;
            updateUIForGuestUser();
            
            // Navigate to home
            navigateTo('home');
            
            // Show auth modal for them to sign in/up with different account
            setTimeout(() => {
                showAuthModal();
            }, 500);
            
        } catch (error) {
            console.error('Error signing out:', error);
            alert('Failed to sign out: ' + error.message);
        }
    }
}

        // ===== ID VERIFICATION FUNCTIONS =====

function showVerificationModal(userData) {
    const modal = document.getElementById('verificationModal');
    const idSection = document.getElementById('coachIdVerification');
    const completeBtn = document.getElementById('completeProfileBtn');
    
    // Pre-fill any existing data
    if (userData.name) {
        document.getElementById('verify-name').value = userData.name;
    }
    if (userData.age) {
        document.getElementById('verify-age').value = userData.age;
    }
    if (userData.country) {
        document.getElementById('verify-country').value = userData.country;
    }
    
    // Check if this is a coach
    isCoachVerification = (userData.userType === 'coach');
    
    if (isCoachVerification) {
        idSection.classList.add('show');
        completeBtn.textContent = '‚è≥ Upload ID to Continue';
        completeBtn.disabled = true;
    } else {
        idSection.classList.remove('show');
        completeBtn.textContent = '‚úÖ Complete Profile';
        completeBtn.disabled = false;
    }
    
    // Reset ID verification state
    uploadedIDFile = null;
    uploadedIDBase64 = null;
    idVerificationPassed = false;
    document.getElementById('idPreviewContainer').classList.remove('show');
    document.getElementById('idVerificationStatus').classList.remove('show');
    
    modal.classList.add('active');
}

// Handle ID file upload
function handleIDUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        alert('File is too large. Maximum size is 10MB.');
        return;
    }
    
    // Validate file type
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert('Invalid file type. Please upload JPG, PNG, or PDF.');
        return;
    }
    
    uploadedIDFile = file;
    
    // Convert to base64 for preview and API
    const reader = new FileReader();
    reader.onload = function(e) {
        uploadedIDBase64 = e.target.result.split(',')[1]; // Remove data:image/jpeg;base64, prefix
        
        // Show preview for images only
        if (file.type.startsWith('image/')) {
            document.getElementById('idPreviewImage').src = e.target.result;
            document.getElementById('idPreviewContainer').classList.add('show');
        } else {
            document.getElementById('idPreviewContainer').classList.remove('show');
        }
        
        // Automatically start verification
        verifyIDWithAI();
    };
    reader.readAsDataURL(file);
}

// Drag and drop support
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('idUploadArea');
    
    if (uploadArea) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => {
                uploadArea.classList.remove('drag-over');
            }, false);
        });
        
        uploadArea.addEventListener('drop', function(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                document.getElementById('verify-id-file').files = files;
                handleIDUpload({ target: { files: files } });
            }
        }, false);
    }
});

function changeIDPhoto() {
    document.getElementById('verify-id-file').value = '';
    document.getElementById('idPreviewContainer').classList.remove('show');
    document.getElementById('idVerificationStatus').classList.remove('show');
    uploadedIDFile = null;
    uploadedIDBase64 = null;
    idVerificationPassed = false;
    document.getElementById('completeProfileBtn').disabled = true;
    document.getElementById('completeProfileBtn').textContent = '‚è≥ Upload ID to Continue';
}

// Verify ID using AI
async function verifyIDWithAI() {
    if (!uploadedIDBase64) {
        alert('Please upload an ID first');
        return;
    }
    
    const statusDiv = document.getElementById('idVerificationStatus');
    const completeBtn = document.getElementById('completeProfileBtn');
    const coachName = document.getElementById('verify-name').value.trim();
    
    if (!coachName) {
        alert('Please enter your full name first');
        return;
    }
    
    // Show verifying status
    statusDiv.className = 'id-verification-status verifying show';
    statusDiv.innerHTML = `
        <div class="verification-spinner"></div>
        <strong>Verifying your ID...</strong>
        <p style="margin-top: 8px;">This may take 10-20 seconds. Please wait...</p>
    `;
    
    completeBtn.disabled = true;
    completeBtn.textContent = '‚è≥ Verifying ID...';
    
    try {
        // Call your Cloud Run function
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                data: {
                    action: 'verifyCoachID',
                    imageBase64: uploadedIDBase64,
                    coachName: coachName,
                    userId: currentUser.uid
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`Verification failed: ${response.status}`);
        }
        
        const data = await response.json();
        const result = data.result;
        
        console.log('Verification result:', result);
        
        if (result.isValid && result.isOver16 && !result.documentAppearsTampered) {
            // Success
            idVerificationPassed = true;
            statusDiv.className = 'id-verification-status success show';
            statusDiv.innerHTML = `
                <strong>ID Verified Successfully!</strong>
                <p style="margin-top: 8px;">
                    <strong>Document:</strong> ${result.documentType}<br>
                    <strong>Name:</strong> ${result.fullName}<br>
                    <strong>Age:</strong> ${result.age} years old<br>
                    <strong>Status:</strong> ${result.reason}
                </p>
                <p style="margin-top: 10px; font-size: 0.9rem; font-style: italic;">
                    üîí Your ID photo has not been stored. Only verification status is saved.
                </p>
            `;
            
            completeBtn.disabled = false;
            completeBtn.textContent = 'COMPLETE PROFILE';
            
            // Store verification result in Firestore (without the image)
            await db.collection('users').doc(currentUser.uid).update({
                idVerified: true,
                idVerificationDate: firebase.firestore.FieldValue.serverTimestamp(),
                idDocumentType: result.documentType,
                idVerificationConfidence: result.confidence,
                verifiedAge: result.age
            });
            
        } else {
            // Verification failed
            idVerificationPassed = false;
            statusDiv.className = 'id-verification-status error show';
            
            let errorMessage = result.reason || 'Verification failed';
            
            if (!result.isValid) {
                errorMessage = '‚ùå Invalid or unrecognized document. Please upload a clear photo of your Driver\'s License, Passport, or National ID.';
            } else if (!result.isOver16) {
                errorMessage = '‚ùå You must be at least 16 years old to register as a coach.';
            } else if (result.documentAppearsTampered) {
                errorMessage = '‚ùå Document appears to be altered or tampered. Please upload an original, unedited ID.';
            }
            
            statusDiv.innerHTML = `
                <strong>Verification Failed</strong>
                <p style="margin-top: 8px;">${errorMessage}</p>
                ${result.fullName ? `<p style="margin-top: 5px;"><strong>Detected Name:</strong> ${result.fullName}</p>` : ''}
                ${result.age ? `<p><strong>Detected Age:</strong> ${result.age}</p>` : ''}
                <p style="margin-top: 10px; font-size: 0.9rem;">
                    <strong>Tips for better verification:</strong><br>
                    ‚Ä¢ Ensure good lighting<br>
                    ‚Ä¢ Avoid glare or shadows<br>
                    ‚Ä¢ Make sure all text is readable<br>
                    ‚Ä¢ Use the original, unedited document
                </p>
            `;
            
            completeBtn.disabled = true;
            completeBtn.textContent = '‚ùå Upload Valid ID';
        }
        
    } catch (error) {
        console.error('ID Verification Error:', error);
        idVerificationPassed = false;
        statusDiv.className = 'id-verification-status error show';
        statusDiv.innerHTML = `
            <strong>‚ùå Verification Error</strong>
            <p style="margin-top: 8px;">
                Unable to verify your ID. This could be due to:<br>
                ‚Ä¢ Poor image quality<br>
                ‚Ä¢ Network connection issues<br>
                ‚Ä¢ Unsupported document format
            </p>
            <p style="margin-top: 10px;">
                Error details: ${error.message}
            </p>
            <p style="margin-top: 10px; font-weight: bold;">
                Please try uploading a clearer photo of your ID.
            </p>
        `;
        
        completeBtn.disabled = true;
        completeBtn.textContent = '‚ùå Upload Valid ID';
    }
}

// Update handleVerification function to include ID check
async function handleVerification(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Session expired. Please sign in again.');
        return;
    }
    
    const name = document.getElementById('verify-name').value.trim();
    const age = document.getElementById('verify-age').value;
    const country = document.getElementById('verify-country').value;
    const errorDiv = document.getElementById('verify-error');
    
    if (!name || !age || !country) {
        errorDiv.textContent = 'All fields are required.';
        errorDiv.style.display = 'block';
        return;
    }
    
    if (age < 5 || age > 100) {
        errorDiv.textContent = 'Please enter a valid age between 5 and 100.';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Check if coach needs ID verification
    if (isCoachVerification && !idVerificationPassed) {
        errorDiv.textContent = 'Please upload and verify your government-issued ID to continue.';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // ‚úÖ Update Firestore - PRESERVE photoURL
        const updateData = {
            name: name,
            age: parseInt(age),
            country: country,
            profileComplete: true
        };
        
        // Only add photoURL if it exists (don't overwrite with null)
        if (currentUser.photoURL) {
            updateData.photoURL = currentUser.photoURL;
        }
        
        await db.collection('users').doc(currentUser.uid).update(updateData);
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: name });
        
        errorDiv.style.display = 'none';
        closeVerificationModal();
        
        if (isCoachVerification) {
            alert('‚úÖ Profile and ID verification completed successfully! Welcome to WordBiz Coaching Academy!');
        } else {
            alert('‚úÖ Profile completed successfully! Welcome to WordBiz Coaching Academy!');
        }
        
        // Refresh UI
        updateUIForAuthenticatedUser(currentUser);
    } catch (error) {
        console.error('Error completing profile:', error);
        errorDiv.textContent = 'Failed to complete profile: ' + error.message;
        errorDiv.style.display = 'block';
    }
}
        
        
        function updateUIForAuthenticatedUser(user) {
    const displayName = user.displayName || user.email.split('@')[0];
    const photoURL = user.photoURL;
    
    // Update sidebar
    document.getElementById('sidebarUserName').textContent = displayName;
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    
    if (photoURL) {
        sidebarAvatar.style.backgroundImage = `url(${photoURL})`;
        sidebarAvatar.textContent = '';
    } else {
        sidebarAvatar.style.backgroundImage = 'none';
        sidebarAvatar.textContent = displayName.charAt(0).toUpperCase();
    }
    
    // Show My Profile button
    document.getElementById('myProfileBtn').style.display = 'block';
    
    document.getElementById('sidebar-signin').style.display = 'none';
    document.getElementById('sidebar-signout').style.display = 'block';
}
        
       function updateUIForGuestUser() {
    document.getElementById('sidebarUserName').textContent = 'Guest';
    const sidebarAvatar = document.getElementById('sidebarUserAvatar');
    sidebarAvatar.style.backgroundImage = 'none';
    sidebarAvatar.textContent = '?';
    
    // Hide My Profile button
    document.getElementById('myProfileBtn').style.display = 'none';
    
    document.getElementById('sidebar-signin').style.display = 'block';
    document.getElementById('sidebar-signout').style.display = 'none';
    userFavorites = [];
    userIncorrect = [];
    userSpellingFavorites = [];
    userSpellingIncorrect = [];
    
    document.getElementById('favorites-container').innerHTML = '<div class="loading">Please sign in to save favorites</div>';
    document.getElementById('incorrect-container').innerHTML = '<div class="loading">Please sign in to track incorrect answers</div>';
    document.getElementById('spelling-favorites-container').innerHTML = '<div class="loading">Please sign in to save spelling favorites</div>';
    document.getElementById('spelling-incorrect-container').innerHTML = '<div class="loading">Please sign in to track spelling mistakes</div>';
}
        
       
        // ===== QUIZ FUNCTIONS =====
        function switchQuizMode(mode) {
            document.querySelectorAll('.quiz-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.quiz-mode').forEach(m => {
                m.classList.remove('active');
            });

            document.getElementById('practice-quiz-mode').classList.add('active');
        }

     async function startPracticeQuizWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection
    document.getElementById('quiz-level-selection').style.display = 'none';
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üìö Loading words from ' + level.toUpperCase() + ' level...</div>';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üé≤ Generating quiz questions...</div>';
    
    // Initialize IQ tracking
    quizStartTime = Date.now();
    quizAnswerTimes = [];
    
    const quizWords = [];
    for (let i = 0; i < 5; i++) {
        const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
        quizWords.push(randomWord);
    }
    
    try {
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                data: { 
                    action: 'generatePracticeQuiz',
                    words: quizWords 
                } 
            })
        });
        
        const data = await response.json();
        currentQuiz = data.result;
        currentQuestionIndex = 0;
        quizScore = 0;
        
        showQuestion('practice');
    } catch (error) {
        console.error('Error generating quiz:', error);
        document.getElementById('practice-quiz-container').innerHTML = 
            '<div class="feedback error">Failed to generate quiz. Please try again.</div>';
    }
}

// Keep old function name for backwards compatibility but add check
async function startPracticeQuiz() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    await startPracticeQuizWithLevel(selectedGameLevel);
}

function backToQuizLevelSelection() {
    document.getElementById('quiz-level-selection').style.display = 'block';
    document.getElementById('practice-quiz-container').innerHTML = '';
    selectedGameLevel = '';
}


function showQuestion(quizType = 'practice') {
    const question = currentQuiz.questions[currentQuestionIndex];
    const container = document.getElementById('practice-quiz-container');
    
    const isFavorited = userFavorites.some(fav => fav.word === question.word);
    
    // Start timing for this question
    questionStartTime = Date.now();
    
    container.innerHTML = `
        <div class="quiz-question-card" style="position: relative;">
            ${currentUser ? `
                <span class="favorite-heart ${isFavorited ? 'active' : ''}" 
                      onclick="event.stopPropagation(); toggleFavorite('${question.word}', null, this)">
                    ${isFavorited ? '‚ù§Ô∏è' : 'ü§ç'}
                </span>
            ` : ''}
            <div class="quiz-score">Score: ${quizScore} / ${currentQuestionIndex}</div>
            <h3>Question ${currentQuestionIndex + 1} of ${currentQuiz.questions.length}</h3>
            <p style="font-size: 1.3rem; margin: 20px 0;"><strong>${question.question}</strong></p>
            <div class="quiz-options">
                ${question.options.map((option, index) => `
                    <div class="quiz-option" onclick="checkAnswer(${index}, '${quizType}')">
                        ${option}
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

       async function checkAnswer(selectedIndex, quizType = 'practice') {
    const question = currentQuiz.questions[currentQuestionIndex];
    const options = document.querySelectorAll('.quiz-option');
    
    // Calculate time taken for this question
    const timeTaken = Date.now() - questionStartTime;
    quizAnswerTimes.push({
        correct: selectedIndex === question.correctAnswer,
        timeTaken: timeTaken
    });
    
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        options[selectedIndex].classList.add('correct');
        quizScore++;
    } else {
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
        
        if (currentUser) {
            await saveIncorrectQuestion(question, quizType, selectedIndex);
        }
        
        if (currentUser) {
            const favoriteRef = db.collection('users').doc(currentUser.uid).collection('favorites').doc(question.word);
            const favoriteDoc = await favoriteRef.get();
            
            if (favoriteDoc.exists) {
                await favoriteRef.update({
                    userAnswerIndex: selectedIndex
                });
                
                const favIndex = userFavorites.findIndex(fav => fav.word === question.word);
                if (favIndex !== -1) {
                    userFavorites[favIndex].userAnswerIndex = selectedIndex;
                }
                
                if (document.getElementById('favorites-section').classList.contains('active')) {
                    displayFavorites();
                }
            }
        }
    }
    
    setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < currentQuiz.questions.length) {
            questionStartTime = Date.now(); // Reset timer for next question
            showQuestion(quizType);
        } else {
            showQuizResults();
        }
    }, 3000);
}

        function calculateIQScore(score, total, answerTimes) {
    // Base IQ calculation on accuracy and speed
    const accuracyPercentage = (score / total) * 100;
    
    // Calculate average time per question (in seconds)
    const avgTime = answerTimes.reduce((sum, ans) => sum + ans.timeTaken, 0) / answerTimes.length / 1000;
    
    // Speed score: faster is better (ideal time: 5-10 seconds per question)
    let speedScore = 0;
    if (avgTime < 5) speedScore = 100;
    else if (avgTime < 10) speedScore = 90;
    else if (avgTime < 15) speedScore = 75;
    else if (avgTime < 20) speedScore = 60;
    else speedScore = 40;
    
    // Consistency score: fewer mistakes on easy questions = higher IQ
    const correctAnswers = answerTimes.filter(ans => ans.correct).length;
    const consistencyScore = (correctAnswers / total) * 100;
    
    // Calculate base IQ (scale: 70-145)
    // Formula: 70 + (accuracy * 0.5) + (speed * 0.2) + (consistency * 0.05)
    let iq = 70 + (accuracyPercentage * 0.5) + (speedScore * 0.2) + (consistencyScore * 0.05);
    
    // Cap at 145 (genius level)
    iq = Math.min(145, Math.round(iq));
    
    return {
        iq: iq,
        accuracy: accuracyPercentage,
        avgTime: avgTime.toFixed(1),
        speedScore: speedScore,
        category: getIQCategory(iq)
    };
}

function getIQCategory(iq) {
    if (iq >= 130) return { label: "Genius", color: "#FFD700", emoji: "üß†‚ú®" };
    if (iq >= 120) return { label: "Superior", color: "#4CAF50", emoji: "üåü" };
    if (iq >= 110) return { label: "High Average", color: "#2196F3", emoji: "‚≠ê" };
    if (iq >= 90) return { label: "Average", color: "#FF9800", emoji: "üëç" };
    if (iq >= 80) return { label: "Low Average", color: "#FF5722", emoji: "üìö" };
    return { label: "Keep Practicing", color: "#9E9E9E", emoji: "üí™" };
}
        
        function showQuizResults() {
    const container = document.getElementById('practice-quiz-container');
    const percentage = Math.round((quizScore / currentQuiz.questions.length) * 100);
    
    // Calculate IQ Score
    const iqData = calculateIQScore(quizScore, currentQuiz.questions.length, quizAnswerTimes);
    
    let message = '';
    let emoji = '';
    let showBalloons = false;
    let showSpellingEncouragement = false;
    
    if (percentage >= 80) {
        message = 'Excellent! You\'re a word master!';
        emoji = 'üèÜ';
        showBalloons = true;
        showSpellingEncouragement = true;
    } else if (percentage >= 60) {
        message = 'Great job! Keep practicing!';
        emoji = '‚≠ê';
        showSpellingEncouragement = true;
    } else {
        message = 'Keep practicing! You\'ll get better!';
        emoji = 'üìö';
    }
    
    // Create balloons if score is high
    if (showBalloons) {
        createBalloons();
        createConfetti();
    }
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
            <h2>Quiz Complete!</h2>
            <div class="quiz-score">Final Score: ${quizScore} / ${currentQuiz.questions.length}</div>
            <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
            <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
            
            <!-- IQ Score Display -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; margin: 30px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                <h3 style="color: white; margin-bottom: 15px; font-size: 1.5rem;">üß† Your Vocabulary IQ</h3>
                <div class="iq-badge">${iqData.iq}</div>
                <p style="color: white; font-size: 1.3rem; margin: 15px 0;">
                    ${iqData.category.emoji} <strong>${iqData.category.label}</strong>
                </p>
                <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p style="color: white; margin: 8px 0;"><strong>üìä Accuracy:</strong> ${iqData.accuracy.toFixed(1)}%</p>
                    <p style="color: white; margin: 8px 0;"><strong>‚ö° Avg Response Time:</strong> ${iqData.avgTime}s</p>
                    <p style="color: white; margin: 8px 0;"><strong>üéØ Speed Score:</strong> ${iqData.speedScore}/100</p>
                </div>
            </div>
            
            ${showSpellingEncouragement ? `
                <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 25px; border-radius: 15px; margin: 20px 0; box-shadow: 0 5px 20px rgba(255,215,0,0.4); animation: pulse-glow 2s infinite;">
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">üèÜ You Have Spelling Champion Potential!</h3>
                    <p style="color: #0d3b66; margin: 10px 0; font-size: 1.1rem;">
                        Your strong vocabulary skills show you could excel at spelling competitions!
                    </p>
                    <p style="color: #0d3b66; margin: 10px 0; font-weight: bold;">
                        üí∞ Head to the Spelling section to practice and earn coins in upcoming live challenges!
                    </p>
                    <button class="practice-btn" onclick="navigateTo('spelling')" style="background: #0d3b66; color: white; margin-top: 15px; font-size: 1.1rem; padding: 15px 30px;">
                        üî§ Go to Spelling Practice ‚Üí
                    </button>
                </div>
            ` : ''}
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
    <button class="practice-btn" onclick="backToQuizLevelSelection()">‚Üê Back to Levels</button>
    <button class="practice-btn" onclick="startPracticeQuizWithLevel('${selectedGameLevel}')">üîÑ Try Again</button>
    <button class="practice-btn" onclick="navigateTo('home')">üè† Home</button>
</div>
        </div>
    `;
}

function createBalloons() {
    const balloons = ['üéà', 'üéà', 'üéà', 'üéà', 'üéà', 'üéà'];
    const colors = ['red', 'blue', 'green', 'yellow', 'purple', 'pink'];
    
    balloons.forEach((balloon, index) => {
        const balloonEl = document.createElement('div');
        balloonEl.className = 'balloon';
        balloonEl.textContent = balloon;
        balloonEl.style.color = colors[index];
        document.body.appendChild(balloonEl);
        
        // Remove after animation
        setTimeout(() => {
            balloonEl.remove();
        }, 8000);
    });
}

function createConfetti() {
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8'];
    
    for (let i = 0; i < 50; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            confetti.style.animationDelay = Math.random() * 2 + 's';
            document.body.appendChild(confetti);
            
            setTimeout(() => confetti.remove(), 3000);
        }, i * 50);
    }
}

        // ===== FAVORITES MANAGEMENT =====
     async function loadUserFavorites(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('favorites').get();
        
        // Load all favorites - only filter out truly broken ones
        userFavorites = snapshot.docs
            .map(doc => ({ id: doc.id, ...doc.data() }))
            .filter(fav => {
                // Keep if it has word and valid question
                return fav.word && 
                       fav.question && 
                       fav.question !== 'undefined';
            });
        
        console.log('Loaded favorites:', userFavorites);
        displayFavorites();
        
        // Enable quiz button based on valid quizzable favorites
        const btn = document.getElementById('favoritesQuizBtn');
        if (btn) {
            const quizzableFavorites = userFavorites.filter(fav => 
                fav.options && 
                Array.isArray(fav.options) && 
                fav.options.length > 0 &&
                typeof fav.correctAnswer === 'number'
            );
            btn.disabled = quizzableFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error loading favorites:', error);
    }
}
        
       async function toggleFavorite(word, questionData, element) {
    if (!currentUser) {
        alert('Please sign in to save favorites');
        return;
    }

    const favoriteRef = db.collection('users').doc(currentUser.uid).collection('favorites').doc(word);
    const favoriteDoc = await favoriteRef.get();

    if (favoriteDoc.exists) {
        await favoriteRef.delete();
        element.textContent = 'ü§ç';
        element.classList.remove('active');
        userFavorites = userFavorites.filter(fav => fav.word !== word);
    } else {
        // Get the current question from the quiz
        const question = currentQuiz.questions[currentQuestionIndex];
        
        const favoriteData = {
            word: word,
            question: question.question,
            options: question.options,
            correctAnswer: question.correctAnswer,
            correctDefinition: question.options[question.correctAnswer],
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Check if this question was already answered incorrectly
        const incorrectAnswer = userIncorrect.find(inc => inc.word === word);
        if (incorrectAnswer && incorrectAnswer.userAnswerIndex !== undefined) {
            favoriteData.userAnswerIndex = incorrectAnswer.userAnswerIndex;
        }
        
        // ALSO check if the user just answered this question wrong (check the DOM)
        const wrongOption = document.querySelector('.quiz-option.wrong');
        if (wrongOption) {
            // Find which index this is
            const allOptions = Array.from(document.querySelectorAll('.quiz-option'));
            const wrongIndex = allOptions.indexOf(wrongOption);
            if (wrongIndex !== -1) {
                favoriteData.userAnswerIndex = wrongIndex;
            }
        }
        
        await favoriteRef.set(favoriteData);
        
        element.textContent = '‚ù§Ô∏è';
        element.classList.add('active');
        
        const newFavorite = {
            word: word,
            question: question.question,
            options: question.options,
            correctAnswer: question.correctAnswer,
            correctDefinition: question.options[question.correctAnswer]
        };
        
        if (favoriteData.userAnswerIndex !== undefined) {
            newFavorite.userAnswerIndex = favoriteData.userAnswerIndex;
        }
        
        userFavorites.push(newFavorite);
    }

    displayFavorites();
}
        
async function startFavoritesQuiz() {
    // Only use favorites that have full question data
    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );
    
    const minQuestions = Math.min(quizzableFavorites.length, 5);
    if (quizzableFavorites.length < minQuestions) {
        alert(`You need at least ${minQuestions} quizzable favorites to generate a quiz`);
        return;
    }

    navigateTo('quiz', true);
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üé≤ Generating quiz from your favorites...</div>';

    // Use the exact saved questions with their options
    const selectedFavorites = [...quizzableFavorites].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

    const quizQuestions = selectedFavorites.map(fav => ({
        word: fav.word,
        question: fav.question,
        options: fav.options,
        correctAnswer: fav.correctAnswer,
        correctDefinition: fav.correctDefinition
    }));

    currentQuiz = { questions: quizQuestions };
    currentQuestionIndex = 0;
    quizScore = 0;

    showQuestion('favorites');
}

function displayFavorites() {
    const container = document.getElementById('favorites-container');
    const btn = document.getElementById('favoritesQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to save favorites</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userFavorites.length === 0) {
        container.innerHTML = '<div class="loading">No favorites yet. Star words from quizzes to add them here!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );

    if (btn) {
        btn.disabled = quizzableFavorites.length < 5;
    }

    container.innerHTML = `
        ${userFavorites.length < 5 ? `
            <div class="loading">
                You have ${userFavorites.length} favorite(s). Add at least ${5 - userFavorites.length} more to generate a quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userFavorites.map(fav => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeFavorite('${fav.word}')">√ó</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">${fav.word}</h3>
                    <p style="color: #666; margin-bottom: 10px;"><strong>Q:</strong> ${fav.question}</p>
                    ${fav.options ? `
                        <div style="margin: 10px 0;">
                            ${fav.options.map((opt, idx) => `
                                <p style="padding: 5px; margin: 3px 0; border-radius: 5px; font-size: 0.9rem; 
                                   background: ${idx === fav.correctAnswer ? '#d4edda' : (fav.userAnswerIndex !== undefined && idx === fav.userAnswerIndex ? '#f8d7da' : '#f9f9f9')};">
                                    ${opt} ${idx === fav.correctAnswer ? '‚úì' : (fav.userAnswerIndex !== undefined && idx === fav.userAnswerIndex ? '‚úó' : '')}
                                </p>
                            `).join('')}
                        </div>
                    ` : `
                        <p style="color: #28a745; margin-top: 10px;"><strong>Definition:</strong> ${fav.correctDefinition || 'No definition saved'}</p>
                    `}
                </div>
            `).join('')}
        </div>
    `;
}
        
        async function removeFavorite(word) {
            if (!currentUser) return;

            await db.collection('users').doc(currentUser.uid).collection('favorites').doc(word).delete();
            userFavorites = userFavorites.filter(fav => fav.word !== word);
            displayFavorites();
        }

      async function startFavoritesQuiz() {
    // Only use favorites that have full question data
    const quizzableFavorites = userFavorites.filter(fav => 
        fav.options && 
        Array.isArray(fav.options) && 
        fav.options.length > 0 &&
        typeof fav.correctAnswer === 'number'
    );
    
    const minQuestions = Math.min(quizzableFavorites.length, 5);
    if (quizzableFavorites.length < minQuestions) {
        alert(`You need at least ${minQuestions} quizzable favorites to generate a quiz`);
        return;
    }

    navigateTo('quiz', true);
    document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üé≤ Generating quiz from your favorites...</div>';

    // Use the exact saved questions with their options
    const selectedFavorites = [...quizzableFavorites].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

    const quizQuestions = selectedFavorites.map(fav => ({
        word: fav.word,
        question: fav.question,
        options: fav.options,
        correctAnswer: fav.correctAnswer,
        correctDefinition: fav.correctDefinition
    }));

    currentQuiz = { questions: quizQuestions };
    currentQuestionIndex = 0;
    quizScore = 0;

    showQuestion('favorites');
}

        
      async function loadUserIncorrect(userId) {
            try {
                const snapshot = await db.collection('users').doc(userId).collection('incorrectQuestions').get();
                userIncorrect = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayIncorrect();
                
                // Enable quiz button if enough incorrect answers
                const btn = document.getElementById('incorrectQuizBtn');
                if (btn) {
                    btn.disabled = userIncorrect.length < 5;
                }
            } catch (error) {
                console.error('Error loading incorrect questions:', error);
            }
        }
        
       async function saveIncorrectQuestion(question, quizType, selectedIndex) {
            if (!currentUser) return;

            const incorrectRef = db.collection('users').doc(currentUser.uid).collection('incorrectQuestions');
            
            // Save complete question with all options
            const docRef = await incorrectRef.add({
                word: question.word,
                question: question.question,
                options: question.options,
                correctAnswer: question.correctAnswer,
                correctDefinition: question.options[question.correctAnswer],
                userAnswer: question.options[selectedIndex],
                userAnswerIndex: selectedIndex,
                quizType: quizType,
                savedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            userIncorrect.push({
                id: docRef.id,
                word: question.word,
                question: question.question,
                options: question.options,
                correctAnswer: question.correctAnswer,
                correctDefinition: question.options[question.correctAnswer],
                userAnswer: question.options[selectedIndex]
            });
            
            displayIncorrect();
        }

       function displayIncorrect() {
            const container = document.getElementById('incorrect-container');
            const btn = document.getElementById('incorrectQuizBtn');

            if (!currentUser) {
                container.innerHTML = '<div class="loading">Please sign in to track incorrect answers</div>';
                btn.disabled = true;
                return;
            }

            if (userIncorrect.length === 0) {
                container.innerHTML = '<div class="loading">No incorrect answers yet. Take a quiz to get started!</div>';
                btn.disabled = true;
                return;
            }

            const minQuestions = Math.min(userIncorrect.length, 5);
            btn.disabled = userIncorrect.length < minQuestions;

            container.innerHTML = `
                ${userIncorrect.length < 5 ? `
                    <div class="loading">
                        You have ${userIncorrect.length} incorrect answer(s). Add at least ${5 - userIncorrect.length} more to generate a practice quiz.
                    </div>
                ` : ''}
                <div class="favorites-grid">
                    ${userIncorrect.map(inc => `
                        <div class="favorite-card">
                            <button class="delete-btn" onclick="removeIncorrect('${inc.id}')">√ó</button>
                            <h3 style="color: #0d3b66; margin-bottom: 10px;">${inc.word}</h3>
                            <p style="color: #666; margin-bottom: 10px;"><strong>Q:</strong> ${inc.question}</p>
                            ${inc.options ? `
                                <div style="margin: 10px 0;">
                                    ${inc.options.map((opt, idx) => `
                                        <p style="padding: 5px; margin: 3px 0; border-radius: 5px; font-size: 0.9rem; 
                                           background: ${idx === inc.correctAnswer ? '#d4edda' : (opt === inc.userAnswer ? '#f8d7da' : '#f9f9f9')};">
                                            ${opt} ${idx === inc.correctAnswer ? '‚úì' : (opt === inc.userAnswer ? '‚úó' : '')}
                                        </p>
                                    `).join('')}
                                </div>
                            ` : `
                                <p style="color: #dc3545; margin-top: 5px;"><strong>Your answer:</strong> ${inc.userAnswer}</p>
                                <p style="color: #28a745; margin-top: 5px;"><strong>Correct:</strong> ${inc.correctDefinition}</p>
                            `}
                        </div>
                    `).join('')}
                </div>
            `;
        }
              

        async function removeIncorrect(id) {
            if (!currentUser) return;

            await db.collection('users').doc(currentUser.uid).collection('incorrectQuestions').doc(id).delete();
            userIncorrect = userIncorrect.filter(inc => inc.id !== id);
            displayIncorrect();
        }

        async function startIncorrectQuiz() {
            const minQuestions = Math.min(userIncorrect.length, 5);
            if (userIncorrect.length < minQuestions) {
                alert(`You need at least ${minQuestions} incorrect answers to generate a practice quiz`);
                return;
            }

            navigateTo('quiz', true);
            document.getElementById('practice-quiz-container').innerHTML = '<div class="loading">üé≤ Generating quiz from your incorrect answers...</div>';

            // Use the exact saved questions with their options
            const selectedIncorrect = [...userIncorrect].sort(() => 0.5 - Math.random()).slice(0, minQuestions);

            const quizQuestions = selectedIncorrect.map(inc => ({
                word: inc.word,
                question: inc.question,
                options: inc.options,
                correctAnswer: inc.correctAnswer,
                correctDefinition: inc.correctDefinition
            }));

            currentQuiz = { questions: quizQuestions };
            currentQuestionIndex = 0;
            quizScore = 0;

            showQuestion('incorrect');
        }

        async function cleanupInvalidFavorites() {
    if (!currentUser) return;
    
    try {
        const snapshot = await db.collection('users').doc(currentUser.uid).collection('favorites').get();
        
        const deletions = [];
        snapshot.docs.forEach(doc => {
            const data = doc.data();
            // Only delete if question is literally "undefined" or missing word
            if (!data.word || data.question === 'undefined') {
                console.log('Deleting invalid favorite:', doc.id);
                deletions.push(doc.ref.delete());
            }
        });
        
        if (deletions.length > 0) {
            await Promise.all(deletions);
            console.log(`Cleaned up ${deletions.length} invalid favorites`);
            // Reload favorites
            await loadUserFavorites(currentUser.uid);
        }
    } catch (error) {
        console.error('Error cleaning up favorites:', error);
    }
}



async function startSpellingPracticeWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection and show loading
    document.getElementById('spelling-level-selection').style.display = 'none';
    const gameContainer = document.getElementById('spelling-game');
    gameContainer.innerHTML = '<div class="loading">üìö Loading ' + level.toUpperCase() + ' words...</div>';
    gameContainer.style.display = 'block';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    // Select 10 random words from the entire level (no difficulty filtering)
    if (allWords.length < 10) {
        alert('Not enough words in this level. Try another level.');
        document.getElementById('spelling-level-selection').style.display = 'block';
        gameContainer.style.display = 'none';
        return;
    }
    
    const shuffled = [...allWords].sort(() => 0.5 - Math.random());
    spellingWords = shuffled.slice(0, 10);
    
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    // Clear the loading message and restore the game UI
    gameContainer.innerHTML = `
        <div class="quiz-question-card">
            <div class="quiz-score" id="spelling-score">Score: 0 / 0</div>
            <h3 id="spelling-progress">Word 1 of 10</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="practice-btn" onclick="speakCurrentSpellingWord()" style="font-size: 0.9rem; padding: 10px 15px;">
                        üîä Play Word
                    </button>
                    <button class="practice-btn" onclick="speakWordInSentence()" style="font-size: 0.9rem; padding: 10px 15px;">
                        üí¨ Use in Sentence
                    </button>
                    <button class="practice-btn" id="show-details-btn" onclick="showSpellingWordDetails()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                        üìñ Word Details
                    </button>
                    <button class="practice-btn" id="add-spelling-favorite-btn" onclick="addCurrentSpellingToFavorites()" style="font-size: 0.9rem; padding: 10px 15px; display: none;">
                        ‚≠ê Add to Favorites
                    </button>
                </div>
                <p style="margin-top: 5px; color: #666; font-style: italic; font-size: 0.9rem;">Listen to the word alone, in a sentence, see details, or add to favorites</p>
            </div>
                            
            <div class="form-group" style="margin: 30px 0;">
                <label style="font-size: 1.2rem;">Type what you hear:</label>
                <input type="text" id="spelling-input" 
                       placeholder="Use the keyboard below..." 
                       style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                       readonly>
            </div>
            
            <!-- Virtual Keyboard -->
            <div class="virtual-keyboard">
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('Q')">Q</button>
                    <button class="keyboard-key" onclick="typeKey('W')">W</button>
                    <button class="keyboard-key" onclick="typeKey('E')">E</button>
                    <button class="keyboard-key" onclick="typeKey('R')">R</button>
                    <button class="keyboard-key" onclick="typeKey('T')">T</button>
                    <button class="keyboard-key" onclick="typeKey('Y')">Y</button>
                    <button class="keyboard-key" onclick="typeKey('U')">U</button>
                    <button class="keyboard-key" onclick="typeKey('I')">I</button>
                    <button class="keyboard-key" onclick="typeKey('O')">O</button>
                    <button class="keyboard-key" onclick="typeKey('P')">P</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('A')">A</button>
                    <button class="keyboard-key" onclick="typeKey('S')">S</button>
                    <button class="keyboard-key" onclick="typeKey('D')">D</button>
                    <button class="keyboard-key" onclick="typeKey('F')">F</button>
                    <button class="keyboard-key" onclick="typeKey('G')">G</button>
                    <button class="keyboard-key" onclick="typeKey('H')">H</button>
                    <button class="keyboard-key" onclick="typeKey('J')">J</button>
                    <button class="keyboard-key" onclick="typeKey('K')">K</button>
                    <button class="keyboard-key" onclick="typeKey('L')">L</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeKey('Z')">Z</button>
                    <button class="keyboard-key" onclick="typeKey('X')">X</button>
                    <button class="keyboard-key" onclick="typeKey('C')">C</button>
                    <button class="keyboard-key" onclick="typeKey('V')">V</button>
                    <button class="keyboard-key" onclick="typeKey('B')">B</button>
                    <button class="keyboard-key" onclick="typeKey('N')">N</button>
                    <button class="keyboard-key" onclick="typeKey('M')">M</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key backspace" onclick="backspaceKey()">‚å´ Delete</button>
                    <button class="keyboard-key space" onclick="typeKey(' ')">Space</button>
                    <button class="keyboard-key enter" onclick="submitSpelling()">‚úì Enter</button>
                </div>
            </div>
                            
            <div style="text-align: center; margin-top: 20px;">
                <button class="practice-btn" onclick="skipSpellingWord()" style="background: #666;">
                    ‚è≠Ô∏è Skip
                </button>
            </div>
                            
            <div id="spelling-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
    
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

function backToSpellingLevelSelection() {
    document.getElementById('spelling-level-selection').style.display = 'block';
    document.getElementById('spelling-game').style.display = 'none';
    document.getElementById('spelling-results').style.display = 'none';
    selectedGameLevel = '';
}

// Keep old function for backwards compatibility
function startSpellingPractice() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    startSpellingPracticeWithLevel(selectedGameLevel);
}
        
        function loadSpellingWord() {
    currentSpellingWord = spellingWords[currentSpellingIndex];
    
    document.getElementById('spelling-progress').textContent = 
        `Word ${currentSpellingIndex + 1} of ${spellingWords.length}`;
    document.getElementById('spelling-score').textContent = 
        `Score: ${spellingScore} / ${currentSpellingIndex}`;
    document.getElementById('spelling-input').value = '';
    document.getElementById('spelling-feedback').innerHTML = '';
    
    // Show favorite button if user is logged in
    const favoriteBtn = document.getElementById('add-spelling-favorite-btn');
    if (favoriteBtn && currentUser) {
        favoriteBtn.style.display = 'inline-block';
    }
    
    // Hide word details button for new word
    const detailsBtn = document.getElementById('show-details-btn');
    if (detailsBtn) {
        detailsBtn.style.display = 'none';
    }
    
    // Re-enable input for new word
    document.getElementById('spelling-input').disabled = false;
    
    // Auto-play the word when loaded
    setTimeout(() => speakCurrentSpellingWord(), 500);
    
    // Focus on input
    document.getElementById('spelling-input').focus();
}
        
       function speakCurrentSpellingWord() {
            if (!currentSpellingWord) return;
            
            const utterance = new SpeechSynthesisUtterance(currentSpellingWord);
            utterance.rate = 0.7; // Slower for spelling
            utterance.pitch = 1;
            utterance.volume = 1;
            
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
            
            // Visual feedback
            const btn = event?.target;
            if (btn) {
                btn.style.transform = 'scale(0.95)';
                setTimeout(() => btn.style.transform = 'scale(1)', 200);
            }
        }

        async function speakWordInSentence() {
    if (!currentSpellingWord) return;
    
    // Show loading state
    const btn = event?.target;
    if (btn) {
        btn.disabled = true;
        btn.textContent = '‚è≥ Loading...';
    }
    
    try {
        // Fetch word definition to get example sentence
        const wordRef = db.collection('dictionary').doc(currentSpellingWord.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let exampleSentence = null;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        exampleSentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        // If no cached example, fetch from API
        if (!exampleSentence) {
            const response = await fetch(CLOUD_FUNCTION_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { word: currentSpellingWord } })
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.result && data.result.meanings && data.result.meanings.length > 0) {
                    for (let meaning of data.result.meanings) {
                        if (meaning.example) {
                            exampleSentence = meaning.example;
                            break;
                        }
                    }
                }
            }
        }
        
        // If still no example, create a simple sentence
        if (!exampleSentence) {
            exampleSentence = `The word is ${currentSpellingWord}.`;
        }
        
        // Use SSML to emphasize the target word with volume
        const targetWord = currentSpellingWord;
        const emphasizedSentence = exampleSentence.replace(
            new RegExp(`\\b${targetWord}\\b`, 'gi'),
            `<emphasis level="strong">${targetWord}</emphasis>`
        );
        
        // Speak the entire sentence at once
        const utterance = new SpeechSynthesisUtterance(exampleSentence);
        utterance.rate = 0.8;
        utterance.pitch = 1;
        utterance.volume = 1;
        
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        // Fallback: just say the word
        const utterance = new SpeechSynthesisUtterance(`The word is ${currentSpellingWord}.`);
        utterance.rate = 0.8;
        window.speechSynthesis.speak(utterance);
    } finally {
        // Reset button
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'üí¨ Use in Sentence';
        }
    }
}
        
       async function showSpellingWordDetails() {
    if (!currentSpellingWord) return;
    
    const feedbackDiv = document.getElementById('spelling-feedback');
    feedbackDiv.innerHTML = '<div class="loading">üìö Loading word details...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentSpellingWord);
        
        feedbackDiv.innerHTML = `
            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #17a2b8; margin-top: 15px;">
                <h3 style="color: #17a2b8; margin-bottom: 15px;">üìñ Word Information</h3>
                
                ${wordDetails.phonetic ? `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #0d3b66;">üîä Pronunciation:</strong>
                        <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                    </div>
                ` : ''}
                
                ${wordDetails.origin ? `
                    <div style="margin-bottom: 15px;">
                        <strong style="color: #0d3b66;">üìú Origin:</strong>
                        <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                    </div>
                ` : ''}
                
                ${wordDetails.definition ? `
                    <div style="margin-bottom: 10px;">
                        <strong style="color: #0d3b66;">üìù Definition:</strong>
                        <p style="color: #333; margin-top: 8px; line-height: 1.6;">${wordDetails.definition}</p>
                    </div>
                ` : ''}
                
                <p style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; color: #0d3b66; font-style: italic; text-align: center;">
                    ‚ö†Ô∏è Remember: Don't use this to cheat! Use it to learn about the word after attempting.
                </p>
            </div>
        `;
    } catch (error) {
        console.error('Error fetching word details:', error);
        feedbackDiv.innerHTML = `
            <div class="feedback error">
                ‚ùå Unable to load word details. Please try again.
            </div>
        `;
    }
}
        function nextSpellingWord() {
    document.getElementById('spelling-input').disabled = false;
    currentSpellingIndex++;
    if (currentSpellingIndex < spellingWords.length) {
        loadSpellingWord();
    } else {
        showSpellingResults();
    }
}
        
   async function submitSpelling() {
    const userAnswer = document.getElementById('spelling-input').value.trim().toLowerCase();
    const correctWord = currentSpellingWord.toLowerCase();
    const feedbackDiv = document.getElementById('spelling-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">‚ö†Ô∏è Please type a word before submitting</div>';
        return;
    }
    
    // Disable input while processing
    document.getElementById('spelling-input').disabled = true;
    
    if (userAnswer === correctWord) {
        spellingScore++;
        
        // Fetch word details to show origin
        feedbackDiv.innerHTML = '<div class="loading">‚úÖ Correct! Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentSpellingWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    ‚úÖ <strong>Correct!</strong> The word is: <strong>${currentSpellingWord}</strong>
                    
                    ${currentUser ? `
                        <button class="practice-btn" onclick="saveSpellingFavorite('${currentSpellingWord}', '${userAnswer}', true)" 
                                style="margin-top: 15px; background: #ffd700; color: #0d3b66;">
                            ‚≠ê Add to Favorites
                        </button>
                    ` : ''}
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üîä Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üìú Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">üìù Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    ‚úÖ Correct! The word is: <strong>${currentSpellingWord}</strong>
                    ${currentUser ? `
                        <button class="practice-btn" onclick="saveSpellingFavorite('${currentSpellingWord}', '${userAnswer}', true)" 
                                style="margin-top: 15px; background: #ffd700; color: #0d3b66;">
                            ‚≠ê Add to Favorites
                        </button>
                    ` : ''}
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        }
    } else {
        // Save incorrect answer automatically
        if (currentUser) {
            await saveSpellingIncorrect(currentSpellingWord, userAnswer);
        }
        
        spellingMistakes.push({
            word: currentSpellingWord,
            userAnswer: userAnswer
        });
        
        // Fetch word details to show origin
        feedbackDiv.innerHTML = '<div class="loading">‚ùå Incorrect. Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentSpellingWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå <strong>Incorrect.</strong> You wrote: <strong>${userAnswer}</strong><br>
                    Correct spelling: <strong>${currentSpellingWord}</strong>
                    
                    ${currentUser ? '<p style="margin-top: 10px; color: #721c24; font-style: italic;">‚úÖ Automatically saved to Spelling Mistakes</p>' : ''}
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üîä Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üìú Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">üìù Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå Incorrect. You wrote: <strong>${userAnswer}</strong><br>
                    Correct spelling: <strong>${currentSpellingWord}</strong>
                    ${currentUser ? '<p style="margin-top: 10px; color: #721c24; font-style: italic;">‚úÖ Automatically saved to Spelling Mistakes</p>' : ''}
                    
                    <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        }
        
        // Speak the correct word again
        setTimeout(() => speakCurrentSpellingWord(), 1000);
    }
    
    // Show the word details button after attempt
    document.getElementById('show-details-btn').style.display = 'inline-block';
}

        
        async function skipSpellingWord() {
    spellingMistakes.push({
        word: currentSpellingWord,
        userAnswer: '(skipped)'
    });
    
    // Disable input while processing
    document.getElementById('spelling-input').disabled = true;
    
    const feedbackDiv = document.getElementById('spelling-feedback');
    feedbackDiv.innerHTML = '<div class="loading">‚è≠Ô∏è Loading word details...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentSpellingWord);
        
        feedbackDiv.innerHTML = `
            <div class="feedback" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
                ‚è≠Ô∏è <strong>Skipped.</strong> The word was: <strong>${currentSpellingWord}</strong>
                
                <div style="margin-top: 15px; padding: 15px; background: #ffe8a1; border-radius: 8px;">
                    ${wordDetails.phonetic ? `
                        <div style="margin-bottom: 10px;">
                            <strong>üîä Pronunciation:</strong>
                            <span style="font-style: italic; margin-left: 8px;">${wordDetails.phonetic}</span>
                        </div>
                    ` : ''}
                    
                    ${wordDetails.origin ? `
                        <div style="margin-bottom: 10px;">
                            <strong>üìú Origin:</strong>
                            <span style="margin-left: 8px;">${wordDetails.origin}</span>
                        </div>
                    ` : ''}
                    
                    ${wordDetails.definition ? `
                        <div>
                            <strong>üìù Definition:</strong>
                            <span style="margin-left: 8px;">${wordDetails.definition}</span>
                        </div>
                    ` : ''}
                </div>
                
                <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    ‚û°Ô∏è Next Word
                </button>
            </div>
        `;
    } catch (error) {
        feedbackDiv.innerHTML = `
            <div class="feedback" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
                ‚è≠Ô∏è Skipped. The word was: <strong>${currentSpellingWord}</strong>
                
                <button class="practice-btn" onclick="nextSpellingWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    ‚û°Ô∏è Next Word
                </button>
            </div>
        `;
    }
    
    speakCurrentSpellingWord();
    
    // Show the word details button after skip
    document.getElementById('show-details-btn').style.display = 'inline-block';
}
        
        
        function showSpellingResults() {
            document.getElementById('spelling-game').style.display = 'none';
            const resultsDiv = document.getElementById('spelling-results');
            resultsDiv.style.display = 'block';
            
            const percentage = Math.round((spellingScore / spellingWords.length) * 100);
            
            let message = '';
            let emoji = '';
            
            if (percentage >= 90) {
                message = 'Outstanding! You\'re a spelling champion!';
                emoji = 'üèÜ';
            } else if (percentage >= 70) {
                message = 'Great job! Keep practicing!';
                emoji = '‚≠ê';
            } else if (percentage >= 50) {
                message = 'Good effort! Practice makes perfect!';
                emoji = 'üëç';
            } else {
                message = 'Keep practicing! You\'ll improve!';
                emoji = 'üìö';
            }
            
            resultsDiv.innerHTML = `
                <div class="quiz-question-card" style="text-align: center;">
                    <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
                    <h2>Spelling Practice Complete!</h2>
                    <div class="quiz-score">Final Score: ${spellingScore} / ${spellingWords.length}</div>
                    <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
                    <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
                    
                    ${spellingMistakes.length > 0 ? `
                        <div style="margin: 30px 0; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                            <h3 style="color: #0d3b66; margin-bottom: 15px;">üìù Words to Review:</h3>
                            <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                                ${spellingMistakes.map(mistake => `
                                    <div style="padding: 10px; margin: 5px 0; background: white; border-left: 3px solid #dc3545; border-radius: 5px;">
                                        <strong>${mistake.word}</strong> 
                                        <span style="color: #666;">- You wrote: ${mistake.userAnswer}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="startSpellingPracticeWithLevel()">üîÑ Practice Again</button>
                    <button class="practice-btn" onclick="backToSpellingLevelSelection()">‚Üê Back to Levels</button>
                    <button class="practice-btn" onclick="navigateTo('home')">üè† Home</button>
                  </div>
                </div>
            `;
        }

        function restartSpellingSection() {
    document.getElementById('spelling-game').style.display = 'none';
    document.getElementById('spelling-results').style.display = 'none';
    document.getElementById('spelling-level-selection').style.display = 'block';
    selectedGameLevel = '';
}

        function switchSpellingMode(mode) {
    // Update active tab
    const tabs = document.querySelectorAll('#spelling-section .quiz-tab');
    tabs.forEach((tab, index) => {
        tab.classList.remove('active');
        if ((mode === 'practice' && index === 0) ||
            (mode === 'unscramble' && index === 1) ||
            (mode === 'live' && index === 2) ||
            (mode === 'leaderboard' && index === 3)) {
            tab.classList.add('active');
        }
    });

    // Update active mode
    document.querySelectorAll('#spelling-section .quiz-mode').forEach(m => {
        m.classList.remove('active');
    });

    if (mode === 'practice') {
        document.getElementById('practice-spelling-mode').classList.add('active');
    } else if (mode === 'unscramble') {
        document.getElementById('unscramble-mode').classList.add('active');
    } else if (mode === 'live') {
        document.getElementById('live-spelling-mode').classList.add('active');
    } else if (mode === 'leaderboard') {
        document.getElementById('leaderboard-spelling-mode').classList.add('active');
    }
}

        // ===== SPELLING FAVORITES FUNCTIONS =====
async function loadUserSpellingFavorites(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('spellingFavorites').get();
        userSpellingFavorites = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displaySpellingFavorites();
        
        const btn = document.getElementById('spellingFavoritesQuizBtn');
        if (btn) {
            btn.disabled = userSpellingFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error loading spelling favorites:', error);
    }
}

async function saveSpellingFavorite(word, userAnswer, wasCorrect) {
    if (!currentUser) return;
    
    try {
        const favoriteRef = db.collection('users').doc(currentUser.uid).collection('spellingFavorites').doc(word);
        
        // Check if already exists
        const existingDoc = await favoriteRef.get();
        if (existingDoc.exists) {
            console.log('Word already in favorites');
            return;
        }
        
        await favoriteRef.set({
            word: word,
            userAnswer: userAnswer || '',
            wasCorrect: wasCorrect,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        userSpellingFavorites.push({
            id: word,
            word: word,
            userAnswer: userAnswer || '',
            wasCorrect: wasCorrect
        });
        
        displaySpellingFavorites();
        
        // Update button state if quiz button exists
        const btn = document.getElementById('spellingFavoritesQuizBtn');
        if (btn) {
            btn.disabled = userSpellingFavorites.length < 5;
        }
    } catch (error) {
        console.error('Error saving spelling favorite:', error);
    }
}

function displaySpellingFavorites() {
    const container = document.getElementById('spelling-favorites-container');
    const btn = document.getElementById('spellingFavoritesQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to save spelling favorites</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userSpellingFavorites.length === 0) {
        container.innerHTML = '<div class="loading">No spelling favorites yet. Star words from spelling practice to add them here!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (btn) {
        btn.disabled = userSpellingFavorites.length < 5;
    }

    container.innerHTML = `
        ${userSpellingFavorites.length < 5 ? `
            <div class="loading">
                You have ${userSpellingFavorites.length} favorite(s). Add at least ${5 - userSpellingFavorites.length} more to generate a quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userSpellingFavorites.map(fav => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeSpellingFavorite('${fav.id}')">√ó</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">üìù ${fav.word}</h3>
                    ${fav.userAnswer && fav.userAnswer !== '' ? `
                    <p style="color: #666; margin: 5px 0;"><strong>Your answer:</strong> ${fav.userAnswer}</p>
                     ` : `
                    <p style="color: #666; margin: 5px 0; font-style: italic;">Added for practice</p>
                    `}
                    <p style="color: ${fav.wasCorrect ? '#28a745' : '#dc3545'}; margin-top: 10px; font-weight: bold;">
                        ${fav.wasCorrect ? '‚úÖ Spelled Correctly' : '‚ùå Needs Practice'}
                    </p>
                </div>
            `).join('')}
        </div>
    `;
}

async function removeSpellingFavorite(id) {
    if (!currentUser) return;

    await db.collection('users').doc(currentUser.uid).collection('spellingFavorites').doc(id).delete();
    userSpellingFavorites = userSpellingFavorites.filter(fav => fav.id !== id);
    displaySpellingFavorites();
}

async function startSpellingFavoritesQuiz() {
    if (userSpellingFavorites.length < 5) {
        alert('You need at least 5 spelling favorites to generate a quiz');
        return;
    }

    navigateTo('spelling', true);
    
    const selected = [...userSpellingFavorites].sort(() => 0.5 - Math.random()).slice(0, Math.min(10, userSpellingFavorites.length));
    
    spellingWords = selected.map(fav => fav.word);
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    document.querySelector('#spelling-container .welcome-section').style.display = 'none';
    document.getElementById('spelling-game').style.display = 'block';
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

// ===== SPELLING INCORRECT FUNCTIONS =====
async function loadUserSpellingIncorrect(userId) {
    try {
        const snapshot = await db.collection('users').doc(userId).collection('spellingIncorrect').get();
        userSpellingIncorrect = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        displaySpellingIncorrect();
        
        const btn = document.getElementById('spellingIncorrectQuizBtn');
        if (btn) {
            btn.disabled = userSpellingIncorrect.length < 5;
        }
    } catch (error) {
        console.error('Error loading spelling incorrect:', error);
    }
}

async function saveSpellingIncorrect(word, userAnswer) {
    if (!currentUser) return;
    
    try {
        const incorrectRef = db.collection('users').doc(currentUser.uid).collection('spellingIncorrect');
        
        await incorrectRef.add({
            word: word,
            userAnswer: userAnswer,
            savedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        userSpellingIncorrect.push({
            word: word,
            userAnswer: userAnswer
        });
        
        displaySpellingIncorrect();
    } catch (error) {
        console.error('Error saving spelling incorrect:', error);
    }
}

function displaySpellingIncorrect() {
    const container = document.getElementById('spelling-incorrect-container');
    const btn = document.getElementById('spellingIncorrectQuizBtn');

    if (!currentUser) {
        container.innerHTML = '<div class="loading">Please sign in to track spelling mistakes</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (userSpellingIncorrect.length === 0) {
        container.innerHTML = '<div class="loading">No spelling mistakes yet. Practice spelling to track your progress!</div>';
        if (btn) btn.disabled = true;
        return;
    }

    if (btn) {
        btn.disabled = userSpellingIncorrect.length < 5;
    }

    container.innerHTML = `
        ${userSpellingIncorrect.length < 5 ? `
            <div class="loading">
                You have ${userSpellingIncorrect.length} mistake(s). Add at least ${5 - userSpellingIncorrect.length} more to generate a practice quiz.
            </div>
        ` : ''}
        <div class="favorites-grid">
            ${userSpellingIncorrect.map((inc, index) => `
                <div class="favorite-card">
                    <button class="delete-btn" onclick="removeSpellingIncorrect('${inc.id || index}')">√ó</button>
                    <h3 style="color: #0d3b66; margin-bottom: 10px;">üìù ${inc.word}</h3>
                    <p style="color: #dc3545; margin: 5px 0;"><strong>Your answer:</strong> ${inc.userAnswer}</p>
                    <p style="color: #28a745; margin-top: 10px;"><strong>Correct spelling:</strong> ${inc.word}</p>
                </div>
            `).join('')}
        </div>
    `;
}

async function removeSpellingIncorrect(id) {
    if (!currentUser) return;

    await db.collection('users').doc(currentUser.uid).collection('spellingIncorrect').doc(id).delete();
    userSpellingIncorrect = userSpellingIncorrect.filter(inc => inc.id !== id);
    displaySpellingIncorrect();
}

async function startSpellingIncorrectQuiz() {
    if (userSpellingIncorrect.length < 5) {
        alert('You need at least 5 spelling mistakes to generate a practice quiz');
        return;
    }

    navigateTo('spelling', true);
    
    const selected = [...userSpellingIncorrect].sort(() => 0.5 - Math.random()).slice(0, Math.min(10, userSpellingIncorrect.length));
    
    spellingWords = selected.map(inc => inc.word);
    currentSpellingIndex = 0;
    spellingScore = 0;
    spellingMistakes = [];
    
    document.querySelector('#spelling-container .welcome-section').style.display = 'none';
    document.getElementById('spelling-game').style.display = 'block';
    document.getElementById('spelling-results').style.display = 'none';
    
    loadSpellingWord();
}

async function addCurrentSpellingToFavorites() {
    if (!currentUser) {
        alert('Please sign in to save favorites');
        return;
    }
    
    if (!currentSpellingWord) return;
    
    const btn = document.getElementById('add-spelling-favorite-btn');
    const originalText = btn.textContent;
    
    btn.textContent = '‚è≥ Saving...';
    btn.disabled = true;
    
    try {
        await saveSpellingFavorite(currentSpellingWord, '', false);
        btn.textContent = '‚úÖ Added!';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
    } catch (error) {
        console.error('Error saving favorite:', error);
        btn.textContent = '‚ùå Failed';
        setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
        }, 2000);
    }
}



        // ===== DASHBOARD FUNCTIONS =====
async function goToUserDashboard() {
    if (!currentUser) {
        showAuthModal();
        return;
    }
    
    // Navigate to dashboard first
    navigateTo('student-dashboard');
    
    // Then load user data (with loading state)
    await loadUserDashboard();
}

async function loadUserDashboard() {
    if (!currentUser) return;
    
    try {
        // Show loading state
        document.getElementById('dashboard-name').textContent = 'Loading...';
        document.getElementById('dashboard-email').textContent = 'Loading...';
        
        // Get user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        // Update dashboard header
        const displayName = userData?.name || currentUser.displayName || 'Student';
        document.getElementById('dashboard-name').textContent = displayName;
        document.getElementById('dashboard-email').textContent = userData?.email || currentUser.email || '';
        
        // Update avatar with Google photo or initials
        const dashboardAvatar = document.getElementById('dashboard-avatar');
        if (currentUser.photoURL) {
            dashboardAvatar.style.backgroundImage = `url(${currentUser.photoURL})`;
            dashboardAvatar.textContent = '';
        } else {
            dashboardAvatar.style.backgroundImage = 'none';
            dashboardAvatar.textContent = displayName.charAt(0).toUpperCase();
        }
        
        // Format join date
        if (userData?.createdAt) {
            const joinDate = userData.createdAt.toDate();
            document.getElementById('dashboard-join-date').textContent = 
                `Member since: ${joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;
            document.getElementById('display-joined').textContent = 
                joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            // Fallback for accounts without createdAt
            document.getElementById('dashboard-join-date').textContent = 'Member since: Recently joined';
            document.getElementById('display-joined').textContent = 'Recently joined';
        }
        
        // Update profile fields
        document.getElementById('display-name').textContent = displayName;
        document.getElementById('edit-name').value = displayName;
        
        document.getElementById('display-email').textContent = userData?.email || currentUser.email || 'N/A';
        
        document.getElementById('display-age').textContent = userData?.age || 'Not specified';
        document.getElementById('edit-age').value = userData?.age || '';
        
        document.getElementById('display-country').textContent = userData?.country || 'Not specified';
        document.getElementById('edit-country').value = userData?.country || '';
        
        document.getElementById('display-usertype').textContent = 
            userData?.userType ? userData.userType.charAt(0).toUpperCase() + userData.userType.slice(1) : 'Student';
        
        // ===== COACH-SPECIFIC RESTRICTIONS =====
        const isCoach = userData?.userType === 'coach';
        
        if (isCoach) {
            // Hide edit button for coaches
            document.getElementById('edit-profile-btn').style.display = 'none';
            
            // Hide delete account option for coaches
            const deleteAccountOption = document.querySelector('.setting-item[onclick="confirmDeleteAccount()"]');
            if (deleteAccountOption) {
                deleteAccountOption.style.display = 'none';
            }
            
            // Hide quiz mistakes and spelling mistakes navigation items for coaches
            const quizMistakesNav = document.querySelector('a[href="#quiz-mistakes"]');
            if (quizMistakesNav) {
                quizMistakesNav.style.display = 'none';
            }
            
            const spellingMistakesNav = document.querySelector('a[href="#spelling-mistakes"]');
            if (spellingMistakesNav) {
                spellingMistakesNav.style.display = 'none';
            }
        } else {
            // Show edit button for non-coaches (students)
            document.getElementById('edit-profile-btn').style.display = 'inline-block';
            
            // Show delete account option for non-coaches
            const deleteAccountOption = document.querySelector('.setting-item[onclick="confirmDeleteAccount()"]');
            if (deleteAccountOption) {
                deleteAccountOption.style.display = 'flex';
            }
            
            // Show quiz mistakes and spelling mistakes navigation items for students
            const quizMistakesNav = document.querySelector('a[href="#quiz-mistakes"]');
            if (quizMistakesNav) {
                quizMistakesNav.style.display = 'flex';
            }
            
            const spellingMistakesNav = document.querySelector('a[href="#spelling-mistakes"]');
            if (spellingMistakesNav) {
                spellingMistakesNav.style.display = 'flex';
            }
        }
        
        // Update stats (wait for them to be loaded)
        setTimeout(() => {
            document.getElementById('stat-quiz-favorites').textContent = userFavorites.length;
            document.getElementById('stat-quiz-incorrect').textContent = userIncorrect.length;
            document.getElementById('stat-spelling-favorites').textContent = userSpellingFavorites.length;
            document.getElementById('stat-spelling-incorrect').textContent = userSpellingIncorrect.length;
        }, 500);
        
    } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('dashboard-name').textContent = 'Error loading profile';
        document.getElementById('dashboard-email').textContent = 'Please try refreshing';
    }
}
        
        // ===== PASSWORD CHANGE FUNCTIONS =====
function showChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.add('active');
    
    // Clear form
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}

function closeChangePasswordModal() {
    document.getElementById('changePasswordModal').classList.remove('active');
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}

async function handleChangePassword(event) {
    event.preventDefault();
    
    if (!currentUser) {
        alert('Please sign in to change password');
        return;
    }
    
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmPassword = document.getElementById('confirm-new-password').value;
    
    const errorDiv = document.getElementById('change-password-error');
    const successDiv = document.getElementById('change-password-success');
    
    // Hide previous messages
    errorDiv.style.display = 'none';
    successDiv.style.display = 'none';
    
    // Validate passwords match
    if (newPassword !== confirmPassword) {
        errorDiv.textContent = 'New passwords do not match!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate new password is different
    if (currentPassword === newPassword) {
        errorDiv.textContent = 'New password must be different from current password!';
        errorDiv.style.display = 'block';
        return;
    }
    
    // Validate password strength
    if (newPassword.length < 6) {
        errorDiv.textContent = 'New password must be at least 6 characters!';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        // Re-authenticate user with current password
        const credential = firebase.auth.EmailAuthProvider.credential(
            currentUser.email,
            currentPassword
        );
        
        await currentUser.reauthenticateWithCredential(credential);
        
        // Update password
        await currentUser.updatePassword(newPassword);
        
        // Success!
        successDiv.textContent = '‚úÖ Password changed successfully!';
        successDiv.style.display = 'block';
        
        // Clear form
        document.getElementById('change-password-form').reset();
        
        // Close modal after 2 seconds
        setTimeout(() => {
            closeChangePasswordModal();
        }, 2000);
        
    } catch (error) {
        console.error('Error changing password:', error);
        
        let errorMessage = 'Failed to change password. ';
        
        if (error.code === 'auth/wrong-password') {
            errorMessage += 'Current password is incorrect.';
        } else if (error.code === 'auth/weak-password') {
            errorMessage += 'New password is too weak.';
        } else if (error.code === 'auth/requires-recent-login') {
            errorMessage += 'Please sign out and sign in again, then try changing your password.';
        } else {
            errorMessage += error.message;
        }
        
        errorDiv.textContent = errorMessage;
        errorDiv.style.display = 'block';
    }
}

// Special handling for Google sign-in users
async function handlePasswordChangeForGoogleUsers() {
    if (currentUser && currentUser.providerData.length > 0) {
        const provider = currentUser.providerData[0].providerId;
        
        if (provider === 'google.com') {
            alert('You signed in with Google. To change your password, please go to your Google Account settings.');
            return true; // Indicates Google user
        }
    }
    return false; // Not a Google user
}

// Update showChangePasswordModal to check for Google users
function showChangePasswordModal() {
    // Check if user signed in with Google
    if (currentUser && currentUser.providerData.length > 0) {
        const provider = currentUser.providerData[0].providerId;
        
        if (provider === 'google.com') {
            alert('üîê You signed in with Google.\n\nTo change your password, please visit:\nhttps://myaccount.google.com/security');
            return;
        }
    }
    
    document.getElementById('changePasswordModal').classList.add('active');
    
    // Clear form
    document.getElementById('change-password-form').reset();
    document.getElementById('change-password-error').style.display = 'none';
    document.getElementById('change-password-success').style.display = 'none';
}
        
async function toggleEditMode() {
    // Check if user is a coach
    if (currentUser) {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData?.userType === 'coach') {
                alert('üõ°Ô∏è Coach profiles cannot be edited.\n\nFor security reasons, coach account information is locked after ID verification.\n\nPlease contact support if you need to update your information.');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // Hide display elements, show edit inputs (for students only)
    document.getElementById('display-name').style.display = 'none';
    document.getElementById('edit-name').style.display = 'block';
    
    document.getElementById('display-age').style.display = 'none';
    document.getElementById('edit-age').style.display = 'block';
    
    document.getElementById('display-country').style.display = 'none';
    document.getElementById('edit-country').style.display = 'block';
    
    // Toggle buttons
    document.getElementById('edit-profile-btn').style.display = 'none';
    document.getElementById('save-profile-btn').style.display = 'inline-block';
    document.getElementById('cancel-edit-btn').style.display = 'inline-block';
}

function cancelEditMode() {
    // Show display elements, hide edit inputs
    document.getElementById('display-name').style.display = 'inline';
    document.getElementById('edit-name').style.display = 'none';
    
    document.getElementById('display-age').style.display = 'inline';
    document.getElementById('edit-age').style.display = 'none';
    
    document.getElementById('display-country').style.display = 'inline';
    document.getElementById('edit-country').style.display = 'none';
    
    // Toggle buttons
    document.getElementById('edit-profile-btn').style.display = 'inline-block';
    document.getElementById('save-profile-btn').style.display = 'none';
    document.getElementById('cancel-edit-btn').style.display = 'none';
    
    document.getElementById('profile-form').classList.remove('edit-mode');
}

async function saveProfile() {
    if (!currentUser) return;
    
    const newName = document.getElementById('edit-name').value.trim();
    const newAge = document.getElementById('edit-age').value;
    const newCountry = document.getElementById('edit-country').value;
    
    if (!newName) {
        alert('Name cannot be empty');
        return;
    }
    
    try {
        // Update Firestore
        await db.collection('users').doc(currentUser.uid).update({
            name: newName,
            age: newAge,
            country: newCountry
        });
        
        // Update Firebase Auth profile
        await currentUser.updateProfile({ displayName: newName });
        
        // Update UI
        document.getElementById('display-name').textContent = newName;
        document.getElementById('display-age').textContent = newAge;
        document.getElementById('display-country').textContent = newCountry;
        
        document.getElementById('dashboard-student-name').textContent = newName;
        document.getElementById('dashboard-name').textContent = newName;
        document.getElementById('dashboard-avatar').textContent = newName.charAt(0).toUpperCase();
        
        // Update sidebar
        document.getElementById('sidebarUserName').textContent = newName;
        document.getElementById('sidebarUserAvatar').textContent = newName.charAt(0).toUpperCase();
        
        cancelEditMode();
        alert('Profile updated successfully!');
    } catch (error) {
        console.error('Error updating profile:', error);
        alert('Failed to update profile: ' + error.message);
    }
}


        function showChangePasswordModal() {
    alert('Change password feature coming soon! For now, you can reset your password using the "Forgot Password" link on the sign-in page.');
}

async function confirmDeleteAccount() {
    if (!currentUser) return;
    
    // Check if user is a coach
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData?.userType === 'coach') {
            alert('üõ°Ô∏è Coach accounts cannot be deleted.\n\nFor security and compliance reasons, coach accounts must be deactivated by an administrator.\n\nPlease contact support if you need to deactivate your account.');
            return;
        }
    } catch (error) {
        console.error('Error checking user type:', error);
    }
    
    // Proceed with deletion for non-coach users
    if (confirm('‚ö†Ô∏è WARNING: This will permanently delete your account and all your data. This action cannot be undone.\n\nAre you absolutely sure?')) {
        if (confirm('Final confirmation: Delete your account forever?')) {
            deleteUserAccount();
        }
    }
}

async function deleteUserAccount() {
    if (!currentUser) return;
    
    try {
        // Delete user data from Firestore
        await db.collection('users').doc(currentUser.uid).delete();
        
        // Delete user subcollections
        const collections = ['favorites', 'incorrectQuestions', 'spellingFavorites', 'spellingIncorrect'];
        for (const collection of collections) {
            const snapshot = await db.collection('users').doc(currentUser.uid).collection(collection).get();
            const deletePromises = snapshot.docs.map(doc => doc.ref.delete());
            await Promise.all(deletePromises);
        }
        
        // Delete Firebase Auth account
        await currentUser.delete();
        
        alert('Your account has been successfully deleted.');
        navigateTo('home');
    } catch (error) {
        console.error('Error deleting account:', error);
        alert('Failed to delete account: ' + error.message);
    }
}

     function typeKey(letter) {
    const input = document.getElementById('spelling-input');
    if (input.disabled) return;
    input.value += letter.toLowerCase();
}

function backspaceKey() {
    const input = document.getElementById('spelling-input');
    if (input.disabled) return;
    input.value = input.value.slice(0, -1);
}  

// ===== UNSCRAMBLE FUNCTIONS =====
async function startUnscrambleWithLevel(level) {
    selectedGameLevel = level;
    
    // Hide level selection and show loading
    document.getElementById('unscramble-level-selection').style.display = 'none';
    const gameContainer = document.getElementById('unscramble-game');
    gameContainer.innerHTML = '<div class="loading">üìö Loading ' + level.toUpperCase() + ' words...</div>';
    gameContainer.style.display = 'block';
    
    // Load level words if not already loaded
    if (levelWords[level].length === 0) {
        await loadLevelWords(level);
    } else {
        allWords = levelWords[level];
    }
    
    // Select 10 random words from the entire level (no difficulty filtering)
    if (allWords.length < 10) {
        alert('Not enough words in this level. Try another level.');
        document.getElementById('unscramble-level-selection').style.display = 'block';
        gameContainer.style.display = 'none';
        return;
    }
    
    const shuffled = [...allWords].sort(() => 0.5 - Math.random());
    unscrambleWords = shuffled.slice(0, 10);
    
    currentUnscrambleIndex = 0;
    unscrambleScore = 0;
    hintsUsed = 0;
    
    // Clear the loading message and restore the game UI
    gameContainer.innerHTML = `
        <div class="quiz-question-card">
            <div class="quiz-score" id="unscramble-score">Score: 0 / 0</div>
            <h3 id="unscramble-progress">Word 1 of 10</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                
                <div id="letter-tiles" class="letter-tiles-container">
                    <!-- Letter tiles will be inserted here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="shuffleLetters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                        üîÄ Shuffle
                    </button>
                    
                    <button class="practice-btn" onclick="showUnscrambleHint()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px; background: #17a2b8;">
                        üí° Hint
                    </button>
                    
                    <button class="practice-btn" onclick="submitUnscramble()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ‚úì Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="unscramble-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
    
    document.getElementById('unscramble-results').style.display = 'none';
    
    loadUnscrambleWord();
}
function backToUnscrambleLevelSelection() {
    document.getElementById('unscramble-level-selection').style.display = 'block';
    document.getElementById('unscramble-game').style.display = 'none';
    document.getElementById('unscramble-results').style.display = 'none';
    selectedGameLevel = '';
}

// Keep old function for backwards compatibility
function startUnscramble() {
    if (!selectedGameLevel) {
        alert('Please select a level first');
        return;
    }
    startUnscrambleWithLevel(selectedGameLevel);
}
        
function loadUnscrambleWord() {
    currentUnscrambleWord = unscrambleWords[currentUnscrambleIndex];
    hintsUsed = 0;
    
    document.getElementById('unscramble-progress').textContent = 
        `Word ${currentUnscrambleIndex + 1} of ${unscrambleWords.length}`;
    document.getElementById('unscramble-score').textContent = 
        `Score: ${unscrambleScore} / ${currentUnscrambleIndex}`;
    document.getElementById('unscramble-feedback').innerHTML = '';
    
    // Scramble and display letters
    shuffleLetters();
}

function shuffleLetters() {
    const letters = currentUnscrambleWord.split('');
    let scrambled = [...letters];
    
    // Shuffle the array
    let attempts = 0;
    do {
        for (let i = scrambled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
        }
        attempts++;
    } while (scrambled.join('') === currentUnscrambleWord && attempts < 10);
    
    currentLetterOrder = scrambled;
    renderLetterTiles();
}

function renderLetterTiles() {
    const container = document.getElementById('letter-tiles');
    container.innerHTML = '';
    
    currentLetterOrder.forEach((letter, index) => {
        const tile = document.createElement('div');
        tile.className = 'letter-tile';
        tile.textContent = letter.toUpperCase();
        tile.draggable = true;
        tile.dataset.index = index;
        
        // Drag events
        tile.addEventListener('dragstart', handleDragStart);
        tile.addEventListener('dragend', handleDragEnd);
        tile.addEventListener('dragover', handleDragOver);
        tile.addEventListener('drop', handleDrop);
        tile.addEventListener('dragenter', handleDragEnter);
        tile.addEventListener('dragleave', handleDragLeave);
        
        // Touch events for mobile
        tile.addEventListener('touchstart', handleTouchStart, { passive: false });
        tile.addEventListener('touchmove', handleTouchMove, { passive: false });
        tile.addEventListener('touchend', handleTouchEnd);
        
        container.appendChild(tile);
    });
}

function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    
    // Remove drag-over class from all tiles
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleDragEnter(e) {
    if (this !== draggedElement) {
        this.classList.add('drag-over');
    }
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}

function handleDrop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    this.classList.remove('drag-over');
    
    if (draggedElement !== this) {
        const draggedIndex = parseInt(draggedElement.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        
        // Swap letters in the array
        [currentLetterOrder[draggedIndex], currentLetterOrder[targetIndex]] = 
        [currentLetterOrder[targetIndex], currentLetterOrder[draggedIndex]];
        
        // Re-render
        renderLetterTiles();
    }
    
    return false;
}

// Touch support for mobile
let touchTarget = null;
let touchClone = null;

function handleTouchStart(e) {
    e.preventDefault();
    touchTarget = this;
    this.classList.add('dragging');
    
    // Create a clone for visual feedback
    touchClone = this.cloneNode(true);
    touchClone.style.position = 'fixed';
    touchClone.style.zIndex = '10000';
    touchClone.style.pointerEvents = 'none';
    touchClone.style.opacity = '0.8';
    document.body.appendChild(touchClone);
    
    updateTouchClonePosition(e.touches[0]);
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!touchTarget) return;
    
    updateTouchClonePosition(e.touches[0]);
    
    // Find element under touch
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    // Remove drag-over from all
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    // Add drag-over to element below
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== touchTarget) {
        elementBelow.classList.add('drag-over');
    }
}

function handleTouchEnd(e) {
    e.preventDefault();
    if (!touchTarget) return;
    
    touchTarget.classList.remove('dragging');
    
    // Remove clone
    if (touchClone) {
        touchClone.remove();
        touchClone = null;
    }
    
    // Find element under touch
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== touchTarget) {
        const draggedIndex = parseInt(touchTarget.dataset.index);
        const targetIndex = parseInt(elementBelow.dataset.index);
        
        // Swap letters
        [currentLetterOrder[draggedIndex], currentLetterOrder[targetIndex]] = 
        [currentLetterOrder[targetIndex], currentLetterOrder[draggedIndex]];
        
        // Re-render
        renderLetterTiles();
    }
    
    // Remove drag-over from all
    document.querySelectorAll('.letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    touchTarget = null;
}

function updateTouchClonePosition(touch) {
    if (touchClone) {
        touchClone.style.left = (touch.clientX - 30) + 'px';
        touchClone.style.top = (touch.clientY - 30) + 'px';
    }
}

async function showUnscrambleHint() {
    hintsUsed++;
    const feedbackDiv = document.getElementById('unscramble-feedback');
    
    feedbackDiv.innerHTML = '<div class="loading">üí° Loading hint...</div>';
    
    try {
        const wordDetails = await fetchWordDetails(currentUnscrambleWord);
        
        let hintText = '';
        if (hintsUsed === 1) {
            // First hint: Show first letter
            hintText = `The word starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else if (hintsUsed === 2) {
            // Second hint: Show word length and first letter
            hintText = `The word has <strong>${currentUnscrambleWord.length} letters</strong> and starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else {
            // Third hint: Show definition
            hintText = `<strong>Definition:</strong> ${wordDetails.definition || 'A word you should know!'}`;
        }
        
        feedbackDiv.innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">üí° Hint ${hintsUsed}:</strong>
                <p style="color: #856404; margin-top: 8px;">${hintText}</p>
            </div>
        `;
    } catch (error) {
        console.error('Error showing hint:', error);
        let hintText = '';
        if (hintsUsed === 1) {
            hintText = `The word starts with: <strong>${currentUnscrambleWord.charAt(0).toUpperCase()}</strong>`;
        } else {
            hintText = `The word has <strong>${currentUnscrambleWord.length} letters</strong>`;
        }
        
        feedbackDiv.innerHTML = `
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107;">
                <strong style="color: #856404;">üí° Hint:</strong>
                <p style="color: #856404; margin-top: 8px;">${hintText}</p>
            </div>
        `;
    }
}

async function submitUnscramble() {
    const userWord = currentLetterOrder.join('').toLowerCase();
    const correctWord = currentUnscrambleWord.toLowerCase();
    const feedbackDiv = document.getElementById('unscramble-feedback');
    
    if (userWord === correctWord) {
        unscrambleScore++;
        
        feedbackDiv.innerHTML = '<div class="loading">‚úÖ Correct! Loading word details...</div>';
        
        try {
            const wordDetails = await fetchWordDetails(currentUnscrambleWord);
            
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    ‚úÖ <strong>Correct!</strong> The word is: <strong>${currentUnscrambleWord}</strong>
                    
                    <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                        ${wordDetails.phonetic ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üîä Pronunciation:</strong>
                                <span style="font-style: italic; color: #666; margin-left: 8px;">${wordDetails.phonetic}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.origin ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #0d3b66;">üìú Origin:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.origin}</span>
                            </div>
                        ` : ''}
                        
                        ${wordDetails.definition ? `
                            <div>
                                <strong style="color: #0d3b66;">üìù Definition:</strong>
                                <span style="color: #666; margin-left: 8px;">${wordDetails.definition}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        } catch (error) {
            feedbackDiv.innerHTML = `
                <div class="feedback success">
                    ‚úÖ <strong>Correct!</strong> The word is: <strong>${currentUnscrambleWord}</strong>
                    
                    <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                        ‚û°Ô∏è Next Word
                    </button>
                </div>
            `;
        }
    } else {
        feedbackDiv.innerHTML = `
            <div class="feedback error">
                ‚ùå <strong>Incorrect.</strong> The correct word is: <strong>${correctWord.toUpperCase()}</strong>
                <p style="margin-top: 10px;">Your answer: <strong>${userWord.toUpperCase()}</strong></p>
                
                <button class="practice-btn" onclick="nextUnscrambleWord()" style="margin-top: 15px; font-size: 1.1rem;">
                    ‚û°Ô∏è Next Word
                </button>
            </div>
        `;
    }
}

        
function nextUnscrambleWord() {
    currentUnscrambleIndex++;
    if (currentUnscrambleIndex < unscrambleWords.length) {
        loadUnscrambleWord();
    } else {
        showUnscrambleResults();
    }
}

function showUnscrambleResults() {
    document.getElementById('unscramble-game').style.display = 'none';
    const resultsDiv = document.getElementById('unscramble-results');
    resultsDiv.style.display = 'block';
    
    const percentage = Math.round((unscrambleScore / unscrambleWords.length) * 100);
    
    let message = '';
    let emoji = '';
    
    if (percentage >= 90) {
        message = 'Outstanding! You\'re a word master!';
        emoji = 'üèÜ';
    } else if (percentage >= 70) {
        message = 'Great job! Keep it up!';
        emoji = '‚≠ê';
    } else if (percentage >= 50) {
        message = 'Good effort! Practice makes perfect!';
        emoji = 'üëç';
    } else {
        message = 'Keep practicing! You\'ll improve!';
        emoji = 'üìö';
    }
    
    resultsDiv.innerHTML = `
        <div class="quiz-question-card" style="text-align: center;">
            <div style="font-size: 4rem; margin: 20px 0;">${emoji}</div>
            <h2>Unscramble Complete!</h2>
            <div class="quiz-score">Final Score: ${unscrambleScore} / ${unscrambleWords.length}</div>
            <p style="font-size: 1.5rem; margin: 20px 0; color: #0d3b66;">${percentage}%</p>
            <p style="font-size: 1.2rem; margin: 20px 0;">${message}</p>
            
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
            <button class="practice-btn" onclick="startUnscrambleWithLevel()">üîÑ Try Again</button>
            <button class="practice-btn" onclick="backToUnscrambleLevelSelection()">‚Üê Back to Levels</button>
            <button class="practice-btn" onclick="navigateTo('home')">üè† Home</button>
           </div>
        </div>
    `;
}

function restartUnscrambleSection() {
    document.getElementById('unscramble-game').style.display = 'none';
    document.getElementById('unscramble-results').style.display = 'none';
    document.getElementById('unscramble-level-selection').style.display = 'block';
    selectedGameLevel = '';
}

   // ===== COACHES DISPLAY FUNCTIONS =====
async function loadAndDisplayCoaches() {
    const container = document.getElementById('coaches-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading coaches...</div>';
        
        console.log('üîç Fetching coaches from Firestore...');
        
        // Fetch all coaches from Firestore
        const coachesSnapshot = await db.collection('users')
            .where('userType', '==', 'coach')
            .get();
        
        console.log('üìä Found coaches:', coachesSnapshot.size);
        
        if (coachesSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üë®‚Äçüè´</div>
                    <h3>No coaches registered yet</h3>
                    <p>Be the first to join as a coach!</p>
                </div>
            `;
            return;
        }
        
        const coaches = [];
        coachesSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Coach:', doc.id, data.name, data.photoURL);
            coaches.push({ id: doc.id, ...data });
        });
        
        // Sort coaches (newest first)
        coaches.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate stats
        const totalCoaches = coaches.length;
        const verifiedCoaches = coaches.filter(c => c.idVerified).length;
        const pendingCoaches = totalCoaches - verifiedCoaches;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Cards -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalCoaches}</div>
                    <div class="stat-label">Total Coaches</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${verifiedCoaches}</div>
                    <div class="stat-label">‚úÖ Verified</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${pendingCoaches}</div>
                    <div class="stat-label">‚è≥ Pending</div>
                </div>
            </div>
            
            <!-- Coaches Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üë®‚Äçüè´ Coach</th>
                            <th>‚úÖ Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => {
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (coach.photoURL) {
                                avatarStyle = `style="background-image: url('${coach.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (coach.name || 'C').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showCoachDetailById('${coach.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${coach.name || 'Unknown Coach'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        ${coach.idVerified ? 
                                            '<span class="verified-badge">‚úÖ Verified</span>' : 
                                            '<span class="unverified-badge">‚è≥ Pending</span>'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">üõ°Ô∏è Safety & Verification</h3>
                <p style="color: #666; line-height: 1.6;">
                    All coaches on WordBiz Coaching Academy undergo ID verification for student safety. 
                    Click on any coach to view their full profile and verification details.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading coaches:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading coaches. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayCoaches()">üîÑ Retry</button>
            </div>
        `;
    }
}

// Load and show coach profile modal
async function showCoachDetailById(coachId) {
    try {
        console.log('üìã Loading coach details for:', coachId);
        const coachDoc = await db.collection('users').doc(coachId).get();
        
        if (coachDoc.exists) {
            const coach = { id: coachDoc.id, ...coachDoc.data() };
            console.log('‚úÖ Coach data loaded:', coach);
            showCoachDetail(coach);
        } else {
            console.error('‚ùå Coach not found');
            alert('Coach profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading coach details:', error);
        alert('Unable to load coach details: ' + error.message);
    }
}

// Display coach detail modal
function showCoachDetail(coach) {
    console.log('üé® Displaying coach modal:', coach.name);
    const modal = document.getElementById('coachDetailModal');
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-coach-avatar');
    if (coach.photoURL) {
        console.log('üñºÔ∏è Setting photo URL:', coach.photoURL);
        avatar.style.backgroundImage = `url('${coach.photoURL}')`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.textContent = '';
    } else {
        console.log('üìù No photo URL, using initial');
        avatar.style.backgroundImage = 'none';
        avatar.textContent = (coach.name || 'C').charAt(0).toUpperCase();
    }
    
    // Update name
    document.getElementById('modal-coach-name').textContent = coach.name || 'Unknown Coach';
    
    // Update status badge
    const statusBadge = document.getElementById('modal-coach-status');
    if (coach.idVerified) {
        statusBadge.className = 'status-badge verified';
        statusBadge.textContent = '‚úÖ Verified';
    } else {
        statusBadge.className = 'status-badge pending';
        statusBadge.textContent = '‚è≥ Pending Verification';
    }
    
    // Update email
    document.getElementById('modal-coach-email').textContent = coach.email || 'N/A';
    
    // Update organization
    document.getElementById('modal-coach-organization').textContent = coach.organization || 'Independent';
    
    // Update joined date
    if (coach.createdAt) {
        const joinDate = coach.createdAt.toDate();
        document.getElementById('modal-coach-joined').textContent = 
            joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } else {
        document.getElementById('modal-coach-joined').textContent = 'Recently';
    }
    
    // Update verification info
    if (coach.idVerified) {
        const verificationText = coach.idDocumentType ? 
            `ID Verified (${coach.idDocumentType})` : 
            'ID Verified';
        document.getElementById('modal-coach-verification').textContent = verificationText;
    } else {
        document.getElementById('modal-coach-verification').textContent = 'Pending Verification';
    }
    
    // Show/hide age if available
    const ageRow = document.getElementById('modal-coach-age-row');
    if (coach.verifiedAge) {
        ageRow.style.display = 'flex';
        document.getElementById('modal-coach-age').textContent = coach.verifiedAge + ' years old';
    } else {
        ageRow.style.display = 'none';
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('‚úÖ Modal displayed');
}

// Close coach detail modal
function closeCoachDetailModal() {
    document.getElementById('coachDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('coachDetailModal');
    if (event.target === modal) {
        closeCoachDetailModal();
    }
});

     // ===== ONE-TIME MIGRATION: Update existing users with photoURL =====
async function migrateUserPhotoURLs() {
    console.log('üîÑ Starting photoURL migration...');
    
    try {
        // Get all users from Firestore
        const usersSnapshot = await db.collection('users').get();
        
        let updated = 0;
        let skipped = 0;
        let errors = 0;
        
        const updatePromises = [];
        
        usersSnapshot.forEach(doc => {
            const userId = doc.id;
            const userData = doc.data();
            
            // Check if user already has photoURL in Firestore
            if (userData.photoURL) {
                console.log(`‚è≠Ô∏è Skipping ${userData.name} - already has photoURL`);
                skipped++;
                return;
            }
            
            // Get the user from Firebase Auth
            const updatePromise = auth.app.firestore().collection('users').doc(userId).get()
                .then(() => {
                    // We need to get photoURL from Firebase Auth
                    // Since we can't directly access other users' auth data from client,
                    // we'll update when they next sign in
                    console.log(`üìù Marked ${userData.name} for update on next sign-in`);
                });
            
            updatePromises.push(updatePromise);
        });
        
        await Promise.all(updatePromises);
        
        console.log(`‚úÖ Migration complete: ${updated} updated, ${skipped} skipped, ${errors} errors`);
        alert(`Migration complete!\nUpdated: ${updated}\nSkipped: ${skipped}\nErrors: ${errors}`);
        
    } catch (error) {
        console.error('‚ùå Migration error:', error);
        alert('Migration failed: ' + error.message);
    }
}   
    </script>
</body>
</html>
