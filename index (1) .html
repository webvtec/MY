 <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">
        <div class="sidebar-user-info" id="sidebarUserInfo">
            <div class="user-avatar" id="sidebarUserAvatar" style="background-image: none; background-size: cover; background-position: center;">?</div>
            <span id="sidebarUserName">Guest</span>
            <button class="my-profile-btn" id="myProfileBtn" onclick="goToUserDashboard()" style="display: none;">
                üë§ MY PROFILE
            </button>
        </div>
    </div>
    <div class="sidebar-item sidebar-item-home" onclick="navigateTo('home')">HOME</div>
    <div class="sidebar-item" onclick="navigateTo('word-database')">WORD DATABASE</div>
    <div class="sidebar-item" onclick="navigateTo('coaches')">BOOK COACHES</div>
    <div class="sidebar-item" onclick="navigateTo('students')">OUR STUDENTS</div>
    <div class="sidebar-item" onclick="()">CONTACT US</div>
    <div class="sidebar-item" onclick="navigateTo('about')">ABOUT US</div>
    <div class="sidebar-item" id="admin-nav-link" onclick="navigateTo('admin')" style="display: none;">ADMIN PANEL</div>
    <div class="sidebar-item sign-in" id="sidebar-signin" onclick="showAuthModal()">SIGN IN</div>
    <div class="sidebar-item" id="sidebar-signout" style="display:none;" onclick="signOut()">SIGN OUT</div>
</div>
</div>


    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        
// ===== PAYPAL CONFIGURATION =====
const PAYPAL_HANDLER_URL = 'https://verificationpaypalpayment-998744778737.us-central1.run.app';
const REOPEN_ACCOUNT_COST = 6.50;
const REOPEN_DAYS = 30;

let paypalButtonRendered = false;
let sponsorPaypalRendered = false;
let currentChildData = null;

        

        let paypalSDKLoaded = false;

async function loadPayPalSDK() {
    if (paypalSDKLoaded) {
        return Promise.resolve();
    }
    
    try {
        // Get client ID from Firebase function
        const response = await fetch(`${PAYPAL_HANDLER_URL}?action=getClientId`);
        const data = await response.json();
        
        if (!data.success || !data.clientId) {
            throw new Error('Failed to get PayPal client ID');
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${data.clientId}&currency=USD&locale=en_US`;
            script.async = true;
            
            script.onload = () => {
                paypalSDKLoaded = true;
                console.log('‚úÖ PayPal SDK loaded');
                resolve();
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load PayPal SDK'));
            };
            
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading PayPal SDK:', error);
        throw error;
    }
}
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // ‚úÖ NEW: Track declined challenges
let presenceInitialized = false; // ‚úÖ NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// ‚úÖ Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;


// ===== TOURNAMENT VARIABLES =====
let currentTournament = null;
let tournamentStage = 0;
let stage1Questions = [];
let stage1CurrentIndex = 0;
let stage1Score = 0;
let stage1Errors = 0;
let stage1Handicaps = 2;
let stage1TimeLeft = 600; // 10 minutes in seconds
let stage1Timer = null;

// ===== STAGE 2: AI AUDIO SPELLING =====
let stage2Words = [];
let stage2CurrentIndex = 0;
let stage2Score = 0;
let stage2Errors = 0;
let stage2TimeLeft = 900; // 15 minutes
let stage2Timer = null;
let stage2HandicapsRemaining = 1; // Base 1 + carried from Stage 1

// ===== TOURNAMENT STAGE 3 FUNCTIONS =====
let stage3Words = [];
let stage3CurrentIndex = 0;
let stage3Score = 0;
let stage3Errors = 0;
let stage3TimeLeft = 900; // 15 minutes
let stage3Timer = null;
let stage3HandicapsRemaining = 0;
let stage3CurrentLetterOrder = [];
let stage3DraggedElement = null;

// ===== LIVE STAGES 4-7 VARIABLES =====
let stage4RoomId = null;
let stage5RoomId = null;
let stage6RoomId = null;
let stage7RoomId = null;
let currentStageRoom = null;
let stageRoomListener = null;


// ===== LIVE ROOM VARIABLES =====
let localStream = null;
let liveRoomParticipants = new Map(); // userId -> {name, email, schoolId, stream, audioEnabled, videoEnabled}
let liveRoomListener = null;
let myAudioEnabled = true;
let myVideoEnabled = true;


// ===== AUTO-ELIMINATION VARIABLES =====
let stage3CompletionChecker = null;
const STAGE3_CUTOFF_TIME = 15 * 60 * 1000; // 15 minutes to complete Stage 3
const STAGE3_ELIMINATION_DELAY = 2 * 60 * 1000; // Wait 2 minutes after first completion before eliminating
let stage3FirstCompletionTime = null;


   // ===== CLASS SYSTEM VARIABLES =====
let myClass = null;
let classStudents = [];
let classAnnouncements = [];


// ===== LIVE SESSION VARIABLES =====
let liveSessionActive = false;
let liveSessionId = null;
let liveSessionListener = null;
let myPeerConnection = null;
let localAudioStream = null;
let peerConnections = new Map(); // userId -> RTCPeerConnection
let remoteStreams = new Map(); // userId -> MediaStream
let isMicMuted = false;
let sessionParticipants = new Map(); // userId -> {name, email, photoURL}
let isCoach = false; // Track if current user is coach
let coachMutedMe = false; // ‚úÖ NEW: Track if coach has muted this student

        
// ===== ICE CANDIDATE QUEUE =====
const pendingIceCandidates = new Map(); // userId -> [candidates]
        
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // ‚úÖ Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // ‚úÖ ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // √¢≈ì‚Ä¶ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });



   auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        console.log('üë§ User signed in:', user.email);
        console.log('üñºÔ∏è Auth photoURL:', user.photoURL);
        
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        console.log('üìÑ Firestore photoURL:', userData.photoURL);
        
        if (user.photoURL && !userData.photoURL) {
            console.log('üìÑ Syncing photoURL to Firestore...');
            await userRef.update({
                photoURL: user.photoURL
            });
            console.log('‚úÖ PhotoURL synced!');
        }
        
        // ‚úÖ INITIALIZE SPELLING STATS IF NOT EXISTS
        if (!userData.spellingStats) {
            console.log('üìÑ Initializing spelling stats...');
            await userRef.update({
                spellingStats: {
                    totalChallenges: 0,
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    winStreak: 0,
                    bestStreak: 0
                }
            });
            console.log('‚úÖ Spelling stats initialized!');
        }
        
        // ‚úÖ CHECK ADMIN STATUS HERE (CRITICAL - RIGHT AFTER USER DATA IS LOADED)
        await checkAdminStatus();
        
        // ‚úÖ ADD MY CLASS BUTTON
        const myClassBtn = document.getElementById('myClassBtn');
        if (!myClassBtn) {
            const classBtn = document.createElement('button');
            classBtn.id = 'myClassBtn';
            classBtn.className = 'my-profile-btn';
            classBtn.style.cssText = 'display: none; margin-top: 10px;';
            classBtn.onclick = () => {
                navigateTo('class');
                loadMyClass();
            };
            
            const sidebarUserInfo = document.getElementById('sidebarUserInfo');
            sidebarUserInfo.appendChild(classBtn);
        }
        
        try {
            if (userData && (userData.userType === 'student' || userData.userType === 'coach')) {
                document.getElementById('myClassBtn').innerHTML = 'üìö MY CLASS';
                document.getElementById('myClassBtn').style.display = 'block';
            }
        } catch (error) {
            console.error('Error checking class status:', error);
        }
        
        // ‚úÖ CHECK USER TYPE AND HANDLE ACCORDINGLY
        if (userData.userType === 'parent') {
            // Parent user - no profile completion needed
            if (!userData.profileComplete) {
                await userRef.update({ profileComplete: true });
            }
            updateUIForAuthenticatedUser(user);
            
            // Navigate to parent dashboard
            navigateTo('parent-dashboard');
            return;
        }
        
        // STUDENT/COACH HANDLING
        if (!userData.profileComplete) {
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // ‚úÖ LOAD USER COINS (for students only)
        if (userData.userType === 'student') {
            await loadUserCoins(user.uid);
            await checkSubscriptionStatus();
        }
        
        await cleanupInvalidFavorites();
        
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // ‚úÖ Initialize presence immediately on login (only for students/coaches)
        if (userData.userType !== 'parent') {
            await initializeOnlinePresence();
        }
        
        // Load appropriate dashboard
        if (userData.userType === 'student') {
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        }
    } else {
        currentUser = null;
        isAdmin = false;
        
        // ‚úÖ Clean up tournament listeners
        if (tournamentListeners) {
            tournamentListeners.forEach(unsubscribe => unsubscribe());
            tournamentListeners = [];
        }
        
        updateUIForGuestUser();
        updateAdminUI();
    }
});
    });
        
        
    
// ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // ‚úÖ CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'parent-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // ‚úÖ ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard' || section === 'parent-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // ‚úÖ PREVENT PARENTS FROM ACCESSING STUDENT FEATURES
    if (currentUser && section !== 'parent-dashboard' && section !== 'home' && section !== 'about' && section !== 'coaches' && section !== 'students') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'parent') {
                alert('‚ö†Ô∏è Parents can only access:\n‚Ä¢ Parent Dashboard\n‚Ä¢ Home\n‚Ä¢ About\n‚Ä¢ Coaches\n‚Ä¢ Students\n\nPlease use the Parent Dashboard to manage your child\'s account.');
                navigateTo('parent-dashboard');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // ‚úÖ Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // ‚úÖ RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // ‚úÖ Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // ‚úÖ Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // ‚úÖ Load student dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    // ‚úÖ Load parent dashboard when navigating to it
    if (section === 'parent-dashboard' && currentUser) {
        await loadParentDashboard();
    }
    
    // ‚úÖ LOAD ADMIN PANEL WHEN NAVIGATING TO IT
    if (section === 'admin' && currentUser) {
        console.log('üéØ Navigating to admin panel. isAdmin:', isAdmin);
        if (!isAdmin) {
            alert('‚ùå Admin access required. Please sign in with an admin account.');
            navigateTo('home');
            return;
        }
        await loadAdminPanel();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }

    if (section === 'tournaments') {
    await loadTournamentList();
}
   // Load class section
    if (section === 'class' && currentUser) {
        await loadMyClass();
} 
}

 // ===== COACHES DISPLAY FUNCTIONS =====
async function loadAndDisplayCoaches() {
    const container = document.getElementById('coaches-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading coaches...</div>';
        
        console.log('üîç Fetching coaches from Firestore...');
        
        // Fetch all coaches from Firestore
        const coachesSnapshot = await db.collection('users')
            .where('userType', '==', 'coach')
            .get();
        
        console.log('üìä Found coaches:', coachesSnapshot.size);
        
        if (coachesSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üë®‚Äçüè´</div>
                    <h3>No coaches registered yet</h3>
                    <p>Be the first to join as a coach!</p>
                </div>
            `;
            return;
        }
        
        const coaches = [];
        coachesSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Coach:', doc.id, data.name, data.photoURL);
            coaches.push({ id: doc.id, ...data });
        });
        
        // Sort coaches (newest first)
        coaches.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate stats
        const totalCoaches = coaches.length;
        const verifiedCoaches = coaches.filter(c => c.idVerified).length;
        const pendingCoaches = totalCoaches - verifiedCoaches;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Cards -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalCoaches}</div>
                    <div class="stat-label">Total Coaches</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${verifiedCoaches}</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${pendingCoaches}</div>
                    <div class="stat-label">‚è≥ Pending</div>
                </div>
            </div>
            
            <!-- Coaches Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üë®‚Äçüè´ Coach</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => {
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (coach.photoURL) {
                                avatarStyle = `style="background-image: url('${coach.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (coach.name || 'C').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showCoachDetailById('${coach.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${coach.name || 'Unknown Coach'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        ${coach.idVerified ? 
                                            '<span class="verified-badge">Verified</span>' : 
                                            '<span class="unverified-badge">‚è≥ Pending</span>'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">üõ°Ô∏è Safety & Verification</h3>
                <p style="color: #666; line-height: 1.6;">
                    All coaches on WordBiz Coaching Academy undergo ID verification for student safety. 
                    Click on any coach to view their full profile and verification details.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading coaches:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading coaches. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayCoaches()">üîÑ Retry</button>
            </div>
        `;
    }
}

// Load and show coach profile modal
async function showCoachDetailById(coachId) {
    try {
        console.log('üìã Loading coach details for:', coachId);
        const coachDoc = await db.collection('users').doc(coachId).get();
        
        if (coachDoc.exists) {
            const coach = { id: coachDoc.id, ...coachDoc.data() };
            console.log('Coach data loaded:', coach);
            showCoachDetail(coach);
        } else {
            console.error('‚ùå Coach not found');
            alert('Coach profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading coach details:', error);
        alert('Unable to load coach details: ' + error.message);
    }
}

// Display coach detail modal
async function showCoachDetail(coach) {
    console.log('Displaying coach modal:', coach.name);
    const modal = document.getElementById('coachDetailModal');
    
    if (!modal) {
        console.error('Coach modal not found!');
        return;
    }


 // ===== STUDENTS DISPLAY FUNCTIONS =====
async function loadAndDisplayStudents() {
    const container = document.getElementById('students-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading students...</div>';
        
        console.log('üîç Fetching students from Firestore...');
        
        // Fetch all students from Firestore
        const studentsSnapshot = await db.collection('users')
            .where('userType', '==', 'student')
            .get();
        
        console.log('üìä Found students:', studentsSnapshot.size);
        
        if (studentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üéì</div>
                    <h3>No students registered yet</h3>
                    <p>Be the first to join as a student!</p>
                </div>
            `;
            return;
        }
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Student:', doc.id, data.name, data.photoURL);
            students.push({ id: doc.id, ...data });
        });
        
        // Sort students (newest first)
        students.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate total students
        const totalStudents = students.length;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Card -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            </div>
            
            <!-- Students Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üéì Student</th>
                            <th>üÜî Student ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => {
                            // Generate Student ID (WB-2025-XXXX)
                            const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
                            
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (student.photoURL) {
                                avatarStyle = `style="background-image: url('${student.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (student.name || 'S').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showStudentDetailById('${student.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${student.name || 'Student'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span style="font-family: monospace; background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: #0d3b66;">
                                            ${studentId}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                <h3 style="color: white; margin-bottom: 10px;">üåü Growing Community</h3>
                <p style="color: rgba(255,255,255,0.95); line-height: 1.6;">
                    Our students are learning from coaches around the world, building vocabulary skills 
                    through interactive quizzes, spelling challenges, and personalized practice sessions.
                    Click on any student to view their full profile.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading students:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading students. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayStudents()">üîÑ Retry</button>
            </div>
        `;
    }
}
        
// Load and show student profile modal
async function showStudentDetailById(studentId) {
    try {
        console.log('üìã Loading student details for:', studentId);
        const studentDoc = await db.collection('users').doc(studentId).get();
        
        if (studentDoc.exists) {
            const student = { id: studentDoc.id, ...studentDoc.data() };
            console.log('Student data loaded:', student);
            showStudentDetail(student);
        } else {
            console.error('‚ùå Student not found');
            alert('Student profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading student details:', error);
        alert('Unable to load student details: ' + error.message);
    }
}

// Display student detail modal
async function showStudentDetail(student) {
    console.log('Displaying student modal:', student.name);
    const modal = document.getElementById('studentDetailModal');
    
    if (!modal) {
        console.error('Student modal not found!');
        return;
    }



     // ===== ADMIN CONFIGURATION =====
const ADMIN_EMAIL = 'carlanviroberts@gmail.com'; // ‚ö†Ô∏è CHANGE THIS TO YOUR ADMIN EMAIL
let isAdmin = false;

// Check if current user is admin
async function checkAdminStatus() {
    if (!currentUser) {
        isAdmin = false;
        updateAdminUI();
        console.log('‚ùå No current user - admin status: false');
        return false;
    }
    
    try {
        console.log('üîç Checking admin status for:', currentUser.email);
        console.log('üîç Admin email configured as:', ADMIN_EMAIL);
        
        // Check email directly first
        if (currentUser.email === ADMIN_EMAIL) {
            isAdmin = true;
            console.log('‚úÖ ADMIN DETECTED via email match!');
            updateAdminUI();
            return true;
        }
        
        // Also check Firestore user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            isAdmin = (userData?.email === ADMIN_EMAIL);
            console.log('üìÑ Firestore check - Admin status:', isAdmin);
        } else {
            console.log('‚ö†Ô∏è User document not found in Firestore');
        }
        
        updateAdminUI();
        return isAdmin;
        
    } catch (error) {
        console.error('‚ùå Error checking admin status:', error);
        isAdmin = false;
        updateAdminUI();
        return false;
    }
}

function updateAdminUI() {
    console.log('üîÑ Updating admin UI. isAdmin:', isAdmin);
    
    // Show/hide admin link in sidebar
    const adminLink = document.getElementById('admin-nav-link');
    if (adminLink) {
        adminLink.style.display = isAdmin ? 'block' : 'none';
        console.log('‚úÖ Admin link display set to:', isAdmin ? 'block' : 'none');
    } else {
        console.log('‚ö†Ô∏è Admin link element not found in DOM');
    }
}

// ===== ADMIN PANEL WITH SECTIONS =====

let currentAdminSection = 'tournaments'; // Default section
let currentUserSubSection = 'students'; // Default user sub-section

async function loadAdminPanel() {
    if (!isAdmin) {
        document.getElementById('admin-container').innerHTML = `
            <div class="feedback error" style="text-align: center; padding: 40px;">
                ‚ùå <strong>Access Denied</strong><br><br>
                Admin privileges required.<br>
                Current user: ${currentUser ? currentUser.email : 'Not signed in'}
            </div>
        `;
        return;
    }
    
    const container = document.getElementById('admin-container');
    container.innerHTML = `
        <div class="admin-panel">
            <!-- Admin Navigation -->
            <div style="display: flex; gap: 15px; margin-bottom: 30px; justify-content: center;">
                <button class="practice-btn" id="admin-tournaments-btn" onclick="switchAdminSection('tournaments')" style="padding: 12px 30px; font-size: 1.1rem;">
                    üèÜ Tournaments
                </button>
                <button class="practice-btn" id="admin-users-btn" onclick="switchAdminSection('users')" style="padding: 12px 30px; font-size: 1.1rem;">
                    üë• Users
                </button>
            </div>
            
            <!-- Content Container -->
            <div id="admin-content-container">
                <div class="loading">Loading...</div>
            </div>
        </div>
    `;
    
    // Load default section
    switchAdminSection('tournaments');
}

async function switchAdminSection(section) {
    currentAdminSection = section;
    
    // Update button styles
    const tournamentsBtn = document.getElementById('admin-tournaments-btn');
    const usersBtn = document.getElementById('admin-users-btn');
    
    if (tournamentsBtn && usersBtn) {
        tournamentsBtn.style.background = section === 'tournaments' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
        usersBtn.style.background = section === 'users' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
    }
    
    const contentContainer = document.getElementById('admin-content-container');
    
    if (section === 'tournaments') {
        await loadAdminTournaments(contentContainer);
    } else if (section === 'users') {
        await loadAdminUsersSection(contentContainer);
    }
}

// ===== TOURNAMENTS SECTION =====

async function loadAdminTournaments(container) {
    container.innerHTML = '<div class="loading">Loading tournaments...</div>';
    
    try {
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('createdAt', 'desc')
            .get();
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            tournaments.push({ id: doc.id, ...doc.data() });
        });
        
        container.innerHTML = `
            <div style="text-align: center; margin-bottom: 30px;">
                <button class="practice-btn" onclick="showCreateTournamentModal()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2);">
                    ‚ûï Create New Tournament
                </button>
            </div>
            
            <h3 style="color: #0d3b66; margin-bottom: 20px;">üìã Manage Tournaments (${tournaments.length})</h3>
            
            ${tournaments.length === 0 ? `
                <div class="loading">
                    No tournaments created yet. Click "Create New Tournament" to get started.
                </div>
            ` : `
                <div class="coaches-table">
                    <table>
                        <thead>
                            <tr>
                                <th>üèÜ Tournament</th>
                                <th>üìÖ Date</th>
                                <th>üë• Participants</th>
                                <th>‚öôÔ∏è Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tournaments.map(tournament => `
                                <tr>
                                    <td>
                                        <div style="font-weight: bold; color: #0d3b66;">${tournament.name}</div>
                                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                            Level: ${tournament.level} ‚Ä¢ Status: ${tournament.status}
                                        </div>
                                    </td>
                                    <td>
                                        <div>${tournament.startDate ? new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not scheduled'}</div>
                                        <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                            ${tournament.startTime || 'Time TBD'}
                                        </div>
                                    </td>
                                    <td style="text-align: center;">
                                        <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #0d3b66;">
                                            ${tournament.participants || 0}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 5px; justify-content: center;">
                                            <button class="practice-btn" onclick="viewTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8;">
                                                üëÅÔ∏è View
                                            </button>
                                            <button class="practice-btn" onclick="editTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                ‚úèÔ∏è Edit
                                            </button>
                                            <button class="practice-btn" onclick="deleteTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                                üóëÔ∏è Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `}
        `;
        
    } catch (error) {
        console.error('Error loading tournaments:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load tournaments: ${error.message}
            </div>
        `;
    }
}

// ===== USERS SECTION =====

async function loadAdminUsersSection(container) {
    container.innerHTML = `
        <div>
            <!-- User Type Navigation -->
            <div style="display: flex; gap: 15px; margin-bottom: 30px; justify-content: center;">
                <button class="practice-btn" id="admin-students-btn" onclick="switchUserSubSection('students')" style="padding: 10px 25px;">
                    üéì Students
                </button>
                <button class="practice-btn" id="admin-coaches-btn" onclick="switchUserSubSection('coaches')" style="padding: 10px 25px;">
                    üë®‚Äçüè´ Coaches
                </button>
            </div>
            
            <!-- User List Container -->
            <div id="admin-user-list-container">
                <div class="loading">Loading users...</div>
            </div>
        </div>
    `;
    
    // Load default sub-section
    switchUserSubSection('students');
}

async function switchUserSubSection(subSection) {
    currentUserSubSection = subSection;
    
    // Update button styles
    const studentsBtn = document.getElementById('admin-students-btn');
    const coachesBtn = document.getElementById('admin-coaches-btn');
    
    if (studentsBtn && coachesBtn) {
        studentsBtn.style.background = subSection === 'students' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
        coachesBtn.style.background = subSection === 'coaches' ? 'linear-gradient(135deg, #667eea, #764ba2)' : '#6c757d';
    }
    
    const listContainer = document.getElementById('admin-user-list-container');
    
    if (subSection === 'students') {
        await loadAdminStudentsList(listContainer);
    } else if (subSection === 'coaches') {
        await loadAdminCoachesList(listContainer);
    }
}

// ===== STUDENTS LIST =====

async function loadAdminStudentsList(container) {
    container.innerHTML = '<div class="loading">Loading students...</div>';
    
    try {
        const studentsSnapshot = await db.collection('users')
            .where('role', '==', 'student')
            .orderBy('createdAt', 'desc')
            .get();
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            students.push({ id: doc.id, ...doc.data() });
        });
        
        if (students.length === 0) {
            container.innerHTML = `
                <div class="loading">
                    No students found on the platform.
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <h3 style="color: #0d3b66; margin-bottom: 20px;">üéì All Students (${students.length})</h3>
            
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üë§ Student</th>
                            <th>üìß Email</th>
                            <th>üìÖ Joined</th>
                            <th>üîí Status</th>
                            <th>‚öôÔ∏è Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => `
                            <tr>
                                <td>
                                    <div style="font-weight: bold; color: #0d3b66;">${student.firstName || 'N/A'} ${student.lastName || ''}</div>
                                    <div style="font-size: 0.85rem; color: #666;">ID: ${student.id.substring(0, 8)}...</div>
                                </td>
                                <td>${student.email || 'No email'}</td>
                                <td>${student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                                <td style="text-align: center;">
                                    ${student.subscriptionLocked ? 
                                        '<span style="background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">üîí Locked</span>' : 
                                        '<span style="background: #51cf66; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">‚úÖ Active</span>'
                                    }
                                </td>
                                <td>
                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                        <button class="practice-btn" onclick="viewStudentDetailsAdmin('${student.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8;">
                                            üëÅÔ∏è View
                                        </button>
                                        ${student.subscriptionLocked ? 
                                            `<button class="practice-btn" onclick="unlockStudentAccount('${student.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #51cf66;">
                                                üîì Unlock
                                            </button>` :
                                            `<button class="practice-btn" onclick="lockStudentAccount('${student.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                üîí Lock
                                            </button>`
                                        }
                                        <button class="practice-btn" onclick="deleteStudentAccount('${student.id}', '${student.firstName} ${student.lastName}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading students:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load students: ${error.message}
            </div>
        `;
    }
}

// ===== COACHES LIST =====

async function loadAdminCoachesList(container) {
    container.innerHTML = '<div class="loading">Loading coaches...</div>';
    
    try {
        const coachesSnapshot = await db.collection('users')
            .where('role', '==', 'coach')
            .orderBy('createdAt', 'desc')
            .get();
        
        const coaches = [];
        coachesSnapshot.forEach(doc => {
            coaches.push({ id: doc.id, ...doc.data() });
        });
        
        if (coaches.length === 0) {
            container.innerHTML = `
                <div class="loading">
                    No coaches found on the platform.
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <h3 style="color: #0d3b66; margin-bottom: 20px;">üë®‚Äçüè´ All Coaches (${coaches.length})</h3>
            
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üë§ Coach</th>
                            <th>üìß Email</th>
                            <th>üë• Students</th>
                            <th>üìÖ Joined</th>
                            <th>üîí Status</th>
                            <th>‚öôÔ∏è Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => `
                            <tr>
                                <td>
                                    <div style="font-weight: bold; color: #0d3b66;">${coach.firstName || 'N/A'} ${coach.lastName || ''}</div>
                                    <div style="font-size: 0.85rem; color: #666;">ID: ${coach.id.substring(0, 8)}...</div>
                                </td>
                                <td>${coach.email || 'No email'}</td>
                                <td style="text-align: center;">
                                    <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #0d3b66;">
                                        ${coach.studentCount || 0}
                                    </span>
                                </td>
                                <td>${coach.createdAt ? new Date(coach.createdAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                                <td style="text-align: center;">
                                    ${coach.subscriptionLocked ? 
                                        '<span style="background: #ff6b6b; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">üîí Locked</span>' : 
                                        '<span style="background: #51cf66; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.85rem;">‚úÖ Active</span>'
                                    }
                                </td>
                                <td>
                                    <div style="display: flex; gap: 5px; justify-content: center;">
                                        <button class="practice-btn" onclick="viewCoachDetailsAdmin('${coach.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8;">
                                            üëÅÔ∏è View
                                        </button>
                                        ${coach.subscriptionLocked ? 
                                            `<button class="practice-btn" onclick="unlockCoachAccount('${coach.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #51cf66;">
                                                üîì Unlock
                                            </button>` :
                                            `<button class="practice-btn" onclick="lockCoachAccount('${coach.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                üîí Lock
                                            </button>`
                                        }
                                        <button class="practice-btn" onclick="deleteCoachAccount('${coach.id}', '${coach.firstName} ${coach.lastName}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                            üóëÔ∏è Delete
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading coaches:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load coaches: ${error.message}
            </div>
        `;
    }
}

// ===== STUDENT ADMIN ACTIONS =====

async function viewStudentDetailsAdmin(studentId) {
    try {
        const studentDoc = await db.collection('users').doc(studentId).get();
        
        if (!studentDoc.exists) {
            alert('‚ùå Student not found');
            return;
        }
        
        const student = studentDoc.data();
        
        // Get student's progress data
        const progressSnapshot = await db.collection('users').doc(studentId)
            .collection('progress')
            .orderBy('timestamp', 'desc')
            .limit(10)
            .get();
        
        const progressData = [];
        progressSnapshot.forEach(doc => {
            progressData.push(doc.data());
        });
        
        const modal = document.createElement('div');
        modal.className = 'auth-modal active';
        modal.style.display = 'block';
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 700px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <h2 style="color: white;">üë§ Student Details</h2>
                    <button class="modal-close" onclick="this.closest('.auth-modal').remove()" style="color: white;">√ó</button>
                </div>
                <div class="auth-body">
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">üìã Basic Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <p><strong>Name:</strong> ${student.firstName || 'N/A'} ${student.lastName || ''}</p>
                            <p><strong>Email:</strong> ${student.email || 'N/A'}</p>
                            <p><strong>User ID:</strong> ${studentId}</p>
                            <p><strong>Account Created:</strong> ${student.createdAt ? new Date(student.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Subscription Status:</strong> ${student.subscriptionLocked ? 'üîí Locked' : '‚úÖ Active'}</p>
                            <p><strong>Coach ID:</strong> ${student.coachId || 'No coach assigned'}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">üìä Recent Activity</h3>
                        ${progressData.length === 0 ? 
                            '<p style="color: #666;">No practice sessions recorded yet.</p>' :
                            `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 200px; overflow-y: auto;">
                                ${progressData.map(session => `
                                    <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${session.difficulty || 'Unknown'}</strong> - 
                                        Score: ${session.score || 0}/${session.totalWords || 0} 
                                        (${session.accuracy || 0}%)
                                        <br>
                                        <small style="color: #666;">${session.timestamp ? new Date(session.timestamp.toDate()).toLocaleString() : 'N/A'}</small>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                    
                    <button class="auth-submit" onclick="this.closest('.auth-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error viewing student details:', error);
        alert('‚ùå Failed to load student details: ' + error.message);
    }
}

async function unlockStudentAccount(studentId) {
    if (!confirm('Are you sure you want to unlock this student account?')) {
        return;
    }
    
    try {
        await db.collection('users').doc(studentId).update({
            subscriptionLocked: false,
            unlockedByAdmin: true,
            unlockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Student account unlocked successfully!');
        
        // Reload the students list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminStudentsList(listContainer);
        }
        
    } catch (error) {
        console.error('Error unlocking student account:', error);
        alert('‚ùå Failed to unlock account: ' + error.message);
    }
}

async function lockStudentAccount(studentId) {
    if (!confirm('Are you sure you want to lock this student account? They will not be able to access practice features.')) {
        return;
    }
    
    try {
        await db.collection('users').doc(studentId).update({
            subscriptionLocked: true,
            lockedByAdmin: true,
            lockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Student account locked successfully!');
        
        // Reload the students list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminStudentsList(listContainer);
        }
        
    } catch (error) {
        console.error('Error locking student account:', error);
        alert('‚ùå Failed to lock account: ' + error.message);
    }
}

async function deleteStudentAccount(studentId, studentName) {
    const confirmDelete = confirm(`‚ö†Ô∏è WARNING: Are you sure you want to permanently delete the account for "${studentName}"?\n\nThis will:\n- Delete their user account\n- Delete all their progress data\n- Remove them from their coach's student list\n\nThis action CANNOT be undone!`);
    
    if (!confirmDelete) {
        return;
    }
    
    const doubleConfirm = confirm(`Final confirmation: Type the student's name to confirm deletion.\n\nExpected: ${studentName}`);
    
    if (!doubleConfirm) {
        return;
    }
    
    try {
        // Delete user document
        await db.collection('users').doc(studentId).delete();
        
        alert('‚úÖ Student account deleted successfully!');
        
        // Reload the students list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminStudentsList(listContainer);
        }
        
    } catch (error) {
        console.error('Error deleting student account:', error);
        alert('‚ùå Failed to delete account: ' + error.message);
    }
}

// ===== COACH ADMIN ACTIONS =====

async function viewCoachDetailsAdmin(coachId) {
    try {
        const coachDoc = await db.collection('users').doc(coachId).get();
        
        if (!coachDoc.exists) {
            alert('‚ùå Coach not found');
            return;
        }
        
        const coach = coachDoc.data();
        
        // Get coach's students
        const studentsSnapshot = await db.collection('users')
            .where('coachId', '==', coachId)
            .get();
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            students.push({ id: doc.id, ...doc.data() });
        });
        
        const modal = document.createElement('div');
        modal.className = 'auth-modal active';
        modal.style.display = 'block';
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 700px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <h2 style="color: white;">üë®‚Äçüè´ Coach Details</h2>
                    <button class="modal-close" onclick="this.closest('.auth-modal').remove()" style="color: white;">√ó</button>
                </div>
                <div class="auth-body">
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">üìã Basic Information</h3>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                            <p><strong>Name:</strong> ${coach.firstName || 'N/A'} ${coach.lastName || ''}</p>
                            <p><strong>Email:</strong> ${coach.email || 'N/A'}</p>
                            <p><strong>User ID:</strong> ${coachId}</p>
                            <p><strong>Account Created:</strong> ${coach.createdAt ? new Date(coach.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            <p><strong>Subscription Status:</strong> ${coach.subscriptionLocked ? 'üîí Locked' : '‚úÖ Active'}</p>
                            <p><strong>Total Students:</strong> ${students.length}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #0d3b66; margin-bottom: 15px;">üë• Students (${students.length})</h3>
                        ${students.length === 0 ? 
                            '<p style="color: #666;">No students assigned to this coach.</p>' :
                            `<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 200px; overflow-y: auto;">
                                ${students.map(student => `
                                    <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px;">
                                        <strong>${student.firstName || 'N/A'} ${student.lastName || ''}</strong>
                                        <br>
                                        <small style="color: #666;">${student.email || 'No email'}</small>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                    
                    <button class="auth-submit" onclick="this.closest('.auth-modal').remove()">
                        Close
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error viewing coach details:', error);
        alert('‚ùå Failed to load coach details: ' + error.message);
    }
}


async function unlockCoachAccount(coachId) {
    if (!confirm('Are you sure you want to unlock this coach account?')) {
        return;
    }
    
    try {
        await db.collection('users').doc(coachId).update({
            subscriptionLocked: false,
            unlockedByAdmin: true,
            unlockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Coach account unlocked successfully!');
        
        // Reload the coaches list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminCoachesList(listContainer);
        }
        
    } catch (error) {
        console.error('Error unlocking coach account:', error);
        alert('‚ùå Failed to unlock account: ' + error.message);
    }
}

async function lockCoachAccount(coachId) {
    if (!confirm('Are you sure you want to lock this coach account? They will not be able to access their dashboard.')) {
        return;
    }
    
    try {
        await db.collection('users').doc(coachId).update({
            subscriptionLocked: true,
            lockedByAdmin: true,
            lockedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        alert('‚úÖ Coach account locked successfully!');
        
        // Reload the coaches list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminCoachesList(listContainer);
        }
        
    } catch (error) {
        console.error('Error locking coach account:', error);
        alert('‚ùå Failed to lock account: ' + error.message);
    }
}

async function deleteCoachAccount(coachId, coachName) {
    const confirmDelete = confirm(`‚ö†Ô∏è WARNING: Are you sure you want to permanently delete the account for coach "${coachName}"?\n\nThis will:\n- Delete their coach account\n- Unassign all their students\n- Delete all their data\n\nThis action CANNOT be undone!`);
    
    if (!confirmDelete) {
        return;
    }

    const doubleConfirm = confirm(`Final confirmation: This will also unassign all students from this coach. Continue?`);

    if (!doubleConfirm) {
        return;
    }

    try {
        // First, unassign all students
        const studentsSnapshot = await db.collection('users')
            .where('coachId', '==', coachId)
            .get();
        
        const batch = db.batch();
        studentsSnapshot.forEach(doc => {
            batch.update(doc.ref, { coachId: null });
        });
        
        // Delete coach document
        batch.delete(db.collection('users').doc(coachId));
        
        await batch.commit();
        
        alert('‚úÖ Coach account deleted successfully and students unassigned!');
        
        // Reload the coaches list
        const listContainer = document.getElementById('admin-user-list-container');
        if (listContainer) {
            await loadAdminCoachesList(listContainer);
        }
        
    } catch (error) {
        console.error('Error deleting coach account:', error);
        alert('‚ùå Failed to delete account: ' + error.message);
    }
}

// ===== TOURNAMENT MODAL FUNCTIONS =====
function showCreateTournamentModal() {
    const modal = document.createElement('div');
    modal.className = 'auth-modal';
    modal.id = 'createTournamentModal';
    modal.style.display = 'block';
    modal.classList.add('active');
    modal.innerHTML = `
        <div class="auth-content" style="max-width: 600px;">
            <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h2 style="color: white;">‚ûï Create New Tournament</h2>
                <button class="modal-close" onclick="closeCreateTournamentModal()" style="color: white;">√ó</button>
            </div>
            <div class="auth-body">
                <form id="create-tournament-form" onsubmit="handleCreateTournament(event)">
                    <div class="form-group">
                        <label>Tournament Name *</label>
                        <input type="text" id="tournament-name" required placeholder="e.g., Summer Spelling Championship 2025">
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;" placeholder="Describe the tournament..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty Level *</label>
                        <select id="tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="">Select level</option>
                            <option value="foundation">üå± Foundation</option>
                            <option value="challenge">üéØ Challenge</option>
                            <option value="advanced">üöÄ Advanced</option>
                            <option value="championship">üèÜ Championship</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="tournament-date" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="tournament-time" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Max Participants</label>
                        <input type="number" id="tournament-max-participants" min="10" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="upcoming">üìÖ Upcoming (Open for Registration)</option>
                            <option value="active">‚ñ∂Ô∏è Active (In Progress)</option>
                            <option value="completed">‚úÖ Completed</option>
                            <option value="cancelled">‚ùå Cancelled</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        ‚úÖ Create Tournament
                    </button>
                    
                    <div id="create-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                </form>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
}

function closeCreateTournamentModal() {
    const modal = document.getElementById('createTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleCreateTournament(event) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('‚ùå Admin access required');
        return;
    }

    const name = document.getElementById('tournament-name').value.trim();
    const description = document.getElementById('tournament-description').value.trim();
    const level = document.getElementById('tournament-level').value;
    const date = document.getElementById('tournament-date').value;
    const time = document.getElementById('tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('tournament-max-participants').value);
    const status = document.getElementById('tournament-status').value;

    const errorDiv = document.getElementById('create-tournament-error');

    try {
        console.log('üìù Creating tournament:', name);
        
        // Create tournament in Firestore
        const tournamentRef = await db.collection('tournaments').add({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            participants: 0,
            registeredUsers: [],
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Tournament created:', tournamentRef.id);
        
        closeCreateTournamentModal();
        
        alert('‚úÖ Tournament created successfully!');
        
        // Reload admin panel tournaments section
        const contentContainer = document.getElementById('admin-content-container');
        if (contentContainer) {
            await loadAdminTournaments(contentContainer);
        }
        
        // Also reload tournament list if we're on tournaments page
        const tournamentsSection = document.getElementById('tournaments-section');
        if (tournamentsSection && tournamentsSection.classList.contains('active')) {
            await loadTournamentList();
        }
        
    } catch (error) {
        console.error('‚ùå Error creating tournament:', error);
        errorDiv.textContent = 'Failed to create tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}
    </script>
</body>
</html>

