
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        
// ===== PAYPAL CONFIGURATION =====
const PAYPAL_HANDLER_URL = 'https://verificationpaypalpayment-998744778737.us-central1.run.app';
const REOPEN_ACCOUNT_COST = 6.50;
const REOPEN_DAYS = 30;

let paypalButtonRendered = false;
let sponsorPaypalRendered = false;
let currentChildData = null;

        

        let paypalSDKLoaded = false;

async function loadPayPalSDK() {
    if (paypalSDKLoaded) {
        return Promise.resolve();
    }
    
    try {
        // Get client ID from Firebase function
        const response = await fetch(`${PAYPAL_HANDLER_URL}?action=getClientId`);
        const data = await response.json();
        
        if (!data.success || !data.clientId) {
            throw new Error('Failed to get PayPal client ID');
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${data.clientId}&currency=USD&locale=en_US`;
            script.async = true;
            
            script.onload = () => {
                paypalSDKLoaded = true;
                console.log('‚úÖ PayPal SDK loaded');
                resolve();
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load PayPal SDK'));
            };
            
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading PayPal SDK:', error);
        throw error;
    }
}
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // ‚úÖ NEW: Track declined challenges
let presenceInitialized = false; // ‚úÖ NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// ‚úÖ Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;


// ===== TOURNAMENT VARIABLES =====
let currentTournament = null;
let tournamentStage = 0;
let stage1Questions = [];
let stage1CurrentIndex = 0;
let stage1Score = 0;
let stage1Errors = 0;
let stage1Handicaps = 2;
let stage1TimeLeft = 600; // 10 minutes in seconds
let stage1Timer = null;



// ===== STAGE 2: AI AUDIO SPELLING =====
let stage2Words = [];
let stage2CurrentIndex = 0;
let stage2Score = 0;
let stage2Errors = 0;
let stage2TimeLeft = 900; // 15 minutes
let stage2Timer = null;
let stage2HandicapsRemaining = 1; // Base 1 + carried from Stage 1


   // ===== TOURNAMENT STAGE 3 FUNCTIONS =====
let stage3Words = [];
let stage3CurrentIndex = 0;
let stage3Score = 0;
let stage3Errors = 0;
let stage3TimeLeft = 900; // 15 minutes
let stage3Timer = null;
let stage3HandicapsRemaining = 0;
let stage3CurrentLetterOrder = [];
let stage3DraggedElement = null; 

 // ===== LIVE SPELL MASTER STAGES (4-7) =====
let liveStageParticipants = [];
let currentLiveStageIndex = 0;
let liveStageTimer = null;
let callerMode = false; // true if user is the caller
let liveStageWords = [];
let eliminatedPlayers = [];
let currentSpellerIndex = 0;
let finalRoundSpelling = null;

        
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // ‚úÖ Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // ‚úÖ ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // √¢≈ì‚Ä¶ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });
    
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        console.log('üë§ User signed in:', user.email);
        console.log('üñºÔ∏è Auth photoURL:', user.photoURL);
        
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        console.log('üìÑ Firestore photoURL:', userData.photoURL);
        
        if (user.photoURL && !userData.photoURL) {
            console.log('üìÑ Syncing photoURL to Firestore...');
            await userRef.update({
                photoURL: user.photoURL
            });
            console.log('‚úÖ PhotoURL synced!');
        }
        
        // ‚úÖ INITIALIZE SPELLING STATS IF NOT EXISTS
        if (!userData.spellingStats) {
            console.log('üìÑ Initializing spelling stats...');
            await userRef.update({
                spellingStats: {
                    totalChallenges: 0,
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    winStreak: 0,
                    bestStreak: 0
                }
            });
            console.log('‚úÖ Spelling stats initialized!');
        }
        
        // ‚úÖ CHECK ADMIN STATUS HERE (CRITICAL - RIGHT AFTER USER DATA IS LOADED)
        await checkAdminStatus();
        
        // ‚úÖ CHECK USER TYPE AND HANDLE ACCORDINGLY
        if (userData.userType === 'parent') {
            // Parent user - no profile completion needed
            if (!userData.profileComplete) {
                await userRef.update({ profileComplete: true });
            }
            updateUIForAuthenticatedUser(user);
            
            // Navigate to parent dashboard
            navigateTo('parent-dashboard');
            return;
        }
        
        // STUDENT/COACH HANDLING
        if (!userData.profileComplete) {
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // ‚úÖ LOAD USER COINS (for students only)
        if (userData.userType === 'student') {
            await loadUserCoins(user.uid);
            await checkSubscriptionStatus();
        }
        
        await cleanupInvalidFavorites();
        
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // ‚úÖ Initialize presence immediately on login (only for students/coaches)
        if (userData.userType !== 'parent') {
            await initializeOnlinePresence();
        }
        
        // Load appropriate dashboard
        if (userData.userType === 'student') {
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        }
    } else {
        currentUser = null;
        isAdmin = false; // ‚úÖ Reset admin status when signed out
        updateUIForGuestUser();
        // ‚úÖ Update UI to hide admin link
        updateAdminUI();
    }
});
    });
        
        
    
// ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // ‚úÖ CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'parent-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // ‚úÖ ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard' || section === 'parent-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // ‚úÖ PREVENT PARENTS FROM ACCESSING STUDENT FEATURES
    if (currentUser && section !== 'parent-dashboard' && section !== 'home' && section !== 'about' && section !== 'coaches' && section !== 'students') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'parent') {
                alert('‚ö†Ô∏è Parents can only access:\n‚Ä¢ Parent Dashboard\n‚Ä¢ Home\n‚Ä¢ About\n‚Ä¢ Coaches\n‚Ä¢ Students\n\nPlease use the Parent Dashboard to manage your child\'s account.');
                navigateTo('parent-dashboard');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // ‚úÖ Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // ‚úÖ RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // ‚úÖ Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // ‚úÖ Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // ‚úÖ Load student dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    // ‚úÖ Load parent dashboard when navigating to it
    if (section === 'parent-dashboard' && currentUser) {
        await loadParentDashboard();
    }
    
    // ‚úÖ LOAD ADMIN PANEL WHEN NAVIGATING TO IT
    if (section === 'admin' && currentUser) {
        console.log('üéØ Navigating to admin panel. isAdmin:', isAdmin);
        if (!isAdmin) {
            alert('‚ùå Admin access required. Please sign in with an admin account.');
            navigateTo('home');
            return;
        }
        await loadAdminPanel();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }

    if (section === 'tournaments') {
    await loadTournamentList();
}
}
        


     // ===== TOURNAMENT STAGE 1 FUNCTIONS =====

async function startTournamentStage1(tournamentId) {
    try {
        console.log('üèÜ Starting Tournament Stage 1:', tournamentId);
        
        currentTournament = tournamentId;
        tournamentStage = 1;
        stage1CurrentIndex = 0;
        stage1Score = 0;
        stage1Errors = 0;
        stage1Handicaps = 2;
        stage1TimeLeft = 600; // 10 minutes
        
        // Hide lobby, show stage 1
        document.getElementById('tournament-lobby').style.display = 'none';
        document.getElementById('tournament-stage1').style.display = 'block';
        
        // Generate 25 antonym/synonym questions
        await generateStage1Questions();
        
        // Start timer
        startStage1Timer();
        
        // Load first question
        loadStage1Question();
        
    } catch (error) {
        console.error('Error starting Stage 1:', error);
        alert('Failed to start tournament: ' + error.message);
    }
}

async function generateStage1Questions() {
    try {
        // Load words from current level
        if (!selectedGameLevel) {
            selectedGameLevel = 'challenge'; // Default to challenge level
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select 25 random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        const selectedWords = shuffled.slice(0, 25);
        
        console.log('üìù Generating questions for:', selectedWords);
        
        // Generate questions using AI
        const response = await fetch(CLOUD_FUNCTION_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                data: { 
                    action: 'generateAntonymSynonymQuestions',
                    words: selectedWords 
                } 
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to generate questions');
        }
        
        const data = await response.json();
        stage1Questions = data.result.questions;
        
        console.log('‚úÖ Generated', stage1Questions.length, 'questions');
        
    } catch (error) {
        console.error('Error generating Stage 1 questions:', error);
        throw error;
    }
}

function loadStage1Question() {
    if (stage1CurrentIndex >= stage1Questions.length) {
        completeStage1();
        return;
    }
    
    const question = stage1Questions[stage1CurrentIndex];
    const container = document.getElementById('stage1-question-container');
    
    document.getElementById('stage1-progress').textContent = 
        `Question ${stage1CurrentIndex + 1} of ${stage1Questions.length}`;
    
    container.innerHTML = `
        <div style="margin: 30px 0;">
            <p style="font-size: 1.3rem; margin-bottom: 20px; line-height: 1.6;">
                <strong>${question.sentence}</strong>
            </p>
            <p style="color: #666; margin-bottom: 10px;">
                Select the best ${question.type === 'synonym' ? 'SYNONYM' : 'ANTONYM'} for the word: 
                <strong style="color: #0d3b66;">${question.targetWord}</strong>
            </p>
        </div>
        
        <div class="quiz-options">
            ${question.options.map((option, index) => `
                <div class="quiz-option" onclick="checkStage1Answer(${index})">
                    ${option}
                </div>
            `).join('')}
        </div>
        
        <div id="stage1-feedback" style="margin-top: 20px;"></div>
    `;
}

function checkStage1Answer(selectedIndex) {
    const question = stage1Questions[stage1CurrentIndex];
    const options = document.querySelectorAll('.quiz-option');
    const feedbackDiv = document.getElementById('stage1-feedback');
    
    // Disable all options
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        stage1Score++;
        options[selectedIndex].classList.add('correct');
        feedbackDiv.innerHTML = '<div class="feedback success">‚úÖ Correct!</div>';
        
        // Update score display
        document.getElementById('stage1-score').textContent = stage1Score;
        
        // Move to next question after 1 second
        setTimeout(() => {
            stage1CurrentIndex++;
            loadStage1Question();
        }, 1000);
        
    } else {
        stage1Errors++;
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
        
        // Update errors display
        document.getElementById('stage1-errors').textContent = stage1Errors;
        
        // Check if eliminated
        if (stage1Errors >= 2 && stage1Handicaps === 0) {
            feedbackDiv.innerHTML = '<div class="feedback error">‚ùå Eliminated! You made 2 errors with no handicaps remaining.</div>';
            setTimeout(() => eliminateFromStage1(), 2000);
        } else if (stage1Errors >= 2 && stage1Handicaps > 0) {
            // Use handicap
            stage1Handicaps--;
            stage1Errors = 0; // Reset errors
            document.getElementById('stage1-handicaps').textContent = stage1Handicaps;
            document.getElementById('stage1-errors').textContent = stage1Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå Wrong answer!<br>
                    üõ°Ô∏è Handicap used! Errors reset. Handicaps remaining: ${stage1Handicaps}
                </div>
            `;
            
            setTimeout(() => {
                stage1CurrentIndex++;
                loadStage1Question();
            }, 2000);
        } else {
            feedbackDiv.innerHTML = `<div class="feedback error">‚ùå Wrong! Correct answer: ${question.options[question.correctAnswer]}</div>`;
            setTimeout(() => {
                stage1CurrentIndex++;
                loadStage1Question();
            }, 2000);
        }
    }
}

function startStage1Timer() {
    if (stage1Timer) clearInterval(stage1Timer);
    
    stage1Timer = setInterval(() => {
        stage1TimeLeft--;
        
        const minutes = Math.floor(stage1TimeLeft / 60);
        const seconds = stage1TimeLeft % 60;
        document.getElementById('stage1-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is low
        if (stage1TimeLeft <= 60) {
            document.getElementById('stage1-timer').style.color = '#dc3545';
        }
        
        if (stage1TimeLeft <= 0) {
            clearInterval(stage1Timer);
            completeStage1();
        }
    }, 1000);
}

function completeStage1() {
    clearInterval(stage1Timer);
    
    const container = document.getElementById('stage1-question-container');
    const feedbackDiv = document.getElementById('stage1-feedback');
    
    const percentage = Math.round((stage1Score / stage1Questions.length) * 100);
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'üèÜ' : percentage >= 60 ? '‚≠ê' : 'üìö'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 1 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage1Score} / ${stage1Questions.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                üõ°Ô∏è Handicaps Remaining: ${stage1Handicaps}
            </p>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ Qualified for Stage 2!</h3>
                    <p style="color: #155724;">
                        You'll carry ${stage1Handicaps} handicap(s) into the next round.
                    </p>
                </div>
                <button class="practice-btn" onclick="proceedToStage2()" style="font-size: 1.2rem; padding: 15px 40px;">
                    ‚û°Ô∏è Proceed to Stage 2
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">‚ùå Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance to Stage 2.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    üè† Return to Lobby
                </button>
            `}
        </div>
    `;
    
    feedbackDiv.innerHTML = '';
}

function eliminateFromStage1() {
    clearInterval(stage1Timer);
    
    const container = document.getElementById('stage1-question-container');
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üò¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 1</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You made 2 errors with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage1Score} / ${stage1CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                üè† Return to Lobby
            </button>
        </div>
    `;
}

function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    // Reload tournament list
    loadTournamentList();
}

function proceedToStage2() {
    alert('Stage 2 will be implemented next! üéâ');
    // This will be implemented in the next step
}

async function loadTournamentList() {
    const container = document.getElementById('tournament-list-container');
    container.innerHTML = '<div class="loading">Loading tournaments...</div>';
    
    try {
        // ‚úÖ MODIFIED: Fetch all tournaments, then filter in JavaScript
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('startDate', 'asc')
            .get();
        
        if (tournamentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üèÜ</div>
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">No Active Tournaments</h3>
                    <p style="color: #666;">Check back later for upcoming spelling tournaments!</p>
                    ${isAdmin ? `
                        <button class="practice-btn" onclick="navigateTo('admin')" style="margin-top: 20px; background: linear-gradient(135deg, #667eea, #764ba2);">
                            ‚öôÔ∏è Go to Admin Panel
                        </button>
                    ` : ''}
                </div>
            `;
            return;
        }
        
        // ‚úÖ Filter in JavaScript instead of Firestore query
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            const data = doc.data();
            // Only show upcoming or active tournaments
            if (data.status === 'upcoming' || data.status === 'active') {
                tournaments.push({ id: doc.id, ...data });
            }
        });
        
        // ‚úÖ Handle case where no tournaments match filter
        if (tournaments.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üèÜ</div>
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">No Active Tournaments</h3>
                    <p style="color: #666;">Check back later for upcoming spelling tournaments!</p>
                    ${isAdmin ? `
                        <button class="practice-btn" onclick="navigateTo('admin')" style="margin-top: 20px; background: linear-gradient(135deg, #667eea, #764ba2);">
                            ‚öôÔ∏è Go to Admin Panel
                        </button>
                    ` : ''}
                </div>
            `;
            return;
        }
        
        container.innerHTML = tournaments.map(tournament => {
            const isFull = tournament.participants >= tournament.maxParticipants;
            const isRegistered = tournament.registeredUsers?.includes(currentUser?.uid);
            
            const levelEmoji = {
                'foundation': 'üå±',
                'challenge': 'üéØ',
                'advanced': 'üöÄ',
                'championship': 'üèÜ'
            };
            
            const statusColor = {
                'upcoming': '#ffc107',
                'active': '#28a745',
                'completed': '#6c757d',
                'cancelled': '#dc3545'
            };
            
            return `
                <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-left: 5px solid ${statusColor[tournament.status]};">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="color: #0d3b66; margin: 0 0 10px 0; font-size: 1.5rem;">${levelEmoji[tournament.level]} ${tournament.name}</h3>
                            <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">${tournament.description}</p>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">üìÖ</span>
                                    <span style="color: #666;">${new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">üïê</span>
                                    <span style="color: #666;">${tournament.startTime}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">üë•</span>
                                    <span style="color: #666;">${tournament.participants} / ${tournament.maxParticipants} registered</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="background: ${statusColor[tournament.status]}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; margin-bottom: 15px;">
                                ${tournament.status === 'upcoming' ? 'üìÖ Upcoming' : tournament.status === 'active' ? '‚ñ∂Ô∏è Active' : '‚úÖ Completed'}
                            </div>
                            
                            ${currentUser ? (
                                isRegistered ? `
                                    <button class="practice-btn" disabled style="background: #28a745; opacity: 0.7; cursor: not-allowed;">
                                        ‚úÖ Registered
                                    </button>
                                ` : isFull ? `
                                    <button class="practice-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                                        üîí Full
                                    </button>
                                ` : tournament.status === 'active' ? `
                                    <button class="practice-btn" onclick="startTournamentStage1('${tournament.id}')" style="font-size: 1.1rem; padding: 12px 30px;">
                                        üéØ Join Now
                                    </button>
                                ` : `
                                    <button class="practice-btn" onclick="registerForTournament('${tournament.id}')" style="font-size: 1.1rem; padding: 12px 30px;">
                                        üìù Register
                                    </button>
                                `
                            ) : `
                                <button class="practice-btn" onclick="showAuthModal()" style="font-size: 1.1rem; padding: 12px 30px;">
                                    üìù Sign In to Join
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading tournaments:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load tournaments: ${error.message}
            </div>
        `;
    }
}

async function registerForTournament(tournamentId) {
    if (!currentUser) {
        alert('Please sign in to register');
        showAuthModal();
        return;
    }
    
    try {
        const tournamentRef = db.collection('tournaments').doc(tournamentId);
        const tournamentDoc = await tournamentRef.get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Check if already registered
        if (tournament.registeredUsers?.includes(currentUser.uid)) {
            alert('You are already registered for this tournament');
            return;
        }
        
        // Check if full
        if (tournament.participants >= tournament.maxParticipants) {
            alert('This tournament is full');
            return;
        }
        
        // Register user
        await tournamentRef.update({
            participants: firebase.firestore.FieldValue.increment(1),
            registeredUsers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        
        alert('‚úÖ Successfully registered for the tournament!');
        
        // Reload list
        loadTournamentList();
        
    } catch (error) {
        console.error('Error registering for tournament:', error);
        alert('Failed to register: ' + error.message);
    }
}

  
async function proceedToStage2() {
    try {
        console.log('üéØ Starting Stage 2: AI Audio Spelling');
        
        tournamentStage = 2;
        stage2CurrentIndex = 0;
        stage2Score = 0;
        stage2Errors = 0;
        stage2TimeLeft = 900;
        stage2HandicapsRemaining = 1 + stage1Handicaps; // Add carried handicaps
        
        // Hide Stage 1
        document.getElementById('tournament-stage1').style.display = 'none';
        
        // Create Stage 2 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage2Container = document.getElementById('tournament-stage2');
        
        if (!stage2Container) {
            stage2Container = document.createElement('div');
            stage2Container.id = 'tournament-stage2';
            tournamentsSection.appendChild(stage2Container);
        }
        
        stage2Container.style.display = 'block';
        
        // Show loading
        stage2Container.innerHTML = '<div class="loading">üìö Loading Stage 2 words...</div>';
        
        // Generate words
        await generateStage2Words();
        
        // Build Stage 2 UI
        buildStage2UI();
        
        // Start timer
        startStage2Timer();
        
        // Load first word
        loadStage2Word();
        
    } catch (error) {
        console.error('Error starting Stage 2:', error);
        alert('Failed to start Stage 2: ' + error.message);
    }
}

async function generateStage2Words() {
    try {
        // Use words from current level
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select 25 random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        stage2Words = shuffled.slice(0, 25);
        
        console.log('‚úÖ Generated 25 words for Stage 2:', stage2Words);
        
    } catch (error) {
        console.error('Error generating Stage 2 words:', error);
        throw error;
    }
}

function buildStage2UI() {
    const container = document.getElementById('tournament-stage2');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: #0d3b66; margin: 0;">üé§ Stage 2: AI Audio Spelling</h2>
                <button class="practice-btn" onclick="exitTournament()" style="background: #dc3545; padding: 10px 20px;">
                    üö™ Exit
                </button>
            </div>
            
            <!-- Timer and Stats -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚è±Ô∏è Time Remaining</div>
                    <div id="stage2-timer" style="font-size: 2rem; font-weight: bold; color: #0d3b66;">15:00</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚úÖ Correct</div>
                    <div id="stage2-score" style="font-size: 2rem; font-weight: bold; color: #28a745;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚ùå Errors</div>
                    <div id="stage2-errors" style="font-size: 2rem; font-weight: bold; color: #dc3545;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">üõ°Ô∏è Handicaps</div>
                    <div id="stage2-handicaps" style="font-size: 2rem; font-weight: bold; color: #667eea;">${stage2HandicapsRemaining}</div>
                </div>
            </div>
            
            <!-- Progress -->
            <h3 id="stage2-progress">Word 1 of 25</h3>
            
            <!-- Audio Controls -->
            <div style="text-align: center; margin: 30px 0;">
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="practice-btn" onclick="speakStage2Word()" style="font-size: 1.1rem; padding: 15px 30px;">
                        üîä Play Word
                    </button>
                    <button class="practice-btn" onclick="speakStage2Sentence()" style="font-size: 1.1rem; padding: 15px 30px; background: #17a2b8;">
                        üí¨ Use in Sentence
                    </button>
                </div>
                <p style="color: #666; font-style: italic; font-size: 0.9rem;">Listen and spell the word you hear</p>
            </div>
            
            <!-- Input Field -->
            <div class="form-group" style="margin: 30px 0;">
                <label style="font-size: 1.2rem;">Type what you hear:</label>
                <input type="text" id="stage2-input" 
                       placeholder="Use the keyboard below..." 
                       style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                       readonly>
            </div>
            
            <!-- Virtual Keyboard -->
            <div class="virtual-keyboard">
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('Q')">Q</button>
                    <button class="keyboard-key" onclick="typeStage2Key('W')">W</button>
                    <button class="keyboard-key" onclick="typeStage2Key('E')">E</button>
                    <button class="keyboard-key" onclick="typeStage2Key('R')">R</button>
                    <button class="keyboard-key" onclick="typeStage2Key('T')">T</button>
                    <button class="keyboard-key" onclick="typeStage2Key('Y')">Y</button>
                    <button class="keyboard-key" onclick="typeStage2Key('U')">U</button>
                    <button class="keyboard-key" onclick="typeStage2Key('I')">I</button>
                    <button class="keyboard-key" onclick="typeStage2Key('O')">O</button>
                    <button class="keyboard-key" onclick="typeStage2Key('P')">P</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('A')">A</button>
                    <button class="keyboard-key" onclick="typeStage2Key('S')">S</button>
                    <button class="keyboard-key" onclick="typeStage2Key('D')">D</button>
                    <button class="keyboard-key" onclick="typeStage2Key('F')">F</button>
                    <button class="keyboard-key" onclick="typeStage2Key('G')">G</button>
                    <button class="keyboard-key" onclick="typeStage2Key('H')">H</button>
                    <button class="keyboard-key" onclick="typeStage2Key('J')">J</button>
                    <button class="keyboard-key" onclick="typeStage2Key('K')">K</button>
                    <button class="keyboard-key" onclick="typeStage2Key('L')">L</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('Z')">Z</button>
                    <button class="keyboard-key" onclick="typeStage2Key('X')">X</button>
                    <button class="keyboard-key" onclick="typeStage2Key('C')">C</button>
                    <button class="keyboard-key" onclick="typeStage2Key('V')">V</button>
                    <button class="keyboard-key" onclick="typeStage2Key('B')">B</button>
                    <button class="keyboard-key" onclick="typeStage2Key('N')">N</button>
                    <button class="keyboard-key" onclick="typeStage2Key('M')">M</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key backspace" onclick="backspaceStage2Key()">‚å´ Delete</button>
                    <button class="keyboard-key space" onclick="typeStage2Key(' ')">Space</button>
                    <button class="keyboard-key enter" onclick="submitStage2Answer()">‚úì Enter</button>
                </div>
            </div>
            
            <div id="stage2-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
}

function startStage2Timer() {
    if (stage2Timer) clearInterval(stage2Timer);
    
    stage2Timer = setInterval(() => {
        stage2TimeLeft--;
        
        const minutes = Math.floor(stage2TimeLeft / 60);
        const seconds = stage2TimeLeft % 60;
        document.getElementById('stage2-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (stage2TimeLeft <= 60) {
            document.getElementById('stage2-timer').style.color = '#dc3545';
        }
        
        if (stage2TimeLeft <= 0) {
            clearInterval(stage2Timer);
            completeStage2();
        }
    }, 1000);
}

function loadStage2Word() {
    if (stage2CurrentIndex >= stage2Words.length) {
        completeStage2();
        return;
    }
    
    document.getElementById('stage2-progress').textContent = 
        `Word ${stage2CurrentIndex + 1} of ${stage2Words.length}`;
    
    document.getElementById('stage2-input').value = '';
    document.getElementById('stage2-feedback').innerHTML = '';
    
    // Auto-play word
    setTimeout(() => speakStage2Word(), 500);
}

function speakStage2Word() {
    const word = stage2Words[stage2CurrentIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage2Sentence() {
    const word = stage2Words[stage2CurrentIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage2Word();
    }
}

function typeStage2Key(letter) {
    const input = document.getElementById('stage2-input');
    input.value += letter.toLowerCase();
}

function backspaceStage2Key() {
    const input = document.getElementById('stage2-input');
    input.value = input.value.slice(0, -1);
}

function submitStage2Answer() {
    const userAnswer = document.getElementById('stage2-input').value.trim().toLowerCase();
    const correctWord = stage2Words[stage2CurrentIndex].toLowerCase();
    const feedbackDiv = document.getElementById('stage2-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">‚ö†Ô∏è Please type a word</div>';
        return;
    }
    
    const isCorrect = userAnswer === correctWord;
    
    if (isCorrect) {
        stage2Score++;
        feedbackDiv.innerHTML = '<div class="feedback success">‚úÖ Correct!</div>';
        document.getElementById('stage2-score').textContent = stage2Score;
        
        setTimeout(() => {
            stage2CurrentIndex++;
            loadStage2Word();
        }, 1000);
        
    } else {
        stage2Errors++;
        document.getElementById('stage2-errors').textContent = stage2Errors;
        
        // Check elimination
        if (stage2Errors >= 1 && stage2HandicapsRemaining === 0) {
            feedbackDiv.innerHTML = `<div class="feedback error">‚ùå Eliminated! Wrong spelling. Correct: ${correctWord}</div>`;
            setTimeout(() => eliminateFromStage2(), 2000);
        } else if (stage2Errors >= 1 && stage2HandicapsRemaining > 0) {
            // Use handicap
            stage2HandicapsRemaining--;
            stage2Errors = 0;
            document.getElementById('stage2-handicaps').textContent = stage2HandicapsRemaining;
            document.getElementById('stage2-errors').textContent = stage2Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå Wrong! Correct: ${correctWord}<br>
                    üõ°Ô∏è Handicap used! Errors reset. Handicaps remaining: ${stage2HandicapsRemaining}
                </div>
            `;
            
            setTimeout(() => {
                stage2CurrentIndex++;
                loadStage2Word();
            }, 2000);
        }
    }
}

function completeStage2() {
    clearInterval(stage2Timer);
    
    const container = document.getElementById('tournament-stage2');
    const percentage = Math.round((stage2Score / stage2Words.length) * 100);
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'üèÜ' : percentage >= 60 ? '‚≠ê' : 'üìö'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 2 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage2Score} / ${stage2Words.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                üõ°Ô∏è Handicaps Remaining: ${stage2HandicapsRemaining}
            </p>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ Qualified for Stage 3!</h3>
                    <p style="color: #155724;">
                        You'll carry ${stage2HandicapsRemaining} handicap(s) into Stage 3.
                    </p>
                </div>
                <button class="practice-btn" onclick="proceedToStage3()" style="font-size: 1.2rem; padding: 15px 40px;">
                    ‚û°Ô∏è Proceed to Stage 3
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">‚ùå Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance to Stage 3.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    üè† Return to Lobby
                </button>
            `}
        </div>
    `;
}

function eliminateFromStage2() {
    clearInterval(stage2Timer);
    
    const container = document.getElementById('tournament-stage2');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üò¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 2</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                One error with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage2Score} / ${stage2CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                üè† Return to Lobby
            </button>
        </div>
    `;
}


     

async function proceedToStage3() {
    try {
        console.log('üéØ Starting Stage 3: Spelling Challenge');
        
        tournamentStage = 3;
        stage3CurrentIndex = 0;
        stage3Score = 0;
        stage3Errors = 0;
        stage3TimeLeft = 900;
        stage3HandicapsRemaining = stage2HandicapsRemaining; // Carry from Stage 2
        
        // Hide Stage 2
        document.getElementById('tournament-stage2').style.display = 'none';
        
        // Create Stage 3 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage3Container = document.getElementById('tournament-stage3');
        
        if (!stage3Container) {
            stage3Container = document.createElement('div');
            stage3Container.id = 'tournament-stage3';
            tournamentsSection.appendChild(stage3Container);
        }
        
        stage3Container.style.display = 'block';
        stage3Container.innerHTML = '<div class="loading">üìö Loading Stage 3 words...</div>';
        
        // Generate words
        await generateStage3Words();
        
        // Build UI
        buildStage3UI();
        
        // Start timer
        startStage3Timer();
        
        // Load first word
        loadStage3Word();
        
    } catch (error) {
        console.error('Error starting Stage 3:', error);
        alert('Failed to start Stage 3: ' + error.message);
    }
}

async function generateStage3Words() {
    try {
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select 25 random words for unscrambling
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        stage3Words = shuffled.slice(0, 25);
        
        console.log('‚úÖ Generated 25 words for Stage 3:', stage3Words);
        
    } catch (error) {
        console.error('Error generating Stage 3 words:', error);
        throw error;
    }
}

function buildStage3UI() {
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: #0d3b66; margin: 0;">üî§ Stage 3: Unscramble Challenge</h2>
                <button class="practice-btn" onclick="exitTournament()" style="background: #dc3545; padding: 10px 20px;">
                    üö™ Exit
                </button>
            </div>
            
            <!-- Timer and Stats -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚è±Ô∏è Time Remaining</div>
                    <div id="stage3-timer" style="font-size: 2rem; font-weight: bold; color: #0d3b66;">15:00</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚úÖ Correct</div>
                    <div id="stage3-score" style="font-size: 2rem; font-weight: bold; color: #28a745;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">‚ùå Errors</div>
                    <div id="stage3-errors" style="font-size: 2rem; font-weight: bold; color: #dc3545;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">üõ°Ô∏è Handicaps</div>
                    <div id="stage3-handicaps" style="font-size: 2rem; font-weight: bold; color: #667eea;">${stage3HandicapsRemaining}</div>
                </div>
            </div>
            
            <h3 id="stage3-progress">Word 1 of 25</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                
                <div id="stage3-letter-tiles" class="letter-tiles-container">
                    <!-- Letter tiles will be inserted here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="shuffleStage3Letters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                        üîÄ Shuffle
                    </button>
                    
                    <button class="practice-btn" onclick="submitStage3Answer()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ‚úì Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="stage3-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
}

function startStage3Timer() {
    if (stage3Timer) clearInterval(stage3Timer);
    
    stage3Timer = setInterval(() => {
        stage3TimeLeft--;
        
        const minutes = Math.floor(stage3TimeLeft / 60);
        const seconds = stage3TimeLeft % 60;
        document.getElementById('stage3-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (stage3TimeLeft <= 60) {
            document.getElementById('stage3-timer').style.color = '#dc3545';
        }
        
        if (stage3TimeLeft <= 0) {
            clearInterval(stage3Timer);
            completeStage3();
        }
    }, 1000);
}

function loadStage3Word() {
    if (stage3CurrentIndex >= stage3Words.length) {
        completeStage3();
        return;
    }
    
    const word = stage3Words[stage3CurrentIndex];
    
    document.getElementById('stage3-progress').textContent = 
        `Word ${stage3CurrentIndex + 1} of ${stage3Words.length}`;
    
    document.getElementById('stage3-feedback').innerHTML = '';
    
    // Scramble the letters
    shuffleStage3Letters();
}

function shuffleStage3Letters() {
    const word = stage3Words[stage3CurrentIndex];
    const letters = word.split('');
    let scrambled = [...letters];
    
    // Shuffle the array
    let attempts = 0;
    do {
        for (let i = scrambled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
        }
        attempts++;
    } while (scrambled.join('') === word && attempts < 10);
    
    stage3CurrentLetterOrder = scrambled;
    renderStage3LetterTiles();
}

function renderStage3LetterTiles() {
    const container = document.getElementById('stage3-letter-tiles');
    container.innerHTML = '';
    
    stage3CurrentLetterOrder.forEach((letter, index) => {
        const tile = document.createElement('div');
        tile.className = 'letter-tile';
        tile.textContent = letter.toUpperCase();
        tile.draggable = true;
        tile.dataset.index = index;
        
        // Drag events
        tile.addEventListener('dragstart', handleStage3DragStart);
        tile.addEventListener('dragend', handleStage3DragEnd);
        tile.addEventListener('dragover', handleStage3DragOver);
        tile.addEventListener('drop', handleStage3Drop);
        tile.addEventListener('dragenter', handleStage3DragEnter);
        tile.addEventListener('dragleave', handleStage3DragLeave);
        
        // Touch events for mobile
        tile.addEventListener('touchstart', handleStage3TouchStart, { passive: false });
        tile.addEventListener('touchmove', handleStage3TouchMove, { passive: false });
        tile.addEventListener('touchend', handleStage3TouchEnd);
        
        container.appendChild(tile);
    });
}

function handleStage3DragStart(e) {
    stage3DraggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleStage3DragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
}

function handleStage3DragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleStage3DragEnter(e) {
    if (this !== stage3DraggedElement) {
        this.classList.add('drag-over');
    }
}

function handleStage3DragLeave(e) {
    this.classList.remove('drag-over');
}

function handleStage3Drop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    this.classList.remove('drag-over');
    
    if (stage3DraggedElement !== this) {
        const draggedIndex = parseInt(stage3DraggedElement.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        
        [stage3CurrentLetterOrder[draggedIndex], stage3CurrentLetterOrder[targetIndex]] = 
        [stage3CurrentLetterOrder[targetIndex], stage3CurrentLetterOrder[draggedIndex]];
        
        renderStage3LetterTiles();
    }
    
    return false;
}

// Touch support for mobile
let stage3TouchTarget = null;
let stage3TouchClone = null;

function handleStage3TouchStart(e) {
    e.preventDefault();
    stage3TouchTarget = this;
    this.classList.add('dragging');
    
    stage3TouchClone = this.cloneNode(true);
    stage3TouchClone.style.position = 'fixed';
    stage3TouchClone.style.zIndex = '10000';
    stage3TouchClone.style.pointerEvents = 'none';
    stage3TouchClone.style.opacity = '0.8';
    document.body.appendChild(stage3TouchClone);
    
    updateStage3TouchClonePosition(e.touches[0]);
}

function handleStage3TouchMove(e) {
    e.preventDefault();
    if (!stage3TouchTarget) return;
    
    updateStage3TouchClonePosition(e.touches[0]);
    
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== stage3TouchTarget) {
        elementBelow.classList.add('drag-over');
    }
}

function handleStage3TouchEnd(e) {
    e.preventDefault();
    if (!stage3TouchTarget) return;
    
    stage3TouchTarget.classList.remove('dragging');
    
    if (stage3TouchClone) {
        stage3TouchClone.remove();
        stage3TouchClone = null;
    }
    
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== stage3TouchTarget) {
        const draggedIndex = parseInt(stage3TouchTarget.dataset.index);
        const targetIndex = parseInt(elementBelow.dataset.index);
        
        [stage3CurrentLetterOrder[draggedIndex], stage3CurrentLetterOrder[targetIndex]] = 
        [stage3CurrentLetterOrder[targetIndex], stage3CurrentLetterOrder[draggedIndex]];
        
        renderStage3LetterTiles();
    }
    
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    stage3TouchTarget = null;
}

function updateStage3TouchClonePosition(touch) {
    if (stage3TouchClone) {
        stage3TouchClone.style.left = (touch.clientX - 30) + 'px';
        stage3TouchClone.style.top = (touch.clientY - 30) + 'px';
    }
}

function submitStage3Answer() {
    const userWord = stage3CurrentLetterOrder.join('').toLowerCase();
    const correctWord = stage3Words[stage3CurrentIndex].toLowerCase();
    const feedbackDiv = document.getElementById('stage3-feedback');
    
    if (userWord === correctWord) {
        stage3Score++;
        feedbackDiv.innerHTML = '<div class="feedback success">‚úÖ Correct!</div>';
        document.getElementById('stage3-score').textContent = stage3Score;
        
        setTimeout(() => {
            stage3CurrentIndex++;
            loadStage3Word();
        }, 1000);
        
    } else {
        stage3Errors++;
        document.getElementById('stage3-errors').textContent = stage3Errors;
        
        // Check elimination
        if (stage3Errors >= 1 && stage3HandicapsRemaining === 0) {
            feedbackDiv.innerHTML = `<div class="feedback error">‚ùå Eliminated! Wrong word. Correct: ${correctWord}</div>`;
            setTimeout(() => eliminateFromStage3(), 2000);
        } else if (stage3Errors >= 1 && stage3HandicapsRemaining > 0) {
            // Use handicap
            stage3HandicapsRemaining--;
            stage3Errors = 0;
            document.getElementById('stage3-handicaps').textContent = stage3HandicapsRemaining;
            document.getElementById('stage3-errors').textContent = stage3Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    ‚ùå Wrong! Correct: ${correctWord}<br>
                    üõ°Ô∏è Handicap used! Errors reset. Handicaps remaining: ${stage3HandicapsRemaining}
                </div>
            `;
            
            setTimeout(() => {
                stage3CurrentIndex++;
                loadStage3Word();
            }, 2000);
        }
    }
}

function completeStage3() {
    clearInterval(stage3Timer);
    
    const container = document.getElementById('tournament-stage3');
    const percentage = Math.round((stage3Score / stage3Words.length) * 100);
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'üèÜ' : percentage >= 60 ? '‚≠ê' : 'üìö'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 3 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage3Score} / ${stage3Words.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                üõ°Ô∏è Handicaps Remaining: ${stage3HandicapsRemaining}
            </p>
            
            ${percentage >= 60 ? `
                <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #155724; margin-bottom: 10px;">‚úÖ Qualified for Stage 4!</h3>
                    <p style="color: #155724;">
                        Congratulations! You've reached the Live Spell Master rounds.<br>
                        <strong>Next:</strong> Top 10 compete with live human caller
                    </p>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404; margin: 0 0 15px 0;">üé≠ Choose Your Role:</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <button class="practice-btn" onclick="joinAsSpeller()" style="background: #667eea; font-size: 1rem; padding: 15px;">
                            üéØ Join as Speller
                        </button>
                        <button class="practice-btn" onclick="joinAsCaller()" style="background: #764ba2; font-size: 1rem; padding: 15px;">
                            üé§ Join as Caller
                        </button>
                    </div>
                    <p style="color: #856404; margin: 15px 0 0 0; font-size: 0.9rem;">
                        ‚ÑπÔ∏è <strong>Speller:</strong> Compete to spell words correctly<br>
                        ‚ÑπÔ∏è <strong>Caller:</strong> Read words aloud for spellers
                    </p>
                </div>
                
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d;">
                    üè† Return to Lobby
                </button>
            ` : `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #721c24; margin-bottom: 10px;">‚ùå Did Not Qualify</h3>
                    <p style="color: #721c24;">
                        You need at least 60% accuracy to advance to the Live Rounds.
                    </p>
                </div>
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px;">
                    üè† Return to Lobby
                </button>
            `}
        </div>
    `;
}

function eliminateFromStage3() {
    clearInterval(stage3Timer);
    
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">üò¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 3</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                One error with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage3Score} / ${stage3CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                üè† Return to Lobby
            </button>
        </div>
    `;
}

// Update exitTournament to handle all stages
function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    if (stage2Timer) clearInterval(stage2Timer);
    if (stage3Timer) clearInterval(stage3Timer);
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    const stage2 = document.getElementById('tournament-stage2');
    if (stage2) stage2.style.display = 'none';
    
    const stage3 = document.getElementById('tournament-stage3');
    if (stage3) stage3.style.display = 'none';
    
    loadTournamentList();
} 


 async function joinAsSpeller() {
    callerMode = false;
    
    // Show waiting room
    const container = document.getElementById('tournament-stage3');
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin: 20px 0; animation: pulse 2s infinite;">‚è≥</div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Waiting for Stage 4 to Begin...</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You've joined as a <strong style="color: #667eea;">SPELLER</strong>
            </p>
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 15px;">üìã Stage 4: Live Spell Master (Top 10)</h3>
                <p style="color: #666; line-height: 1.8;">
                    ‚Ä¢ Live human caller will read words<br>
                    ‚Ä¢ One mistake = eliminated (unless you have a Shield)<br>
                    ‚Ä¢ Top 10 spellers advance<br>
                    ‚Ä¢ 5-minute break after this round
                </p>
            </div>
            <div class="loading">Waiting for a caller to start the round...</div>
            
            <button class="practice-btn" onclick="exitTournament()" style="margin-top: 20px; background: #6c757d;">
                üö™ Leave Waiting Room
            </button>
        </div>
    `;
    
    // In a real implementation, this would connect to a live session
    // For demo purposes, we'll simulate
    setTimeout(() => {
        alert('‚è∞ In a live tournament, you would wait here for a caller to start Stage 4.\n\nFor demo purposes, the caller interface is available by choosing "Join as Caller".');
    }, 2000);
}

async function joinAsCaller() {
    callerMode = true;
    
    try {
        // Hide Stage 3
        document.getElementById('tournament-stage3').style.display = 'none';
        
        // Generate words for Stage 4
        await generateLiveStageWords(10); // 10 words for Stage 4
        
        // Show caller interface
        startStage4AsCaller();
        
    } catch (error) {
        console.error('Error starting as caller:', error);
        alert('Failed to start as caller: ' + error.message);
    }
}

  async function generateLiveStageWords(count) {
    try {
        if (!selectedGameLevel) {
            selectedGameLevel = 'championship'; // Use hardest level for finals
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        liveStageWords = shuffled.slice(0, count);
        
        console.log(`‚úÖ Generated ${count} words for live stage:`, liveStageWords);
        
    } catch (error) {
        console.error('Error generating live stage words:', error);
        throw error;
    }
}

 function startStage4AsCaller() {
    tournamentStage = 4;
    currentLiveStageIndex = 0;
    liveStageParticipants = ['Demo Player 1', 'Demo Player 2', 'Demo Player 3']; // Simulated players
    eliminatedPlayers = [];
    
    const tournamentsSection = document.querySelector('#tournaments-section .word-database');
    let stage4Container = document.getElementById('tournament-stage4');
    
    if (!stage4Container) {
        stage4Container = document.createElement('div');
        stage4Container.id = 'tournament-stage4';
        tournamentsSection.appendChild(stage4Container);
    }
    
    stage4Container.style.display = 'block';
    
    buildStage4CallerUI();
}

function buildStage4CallerUI() {
    const container = document.getElementById('tournament-stage4');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">üé§ Stage 4: Live Spell Master (Caller Mode)</h2>
                <p style="margin: 0; opacity: 0.9;">You are the human caller for this round</p>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">üë• Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #d4edda; padding: 10px 20px; border-radius: 20px; color: #155724; font-weight: bold;">
                            ‚úÖ ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">‚ùå Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: white;">üìù Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="caller-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length ? `
                    <button class="practice-btn" onclick="speakCallerWord()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        üîä Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakCallerSentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        üí¨ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="caller-controls">
                ${currentLiveStageIndex < liveStageWords.length ? `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 15px 0;">üìã Caller Instructions:</h4>
                        <ol style="color: #856404; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Pronounce the word clearly</li>
                            <li>Use it in a sentence if requested</li>
                            <li>Mark each speller as correct or incorrect</li>
                            <li>One mistake eliminates a speller (unless they have a Shield)</li>
                        </ol>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markSpellerCorrect(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚úÖ Correct
                                    </button>
                                    <button class="practice-btn" onclick="markSpellerIncorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚ùå Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextCallerWord()" style="font-size: 1.2rem; padding: 15px 40px; background: #667eea;">
                            ‚û°Ô∏è Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 4 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} spellers advance to Stage 5
                        </p>
                        
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3 style="color: #155724; margin-bottom: 15px;">‚úÖ Qualified for Stage 5:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                ${liveStageParticipants.map(player => `
                                    <div style="background: white; padding: 15px 25px; border-radius: 10px; color: #155724; font-weight: bold; font-size: 1.1rem;">
                                        üåü ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage5()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            ‚û°Ô∏è Proceed to Stage 5 (Top 5)
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            üè† Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}   

    // ===== TOURNAMENT STAGE 5 FUNCTIONS (Top 10 ‚Üí Top 5) =====

async function proceedToStage5() {
    try {
        console.log('üéØ Starting Stage 5: Live Spell Master (Top 10 ‚Üí Top 5)');
        
        tournamentStage = 5;
        currentLiveStageIndex = 0;
        
        // Keep current participants from Stage 4
        if (liveStageParticipants.length > 10) {
            liveStageParticipants = liveStageParticipants.slice(0, 10);
        }
        
        eliminatedPlayers = [];
        
        // Generate words for Stage 5
        await generateLiveStageWords(15); // 15 words for Stage 5
        
        // Hide Stage 4
        const stage4 = document.getElementById('tournament-stage4');
        if (stage4) stage4.style.display = 'none';
        
        // Create Stage 5 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage5Container = document.getElementById('tournament-stage5');
        
        if (!stage5Container) {
            stage5Container = document.createElement('div');
            stage5Container.id = 'tournament-stage5';
            tournamentsSection.appendChild(stage5Container);
        }
        
        stage5Container.style.display = 'block';
        
        // Show caller interface for Stage 5
        buildStage5CallerUI();
        
    } catch (error) {
        console.error('Error starting Stage 5:', error);
        alert('Failed to start Stage 5: ' + error.message);
    }
}

function buildStage5CallerUI() {
    const container = document.getElementById('tournament-stage5');
    const targetCount = 5; // Advance top 5
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">üé§ Stage 5: Live Spell Master (Top 10 ‚Üí Top 5)</h2>
                <p style="margin: 0; opacity: 0.9;">Spell until ${targetCount} spellers remain</p>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666; font-weight: bold;">Active: ${liveStageParticipants.length}</span>
                    <span style="color: #667eea; font-weight: bold;">Target: ${targetCount}</span>
                    <span style="color: #dc3545; font-weight: bold;">Eliminated: ${eliminatedPlayers.length}</span>
                </div>
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${((liveStageParticipants.length / 10) * 100)}%; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">üë• Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #d4edda; padding: 10px 20px; border-radius: 20px; color: #155724; font-weight: bold;">
                            ‚úÖ ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">‚ùå Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: white;">üìù Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="stage5-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length && liveStageParticipants.length > targetCount ? `
                    <button class="practice-btn" onclick="speakStage5Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        üîä Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage5Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        üí¨ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="stage5-caller-controls">
                ${liveStageParticipants.length > targetCount && currentLiveStageIndex < liveStageWords.length ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markStage5Correct(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚úÖ Correct
                                    </button>
                                    <button class="practice-btn" onclick="markStage5Incorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚ùå Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextStage5Word()" style="font-size: 1.2rem; padding: 15px 40px; background: #667eea;">
                            ‚û°Ô∏è Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 5 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} spellers advance to Stage 6
                        </p>
                        
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3 style="color: #155724; margin-bottom: 15px;">‚úÖ Qualified for Stage 6:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                ${liveStageParticipants.map(player => `
                                    <div style="background: white; padding: 15px 25px; border-radius: 10px; color: #155724; font-weight: bold; font-size: 1.1rem;">
                                        üåü ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage6()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            ‚û°Ô∏è Proceed to Stage 6 (Top 5 ‚Üí Top 3)
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            üè† Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function speakStage5Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage5Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage5Word();
    }
}

function markStage5Correct(playerIndex) {
    // Player stays in the game
    console.log(`‚úÖ ${liveStageParticipants[playerIndex]} spelled correctly`);
}

function markStage5Incorrect(playerIndex) {
    const player = liveStageParticipants[playerIndex];
    
    if (confirm(`‚ùå Are you sure ${player} spelled incorrectly? This will eliminate them.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(playerIndex, 1);
        
        // Rebuild UI
        buildStage5CallerUI();
    }
}

function nextStage5Word() {
    currentLiveStageIndex++;
    
    if (liveStageParticipants.length <= 5) {
        // Reached target - complete stage
        buildStage5CallerUI();
    } else if (currentLiveStageIndex >= liveStageWords.length) {
        // Ran out of words but still too many players - generate more
        alert('‚ö†Ô∏è Need more words! Generating additional words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage5CallerUI();
        });
    } else {
        // Continue to next word
        buildStage5CallerUI();
    }
}

// ===== TOURNAMENT STAGE 6 FUNCTIONS (Top 5 ‚Üí Top 3) =====

async function proceedToStage6() {
    try {
        console.log('üéØ Starting Stage 6: Live Spell Master (Top 5 ‚Üí Top 3)');
        
        tournamentStage = 6;
        currentLiveStageIndex = 0;
        
        // Keep top 5 from Stage 5
        if (liveStageParticipants.length > 5) {
            liveStageParticipants = liveStageParticipants.slice(0, 5);
        }
        
        eliminatedPlayers = [];
        
        // Generate words for Stage 6
        await generateLiveStageWords(12); // 12 words for Stage 6
        
        // Hide Stage 5
        const stage5 = document.getElementById('tournament-stage5');
        if (stage5) stage5.style.display = 'none';
        
        // Create Stage 6 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage6Container = document.getElementById('tournament-stage6');
        
        if (!stage6Container) {
            stage6Container = document.createElement('div');
            stage6Container.id = 'tournament-stage6';
            tournamentsSection.appendChild(stage6Container);
        }
        
        stage6Container.style.display = 'block';
        
        // Show caller interface for Stage 6
        buildStage6CallerUI();
        
    } catch (error) {
        console.error('Error starting Stage 6:', error);
        alert('Failed to start Stage 6: ' + error.message);
    }
}

function buildStage6CallerUI() {
    const container = document.getElementById('tournament-stage6');
    const targetCount = 3; // Advance top 3
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: #0d3b66;">
                <h2 style="margin: 0 0 10px 0;">üé§ Stage 6: Live Spell Master (Top 5 ‚Üí Top 3)</h2>
                <p style="margin: 0; opacity: 0.9;">Spell until ${targetCount} finalists remain</p>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666; font-weight: bold;">Active: ${liveStageParticipants.length}</span>
                    <span style="color: #FFD700; font-weight: bold;">Target: ${targetCount}</span>
                    <span style="color: #dc3545; font-weight: bold;">Eliminated: ${eliminatedPlayers.length}</span>
                </div>
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #FFD700, #FFA500); height: 100%; width: ${((liveStageParticipants.length / 5) * 100)}%; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">üë• Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #fff3cd; padding: 10px 20px; border-radius: 20px; color: #856404; font-weight: bold; border: 2px solid #FFD700;">
                            ‚≠ê ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">‚ùå Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: #0d3b66; text-align: center;">
                <h3 style="margin: 0 0 15px 0;">üìù Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="stage6-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length && liveStageParticipants.length > targetCount ? `
                    <button class="practice-btn" onclick="speakStage6Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        üîä Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage6Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        üí¨ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="stage6-caller-controls">
                ${liveStageParticipants.length > targetCount && currentLiveStageIndex < liveStageWords.length ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #FFD700; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">‚≠ê ${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markStage6Correct(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚úÖ Correct
                                    </button>
                                    <button class="practice-btn" onclick="markStage6Incorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        ‚ùå Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextStage6Word()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #0d3b66;">
                            ‚û°Ô∏è Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üèÜ</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 6 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} finalists advance to the <strong>FINAL SPELL-OFF</strong>
                        </p>
                        
                        <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 30px; border-radius: 15px; margin: 20px 0;">
                            <h3 style="margin-bottom: 15px; color: #0d3b66;">üåü FINALISTS:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                                ${liveStageParticipants.map((player, idx) => `
                                    <div style="background: white; padding: 20px 30px; border-radius: 15px; color: #0d3b66; font-weight: bold; font-size: 1.2rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                                        ${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'} ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage7()" style="font-size: 1.3rem; padding: 20px 50px; margin: 10px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #0d3b66; font-weight: bold;">
                            üèÜ START FINAL SPELL-OFF
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            üè† Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function speakStage6Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage6Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage6Word();
    }
}

function markStage6Correct(playerIndex) {
    console.log(`‚úÖ ${liveStageParticipants[playerIndex]} spelled correctly`);
}

function markStage6Incorrect(playerIndex) {
    const player = liveStageParticipants[playerIndex];
    
    if (confirm(`‚ùå Are you sure ${player} spelled incorrectly? This will eliminate them from the finals.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(playerIndex, 1);
        
        buildStage6CallerUI();
    }
}

function nextStage6Word() {
    currentLiveStageIndex++;
    
    if (liveStageParticipants.length <= 3) {
        buildStage6CallerUI();
    } else if (currentLiveStageIndex >= liveStageWords.length) {
        alert('‚ö†Ô∏è Need more words! Generating additional words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage6CallerUI();
        });
    } else {
        buildStage6CallerUI();
    }
}

// ===== TOURNAMENT STAGE 7 FUNCTIONS (Final Spell-Off: Top 3 ‚Üí Champion) =====

async function proceedToStage7() {
    try {
        console.log('üèÜ Starting Stage 7: FINAL SPELL-OFF');
        
        tournamentStage = 7;
        currentLiveStageIndex = 0;
        currentSpellerIndex = 0;
        
        // Keep top 3 from Stage 6
        if (liveStageParticipants.length > 3) {
            liveStageParticipants = liveStageParticipants.slice(0, 3);
        }
        
        eliminatedPlayers = [];
        finalRoundSpelling = null;
        
        // Generate words for Final Round (championship level)
        selectedGameLevel = 'championship';
        await generateLiveStageWords(20); // 20 championship words
        
        // Hide Stage 6
        const stage6 = document.getElementById('tournament-stage6');
        if (stage6) stage6.style.display = 'none';
        
        // Create Stage 7 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage7Container = document.getElementById('tournament-stage7');
        
        if (!stage7Container) {
            stage7Container = document.createElement('div');
            stage7Container.id = 'tournament-stage7';
            tournamentsSection.appendChild(stage7Container);
        }
        
        stage7Container.style.display = 'block';
        
        // Show final spell-off interface
        buildStage7UI();
        
    } catch (error) {
        console.error('Error starting Stage 7:', error);
        alert('Failed to start Final Spell-Off: ' + error.message);
    }
}

// ===== COMPLETE STAGE 7 FUNCTIONS =====

function buildStage7UI() {
    const container = document.getElementById('tournament-stage7');
    
    // Check if we have a winner
    if (liveStageParticipants.length === 1) {
        showTournamentWinner();
        return;
    }
    
    const currentSpeller = liveStageParticipants[currentSpellerIndex];
    const currentWord = liveStageWords[currentLiveStageIndex];
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 20px; color: white; text-align: center;">
                <h1 style="margin: 0 0 10px 0; color: white; font-size: 2.5rem;">üèÜ FINAL SPELL-OFF üèÜ</h1>
                <p style="margin: 0; opacity: 0.9; font-size: 1.2rem;">Classic Turn-Based Spelling ‚Ä¢ One Wrong Disqualifies</p>
            </div>
            
            <!-- Remaining Finalists -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0; text-align: center;">üåü Remaining Finalists (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    ${liveStageParticipants.map((player, idx) => `
                        <div style="background: ${player === currentSpeller ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'white'}; padding: 20px 30px; border-radius: 15px; color: #0d3b66; font-weight: bold; font-size: 1.2rem; border: 3px solid ${player === currentSpeller ? '#FFD700' : '#e0e0e0'}; box-shadow: ${player === currentSpeller ? '0 5px 20px rgba(255,215,0,0.5)' : '0 2px 8px rgba(0,0,0,0.1)'}; transition: all 0.3s;">
                            ${player === currentSpeller ? '‚û§ ' : ''}${player}${player === currentSpeller ? ' ‚¨ÖÔ∏è' : ''}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0; text-align: center;">‚ùå Eliminated</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Turn -->
            <div style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: #0d3b66; text-align: center;">
                <h3 style="margin: 0 0 15px 0;">üéØ ${currentSpeller}'s Turn</h3>
                <div style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentWord.toUpperCase()}
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="speakStage7Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        üîä Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage7Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        üí¨ Use in Sentence
                    </button>
                </div>
            </div>
            
            <!-- Caller Controls -->
            <div style="text-align: center; margin: 30px 0;">
                <h4 style="color: #0d3b66; margin-bottom: 20px;">Did ${currentSpeller} spell "${currentWord}" correctly?</h4>
                <div style="display: flex; gap: 20px; justify-content: center;">
                    <button class="practice-btn" onclick="markStage7Correct()" style="background: #28a745; font-size: 1.2rem; padding: 15px 40px;">
                        ‚úÖ CORRECT
                    </button>
                    <button class="practice-btn" onclick="markStage7Incorrect()" style="background: #dc3545; font-size: 1.2rem; padding: 15px 40px;">
                        ‚ùå WRONG
                    </button>
                </div>
            </div>
        </div>
    `;
}

function speakStage7Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage7Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage7Word();
    }
}

function markStage7Correct() {
    console.log(`‚úÖ ${liveStageParticipants[currentSpellerIndex]} spelled correctly`);
    
    // Move to next speller
    currentSpellerIndex++;
    if (currentSpellerIndex >= liveStageParticipants.length) {
        currentSpellerIndex = 0; // Loop back to first speller
        currentLiveStageIndex++; // New word for next round
    }
    
    // Check if we ran out of words
    if (currentLiveStageIndex >= liveStageWords.length) {
        alert('‚ö†Ô∏è Need more words! Generating additional championship words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage7UI();
        });
    } else {
        buildStage7UI();
    }
}

function markStage7Incorrect() {
    const player = liveStageParticipants[currentSpellerIndex];
    
    if (confirm(`‚ùå Are you sure ${player} spelled incorrectly? This will eliminate them from the finals.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(currentSpellerIndex, 1);
        
        // Adjust current speller index
        if (currentSpellerIndex >= liveStageParticipants.length) {
            currentSpellerIndex = 0;
        }
        
        // Check if we have a winner
        if (liveStageParticipants.length === 1) {
            showTournamentWinner();
        } else {
            // Move to next word
            currentLiveStageIndex++;
            buildStage7UI();
        }
    }
}

function showTournamentWinner() {
    const container = document.getElementById('tournament-stage7');
    const winner = liveStageParticipants[0];
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 50px; background: linear-gradient(135deg, #FFD700, #FFA500);">
            <div style="font-size: 6rem; margin-bottom: 30px; animation: bounce 2s infinite;">üèÜ</div>
            
            <h1 style="color: #0d3b66; font-size: 3rem; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                SPELLING CHAMPION
            </h1>
            
            <div style="background: white; padding: 40px; border-radius: 20px; margin: 30px 0; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                <div style="font-size: 2.5rem; font-weight: bold; color: #0d3b66; margin-bottom: 20px;">
                    üåü ${winner} üåü
                </div>
                <p style="font-size: 1.3rem; color: #666; margin: 15px 0;">
                    Conquered all 7 stages to become the ultimate spelling champion!
                </p>
            </div>
            
            <div style="background: rgba(255,255,255,0.9); padding: 30px; border-radius: 15px; margin: 30px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 20px;">üéØ Tournament Journey</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 1</div>
                        <div style="color: #666; font-size: 0.9rem;">Antonym/Synonym</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 2</div>
                        <div style="color: #666; font-size: 0.9rem;">AI Audio Spelling</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 3</div>
                        <div style="color: #666; font-size: 0.9rem;">Unscramble</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 4</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 10</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 5</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 5</div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #155724;">Stage 6</div>
                        <div style="color: #666; font-size: 0.9rem;">Top 3</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 15px; border-radius: 10px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66;">Stage 7</div>
                        <div style="color: #0d3b66; font-size: 0.9rem; font-weight: bold;">üèÜ CHAMPION</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 40px;">
                <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.3rem; padding: 20px 50px; background: white; color: #0d3b66; font-weight: bold;">
                    üè† Return to Lobby
                </button>
            </div>
        </div>
    `;
    
    // Add bounce animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
    `;
    document.head.appendChild(style);
}




// ===== ADMIN CONFIGURATION =====
// ===== ADMIN CONFIGURATION =====
const ADMIN_EMAIL = 'carlanviroberts@gmail.com'; // ‚ö†Ô∏è CHANGE THIS TO YOUR ADMIN EMAIL
let isAdmin = false;

// Check if current user is admin
async function checkAdminStatus() {
    if (!currentUser) {
        isAdmin = false;
        updateAdminUI();
        console.log('‚ùå No current user - admin status: false');
        return false;
    }
    
    try {
        console.log('üîç Checking admin status for:', currentUser.email);
        console.log('üîç Admin email configured as:', ADMIN_EMAIL);
        
        // Check email directly first
        if (currentUser.email === ADMIN_EMAIL) {
            isAdmin = true;
            console.log('‚úÖ ADMIN DETECTED via email match!');
            updateAdminUI();
            return true;
        }
        
        // Also check Firestore user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            isAdmin = (userData?.email === ADMIN_EMAIL);
            console.log('üìÑ Firestore check - Admin status:', isAdmin);
        } else {
            console.log('‚ö†Ô∏è User document not found in Firestore');
        }
        
        updateAdminUI();
        return isAdmin;
        
    } catch (error) {
        console.error('‚ùå Error checking admin status:', error);
        isAdmin = false;
        updateAdminUI();
        return false;
    }
}

function updateAdminUI() {
    console.log('üîÑ Updating admin UI. isAdmin:', isAdmin);
    
    // Show/hide admin link in sidebar
    const adminLink = document.getElementById('admin-nav-link');
    if (adminLink) {
        adminLink.style.display = isAdmin ? 'block' : 'none';
        console.log('‚úÖ Admin link display set to:', isAdmin ? 'block' : 'none');
    } else {
        console.log('‚ö†Ô∏è Admin link element not found in DOM');
    }
}
// ===== ADMIN TOURNAMENT MANAGEMENT =====

async function loadAdminPanel() {
    if (!isAdmin) {
        document.getElementById('admin-container').innerHTML = `
            <div class="feedback error" style="text-align: center; padding: 40px;">
                ‚ùå <strong>Access Denied</strong><br><br>
                Admin privileges required.<br>
                Current user: ${currentUser ? currentUser.email : 'Not signed in'}
            </div>
        `;
        return;
    }
    
    const container = document.getElementById('admin-container');
    container.innerHTML = '<div class="loading">Loading admin panel...</div>';
    
    try {
        // Load all tournaments
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('createdAt', 'desc')
            .get();
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            tournaments.push({ id: doc.id, ...doc.data() });
        });
        
        container.innerHTML = `
            <div class="admin-panel">
                <!-- Create Tournament Button -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="practice-btn" onclick="showCreateTournamentModal()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2);">
                        ‚ûï Create New Tournament
                    </button>
                </div>
                
                <!-- Tournaments List -->
                <h3 style="color: #0d3b66; margin-bottom: 20px;">üìã Manage Tournaments (${tournaments.length})</h3>
                
                ${tournaments.length === 0 ? `
                    <div class="loading">
                        No tournaments created yet. Click "Create New Tournament" to get started.
                    </div>
                ` : `
                    <div class="coaches-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>üèÜ Tournament</th>
                                    <th>üìÖ Date</th>
                                    <th>üë• Participants</th>
                                    <th>‚öôÔ∏è Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tournaments.map(tournament => `
                                    <tr>
                                        <td>
                                            <div style="font-weight: bold; color: #0d3b66;">${tournament.name}</div>
                                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                                Level: ${tournament.level} ‚Ä¢ Status: ${tournament.status}
                                            </div>
                                        </td>
                                        <td>
                                            <div>${tournament.startDate ? new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not scheduled'}</div>
                                            <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                                ${tournament.startTime || 'Time TBD'}
                                            </div>
                                        </td>
                                        <td style="text-align: center;">
                                            <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #0d3b66;">
                                                ${tournament.participants || 0}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 5px; justify-content: center;">
                                                <button class="practice-btn" onclick="viewTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8;">
                                                    üëÅÔ∏è View
                                                </button>
                                                <button class="practice-btn" onclick="editTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                    ‚úèÔ∏è Edit
                                                </button>
                                                <button class="practice-btn" onclick="deleteTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                                    üóëÔ∏è Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading admin panel:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Failed to load admin panel: ${error.message}
            </div>
        `;
    }
}

        
function showCreateTournamentModal() {
    const modal = document.createElement('div');
    modal.className = 'auth-modal';
    modal.id = 'createTournamentModal';
    modal.style.display = 'block';
    modal.classList.add('active');
    
    modal.innerHTML = `
        <div class="auth-content" style="max-width: 600px;">
            <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h2 style="color: white;">‚ûï Create New Tournament</h2>
                <button class="modal-close" onclick="closeCreateTournamentModal()" style="color: white;">√ó</button>
            </div>
            <div class="auth-body">
                <form id="create-tournament-form" onsubmit="handleCreateTournament(event)">
                    <div class="form-group">
                        <label>Tournament Name *</label>
                        <input type="text" id="tournament-name" required placeholder="e.g., Summer Spelling Championship 2025">
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;" placeholder="Describe the tournament..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty Level *</label>
                        <select id="tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="">Select level</option>
                            <option value="foundation">üå± Foundation</option>
                            <option value="challenge">üéØ Challenge</option>
                            <option value="advanced">üöÄ Advanced</option>
                            <option value="championship">üèÜ Championship</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="tournament-date" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="tournament-time" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Max Participants</label>
                        <input type="number" id="tournament-max-participants" min="10" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="upcoming">üìÖ Upcoming (Open for Registration)</option>
                            <option value="active">‚ñ∂Ô∏è Active (In Progress)</option>
                            <option value="completed">‚úÖ Completed</option>
                            <option value="cancelled">‚ùå Cancelled</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        ‚úÖ Create Tournament
                    </button>
                    
                    <div id="create-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                </form>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeCreateTournamentModal() {
    const modal = document.getElementById('createTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleCreateTournament(event) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('‚ùå Admin access required');
        return;
    }
    
    const name = document.getElementById('tournament-name').value.trim();
    const description = document.getElementById('tournament-description').value.trim();
    const level = document.getElementById('tournament-level').value;
    const date = document.getElementById('tournament-date').value;
    const time = document.getElementById('tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('tournament-max-participants').value);
    const status = document.getElementById('tournament-status').value;
    
    const errorDiv = document.getElementById('create-tournament-error');
    
    try {
        console.log('üìù Creating tournament:', name);
        
        // Create tournament in Firestore
        const tournamentRef = await db.collection('tournaments').add({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            participants: 0,
            registeredUsers: [],
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Tournament created:', tournamentRef.id);
        
        closeCreateTournamentModal();
        
        alert('‚úÖ Tournament created successfully!');
        
        // ‚úÖ Reload admin panel
        await loadAdminPanel();
        
        // ‚úÖ ALSO reload tournament list if we're on tournaments page
        const tournamentsSection = document.getElementById('tournaments-section');
        if (tournamentsSection && tournamentsSection.classList.contains('active')) {
            await loadTournamentList();
        }
        
    } catch (error) {
        console.error('‚ùå Error creating tournament:', error);
        errorDiv.textContent = 'Failed to create tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function viewTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = { id: tournamentDoc.id, ...tournamentDoc.data() };
        
        alert(`
üèÜ ${tournament.name}

üìù Description: ${tournament.description}
üìä Level: ${tournament.level}
üìÖ Date: ${tournament.startDate} at ${tournament.startTime}
üë• Participants: ${tournament.participants} / ${tournament.maxParticipants}
‚ö° Status: ${tournament.status}

Created: ${tournament.createdAt ? new Date(tournament.createdAt.toDate()).toLocaleString() : 'Unknown'}
        `);
        
    } catch (error) {
        console.error('Error viewing tournament:', error);
        alert('Failed to load tournament details');
    }
}

async function editTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Pre-fill edit modal (similar to create modal)
        const modal = document.createElement('div');
        modal.className = 'auth-modal';
        modal.id = 'editTournamentModal';
        modal.style.display = 'block';
        modal.classList.add('active');
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 600px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #ffc107, #ff9800);">
                    <h2 style="color: #0d3b66;">‚úèÔ∏è Edit Tournament</h2>
                    <button class="modal-close" onclick="closeEditTournamentModal()" style="color: #0d3b66;">√ó</button>
                </div>
                <div class="auth-body">
                    <form id="edit-tournament-form" onsubmit="handleEditTournament(event, '${tournamentId}')">
                        <div class="form-group">
                            <label>Tournament Name *</label>
                            <input type="text" id="edit-tournament-name" required value="${tournament.name}">
                        </div>
                        
                        <div class="form-group">
                            <label>Description *</label>
                            <textarea id="edit-tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;">${tournament.description}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Difficulty Level *</label>
                            <select id="edit-tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                                <option value="foundation" ${tournament.level === 'foundation' ? 'selected' : ''}>üå± Foundation</option>
                                <option value="challenge" ${tournament.level === 'challenge' ? 'selected' : ''}>üéØ Challenge</option>
                                <option value="advanced" ${tournament.level === 'advanced' ? 'selected' : ''}>üöÄ Advanced</option>
                                <option value="championship" ${tournament.level === 'championship' ? 'selected' : ''}>üèÜ Championship</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Start Date *</label>
                            <input type="date" id="edit-tournament-date" required value="${tournament.startDate}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Start Time *</label>
                            <input type="time" id="edit-tournament-time" required value="${tournament.startTime}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Max Participants</label>
                            <input type="number" id="edit-tournament-max-participants" min="10" max="100" value="${tournament.maxParticipants}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="edit-tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                                <option value="upcoming" ${tournament.status === 'upcoming' ? 'selected' : ''}>üìÖ Upcoming</option>
                                <option value="active" ${tournament.status === 'active' ? 'selected' : ''}>‚ñ∂Ô∏è Active</option>
                                <option value="completed" ${tournament.status === 'completed' ? 'selected' : ''}>‚úÖ Completed</option>
                                <option value="cancelled" ${tournament.status === 'cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #ffc107, #ff9800); color: #0d3b66;">
                            ‚úÖ Save Changes
                        </button>
                        
                        <div id="edit-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error loading tournament for edit:', error);
        alert('Failed to load tournament: ' + error.message);
    }
}

function closeEditTournamentModal() {
    const modal = document.getElementById('editTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleEditTournament(event, tournamentId) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('‚ùå Admin access required');
        return;
    }
    
    const name = document.getElementById('edit-tournament-name').value.trim();
    const description = document.getElementById('edit-tournament-description').value.trim();
    const level = document.getElementById('edit-tournament-level').value;
    const date = document.getElementById('edit-tournament-date').value;
    const time = document.getElementById('edit-tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('edit-tournament-max-participants').value);
    const status = document.getElementById('edit-tournament-status').value;
    
    const errorDiv = document.getElementById('edit-tournament-error');
    
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ Tournament updated:', tournamentId);
        
        closeEditTournamentModal();
        
        alert('‚úÖ Tournament updated successfully!');
        
        // Reload admin panel
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error updating tournament:', error);
        errorDiv.textContent = 'Failed to update tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function deleteTournament(tournamentId) {
    if (!isAdmin) {
        alert('‚ùå Admin access required');
        return;
    }
    
    if (confirm('üóëÔ∏è Are you sure you want to delete this tournament? This action cannot be undone.')) {
        try {
            await db.collection('tournaments').doc(tournamentId).delete();
            
            console.log('‚úÖ Tournament deleted:', tournamentId);
            
            alert('‚úÖ Tournament deleted successfully');
            
            // Reload admin panel
            loadAdminPanel();
            
        } catch (error) {
            console.error('Error deleting tournament:', error);
            alert('Failed to delete tournament: ' + error.message);
        }
    }
}        
    </script>
</body>
</html>
