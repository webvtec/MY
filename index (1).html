 <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        
// ===== PAYPAL CONFIGURATION =====
const PAYPAL_HANDLER_URL = 'https://verificationpaypalpayment-998744778737.us-central1.run.app';
const REOPEN_ACCOUNT_COST = 6.50;
const REOPEN_DAYS = 30;

let paypalButtonRendered = false;
let sponsorPaypalRendered = false;
let currentChildData = null;

        

        let paypalSDKLoaded = false;

async function loadPayPalSDK() {
    if (paypalSDKLoaded) {
        return Promise.resolve();
    }
    
    try {
        // Get client ID from Firebase function
        const response = await fetch(`${PAYPAL_HANDLER_URL}?action=getClientId`);
        const data = await response.json();
        
        if (!data.success || !data.clientId) {
            throw new Error('Failed to get PayPal client ID');
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${data.clientId}&currency=USD&locale=en_US`;
            script.async = true;
            
            script.onload = () => {
                paypalSDKLoaded = true;
                console.log('âœ… PayPal SDK loaded');
                resolve();
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load PayPal SDK'));
            };
            
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading PayPal SDK:', error);
        throw error;
    }
}
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // âœ… NEW: Track declined challenges
let presenceInitialized = false; // âœ… NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// âœ… Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;


// ===== TOURNAMENT VARIABLES =====
let currentTournament = null;
let tournamentStage = 0;
let stage1Questions = [];
let stage1CurrentIndex = 0;
let stage1Score = 0;
let stage1Errors = 0;
let stage1Handicaps = 2;
let stage1TimeLeft = 600; // 10 minutes in seconds
let stage1Timer = null;

// ===== STAGE 2: AI AUDIO SPELLING =====
let stage2Words = [];
let stage2CurrentIndex = 0;
let stage2Score = 0;
let stage2Errors = 0;
let stage2TimeLeft = 900; // 15 minutes
let stage2Timer = null;
let stage2HandicapsRemaining = 1; // Base 1 + carried from Stage 1

// ===== TOURNAMENT STAGE 3 FUNCTIONS =====
let stage3Words = [];
let stage3CurrentIndex = 0;
let stage3Score = 0;
let stage3Errors = 0;
let stage3TimeLeft = 900; // 15 minutes
let stage3Timer = null;
let stage3HandicapsRemaining = 0;
let stage3CurrentLetterOrder = [];
let stage3DraggedElement = null;

// ===== LIVE STAGES 4-7 VARIABLES =====
let stage4RoomId = null;
let stage5RoomId = null;
let stage6RoomId = null;
let stage7RoomId = null;
let currentStageRoom = null;
let stageRoomListener = null;


// ===== LIVE ROOM VARIABLES =====
let localStream = null;
let liveRoomParticipants = new Map(); // userId -> {name, email, schoolId, stream, audioEnabled, videoEnabled}
let liveRoomListener = null;
let myAudioEnabled = true;
let myVideoEnabled = true;


// ===== AUTO-ELIMINATION VARIABLES =====
let stage3CompletionChecker = null;
const STAGE3_CUTOFF_TIME = 15 * 60 * 1000; // 15 minutes to complete Stage 3
const STAGE3_ELIMINATION_DELAY = 2 * 60 * 1000; // Wait 2 minutes after first completion before eliminating
let stage3FirstCompletionTime = null;

        
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // âœ… Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // âœ… ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // Ã¢Å“â€¦ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });
    
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        console.log('ğŸ‘¤ User signed in:', user.email);
        console.log('ğŸ–¼ï¸ Auth photoURL:', user.photoURL);
        
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        console.log('ğŸ“„ Firestore photoURL:', userData.photoURL);
        
        if (user.photoURL && !userData.photoURL) {
            console.log('ğŸ“„ Syncing photoURL to Firestore...');
            await userRef.update({
                photoURL: user.photoURL
            });
            console.log('âœ… PhotoURL synced!');
        }
        
        // âœ… INITIALIZE SPELLING STATS IF NOT EXISTS
        if (!userData.spellingStats) {
            console.log('ğŸ“„ Initializing spelling stats...');
            await userRef.update({
                spellingStats: {
                    totalChallenges: 0,
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    winStreak: 0,
                    bestStreak: 0
                }
            });
            console.log('âœ… Spelling stats initialized!');
        }
        
        // âœ… CHECK ADMIN STATUS HERE (CRITICAL - RIGHT AFTER USER DATA IS LOADED)
        await checkAdminStatus();
        
        // âœ… CHECK USER TYPE AND HANDLE ACCORDINGLY
        if (userData.userType === 'parent') {
            // Parent user - no profile completion needed
            if (!userData.profileComplete) {
                await userRef.update({ profileComplete: true });
            }
            updateUIForAuthenticatedUser(user);
            
            // Navigate to parent dashboard
            navigateTo('parent-dashboard');
            return;
        }
        
        // STUDENT/COACH HANDLING
        if (!userData.profileComplete) {
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // âœ… LOAD USER COINS (for students only)
        if (userData.userType === 'student') {
            await loadUserCoins(user.uid);
            await checkSubscriptionStatus();
        }
        
        await cleanupInvalidFavorites();
        
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // âœ… Initialize presence immediately on login (only for students/coaches)
        if (userData.userType !== 'parent') {
            await initializeOnlinePresence();
        }
        
        // Load appropriate dashboard
        if (userData.userType === 'student') {
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        }
   } else {
    currentUser = null;
    isAdmin = false;
    
    // âœ… Clean up tournament listeners
    if (tournamentListeners) {
        tournamentListeners.forEach(unsubscribe => unsubscribe());
        tournamentListeners = [];
    }
    
    updateUIForGuestUser();
    updateAdminUI();
}
});
    });
        
        
    
// ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // âœ… CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'parent-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // âœ… ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard' || section === 'parent-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // âœ… PREVENT PARENTS FROM ACCESSING STUDENT FEATURES
    if (currentUser && section !== 'parent-dashboard' && section !== 'home' && section !== 'about' && section !== 'coaches' && section !== 'students') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'parent') {
                alert('âš ï¸ Parents can only access:\nâ€¢ Parent Dashboard\nâ€¢ Home\nâ€¢ About\nâ€¢ Coaches\nâ€¢ Students\n\nPlease use the Parent Dashboard to manage your child\'s account.');
                navigateTo('parent-dashboard');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // âœ… Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // âœ… RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // âœ… Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // âœ… Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // âœ… Load student dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    // âœ… Load parent dashboard when navigating to it
    if (section === 'parent-dashboard' && currentUser) {
        await loadParentDashboard();
    }
    
    // âœ… LOAD ADMIN PANEL WHEN NAVIGATING TO IT
    if (section === 'admin' && currentUser) {
        console.log('ğŸ¯ Navigating to admin panel. isAdmin:', isAdmin);
        if (!isAdmin) {
            alert('âŒ Admin access required. Please sign in with an admin account.');
            navigateTo('home');
            return;
        }
        await loadAdminPanel();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }

    if (section === 'tournaments') {
    await loadTournamentList();
}
}

// ===== TOURNAMENT STAGE 1 FUNCTIONS =====

async function startTournamentStage1(tournamentId) {
    try {
        console.log('ğŸ† Joining Tournament Stage 1:', tournamentId);
        
        const tournamentRef = db.collection('tournaments').doc(tournamentId);
        const tournamentDoc = await tournamentRef.get();
        
        if (!tournamentDoc.exists) {
            throw new Error('Tournament not found');
        }
        
        const tournamentData = tournamentDoc.data();
        selectedGameLevel = tournamentData.level || 'challenge';
        
        currentTournament = tournamentId;
        tournamentStage = 1;
        stage1CurrentIndex = 0;
        stage1Score = 0;
        stage1Errors = 0;
        stage1Handicaps = 2;
        stage1TimeLeft = 600;
        
        // âœ… Check if questions already exist (first player generates, others use same)
        const questionsSnapshot = await tournamentRef.collection('stage1Questions').get();
        
        if (questionsSnapshot.empty) {
            console.log('ğŸ“ Generating questions for all players...');
            
            // First player to join generates questions
            await generateStage1Questions();
            
            // Save questions to Firestore so all players use the same questions
            const batch = db.batch();
            stage1Questions.forEach((question, index) => {
                const questionRef = tournamentRef.collection('stage1Questions').doc(`q${index}`);
                batch.set(questionRef, question);
            });
            await batch.commit();
            
            console.log('âœ… Questions saved to Firestore');
        } else {
            console.log('ğŸ“¥ Loading existing questions...');
            
            // Load questions from Firestore
            stage1Questions = [];
            questionsSnapshot.forEach(doc => {
                stage1Questions.push(doc.data());
            });
            
            // Sort by document ID to maintain order
            stage1Questions.sort((a, b) => {
                const aNum = parseInt(a.word) || 0;
                const bNum = parseInt(b.word) || 0;
                return aNum - bNum;
            });
            
            console.log('âœ… Loaded', stage1Questions.length, 'questions');
        }
        
        // âœ… Create participant document for real-time tracking
        await tournamentRef.collection('participants').doc(currentUser.uid).set({
            userId: currentUser.uid,
            name: currentUser.displayName || currentUser.email,
            stage: 1,
            score: 0,
            errors: 0,
            handicaps: 2,
            currentQuestion: 0,
            status: 'active',
            joinedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Hide lobby, show stage 1
        document.getElementById('tournament-lobby').style.display = 'none';
        document.getElementById('tournament-stage1').style.display = 'block';
        
        // âœ… Setup real-time leaderboard
        setupStage1Leaderboard(tournamentId);
        
        // Start timer
        startStage1Timer();
        
        // Load first question
        loadStage1Question();
        
    } catch (error) {
        console.error('Error starting Stage 1:', error);
        alert('Failed to start tournament: ' + error.message);
    }
}
async function generateStage1Questions() {
    try {
        console.log('ğŸ¯ Fetching words from database for level:', selectedGameLevel);
        
        // âœ… Create unique seed from tournament ID
        const tournamentSeed = hashString(currentTournament + 'stage1');
        const seededRandom = createSeededRandom(tournamentSeed);
        
        // Fetch words from Firestore dictionary
        const wordsSnapshot = await db.collection('dictionary')
            .where('level', '==', selectedGameLevel)
            .limit(100)
            .get();
        
        if (wordsSnapshot.empty) {
            console.log('âš ï¸ No words found with level filter, fetching random words...');
            const randomWordsSnapshot = await db.collection('dictionary').limit(100).get();
            
            if (randomWordsSnapshot.empty) {
                throw new Error('No words found in database. Please add words first.');
            }
            
            const allWords = [];
            randomWordsSnapshot.forEach(doc => {
                allWords.push({ id: doc.id, ...doc.data() });
            });
            
            // âœ… Use seeded random for shuffling
            const shuffled = allWords.sort(() => seededRandom() - 0.5);
            return await buildQuestionsFromWords(shuffled.slice(0, 25));
        }
        
        const words = [];
        wordsSnapshot.forEach(doc => {
            words.push({ id: doc.id, ...doc.data() });
        });
        
        console.log(`âœ… Found ${words.length} words in database`);
        
        // âœ… Use seeded random for unique shuffling per tournament
        const shuffled = words.sort(() => seededRandom() - 0.5);
        const selected = shuffled.slice(0, 25);
        
        return await buildQuestionsFromWords(selected);
        
    } catch (error) {
        console.error('Error fetching words from database:', error);
        throw new Error('Failed to load words from database: ' + error.message);
    }
}

async function buildQuestionsFromWords(words) {
    stage1Questions = [];
    
    for (const wordData of words) {
        const word = wordData.word || wordData.id;
        
        // Get synonyms and antonyms from meanings
        let synonyms = [];
        let antonyms = [];
        let definition = '';
        let example = '';
        
        if (wordData.meanings && wordData.meanings.length > 0) {
            wordData.meanings.forEach(meaning => {
                definition = definition || meaning.definition;
                example = example || meaning.example;
                
                if (meaning.synonyms && meaning.synonyms.length > 0) {
                    synonyms = synonyms.concat(meaning.synonyms);
                }
                if (meaning.antonyms && meaning.antonyms.length > 0) {
                    antonyms = antonyms.concat(meaning.antonyms);
                }
            });
        }
        
        // Decide question type
        const hasEnoughSynonyms = synonyms.length >= 1;
        const hasEnoughAntonyms = antonyms.length >= 1;
        
        let questionType;
        if (hasEnoughSynonyms && hasEnoughAntonyms) {
            questionType = Math.random() > 0.5 ? 'synonym' : 'antonym';
        } else if (hasEnoughSynonyms) {
            questionType = 'synonym';
        } else if (hasEnoughAntonyms) {
            questionType = 'antonym';
        } else {
            questionType = 'definition';
        }
        
        const availableWords = questionType === 'synonym' ? synonyms : antonyms;
        const correctAnswer = availableWords.length > 0 ? availableWords[0] : word;
        
        // Get wrong options from other words
        const wrongOptions = words
            .filter(w => (w.word || w.id) !== word && (w.word || w.id) !== correctAnswer)
            .map(w => w.word || w.id)
            .sort(() => 0.5 - Math.random())
            .slice(0, 3);
        
        // Build options
        const options = [correctAnswer, ...wrongOptions].sort(() => 0.5 - Math.random());
        const correctIndex = options.indexOf(correctAnswer);
        
        // Build sentence
        const sentence = example || 
            `Find the ${questionType} of "${word}"` + 
            (definition ? `: ${definition}` : '');
        
        stage1Questions.push({
            word: word,
            targetWord: word,
            type: questionType,
            sentence: sentence,
            options: options,
            correctAnswer: correctIndex
        });
    }
    
    console.log('âœ… Built', stage1Questions.length, 'questions from database');
    return stage1Questions;
}

function loadStage1Question() {
    if (stage1CurrentIndex >= stage1Questions.length) {
        completeStage1();
        return;
    }
    
    const question = stage1Questions[stage1CurrentIndex];
    const container = document.getElementById('stage1-question-container');
    
    document.getElementById('stage1-progress').textContent = 
        `Question ${stage1CurrentIndex + 1} of ${stage1Questions.length}`;
    
    container.innerHTML = `
        <div style="margin: 30px 0;">
            <p style="font-size: 1.3rem; margin-bottom: 20px; line-height: 1.6;">
                <strong>${question.sentence}</strong>
            </p>
            <p style="color: #666; margin-bottom: 10px;">
                Select the best ${question.type === 'synonym' ? 'SYNONYM' : 'ANTONYM'} for the word: 
                <strong style="color: #0d3b66;">${question.targetWord}</strong>
            </p>
        </div>
        
        <div class="quiz-options">
            ${question.options.map((option, index) => `
                <div class="quiz-option" onclick="checkStage1Answer(${index})">
                    ${option}
                </div>
            `).join('')}
        </div>
        
        <div id="stage1-feedback" style="margin-top: 20px;"></div>
    `;
}

async function checkStage1Answer(selectedIndex) {
    const question = stage1Questions[stage1CurrentIndex];
    const options = document.querySelectorAll('.quiz-option');
    const feedbackDiv = document.getElementById('stage1-feedback');
    
    // Disable all options
    options.forEach(opt => opt.style.pointerEvents = 'none');
    
    const isCorrect = selectedIndex === question.correctAnswer;
    
    if (isCorrect) {
        stage1Score++;
        options[selectedIndex].classList.add('correct');
        feedbackDiv.innerHTML = '<div class="feedback success">âœ… Correct!</div>';
        
        document.getElementById('stage1-score').textContent = stage1Score;
        
        // âœ… Update Firestore
        await db.collection('tournaments').doc(currentTournament)
            .collection('participants').doc(currentUser.uid).update({
                score: stage1Score,
                currentQuestion: stage1CurrentIndex + 1
            });
        
        setTimeout(() => {
            stage1CurrentIndex++;
            loadStage1Question();
        }, 1000);
        
    } else {
        stage1Errors++;
        options[selectedIndex].classList.add('wrong');
        options[question.correctAnswer].classList.add('correct');
        
        document.getElementById('stage1-errors').textContent = stage1Errors;
        
        // âœ… Update Firestore
        await db.collection('tournaments').doc(currentTournament)
            .collection('participants').doc(currentUser.uid).update({
                errors: stage1Errors,
                handicaps: stage1Handicaps,
                currentQuestion: stage1CurrentIndex + 1
            });
        
        if (stage1Errors >= 2 && stage1Handicaps === 0) {
            // Eliminated
            await db.collection('tournaments').doc(currentTournament)
                .collection('participants').doc(currentUser.uid).update({
                    status: 'eliminated',
                    eliminatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            feedbackDiv.innerHTML = '<div class="feedback error">âŒ Eliminated! You made 2 errors with no handicaps.</div>';
            setTimeout(() => eliminateFromStage1(), 2000);
            
        } else if (stage1Errors >= 2 && stage1Handicaps > 0) {
            stage1Handicaps--;
            stage1Errors = 0;
            
            document.getElementById('stage1-handicaps').textContent = stage1Handicaps;
            document.getElementById('stage1-errors').textContent = stage1Errors;
            
            await db.collection('tournaments').doc(currentTournament)
                .collection('participants').doc(currentUser.uid).update({
                    errors: 0,
                    handicaps: stage1Handicaps
                });
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    âŒ Wrong! Correct: ${question.options[question.correctAnswer]}<br>
                    ğŸ›¡ï¸ Handicap used! Errors reset. Handicaps: ${stage1Handicaps}
                </div>
            `;
            
            setTimeout(() => {
                stage1CurrentIndex++;
                loadStage1Question();
            }, 2000);
        } else {
            feedbackDiv.innerHTML = `<div class="feedback error">âŒ Wrong! Correct: ${question.options[question.correctAnswer]}</div>`;
            setTimeout(() => {
                stage1CurrentIndex++;
                loadStage1Question();
            }, 2000);
        }
    }
}
function startStage1Timer() {
    if (stage1Timer) clearInterval(stage1Timer);
    
    stage1Timer = setInterval(() => {
        stage1TimeLeft--;
        
        const minutes = Math.floor(stage1TimeLeft / 60);
        const seconds = stage1TimeLeft % 60;
        document.getElementById('stage1-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is low
        if (stage1TimeLeft <= 60) {
            document.getElementById('stage1-timer').style.color = '#dc3545';
        }
        
        if (stage1TimeLeft <= 0) {
            clearInterval(stage1Timer);
            completeStage1();
        }
    }, 1000);
}


function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    if (stage2Timer) clearInterval(stage2Timer);
    if (stage3Timer) clearInterval(stage3Timer);
    
    // âœ… Clean up leaderboard listener
    if (stage1LeaderboardListener) {
        stage1LeaderboardListener();
        stage1LeaderboardListener = null;
    }
    
    // âœ… Remove leaderboard UI
    const leaderboard = document.getElementById('stage1-leaderboard');
    if (leaderboard) {
        leaderboard.remove();
    }
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    const stage2 = document.getElementById('tournament-stage2');
    if (stage2) stage2.style.display = 'none';
    
    const stage3 = document.getElementById('tournament-stage3');
    if (stage3) stage3.style.display = 'none';
    
    loadTournamentList();
}
        async function completeStage1() {
    clearInterval(stage1Timer);
    
    // âœ… Mark as completed in Firestore
    await db.collection('tournaments').doc(currentTournament)
        .collection('participants').doc(currentUser.uid).update({
            status: 'stage1-completed',
            stage1Score: stage1Score,
            stage1Total: stage1Questions.length,
            stage1Percentage: Math.round((stage1Score / stage1Questions.length) * 100),
            stage1CompletedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    
    const container = document.getElementById('stage1-question-container');
    const percentage = Math.round((stage1Score / stage1Questions.length) * 100);
    
    // âœ… Get final rankings (for display only, doesn't block progression)
    const participantsSnapshot = await db.collection('tournaments').doc(currentTournament)
        .collection('participants')
        .where('stage', '==', 1)
        .orderBy('score', 'desc')
        .get();
    
    const allPlayers = [];
    participantsSnapshot.forEach(doc => {
        allPlayers.push({ id: doc.id, ...doc.data() });
    });
    
    const myRank = allPlayers.findIndex(p => p.id === currentUser.uid) + 1;
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'ğŸ†' : percentage >= 60 ? 'â­' : 'ğŸ“š'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 1 Complete!</h2>
            
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 10px 0;">
                    ${stage1Score} / ${stage1Questions.length} Correct
                </div>
                <p style="font-size: 1.2rem; color: #666;">
                    Accuracy: ${percentage}%
                </p>
                <p style="font-size: 1.3rem; color: #667eea; font-weight: bold; margin: 10px 0;">
                    ğŸ… Current Rank: #${myRank} of ${allPlayers.length}
                </p>
                <p style="font-size: 1.1rem; color: #667eea;">
                    ğŸ›¡ï¸ Handicaps Remaining: ${stage1Handicaps}
                </p>
            </div>
            
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0; max-height: 300px; overflow-y: auto;">
                <h3 style="color: #0d3b66; margin-bottom: 15px;">ğŸ† Live Rankings</h3>
                ${allPlayers.slice(0, 10).map((player, index) => `
                    <div style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 5px; background: ${player.id === currentUser.uid ? '#e3f2fd' : 'white'}; border-radius: 5px;">
                        <span style="font-weight: ${index < 3 ? 'bold' : 'normal'};">
                            ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`} 
                            ${player.name || 'Player'}
                            ${player.id === currentUser.uid ? ' (You)' : ''}
                        </span>
                        <span style="font-weight: bold; color: #28a745;">
                            ${player.score} pts
                        </span>
                    </div>
                `).join('')}
            </div>
            
            <!-- âœ… ALWAYS SHOW PROCEED BUTTON -->
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">âœ… Ready for Stage 2!</h3>
                <p style="color: #0d3b66;">
                    You'll carry ${stage1Handicaps} handicap(s) into the next round.
                </p>
                <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                    Note: Rankings are live and may change as other players complete Stage 1
                </p>
            </div>
            <button class="practice-btn" onclick="proceedToStage2()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                â¡ï¸ Proceed to Stage 2
            </button>
        </div>
    `;
}
        
let stage1LeaderboardListener = null;

function setupStage1Leaderboard(tournamentId) {
    const leaderboardContainer = document.createElement('div');
    leaderboardContainer.id = 'stage1-leaderboard';
    leaderboardContainer.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        max-width: 300px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 100;
    `;
    
    document.body.appendChild(leaderboardContainer);
    
    // âœ… Listen to all participants in real-time
    stage1LeaderboardListener = db.collection('tournaments').doc(tournamentId)
        .collection('participants')
        .where('stage', '==', 1)
        .onSnapshot(snapshot => {
            const players = [];
            snapshot.forEach(doc => {
                players.push({ id: doc.id, ...doc.data() });
            });
            
            // Sort by score (descending), then by current question (descending)
            players.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return b.currentQuestion - a.currentQuestion;
            });
            
            leaderboardContainer.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: #0d3b66; font-size: 1.1rem;">
                    ğŸ† Live Leaderboard (${players.length})
                </h3>
                ${players.map((player, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: ${player.id === currentUser.uid ? '#e3f2fd' : '#f9f9f9'}; border-radius: 8px; border-left: 4px solid ${index === 0 ? '#FFD700' : index === 1 ? '#C0C0C0' : index === 2 ? '#CD7F32' : '#0d3b66'};">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #0d3b66; font-size: 0.9rem;">
                                ${index + 1}. ${player.name || 'Player'}
                                ${player.id === currentUser.uid ? ' (You)' : ''}
                            </div>
                            <div style="font-size: 0.8rem; color: #666; margin-top: 2px;">
                                Q${player.currentQuestion + 1}/25 â€¢ ${player.errors} errors
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #28a745;">
                                ${player.score}
                            </div>
                            <div style="font-size: 0.75rem; color: #666;">
                                ${player.status === 'active' ? 'ğŸŸ¢' : 'ğŸ”´'}
                            </div>
                        </div>
                    </div>
                `).join('')}
            `;
        });
}        

function eliminateFromStage1() {
    clearInterval(stage1Timer);
    
    const container = document.getElementById('stage1-question-container');
    
    container.innerHTML = `
        <div style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 1</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You made 2 errors with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage1Score} / ${stage1CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                ğŸ  Return to Lobby
            </button>
        </div>
    `;
}

function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    // Reload tournament list
    loadTournamentList();
}

function proceedToStage2() {
    alert('Stage 2 will be implemented next! ğŸ‰');
    // This will be implemented in the next step
}

async function loadTournamentList() {
    const container = document.getElementById('tournament-list-container');
    container.innerHTML = '<div class="loading">Loading tournaments...</div>';
    
    try {
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('startDate', 'asc')
            .get();
        
        if (tournamentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ†</div>
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">No Active Tournaments</h3>
                    <p style="color: #666;">Check back later for upcoming spelling tournaments!</p>
                </div>
            `;
            return;
        }
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.status === 'upcoming' || data.status === 'active') {
                tournaments.push({ id: doc.id, ...data });
            }
        });
        
        if (tournaments.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ†</div>
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">No Active Tournaments</h3>
                    <p style="color: #666;">Check back later for upcoming spelling tournaments!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = tournaments.map(tournament => {
            const isFull = tournament.participants >= tournament.maxParticipants;
            const isRegistered = tournament.registeredUsers?.includes(currentUser?.uid);
            
            const levelEmoji = {
                'foundation': 'ğŸŒ±',
                'challenge': 'ğŸ¯',
                'advanced': 'ğŸš€',
                'championship': 'ğŸ†'
            };
            
            const statusColor = {
                'upcoming': '#ffc107',
                'active': '#28a745',
                'completed': '#6c757d',
                'cancelled': '#dc3545'
            };
            
            return `
                <div style="background: white; padding: 30px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); border-left: 5px solid ${statusColor[tournament.status]};">
                    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; min-width: 250px;">
                            <h3 style="color: #0d3b66; margin: 0 0 10px 0; font-size: 1.5rem;">${levelEmoji[tournament.level]} ${tournament.name}</h3>
                            <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">${tournament.description}</p>
                            
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-top: 15px;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">ğŸ“…</span>
                                    <span style="color: #666;">${new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">ğŸ•</span>
                                    <span style="color: #666;">${tournament.startTime}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">ğŸ‘¥</span>
                                    <span style="color: #666;">${tournament.participants} / ${tournament.maxParticipants} registered</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center;">
                            <div style="background: ${statusColor[tournament.status]}; color: white; padding: 8px 20px; border-radius: 20px; font-weight: bold; margin-bottom: 15px;">
                                ${tournament.status === 'upcoming' ? 'ğŸ“… Upcoming' : tournament.status === 'active' ? 'â–¶ï¸ Live Now' : 'âœ… Completed'}
                            </div>
                            
                            ${currentUser ? (
                                isRegistered ? (
                                    tournament.status === 'active' && tournament.sessionActive ? `
                                        <button class="practice-btn" onclick="joinLiveTournament('${tournament.id}')" style="background: #28a745; animation: pulse 2s infinite;">
                                            âš¡ JOIN NOW - LIVE!
                                        </button>
                                    ` : `
                                        <button class="practice-btn" disabled style="background: #28a745; opacity: 0.7; cursor: not-allowed;">
                                            âœ… Registered
                                        </button>
                                    `
                                ) : isFull ? `
                                    <button class="practice-btn" disabled style="opacity: 0.5; cursor: not-allowed;">
                                        ğŸ”’ Full
                                    </button>
                                ` : tournament.status === 'upcoming' ? `
                                    <button class="practice-btn" onclick="registerForTournament('${tournament.id}')" style="font-size: 1.1rem; padding: 12px 30px;">
                                        ğŸ“ Register
                                    </button>
                                ` : `
                                    <button class="practice-btn" disabled style="opacity: 0.5;">
                                        Tournament Started
                                    </button>
                                `
                            ) : `
                                <button class="practice-btn" onclick="showAuthModal()" style="font-size: 1.1rem; padding: 12px 30px;">
                                    ğŸ” Sign In to Join
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        // âœ… SET UP REAL-TIME LISTENERS FOR REGISTERED TOURNAMENTS
        if (currentUser) {
            setupTournamentListeners(tournaments);
        }
        
    } catch (error) {
        console.error('Error loading tournaments:', error);
        container.innerHTML = `
            <div class="feedback error">
                âŒ Failed to load tournaments: ${error.message}
            </div>
        `;
    }
}

async function registerForTournament(tournamentId) {
    if (!currentUser) {
        alert('Please sign in to register');
        showAuthModal();
        return;
    }
    
    try {
        const tournamentRef = db.collection('tournaments').doc(tournamentId);
        const tournamentDoc = await tournamentRef.get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Check if already registered
        if (tournament.registeredUsers?.includes(currentUser.uid)) {
            alert('You are already registered for this tournament');
            return;
        }
        
        // Check if full
        if (tournament.participants >= tournament.maxParticipants) {
            alert('This tournament is full');
            return;
        }
        
        // Register user
        await tournamentRef.update({
            participants: firebase.firestore.FieldValue.increment(1),
            registeredUsers: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        
        alert('âœ… Successfully registered for the tournament!');
        
        // Reload list
        loadTournamentList();
        
    } catch (error) {
        console.error('Error registering for tournament:', error);
        alert('Failed to register: ' + error.message);
    }
}

  
async function proceedToStage2() {
    try {
        console.log('ğŸ¯ Starting Stage 2: AI Audio Spelling');
        
        tournamentStage = 2;
        stage2CurrentIndex = 0;
        stage2Score = 0;
        stage2Errors = 0;
        stage2TimeLeft = 900;
        stage2HandicapsRemaining = 1 + stage1Handicaps; // Add carried handicaps
        
        // Hide Stage 1
        document.getElementById('tournament-stage1').style.display = 'none';
        
        // Create Stage 2 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage2Container = document.getElementById('tournament-stage2');
        
        if (!stage2Container) {
            stage2Container = document.createElement('div');
            stage2Container.id = 'tournament-stage2';
            tournamentsSection.appendChild(stage2Container);
        }
        
        stage2Container.style.display = 'block';
        
        // Show loading
        stage2Container.innerHTML = '<div class="loading">ğŸ“š Loading Stage 2 words...</div>';
        
        // Generate words
        await generateStage2Words();
        
        // Build Stage 2 UI
        buildStage2UI();
        
        // Start timer
        startStage2Timer();
        
        // Load first word
        loadStage2Word();
        
    } catch (error) {
        console.error('Error starting Stage 2:', error);
        alert('Failed to start Stage 2: ' + error.message);
    }
}

async function generateStage2Words() {
    try {
        // âœ… Create unique seed from tournament ID
        const tournamentSeed = hashString(currentTournament + 'stage2');
        const seededRandom = createSeededRandom(tournamentSeed);
        
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // âœ… Use seeded random for unique shuffling
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => seededRandom() - 0.5);
        stage2Words = shuffled.slice(0, 25);
        
        console.log('âœ… Generated 25 words for Stage 2:', stage2Words);
        
    } catch (error) {
        console.error('Error generating Stage 2 words:', error);
        throw error;
    }
}


function buildStage2UI() {
    const container = document.getElementById('tournament-stage2');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: #0d3b66; margin: 0;">ğŸ¤ Stage 2: AI Audio Spelling</h2>
                <button class="practice-btn" onclick="exitTournament()" style="background: #dc3545; padding: 10px 20px;">
                    ğŸšª Exit
                </button>
            </div>
            
            <!-- Timer and Stats -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">â±ï¸ Time Remaining</div>
                    <div id="stage2-timer" style="font-size: 2rem; font-weight: bold; color: #0d3b66;">15:00</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">âœ… Correct</div>
                    <div id="stage2-score" style="font-size: 2rem; font-weight: bold; color: #28a745;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">âŒ Errors</div>
                    <div id="stage2-errors" style="font-size: 2rem; font-weight: bold; color: #dc3545;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ğŸ›¡ï¸ Handicaps</div>
                    <div id="stage2-handicaps" style="font-size: 2rem; font-weight: bold; color: #667eea;">${stage2HandicapsRemaining}</div>
                </div>
            </div>
            
            <!-- Progress -->
            <h3 id="stage2-progress">Word 1 of 25</h3>
            
            <!-- Audio Controls -->
            <div style="text-align: center; margin: 30px 0;">
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                    <button class="practice-btn" onclick="speakStage2Word()" style="font-size: 1.1rem; padding: 15px 30px;">
                        ğŸ”Š Play Word
                    </button>
                    <button class="practice-btn" onclick="speakStage2Sentence()" style="font-size: 1.1rem; padding: 15px 30px; background: #17a2b8;">
                        ğŸ’¬ Use in Sentence
                    </button>
                </div>
                <p style="color: #666; font-style: italic; font-size: 0.9rem;">Listen and spell the word you hear</p>
            </div>
            
            <!-- Input Field -->
            <div class="form-group" style="margin: 30px 0;">
                <label style="font-size: 1.2rem;">Type what you hear:</label>
                <input type="text" id="stage2-input" 
                       placeholder="Use the keyboard below..." 
                       style="width: 100%; padding: 15px; font-size: 1.3rem; text-align: center; border: 3px solid #0d3b66; border-radius: 8px; margin-top: 10px;"
                       readonly>
            </div>
            
            <!-- Virtual Keyboard -->
            <div class="virtual-keyboard">
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('Q')">Q</button>
                    <button class="keyboard-key" onclick="typeStage2Key('W')">W</button>
                    <button class="keyboard-key" onclick="typeStage2Key('E')">E</button>
                    <button class="keyboard-key" onclick="typeStage2Key('R')">R</button>
                    <button class="keyboard-key" onclick="typeStage2Key('T')">T</button>
                    <button class="keyboard-key" onclick="typeStage2Key('Y')">Y</button>
                    <button class="keyboard-key" onclick="typeStage2Key('U')">U</button>
                    <button class="keyboard-key" onclick="typeStage2Key('I')">I</button>
                    <button class="keyboard-key" onclick="typeStage2Key('O')">O</button>
                    <button class="keyboard-key" onclick="typeStage2Key('P')">P</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('A')">A</button>
                    <button class="keyboard-key" onclick="typeStage2Key('S')">S</button>
                    <button class="keyboard-key" onclick="typeStage2Key('D')">D</button>
                    <button class="keyboard-key" onclick="typeStage2Key('F')">F</button>
                    <button class="keyboard-key" onclick="typeStage2Key('G')">G</button>
                    <button class="keyboard-key" onclick="typeStage2Key('H')">H</button>
                    <button class="keyboard-key" onclick="typeStage2Key('J')">J</button>
                    <button class="keyboard-key" onclick="typeStage2Key('K')">K</button>
                    <button class="keyboard-key" onclick="typeStage2Key('L')">L</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key" onclick="typeStage2Key('Z')">Z</button>
                    <button class="keyboard-key" onclick="typeStage2Key('X')">X</button>
                    <button class="keyboard-key" onclick="typeStage2Key('C')">C</button>
                    <button class="keyboard-key" onclick="typeStage2Key('V')">V</button>
                    <button class="keyboard-key" onclick="typeStage2Key('B')">B</button>
                    <button class="keyboard-key" onclick="typeStage2Key('N')">N</button>
                    <button class="keyboard-key" onclick="typeStage2Key('M')">M</button>
                </div>
                <div class="keyboard-row">
                    <button class="keyboard-key backspace" onclick="backspaceStage2Key()">âŒ« Delete</button>
                    <button class="keyboard-key space" onclick="typeStage2Key(' ')">Space</button>
                    <button class="keyboard-key enter" onclick="submitStage2Answer()">âœ“ Enter</button>
                </div>
            </div>
            
            <div id="stage2-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
}

function startStage2Timer() {
    if (stage2Timer) clearInterval(stage2Timer);
    
    stage2Timer = setInterval(() => {
        stage2TimeLeft--;
        
        const minutes = Math.floor(stage2TimeLeft / 60);
        const seconds = stage2TimeLeft % 60;
        document.getElementById('stage2-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (stage2TimeLeft <= 60) {
            document.getElementById('stage2-timer').style.color = '#dc3545';
        }
        
        if (stage2TimeLeft <= 0) {
            clearInterval(stage2Timer);
            completeStage2();
        }
    }, 1000);
}

function loadStage2Word() {
    if (stage2CurrentIndex >= stage2Words.length) {
        completeStage2();
        return;
    }
    
    document.getElementById('stage2-progress').textContent = 
        `Word ${stage2CurrentIndex + 1} of ${stage2Words.length}`;
    
    document.getElementById('stage2-input').value = '';
    document.getElementById('stage2-feedback').innerHTML = '';
    
    // Auto-play word
    setTimeout(() => speakStage2Word(), 500);
}

function speakStage2Word() {
    const word = stage2Words[stage2CurrentIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage2Sentence() {
    const word = stage2Words[stage2CurrentIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage2Word();
    }
}

function typeStage2Key(letter) {
    const input = document.getElementById('stage2-input');
    input.value += letter.toLowerCase();
}

function backspaceStage2Key() {
    const input = document.getElementById('stage2-input');
    input.value = input.value.slice(0, -1);
}

function submitStage2Answer() {
    const userAnswer = document.getElementById('stage2-input').value.trim().toLowerCase();
    const correctWord = stage2Words[stage2CurrentIndex].toLowerCase();
    const feedbackDiv = document.getElementById('stage2-feedback');
    
    if (!userAnswer) {
        feedbackDiv.innerHTML = '<div class="feedback error">âš ï¸ Please type a word</div>';
        return;
    }
    
    const isCorrect = userAnswer === correctWord;
    
    if (isCorrect) {
        stage2Score++;
        feedbackDiv.innerHTML = '<div class="feedback success">âœ… Correct!</div>';
        document.getElementById('stage2-score').textContent = stage2Score;
        
        setTimeout(() => {
            stage2CurrentIndex++;
            loadStage2Word();
        }, 1000);
        
    } else {
        stage2Errors++;
        document.getElementById('stage2-errors').textContent = stage2Errors;
        
        // Check elimination
        if (stage2Errors >= 1 && stage2HandicapsRemaining === 0) {
            feedbackDiv.innerHTML = `<div class="feedback error">âŒ Eliminated! Wrong spelling. Correct: ${correctWord}</div>`;
            setTimeout(() => eliminateFromStage2(), 2000);
        } else if (stage2Errors >= 1 && stage2HandicapsRemaining > 0) {
            // Use handicap
            stage2HandicapsRemaining--;
            stage2Errors = 0;
            document.getElementById('stage2-handicaps').textContent = stage2HandicapsRemaining;
            document.getElementById('stage2-errors').textContent = stage2Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    âŒ Wrong! Correct: ${correctWord}<br>
                    ğŸ›¡ï¸ Handicap used! Errors reset. Handicaps remaining: ${stage2HandicapsRemaining}
                </div>
            `;
            
            setTimeout(() => {
                stage2CurrentIndex++;
                loadStage2Word();
            }, 2000);
        }
    }
}

async function completeStage2() {
    clearInterval(stage2Timer);
    
    // âœ… Mark as completed in Firestore
    await db.collection('tournaments').doc(currentTournament)
        .collection('participants').doc(currentUser.uid).update({
            status: 'stage2-completed',
            stage2Score: stage2Score,
            stage2Total: stage2Words.length,
            stage2Percentage: Math.round((stage2Score / stage2Words.length) * 100),
            stage2CompletedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    
    const container = document.getElementById('tournament-stage2');
    const percentage = Math.round((stage2Score / stage2Words.length) * 100);
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${percentage >= 80 ? 'ğŸ†' : percentage >= 60 ? 'â­' : 'ğŸ“š'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 2 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage2Score} / ${stage2Words.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                ğŸ›¡ï¸ Handicaps Remaining: ${stage2HandicapsRemaining}
            </p>
            
            <!-- âœ… ALWAYS SHOW PROCEED BUTTON -->
            <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="color: #155724; margin-bottom: 10px;">âœ… Ready for Stage 3!</h3>
                <p style="color: #155724;">
                    You'll carry ${stage2HandicapsRemaining} handicap(s) into Stage 3.
                </p>
            </div>
            <button class="practice-btn" onclick="proceedToStage3()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                â¡ï¸ Proceed to Stage 3
            </button>
        </div>
    `;
}


function eliminateFromStage2() {
    clearInterval(stage2Timer);
    
    const container = document.getElementById('tournament-stage2');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 2</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                One error with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage2Score} / ${stage2CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                ğŸ  Return to Lobby
            </button>
        </div>
    `;
}


     

async function proceedToStage3() {
    try {
        console.log('ğŸ¯ Starting Stage 3: Spelling Challenge');
        
        tournamentStage = 3;
        stage3CurrentIndex = 0;
        stage3Score = 0;
        stage3Errors = 0;
        stage3TimeLeft = 900;
        stage3HandicapsRemaining = stage2HandicapsRemaining; // Carry from Stage 2
        
        // Hide Stage 2
        document.getElementById('tournament-stage2').style.display = 'none';
        
        // Create Stage 3 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage3Container = document.getElementById('tournament-stage3');
        
        if (!stage3Container) {
            stage3Container = document.createElement('div');
            stage3Container.id = 'tournament-stage3';
            tournamentsSection.appendChild(stage3Container);
        }
        
        stage3Container.style.display = 'block';
        stage3Container.innerHTML = '<div class="loading">ğŸ“š Loading Stage 3 words...</div>';
        
        // Generate words
        await generateStage3Words();
        
        // Build UI
        buildStage3UI();
        
        // Start timer
        startStage3Timer();
        
        // Load first word
        loadStage3Word();
        
    } catch (error) {
        console.error('Error starting Stage 3:', error);
        alert('Failed to start Stage 3: ' + error.message);
    }
}

async function generateStage3Words() {
    try {
        // âœ… Create unique seed from tournament ID
        const tournamentSeed = hashString(currentTournament + 'stage3');
        const seededRandom = createSeededRandom(tournamentSeed);
        
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // âœ… Use seeded random for unique shuffling
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => seededRandom() - 0.5);
        stage3Words = shuffled.slice(0, 25);
        
        console.log('âœ… Generated 25 words for Stage 3:', stage3Words);
        
    } catch (error) {
        console.error('Error generating Stage 3 words:', error);
        throw error;
    }
}

function buildStage3UI() {
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <h2 style="color: #0d3b66; margin: 0;">ğŸ”¤ Stage 3: Unscramble Challenge</h2>
                <button class="practice-btn" onclick="exitTournament()" style="background: #dc3545; padding: 10px 20px;">
                    ğŸšª Exit
                </button>
            </div>
            
            <!-- Timer and Stats -->
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;">
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">â±ï¸ Time Remaining</div>
                    <div id="stage3-timer" style="font-size: 2rem; font-weight: bold; color: #0d3b66;">15:00</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">âœ… Correct</div>
                    <div id="stage3-score" style="font-size: 2rem; font-weight: bold; color: #28a745;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">âŒ Errors</div>
                    <div id="stage3-errors" style="font-size: 2rem; font-weight: bold; color: #dc3545;">0</div>
                </div>
                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; flex: 1; min-width: 150px;">
                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">ğŸ›¡ï¸ Handicaps</div>
                    <div id="stage3-handicaps" style="font-size: 2rem; font-weight: bold; color: #667eea;">${stage3HandicapsRemaining}</div>
                </div>
            </div>
            
            <h3 id="stage3-progress">Word 1 of 25</h3>
            
            <div style="text-align: center; margin: 30px 0;">
                <h2 style="color: #0d3b66; margin-bottom: 20px;">Drag the letters to form the word:</h2>
                
                <div id="stage3-letter-tiles" class="letter-tiles-container">
                    <!-- Letter tiles will be inserted here -->
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="practice-btn" onclick="shuffleStage3Letters()" style="font-size: 1.1rem; padding: 15px 30px; margin: 10px;">
                        ğŸ”€ Shuffle
                    </button>
                    
                    <button class="practice-btn" onclick="submitStage3Answer()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        âœ“ Submit Answer
                    </button>
                </div>
            </div>
            
            <div id="stage3-feedback" style="margin-top: 20px;"></div>
        </div>
    `;
}

function startStage3Timer() {
    if (stage3Timer) clearInterval(stage3Timer);
    
    stage3Timer = setInterval(() => {
        stage3TimeLeft--;
        
        const minutes = Math.floor(stage3TimeLeft / 60);
        const seconds = stage3TimeLeft % 60;
        document.getElementById('stage3-timer').textContent = 
            `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (stage3TimeLeft <= 60) {
            document.getElementById('stage3-timer').style.color = '#dc3545';
        }
        
        if (stage3TimeLeft <= 0) {
            clearInterval(stage3Timer);
            completeStage3();
        }
    }, 1000);
}

function loadStage3Word() {
    if (stage3CurrentIndex >= stage3Words.length) {
        completeStage3();
        return;
    }
    
    const word = stage3Words[stage3CurrentIndex];
    
    document.getElementById('stage3-progress').textContent = 
        `Word ${stage3CurrentIndex + 1} of ${stage3Words.length}`;
    
    document.getElementById('stage3-feedback').innerHTML = '';
    
    // Scramble the letters
    shuffleStage3Letters();
}

function shuffleStage3Letters() {
    const word = stage3Words[stage3CurrentIndex];
    const letters = word.split('');
    let scrambled = [...letters];
    
    // Shuffle the array
    let attempts = 0;
    do {
        for (let i = scrambled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [scrambled[i], scrambled[j]] = [scrambled[j], scrambled[i]];
        }
        attempts++;
    } while (scrambled.join('') === word && attempts < 10);
    
    stage3CurrentLetterOrder = scrambled;
    renderStage3LetterTiles();
}

function renderStage3LetterTiles() {
    const container = document.getElementById('stage3-letter-tiles');
    container.innerHTML = '';
    
    stage3CurrentLetterOrder.forEach((letter, index) => {
        const tile = document.createElement('div');
        tile.className = 'letter-tile';
        tile.textContent = letter.toUpperCase();
        tile.draggable = true;
        tile.dataset.index = index;
        
        // Drag events
        tile.addEventListener('dragstart', handleStage3DragStart);
        tile.addEventListener('dragend', handleStage3DragEnd);
        tile.addEventListener('dragover', handleStage3DragOver);
        tile.addEventListener('drop', handleStage3Drop);
        tile.addEventListener('dragenter', handleStage3DragEnter);
        tile.addEventListener('dragleave', handleStage3DragLeave);
        
        // Touch events for mobile
        tile.addEventListener('touchstart', handleStage3TouchStart, { passive: false });
        tile.addEventListener('touchmove', handleStage3TouchMove, { passive: false });
        tile.addEventListener('touchend', handleStage3TouchEnd);
        
        container.appendChild(tile);
    });
}

function handleStage3DragStart(e) {
    stage3DraggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/html', this.innerHTML);
}

function handleStage3DragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
}

function handleStage3DragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    e.dataTransfer.dropEffect = 'move';
    return false;
}

function handleStage3DragEnter(e) {
    if (this !== stage3DraggedElement) {
        this.classList.add('drag-over');
    }
}

function handleStage3DragLeave(e) {
    this.classList.remove('drag-over');
}

function handleStage3Drop(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    
    this.classList.remove('drag-over');
    
    if (stage3DraggedElement !== this) {
        const draggedIndex = parseInt(stage3DraggedElement.dataset.index);
        const targetIndex = parseInt(this.dataset.index);
        
        [stage3CurrentLetterOrder[draggedIndex], stage3CurrentLetterOrder[targetIndex]] = 
        [stage3CurrentLetterOrder[targetIndex], stage3CurrentLetterOrder[draggedIndex]];
        
        renderStage3LetterTiles();
    }
    
    return false;
}

// Touch support for mobile
let stage3TouchTarget = null;
let stage3TouchClone = null;

function handleStage3TouchStart(e) {
    e.preventDefault();
    stage3TouchTarget = this;
    this.classList.add('dragging');
    
    stage3TouchClone = this.cloneNode(true);
    stage3TouchClone.style.position = 'fixed';
    stage3TouchClone.style.zIndex = '10000';
    stage3TouchClone.style.pointerEvents = 'none';
    stage3TouchClone.style.opacity = '0.8';
    document.body.appendChild(stage3TouchClone);
    
    updateStage3TouchClonePosition(e.touches[0]);
}

function handleStage3TouchMove(e) {
    e.preventDefault();
    if (!stage3TouchTarget) return;
    
    updateStage3TouchClonePosition(e.touches[0]);
    
    const touch = e.touches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== stage3TouchTarget) {
        elementBelow.classList.add('drag-over');
    }
}

function handleStage3TouchEnd(e) {
    e.preventDefault();
    if (!stage3TouchTarget) return;
    
    stage3TouchTarget.classList.remove('dragging');
    
    if (stage3TouchClone) {
        stage3TouchClone.remove();
        stage3TouchClone = null;
    }
    
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    
    if (elementBelow && elementBelow.classList.contains('letter-tile') && elementBelow !== stage3TouchTarget) {
        const draggedIndex = parseInt(stage3TouchTarget.dataset.index);
        const targetIndex = parseInt(elementBelow.dataset.index);
        
        [stage3CurrentLetterOrder[draggedIndex], stage3CurrentLetterOrder[targetIndex]] = 
        [stage3CurrentLetterOrder[targetIndex], stage3CurrentLetterOrder[draggedIndex]];
        
        renderStage3LetterTiles();
    }
    
    document.querySelectorAll('#stage3-letter-tiles .letter-tile').forEach(tile => {
        tile.classList.remove('drag-over');
    });
    
    stage3TouchTarget = null;
}

function updateStage3TouchClonePosition(touch) {
    if (stage3TouchClone) {
        stage3TouchClone.style.left = (touch.clientX - 30) + 'px';
        stage3TouchClone.style.top = (touch.clientY - 30) + 'px';
    }
}

function submitStage3Answer() {
    const userWord = stage3CurrentLetterOrder.join('').toLowerCase();
    const correctWord = stage3Words[stage3CurrentIndex].toLowerCase();
    const feedbackDiv = document.getElementById('stage3-feedback');
    
    if (userWord === correctWord) {
        stage3Score++;
        feedbackDiv.innerHTML = '<div class="feedback success">âœ… Correct!</div>';
        document.getElementById('stage3-score').textContent = stage3Score;
        
        setTimeout(() => {
            stage3CurrentIndex++;
            loadStage3Word();
        }, 1000);
        
    } else {
        stage3Errors++;
        document.getElementById('stage3-errors').textContent = stage3Errors;
        
        // Check elimination
        if (stage3Errors >= 1 && stage3HandicapsRemaining === 0) {
            feedbackDiv.innerHTML = `<div class="feedback error">âŒ Eliminated! Wrong word. Correct: ${correctWord}</div>`;
            setTimeout(() => eliminateFromStage3(), 2000);
        } else if (stage3Errors >= 1 && stage3HandicapsRemaining > 0) {
            // Use handicap
            stage3HandicapsRemaining--;
            stage3Errors = 0;
            document.getElementById('stage3-handicaps').textContent = stage3HandicapsRemaining;
            document.getElementById('stage3-errors').textContent = stage3Errors;
            
            feedbackDiv.innerHTML = `
                <div class="feedback error">
                    âŒ Wrong! Correct: ${correctWord}<br>
                    ğŸ›¡ï¸ Handicap used! Errors reset. Handicaps remaining: ${stage3HandicapsRemaining}
                </div>
            `;
            
            setTimeout(() => {
                stage3CurrentIndex++;
                loadStage3Word();
            }, 2000);
        }
    }
}

async function completeStage3() {
    clearInterval(stage3Timer);
    
    const percentage = Math.round((stage3Score / stage3Words.length) * 100);
    const completionTime = Date.now();
    
    // âœ… UPDATE USER'S STAGE 3 COMPLETION IN FIRESTORE
    try {
        await db.collection('tournaments').doc(currentTournament)
            .collection('participants').doc(currentUser.uid).set({
                userId: currentUser.uid,
                name: currentUser.displayName || currentUser.email,
                email: currentUser.email,
                stage: 3,
                stage3Score: stage3Score,
                stage3Total: stage3Words.length,
                stage3Percentage: percentage,
                stage3CompletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                stage3CompletionTimestamp: completionTime,
                status: 'stage3-completed',
                handicaps: stage3HandicapsRemaining
            }, { merge: true });
        
        console.log('âœ… Stage 3 completion recorded');
        
        // âœ… NOTIFY ADMIN
        await notifyAdminStage3Complete();
        
        // âœ… START AUTO-ELIMINATION CHECKER (only first person triggers this)
        await initializeStage3AutoElimination();
        
    } catch (error) {
        console.error('Error recording Stage 3 completion:', error);
    }
    
    // âœ… Get current rankings
    const allCompletions = await getStage3Rankings();
    
    const myRank = allCompletions.findIndex(p => p.id === currentUser.uid) + 1;
    const totalParticipants = allCompletions.length;
    const willMakeTop10 = myRank <= 10;
    
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">
                ${willMakeTop10 ? 'ğŸ†' : 'â­'}
            </div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 3 Complete!</h2>
            <div style="font-size: 2rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                ${stage3Score} / ${stage3Words.length} Correct
            </div>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                Accuracy: ${percentage}%
            </p>
            <p style="font-size: 1.1rem; color: #667eea; margin: 20px 0;">
                ğŸ›¡ï¸ Handicaps Remaining: ${stage3HandicapsRemaining}
            </p>
            
            <!-- âœ… SHOW CURRENT RANKINGS -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 15px;">ğŸ“Š Current Stage 3 Rankings</h3>
                <p style="color: #666; margin-bottom: 15px;">
                    Your Rank: <strong style="color: ${willMakeTop10 ? '#28a745' : '#dc3545'};">#${myRank}</strong> of ${totalParticipants} participants
                </p>
                <div style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                    ${allCompletions.slice(0, 15).map((p, index) => `
                        <div style="display: flex; justify-content: space-between; padding: 10px; margin-bottom: 5px; background: ${p.id === currentUser.uid ? '#e3f2fd' : index < 10 ? '#e8f5e9' : 'white'}; border-radius: 5px; border-left: 4px solid ${index < 10 ? '#28a745' : '#dc3545'};">
                            <span style="font-weight: ${index < 3 ? 'bold' : 'normal'};">
                                ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                ${p.name || 'Player'}
                                ${p.id === currentUser.uid ? ' (You)' : ''}
                                ${index < 10 ? ' âœ…' : ' â¸ï¸'}
                            </span>
                            <span style="font-weight: bold; color: #28a745;">
                                ${p.stage3Percentage}%
                            </span>
                        </div>
                    `).join('')}
                </div>
                <p style="color: #666; font-size: 0.9rem; margin-top: 15px;">
                    ${willMakeTop10 ? 
                        'âœ… You\'re currently in TOP 10 position!' : 
                        'â¸ï¸ You need to be in TOP 10 to advance to Stage 4'
                    }
                </p>
            </div>
            
            <!-- âœ… AUTO-ELIMINATION WARNING -->
            <div style="background: ${willMakeTop10 ? '#d4edda' : '#fff3cd'}; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="color: ${willMakeTop10 ? '#155724' : '#856404'}; margin-bottom: 10px;">
                    ${willMakeTop10 ? 'âœ… Currently Qualified!' : 'âš ï¸ At Risk of Elimination'}
                </h3>
                <p style="color: ${willMakeTop10 ? '#155724' : '#856404'};">
                    ${willMakeTop10 ? 
                        'Great job! You\'re in the Top 10. Rankings may still change as others complete.' :
                        'You\'re currently outside Top 10. Rankings will be finalized 2 minutes after the first player completes Stage 3.'
                    }
                </p>
                <p style="color: ${willMakeTop10 ? '#155724' : '#856404'}; font-weight: bold; margin-top: 15px;">
                    ğŸ¥ Auto-elimination will occur, then admin will create Stage 4 room for Top 10.
                </p>
            </div>
            
            <div id="stage4-join-section" style="margin: 20px 0;">
                <div class="loading">â³ Waiting for final rankings and Stage 4 room creation...</div>
            </div>
            
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin-top: 20px;">
                ğŸ  Return to Lobby
            </button>
        </div>
    `;
    
    // âœ… LISTEN FOR STAGE 4 ROOM CREATION
    listenForStage4Room();
}
    
  // ===== GET STAGE 3 RANKINGS =====
async function getStage3Rankings() {
    const participantsSnapshot = await db.collection('tournaments').doc(currentTournament)
        .collection('participants')
        .where('status', 'in', ['stage3-completed', 'qualified-stage4', 'eliminated-after-stage3'])
        .get();
    
    const allCompletions = [];
    participantsSnapshot.forEach(doc => {
        const data = doc.data();
        // Only include completed participants
        if (data.stage3Percentage !== undefined) {
            allCompletions.push({ id: doc.id, ...data });
        }
    });
    
    // âœ… SORT BY: 1) Percentage DESC, 2) Completion Time ASC (faster wins ties)
    allCompletions.sort((a, b) => {
        if (b.stage3Percentage !== a.stage3Percentage) {
            return b.stage3Percentage - a.stage3Percentage;
        }
        // If same percentage, earlier completion wins
        return (a.stage3CompletionTimestamp || 0) - (b.stage3CompletionTimestamp || 0);
    });
    
    return allCompletions;
}

// ===== INITIALIZE AUTO-ELIMINATION =====
async function initializeStage3AutoElimination() {
    try {
        // Check if elimination timer already started
        const tournamentDoc = await db.collection('tournaments').doc(currentTournament).get();
        const tournamentData = tournamentDoc.data();
        
        if (!tournamentData.stage3FirstCompletion) {
            // This is the FIRST person to complete Stage 3
            console.log('ğŸ¯ First Stage 3 completion - starting elimination timer');
            
            await db.collection('tournaments').doc(currentTournament).update({
                stage3FirstCompletion: firebase.firestore.FieldValue.serverTimestamp(),
                stage3EliminationScheduled: Date.now() + STAGE3_ELIMINATION_DELAY
            });
            
            // Start listening for auto-elimination
            startStage3EliminationListener();
        } else {
            console.log('â° Elimination timer already running');
        }
        
    } catch (error) {
        console.error('Error initializing auto-elimination:', error);
    }
}

// ===== LISTEN FOR AUTO-ELIMINATION TRIGGER =====
function startStage3EliminationListener() {
    console.log('ğŸ‘‚ Starting elimination listener...');
    
    const eliminationListener = db.collection('tournaments').doc(currentTournament)
        .onSnapshot(async (doc) => {
            if (!doc.exists) return;
            
            const data = doc.data();
            const eliminationTime = data.stage3EliminationScheduled;
            
            if (eliminationTime && Date.now() >= eliminationTime && !data.stage3EliminationComplete) {
                console.log('âš¡ TRIGGERING AUTO-ELIMINATION');
                
                // Mark as triggered to prevent duplicate runs
                await db.collection('tournaments').doc(currentTournament).update({
                    stage3EliminationComplete: true
                });
                
                // Run elimination
                await performStage3AutoElimination();
                
                // Stop listening
                eliminationListener();
            }
        });
    
    if (!window.tournamentListeners) {
        window.tournamentListeners = [];
    }
    window.tournamentListeners.push(eliminationListener);
}

// ===== PERFORM AUTO-ELIMINATION =====
async function performStage3AutoElimination() {
    console.log('ğŸ”¥ PERFORMING AUTO-ELIMINATION');
    
    try {
        // Get final rankings
        const allCompletions = await getStage3Rankings();
        
        console.log(`ğŸ“Š Total completions: ${allCompletions.length}`);
        
        if (allCompletions.length === 0) {
            console.log('âš ï¸ No completions found');
            return;
        }
        
        // Top 10 qualify
        const top10 = allCompletions.slice(0, 10);
        const eliminated = allCompletions.slice(10);
        
        console.log(`âœ… Qualifying: ${top10.length} users`);
        console.log(`âŒ Eliminating: ${eliminated.length} users`);
        
        const batch = db.batch();
        
        // âœ… QUALIFY TOP 10
        top10.forEach((user, index) => {
            const userRef = db.collection('tournaments').doc(currentTournament)
                .collection('participants').doc(user.id);
            batch.update(userRef, {
                status: 'qualified-stage4',
                finalRank: index + 1,
                qualifiedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log(`âœ… #${index + 1}: ${user.name} - ${user.stage3Percentage}%`);
        });
        
        // âŒ ELIMINATE EVERYONE ELSE
        eliminated.forEach((user, index) => {
            const userRef = db.collection('tournaments').doc(currentTournament)
                .collection('participants').doc(user.id);
            batch.update(userRef, {
                status: 'eliminated-after-stage3',
                eliminatedReason: `Ranked #${10 + index + 1} - Did not make Top 10`,
                eliminatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log(`âŒ #${10 + index + 1}: ${user.name} - ${user.stage3Percentage}%`);
        });
        
        await batch.commit();
        
        console.log('âœ… AUTO-ELIMINATION COMPLETE');
        
        // Notify all users
        await notifyUsersOfElimination(eliminated);
        
    } catch (error) {
        console.error('Error performing auto-elimination:', error);
    }
}

// ===== NOTIFY ELIMINATED USERS =====
async function notifyUsersOfElimination(eliminatedUsers) {
    // This will be picked up by the listenForStage4Room function
    // which checks the user's status
    console.log(`ğŸ“¢ ${eliminatedUsers.length} users eliminated`);
}  

// ===== NOTIFY ADMIN OF STAGE 3 COMPLETIONS =====
async function notifyAdminStage3Complete() {
    try {
        // Create notification document for admin
        await db.collection('tournaments').doc(currentTournament)
            .collection('adminNotifications').add({
                type: 'stage3_completion',
                userId: currentUser.uid,
                userName: currentUser.displayName || currentUser.email,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                read: false
            });
        
        console.log('âœ… Admin notified of Stage 3 completion');
    } catch (error) {
        console.error('Error notifying admin:', error);
    }
}

// ===== LISTEN FOR STAGE 4 ROOM CREATION OR ELIMINATION =====
function listenForStage4Room() {
    console.log('ğŸ‘‚ Listening for Stage 4 room creation or elimination...');
    
    const roomListener = db.collection('tournaments').doc(currentTournament)
        .collection('participants').doc(currentUser.uid)
        .onSnapshot(doc => {
            if (!doc.exists) return;
            
            const userData = doc.data();
            
            // âŒ CHECK IF ELIMINATED
            if (userData.status === 'eliminated-after-stage3') {
                showEliminationScreen(userData);
                return;
            }
            
            // âœ… CHECK IF QUALIFIED AND STAGE 4 ROOM EXISTS
            if (userData.status === 'qualified-stage4') {
                db.collection('tournaments').doc(currentTournament)
                    .collection('liveRooms').doc('stage4').get()
                    .then(stage4Doc => {
                        if (stage4Doc.exists) {
                            const roomData = stage4Doc.data();
                            
                            if (roomData.isActive && roomData.top10Participants?.includes(currentUser.uid)) {
                                console.log('ğŸ¥ Stage 4 room is ready!');
                                showStage4JoinButton(roomData);
                            }
                        }
                    });
            }
        });
    
    if (!window.tournamentListeners) {
        window.tournamentListeners = [];
    }
    window.tournamentListeners.push(roomListener);
}

// ===== SHOW ELIMINATION SCREEN =====
function showEliminationScreen(userData) {
    const joinSection = document.getElementById('stage4-join-section');
    if (!joinSection) return;
    
    joinSection.innerHTML = `
        <div style="background: linear-gradient(135deg, #dc3545, #c0392b); padding: 40px; border-radius: 15px; margin: 20px 0; animation: fadeIn 0.5s;">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜¢</div>
            <h2 style="color: white; margin-bottom: 15px;">Eliminated from Tournament</h2>
            <p style="color: white; opacity: 0.9; font-size: 1.1rem; margin-bottom: 15px;">
                ${userData.eliminatedReason || 'You did not make the Top 10 cutoff'}
            </p>
            <p style="color: white; opacity: 0.8; margin-bottom: 20px;">
                Thank you for participating! Better luck next time.
            </p>
            <button class="practice-btn" onclick="exitTournament()" 
                    style="background: white; color: #dc3545; font-size: 1.2rem; padding: 15px 40px; font-weight: bold;">
                ğŸ  Return to Lobby
            </button>
        </div>
    `;
}
        
// ===== SHOW JOIN BUTTON FOR STAGE 4 =====
function showStage4JoinButton(roomData) {
    const joinSection = document.getElementById('stage4-join-section');
    if (!joinSection) return;
    
    joinSection.innerHTML = `
        <div style="background: linear-gradient(135deg, #28a745, #20c997); padding: 30px; border-radius: 15px; margin: 20px 0; animation: pulse 2s infinite;">
            <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ¥</div>
            <h3 style="color: white; margin-bottom: 15px;">Stage 4 Room is Ready!</h3>
            <p style="color: white; opacity: 0.9; margin-bottom: 20px;">
                You are one of the TOP 10 qualifiers!
            </p>
            <button class="practice-btn" onclick="joinStage4Room()" 
                    style="background: white; color: #28a745; font-size: 1.3rem; padding: 20px 50px; font-weight: bold;">
                âš¡ JOIN STAGE 4 NOW
            </button>
        </div>
    `;
    
    // Add pulse animation
    if (!document.getElementById('pulse-animation-style')) {
        const style = document.createElement('style');
        style.id = 'pulse-animation-style';
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); box-shadow: 0 5px 20px rgba(40, 167, 69, 0.3); }
                50% { transform: scale(1.05); box-shadow: 0 10px 40px rgba(40, 167, 69, 0.6); }
            }
        `;
        document.head.appendChild(style);
    }
}

        
function eliminateFromStage3() {
    clearInterval(stage3Timer);
    
    const container = document.getElementById('tournament-stage3');
    
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜¢</div>
            <h2 style="color: #dc3545; margin-bottom: 20px;">Eliminated from Stage 3</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                One error with no handicaps remaining.
            </p>
            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66; margin: 20px 0;">
                Final Score: ${stage3Score} / ${stage3CurrentIndex + 1}
            </div>
            <button class="practice-btn" onclick="exitTournament()" style="font-size: 1.2rem; padding: 15px 40px; margin-top: 20px;">
                ğŸ  Return to Lobby
            </button>
        </div>
    `;
}


   // ===== ADMIN: LISTEN FOR STAGE 3 COMPLETIONS =====
function listenForStage3Completions(tournamentId) {
    const notificationsListener = db.collection('tournaments').doc(tournamentId)
        .collection('adminNotifications')
        .where('type', '==', 'stage3_completion')
        .where('read', '==', false)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const notification = change.doc.data();
                    showAdminNotification(`âœ… ${notification.userName} completed Stage 3!`);
                    
                    // Mark as read
                    change.doc.ref.update({ read: true });
                    
                    // Refresh the view
                    setTimeout(() => {
                        closeViewTournamentModal();
                        viewTournament(tournamentId);
                    }, 2000);
                }
            });
        });
    
    if (!window.tournamentListeners) {
        window.tournamentListeners = [];
    }
    window.tournamentListeners.push(notificationsListener);
}

// ===== SHOW ADMIN NOTIFICATION =====
function showAdminNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        z-index: 10001;
        font-size: 1.1rem;
        font-weight: bold;
        animation: slideInRight 0.5s ease-out;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Add animation
    if (!document.getElementById('slideInRight-style')) {
        const style = document.createElement('style');
        style.id = 'slideInRight-style';
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(400px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    }
    
    setTimeout(() => notification.remove(), 5000);
}     

// Update exitTournament to handle all stages
function exitTournament() {
    if (stage1Timer) clearInterval(stage1Timer);
    if (stage2Timer) clearInterval(stage2Timer);
    if (stage3Timer) clearInterval(stage3Timer);
    
    currentTournament = null;
    tournamentStage = 0;
    
    document.getElementById('tournament-lobby').style.display = 'block';
    document.getElementById('tournament-stage1').style.display = 'none';
    
    const stage2 = document.getElementById('tournament-stage2');
    if (stage2) stage2.style.display = 'none';
    
    const stage3 = document.getElementById('tournament-stage3');
    if (stage3) stage3.style.display = 'none';
    
    loadTournamentList();
} 


 async function joinAsSpeller() {
    callerMode = false;
    
    // Show waiting room
    const container = document.getElementById('tournament-stage3');
    container.innerHTML = `
        <div class="quiz-question-card" style="text-align: center; padding: 40px;">
            <div style="font-size: 4rem; margin: 20px 0; animation: pulse 2s infinite;">â³</div>
            <h2 style="color: #0d3b66; margin-bottom: 20px;">Waiting for Stage 4 to Begin...</h2>
            <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                You've joined as a <strong style="color: #667eea;">SPELLER</strong>
            </p>
            <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3 style="color: #0d3b66; margin-bottom: 15px;">ğŸ“‹ Stage 4: Live Spell Master (Top 10)</h3>
                <p style="color: #666; line-height: 1.8;">
                    â€¢ Live human caller will read words<br>
                    â€¢ One mistake = eliminated (unless you have a Shield)<br>
                    â€¢ Top 10 spellers advance<br>
                    â€¢ 5-minute break after this round
                </p>
            </div>
            <div class="loading">Waiting for a caller to start the round...</div>
            
            <button class="practice-btn" onclick="exitTournament()" style="margin-top: 20px; background: #6c757d;">
                ğŸšª Leave Waiting Room
            </button>
        </div>
    `;
    
    // In a real implementation, this would connect to a live session
    // For demo purposes, we'll simulate
    setTimeout(() => {
        alert('â° In a live tournament, you would wait here for a caller to start Stage 4.\n\nFor demo purposes, the caller interface is available by choosing "Join as Caller".');
    }, 2000);
}

async function joinAsCaller() {
    callerMode = true;
    
    try {
        // Hide Stage 3
        document.getElementById('tournament-stage3').style.display = 'none';
        
        // Generate words for Stage 4
        await generateLiveStageWords(10); // 10 words for Stage 4
        
        // Show caller interface
        startStage4AsCaller();
        
    } catch (error) {
        console.error('Error starting as caller:', error);
        alert('Failed to start as caller: ' + error.message);
    }
}

  async function generateLiveStageWords(count) {
    try {
        if (!selectedGameLevel) {
            selectedGameLevel = 'championship'; // Use hardest level for finals
        }
        
        if (levelWords[selectedGameLevel].length === 0) {
            await loadLevelWords(selectedGameLevel);
        }
        
        // Select random words
        const shuffled = [...levelWords[selectedGameLevel]].sort(() => 0.5 - Math.random());
        liveStageWords = shuffled.slice(0, count);
        
        console.log(`âœ… Generated ${count} words for live stage:`, liveStageWords);
        
    } catch (error) {
        console.error('Error generating live stage words:', error);
        throw error;
    }
}


 // ===== CREATE STAGE 4 ROOM (TOP 10 ONLY) =====
async function createStage4Room(tournamentId) {
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    if (!confirm('ğŸš€ Create Stage 4 room and select TOP 10 participants?')) {
        return;
    }
    
    try {
        console.log('ğŸ¥ Creating Stage 4 room...');
        
        // Get top 10 qualified participants
        const participantsSnapshot = await db.collection('tournaments').doc(tournamentId)
            .collection('participants')
            .where('status', '==', 'qualified-stage4')
            .orderBy('stage3Percentage', 'desc')
            .limit(10)
            .get();
        
        const top10 = [];
        const top10Ids = [];
        participantsSnapshot.forEach(doc => {
            top10.push({ id: doc.id, ...doc.data() });
            top10Ids.push(doc.id);
        });
        
        if (top10.length < 10) {
            alert(`âš ï¸ Only ${top10.length} qualified participants. Need at least 10.`);
            return;
        }
        
        // Create Stage 4 room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage4').set({
                stage: 4,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: true,
                top10Participants: top10Ids,
                activeParticipants: [],
                eliminatedParticipants: [],
                adminInRoom: false
            });
        
        // Update all top 10 to active
        const batch = db.batch();
        top10Ids.forEach(userId => {
            const userRef = db.collection('tournaments').doc(tournamentId)
                .collection('participants').doc(userId);
            batch.update(userRef, {
                status: 'stage4-active',
                stage: 4
            });
        });
        
        // Eliminate everyone else
        const allParticipantsSnapshot = await db.collection('tournaments').doc(tournamentId)
            .collection('participants')
            .where('status', '==', 'qualified-stage4')
            .get();
        
        allParticipantsSnapshot.forEach(doc => {
            if (!top10Ids.includes(doc.id)) {
                batch.update(doc.ref, {
                    status: 'eliminated-after-stage3',
                    eliminatedReason: 'Did not make Top 10'
                });
            }
        });
        
        await batch.commit();
        
        console.log('âœ… Stage 4 room created with top 10 participants');
        
        alert(`âœ… Stage 4 room created!\n\nTop 10 participants have been notified and can now join.`);
        
        // Refresh view
        closeViewTournamentModal();
        viewTournament(tournamentId);
        
    } catch (error) {
        console.error('Error creating Stage 4 room:', error);
        alert('Failed to create Stage 4 room: ' + error.message);
    }
}


// ===== PARTICIPANT: JOIN STAGE 4 ROOM =====
async function joinStage4Room() {
    if (!currentUser) {
        alert('Please sign in first');
        return;
    }
    
    try {
        console.log('ğŸ¥ Joining Stage 4 room...');
        
        // Request camera/mic permissions
        try {
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: true,
                video: true
            });
        } catch (error) {
            console.error('Media permission denied:', error);
            alert('âš ï¸ Camera and microphone access required for Stage 4.\n\nPlease allow permissions and try again.');
            return;
        }
        
        // Add to active participants
        await db.collection('tournaments').doc(currentTournament)
            .collection('liveRooms').doc('stage4').update({
                activeParticipants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
        
        // Hide Stage 3 container
        const stage3Container = document.getElementById('tournament-stage3');
        if (stage3Container) stage3Container.style.display = 'none';
        
        // Show Stage 4 participant interface
        showStage4ParticipantUI();
        
        console.log('âœ… Joined Stage 4 room');
        
    } catch (error) {
        console.error('Error joining Stage 4 room:', error);
        alert('Failed to join Stage 4 room: ' + error.message);
    }
}

// ===== SHOW STAGE 4 PARTICIPANT INTERFACE =====
function showStage4ParticipantUI() {
    const tournamentsSection = document.querySelector('#tournaments-section .word-database');
    let stage4Container = document.getElementById('tournament-stage4-participant');
    
    if (!stage4Container) {
        stage4Container = document.createElement('div');
        stage4Container.id = 'tournament-stage4-participant';
        tournamentsSection.appendChild(stage4Container);
    }
    
    stage4Container.style.display = 'block';
    
    stage4Container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¥ STAGE 4 LIVE ROOM</h2>
                <p style="margin: 0; opacity: 0.9;">Top 10 Face-to-Face Round</p>
            </div>
            
            <!-- My Video Controls -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="practice-btn" onclick="toggleMyAudio()" id="my-audio-btn" 
                            style="flex: 1; background: #28a745; font-size: 0.9rem; padding: 12px;">
                        ğŸ¤ Mic: ON
                    </button>
                    <button class="practice-btn" onclick="toggleMyVideo()" id="my-video-btn" 
                            style="flex: 1; background: #28a745; font-size: 0.9rem; padding: 12px;">
                        ğŸ¥ Camera: ON
                    </button>
                    <button class="practice-btn" onclick="leaveStage4Room()" 
                            style="flex: 1; background: #dc3545; font-size: 0.9rem; padding: 12px;">
                        ğŸšª Leave Room
                    </button>
                </div>
            </div>
            
            <!-- My Video Feed -->
            <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <video id="my-video-stage4" autoplay muted playsinline 
                       style="width: 100%; max-height: 400px; object-fit: cover;"></video>
                <div style="position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 25px; color: white; font-weight: bold; font-size: 1.1rem;">
                    ğŸ‘¤ YOU
                </div>
            </div>
            
            <!-- Status Display -->
            <div id="stage4-participant-status" style="text-align: center; padding: 40px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; color: white;">
                <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ¤</div>
                <h3 style="color: white; margin-bottom: 10px;">Connected to Stage 4 Room</h3>
                <p style="opacity: 0.9; margin: 0;">
                    Waiting for admin to start the round...<br>
                    Listen carefully and spell when it's your turn!
                </p>
            </div>
        </div>
    `;
    
    // Setup video
    const myVideo = document.getElementById('my-video-stage4');
    if (myVideo && localStream) {
        myVideo.srcObject = localStream;
    }
    
    // Listen for elimination/advancement
    listenForStage4Changes();
}

// ===== LISTEN FOR STAGE 4 STATUS CHANGES =====
function listenForStage4Changes() {
    const statusListener = db.collection('tournaments').doc(currentTournament)
        .collection('liveRooms').doc('stage4')
        .onSnapshot(doc => {
            if (!doc.exists) return;
            
            const roomData = doc.data();
            
            // Check if eliminated
            if (roomData.eliminatedParticipants?.includes(currentUser.uid)) {
                showEliminationMessage(4);
            }
            
            // Check if advanced to stage 5
            const stage5RoomRef = db.collection('tournaments').doc(currentTournament)
                .collection('liveRooms').doc('stage5');
            
            stage5RoomRef.get().then(stage5Doc => {
                if (stage5Doc.exists && stage5Doc.data().activeParticipants?.includes(currentUser.uid)) {
                    showAdvancementMessage(5);
                }
            });
        });
    
    if (!window.tournamentListeners) {
        window.tournamentListeners = [];
    }
    window.tournamentListeners.push(statusListener);
}

// ===== SHOW ELIMINATION MESSAGE =====
function showEliminationMessage(fromStage) {
    const container = document.getElementById('stage4-participant-status') || 
                      document.getElementById('stage5-participant-status') ||
                      document.getElementById('stage6-participant-status') ||
                      document.getElementById('stage7-participant-status');
    
    if (!container) return;
    
    container.innerHTML = `
        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ˜¢</div>
        <h2 style="color: white; margin-bottom: 15px;">You've Been Eliminated</h2>
        <p style="opacity: 0.9; font-size: 1.1rem;">
            Thank you for participating in Stage ${fromStage}!<br>
            Better luck next time.
        </p>
        <button class="practice-btn" onclick="exitTournamentAfterElimination()" 
                style="background: white; color: #dc3545; font-size: 1.1rem; padding: 15px 40px; margin-top: 20px;">
            ğŸ  Exit Tournament
        </button>
    `;
    
    // Stop media streams
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
}

// ===== SHOW ADVANCEMENT MESSAGE =====
function showAdvancementMessage(toStage) {
    const container = document.getElementById('stage4-participant-status') || 
                      document.getElementById('stage5-participant-status') ||
                      document.getElementById('stage6-participant-status');
    
    if (!container) return;
    
    container.innerHTML = `
        <div style="font-size: 4rem; margin-bottom: 20px; animation: bounce 1s infinite;">ğŸ‰</div>
        <h2 style="color: white; margin-bottom: 15px;">Congratulations!</h2>
        <p style="opacity: 0.9; font-size: 1.2rem; margin-bottom: 20px;">
            You've advanced to Stage ${toStage}!
        </p>
        <div class="loading" style="color: white;">Preparing Stage ${toStage} room...</div>
    `;
    
    // Auto-join next stage
    setTimeout(() => {
        if (toStage === 5) joinStage5Room();
        else if (toStage === 6) joinStage6Room();
        else if (toStage === 7) joinStage7Room();
    }, 3000);
}

// ===== LEAVE STAGE 4 ROOM =====
async function leaveStage4Room() {
    if (!confirm('ğŸšª Leave Stage 4 room? You will be eliminated from the tournament.')) {
        return;
    }
    
    try {
        // Stop media
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // Remove from room
        await db.collection('tournaments').doc(currentTournament)
            .collection('liveRooms').doc('stage4').update({
                activeParticipants: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
                eliminatedParticipants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
        
        // Update status
        await db.collection('tournaments').doc(currentTournament)
            .collection('participants').doc(currentUser.uid).update({
                status: 'eliminated-stage4',
                eliminatedReason: 'Left room voluntarily'
            });
        
        exitTournament();
        
    } catch (error) {
        console.error('Error leaving room:', error);
        alert('Failed to leave room');
    }
}

// ===== EXIT AFTER ELIMINATION =====
function exitTournamentAfterElimination() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    exitTournament();
}

// ===== ADMIN: ENTER STAGE 4 ROOM =====
async function enterStage4RoomAdmin(tournamentId) {
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    try {
        console.log('ğŸ¥ Admin entering Stage 4 room...');
        
        // Request camera/mic permissions
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        });
        
        // Mark admin as in room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage4').update({
                adminInRoom: true,
                adminJoinedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        // Close view modal
        closeViewTournamentModal();
        
        // Show admin Stage 4 interface
        showStage4AdminUI(tournamentId);
        
        console.log('âœ… Admin entered Stage 4 room');
        
    } catch (error) {
        console.error('Error entering Stage 4 room:', error);
        alert('Failed to access camera/microphone: ' + error.message);
    }
}

// ===== STAGE 4 ADMIN INTERFACE =====
function showStage4AdminUI(tournamentId) {
    // Hide all other sections
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const tournamentsSection = document.getElementById('tournaments-section');
    tournamentsSection.classList.add('active');
    
    const wordDatabase = tournamentsSection.querySelector('.word-database');
    
    // Create Stage 4 admin container
    let stage4AdminContainer = document.getElementById('stage4-admin-container');
    if (!stage4AdminContainer) {
        stage4AdminContainer = document.createElement('div');
        stage4AdminContainer.id = 'stage4-admin-container';
        wordDatabase.appendChild(stage4AdminContainer);
    }
    
    // Hide tournament lobby and other stages
    document.getElementById('tournament-lobby').style.display = 'none';
    const stage1 = document.getElementById('tournament-stage1');
    if (stage1) stage1.style.display = 'none';
    const stage2 = document.getElementById('tournament-stage2');
    if (stage2) stage2.style.display = 'none';
    const stage3 = document.getElementById('tournament-stage3');
    if (stage3) stage3.style.display = 'none';
    
    stage4AdminContainer.style.display = 'block';
    
    stage4AdminContainer.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¥ STAGE 4 ADMIN CONTROL</h2>
                <p style="margin: 0; opacity: 0.9;">Manage Top 10 Participants - Eliminate or Advance</p>
            </div>
            
            <!-- Admin Video Controls -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #0d3b66; margin: 0 0 10px 0;">ğŸ›ï¸ Admin Controls</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="toggleAdminAudio()" id="admin-audio-btn" 
                            style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                        ğŸ¤ Mic: ON
                    </button>
                    <button class="practice-btn" onclick="toggleAdminVideo()" id="admin-video-btn" 
                            style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                        ğŸ¥ Camera: ON
                    </button>
                </div>
            </div>
            
            <!-- Admin Video Feed -->
            <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <video id="admin-video-stage4" autoplay muted playsinline 
                       style="width: 100%; max-height: 300px; object-fit: cover;"></video>
                <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(255,215,0,0.9); padding: 8px 15px; border-radius: 20px; color: #0d3b66; font-weight: bold;">
                    ğŸ‘‘ ADMIN
                </div>
            </div>
            
            <!-- Participants Grid -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">
                    ğŸ‘¥ Active Participants (<span id="stage4-active-count">0</span>)
                </h3>
                <div id="stage4-participants-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Participants will be loaded here -->
                </div>
            </div>
            
            <!-- Eliminated Section -->
            <div id="stage4-eliminated-section" style="display: none; background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #721c24; margin: 0 0 15px 0;">
                    âŒ Eliminated (<span id="stage4-eliminated-count">0</span>)
                </h3>
                <div id="stage4-eliminated-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- Eliminated participants will be shown here -->
                </div>
            </div>
            
            <!-- Admin Actions -->
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                <h4 style="color: #856404; margin: 0 0 15px 0;">âš¡ Stage Actions</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="createStage5Room('${tournamentId}')" 
                            style="flex: 1; background: #667eea; font-size: 1.1rem; padding: 15px 30px;">
                        ğŸš€ Create Stage 5 Room
                    </button>
                    <button class="practice-btn" onclick="closeStage4AdminRoom('${tournamentId}')" 
                            style="background: #dc3545; font-size: 1rem; padding: 15px 30px;">
                        ğŸšª Close Room
                    </button>
                </div>
                <p style="color: #856404; margin: 15px 0 0 0; font-size: 0.9rem;">
                    â„¹ï¸ Eliminate participants until ready, then create Stage 5 room to advance remaining users
                </p>
            </div>
        </div>
    `;
    
    // Setup admin video
    const adminVideo = document.getElementById('admin-video-stage4');
    if (adminVideo && localStream) {
        adminVideo.srcObject = localStream;
    }
    
    // Load participants
    loadStage4Participants(tournamentId);
}

// ===== LOAD STAGE 4 PARTICIPANTS =====
async function loadStage4Participants(tournamentId) {
    const grid = document.getElementById('stage4-participants-grid');
    const eliminatedList = document.getElementById('stage4-eliminated-list');
    
    if (!grid) return;
    
    // Listen for room changes
    const roomListener = db.collection('tournaments').doc(tournamentId)
        .collection('liveRooms').doc('stage4')
        .onSnapshot(async (doc) => {
            if (!doc.exists) return;
            
            const roomData = doc.data();
            const activeIds = roomData.activeParticipants || [];
            const eliminatedIds = roomData.eliminatedParticipants || [];
            
            // Update counts
            document.getElementById('stage4-active-count').textContent = activeIds.length;
            document.getElementById('stage4-eliminated-count').textContent = eliminatedIds.length;
            
            // Show/hide eliminated section
            const eliminatedSection = document.getElementById('stage4-eliminated-section');
            if (eliminatedSection) {
                eliminatedSection.style.display = eliminatedIds.length > 0 ? 'block' : 'none';
            }
            
            // Clear grids
            grid.innerHTML = '';
            if (eliminatedList) eliminatedList.innerHTML = '';
            
            // Load active participants
            for (const userId of activeIds) {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) continue;
                
                const userData = userDoc.data();
                
                const participantCard = document.createElement('div');
                participantCard.style.cssText = `
                    background: white;
                    border-radius: 10px;
                    padding: 15px;
                    border: 2px solid #28a745;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                `;
                
                participantCard.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <img src="${userData.photoURL || 'https://via.placeholder.com/50'}" 
                             style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; object-fit: cover; border: 2px solid #28a745;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #0d3b66; font-size: 1rem;">
                                ${userData.firstName} ${userData.lastName}
                            </div>
                            <div style="color: #666; font-size: 0.85rem;">
                                ğŸ“§ ${userData.email}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Placeholder -->
                    <div style="background: #000; border-radius: 8px; height: 120px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 5px;">ğŸ‘¤</div>
                            <div style="font-size: 0.85rem;">Camera feed</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 8px;">
                        <button class="practice-btn" onclick="eliminateParticipantStage4('${userId}', '${tournamentId}')"
                                style="flex: 1; font-size: 0.85rem; padding: 10px; background: #dc3545;">
                            âŒ Eliminate
                        </button>
                        <button class="practice-btn" onclick="keepParticipantStage4('${userId}')"
                                style="flex: 1; font-size: 0.85rem; padding: 10px; background: #28a745;">
                            âœ… Keep
                        </button>
                    </div>
                `;
                
                grid.appendChild(participantCard);
            }
            
            // Load eliminated participants
            for (const userId of eliminatedIds) {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) continue;
                
                const userData = userDoc.data();
                
                const eliminatedBadge = document.createElement('div');
                eliminatedBadge.style.cssText = `
                    background: white;
                    padding: 10px 15px;
                    border-radius: 20px;
                    color: #721c24;
                    font-weight: bold;
                    font-size: 0.9rem;
                    display: inline-block;
                `;
                eliminatedBadge.textContent = `${userData.firstName} ${userData.lastName}`;
                
                if (eliminatedList) {
                    eliminatedList.appendChild(eliminatedBadge);
                }
            }
            
            // Show waiting message if no active participants
            if (activeIds.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 15px;">â³</div>
                        <h3>Waiting for participants to join...</h3>
                        <p>Top 10 qualified participants will appear here when they join the room</p>
                    </div>
                `;
            }
        });
    
    if (!window.tournamentListeners) {
        window.tournamentListeners = [];
    }
    window.tournamentListeners.push(roomListener);
}

// ===== ELIMINATE PARTICIPANT FROM STAGE 4 =====
async function eliminateParticipantStage4(userId, tournamentId) {
    if (!confirm('âŒ Eliminate this participant from Stage 4?')) {
        return;
    }
    
    try {
        // Move to eliminated list
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage4').update({
                activeParticipants: firebase.firestore.FieldValue.arrayRemove(userId),
                eliminatedParticipants: firebase.firestore.FieldValue.arrayUnion(userId)
            });
        
        // Update participant status
        await db.collection('tournaments').doc(tournamentId)
            .collection('participants').doc(userId).update({
                status: 'eliminated-stage4',
                eliminatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                eliminatedBy: 'admin'
            });
        
        console.log('âœ… Participant eliminated from Stage 4');
        
    } catch (error) {
        console.error('Error eliminating participant:', error);
        alert('Failed to eliminate participant');
    }
}

// ===== KEEP PARTICIPANT (CONFIRMATION) =====
function keepParticipantStage4(userId) {
    // Just visual feedback
    const msg = document.createElement('div');
    msg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #28a745;
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-weight: bold;
        z-index: 10001;
        animation: slideInRight 0.3s ease-out;
    `;
    msg.textContent = 'âœ… Participant kept in Stage 4';
    document.body.appendChild(msg);
    
    setTimeout(() => msg.remove(), 2000);
}

// ===== CREATE STAGE 5 ROOM =====
async function createStage5Room(tournamentId) {
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    try {
        // Get current active participants from Stage 4
        const stage4RoomDoc = await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage4').get();
        
        if (!stage4RoomDoc.exists) {
            alert('âŒ Stage 4 room not found');
            return;
        }
        
        const stage4Data = stage4RoomDoc.data();
        const activeParticipants = stage4Data.activeParticipants || [];
        
        if (activeParticipants.length === 0) {
            alert('âš ï¸ No active participants to advance to Stage 5');
            return;
        }
        
        if (activeParticipants.length > 5) {
            alert(`âš ï¸ Stage 5 is for Top 5 only.\n\nCurrent active: ${activeParticipants.length}\n\nPlease eliminate ${activeParticipants.length - 5} more participant(s) before creating Stage 5.`);
            return;
        }
        
        if (!confirm(`ğŸš€ Create Stage 5 room with ${activeParticipants.length} participant(s)?`)) {
            return;
        }
        
        console.log('ğŸ¥ Creating Stage 5 room...');
        
        // Create Stage 5 room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage5').set({
                stage: 5,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: true,
                activeParticipants: activeParticipants,
                eliminatedParticipants: [],
                adminInRoom: true
            });
        
        // Update all participants to Stage 5
        const batch = db.batch();
        activeParticipants.forEach(userId => {
            const userRef = db.collection('tournaments').doc(tournamentId)
                .collection('participants').doc(userId);
            batch.update(userRef, {
                status: 'stage5-active',
                stage: 5,
                advancedToStage5At: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        await batch.commit();
        
        // Close Stage 4 room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage4').update({
                isActive: false,
                closedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        console.log('âœ… Stage 5 room created');
        
        alert(`âœ… Stage 5 room created with ${activeParticipants.length} participant(s)!\n\nParticipants are being automatically moved to Stage 5.`);
        
        // Show Stage 5 admin interface
        showStage5AdminUI(tournamentId);
        
    } catch (error) {
        console.error('Error creating Stage 5 room:', error);
        alert('Failed to create Stage 5 room: ' + error.message);
    }
}

// ===== CLOSE STAGE 4 ADMIN ROOM =====
async function closeStage4AdminRoom(tournamentId) {
    if (!confirm('ğŸšª Close Stage 4 room and return to admin panel?')) {
        return;
    }
    
    try {
        // Stop media streams
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // Mark admin as left
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage4').update({
                adminInRoom: false
            });
        
        // Hide Stage 4 container
        const stage4Container = document.getElementById('stage4-admin-container');
        if (stage4Container) {
            stage4Container.style.display = 'none';
        }
        
        // Return to admin panel
        navigateTo('admin');
        
    } catch (error) {
        console.error('Error closing Stage 4 room:', error);
        alert('Failed to close room');
    }
}

// ===== STAGE 5 ADMIN INTERFACE =====
function showStage5AdminUI(tournamentId) {
    const stage4Container = document.getElementById('stage4-admin-container');
    if (stage4Container) stage4Container.style.display = 'none';
    
    const wordDatabase = document.querySelector('#tournaments-section .word-database');
    
    let stage5AdminContainer = document.getElementById('stage5-admin-container');
    if (!stage5AdminContainer) {
        stage5AdminContainer = document.createElement('div');
        stage5AdminContainer.id = 'stage5-admin-container';
        wordDatabase.appendChild(stage5AdminContainer);
    }
    
    stage5AdminContainer.style.display = 'block';
    
    stage5AdminContainer.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #f093fb, #f5576c); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¥ STAGE 5 ADMIN CONTROL (TOP 5)</h2>
                <p style="margin: 0; opacity: 0.9;">Manage Top 5 â†’ Top 3</p>
            </div>
            
            <!-- Admin Video Controls -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #0d3b66; margin: 0 0 10px 0;">ğŸ›ï¸ Admin Controls</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="toggleAdminAudio()" id="admin-audio-btn-stage5" 
                            style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                        ğŸ¤ Mic: ON
                    </button>
                    <button class="practice-btn" onclick="toggleAdminVideo()" id="admin-video-btn-stage5" 
                            style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                        ğŸ¥ Camera: ON
                    </button>
                </div>
            </div>
            
            <!-- Admin Video Feed -->
            <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <video id="admin-video-stage5" autoplay muted playsinline 
                       style="width: 100%; max-height: 300px; object-fit: cover;"></video>
                <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(255,215,0,0.9); padding: 8px 15px; border-radius: 20px; color: #0d3b66; font-weight: bold;">
                    ğŸ‘‘ ADMIN
                </div>
            </div>
            
            <!-- Participants Grid -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">
                    â­ Active Participants (<span id="stage5-active-count">0</span>)
                </h3>
                <div id="stage5-participants-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Participants will be loaded here -->
                </div>
            </div>
            
            <!-- Eliminated Section -->
            <div id="stage5-eliminated-section" style="display: none; background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #721c24; margin: 0 0 15px 0;">
                    âŒ Eliminated (<span id="stage5-eliminated-count">0</span>)
                </h3>
                <div id="stage5-eliminated-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- Eliminated participants -->
                </div>
            </div>
            
            <!-- Admin Actions -->
            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                <h4 style="color: #856404; margin: 0 0 15px 0;">âš¡ Stage Actions</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="createStage6Room('${tournamentId}')" 
                            style="flex: 1; background: #667eea; font-size: 1.1rem; padding: 15px 30px;">
                        ğŸš€ Create Stage 6 Room (Top 3)
                    </button>
                    <button class="practice-btn" onclick="closeStage5AdminRoom('${tournamentId}')" 
                            style="background: #dc3545; font-size: 1rem; padding: 15px 30px;">
                        ğŸšª Close Room
                    </button>
                </div>
                <p style="color: #856404; margin: 15px 0 0 0; font-size: 0.9rem;">
                    â„¹ï¸ Eliminate until 3 participants remain, then create Stage 6
                </p>
            </div>
        </div>
    `;
    
    // Setup admin video
    const adminVideo = document.getElementById('admin-video-stage5');
    if (adminVideo && localStream) {
        adminVideo.srcObject = localStream;
    }
    
    // Load participants
    loadStage5Participants(tournamentId);
}

// ===== LOAD STAGE 5 PARTICIPANTS =====
async function loadStage5Participants(tournamentId) {
    const grid = document.getElementById('stage5-participants-grid');
    const eliminatedList = document.getElementById('stage5-eliminated-list');
    
    if (!grid) return;
    
    const roomListener = db.collection('tournaments').doc(tournamentId)
        .collection('liveRooms').doc('stage5')
        .onSnapshot(async (doc) => {
            if (!doc.exists) return;
            
            const roomData = doc.data();
            const activeIds = roomData.activeParticipants || [];
            const eliminatedIds= roomData.eliminatedParticipants || [];
        document.getElementById('stage5-active-count').textContent = activeIds.length;
        document.getElementById('stage5-eliminated-count').textContent = eliminatedIds.length;
        
        const eliminatedSection = document.getElementById('stage5-eliminated-section');
        if (eliminatedSection) {
            eliminatedSection.style.display = eliminatedIds.length > 0 ? 'block' : 'none';
        }
        
        grid.innerHTML = '';
        if (eliminatedList) eliminatedList.innerHTML = '';
        
        // Load active participants
        for (const userId of activeIds) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) continue;
            
            const userData = userDoc.data();
            
            const participantCard = document.createElement('div');
            participantCard.style.cssText = `
                background: white;
                border-radius: 10px;
                padding: 15px;
                border: 2px solid #f093fb;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            `;
            
            participantCard.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <img src="${userData.photoURL || 'https://via.placeholder.com/50'}" 
                         style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; object-fit: cover; border: 2px solid #f093fb;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #0d3b66; font-size: 1rem;">
                            â­ ${userData.firstName} ${userData.lastName}
                        </div>
                        <div style="color: #666; font-size: 0.85rem;">
                            ğŸ“§ ${userData.email}
                        </div>
                    </div>
                </div>
                
                <div style="background: #000; border-radius: 8px; height: 120px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 5px;">ğŸ‘¤</div>
                        <div style="font-size: 0.85rem;">Camera feed</div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px;">
                    <button class="practice-btn" onclick="eliminateParticipantStage5('${userId}', '${tournamentId}')"
                            style="flex: 1; font-size: 0.85rem; padding: 10px; background: #dc3545;">
                        âŒ Eliminate
                    </button>
                    <button class="practice-btn" onclick="keepParticipantStage5('${userId}')"
                            style="flex: 1; font-size: 0.85rem; padding: 10px; background: #28a745;">
                        âœ… Keep
                    </button>
                </div>
            `;
            
            grid.appendChild(participantCard);
        }
        
        // Load eliminated
        for (const userId of eliminatedIds) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (!userDoc.exists) continue;
            
            const userData = userDoc.data();
            
            const eliminatedBadge = document.createElement('div');
            eliminatedBadge.style.cssText = `
                background: white;
                padding: 10px 15px;
                border-radius: 20px;
                color: #721c24;
                font-weight: bold;
                font-size: 0.9rem;
            `;
            eliminatedBadge.textContent = `${userData.firstName} ${userData.lastName}`;
            
            if (eliminatedList) eliminatedList.appendChild(eliminatedBadge);
        }
    });

if (!window.tournamentListeners) {
    window.tournamentListeners = [];
}
window.tournamentListeners.push(roomListener);
}
// ===== ELIMINATE FROM STAGE 5 =====
async function eliminateParticipantStage5(userId, tournamentId) {
if (!confirm('âŒ Eliminate this participant from Stage 5?')) {
return;
}
try {
    await db.collection('tournaments').doc(tournamentId)
        .collection('liveRooms').doc('stage5').update({
            activeParticipants: firebase.firestore.FieldValue.arrayRemove(userId),
            eliminatedParticipants: firebase.firestore.FieldValue.arrayUnion(userId)
        });
    
    await db.collection('tournaments').doc(tournamentId)
        .collection('participants').doc(userId).update({
            status: 'eliminated-stage5',
            eliminatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    
    console.log('âœ… Participant eliminated from Stage 5');
    
} catch (error) {
    console.error('Error:', error);
    alert('Failed to eliminate participant');
}
}
function keepParticipantStage5(userId) {
    const msg = document.createElement('div');
    msg.style.cssText = `
        position: fixed; 
        top: 20px; 
        right: 20px;         
        background: #28a745; 
        color: white;         
        padding: 15px 25px; 
        border-radius: 8px;         
        font-weight: bold; 
        z-index: 10001;
    `;
    msg.textContent = 'âœ… Participant kept in Stage 5';
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
}
// ===== PARTICIPANT: JOIN STAGE 5 =====
async function joinStage5Room() {
try {
console.log('ğŸ¥ Joining Stage 5...');
    // Ensure media is still active
    if (!localStream) {
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        });
    }
    
    // Hide Stage 4 UI
    const stage4UI = document.getElementById('tournament-stage4-participant');
    if (stage4UI) stage4UI.style.display = 'none';
    
    // Show Stage 5 UI
    showStage5ParticipantUI();
    
} catch (error) {
    console.error('Error joining Stage 5:', error);
    alert('Failed to join Stage 5');
}
}
function showStage5ParticipantUI() {
const tournamentsSection = document.querySelector('#tournaments-section .word-database');
let stage5Container = document.getElementById('tournament-stage5-participant');
if (!stage5Container) {
    stage5Container = document.createElement('div');
    stage5Container.id = 'tournament-stage5-participant';
    tournamentsSection.appendChild(stage5Container);
}

stage5Container.style.display = 'block';

stage5Container.innerHTML = `
    <div class="quiz-question-card">
        <div style="background: linear-gradient(135deg, #f093fb, #f5576c); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
            <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¥ STAGE 5 LIVE ROOM</h2>
            <p style="margin: 0; opacity: 0.9;">Top 5 Face-to-Face Round</p>
        </div>
        
        <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px;">
                <button class="practice-btn" onclick="toggleMyAudio()" id="my-audio-btn-stage5" 
                        style="flex: 1; background: #28a745;">
                    ğŸ¤ Mic: ON
                </button>
                <button class="practice-btn" onclick="toggleMyVideo()" id="my-video-btn-stage5" 
                        style="flex: 1; background: #28a745;">
                    ğŸ¥ Camera: ON
                </button>
                <button class="practice-btn" onclick="leaveStage5Room()" 
                        style="flex: 1; background: #dc3545;">
                    ğŸšª Leave
                </button>
            </div>
        </div>
        
        <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
            <video id="my-video-stage5" autoplay muted playsinline 
                   style="width: 100%; max-height: 400px; object-fit: cover;"></video>
            <div style="position: absolute; bottom: 15px; left: 15px; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 25px; color: white; font-weight: bold;">
                ğŸ‘¤ YOU - TOP 5!
            </div>
        </div>
        
        <div id="stage5-participant-status" style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f093fb, #f5576c); border-radius: 15px; color: white;">
            <div style="font-size: 3rem; margin-bottom: 15px;">â­</div>
            <h3 style="color: white; margin-bottom: 10px;">Stage 5 - Top 5!</h3>
            <p style="opacity: 0.9;">
                Congratulations on making it this far!<br>
                Wait for admin instructions...
            </p>
        </div>
    </div>
`;

const myVideo = document.getElementById('my-video-stage5');
if (myVideo && localStream) {
    myVideo.srcObject = localStream;
}

listenForStage5Changes();
}
function listenForStage5Changes() {
const listener = db.collection('tournaments').doc(currentTournament)
.collection('liveRooms').doc('stage5')
.onSnapshot(doc => {
if (!doc.exists) return;
        const roomData = doc.data();
        
        if (roomData.eliminatedParticipants?.includes(currentUser.uid)) {
            showEliminationMessage(5);
        }
        
        // Check Stage 6
        db.collection('tournaments').doc(currentTournament)
            .collection('liveRooms').doc('stage6').get()
            .then(stage6Doc => {
                if (stage6Doc.exists && stage6Doc.data().activeParticipants?.includes(currentUser.uid)) {
                    showAdvancementMessage(6);
                }
            });
    });

if (!window.tournamentListeners) window.tournamentListeners = [];
window.tournamentListeners.push(listener);
}
async function leaveStage5Room() {
if (!confirm('ğŸšª Leave Stage 5?')) return;
try {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    await db.collection('tournaments').doc(currentTournament)
        .collection('liveRooms').doc('stage5').update({
            activeParticipants: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
            eliminatedParticipants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
    
    exitTournament();
} catch (error) {
    console.error('Error:', error);
}
}
async function closeStage5AdminRoom(tournamentId) {
if (!confirm('ğŸšª Close Stage 5 room?')) return;
try {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        localStream = null;
    }
    
    await db.collection('tournaments').doc(tournamentId)
        .collection('liveRooms').doc('stage5').update({
            adminInRoom: false
        });
    
    const stage5Container = document.getElementById('stage5-admin-container');
    if (stage5Container) stage5Container.style.display = 'none';
    
    navigateTo('admin');
} catch (error) {
    console.error('Error:', error);
}
}
 function startStage4AsCaller() {
    tournamentStage = 4;
    currentLiveStageIndex = 0;
    liveStageParticipants = ['Demo Player 1', 'Demo Player 2', 'Demo Player 3']; // Simulated players
    eliminatedPlayers = [];
    
    const tournamentsSection = document.querySelector('#tournaments-section .word-database');
    let stage4Container = document.getElementById('tournament-stage4');
    
    if (!stage4Container) {
        stage4Container = document.createElement('div');
        stage4Container.id = 'tournament-stage4';
        tournamentsSection.appendChild(stage4Container);
    }
    
    stage4Container.style.display = 'block';
    
    buildStage4CallerUI();
}

function buildStage4CallerUI() {
    const container = document.getElementById('tournament-stage4');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¤ Stage 4: Live Spell Master (Caller Mode)</h2>
                <p style="margin: 0; opacity: 0.9;">You are the human caller for this round</p>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">ğŸ‘¥ Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #d4edda; padding: 10px 20px; border-radius: 20px; color: #155724; font-weight: bold;">
                            âœ… ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">âŒ Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: white;">ğŸ“ Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="caller-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length ? `
                    <button class="practice-btn" onclick="speakCallerWord()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ğŸ”Š Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakCallerSentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        ğŸ’¬ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="caller-controls">
                ${currentLiveStageIndex < liveStageWords.length ? `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 15px 0;">ğŸ“‹ Caller Instructions:</h4>
                        <ol style="color: #856404; margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Pronounce the word clearly</li>
                            <li>Use it in a sentence if requested</li>
                            <li>Mark each speller as correct or incorrect</li>
                            <li>One mistake eliminates a speller (unless they have a Shield)</li>
                        </ol>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markSpellerCorrect(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        âœ… Correct
                                    </button>
                                    <button class="practice-btn" onclick="markSpellerIncorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        âŒ Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextCallerWord()" style="font-size: 1.2rem; padding: 15px 40px; background: #667eea;">
                            â¡ï¸ Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ†</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 4 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} spellers advance to Stage 5
                        </p>
                        
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3 style="color: #155724; margin-bottom: 15px;">âœ… Qualified for Stage 5:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                ${liveStageParticipants.map(player => `
                                    <div style="background: white; padding: 15px 25px; border-radius: 10px; color: #155724; font-weight: bold; font-size: 1.1rem;">
                                        ğŸŒŸ ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage5()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            â¡ï¸ Proceed to Stage 5 (Top 5)
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            ğŸ  Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}   

    // ===== TOURNAMENT STAGE 5 FUNCTIONS (Top 10 â†’ Top 5) =====

async function proceedToStage5() {
    try {
        console.log('ğŸ¯ Starting Stage 5: Live Spell Master (Top 10 â†’ Top 5)');
        
        tournamentStage = 5;
        currentLiveStageIndex = 0;
        
        // Keep current participants from Stage 4
        if (liveStageParticipants.length > 10) {
            liveStageParticipants = liveStageParticipants.slice(0, 10);
        }
        
        eliminatedPlayers = [];
        
        // Generate words for Stage 5
        await generateLiveStageWords(15); // 15 words for Stage 5
        
        // Hide Stage 4
        const stage4 = document.getElementById('tournament-stage4');
        if (stage4) stage4.style.display = 'none';
        
        // Create Stage 5 container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage5Container = document.getElementById('tournament-stage5');
        
        if (!stage5Container) {
            stage5Container = document.createElement('div');
            stage5Container.id = 'tournament-stage5';
            tournamentsSection.appendChild(stage5Container);
        }
        
        stage5Container.style.display = 'block';
        
        // Show caller interface for Stage 5
        buildStage5CallerUI();
        
    } catch (error) {
        console.error('Error starting Stage 5:', error);
        alert('Failed to start Stage 5: ' + error.message);
    }
}

function buildStage5CallerUI() {
    const container = document.getElementById('tournament-stage5');
    const targetCount = 5; // Advance top 5
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¤ Stage 5: Live Spell Master (Top 10 â†’ Top 5)</h2>
                <p style="margin: 0; opacity: 0.9;">Spell until ${targetCount} spellers remain</p>
            </div>
            
            <!-- Progress Bar -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span style="color: #666; font-weight: bold;">Active: ${liveStageParticipants.length}</span>
                    <span style="color: #667eea; font-weight: bold;">Target: ${targetCount}</span>
                    <span style="color: #dc3545; font-weight: bold;">Eliminated: ${eliminatedPlayers.length}</span>
                </div>
                <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                    <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${((liveStageParticipants.length / 10) * 100)}%; transition: width 0.3s;"></div>
                </div>
            </div>
            
            <!-- Active Players -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">ğŸ‘¥ Active Spellers (${liveStageParticipants.length})</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${liveStageParticipants.map(player => `
                        <div style="background: #d4edda; padding: 10px 20px; border-radius: 20px; color: #155724; font-weight: bold;">
                            âœ… ${player}
                        </div>
                    `).join('')}
                </div>
            </div>
            
            ${eliminatedPlayers.length > 0 ? `
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #721c24; margin: 0 0 15px 0;">âŒ Eliminated (${eliminatedPlayers.length})</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${eliminatedPlayers.map(player => `
                            <div style="background: white; padding: 10px 20px; border-radius: 20px; color: #721c24;">
                                ${player}
                            </div>
                        `).join('')}
                    </div>
                </div>
            ` : ''}
            
            <!-- Current Word -->
            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 30px; border-radius: 15px; margin: 20px 0; color: white; text-align: center;">
                <h3 style="margin: 0 0 15px 0; color: white;">ğŸ“ Word ${currentLiveStageIndex + 1} of ${liveStageWords.length}</h3>
                <div id="stage5-word-display" style="font-size: 3rem; font-weight: bold; margin: 20px 0; letter-spacing: 2px;">
                    ${currentLiveStageIndex < liveStageWords.length ? liveStageWords[currentLiveStageIndex].toUpperCase() : 'COMPLETE'}
                </div>
                
                ${currentLiveStageIndex < liveStageWords.length && liveStageParticipants.length > targetCount ? `
                    <button class="practice-btn" onclick="speakStage5Word()" style="background: white; color: #0d3b66; font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                        ğŸ”Š Pronounce Word
                    </button>
                    <button class="practice-btn" onclick="speakStage5Sentence()" style="background: rgba(255,255,255,0.9); color: #0d3b66; font-size: 1.1rem; padding: 12px 30px; margin: 10px;">
                        ğŸ’¬ Use in Sentence
                    </button>
                ` : ''}
            </div>
            
            <!-- Caller Controls -->
            <div id="stage5-caller-controls">
                ${liveStageParticipants.length > targetCount && currentLiveStageIndex < liveStageWords.length ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                        ${liveStageParticipants.map((player, index) => `
                            <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; text-align: center;">
                                <h4 style="color: #0d3b66; margin: 0 0 15px 0;">${player}</h4>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button class="practice-btn" onclick="markStage5Correct(${index})" style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                                        âœ… Correct
                                    </button>
                                    <button class="practice-btn" onclick="markStage5Incorrect(${index})" style="background: #dc3545; font-size: 0.9rem; padding: 10px 20px;">
                                        âŒ Wrong
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="practice-btn" onclick="nextStage5Word()" style="font-size: 1.2rem; padding: 15px 40px; background: #667eea;">
                            â¡ï¸ Next Word
                        </button>
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ†</div>
                        <h2 style="color: #0d3b66; margin-bottom: 20px;">Stage 5 Complete!</h2>
                        <p style="font-size: 1.2rem; color: #666; margin: 20px 0;">
                            Top ${liveStageParticipants.length} spellers advance to Stage 6
                        </p>
                        
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <h3 style="color: #155724; margin-bottom: 15px;">âœ… Qualified for Stage 6:</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                ${liveStageParticipants.map(player => `
                                    <div style="background: white; padding: 15px 25px; border-radius: 10px; color: #155724; font-weight: bold; font-size: 1.1rem;">
                                        ğŸŒŸ ${player}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <button class="practice-btn" onclick="proceedToStage6()" style="font-size: 1.2rem; padding: 15px 40px; margin: 10px;">
                            â¡ï¸ Proceed to Stage 6 (Top 5 â†’ Top 3)
                        </button>
                        <button class="practice-btn" onclick="exitTournament()" style="font-size: 1rem; padding: 12px 30px; background: #6c757d; margin: 10px;">
                            ğŸ  Exit Tournament
                        </button>
                    </div>
                `}
            </div>
        </div>
    `;
}

function speakStage5Word() {
    const word = liveStageWords[currentLiveStageIndex];
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.rate = 0.7;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}

async function speakStage5Sentence() {
    const word = liveStageWords[currentLiveStageIndex];
    
    try {
        const wordRef = db.collection('dictionary').doc(word.toLowerCase());
        const wordDoc = await wordRef.get();
        
        let sentence = `The word is ${word}.`;
        
        if (wordDoc.exists) {
            const data = wordDoc.data();
            if (data.meanings && data.meanings.length > 0) {
                for (let meaning of data.meanings) {
                    if (meaning.example) {
                        sentence = meaning.example;
                        break;
                    }
                }
            }
        }
        
        const utterance = new SpeechSynthesisUtterance(sentence);
        utterance.rate = 0.8;
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(utterance);
        
    } catch (error) {
        console.error('Error getting sentence:', error);
        speakStage5Word();
    }
}

function markStage5Correct(playerIndex) {
    // Player stays in the game
    console.log(`âœ… ${liveStageParticipants[playerIndex]} spelled correctly`);
}

function markStage5Incorrect(playerIndex) {
    const player = liveStageParticipants[playerIndex];
    
    if (confirm(`âŒ Are you sure ${player} spelled incorrectly? This will eliminate them.`)) {
        eliminatedPlayers.push(player);
        liveStageParticipants.splice(playerIndex, 1);
        
        // Rebuild UI
        buildStage5CallerUI();
    }
}

function nextStage5Word() {
    currentLiveStageIndex++;
    
    if (liveStageParticipants.length <= 5) {
        // Reached target - complete stage
        buildStage5CallerUI();
    } else if (currentLiveStageIndex >= liveStageWords.length) {
        // Ran out of words but still too many players - generate more
        alert('âš ï¸ Need more words! Generating additional words...');
        generateLiveStageWords(10).then(() => {
            currentLiveStageIndex = 0;
            buildStage5CallerUI();
        });
    } else {
        // Continue to next word
        buildStage5CallerUI();
    }
}

// ===== CREATE STAGE 6 ROOM (TOP 5 â†’ TOP 3) =====
async function createStage6Room(tournamentId) {
    if (!isAdmin) {
        alert('â›” Admin access required');
        return;
    }
    
    try {
        // Get current active participants from Stage 5
        const stage5RoomDoc = await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage5').get();
        
        if (!stage5RoomDoc.exists) {
            alert('â›” Stage 5 room not found');
            return;
        }
        
        const stage5Data = stage5RoomDoc.data();
        const activeParticipants = stage5Data.activeParticipants || [];
        
        if (activeParticipants.length === 0) {
            alert('âš ï¸ No active participants to advance to Stage 6');
            return;
        }
        
        if (activeParticipants.length > 3) {
            alert(`âš ï¸ Stage 6 is for Top 3 only.\n\nCurrent active: ${activeParticipants.length}\n\nPlease eliminate ${activeParticipants.length - 3} more participant(s) before creating Stage 6.`);
            return;
        }
        
        if (!confirm(`ğŸš€ Create Stage 6 room with ${activeParticipants.length} participant(s)?`)) {
            return;
        }
        
        console.log('ğŸ¥ Creating Stage 6 room...');
        
        // Create Stage 6 room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage6').set({
                stage: 6,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: true,
                activeParticipants: activeParticipants,
                eliminatedParticipants: [],
                adminInRoom: true
            });
        
        // Update all participants to Stage 6
        const batch = db.batch();
        activeParticipants.forEach(userId => {
            const userRef = db.collection('tournaments').doc(tournamentId)
                .collection('participants').doc(userId);
            batch.update(userRef, {
                status: 'stage6-active',
                stage: 6,
                advancedToStage6At: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        await batch.commit();
        
        // Close Stage 5 room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage5').update({
                isActive: false,
                closedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        console.log('âœ… Stage 6 room created');
        
        alert(`âœ… Stage 6 room created with ${activeParticipants.length} participant(s)!\n\nParticipants are being automatically moved to Stage 6.`);
        
        // Show Stage 6 admin interface
        showStage6AdminUI(tournamentId);
        
    } catch (error) {
        console.error('Error creating Stage 6 room:', error);
        alert('Failed to create Stage 6 room: ' + error.message);
    }
}

// ===== STAGE 6 ADMIN INTERFACE =====
function showStage6AdminUI(tournamentId) {
    const stage5Container = document.getElementById('stage5-admin-container');
    if (stage5Container) stage5Container.style.display = 'none';
    
    const wordDatabase = document.querySelector('#tournaments-section .word-database');
    
    let stage6AdminContainer = document.getElementById('stage6-admin-container');
    if (!stage6AdminContainer) {
        stage6AdminContainer = document.createElement('div');
        stage6AdminContainer.id = 'stage6-admin-container';
        wordDatabase.appendChild(stage6AdminContainer);
    }
    
    stage6AdminContainer.style.display = 'block';
    
    stage6AdminContainer.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: #0d3b66;">
                <h2 style="margin: 0 0 10px 0;">ğŸ¥ STAGE 6 ADMIN CONTROL (TOP 3)</h2>
                <p style="margin: 0; opacity: 0.9;">Final 3 Participants - All advance to Finals</p>
            </div>
            
            <!-- Admin Video Controls -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #0d3b66; margin: 0 0 10px 0;">ğŸ›ï¸ Admin Controls</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="toggleAdminAudio()" id="admin-audio-btn-stage6" 
                            style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                        ğŸ¤ Mic: ON
                    </button>
                    <button class="practice-btn" onclick="toggleAdminVideo()" id="admin-video-btn-stage6" 
                            style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                        ğŸ¥ Camera: ON
                    </button>
                </div>
            </div>
            
            <!-- Admin Video Feed -->
            <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <video id="admin-video-stage6" autoplay muted playsinline 
                       style="width: 100%; max-height: 300px; object-fit: cover;"></video>
                <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(255,215,0,0.9); padding: 8px 15px; border-radius: 20px; color: #0d3b66; font-weight: bold;">
                    ğŸ‘‘ ADMIN
                </div>
            </div>
            
            <!-- Participants Grid -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">
                    ğŸŒŸ Final 3 Participants (<span id="stage6-active-count">0</span>)
                </h3>
                <div id="stage6-participants-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <!-- Participants will be loaded here -->
                </div>
            </div>
            
            <!-- Admin Actions -->
            <div style="background: #d4edda; padding: 20px; border-radius: 10px; border-left: 4px solid #28a745;">
                <h4 style="color: #155724; margin: 0 0 15px 0;">âœ… All 3 finalists will advance to Stage 7</h4>
                <p style="color: #155724; margin: 0 0 15px 0;">
                    The final stage lets you select winner, 2nd place, and 3rd place.
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="createStage7Room('${tournamentId}')" 
                            style="flex: 1; background: linear-gradient(135deg, #FFD700, #FFA500); color: #0d3b66; font-size: 1.2rem; padding: 15px 30px; font-weight: bold;">
                        ğŸ† CREATE STAGE 7 - FINALS
                    </button>
                    <button class="practice-btn" onclick="closeStage6AdminRoom('${tournamentId}')" 
                            style="background: #dc3545; font-size: 1rem; padding: 15px 30px;">
                        ğŸšª Close Room
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Setup admin video
    const adminVideo = document.getElementById('admin-video-stage6');
    if (adminVideo && localStream) {
        adminVideo.srcObject = localStream;
    }
    
    // Load participants
    loadStage6Participants(tournamentId);
}

// ===== LOAD STAGE 6 PARTICIPANTS =====
async function loadStage6Participants(tournamentId) {
    const grid = document.getElementById('stage6-participants-grid');
    
    if (!grid) return;
    
    const roomListener = db.collection('tournaments').doc(tournamentId)
        .collection('liveRooms').doc('stage6')
        .onSnapshot(async (doc) => {
            if (!doc.exists) return;
            
            const roomData = doc.data();
            const activeIds = roomData.activeParticipants || [];
            
            document.getElementById('stage6-active-count').textContent = activeIds.length;
            
            grid.innerHTML = '';
            
            // Load active participants
            for (const userId of activeIds) {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) continue;
                
                const userData = userDoc.data();
                
                const participantCard = document.createElement('div');
                participantCard.style.cssText = `
                    background: white;
                    border-radius: 10px;
                    padding: 15px;
                    border: 3px solid #FFD700;
                    box-shadow: 0 5px 15px rgba(255,215,0,0.3);
                `;
                
                participantCard.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <img src="${userData.photoURL || 'https://via.placeholder.com/50'}" 
                             style="width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; object-fit: cover; border: 2px solid #FFD700;">
                        <div style="flex: 1;">
                            <div style="font-weight: bold; color: #0d3b66; font-size: 1rem;">
                                ğŸŒŸ ${userData.firstName} ${userData.lastName}
                            </div>
                            <div style="color: #666; font-size: 0.85rem;">
                                ğŸ“§ ${userData.email}
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #000; border-radius: 8px; height: 120px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 10px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 5px;">ğŸ‘¤</div>
                            <div style="font-size: 0.85rem;">Camera feed</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 12px; border-radius: 8px; text-align: center; color: #0d3b66; font-weight: bold; font-size: 1.1rem;">
                        ğŸ† FINALIST
                    </div>
                `;
                
                grid.appendChild(participantCard);
            }
        });

    if (!window.tournamentListeners) {
        window.tournamentListeners = [];
    }
    window.tournamentListeners.push(roomListener);
}

// ===== PARTICIPANT: JOIN STAGE 6 =====
async function joinStage6Room() {
    try {
        console.log('ğŸ¥ Joining Stage 6...');
        
        // Ensure media is still active
        if (!localStream) {
            localStream = await navigator.mediaDevices.getUserMedia({
                audio: true,
                video: true
            });
        }
        
        // Hide Stage 5 UI
        const stage5UI = document.getElementById('tournament-stage5-participant');
        if (stage5UI) stage5UI.style.display = 'none';
        
        // Show Stage 6 UI
        showStage6ParticipantUI();
        
    } catch (error) {
        console.error('Error joining Stage 6:', error);
        alert('Failed to join Stage 6');
    }
}

function showStage6ParticipantUI() {
    const tournamentsSection = document.querySelector('#tournaments-section .word-database');
    let stage6Container = document.getElementById('tournament-stage6-participant');
    
    if (!stage6Container) {
        stage6Container = document.createElement('div');
        stage6Container.id = 'tournament-stage6-participant';
        tournamentsSection.appendChild(stage6Container);
    }
    
    stage6Container.style.display = 'block';
    
    stage6Container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: #0d3b66;">
                <h2 style="margin: 0 0 10px 0;">ğŸ¥ STAGE 6 LIVE ROOM</h2>
                <p style="margin: 0; opacity: 0.9;">Top 3 Final Round</p>
            </div>
            
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <button class="practice-btn" onclick="toggleMyAudio()" id="my-audio-btn-stage6" 
                            style="flex: 1; background: #28a745;">
                        ğŸ¤ Mic: ON
                    </button>
                    <button class="practice-btn" onclick="toggleMyVideo()" id="my-video-btn-stage6" 
                            style="flex: 1; background: #28a745;">
                        ğŸ¥ Camera: ON
                    </button>
                    <button class="practice-btn" onclick="leaveStage6Room()" 
                            style="flex: 1; background: #dc3545;">
                        ğŸšª Leave
                    </button>
                </div>
            </div>
            
            <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <video id="my-video-stage6" autoplay muted playsinline 
                       style="width: 100%; max-height: 400px; object-fit: cover;"></video>
                <div style="position: absolute; bottom: 15px; left: 15px; background: rgba(255,215,0,0.9); padding: 10px 20px; border-radius: 25px; color: #0d3b66; font-weight: bold;">
                    ğŸ‘¤ YOU - TOP 3!
                </div>
            </div>
            
            <div id="stage6-participant-status" style="text-align: center; padding: 40px; background: linear-gradient(135deg, #FFD700, #FFA500); border-radius: 15px; color: #0d3b66;">
                <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ†</div>
                <h3 style="margin-bottom: 10px;">Stage 6 - FINAL 3!</h3>
                <p style="opacity: 0.9;">
                    Congratulations on making the finals!<br>
                    Wait for admin to advance you to Stage 7...
                </p>
            </div>
        </div>
    `;
    
    const myVideo = document.getElementById('my-video-stage6');
    if (myVideo && localStream) {
        myVideo.srcObject = localStream;
    }
    
    listenForStage6Changes();
}

function listenForStage6Changes() {
    const listener = db.collection('tournaments').doc(currentTournament)
        .collection('liveRooms').doc('stage6')
        .onSnapshot(doc => {
            if (!doc.exists) return;
            
            // Check Stage 7
            db.collection('tournaments').doc(currentTournament)
                .collection('liveRooms').doc('stage7').get()
                .then(stage7Doc => {
                    if (stage7Doc.exists && stage7Doc.data().activeParticipants?.includes(currentUser.uid)) {
                        showAdvancementMessage(7);
                    }
                });
        });
    
    if (!window.tournamentListeners) window.tournamentListeners = [];
    window.tournamentListeners.push(listener);
}

async function leaveStage6Room() {
    if (!confirm('ğŸšª Leave Stage 6?')) return;
    
    try {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        exitTournament();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function closeStage6AdminRoom(tournamentId) {
    if (!confirm('ğŸšª Close Stage 6 room?')) return;
    
    try {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage6').update({
                adminInRoom: false
            });
        
        const stage6Container = document.getElementById('stage6-admin-container');
        if (stage6Container) stage6Container.style.display = 'none';
        
        navigateTo('admin');
    } catch (error) {
        console.error('Error:', error);
    }
}

// ===== CREATE STAGE 7 ROOM (FINALS - SELECT WINNER) =====
async function createStage7Room(tournamentId) {
    if (!isAdmin) {
        alert('â›” Admin access required');
        return;
    }
    
    try {
        // Get current active participants from Stage 6
        const stage6RoomDoc = await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage6').get();
        
        if (!stage6RoomDoc.exists) {
            alert('â›” Stage 6 room not found');
            return;
        }
        
        const stage6Data = stage6RoomDoc.data();
        const activeParticipants = stage6Data.activeParticipants || [];
        
        if (activeParticipants.length !== 3) {
            alert(`âš ï¸ Stage 7 requires exactly 3 participants.\n\nCurrent: ${activeParticipants.length}`);
            return;
        }
        
        if (!confirm(`ğŸ† Create Stage 7 FINALS with all 3 participants?`)) {
            return;
        }
        
        console.log('ğŸ¥ Creating Stage 7 FINALS room...');
        
        // Create Stage 7 room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage7').set({
                stage: 7,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: true,
                activeParticipants: activeParticipants,
                winner: null,
                secondPlace: null,
                thirdPlace: null,
                adminInRoom: true
            });
        
        // Update all participants to Stage 7
        const batch = db.batch();
        activeParticipants.forEach(userId => {
            const userRef = db.collection('tournaments').doc(tournamentId)
                .collection('participants').doc(userId);
            batch.update(userRef, {
                status: 'stage7-finals',
                stage: 7,
                advancedToStage7At: firebase.firestore.FieldValue.serverTimestamp()
            });
        });
        await batch.commit();
        
        // Close Stage 6 room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage6').update({
                isActive: false,
                closedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        console.log('âœ… Stage 7 FINALS room created');
        
        alert(`âœ… Stage 7 FINALS created!\n\nAll 3 participants are moving to the final stage.`);
        
        // Show Stage 7 admin interface
        showStage7AdminUI(tournamentId);
        
    } catch (error) {
        console.error('Error creating Stage 7 room:', error);
        alert('Failed to create Stage 7 room: ' + error.message);
    }
}

// ===== STAGE 7 ADMIN INTERFACE (FINALS) =====
function showStage7AdminUI(tournamentId) {
    const stage6Container = document.getElementById('stage6-admin-container');
    if (stage6Container) stage6Container.style.display = 'none';
    
    const wordDatabase = document.querySelector('#tournaments-section .word-database');
    
    let stage7AdminContainer = document.getElementById('stage7-admin-container');
    if (!stage7AdminContainer) {
        stage7AdminContainer = document.createElement('div');
        stage7AdminContainer.id = 'stage7-admin-container';
        wordDatabase.appendChild(stage7AdminContainer);
    }
    
    stage7AdminContainer.style.display = 'block';
    
    stage7AdminContainer.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 30px; border-radius: 15px; margin-bottom: 20px; color: white; text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ†</div>
                <h1 style="margin: 0 0 10px 0; color: white; font-size: 2.5rem;">STAGE 7 - GRAND FINALS</h1>
                <p style="margin: 0; opacity: 0.9; font-size: 1.2rem;">Select Winner, 2nd Place & 3rd Place</p>
            </div>
            
            <!-- Admin Video Controls -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <h4 style="color: #0d3b66; margin: 0 0 10px 0;">ğŸ›ï¸ Admin Controls</h4>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="toggleAdminAudio()" id="admin-audio-btn-stage7" 
                            style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                        ğŸ¤ Mic: ON
                    </button>
                    <button class="practice-btn" onclick="toggleAdminVideo()" id="admin-video-btn-stage7" 
                            style="background: #28a745; font-size: 0.9rem; padding: 10px 20px;">
                        ğŸ¥ Camera: ON
                    </button>
                </div>
            </div>
            
            <!-- Admin Video Feed -->
            <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <video id="admin-video-stage7" autoplay muted playsinline 
                       style="width: 100%; max-height: 300px; object-fit: cover;"></video>
                <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(255,215,0,0.9); padding: 8px 15px; border-radius: 20px; color: #0d3b66; font-weight: bold;">
                    ğŸ‘‘ ADMIN
                </div>
            </div>
            
            <!-- Finalists Selection -->
            <div style="background: #f9f9f9; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 20px 0; text-align: center;">
                    ğŸŒŸ Select Final Rankings
                </h3>
                <div id="stage7-finalists-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Finalists will be loaded here -->
                </div>
            </div>
            
            <!-- Results Display -->
            <div id="stage7-results" style="display: none; background: linear-gradient(135deg, #FFD700, #FFA500); padding: 30px; border-radius: 15px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 20px 0; text-align: center; font-size: 1.8rem;">
                    ğŸ† FINAL RESULTS
                </h3>
                <div id="stage7-results-content" style="display: grid; gap: 20px;">
                    <!-- Results will be shown here -->
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px;">
                <button class="practice-btn" onclick="finalizeTournament('${tournamentId}')" id="finalize-btn"
                        style="flex: 1; background: linear-gradient(135deg, #28a745, #20c997); color: white; font-size: 1.2rem; padding: 15px 30px; font-weight: bold;" disabled>
                    âœ… FINALIZE TOURNAMENT
                </button>
                <button class="practice-btn" onclick="closeStage7AdminRoom('${tournamentId}')" 
                        style="background: #dc3545; font-size: 1rem; padding: 15px 30px;">
                    ğŸšª Close Room
                </button>
            </div>
        </div>
    `;
    
    // Setup admin video
    const adminVideo = document.getElementById('admin-video-stage7');
    if (adminVideo && localStream) {
        adminVideo.srcObject = localStream;
    }
    
    // Load finalists
    loadStage7Finalists(tournamentId);
}

// ===== LOAD STAGE 7 FINALISTS =====
async function loadStage7Finalists(tournamentId) {
    const grid = document.getElementById('stage7-finalists-grid');
    
    if (!grid) return;
    
    const roomListener = db.collection('tournaments').doc(tournamentId)
        .collection('liveRooms').doc('stage7')
        .onSnapshot(async (doc) => {
            if (!doc.exists) return;
            
            const roomData = doc.data();
            const activeIds = roomData.activeParticipants || [];
            const winner = roomData.winner;
            const secondPlace = roomData.secondPlace;
            const thirdPlace = roomData.thirdPlace;
            
            grid.innerHTML = '';
            
            // Load all 3 finalists
            for (const userId of activeIds) {
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) continue;
                
                const userData = userDoc.data();
                
                // Determine if this person has been selected
                let selectedAs = null;
                let borderColor = '#0d3b66';
                let bgColor = 'white';
                
                if (userId === winner) {
                    selectedAs = 'ğŸ¥‡ 1ST PLACE';
                    borderColor = '#FFD700';
                    bgColor = 'linear-gradient(135deg, #FFD700, #FFA500)';
                } else if (userId === secondPlace) {
                    selectedAs = 'ğŸ¥ˆ 2ND PLACE';
                    borderColor = '#C0C0C0';
                    bgColor = 'linear-gradient(135deg, #C0C0C0, #A8A8A8)';
                } else if (userId === thirdPlace) {
                    selectedAs = 'ğŸ¥‰ 3RD PLACE';
                    borderColor = '#CD7F32';
                    bgColor = 'linear-gradient(135deg, #CD7F32, #B8860B)';
                }
                
                const participantCard = document.createElement('div');
                participantCard.style.cssText = `
                    background: ${bgColor};
                    border-radius: 15px;
                    padding: 20px;
                    border: 4px solid ${borderColor};
                    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
                    transition: all 0.3s;
                `;
                
                participantCard.innerHTML = `
                    ${selectedAs ? `
                        <div style="background: white; padding: 10px; border-radius: 10px; margin-bottom: 15px; text-align: center; font-weight: bold; font-size: 1.2rem; color: #0d3b66;">
                            ${selectedAs}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <img src="${userData.photoURL || 'https://via.placeholder.com/60'}" 
                             style="width: 60px; height: 60px; border-radius: 50%; margin-right: 15px; object-fit: cover; border: 3px solid ${borderColor};">
                        <div style="flex: 1;">
                                <div style="font-weight: bold; color: ${selectedAs ? 'white' : '#0d3b66'}; font-size: 1.1rem;">
                                    ${userData.firstName} ${userData.lastName}
                                </div>
                                <div style="color: ${selectedAs ? 'rgba(255,255,255,0.8)' : '#666'}; font-size: 0.9rem;">
                                    ğŸ“§ ${userData.email}
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #000; border-radius: 10px; height: 150px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ‘¤</div>
                                <div style="font-size: 0.9rem;">Camera feed</div>
                            </div>
                        </div>
                        
                        ${!selectedAs ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                                <button class="practice-btn" onclick="selectWinner('${userId}', '${tournamentId}')"
                                        style="font-size: 0.85rem; padding: 12px 8px; background: linear-gradient(135deg, #FFD700, #FFA500); color: #0d3b66; font-weight: bold;">
                                    ğŸ¥‡ 1st
                                </button>
                                <button class="practice-btn" onclick="selectSecondPlace('${userId}', '${tournamentId}')"
                                        style="font-size: 0.85rem; padding: 12px 8px; background: linear-gradient(135deg, #C0C0C0, #A8A8A8); color: #0d3b66; font-weight: bold;">
                                    ğŸ¥ˆ 2nd
                                </button>
                                <button class="practice-btn" onclick="selectThirdPlace('${userId}', '${tournamentId}')"
                                        style="font-size: 0.85rem; padding: 12px 8px; background: linear-gradient(135deg, #CD7F32, #B8860B); color: white; font-weight: bold;">
                                    ğŸ¥‰ 3rd
                                </button>
                            </div>
                        ` : `
                            <button class="practice-btn" onclick="clearSelection('${userId}', '${tournamentId}')"
                                    style="width: 100%; font-size: 0.9rem; padding: 10px; background: #dc3545;">
                                âŒ Clear Selection
                            </button>
                        `}
                    `;
                    
                    grid.appendChild(participantCard);
                }
                
                // Check if all positions are filled
                if (winner && secondPlace && thirdPlace) {
                    document.getElementById('finalize-btn').disabled = false;
                    showStage7Results(tournamentId, winner, secondPlace, thirdPlace);
                } else {
                    document.getElementById('finalize-btn').disabled = true;
                    const resultsDiv = document.getElementById('stage7-results');
                    if (resultsDiv) resultsDiv.style.display = 'none';
                }
            });
        
        if (!window.tournamentListeners) {
            window.tournamentListeners = [];
        }
        window.tournamentListeners.push(roomListener);
    }
    
    // ===== SELECT POSITIONS =====
    async function selectWinner(userId, tournamentId) {
        try {
            await db.collection('tournaments').doc(tournamentId)
                .collection('liveRooms').doc('stage7').update({
                    winner: userId
                });
            console.log('âœ… Winner selected');
        } catch (error) {
            console.error('Error selecting winner:', error);
            alert('Failed to select winner');
        }
    }
    
    async function selectSecondPlace(userId, tournamentId) {
        try {
            await db.collection('tournaments').doc(tournamentId)
                .collection('liveRooms').doc('stage7').update({
                    secondPlace: userId
                });
            console.log('âœ… 2nd place selected');
        } catch (error) {
            console.error('Error selecting 2nd place:', error);
            alert('Failed to select 2nd place');
        }
    }
    
    async function selectThirdPlace(userId, tournamentId) {
        try {
            await db.collection('tournaments').doc(tournamentId)
                .collection('liveRooms').doc('stage7').update({
                    thirdPlace: userId
                });
            console.log('âœ… 3rd place selected');
        } catch (error) {
            console.error('Error selecting 3rd place:', error);
            alert('Failed to select 3rd place');
        }
    }
    
    async function clearSelection(userId, tournamentId) {
        try {
            const roomDoc = await db.collection('tournaments').doc(tournamentId)
                .collection('liveRooms').doc('stage7').get();
            const roomData = roomDoc.data();
            
            const updates = {};
            if (roomData.winner === userId) updates.winner = null;
            if (roomData.secondPlace === userId) updates.secondPlace = null;
            if (roomData.thirdPlace === userId) updates.thirdPlace = null;
            
            await db.collection('tournaments').doc(tournamentId)
                .collection('liveRooms').doc('stage7').update(updates);
            
            console.log('âœ… Selection cleared');
        } catch (error) {
            console.error('Error clearing selection:', error);
            alert('Failed to clear selection');
        }
    }
    
    // ===== SHOW STAGE 7 RESULTS =====
    async function showStage7Results(tournamentId, winnerId, secondId, thirdId) {
        const resultsDiv = document.getElementById('stage7-results');
        const resultsContent = document.getElementById('stage7-results-content');
        
        if (!resultsDiv || !resultsContent) return;
        
        // Get user data
        const [winnerDoc, secondDoc, thirdDoc] = await Promise.all([
            db.collection('users').doc(winnerId).get(),
            db.collection('users').doc(secondId).get(),
            db.collection('users').doc(thirdId).get()
        ]);
        
        const winner = winnerDoc.data();
        const second = secondDoc.data();
        const third = thirdDoc.data();
        
        resultsContent.innerHTML = `
            <!-- 1st Place -->
            <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 10px 30px rgba(255,215,0,0.5);">
                <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ¥‡</div>
                <h3 style="color: #0d3b66; margin: 0 0 10px 0; font-size: 1.8rem;">CHAMPION</h3>
                <img src="${winner.photoURL || 'https://via.placeholder.com/100'}" 
                     style="width: 100px; height: 100px; border-radius: 50%; margin: 15px 0; object-fit: cover; border: 5px solid white;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66;">
                    ${winner.firstName} ${winner.lastName}
                </div>
                <div style="font-size: 1rem; color: #0d3b66; margin-top: 5px;">
                    ${winner.email}
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <!-- 2nd Place -->
                <div style="background: linear-gradient(135deg, #C0C0C0, #A8A8A8); padding: 20px; border-radius: 15px; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ¥ˆ</div>
                    <h4 style="color: #0d3b66; margin: 0 0 10px 0; font-size: 1.3rem;">2ND PLACE</h4>
                    <img src="${second.photoURL || 'https://via.placeholder.com/80'}" 
                         style="width: 80px; height: 80px; border-radius: 50%; margin: 10px 0; object-fit: cover; border: 4px solid white;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: #0d3b66;">
                        ${second.firstName} ${second.lastName}
                    </div>
                    <div style="font-size: 0.9rem; color: #0d3b66; margin-top: 5px;">
                        ${second.email}
                    </div>
                </div>
                
                <!-- 3rd Place -->
                <div style="background: linear-gradient(135deg, #CD7F32, #B8860B); padding: 20px; border-radius: 15px; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ¥‰</div>
                    <h4 style="color: white; margin: 0 0 10px 0; font-size: 1.3rem;">3RD PLACE</h4>
                    <img src="${third.photoURL || 'https://via.placeholder.com/80'}" 
                         style="width: 80px; height: 80px; border-radius: 50%; margin: 10px 0; object-fit: cover; border: 4px solid white;">
                    <div style="font-size: 1.2rem; font-weight: bold; color: white;">
                        ${third.firstName} ${third.lastName}
                    </div>
                    <div style="font-size: 0.9rem; color: white; margin-top: 5px;">
                        ${third.email}
                    </div>
                </div>
            </div>
        `;
        
        resultsDiv.style.display = 'block';
    }
    
    // ===== FINALIZE TOURNAMENT =====
    async function finalizeTournament(tournamentId) {
        if (!confirm('ğŸ† FINALIZE this tournament with the current rankings?\n\nThis action cannot be undone.')) {
            return;
        }
        
        try {
            const roomDoc = await db.collection('tournaments').doc(tournamentId)
                .collection('liveRooms').doc('stage7').get();
            
            if (!roomDoc.exists) {
                alert('Stage 7 room not found');
                return;
            }
            
            const roomData = roomDoc.data();
            
            // Update tournament status
            await db.collection('tournaments').doc(tournamentId).update({
                status: 'completed',
                completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                winnerId: roomData.winner,
                secondPlaceId: roomData.secondPlace,
                thirdPlaceId: roomData.thirdPlace
            });
            
            // Update participant records
            const batch = db.batch();
            
            const winnerRef = db.collection('tournaments').doc(tournamentId)
                .collection('participants').doc(roomData.winner);
            batch.update(winnerRef, {
                finalRank: 1,
                status: 'champion',
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            const secondRef = db.collection('tournaments').doc(tournamentId)
                .collection('participants').doc(roomData.secondPlace);
            batch.update(secondRef, {
                finalRank: 2,
                status: 'runner-up',
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            const thirdRef = db.collection('tournaments').doc(tournamentId)
                .collection('participants').doc(roomData.thirdPlace);
            batch.update(thirdRef, {
                finalRank: 3,
                status: 'third-place',
                completedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            await batch.commit();
            
            // Close Stage 7 room
            await db.collection('tournaments').doc(tournamentId)
                .collection('liveRooms').doc('stage7').update({
                    isActive: false,
                    finalizedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            
            console.log('âœ… Tournament finalized');
            
            alert('ğŸ‰ TOURNAMENT COMPLETED!\n\nResults have been saved.\n\nAll participants have been notified.');
            
            // Show completion screen
            showTournamentCompletionScreen(tournamentId);
            
        } catch (error) {
            console.error('Error finalizing tournament:', error);
            alert('Failed to finalize tournament: ' + error.message);
        }
    }
    
    // ===== SHOW COMPLETION SCREEN =====
    async function showTournamentCompletionScreen(tournamentId) {
        const stage7Container = document.getElementById('stage7-admin-container');
        
        const roomDoc = await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage7').get();
        const roomData = roomDoc.data();
        
        // Get user data
        const [winnerDoc, secondDoc, thirdDoc] = await Promise.all([
            db.collection('users').doc(roomData.winner).get(),
            db.collection('users').doc(roomData.secondPlace).get(),
            db.collection('users').doc(roomData.thirdPlace).get()
        ]);
        
        const winner = winnerDoc.data();
        const second = secondDoc.data();
        const third = thirdDoc.data();
        
        stage7Container.innerHTML = `
            <div class="quiz-question-card" style="text-align: center; padding: 50px;">
                <div style="font-size: 6rem; margin-bottom: 30px; animation: bounce 2s infinite;">ğŸ†</div>
                
                <h1 style="color: #0d3b66; font-size: 3rem; margin-bottom: 30px;">
                    TOURNAMENT COMPLETED!
                </h1>
                
                <!-- Final Podium -->
                <div style="background: linear-gradient(135deg, #FFD700, #FFA500); padding: 40px; border-radius: 20px; margin: 30px 0;">
                    <h2 style="color: #0d3b66; margin-bottom: 30px;">ğŸ… FINAL STANDINGS</h2>
                    
                    <div style="display: grid; gap: 20px; max-width: 800px; margin: 0 auto;">
                        <!-- Winner -->
                        <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
                            <div style="font-size: 4rem; margin-bottom: 15px;">ğŸ¥‡</div>
                            <h3 style="color: #0d3b66; margin-bottom: 10px;">CHAMPION</h3>
                            <img src="${winner.photoURL || 'https://via.placeholder.com/100'}" 
                                 style="width: 100px; height: 100px; border-radius: 50%; margin: 15px 0; object-fit: cover; border: 5px solid #FFD700;">
                            <div style="font-size: 1.5rem; font-weight: bold; color: #0d3b66;">
                                ${winner.firstName} ${winner.lastName}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- 2nd Place -->
                            <div style="background: white; padding: 25px; border-radius: 15px;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ¥ˆ</div>
                                <h4 style="color: #0d3b66;">2ND PLACE</h4>
                                <img src="${second.photoURL || 'https://via.placeholder.com/80'}" 
                                     style="width: 80px; height: 80px; border-radius: 50%; margin: 10px 0; object-fit: cover; border: 4px solid #C0C0C0;">
                                <div style="font-weight: bold; color: #0d3b66;">
                                    ${second.firstName} ${second.lastName}
                                </div>
                            </div>
                            
                            <!-- 3rd Place -->
                            <div style="background: white; padding: 25px; border-radius: 15px;">
                                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ¥‰</div>
                                <h4 style="color: #0d3b66;">3RD PLACE</h4>
                                <img src="${third.photoURL || 'https://via.placeholder.com/80'}" 
                                     style="width: 80px; height: 80px; border-radius: 50%; margin: 10px 0; object-fit: cover; border: 4px solid #CD7F32;">
                                <div style="font-weight: bold; color: #0d3b66;">
                                    ${third.firstName} ${third.lastName}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="practice-btn" onclick="returnToAdminPanel()" 
                        style="font-size: 1.3rem; padding: 20px 50px; background: linear-gradient(135deg, #667eea, #764ba2); margin-top: 30px;">
                    ğŸ  Return to Admin Panel
                </button>
            </div>
        `;
        
        // Stop media streams
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
    }
    
    function returnToAdminPanel() {
        const stage7Container = document.getElementById('stage7-admin-container');
        if (stage7Container) stage7Container.style.display = 'none';
        
        navigateTo('admin');
    }
    
    async function closeStage7AdminRoom(tournamentId) {
        if (!confirm('ğŸšª Close Stage 7 room?')) return;
        
        try {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            await db.collection('tournaments').doc(tournamentId)
                .collection('liveRooms').doc('stage7').update({
                    adminInRoom: false
                });
            
            const stage7Container = document.getElementById('stage7-admin-container');
            if (stage7Container) stage7Container.style.display = 'none';
            
            navigateTo('admin');
        } catch (error) {
            console.error('Error:', error);
        }
    }
    
    // ===== PARTICIPANT: JOIN STAGE 7 =====
    async function joinStage7Room() {
        try {
            console.log('ğŸ¥ Joining Stage 7 FINALS...');
            
            // Ensure media is still active
            if (!localStream) {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: true
                });
            }
            
            // Hide Stage 6 UI
            const stage6UI = document.getElementById('tournament-stage6-participant');
            if (stage6UI) stage6UI.style.display = 'none';
            
            // Show Stage 7 UI
            showStage7ParticipantUI();
            
        } catch (error) {
            console.error('Error joining Stage 7:', error);
            alert('Failed to join Stage 7');
        }
    }
    
    function showStage7ParticipantUI() {
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let stage7Container = document.getElementById('tournament-stage7-participant');
        
        if (!stage7Container) {
            stage7Container = document.createElement('div');
            stage7Container.id = 'tournament-stage7-participant';
            tournamentsSection.appendChild(stage7Container);
        }
        
        stage7Container.style.display = 'block';
        
        stage7Container.innerHTML = `
            <div class="quiz-question-card">
                <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 30px; border-radius: 15px; margin-bottom: 20px; color: white; text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 15px;">ğŸ†</div>
                    <h2 style="margin: 0 0 10px 0; color: white;">STAGE 7 - GRAND FINALS</h2>
                    <p style="margin: 0; opacity: 0.9; font-size: 1.1rem;">You're in the FINAL 3!</p>
                </div>
                
                <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px;">
                        <button class="practice-btn" onclick="toggleMyAudio()" id="my-audio-btn-stage7" 
                                style="flex: 1; background: #28a745;">
                            ğŸ¤ Mic: ON
                        </button>
                        <button class="practice-btn" onclick="toggleMyVideo()" id="my-video-btn-stage7" 
                                style="flex: 1; background: #28a745;">
                            ğŸ¥ Camera: ON
                        </button>
                    </div>
                </div>
                
                <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                    <video id="my-video-stage7" autoplay muted playsinline 
                           style="width: 100%; max-height: 400px; object-fit: cover;"></video>
                    <div style="position: absolute; bottom: 15px; left: 15px; background: linear-gradient(135deg, #FFD700, #FFA500); padding: 12px 25px; border-radius: 25px; color: #0d3b66; font-weight: bold; font-size: 1.1rem;">
                        ğŸ‘¤ YOU - FINALIST!
                    </div>
                </div>
                
                <div id="stage7-participant-status" style="text-align: center; padding: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 15px; color: white;">
                    <div style="font-size: 4rem; margin-bottom: 20px; animation: pulse 2s infinite;">ğŸŒŸ</div>
                    <h2 style="color: white; margin-bottom: 15px;">YOU'RE A FINALIST!</h2>
                    <p style="opacity: 0.9; font-size: 1.2rem; margin-bottom: 10px;">
                        Congratulations on making it to the final stage!
                    </p>
                    <p style="opacity: 0.8; font-size: 1rem;">
                        The admin will announce the final rankings shortly...
                    </p>
                </div>
            </div>
        `;
        
        const myVideo = document.getElementById('my-video-stage7');
        if (myVideo && localStream) {
            myVideo.srcObject = localStream;
        }
        
        listenForStage7Results();
    }
    
    function listenForStage7Results() {
        const listener = db.collection('tournaments').doc(currentTournament)
            .collection('liveRooms').doc('stage7')
            .onSnapshot(async (doc) => {
                if (!doc.exists) return;
                
                const roomData = doc.data();
                
                // Check if user has been ranked
                if (roomData.winner === currentUser.uid) {
                    showParticipantResult('ğŸ¥‡ CHAMPION', '1st Place', '#FFD700');
                } else if (roomData.secondPlace === currentUser.uid) {
                    showParticipantResult('ğŸ¥ˆ RUNNER-UP', '2nd Place', '#C0C0C0');
                } else if (roomData.thirdPlace === currentUser.uid) {
                    showParticipantResult('ğŸ¥‰ THIRD PLACE', '3rd Place', '#CD7F32');
                }
                
                // Check if tournament is completed
                if (!roomData.isActive && roomData.finalizedAt) {
                    setTimeout(() => {
                        exitTournamentAfterCompletion();
                    }, 5000);
                }
            });
        
        if (!window.tournamentListeners) window.tournamentListeners = [];
        window.tournamentListeners.push(listener);
    }
    
    function showParticipantResult(title, subtitle, color) {
        const statusDiv = document.getElementById('stage7-participant-status');
        if (!statusDiv) return;
        
        statusDiv.innerHTML = `
            <div style="font-size: 5rem; margin-bottom: 20px; animation: bounce 1s infinite;">${title.split(' ')[0]}</div>
            <h2 style="color: white; margin-bottom: 10px; font-size: 2.5rem;">${title}</h2>
            <div style="background: white; padding: 15px 30px; border-radius: 25px; display: inline-block; margin: 20px 0;">
                <div style="font-size: 1.5rem; font-weight: bold; color: ${color};">
                    ${subtitle}
                </div>
            </div>
            <p style="opacity: 0.9; font-size: 1.2rem; margin-top: 20px;">
                ğŸ‰ Congratulations! ğŸ‰
            </p>
        `;
    }
    
    function exitTournamentAfterCompletion() {
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        alert('ğŸ† Tournament completed! Thank you for participating!');
        exitTournament();
    }



// ===== ADMIN CONFIGURATION =====
// ===== ADMIN CONFIGURATION =====
const ADMIN_EMAIL = 'carlanviroberts@gmail.com'; // âš ï¸ CHANGE THIS TO YOUR ADMIN EMAIL
let isAdmin = false;

// Check if current user is admin
async function checkAdminStatus() {
    if (!currentUser) {
        isAdmin = false;
        updateAdminUI();
        console.log('âŒ No current user - admin status: false');
        return false;
    }
    
    try {
        console.log('ğŸ” Checking admin status for:', currentUser.email);
        console.log('ğŸ” Admin email configured as:', ADMIN_EMAIL);
        
        // Check email directly first
        if (currentUser.email === ADMIN_EMAIL) {
            isAdmin = true;
            console.log('âœ… ADMIN DETECTED via email match!');
            updateAdminUI();
            return true;
        }
        
        // Also check Firestore user document
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            isAdmin = (userData?.email === ADMIN_EMAIL);
            console.log('ğŸ“„ Firestore check - Admin status:', isAdmin);
        } else {
            console.log('âš ï¸ User document not found in Firestore');
        }
        
        updateAdminUI();
        return isAdmin;
        
    } catch (error) {
        console.error('âŒ Error checking admin status:', error);
        isAdmin = false;
        updateAdminUI();
        return false;
    }
}

function updateAdminUI() {
    console.log('ğŸ”„ Updating admin UI. isAdmin:', isAdmin);
    
    // Show/hide admin link in sidebar
    const adminLink = document.getElementById('admin-nav-link');
    if (adminLink) {
        adminLink.style.display = isAdmin ? 'block' : 'none';
        console.log('âœ… Admin link display set to:', isAdmin ? 'block' : 'none');
    } else {
        console.log('âš ï¸ Admin link element not found in DOM');
    }
}
// ===== ADMIN TOURNAMENT MANAGEMENT =====

async function loadAdminPanel() {
    if (!isAdmin) {
        document.getElementById('admin-container').innerHTML = `
            <div class="feedback error" style="text-align: center; padding: 40px;">
                âŒ <strong>Access Denied</strong><br><br>
                Admin privileges required.<br>
                Current user: ${currentUser ? currentUser.email : 'Not signed in'}
            </div>
        `;
        return;
    }
    
    const container = document.getElementById('admin-container');
    container.innerHTML = '<div class="loading">Loading admin panel...</div>';
    
    try {
        // Load all tournaments
        const tournamentsSnapshot = await db.collection('tournaments')
            .orderBy('createdAt', 'desc')
            .get();
        
        const tournaments = [];
        tournamentsSnapshot.forEach(doc => {
            tournaments.push({ id: doc.id, ...doc.data() });
        });
        
        container.innerHTML = `
            <div class="admin-panel">
                <!-- Create Tournament Button -->
                <div style="text-align: center; margin-bottom: 30px;">
                    <button class="practice-btn" onclick="showCreateTournamentModal()" style="font-size: 1.2rem; padding: 15px 40px; background: linear-gradient(135deg, #667eea, #764ba2);">
                        â• Create New Tournament
                    </button>
                </div>
                
                <!-- Tournaments List -->
                <h3 style="color: #0d3b66; margin-bottom: 20px;">ğŸ“‹ Manage Tournaments (${tournaments.length})</h3>
                
                ${tournaments.length === 0 ? `
                    <div class="loading">
                        No tournaments created yet. Click "Create New Tournament" to get started.
                    </div>
                ` : `
                    <div class="coaches-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>ğŸ† Tournament</th>
                                    <th>ğŸ“… Date</th>
                                    <th>ğŸ‘¥ Participants</th>
                                    <th>âš™ï¸ Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tournaments.map(tournament => `
                                    <tr>
                                        <td>
                                            <div style="font-weight: bold; color: #0d3b66;">${tournament.name}</div>
                                            <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                                                Level: ${tournament.level} â€¢ Status: ${tournament.status}
                                            </div>
                                        </td>
                                        <td>
                                            <div>${tournament.startDate ? new Date(tournament.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Not scheduled'}</div>
                                            <div style="font-size: 0.85rem; color: #666; margin-top: 3px;">
                                                ${tournament.startTime || 'Time TBD'}
                                            </div>
                                        </td>
                                        <td style="text-align: center;">
                                            <span style="background: #e3f2fd; padding: 5px 15px; border-radius: 15px; font-weight: bold; color: #0d3b66;">
                                                ${tournament.participants || 0}
                                            </span>
                                        </td>
                                        <td>
                                            <div style="display: flex; gap: 5px; justify-content: center;">
                                                <button class="practice-btn" onclick="viewTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #17a2b8;">
                                                    ğŸ‘ï¸ View
                                                </button>
                                                <button class="practice-btn" onclick="editTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #ffc107; color: #0d3b66;">
                                                    âœï¸ Edit
                                                </button>
                                                <button class="practice-btn" onclick="deleteTournament('${tournament.id}')" style="padding: 8px 15px; font-size: 0.85rem; background: #dc3545;">
                                                    ğŸ—‘ï¸ Delete
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `}
            </div>
        `;
        
    } catch (error) {
        console.error('Error loading admin panel:', error);
        container.innerHTML = `
            <div class="feedback error">
                âŒ Failed to load admin panel: ${error.message}
            </div>
        `;
    }
}

        
function showCreateTournamentModal() {
    const modal = document.createElement('div');
    modal.className = 'auth-modal';
    modal.id = 'createTournamentModal';
    modal.style.display = 'block';
    modal.classList.add('active');
    
    modal.innerHTML = `
        <div class="auth-content" style="max-width: 600px;">
            <div class="auth-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h2 style="color: white;">â• Create New Tournament</h2>
                <button class="modal-close" onclick="closeCreateTournamentModal()" style="color: white;">Ã—</button>
            </div>
            <div class="auth-body">
                <form id="create-tournament-form" onsubmit="handleCreateTournament(event)">
                    <div class="form-group">
                        <label>Tournament Name *</label>
                        <input type="text" id="tournament-name" required placeholder="e.g., Summer Spelling Championship 2025">
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea id="tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;" placeholder="Describe the tournament..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Difficulty Level *</label>
                        <select id="tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="">Select level</option>
                            <option value="foundation">ğŸŒ± Foundation</option>
                            <option value="challenge">ğŸ¯ Challenge</option>
                            <option value="advanced">ğŸš€ Advanced</option>
                            <option value="championship">ğŸ† Championship</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="tournament-date" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" id="tournament-time" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Max Participants</label>
                        <input type="number" id="tournament-max-participants" min="10" max="100" value="50" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                    </div>
                    
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                            <option value="upcoming">ğŸ“… Upcoming (Open for Registration)</option>
                            <option value="active">â–¶ï¸ Active (In Progress)</option>
                            <option value="completed">âœ… Completed</option>
                            <option value="cancelled">âŒ Cancelled</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        âœ… Create Tournament
                    </button>
                    
                    <div id="create-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                </form>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeCreateTournamentModal() {
    const modal = document.getElementById('createTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleCreateTournament(event) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    const name = document.getElementById('tournament-name').value.trim();
    const description = document.getElementById('tournament-description').value.trim();
    const level = document.getElementById('tournament-level').value;
    const date = document.getElementById('tournament-date').value;
    const time = document.getElementById('tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('tournament-max-participants').value);
    const status = document.getElementById('tournament-status').value;
    
    const errorDiv = document.getElementById('create-tournament-error');
    
    try {
        console.log('ğŸ“ Creating tournament:', name);
        
        // Create tournament in Firestore
        const tournamentRef = await db.collection('tournaments').add({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            participants: 0,
            registeredUsers: [],
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Tournament created:', tournamentRef.id);
        
        closeCreateTournamentModal();
        
        alert('âœ… Tournament created successfully!');
        
        // âœ… Reload admin panel
        await loadAdminPanel();
        
        // âœ… ALSO reload tournament list if we're on tournaments page
        const tournamentsSection = document.getElementById('tournaments-section');
        if (tournamentsSection && tournamentsSection.classList.contains('active')) {
            await loadTournamentList();
        }
        
    } catch (error) {
        console.error('âŒ Error creating tournament:', error);
        errorDiv.textContent = 'Failed to create tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function viewTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = { id: tournamentDoc.id, ...tournamentDoc.data() };
        
        // âœ… GET STAGE 3 QUALIFIED PARTICIPANTS
        const participantsSnapshot = await db.collection('tournaments').doc(tournamentId)
            .collection('participants')
            .where('status', '==', 'qualified-stage4')
            .orderBy('stage3Percentage', 'desc')
            .get();
        
        const qualifiedParticipants = [];
        participantsSnapshot.forEach(doc => {
            qualifiedParticipants.push({ id: doc.id, ...doc.data() });
        });
        
        // âœ… CHECK IF STAGE 4 ROOM EXISTS
        const stage4RoomDoc = await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc('stage4').get();
        const stage4RoomExists = stage4RoomDoc.exists;
        
        // Create detailed view modal
        const modal = document.createElement('div');
        modal.className = 'auth-modal';
        modal.id = 'viewTournamentModal';
        modal.style.display = 'block';
        modal.classList.add('active');
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div class="auth-header" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                    <h2 style="color: white;">ğŸ‘ï¸ ${tournament.name}</h2>
                    <button class="modal-close" onclick="closeViewTournamentModal()" style="color: white;">Ã—</button>
                </div>
                <div class="auth-body">
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #0d3b66; margin-bottom: 10px;">ğŸ“‹ Description</h4>
                        <p style="color: #666;">${tournament.description}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div>
                            <strong>ğŸ“Š Level:</strong> ${tournament.level}
                        </div>
                        <div>
                            <strong>ğŸ“… Date:</strong> ${tournament.startDate}
                        </div>
                        <div>
                            <strong>ğŸ• Time:</strong> ${tournament.startTime}
                        </div>
                        <div>
                            <strong>âš¡ Status:</strong> ${tournament.status}
                        </div>
                        <div>
                            <strong>ğŸ‘¥ Registered:</strong> ${tournament.participants} / ${tournament.maxParticipants}
                        </div>
                        <div>
                            <strong>ğŸ® Session:</strong> ${tournament.sessionActive ? 'LIVE âœ…' : 'Not Started'}
                        </div>
                    </div>
                    
                    <!-- âœ… STAGE 3 QUALIFIED PARTICIPANTS -->
                    ${qualifiedParticipants.length > 0 ? `
                        <div style="background: #d4edda; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                            <h4 style="color: #155724; margin: 0 0 15px 0;">
                                âœ… Stage 3 Qualified (${qualifiedParticipants.length} users)
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #c3e6cb; border-bottom: 2px solid #155724;">
                                            <th style="padding: 10px; text-align: left; color: #155724;">Rank</th>
                                            <th style="padding: 10px; text-align: left; color: #155724;">Name</th>
                                            <th style="padding: 10px; text-align: center; color: #155724;">Score</th>
                                            <th style="padding: 10px; text-align: center; color: #155724;">Accuracy</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${qualifiedParticipants.map((p, index) => `
                                            <tr style="border-bottom: 1px solid #d4edda; background: ${index < 10 ? '#e8f5e9' : 'white'};">
                                                <td style="padding: 10px; font-weight: bold; color: ${index < 10 ? '#28a745' : '#666'};">
                                                    ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : index + 1}
                                                    ${index < 10 ? ' âœ…' : ' â¸ï¸'}
                                                </td>
                                                <td style="padding: 10px;">${p.name}</td>
                                                <td style="padding: 10px; text-align: center; font-weight: bold;">${p.stage3Score}/${p.stage3Total}</td>
                                                <td style="padding: 10px; text-align: center; font-weight: bold; color: #28a745;">${p.stage3Percentage}%</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <p style="color: #155724; font-size: 0.9rem; margin: 15px 0 0 0;">
                                â„¹ï¸ Top 10 will advance to Stage 4. Others will be eliminated.
                            </p>
                        </div>
                    ` : '<p style="color: #999;">No Stage 3 completions yet</p>'}
                    
                    <!-- âœ… STAGE 4 ROOM CONTROLS -->
                    ${qualifiedParticipants.length > 0 ? `
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                            <h4 style="color: #856404; margin: 0 0 15px 0;">ğŸ¥ Stage 4 Live Room</h4>
                            ${!stage4RoomExists ? `
                                <p style="color: #856404; margin-bottom: 15px;">
                                    ${qualifiedParticipants.length >= 10 
                                        ? `âœ… Ready to create! ${qualifiedParticipants.length} qualified users (top 10 will advance)`
                                        : `â³ ${qualifiedParticipants.length} qualified so far (need 10+ to create room)`
                                    }
                                </p>
                                <button class="practice-btn" 
                                        onclick="createStage4Room('${tournamentId}')" 
                                        ${qualifiedParticipants.length < 10 ? 'disabled' : ''}
                                        style="background: ${qualifiedParticipants.length >= 10 ? '#28a745' : '#6c757d'}; font-size: 1.1rem; padding: 15px 30px; ${qualifiedParticipants.length < 10 ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    ğŸš€ Create Stage 4 Room (Top 10)
                                </button>
                            ` : `
                                <div style="background: #d4edda; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <p style="color: #155724; margin: 0; font-weight: bold;">âœ… Stage 4 room is active!</p>
                                </div>
                                <button class="practice-btn" onclick="enterStage4RoomAdmin('${tournamentId}')" 
                                        style="background: #17a2b8; font-size: 1.1rem; padding: 15px 30px;">
                                    ğŸ¥ Enter Stage 4 Room
                                </button>
                            `}
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        ${!tournament.sessionActive && tournament.status === 'active' && tournament.participants > 0 ? `
                            <button class="practice-btn" onclick="startTournamentSession('${tournamentId}')" style="flex: 1; background: #28a745; font-size: 1.1rem;">
                                ğŸš€ START TOURNAMENT
                            </button>
                        ` : tournament.sessionActive ? `
                            <button class="practice-btn" disabled style="flex: 1; background: #28a745; opacity: 0.7;">
                                âœ… Tournament Running
                            </button>
                        ` : ''}
                        
                        <button class="practice-btn" onclick="closeViewTournamentModal()" style="flex: 1; background: #6c757d;">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // âœ… LISTEN FOR NEW STAGE 3 COMPLETIONS
        listenForStage3Completions(tournamentId);
        
    } catch (error) {
        console.error('Error viewing tournament:', error);
        alert('Failed to load tournament details');
    }
}

async function getRegisteredUserNames(userIds) {
    const names = [];
    for (const uid of userIds) {
        try {
            const userDoc = await db.collection('users').doc(uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                names.push(`<div style="padding: 5px; border-bottom: 1px solid #e0e0e0;">â€¢ ${userData.firstName} ${userData.lastName} (${userData.email})</div>`);
            }
        } catch (error) {
            console.error('Error fetching user:', error);
        }
    }
    return names.join('');
}

function closeViewTournamentModal() {
    const modal = document.getElementById('viewTournamentModal');
    if (modal) {
        modal.remove();
    }
}

// âœ… NEW: Start tournament session (Admin only)
async function startTournamentSession(tournamentId) {
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    if (!confirm('ğŸš€ Start this tournament now? All registered users will be notified.')) {
        return;
    }
    
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            sessionActive: true,
            sessionStartedAt: firebase.firestore.FieldValue.serverTimestamp(),
            sessionJoined: []
        });
        
        alert('âœ… Tournament started! Registered users will be notified.');
        
        closeViewTournamentModal();
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error starting tournament:', error);
        alert('Failed to start tournament: ' + error.message);
    }
}

async function editTournament(tournamentId) {
    try {
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Pre-fill edit modal (similar to create modal)
        const modal = document.createElement('div');
        modal.className = 'auth-modal';
        modal.id = 'editTournamentModal';
        modal.style.display = 'block';
        modal.classList.add('active');
        
        modal.innerHTML = `
            <div class="auth-content" style="max-width: 600px;">
                <div class="auth-header" style="background: linear-gradient(135deg, #ffc107, #ff9800);">
                    <h2 style="color: #0d3b66;">âœï¸ Edit Tournament</h2>
                    <button class="modal-close" onclick="closeEditTournamentModal()" style="color: #0d3b66;">Ã—</button>
                </div>
                <div class="auth-body">
                    <form id="edit-tournament-form" onsubmit="handleEditTournament(event, '${tournamentId}')">
                        <div class="form-group">
                            <label>Tournament Name *</label>
                            <input type="text" id="edit-tournament-name" required value="${tournament.name}">
                        </div>
                        
                        <div class="form-group">
                            <label>Description *</label>
                            <textarea id="edit-tournament-description" required rows="3" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; font-size: 1rem;">${tournament.description}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Difficulty Level *</label>
                            <select id="edit-tournament-level" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                                <option value="foundation" ${tournament.level === 'foundation' ? 'selected' : ''}>ğŸŒ± Foundation</option>
                                <option value="challenge" ${tournament.level === 'challenge' ? 'selected' : ''}>ğŸ¯ Challenge</option>
                                <option value="advanced" ${tournament.level === 'advanced' ? 'selected' : ''}>ğŸš€ Advanced</option>
                                <option value="championship" ${tournament.level === 'championship' ? 'selected' : ''}>ğŸ† Championship</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Start Date *</label>
                            <input type="date" id="edit-tournament-date" required value="${tournament.startDate}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Start Time *</label>
                            <input type="time" id="edit-tournament-time" required value="${tournament.startTime}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Max Participants</label>
                            <input type="number" id="edit-tournament-max-participants" min="10" max="100" value="${tournament.maxParticipants}" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                        </div>
                        
                        <div class="form-group">
                            <label>Status *</label>
                            <select id="edit-tournament-status" required style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-size: 1rem;">
                                <option value="upcoming" ${tournament.status === 'upcoming' ? 'selected' : ''}>ğŸ“… Upcoming</option>
                                <option value="active" ${tournament.status === 'active' ? 'selected' : ''}>â–¶ï¸ Active</option>
                                <option value="completed" ${tournament.status === 'completed' ? 'selected' : ''}>âœ… Completed</option>
                                <option value="cancelled" ${tournament.status === 'cancelled' ? 'selected' : ''}>âŒ Cancelled</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="auth-submit" style="background: linear-gradient(135deg, #ffc107, #ff9800); color: #0d3b66;">
                            âœ… Save Changes
                        </button>
                        
                        <div id="edit-tournament-error" class="feedback error" style="display: none; margin-top: 15px;"></div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
    } catch (error) {
        console.error('Error loading tournament for edit:', error);
        alert('Failed to load tournament: ' + error.message);
    }
}

function closeEditTournamentModal() {
    const modal = document.getElementById('editTournamentModal');
    if (modal) {
        modal.remove();
    }
}

async function handleEditTournament(event, tournamentId) {
    event.preventDefault();
    
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    const name = document.getElementById('edit-tournament-name').value.trim();
    const description = document.getElementById('edit-tournament-description').value.trim();
    const level = document.getElementById('edit-tournament-level').value;
    const date = document.getElementById('edit-tournament-date').value;
    const time = document.getElementById('edit-tournament-time').value;
    const maxParticipants = parseInt(document.getElementById('edit-tournament-max-participants').value);
    const status = document.getElementById('edit-tournament-status').value;
    
    const errorDiv = document.getElementById('edit-tournament-error');
    
    try {
        await db.collection('tournaments').doc(tournamentId).update({
            name: name,
            description: description,
            level: level,
            startDate: date,
            startTime: time,
            maxParticipants: maxParticipants,
            status: status,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('âœ… Tournament updated:', tournamentId);
        
        closeEditTournamentModal();
        
        alert('âœ… Tournament updated successfully!');
        
        // Reload admin panel
        loadAdminPanel();
        
    } catch (error) {
        console.error('Error updating tournament:', error);
        errorDiv.textContent = 'Failed to update tournament: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function deleteTournament(tournamentId) {
    if (!isAdmin) {
        alert('âŒ Admin access required');
        return;
    }
    
    if (confirm('ğŸ—‘ï¸ Are you sure you want to delete this tournament? This action cannot be undone.')) {
        try {
            await db.collection('tournaments').doc(tournamentId).delete();
            
            console.log('âœ… Tournament deleted:', tournamentId);
            
            alert('âœ… Tournament deleted successfully');
            
            // Reload admin panel
            loadAdminPanel();
            
        } catch (error) {
            console.error('Error deleting tournament:', error);
            alert('Failed to delete tournament: ' + error.message);
        }
    }
}        

// âœ… NEW: Setup real-time listeners for tournaments user is registered for
let tournamentListeners = [];

function setupTournamentListeners(tournaments) {
    // Clean up old listeners
    tournamentListeners.forEach(unsubscribe => unsubscribe());
    tournamentListeners = [];
    
    tournaments.forEach(tournament => {
        if (tournament.registeredUsers?.includes(currentUser.uid)) {
            console.log('ğŸ‘€ Watching tournament:', tournament.name);
            
            const unsubscribe = db.collection('tournaments').doc(tournament.id)
                .onSnapshot(doc => {
                    const data = doc.data();
                    
                    // Check if tournament just went live
                    if (data.status === 'active' && data.sessionActive && !data.sessionJoined?.includes(currentUser.uid)) {
                        showTournamentStartNotification(tournament.id, data);
                    }
                });
            
            tournamentListeners.push(unsubscribe);
        }
    });
}

// âœ… NEW: Show notification when tournament starts
function showTournamentStartNotification(tournamentId, tournamentData) {
    // âœ… Remove any existing notifications first
    const existingNotifs = document.querySelectorAll('[id^="tournament-notification-"]');
    existingNotifs.forEach(notif => notif.remove());
    
    const notification = document.createElement('div');
    notification.id = `tournament-notification-${tournamentId}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.5s ease-out;
    `;
    
    notification.innerHTML = `
        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ†</div>
        <h3 style="margin: 0 0 10px 0; color: white;">Tournament Starting!</h3>
        <p style="margin: 0 0 15px 0; opacity: 0.9;">${tournamentData.name} is now LIVE!</p>
        <button onclick="joinLiveTournament('${tournamentId}')" class="practice-btn" style="background: white; color: #28a745; width: 100%; font-weight: bold; font-size: 1.1rem; padding: 12px;">
            âš¡ JOIN NOW
        </button>
        <button onclick="document.getElementById('tournament-notification-${tournamentId}').remove()" style="position: absolute; top: 10px; right: 10px; background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">Ã—</button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 30 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 30000);
}

        
// âœ… NEW: Join live tournament
async function joinLiveTournament(tournamentId) {
    try {
        console.log('ğŸ¯ Joining live tournament:', tournamentId);
        
        const tournamentDoc = await db.collection('tournaments').doc(tournamentId).get();
        
        if (!tournamentDoc.exists) {
            alert('Tournament not found');
            return;
        }
        
        const tournament = tournamentDoc.data();
        
        // Check if user is registered
        if (!tournament.registeredUsers?.includes(currentUser.uid)) {
            alert('You must be registered to join this tournament');
            return;
        }
        
        // Mark user as joined
        await db.collection('tournaments').doc(tournamentId).update({
            sessionJoined: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
        });
        
        // âœ… Remove notification
        const notifications = document.querySelectorAll('[style*="position: fixed"]');
        notifications.forEach(notif => {
            if (notif.textContent.includes('Tournament Starting')) {
                notif.remove();
            }
        });
        
        // âœ… Navigate to tournaments section first
        await navigateTo('tournaments', true);
        
        // Set current tournament
        currentTournament = tournamentId;
        selectedGameLevel = tournament.level;
        
        // âœ… Small delay to ensure navigation completes
        setTimeout(async () => {
            // Start Stage 1
            await startTournamentStage1(tournamentId);
        }, 300);
        
    } catch (error) {
        console.error('Error joining tournament:', error);
        alert('Failed to join tournament: ' + error.message);
    }
}

// ========================================
// LIVE ROOM SYSTEM FOR STAGES 4-7
// ========================================

async function createLiveRoom(tournamentId, stage) {
    if (!isAdmin) {
        alert('âŒ Only admins can create live rooms');
        return;
    }
    
    try {
        console.log('ğŸ¥ Creating live room for Stage', stage);
        
        // Create live room document in Firestore
        await db.collection('tournaments').doc(tournamentId).collection('liveRooms').doc(`stage${stage}`).set({
            stage: stage,
            createdBy: currentUser.uid,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            isActive: true,
            participants: [],
            adminMicOpen: true,
            adminVideoOpen: true
        });
        
        console.log('âœ… Live room created for Stage', stage);
        
        // Open live room interface for admin
        await openLiveRoomAdmin(tournamentId, stage);
        
    } catch (error) {
        console.error('Error creating live room:', error);
        alert('Failed to create live room: ' + error.message);
    }
}

async function openLiveRoomAdmin(tournamentId, stage) {
    try {
        // Request media permissions
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        });
        
        // Hide current stage
        hideAllStages();
        
        // Create live room container
        const tournamentsSection = document.querySelector('#tournaments-section .word-database');
        let liveRoomContainer = document.getElementById('live-room-container');
        
        if (!liveRoomContainer) {
            liveRoomContainer = document.createElement('div');
            liveRoomContainer.id = 'live-room-container';
            tournamentsSection.appendChild(liveRoomContainer);
        }
        
        liveRoomContainer.style.display = 'block';
        
        buildLiveRoomAdminUI(tournamentId, stage);
        
        // Setup my video
        const myVideo = document.getElementById('admin-video');
        if (myVideo) {
            myVideo.srcObject = localStream;
        }
        
        // Listen for participants joining
        setupLiveRoomListener(tournamentId, stage);
        
    } catch (error) {
        console.error('Error opening live room:', error);
        alert('Failed to access camera/microphone: ' + error.message);
    }
}

function buildLiveRoomAdminUI(tournamentId, stage) {
    const container = document.getElementById('live-room-container');
    
    container.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¥ LIVE ROOM - Stage ${stage} (Admin Mode)</h2>
                <p style="margin: 0; opacity: 0.9;">Face-to-face tournament round with live participants</p>
            </div>
            
            <!-- Admin Controls -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">ğŸ›ï¸ Admin Controls</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="practice-btn" onclick="toggleAdminAudio()" id="admin-audio-btn" style="background: #28a745;">
                        ğŸ¤ Mic: ON
                    </button>
                    <button class="practice-btn" onclick="toggleAdminVideo()" id="admin-video-btn" style="background: #28a745;">
                        ğŸ“¹ Camera: ON
                    </button>
                    <button class="practice-btn" onclick="closeLiveRoom('${tournamentId}', ${stage})" style="background: #dc3545;">
                        ğŸšª Close Room
                    </button>
                </div>
            </div>
            
            <!-- Admin Video -->
            <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <video id="admin-video" autoplay muted playsinline style="width: 100%; max-height: 300px; object-fit: cover;"></video>
                <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; color: white; font-weight: bold;">
                    ğŸ‘‘ YOU (Admin)
                </div>
            </div>
            
            <!-- Participants Grid -->
            <div style="background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #0d3b66; margin: 0 0 15px 0;">ğŸ‘¥ Participants (<span id="participant-count">0</span>)</h3>
                <div id="participants-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                    <!-- Participants will be added here -->
                </div>
            </div>
            
            <!-- Waiting Message -->
            <div id="waiting-message" style="text-align: center; padding: 40px; background: #fff3cd; border-radius: 10px;">
                <div style="font-size: 3rem; margin-bottom: 15px;">â³</div>
                <h3 style="color: #856404; margin-bottom: 10px;">Waiting for participants to join...</h3>
                <p style="color: #856404;">Qualified participants will automatically enter this room</p>
            </div>
        </div>
    `;
}

async function setupLiveRoomListener(tournamentId, stage) {
    // Listen to participants in real-time
    liveRoomListener = db.collection('tournaments').doc(tournamentId)
        .collection('liveRooms').doc(`stage${stage}`)
        .onSnapshot(async (doc) => {
            if (!doc.exists) return;
            
            const roomData = doc.data();
            const participantIds = roomData.participants || [];
            
            // Update participant count
            document.getElementById('participant-count').textContent = participantIds.length;
            
            // Hide/show waiting message
            const waitingMsg = document.getElementById('waiting-message');
            if (waitingMsg) {
                waitingMsg.style.display = participantIds.length === 0 ? 'block' : 'none';
            }
            
            // Load participant details
            await loadParticipantDetails(participantIds);
        });
}

async function loadParticipantDetails(participantIds) {
    const grid = document.getElementById('participants-grid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    for (const uid of participantIds) {
        try {
            const userDoc = await db.collection('users').doc(uid).get();
            if (!userDoc.exists) continue;
            
            const userData = userDoc.data();
            
            const participantCard = document.createElement('div');
            participantCard.style.cssText = `
                background: white;
                border-radius: 10px;
                padding: 15px;
                border: 2px solid #0d3b66;
            `;
            
            participantCard.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <img src="${userData.photoURL || 'https://via.placeholder.com/50'}" 
                         style="width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #0d3b66; font-size: 1.1rem;">
                            ${userData.firstName} ${userData.lastName}
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            ğŸ“§ ${userData.email}
                        </div>
                        <div style="color: #666; font-size: 0.9rem;">
                            ğŸ“ School ID: ${userData.schoolId || 'N/A'}
                        </div>
                    </div>
                </div>
                
                <!-- Participant Video Placeholder -->
                <div style="background: #000; border-radius: 8px; height: 150px; display: flex; align-items: center; justify-content: center; color: white; margin-bottom: 10px;">
                    <div style="text-align: center;">
                        <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ‘¤</div>
                        <div>Camera not connected</div>
                    </div>
                </div>
                
                <!-- Participant Controls -->
                <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                    <button class="practice-btn" onclick="toggleParticipantMic('${uid}')" id="mic-${uid}" 
                            style="flex: 1; font-size: 0.85rem; padding: 8px; background: #28a745;">
                        ğŸ¤ Mic ON
                    </button>
                    <button class="practice-btn" onclick="toggleParticipantVideo('${uid}')" id="video-${uid}"
                            style="flex: 1; font-size: 0.85rem; padding: 8px; background: #28a745;">
                        ğŸ“¹ Cam ON
                    </button>
                </div>
                
                <!-- Admin Actions -->
                <div style="display: flex; gap: 8px;">
                    <button class="practice-btn" onclick="eliminateParticipant('${uid}', '${tournamentId}', ${stage})"
                            style="flex: 1; font-size: 0.85rem; padding: 8px; background: #dc3545;">
                        âŒ Eliminate
                    </button>
                    <button class="practice-btn" onclick="advanceParticipant('${uid}', '${tournamentId}', ${stage})"
                            style="flex: 1; font-size: 0.85rem; padding: 8px; background: #667eea;">
                        â¡ï¸ Advance
                    </button>
                </div>
            `;
            
            grid.appendChild(participantCard);
            
        } catch (error) {
            console.error('Error loading participant:', uid, error);
        }
    }
}

function toggleAdminAudio() {
    myAudioEnabled = !myAudioEnabled;
    
    if (localStream) {
        localStream.getAudioTracks().forEach(track => {
            track.enabled = myAudioEnabled;
        });
    }
    
    const btn = document.getElementById('admin-audio-btn');
    if (btn) {
        btn.textContent = myAudioEnabled ? 'ğŸ¤ Mic: ON' : 'ğŸ¤ Mic: OFF';
        btn.style.background = myAudioEnabled ? '#28a745' : '#dc3545';
    }
}

function toggleAdminVideo() {
    myVideoEnabled = !myVideoEnabled;
    
    if (localStream) {
        localStream.getVideoTracks().forEach(track => {
            track.enabled = myVideoEnabled;
        });
    }
    
    const btn = document.getElementById('admin-video-btn');
    if (btn) {
        btn.textContent = myVideoEnabled ? 'ğŸ“¹ Camera: ON' : 'ğŸ“¹ Camera: OFF';
        btn.style.background = myVideoEnabled ? '#28a745' : '#dc3545';
    }
}

async function toggleParticipantMic(userId) {
    // In real implementation, this would send a signal through WebRTC
    // For now, we'll update Firestore to track state
    try {
        await db.collection('liveRoomControls').doc(userId).set({
            micEnabled: false,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        const btn = document.getElementById(`mic-${userId}`);
        if (btn) {
            const currentState = btn.textContent.includes('ON');
            btn.textContent = currentState ? 'ğŸ¤ Mic OFF' : 'ğŸ¤ Mic ON';
            btn.style.background = currentState ? '#dc3545' : '#28a745';
        }
        
    } catch (error) {
        console.error('Error toggling mic:', error);
    }
}

async function toggleParticipantVideo(userId) {
    try {
        await db.collection('liveRoomControls').doc(userId).set({
            videoEnabled: false,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        const btn = document.getElementById(`video-${userId}`);
        if (btn) {
            const currentState = btn.textContent.includes('ON');
            btn.textContent = currentState ? 'ğŸ“¹ Cam OFF' : 'ğŸ“¹ Cam ON';
            btn.style.background = currentState ? '#dc3545' : '#28a745';
        }
        
    } catch (error) {
        console.error('Error toggling video:', error);
    }
}

async function eliminateParticipant(userId, tournamentId, stage) {
    if (!confirm('âŒ Are you sure you want to ELIMINATE this participant?')) {
        return;
    }
    
    try {
        // Remove from live room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc(`stage${stage}`).update({
                participants: firebase.firestore.FieldValue.arrayRemove(userId)
            });
        
        // Mark as eliminated in tournament
        await db.collection('tournaments').doc(tournamentId)
            .collection('participants').doc(userId).update({
                status: 'eliminated',
                eliminatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                eliminatedStage: stage
            });
        
        alert('âœ… Participant eliminated');
        
    } catch (error) {
        console.error('Error eliminating participant:', error);
        alert('Failed to eliminate participant');
    }
}

async function advanceParticipant(userId, tournamentId, stage) {
    if (!confirm('â¡ï¸ Advance this participant to the next stage?')) {
        return;
    }
    
    try {
        const nextStage = stage + 1;
        
        // Remove from current room
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc(`stage${stage}`).update({
                participants: firebase.firestore.FieldValue.arrayRemove(userId)
            });
        
        // Update participant stage
        await db.collection('tournaments').doc(tournamentId)
            .collection('participants').doc(userId).update({
                stage: nextStage,
                advancedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        // Check if next stage room exists, if not create it
        const nextRoomRef = db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc(`stage${nextStage}`);
        const nextRoomDoc = await nextRoomRef.get();
        
        if (!nextRoomDoc.exists) {
            await nextRoomRef.set({
                stage: nextStage,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                isActive: false,
                participants: [userId]
            });
        } else {
            await nextRoomRef.update({
                participants: firebase.firestore.FieldValue.arrayUnion(userId)
            });
        }
        
        alert(`âœ… Participant advanced to Stage ${nextStage}`);
        
    } catch (error) {
        console.error('Error advancing participant:', error);
        alert('Failed to advance participant');
    }
}

async function closeLiveRoom(tournamentId, stage) {
    if (!confirm('ğŸšª Close this live room? Participants will be disconnected.')) {
        return;
    }
    
    try {
        // Stop local stream
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // Clean up listener
        if (liveRoomListener) {
            liveRoomListener();
            liveRoomListener = null;
        }
        
        // Mark room as inactive
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc(`stage${stage}`).update({
                isActive: false,
                closedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        // Hide container
        const container = document.getElementById('live-room-container');
        if (container) {
            container.style.display = 'none';
        }
        
        alert('âœ… Live room closed');
        
        // Return to admin panel
        navigateTo('admin');
        
    } catch (error) {
        console.error('Error closing live room:', error);
        alert('Failed to close live room');
    }
}

function hideAllStages() {
    const stages = [
        'tournament-stage1',
        'tournament-stage2',
        'tournament-stage3',
        'tournament-stage4',
        'tournament-stage5',
        'tournament-stage6',
        'tournament-stage7'
    ];
    
    stages.forEach(stageId => {
        const stage = document.getElementById(stageId);
        if (stage) stage.style.display = 'none';
    });
}

// ========================================
// PARTICIPANT SIDE - JOIN LIVE ROOM
// ========================================

async function joinLiveRoomAsParticipant(tournamentId, stage) {
    if (!currentUser) {
        alert('Please sign in first');
        return;
    }
    
    try {
        console.log('ğŸ¥ Joining live room for Stage', stage);
        
        // Request media permissions
        localStream = await navigator.mediaDevices.getUserMedia({
            audio: true,
            video: true
        });
        
        // Add self to live room participants
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc(`stage${stage}`).update({
                participants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
            });
        
        // Show participant interface
        showParticipantLiveRoomUI(tournamentId, stage);
        
    } catch (error) {
        console.error('Error joining live room:', error);
        alert('Failed to access camera/microphone: ' + error.message);
    }
}

function showParticipantLiveRoomUI(tournamentId, stage) {
    hideAllStages();
    
    const tournamentsSection = document.querySelector('#tournaments-section .word-database');
    let participantContainer = document.getElementById('participant-live-room');
    
    if (!participantContainer) {
        participantContainer = document.createElement('div');
        participantContainer.id = 'participant-live-room';
        tournamentsSection.appendChild(participantContainer);
    }
    
    participantContainer.style.display = 'block';
    
    participantContainer.innerHTML = `
        <div class="quiz-question-card">
            <div style="background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; border-radius: 10px; margin-bottom: 20px; color: white;">
                <h2 style="margin: 0 0 10px 0; color: white;">ğŸ¥ LIVE ROOM - Stage ${stage}</h2>
                <p style="margin: 0; opacity: 0.9;">Face-to-face tournament round</p>
            </div>
            
            <!-- My Controls -->
            <div style="background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px;">
                    <button class="practice-btn" onclick="toggleMyAudio()" id="my-audio-btn" style="flex: 1; background: #28a745;">
                        ğŸ¤ Mic: ON
                    </button>
                    <button class="practice-btn" onclick="toggleMyVideo()" id="my-video-btn" style="flex: 1; background: #28a745;">
                        ğŸ“¹ Camera: ON
                    </button>
                    <button class="practice-btn" onclick="leaveLiveRoom('${tournamentId}', ${stage})" style="flex: 1; background: #dc3545;">
                        ğŸšª Leave
                    </button>
                </div>
            </div>
            
            <!-- My Video -->
            <div style="background: #000; border-radius: 10px; overflow: hidden; margin-bottom: 20px; position: relative;">
                <video id="my-video" autoplay muted playsinline style="width: 100%; max-height: 300px; object-fit: cover;"></video>
                <div style="position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 8px 15px; border-radius: 20px; color: white; font-weight: bold;">
                    ğŸ‘¤ YOU
                </div>
            </div>
            
            <div style="text-align: center; padding: 30px; background: #e3f2fd; border-radius: 10px;">
                <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ¤</div>
                <h3 style="color: #0d3b66; margin-bottom: 10px;">Ready for Live Round</h3>
                <p style="color: #666;">Wait for the admin to start asking questions</p>
            </div>
        </div>
    `;
    
    // Setup my video
    const myVideo = document.getElementById('my-video');
    if (myVideo && localStream) {
        myVideo.srcObject = localStream;
    }
}

function toggleMyAudio() {
    myAudioEnabled = !myAudioEnabled;
    
    if (localStream) {
        localStream.getAudioTracks().forEach(track => {
            track.enabled = myAudioEnabled;
        });
    }
    
    const btn = document.getElementById('my-audio-btn');
    if (btn) {
        btn.textContent = myAudioEnabled ? 'ğŸ¤ Mic: ON' : 'ğŸ¤ Mic: OFF';
        btn.style.background = myAudioEnabled ? '#28a745' : '#dc3545';
    }
}

function toggleMyVideo() {
    myVideoEnabled = !myVideoEnabled;
    
    if (localStream) {
        localStream.getVideoTracks().forEach(track => {
            track.enabled = myVideoEnabled;
        });
    }
    
    const btn = document.getElementById('my-video-btn');
    if (btn) {
        btn.textContent = myVideoEnabled ? 'ğŸ“¹ Camera: ON' : 'ğŸ“¹ Camera: OFF';
        btn.style.background = myVideoEnabled ? '#28a745' : '#dc3545';
    }
}

async function leaveLiveRoom(tournamentId, stage) {
    if (!confirm('ğŸšª Leave this live room?')) {
        return;
    }
    
    try {
        // Stop local stream
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        // Remove from participants
        await db.collection('tournaments').doc(tournamentId)
            .collection('liveRooms').doc(`stage${stage}`).update({
                participants: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
            });
        
        // Hide container
        const container = document.getElementById('participant-live-room');
        if (container) {
            container.style.display = 'none';
        }
        
        alert('âœ… Left live room');
        
        navigateTo('tournaments');
        
    } catch (error) {
        console.error('Error leaving live room:', error);
        alert('Failed to leave live room');
    }
} 


// ===== SEEDED RANDOM HELPER FUNCTIONS =====
function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32bit integer
    }
    return Math.abs(hash);
}

function createSeededRandom(seed) {
    let currentSeed = seed;
    return function() {
        currentSeed = (currentSeed * 9301 + 49297) % 233280;
        return currentSeed / 233280;
    };
}        
    </script>
</body>
</html>
