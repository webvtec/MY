   <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">
        <div class="sidebar-user-info" id="sidebarUserInfo">
            <div class="user-avatar" id="sidebarUserAvatar" style="background-image: none; background-size: cover; background-position: center;">?</div>
            <span id="sidebarUserName">Guest</span>
            <button class="my-profile-btn" id="myProfileBtn" onclick="goToUserDashboard()" style="display: none;">
                üë§ MY PROFILE
            </button>
        </div>
    </div>
    <div class="sidebar-item sidebar-item-home" onclick="navigateTo('home')">HOME</div>
    <div class="sidebar-item" onclick="navigateTo('word-database')">WORD DATABASE</div>
    <div class="sidebar-item" onclick="navigateTo('coaches')">BOOK COACHES</div>
    <div class="sidebar-item" onclick="navigateTo('students')">OUR STUDENTS</div>
    <div class="sidebar-item" onclick="()">CONTACT US</div>
    <div class="sidebar-item" onclick="navigateTo('about')">ABOUT US</div>
    <div class="sidebar-item" id="admin-nav-link" onclick="navigateTo('admin')" style="display: none;">ADMIN PANEL</div>
    <div class="sidebar-item sign-in" id="sidebar-signin" onclick="showAuthModal()">SIGN IN</div>
    <div class="sidebar-item" id="sidebar-signout" style="display:none;" onclick="signOut()">SIGN OUT</div>
</div>
</div>


<script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        
// ===== PAYPAL CONFIGURATION =====
const PAYPAL_HANDLER_URL = 'https://verificationpaypalpayment-998744778737.us-central1.run.app';
const REOPEN_ACCOUNT_COST = 6.50;
const REOPEN_DAYS = 30;

let paypalButtonRendered = false;
let sponsorPaypalRendered = false;
let currentChildData = null;

        

        let paypalSDKLoaded = false;

async function loadPayPalSDK() {
    if (paypalSDKLoaded) {
        return Promise.resolve();
    }
    
    try {
        // Get client ID from Firebase function
        const response = await fetch(`${PAYPAL_HANDLER_URL}?action=getClientId`);
        const data = await response.json();
        
        if (!data.success || !data.clientId) {
            throw new Error('Failed to get PayPal client ID');
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${data.clientId}&currency=USD&locale=en_US`;
            script.async = true;
            
            script.onload = () => {
                paypalSDKLoaded = true;
                console.log('‚úÖ PayPal SDK loaded');
                resolve();
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load PayPal SDK'));
            };
            
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading PayPal SDK:', error);
        throw error;
    }
}
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // ‚úÖ NEW: Track declined challenges
let presenceInitialized = false; // ‚úÖ NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// ‚úÖ Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;


// ===== TOURNAMENT VARIABLES =====
let currentTournament = null;
let tournamentStage = 0;
let stage1Questions = [];
let stage1CurrentIndex = 0;
let stage1Score = 0;
let stage1Errors = 0;
let stage1Handicaps = 2;
let stage1TimeLeft = 600; // 10 minutes in seconds
let stage1Timer = null;

// ===== STAGE 2: AI AUDIO SPELLING =====
let stage2Words = [];
let stage2CurrentIndex = 0;
let stage2Score = 0;
let stage2Errors = 0;
let stage2TimeLeft = 900; // 15 minutes
let stage2Timer = null;
let stage2HandicapsRemaining = 1; // Base 1 + carried from Stage 1

// ===== TOURNAMENT STAGE 3 FUNCTIONS =====
let stage3Words = [];
let stage3CurrentIndex = 0;
let stage3Score = 0;
let stage3Errors = 0;
let stage3TimeLeft = 900; // 15 minutes
let stage3Timer = null;
let stage3HandicapsRemaining = 0;
let stage3CurrentLetterOrder = [];
let stage3DraggedElement = null;

// ===== LIVE STAGES 4-7 VARIABLES =====
let stage4RoomId = null;
let stage5RoomId = null;
let stage6RoomId = null;
let stage7RoomId = null;
let currentStageRoom = null;
let stageRoomListener = null;


// ===== LIVE ROOM VARIABLES =====
let localStream = null;
let liveRoomParticipants = new Map(); // userId -> {name, email, schoolId, stream, audioEnabled, videoEnabled}
let liveRoomListener = null;
let myAudioEnabled = true;
let myVideoEnabled = true;


// ===== AUTO-ELIMINATION VARIABLES =====
let stage3CompletionChecker = null;
const STAGE3_CUTOFF_TIME = 15 * 60 * 1000; // 15 minutes to complete Stage 3
const STAGE3_ELIMINATION_DELAY = 2 * 60 * 1000; // Wait 2 minutes after first completion before eliminating
let stage3FirstCompletionTime = null;

        
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // ‚úÖ Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // ‚úÖ ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // √¢≈ì‚Ä¶ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });
    
auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        console.log('üë§ User signed in:', user.email);
        console.log('üñºÔ∏è Auth photoURL:', user.photoURL);
        
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        console.log('üìÑ Firestore photoURL:', userData.photoURL);
        
        if (user.photoURL && !userData.photoURL) {
            console.log('üìÑ Syncing photoURL to Firestore...');
            await userRef.update({
                photoURL: user.photoURL
            });
            console.log('‚úÖ PhotoURL synced!');
        }
        
        // ‚úÖ INITIALIZE SPELLING STATS IF NOT EXISTS
        if (!userData.spellingStats) {
            console.log('üìÑ Initializing spelling stats...');
            await userRef.update({
                spellingStats: {
                    totalChallenges: 0,
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    winStreak: 0,
                    bestStreak: 0
                }
            });
            console.log('‚úÖ Spelling stats initialized!');
        }
        
        // ‚úÖ CHECK ADMIN STATUS HERE (CRITICAL - RIGHT AFTER USER DATA IS LOADED)
        await checkAdminStatus();
        
        // ‚úÖ CHECK USER TYPE AND HANDLE ACCORDINGLY
        if (userData.userType === 'parent') {
            // Parent user - no profile completion needed
            if (!userData.profileComplete) {
                await userRef.update({ profileComplete: true });
            }
            updateUIForAuthenticatedUser(user);
            
            // Navigate to parent dashboard
            navigateTo('parent-dashboard');
            return;
        }
        
        // STUDENT/COACH HANDLING
        if (!userData.profileComplete) {
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // ‚úÖ LOAD USER COINS (for students only)
        if (userData.userType === 'student') {
            await loadUserCoins(user.uid);
            await checkSubscriptionStatus();
        }
        
        await cleanupInvalidFavorites();
        
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // ‚úÖ Initialize presence immediately on login (only for students/coaches)
        if (userData.userType !== 'parent') {
            await initializeOnlinePresence();
        }
        
        // Load appropriate dashboard
        if (userData.userType === 'student') {
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        }
   } else {
    currentUser = null;
    isAdmin = false;
    
    // ‚úÖ Clean up tournament listeners
    if (tournamentListeners) {
        tournamentListeners.forEach(unsubscribe => unsubscribe());
        tournamentListeners = [];
    }
    
    updateUIForGuestUser();
    updateAdminUI();
}
});
    });
        
        
    
// ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // ‚úÖ CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'parent-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // ‚úÖ ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard' || section === 'parent-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // ‚úÖ PREVENT PARENTS FROM ACCESSING STUDENT FEATURES
    if (currentUser && section !== 'parent-dashboard' && section !== 'home' && section !== 'about' && section !== 'coaches' && section !== 'students') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'parent') {
                alert('‚ö†Ô∏è Parents can only access:\n‚Ä¢ Parent Dashboard\n‚Ä¢ Home\n‚Ä¢ About\n‚Ä¢ Coaches\n‚Ä¢ Students\n\nPlease use the Parent Dashboard to manage your child\'s account.');
                navigateTo('parent-dashboard');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // ‚úÖ Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // ‚úÖ RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // ‚úÖ Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // ‚úÖ Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // ‚úÖ Load student dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    // ‚úÖ Load parent dashboard when navigating to it
    if (section === 'parent-dashboard' && currentUser) {
        await loadParentDashboard();
    }
    
    // ‚úÖ LOAD ADMIN PANEL WHEN NAVIGATING TO IT
    if (section === 'admin' && currentUser) {
        console.log('üéØ Navigating to admin panel. isAdmin:', isAdmin);
        if (!isAdmin) {
            alert('‚ùå Admin access required. Please sign in with an admin account.');
            navigateTo('home');
            return;
        }
        await loadAdminPanel();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }

    if (section === 'tournaments') {
    await loadTournamentList();
}
}




  // ===== COACHES DISPLAY FUNCTIONS =====
async function loadAndDisplayCoaches() {
    const container = document.getElementById('coaches-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading coaches...</div>';
        
        console.log('üîç Fetching coaches from Firestore...');
        
        // Fetch all coaches from Firestore
        const coachesSnapshot = await db.collection('users')
            .where('userType', '==', 'coach')
            .get();
        
        console.log('üìä Found coaches:', coachesSnapshot.size);
        
        if (coachesSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üë®‚Äçüè´</div>
                    <h3>No coaches registered yet</h3>
                    <p>Be the first to join as a coach!</p>
                </div>
            `;
            return;
        }
        
        const coaches = [];
        coachesSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Coach:', doc.id, data.name, data.photoURL);
            coaches.push({ id: doc.id, ...data });
        });
        
        // Sort coaches (newest first)
        coaches.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate stats
        const totalCoaches = coaches.length;
        const verifiedCoaches = coaches.filter(c => c.idVerified).length;
        const pendingCoaches = totalCoaches - verifiedCoaches;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Cards -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalCoaches}</div>
                    <div class="stat-label">Total Coaches</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${verifiedCoaches}</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${pendingCoaches}</div>
                    <div class="stat-label">‚è≥ Pending</div>
                </div>
            </div>
            
            <!-- Coaches Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üë®‚Äçüè´ Coach</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => {
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (coach.photoURL) {
                                avatarStyle = `style="background-image: url('${coach.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (coach.name || 'C').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showCoachDetailById('${coach.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${coach.name || 'Unknown Coach'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        ${coach.idVerified ? 
                                            '<span class="verified-badge">Verified</span>' : 
                                            '<span class="unverified-badge">‚è≥ Pending</span>'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">üõ°Ô∏è Safety & Verification</h3>
                <p style="color: #666; line-height: 1.6;">
                    All coaches on WordBiz Coaching Academy undergo ID verification for student safety. 
                    Click on any coach to view their full profile and verification details.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading coaches:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading coaches. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayCoaches()">üîÑ Retry</button>
            </div>
        `;
    }
}

// Load and show coach profile modal
async function showCoachDetailById(coachId) {
    try {
        console.log('üìã Loading coach details for:', coachId);
        const coachDoc = await db.collection('users').doc(coachId).get();
        
        if (coachDoc.exists) {
            const coach = { id: coachDoc.id, ...coachDoc.data() };
            console.log('Coach data loaded:', coach);
            showCoachDetail(coach);
        } else {
            console.error('‚ùå Coach not found');
            alert('Coach profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading coach details:', error);
        alert('Unable to load coach details: ' + error.message);
    }
}

// Display coach detail modal
function showCoachDetail(coach) {
    console.log('Displaying coach modal:', coach.name);
    const modal = document.getElementById('coachDetailModal');
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-coach-avatar');
    if (coach.photoURL) {
        console.log('üñºÔ∏è Setting photo URL:', coach.photoURL);
        avatar.style.backgroundImage = `url('${coach.photoURL}')`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.textContent = '';
    } else {
        console.log('üî§ No photo URL, using initial');
        avatar.style.backgroundImage = 'none';
        avatar.textContent = (coach.name || 'C').charAt(0).toUpperCase();
    }
    
    // Update name
    document.getElementById('modal-coach-name').textContent = coach.name || 'Unknown Coach';
    
    // Update status badge
    const statusBadge = document.getElementById('modal-coach-status');
    if (coach.idVerified) {
        statusBadge.className = 'status-badge verified';
        statusBadge.textContent = 'Verified';
    } else {
        statusBadge.className = 'status-badge pending';
        statusBadge.textContent = '‚è≥ Pending Verification';
    }
    
    // Update email
    document.getElementById('modal-coach-email').textContent = coach.email || 'N/A';
    
    // Update organization
    document.getElementById('modal-coach-organization').textContent = coach.organization || 'Independent';
    
    // Update joined date
    if (coach.createdAt) {
        const joinDate = coach.createdAt.toDate();
        document.getElementById('modal-coach-joined').textContent = 
            joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } else {
        document.getElementById('modal-coach-joined').textContent = 'Recently';
    }
    
    // Show/hide age if available
    const ageRow = document.getElementById('modal-coach-age-row');
    if (coach.verifiedAge) {
        ageRow.style.display = 'flex';
        document.getElementById('modal-coach-age').textContent = coach.verifiedAge + ' years old';
    } else {
        ageRow.style.display = 'none';
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('Modal displayed');
}

// Close coach detail modal
function closeCoachDetailModal() {
    document.getElementById('coachDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('coachDetailModal');
    if (event.target === modal) {
        closeCoachDetailModal();
    }
});

     
// ===== STUDENTS DISPLAY FUNCTIONS =====
async function loadAndDisplayStudents() {
    const container = document.getElementById('students-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading students...</div>';
        
        console.log('üîç Fetching students from Firestore...');
        
        // Fetch all students from Firestore
        const studentsSnapshot = await db.collection('users')
            .where('userType', '==', 'student')
            .get();
        
        console.log('üìä Found students:', studentsSnapshot.size);
        
        if (studentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üéì</div>
                    <h3>No students registered yet</h3>
                    <p>Be the first to join as a student!</p>
                </div>
            `;
            return;
        }
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Student:', doc.id, data.name, data.photoURL);
            students.push({ id: doc.id, ...data });
        });
        
        // Sort students (newest first)
        students.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate total students
        const totalStudents = students.length;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Card -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            </div>
            
            <!-- Students Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üéì Student</th>
                            <th>üÜî Student ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => {
                            // Generate Student ID (WB-2025-XXXX)
                            const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
                            
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (student.photoURL) {
                                avatarStyle = `style="background-image: url('${student.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (student.name || 'S').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showStudentDetailById('${student.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${student.name || 'Student'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span style="font-family: monospace; background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: #0d3b66;">
                                            ${studentId}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                <h3 style="color: white; margin-bottom: 10px;">üåü Growing Community</h3>
                <p style="color: rgba(255,255,255,0.95); line-height: 1.6;">
                    Our students are learning from coaches around the world, building vocabulary skills 
                    through interactive quizzes, spelling challenges, and personalized practice sessions.
                    Click on any student to view their full profile.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading students:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading students. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayStudents()">üîÑ Retry</button>
            </div>
        `;
    }
}
        
// Load and show student profile modal
async function showStudentDetailById(studentId) {
    try {
        console.log('üìã Loading student details for:', studentId);
        const studentDoc = await db.collection('users').doc(studentId).get();
        
        if (studentDoc.exists) {
            const student = { id: studentDoc.id, ...studentDoc.data() };
            console.log('Student data loaded:', student);
            showStudentDetail(student);
        } else {
            console.error('‚ùå Student not found');
            alert('Student profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading student details:', error);
        alert('Unable to load student details: ' + error.message);
    }
}

// Display student detail modal
function showStudentDetail(student) {
    console.log('Displaying student modal:', student.name);
    const modal = document.getElementById('studentDetailModal');
    
    // Generate Student ID
    const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-student-avatar');
    if (student.photoURL) {
        console.log('üñºÔ∏è Setting photo URL:', student.photoURL);
        avatar.style.backgroundImage = `url('${student.photoURL}')`;
        avatar.style.backgroundSize = 'cover';
        avatar.style.backgroundPosition = 'center';
        avatar.textContent = '';
    } else {
        console.log('üî§ No photo URL, using initial');
        avatar.style.backgroundImage = 'none';
        avatar.textContent = (student.name || 'S').charAt(0).toUpperCase();
    }
    
    // Update name
    document.getElementById('modal-student-name').textContent = student.name || 'Student';
    
    // Update Student ID (both places)
    document.getElementById('modal-student-id').textContent = studentId;
    document.getElementById('modal-student-id-display').textContent = studentId;
    
    // Update email
    document.getElementById('modal-student-email').textContent = student.email || 'N/A';
    
    // Update age
    const ageRow = document.getElementById('modal-student-age-row');
    if (student.age) {
        ageRow.style.display = 'flex';
        document.getElementById('modal-student-age').textContent = student.age + ' years old';
    } else {
        ageRow.style.display = 'none';
    }
    
    // Update country
    document.getElementById('modal-student-country').textContent = student.country || 'N/A';
    
    // Update joined date
    if (student.createdAt) {
        const joinDate = student.createdAt.toDate();
        document.getElementById('modal-student-joined').textContent = 
            joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    } else {
        document.getElementById('modal-student-joined').textContent = 'Recently';
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('Modal displayed');
}

// Close student detail modal
function closeStudentDetailModal() {
    document.getElementById('studentDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('studentDetailModal');
    if (event.target === modal) {
        closeStudentDetailModal();
    }
});

</script>
</html>
</body>
