 <!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header" id="sidebarHeader">
        <div class="sidebar-user-info" id="sidebarUserInfo">
            <div class="user-avatar" id="sidebarUserAvatar" style="background-image: none; background-size: cover; background-position: center;">?</div>
            <span id="sidebarUserName">Guest</span>
            <button class="my-profile-btn" id="myProfileBtn" onclick="goToUserDashboard()" style="display: none;">
                üë§ MY PROFILE
            </button>
        </div>
    </div>
    <div class="sidebar-item sidebar-item-home" onclick="navigateTo('home')">HOME</div>
    <div class="sidebar-item" onclick="navigateTo('word-database')">WORD DATABASE</div>
    <div class="sidebar-item" onclick="navigateTo('coaches')">BOOK COACHES</div>
    <div class="sidebar-item" onclick="navigateTo('students')">OUR STUDENTS</div>
    <div class="sidebar-item" onclick="()">CONTACT US</div>
    <div class="sidebar-item" onclick="navigateTo('about')">ABOUT US</div>
    <div class="sidebar-item" id="admin-nav-link" onclick="navigateTo('admin')" style="display: none;">ADMIN PANEL</div>
    <div class="sidebar-item sign-in" id="sidebar-signin" onclick="showAuthModal()">SIGN IN</div>
    <div class="sidebar-item" id="sidebar-signout" style="display:none;" onclick="signOut()">SIGN OUT</div>
</div>
</div>



    <!-- Class Section -->
<div id="class-section" class="content-section">
    <div class="word-database">
        <div class="database-header">
            <h2 id="class-section-title">MY CLASS</h2>
        </div>
        
        <!-- Student View -->
        <div id="student-class-view" style="display: none;">
            <div id="student-class-info" class="loading">Loading class information...</div>
        </div>
        
        <!-- Coach View -->
        <div id="coach-class-view" style="display: none;">
            <div class="dashboard-section">
                <h2 class="section-title">üìö CLASS MANAGEMENT</h2>
                
                <!-- Class Stats -->
                <div class="dashboard-grid" id="coach-class-stats">
                    <div class="dashboard-card">
                        <div class="card-icon">üë•</div>
                        <div class="stat-number" id="class-student-count">0</div>
                        <div class="card-label">Students</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon">üì¢</div>
                        <div class="stat-number" id="class-announcement-count">0</div>
                        <div class="card-label">Announcements</div>
                    </div>
                    <div class="dashboard-card">
                        <div class="card-icon">üé•</div>
                        <div class="stat-number" id="class-session-count">0</div>
                        <div class="card-label">Sessions</div>
                    </div>
                </div>
                
                <!-- Announcements Section -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">üì¢ Announcements</h3>
                    <button class="practice-btn" onclick="showAddAnnouncementModal()" style="margin-bottom: 20px;">
                        ‚ûï Add Announcement
                    </button>
                    <div id="coach-announcements-list"></div>
                </div>
                
                <!-- Students List -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">üë• Class Students</h3>
                    <div id="coach-students-list"></div>
                </div>
                
                <!-- Live Session Controls -->
                <div style="margin-top: 30px;">
                    <h3 style="color: #0d3b66; margin-bottom: 15px;">üé• Live Session</h3>
                    <button class="practice-btn" id="start-session-btn" onclick="startLiveSession()" style="background: #28a745;">
                        üé• Start Live Session
                    </button>
                    <div id="live-session-container" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Announcement Modal -->
<div class="auth-modal" id="announcementModal">
    <div class="auth-content" style="max-width: 600px;">
        <div class="auth-header">
            <h2>üì¢ Add Announcement</h2>
            <button class="modal-close" onclick="closeAnnouncementModal()">√ó</button>
        </div>
        <div class="auth-body">
            <form id="announcement-form" onsubmit="handleAddAnnouncement(event)">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="announcement-title" required maxlength="100">
                </div>
                
                <div class="form-group">
                    <label>Message *</label>
                    <textarea id="announcement-message" required rows="5" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif; resize: vertical;"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Next Class Date (Optional)</label>
                    <input type="datetime-local" id="announcement-class-date" style="width: 100%; padding: 12px; border: 2px solid #0d3b66; border-radius: 5px; font-family: Georgia, serif;">
                </div>
                
                <button type="submit" class="auth-submit">üì¢ Post Announcement</button>
                <div id="announcement-error" class="feedback error" style="display:none; margin-top:15px;"></div>
            </form>
        </div>
    </div>
</div>
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyCDdnDKsCUaCK4L95G57AC9-BjCqJiIywA",
            authDomain: "wordbiz-coaching-academy.firebaseapp.com",
            projectId: "wordbiz-coaching-academy",
            storageBucket: "wordbiz-coaching-academy.firebasestorage.app",
            messagingSenderId: "829294789081",
            appId: "1:829294789081:web:501ae4d3d6f3694a40d9c8"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ===== CLOUD FUNCTION URL =====
        const CLOUD_FUNCTION_URL = 'https://getworddefinition-998744778737.us-central1.run.app';


        
// ===== PAYPAL CONFIGURATION =====
const PAYPAL_HANDLER_URL = 'https://verificationpaypalpayment-998744778737.us-central1.run.app';
const REOPEN_ACCOUNT_COST = 6.50;
const REOPEN_DAYS = 30;

let paypalButtonRendered = false;
let sponsorPaypalRendered = false;
let currentChildData = null;

        

        let paypalSDKLoaded = false;

async function loadPayPalSDK() {
    if (paypalSDKLoaded) {
        return Promise.resolve();
    }
    
    try {
        // Get client ID from Firebase function
        const response = await fetch(`${PAYPAL_HANDLER_URL}?action=getClientId`);
        const data = await response.json();
        
        if (!data.success || !data.clientId) {
            throw new Error('Failed to get PayPal client ID');
        }
        
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = `https://www.paypal.com/sdk/js?client-id=${data.clientId}&currency=USD&locale=en_US`;
            script.async = true;
            
            script.onload = () => {
                paypalSDKLoaded = true;
                console.log('‚úÖ PayPal SDK loaded');
                resolve();
            };
            
            script.onerror = () => {
                reject(new Error('Failed to load PayPal SDK'));
            };
            
            document.head.appendChild(script);
        });
    } catch (error) {
        console.error('Error loading PayPal SDK:', error);
        throw error;
    }
}
        
        // ===== GLOBAL VARIABLES =====
let allWords = [];
let currentLetter = '';
let currentWord = null;
let isListening = false;
let recognition = null;
let currentUser = null;
let currentQuiz = null;
let currentQuestionIndex = 0;
let quizScore = 0;
let userFavorites = [];
let userIncorrect = [];
let userSpellingFavorites = [];
let userSpellingIncorrect = [];
let quizStartTime = null;
let quizAnswerTimes = [];
let quizDifficulty = 'medium'; // track difficulty
let questionStartTime = null;

// ===== LIVE SPELLING GLOBALS =====
let challengeListener = null;
let myChallengeListener = null;
let shownPopupIds = new Set();
let declinedChallengeIds = new Set(); // ‚úÖ NEW: Track declined challenges
let presenceInitialized = false; // ‚úÖ NEW: Prevent duplicate presence initialization


// ===== PARENT ID VERIFICATION VARIABLES =====
let parentIDFile = null;
let parentIDBase64 = null;
let childIDFile = null;
let childIDBase64 = null;
let parentIDVerified = false;
let childIDVerified = false;

// ===== LEVEL-BASED WORD LOADING =====
let currentLevel = '';
let levelWords = {
    foundation: [],
    challenge: [],
    advanced: [],
    championship: []
};

// Google Docs URLs for each level - REPLACE WITH YOUR ACTUAL GOOGLE DOCS IDs
const LEVEL_DOCS = {
    foundation: 'https://docs.google.com/document/d/1cgq8FfGXHfFtzeroC1BU5CpNz8Y7Y8qk7f0lduoFdz4/export?format=txt',
    challenge: 'https://docs.google.com/document/d/1sJLFvQZ2eOBOhZLEf4LhnDZCFJy8vn6sa_HV8JpK_Us/export?format=txt',
    advanced: 'https://docs.google.com/document/d/1w2lG7hLHixwn-KtNTEUgHU0txtN7_bhGIPrnvdKnPtc/export?format=txt',
    championship: 'https://docs.google.com/document/d/1ATXYyC7nQOYZ5yyDXow0v0o1efCpXLd3r0GCloCVUrY/export?format=txt'
};

// ===== SPELLING PRACTICE FUNCTIONS =====
let spellingWords = [];
let currentSpellingIndex = 0;
let spellingScore = 0;
let currentSpellingWord = '';
let spellingMistakes = [];
let selectedGameLevel = '';

// ===== UNSCRAMBLE FUNCTIONS =====
let unscrambleWords = [];
let currentUnscrambleIndex = 0;
let unscrambleScore = 0;
let currentUnscrambleWord = '';
let currentLetterOrder = [];
let hintsUsed = 0;
let draggedElement = null;

// ===== ID VERIFICATION VARIABLES =====
let uploadedIDFile = null;
let uploadedIDBase64 = null;
let isCoachVerification = false;
let idVerificationPassed = false;

// ===== LIVE SPELLING VARIABLES =====
let onlineUsersRef = null;
let challengesRef = null;
let activeChallenge = null;
let challengeWords = [];
let currentChallengeIndex = 0;
let myScore = 0;
let opponentScore = 0;
let presenceRef = null;


// ===== LIVE QUIZ VARIABLES =====
let quizOnlineUsersRef = null;
let quizChallengesRef = null;
let activeQuizChallenge = null;
let quizChallengeWords = [];
let currentQuizChallengeIndex = 0;
let myQuizScore = 0;
let opponentQuizScore = 0;
let quizChallengeListener = null;
let myQuizChallengeListener = null;
let shownQuizPopupIds = new Set();

// ‚úÖ Challenge timeout constants
const CHALLENGE_TIMEOUT = 5 * 60 * 1000; // 5 minutes max per challenge
const TURN_TIMEOUT = 60 * 1000; // 60 seconds per turn
const OFFLINE_CHECK_INTERVAL = 10 * 1000; // Check every 10 seconds

let challengeTimeoutTimer = null;
let turnTimeoutTimer = null;
let offlineCheckTimer = null;


let userCoins = 0;
const COINS_PER_WIN = 5;
const MAX_COINS = 1000;


// ===== TOURNAMENT VARIABLES =====
let currentTournament = null;
let tournamentStage = 0;
let stage1Questions = [];
let stage1CurrentIndex = 0;
let stage1Score = 0;
let stage1Errors = 0;
let stage1Handicaps = 2;
let stage1TimeLeft = 600; // 10 minutes in seconds
let stage1Timer = null;

// ===== STAGE 2: AI AUDIO SPELLING =====
let stage2Words = [];
let stage2CurrentIndex = 0;
let stage2Score = 0;
let stage2Errors = 0;
let stage2TimeLeft = 900; // 15 minutes
let stage2Timer = null;
let stage2HandicapsRemaining = 1; // Base 1 + carried from Stage 1

// ===== TOURNAMENT STAGE 3 FUNCTIONS =====
let stage3Words = [];
let stage3CurrentIndex = 0;
let stage3Score = 0;
let stage3Errors = 0;
let stage3TimeLeft = 900; // 15 minutes
let stage3Timer = null;
let stage3HandicapsRemaining = 0;
let stage3CurrentLetterOrder = [];
let stage3DraggedElement = null;

// ===== LIVE STAGES 4-7 VARIABLES =====
let stage4RoomId = null;
let stage5RoomId = null;
let stage6RoomId = null;
let stage7RoomId = null;
let currentStageRoom = null;
let stageRoomListener = null;


// ===== LIVE ROOM VARIABLES =====
let localStream = null;
let liveRoomParticipants = new Map(); // userId -> {name, email, schoolId, stream, audioEnabled, videoEnabled}
let liveRoomListener = null;
let myAudioEnabled = true;
let myVideoEnabled = true;


// ===== AUTO-ELIMINATION VARIABLES =====
let stage3CompletionChecker = null;
const STAGE3_CUTOFF_TIME = 15 * 60 * 1000; // 15 minutes to complete Stage 3
const STAGE3_ELIMINATION_DELAY = 2 * 60 * 1000; // Wait 2 minutes after first completion before eliminating
let stage3FirstCompletionTime = null;


   // ===== CLASS SYSTEM VARIABLES =====
let myClass = null;
let classStudents = [];
let classAnnouncements = [];

// ===== LIVE SESSION VARIABLES =====
let liveSessionActive = false;
let liveSessionId = null;
let liveSessionListener = null;
let myPeerConnection = null;
let localAudioStream = null;
let peerConnections = new Map(); // userId -> RTCPeerConnection
let remoteStreams = new Map(); // userId -> MediaStream
let isMicMuted = false;
let sessionParticipants = new Map(); // userId -> {name, email, photoURL}
let isCoach = false; // Track if current user is coach
        
        
     // ===== INITIALIZE =====
document.addEventListener('DOMContentLoaded', function() {
    initializeAlphabet();
    initializeSpeechRecognition();
    
    // ‚úÖ Cleanup old challenges on page load
    cleanupOldChallenges();
    
    // ‚úÖ ADD SCROLL LISTENER FOR COIN DISPLAY
    window.addEventListener('scroll', function() {
        const coinDisplay = document.getElementById('coinDisplay');
        if (coinDisplay && coinDisplay.classList.contains('show')) {
            if (window.scrollY > 50) {
                coinDisplay.classList.add('scrolled');
            } else {
                coinDisplay.classList.remove('scrolled');
            }
        }
    });
    
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') searchWord();
    });
    
  // √¢≈ì‚Ä¶ ADD MODAL CLOSE HANDLERS
    document.addEventListener('click', function(event) {
        // Close coach detail modal
        const coachModal = document.getElementById('coachDetailModal');
        if (event.target === coachModal) {
            closeCoachDetailModal();
        }
        
        // Close student detail modal
        const studentModal = document.getElementById('studentDetailModal');
        if (event.target === studentModal) {
            closeStudentDetailModal();
        }
        
        // Close leaderboard player modal
        const leaderboardModal = document.getElementById('leaderboardPlayerModal');
        if (event.target === leaderboardModal) {
            closeLeaderboardPlayerModal();
        }
        
        // Close quiz leaderboard player modal
        const quizLeaderboardModal = document.getElementById('quizLeaderboardPlayerModal');
        if (event.target === quizLeaderboardModal) {
            closeQuizLeaderboardPlayerModal();
        }
    });



   auth.onAuthStateChanged(async user => {
    if (user) {
        currentUser = user;
        
        console.log('üë§ User signed in:', user.email);
        console.log('üñºÔ∏è Auth photoURL:', user.photoURL);
        
        const userRef = db.collection('users').doc(user.uid);
        const userDoc = await userRef.get();
        
        if (!userDoc.exists) {
            await auth.signOut();
            alert('Account error. Please sign up again.');
            return;
        }
        
        const userData = userDoc.data();
        console.log('üìÑ Firestore photoURL:', userData.photoURL);
        
        if (user.photoURL && !userData.photoURL) {
            console.log('üìÑ Syncing photoURL to Firestore...');
            await userRef.update({
                photoURL: user.photoURL
            });
            console.log('‚úÖ PhotoURL synced!');
        }
        
        // ‚úÖ INITIALIZE SPELLING STATS IF NOT EXISTS
        if (!userData.spellingStats) {
            console.log('üìÑ Initializing spelling stats...');
            await userRef.update({
                spellingStats: {
                    totalChallenges: 0,
                    wins: 0,
                    losses: 0,
                    totalScore: 0,
                    winStreak: 0,
                    bestStreak: 0
                }
            });
            console.log('‚úÖ Spelling stats initialized!');
        }
        
        // ‚úÖ CHECK ADMIN STATUS HERE (CRITICAL - RIGHT AFTER USER DATA IS LOADED)
        await checkAdminStatus();
        
        // ‚úÖ ADD MY CLASS BUTTON
        const myClassBtn = document.getElementById('myClassBtn');
        if (!myClassBtn) {
            const classBtn = document.createElement('button');
            classBtn.id = 'myClassBtn';
            classBtn.className = 'my-profile-btn';
            classBtn.style.cssText = 'display: none; margin-top: 10px;';
            classBtn.onclick = () => {
                navigateTo('class');
                loadMyClass();
            };
            
            const sidebarUserInfo = document.getElementById('sidebarUserInfo');
            sidebarUserInfo.appendChild(classBtn);
        }
        
        try {
            if (userData && (userData.userType === 'student' || userData.userType === 'coach')) {
                document.getElementById('myClassBtn').innerHTML = 'üìö MY CLASS';
                document.getElementById('myClassBtn').style.display = 'block';
            }
        } catch (error) {
            console.error('Error checking class status:', error);
        }
        
        // ‚úÖ CHECK USER TYPE AND HANDLE ACCORDINGLY
        if (userData.userType === 'parent') {
            // Parent user - no profile completion needed
            if (!userData.profileComplete) {
                await userRef.update({ profileComplete: true });
            }
            updateUIForAuthenticatedUser(user);
            
            // Navigate to parent dashboard
            navigateTo('parent-dashboard');
            return;
        }
        
        // STUDENT/COACH HANDLING
        if (!userData.profileComplete) {
            showVerificationModal(userData);
            return;
        }
        
        updateUIForAuthenticatedUser(user);
        
        // ‚úÖ LOAD USER COINS (for students only)
        if (userData.userType === 'student') {
            await loadUserCoins(user.uid);
            await checkSubscriptionStatus();
        }
        
        await cleanupInvalidFavorites();
        
        await Promise.all([
            loadUserFavorites(user.uid),
            loadUserIncorrect(user.uid),
            loadUserSpellingFavorites(user.uid),
            loadUserSpellingIncorrect(user.uid)
        ]);
        
        // ‚úÖ Initialize presence immediately on login (only for students/coaches)
        if (userData.userType !== 'parent') {
            await initializeOnlinePresence();
        }
        
        // Load appropriate dashboard
        if (userData.userType === 'student') {
            if (document.getElementById('student-dashboard-section').classList.contains('active')) {
                loadUserDashboard();
            }
        }
    } else {
        currentUser = null;
        isAdmin = false;
        
        // ‚úÖ Clean up tournament listeners
        if (tournamentListeners) {
            tournamentListeners.forEach(unsubscribe => unsubscribe());
            tournamentListeners = [];
        }
        
        updateUIForGuestUser();
        updateAdminUI();
    }
});
    });
        
        
    
// ===== NAVIGATION =====
async function navigateTo(section, skipSidebarClose = false) {
    // ‚úÖ CHECK SUBSCRIPTION FOR STUDENTS BEFORE ALLOWING NAVIGATION
    if (currentUser && !subscriptionActive && section !== 'student-dashboard' && section !== 'parent-dashboard' && section !== 'about') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            // ‚úÖ ADD: Only check if user data is fully loaded
            if (userData && userData.profileComplete && userData.userType === 'student') {
                showSubscriptionModal();
                return;
            }
        } catch (error) {
            console.error('Error checking subscription in navigation:', error);
            // Allow navigation on error
        }
    }
    
    // Check if user needs to be logged in
    if ((section === 'favorites' || section === 'incorrect-quiz' || 
         section === 'spelling-favorites' || section === 'spelling-incorrect' || 
         section === 'student-dashboard' || section === 'parent-dashboard') && !currentUser) {
        alert('Please sign in to access this feature');
        showAuthModal();
        return;
    }
    
    // ‚úÖ PREVENT PARENTS FROM ACCESSING STUDENT FEATURES
    if (currentUser && section !== 'parent-dashboard' && section !== 'home' && section !== 'about' && section !== 'coaches' && section !== 'students') {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'parent') {
                alert('‚ö†Ô∏è Parents can only access:\n‚Ä¢ Parent Dashboard\n‚Ä¢ Home\n‚Ä¢ About\n‚Ä¢ Coaches\n‚Ä¢ Students\n\nPlease use the Parent Dashboard to manage your child\'s account.');
                navigateTo('parent-dashboard');
                return;
            }
        } catch (error) {
            console.error('Error checking user type:', error);
        }
    }
    
    // ‚úÖ Track current section BEFORE changing
    const currentSection = document.querySelector('.content-section.active')?.id.replace('-section', '');
    
    // ‚úÖ RESET QUIZ STATE WHEN LEAVING QUIZ SECTION
    if (currentSection === 'quiz' && section !== 'quiz') {
        currentQuiz = null;
        currentQuestionIndex = 0;
        quizScore = 0;
        selectedGameLevel = '';
    }
    
    document.querySelectorAll('.content-section').forEach(sec => {
        sec.classList.remove('active');
    });
    
    const sectionId = section + '-section';
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    if (section === 'word-database') {
        // Always show level selection first
        document.getElementById('level-selection').style.display = 'block';
        document.getElementById('word-database-display').style.display = 'none';
    }
    
    // ‚úÖ Reset Quiz section ONLY if coming from OUTSIDE
    if (section === 'quiz' && currentSection !== 'quiz') {
        document.getElementById('quiz-level-selection').style.display = 'block';
        document.getElementById('practice-quiz-container').innerHTML = '';
        selectedGameLevel = '';
    }
    
    // ‚úÖ Reset Spelling section ONLY if coming from OUTSIDE
    if (section === 'spelling' && currentSection !== 'spelling') {
        document.getElementById('spelling-level-selection').style.display = 'block';
        document.getElementById('spelling-game').style.display = 'none';
        document.getElementById('spelling-results').style.display = 'none';
        selectedGameLevel = '';
    }
    
    if (section === 'favorites' && currentUser) {
        displayFavorites();
    }
    
    if (section === 'incorrect-quiz' && currentUser) {
        displayIncorrect();
    }
    
    if (section === 'spelling-favorites' && currentUser) {
        displaySpellingFavorites();
    }
    
    if (section === 'spelling-incorrect' && currentUser) {
        displaySpellingIncorrect();
    }
    
    // Load coaches section
    if (section === 'coaches') {
        await loadAndDisplayCoaches();
    }
    
    // Load students section
    if (section === 'students') {
        await loadAndDisplayStudents();
    }
    
    // ‚úÖ Load student dashboard when navigating to it
    if (section === 'student-dashboard' && currentUser) {
        await loadUserDashboard();
    }
    
    // ‚úÖ Load parent dashboard when navigating to it
    if (section === 'parent-dashboard' && currentUser) {
        await loadParentDashboard();
    }
    
    // ‚úÖ LOAD ADMIN PANEL WHEN NAVIGATING TO IT
    if (section === 'admin' && currentUser) {
        console.log('üéØ Navigating to admin panel. isAdmin:', isAdmin);
        if (!isAdmin) {
            alert('‚ùå Admin access required. Please sign in with an admin account.');
            navigateTo('home');
            return;
        }
        await loadAdminPanel();
    }
    
    if (!skipSidebarClose) {
        toggleSidebar(true);
    }

    if (section === 'tournaments') {
    await loadTournamentList();
}
   // Load class section
    if (section === 'class' && currentUser) {
        await loadMyClass();
} 
}
    



 
    // ===== COACHES DISPLAY FUNCTIONS =====
async function loadAndDisplayCoaches() {
    const container = document.getElementById('coaches-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading coaches...</div>';
        
        console.log('üîç Fetching coaches from Firestore...');
        
        // Fetch all coaches from Firestore
        const coachesSnapshot = await db.collection('users')
            .where('userType', '==', 'coach')
            .get();
        
        console.log('üìä Found coaches:', coachesSnapshot.size);
        
        if (coachesSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üë®‚Äçüè´</div>
                    <h3>No coaches registered yet</h3>
                    <p>Be the first to join as a coach!</p>
                </div>
            `;
            return;
        }
        
        const coaches = [];
        coachesSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Coach:', doc.id, data.name, data.photoURL);
            coaches.push({ id: doc.id, ...data });
        });
        
        // Sort coaches (newest first)
        coaches.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate stats
        const totalCoaches = coaches.length;
        const verifiedCoaches = coaches.filter(c => c.idVerified).length;
        const pendingCoaches = totalCoaches - verifiedCoaches;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Cards -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalCoaches}</div>
                    <div class="stat-label">Total Coaches</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${verifiedCoaches}</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="coach-stat-card">
                    <div class="stat-number">${pendingCoaches}</div>
                    <div class="stat-label">‚è≥ Pending</div>
                </div>
            </div>
            
            <!-- Coaches Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üë®‚Äçüè´ Coach</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coaches.map(coach => {
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (coach.photoURL) {
                                avatarStyle = `style="background-image: url('${coach.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (coach.name || 'C').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showCoachDetailById('${coach.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${coach.name || 'Unknown Coach'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        ${coach.idVerified ? 
                                            '<span class="verified-badge">Verified</span>' : 
                                            '<span class="unverified-badge">‚è≥ Pending</span>'
                                        }
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e3f2fd; border-radius: 10px; border-left: 4px solid #0d3b66;">
                <h3 style="color: #0d3b66; margin-bottom: 10px;">üõ°Ô∏è Safety & Verification</h3>
                <p style="color: #666; line-height: 1.6;">
                    All coaches on WordBiz Coaching Academy undergo ID verification for student safety. 
                    Click on any coach to view their full profile and verification details.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading coaches:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading coaches. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayCoaches()">üîÑ Retry</button>
            </div>
        `;
    }
}

// Load and show coach profile modal
async function showCoachDetailById(coachId) {
    try {
        console.log('üìã Loading coach details for:', coachId);
        const coachDoc = await db.collection('users').doc(coachId).get();
        
        if (coachDoc.exists) {
            const coach = { id: coachDoc.id, ...coachDoc.data() };
            console.log('Coach data loaded:', coach);
            showCoachDetail(coach);
        } else {
            console.error('‚ùå Coach not found');
            alert('Coach profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading coach details:', error);
        alert('Unable to load coach details: ' + error.message);
    }
}

// Display coach detail modal
async function showCoachDetail(coach) {
    console.log('Displaying coach modal:', coach.name);
    const modal = document.getElementById('coachDetailModal');
    
    if (!modal) {
        console.error('Coach modal not found!');
        return;
    }
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-coach-avatar');
    if (avatar) {
        if (coach.photoURL) {
            console.log('üñºÔ∏è Setting photo URL:', coach.photoURL);
            avatar.style.backgroundImage = `url('${coach.photoURL}')`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
            avatar.textContent = '';
        } else {
            console.log('üî§ No photo URL, using initial');
            avatar.style.backgroundImage = 'none';
            avatar.textContent = (coach.name || 'C').charAt(0).toUpperCase();
        }
    }
    
    // Update name
    const nameEl = document.getElementById('modal-coach-name');
    if (nameEl) nameEl.textContent = coach.name || 'Unknown Coach';
    
    // Update status badge
    const statusBadge = document.getElementById('modal-coach-status');
    if (statusBadge) {
        if (coach.idVerified) {
            statusBadge.className = 'status-badge verified';
            statusBadge.textContent = '‚úÖ Verified';
        } else {
            statusBadge.className = 'status-badge pending';
            statusBadge.textContent = '‚è≥ Pending Verification';
        }
    }
    
    // Update email
    const emailEl = document.getElementById('modal-coach-email');
    if (emailEl) emailEl.textContent = coach.email || 'N/A';
    
    // Update organization
    const orgEl = document.getElementById('modal-coach-organization');
    if (orgEl) orgEl.textContent = coach.organization || 'Independent';
    
    // Update joined date
    const joinedEl = document.getElementById('modal-coach-joined');
    if (joinedEl) {
        if (coach.createdAt) {
            const joinDate = coach.createdAt.toDate();
            joinedEl.textContent = joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            joinedEl.textContent = 'Recently';
        }
    }
    
    // Show/hide age if available
    const ageRow = document.getElementById('modal-coach-age-row');
    if (ageRow) {
        if (coach.verifiedAge) {
            ageRow.style.display = 'flex';
            const ageEl = document.getElementById('modal-coach-age');
            if (ageEl) ageEl.textContent = coach.verifiedAge + ' years old';
        } else {
            ageRow.style.display = 'none';
        }
    }
    
    // ‚úÖ ADD BOOK COACH BUTTON FOR STUDENTS - Use correct class name
    const coachDetailBody = modal.querySelector('.coach-detail-content');
    
    if (!coachDetailBody) {
        console.error('Coach detail content not found!');
        modal.classList.add('active');
        return;
    }
    
    // Remove any existing book button first
    const existingBookBtn = coachDetailBody.querySelector('.book-coach-container');
    if (existingBookBtn) {
        existingBookBtn.remove();
    }
    
    if (currentUser) {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'student') {
                const bookBtnContainer = document.createElement('div');
                bookBtnContainer.className = 'book-coach-container';
                bookBtnContainer.style.cssText = 'margin-top: 20px; text-align: center; padding: 20px;';
                
                bookBtnContainer.innerHTML = `
                    <button class="practice-btn" onclick="bookCoach('${coach.id}', '${coach.name.replace(/'/g, "\\'")}')" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 1.1rem; padding: 15px 30px;">
                        üìö Book This Coach
                    </button>
                `;
                
                coachDetailBody.appendChild(bookBtnContainer);
            }
        } catch (error) {
            console.error('Error checking user type for booking:', error);
        }
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('Modal displayed');
}

// Close coach detail modal
function closeCoachDetailModal() {
    document.getElementById('coachDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('coachDetailModal');
    if (event.target === modal) {
        closeCoachDetailModal();
    }
});

     
// ===== STUDENTS DISPLAY FUNCTIONS =====
async function loadAndDisplayStudents() {
    const container = document.getElementById('students-container');
    
    try {
        container.innerHTML = '<div class="loading">üìö Loading students...</div>';
        
        console.log('üîç Fetching students from Firestore...');
        
        // Fetch all students from Firestore
        const studentsSnapshot = await db.collection('users')
            .where('userType', '==', 'student')
            .get();
        
        console.log('üìä Found students:', studentsSnapshot.size);
        
        if (studentsSnapshot.empty) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üéì</div>
                    <h3>No students registered yet</h3>
                    <p>Be the first to join as a student!</p>
                </div>
            `;
            return;
        }
        
        const students = [];
        studentsSnapshot.forEach(doc => {
            const data = doc.data();
            console.log('üë§ Student:', doc.id, data.name, data.photoURL);
            students.push({ id: doc.id, ...data });
        });
        
        // Sort students (newest first)
        students.sort((a, b) => {
            if (!a.createdAt) return 1;
            if (!b.createdAt) return -1;
            return b.createdAt.toDate() - a.createdAt.toDate();
        });
        
        // Calculate total students
        const totalStudents = students.length;
        
        // Display stats and table
        container.innerHTML = `
            <!-- Stats Card -->
            <div class="coach-stats">
                <div class="coach-stat-card">
                    <div class="stat-number">${totalStudents}</div>
                    <div class="stat-label">Total Students</div>
                </div>
            </div>
            
            <!-- Students Table -->
            <div class="coaches-table">
                <table>
                    <thead>
                        <tr>
                            <th>üéì Student</th>
                            <th>üÜî Student ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => {
                            // Generate Student ID (WB-2025-XXXX)
                            const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
                            
                            // Determine avatar display
                            let avatarStyle = '';
                            let avatarText = '';
                            
                            if (student.photoURL) {
                                avatarStyle = `style="background-image: url('${student.photoURL}'); background-size: cover; background-position: center;"`;
                                avatarText = '';
                            } else {
                                const initial = (student.name || 'S').charAt(0).toUpperCase();
                                avatarStyle = '';
                                avatarText = initial;
                            }
                            
                            return `
                                <tr onclick="showStudentDetailById('${student.id}')" style="cursor: pointer;">
                                    <td>
                                        <div class="coach-profile-cell">
                                            <div class="coach-avatar" ${avatarStyle}>${avatarText}</div>
                                            <div class="coach-name">${student.name || 'Student'}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <span style="font-family: monospace; background: #e3f2fd; padding: 5px 10px; border-radius: 5px; font-weight: bold; color: #0d3b66;">
                                            ${studentId}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px;">
                <h3 style="color: white; margin-bottom: 10px;">üåü Growing Community</h3>
                <p style="color: rgba(255,255,255,0.95); line-height: 1.6;">
                    Our students are learning from coaches around the world, building vocabulary skills 
                    through interactive quizzes, spelling challenges, and personalized practice sessions.
                    Click on any student to view their full profile.
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('‚ùå Error loading students:', error);
        container.innerHTML = `
            <div class="feedback error">
                ‚ùå Error loading students. Please try refreshing the page.
                <br><br>
                <strong>Error details:</strong> ${error.message}
                <br><br>
                <button class="practice-btn" onclick="loadAndDisplayStudents()">üîÑ Retry</button>
            </div>
        `;
    }
}
        
// Load and show student profile modal
async function showStudentDetailById(studentId) {
    try {
        console.log('üìã Loading student details for:', studentId);
        const studentDoc = await db.collection('users').doc(studentId).get();
        
        if (studentDoc.exists) {
            const student = { id: studentDoc.id, ...studentDoc.data() };
            console.log('Student data loaded:', student);
            showStudentDetail(student);
        } else {
            console.error('‚ùå Student not found');
            alert('Student profile not found');
        }
    } catch (error) {
        console.error('‚ùå Error loading student details:', error);
        alert('Unable to load student details: ' + error.message);
    }
}

// Display student detail modal
async function showStudentDetail(student) {
    console.log('Displaying student modal:', student.name);
    const modal = document.getElementById('studentDetailModal');
    
    if (!modal) {
        console.error('Student modal not found!');
        return;
    }
    
    // Generate Student ID
    const studentId = `WB-2025-${student.id.slice(-4).toUpperCase()}`;
    
    // Update avatar with photo
    const avatar = document.getElementById('modal-student-avatar');
    if (avatar) {
        if (student.photoURL) {
            console.log('üñºÔ∏è Setting photo URL:', student.photoURL);
            avatar.style.backgroundImage = `url('${student.photoURL}')`;
            avatar.style.backgroundSize = 'cover';
            avatar.style.backgroundPosition = 'center';
            avatar.textContent = '';
        } else {
            console.log('üî§ No photo URL, using initial');
            avatar.style.backgroundImage = 'none';
            avatar.textContent = (student.name || 'S').charAt(0).toUpperCase();
        }
    }
    
    // Update name
    const nameEl = document.getElementById('modal-student-name');
    if (nameEl) nameEl.textContent = student.name || 'Student';
    
    // Update Student ID (both places)
    const idEl = document.getElementById('modal-student-id');
    if (idEl) idEl.textContent = studentId;
    
    const idDisplayEl = document.getElementById('modal-student-id-display');
    if (idDisplayEl) idDisplayEl.textContent = studentId;
    
    // Update email
    const emailEl = document.getElementById('modal-student-email');
    if (emailEl) emailEl.textContent = student.email || 'N/A';
    
    // Update age
    const ageRow = document.getElementById('modal-student-age-row');
    if (ageRow) {
        if (student.age) {
            ageRow.style.display = 'flex';
            const ageEl = document.getElementById('modal-student-age');
            if (ageEl) ageEl.textContent = student.age + ' years old';
        } else {
            ageRow.style.display = 'none';
        }
    }
    
    // Update country
    const countryEl = document.getElementById('modal-student-country');
    if (countryEl) countryEl.textContent = student.country || 'N/A';
    
    // Update joined date
    const joinedEl = document.getElementById('modal-student-joined');
    if (joinedEl) {
        if (student.createdAt) {
            const joinDate = student.createdAt.toDate();
            joinedEl.textContent = joinDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        } else {
            joinedEl.textContent = 'Recently';
        }
    }
    
    // ‚úÖ ADD RECRUIT BUTTON FOR COACHES - Use correct class name
    const studentDetailBody = modal.querySelector('.coach-detail-content');
    
    if (!studentDetailBody) {
        console.error('Student detail content not found!');
        modal.classList.add('active');
        return;
    }
    
    // Remove any existing recruit button first
    const existingRecruitBtn = studentDetailBody.querySelector('.recruit-student-container');
    if (existingRecruitBtn) {
        existingRecruitBtn.remove();
    }
    
    if (currentUser) {
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            
            if (userData && userData.userType === 'coach') {
                const recruitBtnContainer = document.createElement('div');
                recruitBtnContainer.className = 'recruit-student-container';
                recruitBtnContainer.style.cssText = 'margin-top: 20px; text-align: center; padding: 20px;';
                
                recruitBtnContainer.innerHTML = `
                    <button class="practice-btn" onclick="recruitStudent('${student.id}', '${student.name.replace(/'/g, "\\'")}')" 
                            style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); font-size: 1.1rem; padding: 15px 30px;">
                        ‚ûï Recruit to My Class
                    </button>
                `;
                
                studentDetailBody.appendChild(recruitBtnContainer);
            }
        } catch (error) {
            console.error('Error checking user type for recruiting:', error);
        }
    }
    
    // Show modal
    modal.classList.add('active');
    console.log('Modal displayed');
}
        
// Close student detail modal
function closeStudentDetailModal() {
    document.getElementById('studentDetailModal').classList.remove('active');
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('studentDetailModal');
    if (event.target === modal) {
        closeStudentDetailModal();
    }
});


  // ===== CLASS LOADING FUNCTION =====
async function loadMyClass() {
    if (!currentUser) {
        alert('Please sign in to access your class');
        showAuthModal();
        return;
    }

    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();

        if (!userData || (!userData.userType === 'student' && userData.userType !== 'coach')) {
            alert('Only students and coaches can access classes');
            navigateTo('home');
            return;
        }

        // Show appropriate view based on user type
        const studentView = document.getElementById('student-class-view');
        const coachView = document.getElementById('coach-class-view');
        
        if (userData.userType === 'student') {
            studentView.style.display = 'block';
            coachView.style.display = 'none';
            await loadStudentClassView();
        } else if (userData.userType === 'coach') {
            studentView.style.display = 'none';
            coachView.style.display = 'block';
            await loadCoachClassView();
        }

    } catch (error) {
        console.error('Error loading class:', error);
        alert('Failed to load class information');
    }
}

// ===== STUDENT CLASS VIEW =====
async function loadStudentClassView() {
    const container = document.getElementById('student-class-info');
    
    try {
        container.innerHTML = '<div class="loading">Loading your class...</div>';
        
        // Check if student has a class
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (!userData.classId) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üìö</div>
                    <h3>You're not in a class yet</h3>
                    <p style="color: #666; margin: 20px 0;">
                        Browse available coaches and book one to join their class!
                    </p>
                    <button class="practice-btn" onclick="navigateTo('coaches')">
                        Browse Coaches
                    </button>
                </div>
            `;
            return;
        }
        
        // Load class info
        const classDoc = await db.collection('classes').doc(userData.classId).get();
        
        if (!classDoc.exists) {
            container.innerHTML = `
                <div class="feedback error">
                    Class not found. Please contact your coach.
                </div>
            `;
            return;
        }
        
        const classData = classDoc.data();
        
        // Load coach info
        const coachDoc = await db.collection('users').doc(classData.coachId).get();
        const coachData = coachDoc.data();
        
        // Load announcements
        const announcementsSnapshot = await db.collection('classes')
            .doc(userData.classId)
            .collection('announcements')
            .orderBy('createdAt', 'desc')
            .limit(5)
            .get();
        
        const announcements = [];
        announcementsSnapshot.forEach(doc => {
            announcements.push({ id: doc.id, ...doc.data() });
        });
        
        // ‚úÖ FIXED: Only show live session if it's truly active AND has a sessionId
        const liveSessionHtml = (classData.liveSessionActive === true && classData.liveSessionId) ? `
            <div id="live-session-join-container" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 25px; border-radius: 15px; text-align: center; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);">
                <h3 style="color: white; margin-bottom: 15px; font-size: 1.5rem;">üé• Live Session Active!</h3>
                <p style="color: rgba(255,255,255,0.95); margin-bottom: 20px;">Your coach has started a live session. Join now to participate!</p>
                <button id="join-session-btn" class="practice-btn" onclick="joinLiveSession()" style="background: white; color: #28a745; font-size: 1.2rem; font-weight: bold; padding: 15px 40px;">
                    üé§ Join Live Session
                </button>
            </div>
            
            <!-- Live Session Active UI (Hidden until joined) -->
            <div id="student-live-session-active" style="display: none; background: white; padding: 25px; border-radius: 15px; border: 3px solid #28a745; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: #28a745; margin: 0;">üé• In Live Session</h3>
                    <div style="display: flex; gap: 10px;">
                        <button id="student-toggle-mic-btn" onclick="toggleMicrophone()" class="practice-btn" style="background: #28a745; padding: 10px 20px;">
                            üé§ Mute
                        </button>
                        <button onclick="endLiveSession()" class="practice-btn" style="background: #dc3545; padding: 10px 20px;">
                            ‚ùå Leave Session
                        </button>
                    </div>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #0d3b66; margin-bottom: 15px;">üë• Participants</h4>
                    <div id="student-session-participants-list"></div>
                </div>
                
                <div id="remote-audio-container" style="display: none;"></div>
            </div>
        ` : '';
        
        // Display class info
        container.innerHTML = `
            ${liveSessionHtml}
            
            <div class="dashboard-section">
                <h3 style="color: #0d3b66; margin-bottom: 20px;">üë®‚Äçüè´ Your Coach</h3>
                <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid #0d3b66; margin-bottom: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <div class="coach-avatar" style="width: 60px; height: 60px; ${coachData.photoURL ? `background-image: url('${coachData.photoURL}'); background-size: cover;` : ''}">
                            ${!coachData.photoURL ? (coachData.name || 'C').charAt(0).toUpperCase() : ''}
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #0d3b66;">${coachData.name || 'Coach'}</h3>
                            <p style="margin: 5px 0 0 0; color: #666;">${coachData.email}</p>
                        </div>
                    </div>
                </div>
                
                <h3 style="color: #0d3b66; margin-bottom: 20px;">üì¢ Recent Announcements</h3>
                ${announcements.length > 0 ? `
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                        ${announcements.map(ann => {
                            let nextClassHtml = '';
                            if (ann.nextClassDate) {
                                const classDate = new Date(ann.nextClassDate);
                                const options = { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric', 
                                    hour: 'numeric', 
                                    minute: '2-digit',
                                    hour12: true 
                                };
                                const formattedDate = classDate.toLocaleString('en-US', options).toUpperCase();
                                nextClassHtml = `
                                    <p style="margin: 10px 0 0 0; color: #28a745; font-weight: bold;">
                                        üé• Next Class: ${formattedDate}
                                    </p>
                                `;
                            }
                            
                            return `
                                <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #0d3b66;">
                                    <h4 style="margin: 0 0 10px 0; color: #0d3b66;">${ann.title}</h4>
                                    <p style="margin: 0; color: #666; white-space: pre-wrap;">${ann.message}</p>
                                    ${nextClassHtml}
                                    <p style="margin: 10px 0 0 0; color: #999; font-size: 0.9rem;">
                                        ${ann.createdAt ? ann.createdAt.toDate().toLocaleString() : 'Recently'}
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                        <p style="color: #666;">No announcements yet</p>
                    </div>
                `}
            </div>
        `;
        
        // Set up live session listener for real-time updates
        liveSessionId = userData.classId;
        
        // ‚úÖ FIXED: Listen for session status changes with proper validation
        db.collection('classes').doc(userData.classId).onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                
                // ‚úÖ Check if session is TRULY active (both flags must be true)
                const sessionIsActive = data.liveSessionActive === true && data.liveSessionId != null;
                
                const joinContainer = document.getElementById('live-session-join-container');
                const activeSessionUI = document.getElementById('student-live-session-active');
                
                // If session just started and we're not in it yet
                if (sessionIsActive && !liveSessionActive) {
                    // Show join button if it doesn't exist
                    if (!joinContainer) {
                        // Reload the view to show the join button
                        loadStudentClassView();
                    }
                }
                
                // If session ended while we were in it or viewing
                if (!sessionIsActive && (liveSessionActive || joinContainer)) {
                    if (liveSessionActive) {
                        alert('üì¢ The live session has ended');
                        endLiveSession();
                    }
                    // Reload to remove session UI
                    loadStudentClassView();
                }
            }
        });
        
    } catch (error) {
        console.error('Error loading student class view:', error);
        container.innerHTML = `
            <div class="feedback error">
                Failed to load class information: ${error.message}
            </div>
        `;
    }
}
        
// ===== COACH CLASS VIEW =====
async function loadCoachClassView() {
    try {
        // Get or create coach's class
        const classQuery = await db.collection('classes')
            .where('coachId', '==', currentUser.uid)
            .limit(1)
            .get();
        
        if (classQuery.empty) {
           // Create class for coach
const classRef = await db.collection('classes').add({
    coachId: currentUser.uid,
    coachName: currentUser.displayName || 'Coach',
    coachEmail: currentUser.email,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    studentCount: 0,
    liveSessionActive: false,
    liveSessionId: null,
    sessionCount: 0  // ‚úÖ ADD THIS LINE
});
            
            // Update user with classId
            await db.collection('users').doc(currentUser.uid).update({
                classId: classRef.id
            });
            
            myClass = {
                id: classRef.id,
                coachId: currentUser.uid,
                coachName: currentUser.displayName || 'Coach',
                coachEmail: currentUser.email,
                studentCount: 0,
                liveSessionActive: false,
                liveSessionId: null
            };
        } else {
            const classDoc = classQuery.docs[0];
            myClass = { id: classDoc.id, ...classDoc.data() };
            
            // Update user with classId if not set
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (!userDoc.data().classId) {
                await db.collection('users').doc(currentUser.uid).update({
                    classId: myClass.id
                });
            }
        }
        
        isCoach = true; // Set coach flag
        
        // Load students
        await loadClassStudents();
        
        // Load announcements
        await loadClassAnnouncements();
        
        // Update stats
        updateCoachClassStats();
        
        // Check if there's an active session and restore it
        if (myClass.liveSessionActive) {
            // Show that session is active but don't auto-join
            console.log('‚ÑπÔ∏è Active session detected');
        }
        
    } catch (error) {
        console.error('Error loading coach class view:', error);
        alert('Failed to load class management: ' + error.message);
    }
}

async function loadClassStudents() {
    try {
        const studentsSnapshot = await db.collection('users')
            .where('classId', '==', myClass.id)
            .where('userType', '==', 'student') // ‚úÖ Only get students, not coaches
            .get();
        
        classStudents = [];
        studentsSnapshot.forEach(doc => {
            classStudents.push({ id: doc.id, ...doc.data() });
        });
        
        displayClassStudents();
    } catch (error) {
        console.error('Error loading class students:', error);
    }
}

async function loadClassAnnouncements() {
    try {
        const announcementsSnapshot = await db.collection('classes')
            .doc(myClass.id)
            .collection('announcements')
            .orderBy('createdAt', 'desc')
            .get();
        
        classAnnouncements = [];
        announcementsSnapshot.forEach(doc => {
            classAnnouncements.push({ id: doc.id, ...doc.data() });
        });
        
        displayClassAnnouncements();
    } catch (error) {
        console.error('Error loading announcements:', error);
    }
}

function displayClassStudents() {
    const container = document.getElementById('coach-students-list');
    
    if (classStudents.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                <p style="color: #666;">No students in your class yet</p>
                <button class="practice-btn" onclick="navigateTo('students')" style="margin-top: 15px;">
                    Browse Students
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div style="display: grid; gap: 15px;">
            ${classStudents.map(student => `
                <div style="background: white; padding: 15px; border-radius: 10px; border: 2px solid #0d3b66; display: flex; align-items: center; gap: 15px;">
                    <div class="coach-avatar" style="width: 50px; height: 50px; ${student.photoURL ? `background-image: url('${student.photoURL}'); background-size: cover;` : ''}">
                        ${!student.photoURL ? (student.name || 'S').charAt(0).toUpperCase() : ''}
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: #0d3b66;">${student.name || 'Student'}</h4>
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 0.9rem;">${student.email}</p>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function displayClassAnnouncements() {
    const container = document.getElementById('coach-announcements-list');
    
    if (classAnnouncements.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                <p style="color: #666;">No announcements yet</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div style="display: grid; gap: 15px;">
            ${classAnnouncements.map(ann => {
                let nextClassHtml = '';
                if (ann.nextClassDate) {
                    const classDate = new Date(ann.nextClassDate);
                    const options = { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric', 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    };
                    const formattedDate = classDate.toLocaleString('en-US', options).toUpperCase();
                    nextClassHtml = `
                        <p style="margin: 10px 0 0 0; color: #28a745; font-weight: bold;">
                            üé• Next Class: ${formattedDate}
                        </p>
                    `;
                }
                
                return `
                    <div style="background: white; padding: 20px; border-radius: 10px; border-left: 4px solid #0d3b66;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #0d3b66;">${ann.title}</h4>
                            <button onclick="deleteAnnouncement('${ann.id}')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                                üóëÔ∏è
                            </button>
                        </div>
                        <p style="margin: 10px 0; color: #666; white-space: pre-wrap;">${ann.message}</p>
                        ${nextClassHtml}
                        <p style="margin: 10px 0 0 0; color: #999; font-size: 0.9rem;">
                            ${ann.createdAt ? ann.createdAt.toDate().toLocaleString() : 'Recently'}
                        </p>
                    </div>
                `;
            }).join('')}
        </div>
    `;
}

function updateCoachClassStats() {
    document.getElementById('class-student-count').textContent = classStudents.length;
    document.getElementById('class-announcement-count').textContent = classAnnouncements.length;
    document.getElementById('class-session-count').textContent = myClass ? (myClass.sessionCount || 0) : '0';
}
function showAddAnnouncementModal() {
    document.getElementById('announcementModal').classList.add('active');
}

function closeAnnouncementModal() {
    document.getElementById('announcementModal').classList.remove('active');
    document.getElementById('announcement-form').reset();
    document.getElementById('announcement-error').style.display = 'none';
}

async function handleAddAnnouncement(event) {
    event.preventDefault();
    
    const title = document.getElementById('announcement-title').value.trim();
    const message = document.getElementById('announcement-message').value.trim();
    const classDate = document.getElementById('announcement-class-date').value;
    const errorDiv = document.getElementById('announcement-error');
    
    if (!title || !message) {
        errorDiv.textContent = 'Please fill in all required fields';
        errorDiv.style.display = 'block';
        return;
    }
    
    try {
        await db.collection('classes')
            .doc(myClass.id)
            .collection('announcements')
            .add({
                title,
                message,
                nextClassDate: classDate || null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        
        closeAnnouncementModal();
        await loadClassAnnouncements();
        updateCoachClassStats();
        
        alert('‚úÖ Announcement posted successfully!');
    } catch (error) {
        console.error('Error posting announcement:', error);
        errorDiv.textContent = 'Failed to post announcement: ' + error.message;
        errorDiv.style.display = 'block';
    }
}

async function deleteAnnouncement(announcementId) {
    if (!confirm('Are you sure you want to delete this announcement?')) {
        return;
    }
    
    try {
        await db.collection('classes')
            .doc(myClass.id)
            .collection('announcements')
            .doc(announcementId)
            .delete();
        
        await loadClassAnnouncements();
        updateCoachClassStats();
        
        alert('‚úÖ Announcement deleted');
    } catch (error) {
        console.error('Error deleting announcement:', error);
        alert('Failed to delete announcement');
    }
}

// ICE servers for WebRTC connection
const iceServers = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// ===== START LIVE SESSION (COACH ONLY) =====
async function startLiveSession() {
    if (!currentUser || !myClass) {
        alert('Unable to start session');
        return;
    }
    
    try {
        // Get microphone permission
        localAudioStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            } 
        });
        
        console.log('‚úÖ Microphone access granted');
        
        // Create session in Firestore
        liveSessionId = myClass.id; // Use class ID as session ID
        
        // ‚úÖ FIXED: Increment session count
        const currentSessionCount = myClass.sessionCount || 0;
        
        // ‚úÖ FIXED: Set BOTH flags to true to indicate active session AND increment session count
        await db.collection('classes').doc(myClass.id).update({
            liveSessionActive: true,
            liveSessionId: liveSessionId,
            liveSessionStartedAt: firebase.firestore.FieldValue.serverTimestamp(),
            liveSessionHost: currentUser.uid,
            sessionCount: currentSessionCount + 1  // ‚úÖ INCREMENT SESSION COUNT
        });
        
        console.log('‚úÖ Session started in Firestore:', {
            liveSessionActive: true,
            liveSessionId: liveSessionId,
            sessionCount: currentSessionCount + 1
        });
        
        // Update local myClass object
        myClass.sessionCount = currentSessionCount + 1;
        
        // Add coach as first participant
        await db.collection('classes')
            .doc(myClass.id)
            .collection('sessionParticipants')
            .doc(currentUser.uid)
            .set({
                userId: currentUser.uid,
                name: currentUser.displayName || 'Coach',
                email: currentUser.email,
                photoURL: currentUser.photoURL || null,
                joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                micMuted: false
            });
        
        liveSessionActive = true;
        isCoach = true;
        
        // Show live session UI for COACH
        const startBtn = document.getElementById('start-session-btn');
        const liveSessionContainer = document.getElementById('coach-live-session-active');
        
        if (startBtn) startBtn.style.display = 'none';
        if (liveSessionContainer) liveSessionContainer.style.display = 'block';
        
        // ‚úÖ UPDATE SESSION COUNT IN UI
        updateCoachClassStats();
        
        // Listen for participants joining
        listenForSessionParticipants();
        
        alert('‚úÖ Live session started! Students can now join.');
        
    } catch (error) {
        console.error('Error starting live session:', error);
        
        if (error.name === 'NotAllowedError') {
            alert('‚ùå Microphone access denied. Please allow microphone access and try again.');
        } else if (error.name === 'NotFoundError') {
            alert('‚ùå No microphone found. Please connect a microphone and try again.');
        } else {
            alert('Failed to start session: ' + error.message);
        }
        
        // Cleanup on error
        if (localAudioStream) {
            localAudioStream.getTracks().forEach(track => track.stop());
            localAudioStream = null;
        }
        
        // ‚úÖ Cleanup Firestore if session creation failed
        try {
            await db.collection('classes').doc(myClass.id).update({
                liveSessionActive: false,
                liveSessionId: null
            });
        } catch (cleanupError) {
            console.error('Error cleaning up failed session:', cleanupError);
        }
    }
}
        
// ===== JOIN LIVE SESSION (STUDENT) =====
async function joinLiveSession() {
    if (!currentUser) {
        alert('Please sign in to join the session');
        return;
    }
    
    try {
        console.log('üé§ Requesting microphone access...');
        
        // Get microphone permission
        localAudioStream = await navigator.mediaDevices.getUserMedia({ 
            audio: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            } 
        });
        
        console.log('‚úÖ Microphone access granted');
        
        // Get user data
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (!userData.classId) {
            alert('You are not enrolled in a class');
            if (localAudioStream) {
                localAudioStream.getTracks().forEach(track => track.stop());
                localAudioStream = null;
            }
            return;
        }
        
        liveSessionId = userData.classId;
        
        // ‚úÖ FIXED: Check if session is actually active before joining
        const classDoc = await db.collection('classes').doc(userData.classId).get();
        const classData = classDoc.data();
        
        if (!classData.liveSessionActive || !classData.liveSessionId) {
            alert('‚ùå This session is no longer active');
            if (localAudioStream) {
                localAudioStream.getTracks().forEach(track => track.stop());
                localAudioStream = null;
            }
            return;
        }
        
        console.log('‚úÖ Session is active, joining...');
        
        // Add to session participants
        await db.collection('classes')
            .doc(userData.classId)
            .collection('sessionParticipants')
            .doc(currentUser.uid)
            .set({
                userId: currentUser.uid,
                name: userData.name || 'Student',
                email: userData.email,
                photoURL: userData.photoURL || null,
                joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                micMuted: false
            });
        
        console.log('‚úÖ Added to session participants');
        
        liveSessionActive = true;
        
        // ‚úÖ FIXED: Hide join button and show active session UI
        const joinContainer = document.getElementById('live-session-join-container');
        const activeSessionUI = document.getElementById('student-live-session-active');
        
        if (joinContainer) joinContainer.style.display = 'none';
        if (activeSessionUI) activeSessionUI.style.display = 'block';
        
        // Listen for participants
        listenForSessionParticipants();
        
        console.log('‚úÖ Joined live session successfully');
        
    } catch (error) {
        console.error('Error joining session:', error);
        
        let errorMessage = 'Failed to join session. ';
        
        if (error.name === 'NotAllowedError') {
            errorMessage += 'Microphone access was denied. Please allow microphone access in your browser settings and try again.';
        } else if (error.name === 'NotFoundError') {
            errorMessage += 'No microphone found. Please connect a microphone and try again.';
        } else if (error.message) {
            errorMessage += error.message;
        } else {
            errorMessage += 'Please check your microphone permissions and try again.';
        }
        
        alert(errorMessage);
        
        // Cleanup on error
        if (localAudioStream) {
            localAudioStream.getTracks().forEach(track => track.stop());
            localAudioStream = null;
        }
        
        liveSessionActive = false;
        
        // ‚úÖ Remove from participants if we added ourselves
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();
            if (userData.classId) {
                await db.collection('classes')
                    .doc(userData.classId)
                    .collection('sessionParticipants')
                    .doc(currentUser.uid)
                    .delete();
            }
        } catch (cleanupError) {
            console.error('Error cleaning up after failed join:', cleanupError);
        }
    }
}

// ===== LISTEN FOR SESSION PARTICIPANTS =====
function listenForSessionParticipants() {
    const classId = myClass ? myClass.id : liveSessionId;
    
    liveSessionListener = db.collection('classes')
        .doc(classId)
        .collection('sessionParticipants')
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added') {
                    const participant = change.doc.data();
                    
                    if (participant.userId !== currentUser.uid) {
                        // New participant joined - create peer connection
                        createPeerConnection(participant.userId, participant);
                    }
                    
                    sessionParticipants.set(participant.userId, participant);
                }
                
                if (change.type === 'removed') {
                    const participant = change.doc.data();
                    
                    // Participant left - close connection
                    closePeerConnection(participant.userId);
                    sessionParticipants.delete(participant.userId);
                }
                
                if (change.type === 'modified') {
                    const participant = change.doc.data();
                    sessionParticipants.set(participant.userId, participant);
                }
            });
            
            updateParticipantsList();
        });
    
    // Listen for WebRTC signaling
    listenForSignaling();
}

// ===== CREATE PEER CONNECTION =====
async function createPeerConnection(userId, participant, isInitiator = true) {
    try {
        console.log('üîó Creating peer connection with:', participant.name, 'isInitiator:', isInitiator);
        
        const peerConnection = new RTCPeerConnection(iceServers);
        
        // Add local audio stream to connection
        if (localAudioStream) {
            localAudioStream.getTracks().forEach(track => {
                console.log('üì§ Adding local audio track to peer connection');
                peerConnection.addTrack(track, localAudioStream);
            });
        } else {
            console.warn('‚ö†Ô∏è No local audio stream available');
        }
        
        // Handle incoming audio stream
        peerConnection.ontrack = (event) => {
            console.log('üì• Received audio stream from:', participant.name);
            
            const remoteStream = event.streams[0];
            remoteStreams.set(userId, remoteStream);
            
            // Create audio element to play remote audio
            let audioElement = document.getElementById(`audio_${userId}`);
            if (!audioElement) {
                audioElement = document.createElement('audio');
                audioElement.id = `audio_${userId}`;
                audioElement.autoplay = true;
                audioElement.volume = 1.0;
                
                const coachContainer = document.getElementById('coach-remote-audio-container');
                const studentContainer = document.getElementById('remote-audio-container');
                
                if (coachContainer) {
                    coachContainer.appendChild(audioElement);
                } else if (studentContainer) {
                    studentContainer.appendChild(audioElement);
                } else {
                    document.body.appendChild(audioElement);
                }
                
                console.log('‚úÖ Audio element created and added for:', participant.name);
            }
            
            audioElement.srcObject = remoteStream;
            audioElement.play().catch(err => {
                console.error('‚ùå Error playing audio:', err);
            });
        };
        
        // Handle ICE candidates
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                console.log('üßä Sending ICE candidate to:', participant.name);
                sendIceCandidate(userId, event.candidate);
            }
        };
        
        peerConnection.onconnectionstatechange = () => {
            console.log(`Connection state with ${participant.name}:`, peerConnection.connectionState);
            
            if (peerConnection.connectionState === 'connected') {
                console.log('‚úÖ Successfully connected to:', participant.name);
            } else if (peerConnection.connectionState === 'failed') {
                console.error('‚ùå Connection failed with:', participant.name);
                // Attempt to restart ICE
                peerConnection.restartIce();
            }
        };
        
        peerConnections.set(userId, peerConnection);
        
        // ‚úÖ ONLY create offer if we're the initiator
        if (isInitiator) {
            const offer = await peerConnection.createOffer({
                offerToReceiveAudio: true
            });
            await peerConnection.setLocalDescription(offer);
            await sendOffer(userId, offer);
            console.log('‚úÖ Offer sent to:', participant.name);
        }
        
        return peerConnection;
        
    } catch (error) {
        console.error('Error creating peer connection:', error);
        throw error;
    }
}

// ===== HANDLE INCOMING OFFER =====
async function handleIncomingOffer(userId, offer) {
    try {
        console.log('üì® Received offer from:', userId);
        
        // Get or create peer connection (as NON-initiator)
        let peerConnection = peerConnections.get(userId);
        if (!peerConnection) {
            // Get participant info
            const participantData = await getParticipantData(userId);
            peerConnection = await createPeerConnection(userId, participantData, false);
        }
        
        // Check current signaling state
        if (peerConnection.signalingState === 'have-remote-offer') {
            console.warn('‚ö†Ô∏è Already have remote offer, ignoring duplicate');
            return;
        }
        
        // Set remote description
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        
        // Create and send answer
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        await sendAnswer(userId, answer);
        console.log('‚úÖ Answer sent to:', userId);
        
    } catch (error) {
        console.error('Error handling incoming offer:', error);
    }
}

// ===== HANDLE INCOMING ANSWER =====
async function handleIncomingAnswer(userId, answer) {
    try {
        console.log('üì® Received answer from:', userId);
        
        const peerConnection = peerConnections.get(userId);
        if (!peerConnection) {
            console.error('‚ùå No peer connection found for:', userId);
            return;
        }
        
        // ‚úÖ CHECK SIGNALING STATE
        const currentState = peerConnection.signalingState;
        
        // Check if we're in the correct state
        if (currentState === 'have-local-offer') {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            console.log('‚úÖ Answer processed from:', userId);
        } else if (currentState === 'stable') {
            console.warn('‚ö†Ô∏è Already in stable state, ignoring duplicate answer from:', userId);
        } else {
            console.warn('‚ö†Ô∏è Not in correct state to receive answer, current state:', currentState);
        }
        
    } catch (error) {
        console.error('Error handling incoming answer:', error);
        // Don't re-throw to prevent breaking the flow
    }
}

// ===== WEBRTC SIGNALING =====
function listenForSignaling() {
    const classId = myClass ? myClass.id : liveSessionId;
    
    // Listen for offers
    db.collection('classes')
        .doc(classId)
        .collection('offers')
        .where('to', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                if (change.type === 'added') {
                    const data = change.doc.data();
                    await handleOffer(data.from, data.offer);
                    
                    // Delete processed offer
                    change.doc.ref.delete();
                }
            });
        });
    
    // Listen for answers
    db.collection('classes')
        .doc(classId)
        .collection('answers')
        .where('to', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                if (change.type === 'added') {
                    const data = change.doc.data();
                    await handleAnswer(data.from, data.answer);
                    
                    // Delete processed answer
                    change.doc.ref.delete();
                }
            });
        });
    
    // Listen for ICE candidates
    db.collection('classes')
        .doc(classId)
        .collection('iceCandidates')
        .where('to', '==', currentUser.uid)
        .onSnapshot(snapshot => {
            snapshot.docChanges().forEach(async change => {
                if (change.type === 'added') {
                    const data = change.doc.data();
                    await handleIceCandidate(data.from, data.candidate);
                    
                    // Delete processed candidate
                    change.doc.ref.delete();
                }
            });
        });
}

async function sendOffer(toUserId, offer) {
    const classId = myClass ? myClass.id : liveSessionId;
    
    await db.collection('classes')
        .doc(classId)
        .collection('offers')
        .add({
            from: currentUser.uid,
            to: toUserId,
            offer: {
                type: offer.type,
                sdp: offer.sdp
            },
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
}

async function handleOffer(fromUserId, offer) {
    try {
        console.log('üì® Handling offer from user:', fromUserId);
        
        let peerConnection = peerConnections.get(fromUserId);
        
        if (!peerConnection) {
            console.log('üÜï Creating new peer connection for incoming offer');
            
            // Get participant info
            const classId = myClass ? myClass.id : liveSessionId;
            const participantDoc = await db.collection('classes')
                .doc(classId)
                .collection('sessionParticipants')
                .doc(fromUserId)
                .get();
            
            if (!participantDoc.exists) {
                console.error('‚ùå Participant not found:', fromUserId);
                return;
            }
            
            const participant = participantDoc.data();
            
            // Create new peer connection
            peerConnection = new RTCPeerConnection(iceServers);
            
            // Add local audio
            if (localAudioStream) {
                localAudioStream.getTracks().forEach(track => {
                    console.log('üì§ Adding local audio track (answer)');
                    peerConnection.addTrack(track, localAudioStream);
                });
            }
            
            // Handle remote audio
            peerConnection.ontrack = (event) => {
                console.log('üì• Received audio from:', participant.name);
                const remoteStream = event.streams[0];
                remoteStreams.set(fromUserId, remoteStream);
                
                let audioElement = document.getElementById(`audio_${fromUserId}`);
                if (!audioElement) {
                    audioElement = document.createElement('audio');
                    audioElement.id = `audio_${fromUserId}`;
                    audioElement.autoplay = true;
                    audioElement.volume = 1.0;
                    
                    // Add to appropriate container
                    const coachContainer = document.getElementById('coach-remote-audio-container');
                    const studentContainer = document.getElementById('remote-audio-container');
                    
                    if (coachContainer) {
                        coachContainer.appendChild(audioElement);
                    } else if (studentContainer) {
                        studentContainer.appendChild(audioElement);
                    } else {
                        document.body.appendChild(audioElement);
                    }
                    
                    console.log('‚úÖ Audio element created (answer)');
                }
                
                audioElement.srcObject = remoteStream;
                audioElement.play().then(() => {
                    console.log('‚úÖ Audio playing (answer)');
                }).catch(err => {
                    console.error('‚ùå Error playing audio (answer):', err);
                });
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    sendIceCandidate(fromUserId, event.candidate);
                }
            };
            
            peerConnection.onconnectionstatechange = () => {
                console.log(`Connection state with ${participant.name}:`, peerConnection.connectionState);
            };
            
            peerConnections.set(fromUserId, peerConnection);
        }
        
        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
        console.log('‚úÖ Remote description set');
        
        const answer = await peerConnection.createAnswer({
            offerToReceiveAudio: true // ‚úÖ Explicitly request to receive audio
        });
        await peerConnection.setLocalDescription(answer);
        
        await sendAnswer(fromUserId, answer);
        console.log('‚úÖ Answer sent');
        
    } catch (error) {
        console.error('Error handling offer:', error);
    }
}
async function sendAnswer(toUserId, answer) {
    const classId = myClass ? myClass.id : liveSessionId;
    
    await db.collection('classes')
        .doc(classId)
        .collection('answers')
        .add({
            from: currentUser.uid,
            to: toUserId,
            answer: {
                type: answer.type,
                sdp: answer.sdp
            },
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
}

async function handleAnswer(fromUserId, answer) {
    try {
        console.log('üì® Handling answer from user:', fromUserId);
        
        const peerConnection = peerConnections.get(fromUserId);
        
        if (!peerConnection) {
            console.error('‚ùå No peer connection found for:', fromUserId);
            return;
        }
        
        // ‚úÖ CHECK SIGNALING STATE BEFORE SETTING REMOTE DESCRIPTION
        const currentState = peerConnection.signalingState;
        console.log('Current signaling state:', currentState);
        
        // Only set remote description if we're in the correct state
        if (currentState === 'have-local-offer') {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            console.log('‚úÖ Answer processed from:', fromUserId);
        } else if (currentState === 'stable') {
            console.warn('‚ö†Ô∏è Already in stable state, ignoring duplicate answer');
        } else {
            console.warn('‚ö†Ô∏è Unexpected state for answer:', currentState);
        }
        
    } catch (error) {
        console.error('Error handling answer:', error);
        // Don't throw - just log the error to prevent breaking the flow
    }
}

async function sendIceCandidate(toUserId, candidate) {
    const classId = myClass ? myClass.id : liveSessionId;
    
    await db.collection('classes')
        .doc(classId)
        .collection('iceCandidates')
        .add({
            from: currentUser.uid,
            to: toUserId,
            candidate: candidate.toJSON(),
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
}

async function handleIceCandidate(fromUserId, candidate) {
    try {
        const peerConnection = peerConnections.get(fromUserId);
        if (peerConnection) {
            await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        }
    } catch (error) {
        console.error('Error handling ICE candidate:', error);
    }
}

// ===== TOGGLE MICROPHONE =====
async function toggleMicrophone() {
    if (!localAudioStream) return;
    
    const audioTrack = localAudioStream.getAudioTracks()[0];
    if (audioTrack) {
        audioTrack.enabled = !audioTrack.enabled;
        isMicMuted = !audioTrack.enabled;
        
        // Update button based on user type
        const btnId = isCoach ? 'coach-toggle-mic-btn' : 'student-toggle-mic-btn';
        const btn = document.getElementById(btnId);
        
        if (btn) {
            if (isMicMuted) {
                btn.textContent = 'üîá Unmute';
                btn.style.background = '#dc3545';
            } else {
                btn.textContent = 'üé§ Mute';
                btn.style.background = '#28a745';
            }
        }
        
        // Update in Firestore
        const classId = myClass ? myClass.id : liveSessionId;
        if (classId) {
            await db.collection('classes')
                .doc(classId)
                .collection('sessionParticipants')
                .doc(currentUser.uid)
                .update({ micMuted: isMicMuted });
        }
    }
}

// ===== UPDATE PARTICIPANTS LIST =====
function updateParticipantsList() {
    const containerId = isCoach ? 'coach-session-participants-list' : 'student-session-participants-list';
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('Participants container not found:', containerId);
        return;
    }
    
    if (sessionParticipants.size === 0) {
        container.innerHTML = '<p style="color: #666;">No participants yet</p>';
        return;
    }
    
    // Update participant count for coach
    if (isCoach) {
        const countEl = document.getElementById('participant-count');
        if (countEl) countEl.textContent = sessionParticipants.size;
    }
    
    container.innerHTML = Array.from(sessionParticipants.values())
        .map(participant => {
            const avatarHtml = participant.photoURL 
                ? `<div class="coach-avatar" style="width: 40px; height: 40px; background-image: url('${participant.photoURL}'); background-size: cover;"></div>`
                : `<div class="coach-avatar" style="width: 40px; height: 40px;">${(participant.name || 'U').charAt(0).toUpperCase()}</div>`;
            
            const micStatus = participant.micMuted ? 'üîá' : 'üé§';
            
            return `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 8px; margin-bottom: 10px;">
                    ${avatarHtml}
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #0d3b66;">${participant.name}</div>
                        <div style="font-size: 0.9rem; color: #666;">${participant.email}</div>
                    </div>
                    <div style="font-size: 1.5rem;">${micStatus}</div>
                </div>
            `;
        }).join('');
}

        
// ===== CLOSE PEER CONNECTION =====
function closePeerConnection(userId) {
    const peerConnection = peerConnections.get(userId);
    if (peerConnection) {
        peerConnection.close();
        peerConnections.delete(userId);
    }
    
    const audioElement = document.getElementById(`audio_${userId}`);
    if (audioElement) {
        audioElement.remove();
    }
    
    remoteStreams.delete(userId);
}

// ===== END LIVE SESSION =====
async function endLiveSession() {
    const isCoachUser = isCoach;
    const confirmMessage = isCoachUser 
        ? 'Are you sure you want to end the live session for everyone?' 
        : 'Are you sure you want to leave the live session?';
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    try {
        // Stop local audio
        if (localAudioStream) {
            localAudioStream.getTracks().forEach(track => track.stop());
            localAudioStream = null;
        }
        
        // Close all peer connections
        peerConnections.forEach((pc, userId) => {
            pc.close();
        });
        peerConnections.clear();
        remoteStreams.clear();
        
        // Remove from participants
        const classId = myClass ? myClass.id : liveSessionId;
        if (classId) {
            await db.collection('classes')
                .doc(classId)
                .collection('sessionParticipants')
                .doc(currentUser.uid)
                .delete();
        }
        
        // If coach, end session for everyone
        if (isCoachUser && myClass) {
            await db.collection('classes').doc(myClass.id).update({
                liveSessionActive: false,
                liveSessionId: null
            });
            
            // Clear all participants
            const participantsSnapshot = await db.collection('classes')
                .doc(myClass.id)
                .collection('sessionParticipants')
                .get();
            
            const batch = db.batch();
            participantsSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();
        }
        
        // Cleanup listeners
        if (liveSessionListener) {
            liveSessionListener();
            liveSessionListener = null;
        }
        
        // Reset UI based on user type
        if (isCoachUser) {
            const startBtn = document.getElementById('start-session-btn');
            const liveSessionContainer = document.getElementById('coach-live-session-active');
            
            if (liveSessionContainer) liveSessionContainer.style.display = 'none';
            if (startBtn) startBtn.style.display = 'block';
        } else {
            const liveSessionContainer = document.getElementById('student-live-session-active');
            const joinBtn = document.getElementById('join-session-btn');
            
            if (liveSessionContainer) liveSessionContainer.style.display = 'none';
            if (joinBtn) joinBtn.style.display = 'block';
        }
        
        sessionParticipants.clear();
        liveSessionActive = false;
        liveSessionId = null;
        
        const message = isCoachUser ? '‚úÖ Live session ended' : '‚úÖ Left live session';
        alert(message);
        
    } catch (error) {
        console.error('Error ending session:', error);
        alert('Error ending session: ' + error.message);
    }
}

// ===== CHECK FOR ACTIVE SESSION (FOR STUDENTS) =====
async function checkForActiveSession() {
    if (!currentUser) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (!userData || !userData.classId || userData.userType !== 'student') return;
        
        const classDoc = await db.collection('classes').doc(userData.classId).get();
        const classData = classDoc.data();
        
        if (classData && classData.liveSessionActive) {
            // Show join button
            const studentClassInfo = document.getElementById('student-class-info');
            
            const joinBtnHtml = `
                <div style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px;">
                    <h3 style="color: white; margin-bottom: 15px;">üé• Live Session Active!</h3>
                    <button id="join-session-btn" class="practice-btn" onclick="joinLiveSession()" style="background: white; color: #28a745; font-size: 1.2rem;">
                        Join Live Session
                    </button>
                </div>
            `;
            
            // Check if button doesn't already exist
            if (!document.getElementById('join-session-btn')) {
                studentClassInfo.insertAdjacentHTML('beforeend', joinBtnHtml);
            }
        }
    } catch (error) {
        console.error('Error checking for active session:', error);
    }
}  

   // ===== BOOK COACH (STUDENT) =====
async function bookCoach(coachId, coachName) {
    if (!currentUser) {
        alert('Please sign in to book a coach');
        return;
    }
    
    if (!confirm(`Book ${coachName} as your coach?\n\nThis will add you to their class.`)) {
        return;
    }
    
    try {
        // Get coach's class
        const classQuery = await db.collection('classes')
            .where('coachId', '==', coachId)
            .limit(1)
            .get();
        
        if (classQuery.empty) {
            alert('‚ùå Coach class not found. Please try again later.');
            return;
        }
        
        const classDoc = classQuery.docs[0];
        const classId = classDoc.id;
        
        // Check if student already has a coach
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData.classId && userData.classId !== classId) {
            if (!confirm('You are already in another class. Switch to this coach?')) {
                return;
            }
            
            // Remove from old class count
            try {
                const oldClassDoc = await db.collection('classes').doc(userData.classId).get();
                if (oldClassDoc.exists) {
                    const oldCount = oldClassDoc.data().studentCount || 0;
                    await db.collection('classes').doc(userData.classId).update({
                        studentCount: Math.max(0, oldCount - 1)
                    });
                }
            } catch (error) {
                console.error('Error updating old class count:', error);
            }
        }
        
        // Update student with classId
        await db.collection('users').doc(currentUser.uid).update({
            classId: classId,
            coachId: coachId
        });
        
        // Update class student count
        const currentCount = classDoc.data().studentCount || 0;
        await db.collection('classes').doc(classId).update({
            studentCount: currentCount + 1
        });
        
        alert(`‚úÖ Successfully booked ${coachName}!\n\nYou can now access your class from the "MY CLASS" button.`);
        closeCoachDetailModal();
        
        // Show MY CLASS button
        const myClassBtn = document.getElementById('myClassBtn');
        if (myClassBtn) {
            myClassBtn.style.display = 'block';
        }
        
    } catch (error) {
        console.error('Error booking coach:', error);
        alert('Failed to book coach: ' + error.message);
    }
}

// ===== RECRUIT STUDENT (COACH) =====
async function recruitStudent(studentId, studentName) {
    if (!currentUser || !myClass) {
        alert('Please ensure you have a class set up first');
        return;
    }
    
    if (!confirm(`Recruit ${studentName} to your class?`)) {
        return;
    }
    
    try {
        // Check if student already has a coach
        const studentDoc = await db.collection('users').doc(studentId).get();
        const studentData = studentDoc.data();
        
        if (studentData.classId && studentData.classId !== myClass.id) {
            if (!confirm(`${studentName} is already in another class. Recruit anyway?`)) {
                return;
            }
            
            // Remove from old class count
            try {
                const oldClassDoc = await db.collection('classes').doc(studentData.classId).get();
                if (oldClassDoc.exists) {
                    const oldCount = oldClassDoc.data().studentCount || 0;
                    await db.collection('classes').doc(studentData.classId).update({
                        studentCount: Math.max(0, oldCount - 1)
                    });
                }
            } catch (error) {
                console.error('Error updating old class count:', error);
            }
        }
        
        // Add student to coach's class
        await db.collection('users').doc(studentId).update({
            classId: myClass.id,
            coachId: currentUser.uid
        });
        
        // Update class student count
        const currentCount = myClass.studentCount || 0;
        await db.collection('classes').doc(myClass.id).update({
            studentCount: currentCount + 1
        });
        
        // Update myClass object
        myClass.studentCount = currentCount + 1;
        
        alert(`‚úÖ Successfully recruited ${studentName} to your class!`);
        closeStudentDetailModal();
        
        // Reload class students
        await loadClassStudents();
        updateCoachClassStats();
        
    } catch (error) {
        console.error('Error recruiting student:', error);
        alert('Failed to recruit student: ' + error.message);
    }
}     
    </script>
</body>
</html>
